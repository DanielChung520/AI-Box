---
name: WBS 1.1 FastAPI Service 改进任务
overview: ""
todos: []
---

# WBS 1.1 FastAPI Service 改进任务

## 概述

根据 `docs/plans/phase1/wbs-1.1-fastapi-service.md` 的要求，改进和优化现有的 FastAPI 服务（`api/main.py`），补充缺失功能，确保符合文档验收标准。

## 当前状态分析

### 已实现功能

- ✅ FastAPI 基础框架（`api/main.py`）
- ✅ API 路由与版本策略（`/api/v1` 前缀）
- ✅ 中间件：Request ID、Logging、Error Handler、CORS
- ✅ OpenAPI 文档（`/docs` 和 `/redoc`）
- ✅ 健康检查端点（`/health`、`/ready`、`/metrics`）
- ✅ 版本管理（`api/core/version.py`）

### 需要补充/改进

- ❌ Smoke test 脚本
- ❌ CI 检查（OpenAPI 文档验证）
- ❌ Docker Compose 配置检查/优化
- ⚠️ 项目结构对齐（文档要求 `services/api`，实际在 `api/`）

## 任务拆解

### 1. 创建 Smoke Test 脚本

**文件**: `scripts/smoke_test_api.py` 或 `tests/smoke/test_api.py`

**功能**:

- 测试健康检查端点（`/health`）
- 测试版本端点（`/version`）
- 测试 OpenAPI 文档可访问性（`/docs`、`/redoc`、`/openapi.json`）
- 生成测试报告

**验收标准**:

- 所有端点测试通过
- 生成可读的测试报告（JSON 或 Markdown）

### 2. 添加 CI 检查（OpenAPI 文档验证）

**文件**: `.github/workflows/api-openapi-check.yml` 或更新现有 workflow

**功能**:

- 在 CI 中验证 OpenAPI schema 的有效性
- 检查 OpenAPI 文档是否可访问
- 验证 API 版本一致性

**验收标准**:

- CI 流程中自动检查 OpenAPI 文档
- 检查失败时阻止合并

### 3. 检查/优化 Docker Compose 配置

**文件**: `docker-compose.yml` 或 `docker-compose.api.yaml`

**功能**:

- 确保 FastAPI 服务在 Docker Compose 中可正常启动
- 配置健康检查
- 配置网络和依赖服务

**验收标准**:

- 服务可通过 `docker-compose up` 启动
- 健康检查端点可访问

### 4. 文档和配置完善

**文件**:

- `api/README.md` 或 `docs/api/README.md`
- `.env.example` 更新

**功能**:

- 添加 API 服务使用说明
- 完善环境变量配置示例
- 添加部署说明

## 实施步骤

1. **创建 Smoke Test 脚本**（优先级：高）

- 使用 `httpx` 或 `requests` 库
- 测试关键端点
- 生成测试报告

2. **添加 CI 检查**（优先级：高）

- 创建或更新 GitHub Actions workflow
- 添加 OpenAPI schema 验证步骤

3. **检查 Docker Compose**（优先级：中）

- 验证现有配置
- 必要时添加或优化配置

4. **完善文档**（优先级：低）

- 添加 API 使用说明
- 更新环境变量配置

## 验收标准（符合文档要求）

- ✅ FastAPI 服务可在 Docker Compose 中启动并通过健康检查
- ✅ OpenAPI 文件可通过 `/docs` 与 `/redoc` 正常浏览
- ✅ Smoke test（Ping/版本检查）全数通过并附报告
- ✅ CI 中自动检查 OpenAPI 文档有效性

## 注意事项

- 保持与现有代码风格一致
- 遵循项目代码规范（类型注解、防御性编程等）
- 确保所有新增代码通过 pre-commit hooks 检查