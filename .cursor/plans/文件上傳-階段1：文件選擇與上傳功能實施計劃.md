<!-- 7f8029d4-8f20-4d06-ae76-818cf9d11195 cb7670e4-b68b-499d-a030-8bcf4537ba6f -->
# 階段一：文件選擇與上傳功能實施計劃

## 1. 當前狀態確認

**當前時間**: 2025-12-06 11:58:36 +0800

**現有基礎設施**:

- `api/routers/file_upload.py` - 文件上傳API已存在，已整合JWT認證和審計日誌
- `ai-bot/src/components/ChatInput.tsx` - 已有回紋針圖標（fa-paperclip），但尚未實現點擊功能
- `ai-bot/src/lib/api.ts` - API客戶端已存在，需要添加文件上傳方法
- 文件驗證和存儲服務已存在

**待完成任務**:

- 前端文件上傳UI組件（FileUploadModal）
- 前端上傳進度顯示組件（UploadProgress）
- ChatInput 組件集成文件上傳功能
- 後端文件上傳進度追蹤
- 文件上傳API的前端集成

## 2. 實施任務分解

### 2.1 前端開發 (3-4天)

#### 2.1.1 文件選擇UI組件 (1天)

**文件位置**: `ai-bot/src/components/FileUploadModal.tsx` (新建)

**任務清單**:

1. 創建 FileUploadModal 組件

   - 實現文件選擇對話框UI
   - 支持文件列表顯示和預覽
   - 實現文件移除功能
   - 使用 Tailwind CSS 樣式

2. 實現文件拖拽上傳

   - 支持拖拽文件到對話框區域
   - 拖拽視覺反饋（高亮邊框）
   - 防止默認瀏覽器行為

3. 實現文件類型驗證（前端）

   - 支持格式: PDF, DOCX, TXT, MD, CSV, XLSX
   - 文件擴展名檢查
   - MIME類型驗證
   - 無效文件類型提示

4. 實現文件大小限制提示

   - 最大文件大小: 50MB
   - 文件大小顯示
   - 超過限制的提示和阻止上傳

#### 2.1.2 回紋針按鈕功能集成 (0.5天)

**文件位置**: `ai-bot/src/components/ChatInput.tsx` (修改)

**任務清單**:

1. 為回紋針按鈕添加點擊事件處理

   - 綁定 onClick 事件
   - 打開 FileUploadModal

2. 實現文件選擇觸發

   - 點擊回紋針打開文件選擇對話框
   - 使用 HTML5 file input 元素

3. 實現多文件選擇

   - 支持一次選擇多個文件
   - 文件列表管理（添加、移除）

#### 2.1.3 文件上傳進度顯示 (1天)

**文件位置**: `ai-bot/src/components/UploadProgress.tsx` (新建)

**任務清單**:

1. 創建上傳進度組件

   - 進度條顯示（百分比）
   - 文件上傳狀態指示（等待、上傳中、完成、失敗）
   - 取消上傳功能

2. 實現上傳狀態管理

   - 使用 React State 管理上傳狀態
   - 狀態: 等待、上傳中、完成、失敗
   - 每個文件的獨立狀態

3. 實現上傳進度實時更新

   - 使用 XMLHttpRequest 監聽上傳進度
   - 或使用 Fetch API + ReadableStream（如果支持）
   - 進度更新頻率控制（避免過度渲染）

#### 2.1.4 API 集成 (0.5天)

**文件位置**: `ai-bot/src/lib/api.ts` (修改)

**任務清單**:

1. 創建文件上傳 API 客戶端方法

   - `uploadFiles(files: File[]): Promise<UploadResponse>`
   - 使用 FormData 封裝文件
   - 添加 JWT Token 到請求頭
   - 處理 multipart/form-data

2. 實現文件上傳錯誤處理

   - 網絡錯誤處理
   - 文件大小超限錯誤
   - 文件類型錯誤
   - 認證錯誤（401/403）
   - 友好的錯誤提示

3. 實現上傳進度回調

   - 支持進度回調函數
   - 計算總體進度（多文件）

### 2.2 後端整合 (1-2天)

#### 2.2.1 文件上傳進度追蹤 (0.5天)

**文件位置**: `api/routers/file_upload.py` (修改)

**任務清單**:

1. 實現上傳進度存儲

   - 使用 Redis 存儲上傳進度（key: `upload:progress:{file_id}`）
   - 進度數據結構: `{"file_id": "...", "status": "...", "progress": 75, "message": "..."}`
   - 設置 TTL（例如：1小時）

2. 實現上傳進度更新

   - 在文件上傳過程中更新進度
   - 使用異步任務或回調更新 Redis

3. 創建進度查詢端點

   - `GET /api/files/upload/{file_id}/progress`
   - 從 Redis 讀取進度
   - 返回進度信息

**可選方案**: 如果不需要持久化，可以使用內存存儲（Dictionary），但重啟後會丟失。

#### 2.2.2 文件驗證增強 (0.5天)

**任務清單**:

1. 增強文件類型驗證

   - 檢查現有驗證器配置
   - 確保支持所有計劃格式
   - 添加更多格式支持（如需要）

2. 實現文件內容驗證

   - 檢查文件是否損壞
   - PDF 文件結構驗證
   - 圖片文件完整性檢查

#### 2.2.3 異步處理觸發 (0.5天)

**任務清單**:

1. 創建文件處理觸發器

   - 文件上傳完成後，觸發異步處理任務
   - 使用任務隊列（如 Celery）或簡單的後台任務
   - 返回任務ID供後續查詢

2. 實現處理狀態API

   - `GET /api/files/{file_id}/processing-status`
   - 查詢文件處理狀態（分塊、向量化等）

#### 2.2.4 CORS和錯誤處理優化 (0.5天)

**任務清單**:

1. 確保CORS配置正確

   - 檢查 `api/main.py` 中的 CORS 配置
   - 允許文件上傳的 multipart/form-data

2. 優化錯誤響應

   - 統一的錯誤格式
   - 詳細的錯誤信息（開發環境）
   - 友好的錯誤消息

### 2.3 整合和測試 (0.5天)

**任務清單**:

1. 前端與後端整合測試

   - 完整的上傳流程測試
   - 進度顯示測試
   - 錯誤處理測試

2. 瀏覽器兼容性測試

   - Chrome, Firefox, Safari, Edge
   - 移動端瀏覽器（響應式設計）

3. 性能測試

   - 小文件上傳（< 1MB）
   - 大文件上傳（10MB+）
   - 多文件並發上傳

## 3. 技術實現細節

### 3.1 前端文件上傳實現

```typescript
// api.ts 中添加
export async function uploadFiles(
  files: File[],
  onProgress?: (progress: number) => void
): Promise<UploadResponse> {
  const formData = new FormData();
  files.forEach(file => {
    formData.append('files', file);
  });

  // 使用 XMLHttpRequest 以支持進度追蹤
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();

    // 進度監聽
    xhr.upload.addEventListener('progress', (e) => {
      if (e.lengthComputable && onProgress) {
        const percentComplete = (e.loaded / e.total) * 100;
        onProgress(percentComplete);
      }
    });

    // 完成處理
    xhr.addEventListener('load', () => {
      if (xhr.status === 200) {
        resolve(JSON.parse(xhr.responseText));
      } else {
        reject(new Error(`Upload failed: ${xhr.statusText}`));
      }
    });

    // 錯誤處理
    xhr.addEventListener('error', () => {
      reject(new Error('Network error during upload'));
    });

    xhr.open('POST', `${API_URL}/files/upload`);

    // 添加認證頭（從 localStorage 或 context 獲取）
    const token = localStorage.getItem('access_token');
    if (token) {
      xhr.setRequestHeader('Authorization', `Bearer ${token}`);
    }

    xhr.send(formData);
  });
}
```

### 3.2 後端進度追蹤實現

```python
# file_upload.py 中添加
from database.redis import get_redis_client

async def update_upload_progress(file_id: str, progress: int, status: str, message: str = ""):
    """更新上傳進度"""
    redis_client = get_redis_client()
    progress_data = {
        "file_id": file_id,
        "status": status,  # "uploading", "completed", "failed"
        "progress": progress,
        "message": message,
    }
    redis_client.setex(
        f"upload:progress:{file_id}",
        3600,  # TTL: 1小時
        json.dumps(progress_data)
    )

@router.get("/upload/{file_id}/progress")
async def get_upload_progress(
    file_id: str,
    current_user: User = Depends(get_current_user),
) -> JSONResponse:
    """查詢上傳進度"""
    redis_client = get_redis_client()
    progress_data = redis_client.get(f"upload:progress:{file_id}")

    if not progress_data:
        return APIResponse.error(
            message="Progress not found",
            status_code=status.HTTP_404_NOT_FOUND,
        )

    return APIResponse.success(data=json.loads(progress_data))
```

### 3.3 ChatInput 集成

```typescript
// ChatInput.tsx 中添加
const [showFileUpload, setShowFileUpload] = useState(false);
const [uploadingFiles, setUploadingFiles] = useState<File[]>([]);

const handlePaperclipClick = () => {
  setShowFileUpload(true);
};

const handleFilesSelected = async (files: File[]) => {
  setUploadingFiles(files);
  // 開始上傳
  try {
    const result = await uploadFiles(files, (progress) => {
      // 更新進度
    });
    // 處理成功
  } catch (error) {
    // 處理錯誤
  } finally {
    setUploadingFiles([]);
    setShowFileUpload(false);
  }
};
```

## 4. 依賴關係

### 4.1 前置條件

- 階段零必須完成（認證系統、同意機制）
- Redis 可用（用於進度追蹤）
- ArangoDB 可用（用於文件元數據存儲）

### 4.2 後續任務

- 階段二A：文件分塊與向量化（依賴階段一）
- 階段二B：知識圖譜提取（依賴階段一）

## 5. 驗收標準

### 5.1 功能驗收

- 用戶可以點擊回紋針按鈕打開文件選擇對話框
- 支持拖拽文件上傳
- 支持多文件選擇和上傳
- 顯示上傳進度
- 上傳完成後顯示成功/失敗狀態
- 文件類型驗證正確
- 文件大小限制生效

### 5.2 性能驗收

- 文件選擇對話框打開時間 < 100ms
- 小文件（< 1MB）上傳響應時間 < 2秒
- 大文件（10MB）上傳進度更新頻率 > 1次/秒

### 5.3 兼容性驗收

- 支持 Chrome, Firefox, Safari, Edge
- 支持移動端瀏覽器（響應式設計）

## 6. 文件更新清單

### 新建文件

- `ai-bot/src/components/FileUploadModal.tsx`
- `ai-bot/src/components/UploadProgress.tsx`

### 修改文件

- `ai-bot/src/components/ChatInput.tsx` - 添加回紋針按鈕功能和文件上傳集成
- `ai-bot/src/lib/api.ts` - 添加文件上傳API方法
- `api/routers/file_upload.py` - 添加進度追蹤功能
- `docs/plans/rag-file-upload/file-upload-implement-plan.md` - 更新階段一進度

### 計劃文件更新

- 更新階段一狀態為「進行中」
- 更新開始日期為 2025-12-06
- 更新進度百分比

### To-dos

- [ ] 確認當前準確時間（2025-12-06 11:58:36 +0800）並更新計劃文件進度狀態
- [ ] 創建 FileUploadModal 組件（ai-bot/src/components/FileUploadModal.tsx）：文件選擇對話框、拖拽上傳、文件類型驗證、大小限制
- [ ] 創建 UploadProgress 組件（ai-bot/src/components/UploadProgress.tsx）：進度條顯示、狀態管理、實時更新
- [ ] 修改 ChatInput 組件：為回紋針按鈕添加點擊事件、文件選擇觸發、多文件選擇支持
- [ ] 更新 API 客戶端（ai-bot/src/lib/api.ts）：添加文件上傳方法、進度回調、錯誤處理
- [ ] 實現後端上傳進度追蹤（api/routers/file_upload.py）：Redis 進度存儲、進度更新、查詢端點
- [ ] 增強文件驗證：文件類型驗證增強、文件內容驗證
- [ ] 實現異步處理觸發：文件上傳完成後觸發處理任務、處理狀態API
- [ ] 優化CORS和錯誤處理：確保CORS配置正確、優化錯誤響應格式
- [ ] 整合和測試：前端後端整合測試、瀏覽器兼容性測試、性能測試
- [ ] 更新計劃文件：標記階段一為進行中並更新進度
