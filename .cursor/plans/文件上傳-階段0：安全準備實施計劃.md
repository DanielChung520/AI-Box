<!-- 7f8029d4-8f20-4d06-ae76-818cf9d11195 e6e477b4-3e0c-48ce-80dd-35af12a002e0 -->
# 階段零：安全準備實施計劃

## 1. 當前狀態確認

**當前時間**: 2025-12-06 11:15:28 +0800

**現有基礎設施**:

- `system/security/` 目錄已存在，包含基礎框架：
  - `auth.py` - 認證相關函數（框架已存在，需完善實現）
  - `config.py` - 安全配置管理（已實現）
  - `dependencies.py` - FastAPI 依賴注入（已實現）
  - `middleware.py` - 安全中間件（已實現）
  - `models.py` - 用戶和權限模型（已實現）
- `api/routers/file_upload.py` - 文件上傳API（存在，需要添加認證檢查）
- 安全中間件已在 `api/main.py` 中註冊

**待完成任務**:

- JWT Token 簽發和驗證邏輯（目前僅為框架）
- Token 刷新機制
- Token 黑名單（使用 Redis）
- 數據使用同意機制（完全待實現）
- 審計日誌系統（完全待實現）

## 2. 實施任務分解

### 2.1 JWT認證系統實現 (2-3天)

#### 2.1.1 JWT服務實現

**文件位置**: `system/security/jwt_service.py` (新建)

**任務清單**:

1. 實現 `JWTService` 類

   - `create_access_token()` - 生成 Access Token
   - `create_refresh_token()` - 生成 Refresh Token
   - `verify_token()` - 驗證 Token 簽名和過期時間
   - `decode_token()` - 解析 Token payload
   - 使用 `python-jose[cryptography]` 庫處理 JWT
   - 從配置讀取 secret_key 和 algorithm

2. 實現 Token 黑名單服務

   - `BlacklistService` 類（在 `jwt_service.py` 或新建 `blacklist_service.py`）
   - `add_to_blacklist()` - 將 Token 加入黑名單
   - `is_blacklisted()` - 檢查 Token 是否在黑名單中
   - 使用 Redis 存儲黑名單（TTL 與 Token 過期時間一致）
   - 從 `database/redis/` 使用現有 Redis 客戶端

3. 更新 `system/security/auth.py`

   - 完善 `verify_jwt_token()` 函數，調用 `JWTService`
   - 添加 Token 黑名單檢查
   - 從 Token payload 構建 User 對象

#### 2.1.2 認證路由實現

**文件位置**: `api/routers/auth.py` (新建)

**任務清單**:

1. 實現登錄端點

   - `POST /api/auth/login` - 接受 username/password，返回 access_token 和 refresh_token
   - 暫時實現簡單的用戶驗證（後續可整合實際用戶系統）
   - 調用 `JWTService` 生成 Token

2. 實現 Token 刷新端點

   - `POST /api/auth/refresh` - 接受 refresh_token，返回新的 access_token

3. 實現登出端點

   - `POST /api/auth/logout` - 將 Token 加入黑名單

4. 在 `api/main.py` 中註冊 auth 路由

#### 2.1.3 更新文件上傳API

**文件位置**: `api/routers/file_upload.py`

**任務清單**:

1. 在 `upload_files()` 函數中添加認證依賴

   - 使用 `Depends(get_current_user)` 獲取當前用戶
   - 從 Token 中獲取 `user_id`，移除可選的 `user_id` 參數
   - 確保未認證請求被拒絕

2. 更新其他文件操作端點

   - `get_file_info()` - 添加認證和權限檢查
   - `delete_file()` - 添加認證和權限檢查

### 2.2 數據使用同意機制 (1天)

#### 2.2.1 數據模型設計

**文件位置**: `services/api/models/data_consent.py` (新建)

**任務清單**:

1. 定義 `ConsentType` 枚舉

   - `file_upload` - 文件上傳同意
   - `ai_processing` - AI處理同意
   - `data_sharing` - 數據共享同意
   - `training` - 訓練數據使用同意

2. 定義 `DataConsent` 數據模型（Pydantic）

   - `user_id: str`
   - `consent_type: ConsentType`
   - `purpose: str` - 使用目的描述
   - `granted: bool` - 是否同意
   - `timestamp: datetime` - 同意時間
   - `expires_at: Optional[datetime]` - 過期時間（可選）

3. 定義數據庫模型（如果使用 ORM，如 SQLAlchemy）

#### 2.2.2 數據使用同意服務

**文件位置**: `services/api/services/data_consent_service.py` (新建)

**任務清單**:

1. 實現 `DataConsentService` 類

   - `record_consent()` - 記錄用戶同意狀態
   - `check_consent()` - 檢查用戶是否已同意特定類型
   - `revoke_consent()` - 撤銷用戶同意
   - `get_user_consents()` - 查詢用戶的所有同意記錄
   - 使用 ArangoDB 或現有數據庫存儲同意記錄

#### 2.2.3 同意API實現

**文件位置**: `api/routers/data_consent.py` (新建)

**任務清單**:

1. 實現記錄同意端點

   - `POST /api/consent` - 記錄用戶同意狀態
   - 需要認證（使用 `get_current_user`）

2. 實現查詢同意端點

   - `GET /api/consent` - 查詢當前用戶的同意狀態
   - `GET /api/consent/{consent_type}` - 查詢特定類型的同意狀態

3. 實現撤銷同意端點

   - `DELETE /api/consent/{consent_type}` - 撤銷特定類型的同意

4. 在 `api/main.py` 中註冊路由

#### 2.2.4 同意檢查中間件

**文件位置**: `system/security/consent_middleware.py` (新建)

**任務清單**:

1. 實現同意檢查裝飾器或依賴函數

   - `require_consent(consent_type: ConsentType)` - 檢查用戶是否已同意
   - 在文件上傳前自動檢查 `file_upload` 同意
   - 如果未同意，返回 403 Forbidden

2. 更新 `api/routers/file_upload.py`

   - 在 `upload_files()` 中添加同意檢查

#### 2.2.5 前端同意UI

**文件位置**: `ai-bot/src/components/ConsentModal.tsx` (新建)

**任務清單**:

1. 實現同意模態框組件

   - 顯示同意條款內容
   - 支持選擇同意類型
   - 調用 API 記錄用戶選擇

2. 在應用啟動時或首次使用文件上傳時顯示同意模態框

### 2.3 審計日誌系統 (1-2天)

#### 2.3.1 數據模型設計

**文件位置**: `services/api/models/audit_log.py` (新建)

**任務清單**:

1. 定義 `AuditAction` 枚舉

   - `file_upload` - 文件上傳
   - `file_access` - 文件訪問
   - `file_delete` - 文件刪除
   - `data_process` - 數據處理
   - `model_call` - 模型調用
   - `consent_granted` - 同意授予
   - `consent_revoked` - 同意撤銷

2. 定義 `AuditLog` 數據模型（Pydantic）

   - `user_id: str`
   - `action: AuditAction`
   - `resource_type: str` - 資源類型（file, task, etc.）
   - `resource_id: str` - 資源ID
   - `timestamp: datetime`
   - `ip_address: str`
   - `user_agent: str`
   - `details: Dict[str, Any]` - 額外詳情（JSON）

3. 定義數據庫模型（使用 ArangoDB 或現有數據庫）

#### 2.3.2 審計日誌服務

**文件位置**: `services/api/services/audit_log_service.py` (新建)

**任務清單**:

1. 實現 `AuditLogService` 類

   - `log()` - 記錄審計日誌（異步處理，不阻塞主流程）
   - `query_logs()` - 查詢審計日誌（支持過濾條件）
   - `export_logs()` - 導出審計日誌為 CSV/JSON
   - 使用 ArangoDB 存儲日誌，支持按時間、用戶、操作類型索引

#### 2.3.3 審計日誌裝飾器

**文件位置**: `system/security/audit_decorator.py` (新建)

**任務清單**:

1. 實現 `audit_log()` 裝飾器

   - 自動記錄 API 調用
   - 提取用戶信息、IP 地址、User-Agent
   - 記錄請求參數和響應狀態（敏感信息需過濾）

2. 在關鍵 API 端點使用裝飾器

   - 文件上傳、刪除、訪問
   - 同意記錄和撤銷
   - 數據處理操作

#### 2.3.4 審計日誌API

**文件位置**: `api/routers/audit_log.py` (新建)

**任務清單**:

1. 實現查詢端點

   - `GET /api/audit-logs` - 查詢審計日誌
   - 支持查詢參數：`user_id`, `action`, `start_date`, `end_date`, `limit`, `offset`
   - 需要管理員權限（使用 `require_permission`）

2. 實現導出端點

   - `GET /api/audit-logs/export` - 導出審計日誌
   - 支持格式：CSV, JSON
   - 需要管理員權限

3. 在 `api/main.py` 中註冊路由

### 2.4 安全配置和測試 (0.5天)

#### 2.4.1 配置管理

**任務清單**:

1. 更新 `config/config.example.json`（如果存在）

   - 添加 `services.security.jwt` 配置區塊
   - 添加 `services.security.consent` 配置區塊
   - 添加 `services.security.audit` 配置區塊

2. 更新 `.env.example`

   - 添加 `SECURITY_JWT_SECRET_KEY`（示例值，生產環境需使用強密鑰）
   - 添加 `SECURITY_JWT_EXPIRATION_HOURS`
   - 添加 `SECURITY_JWT_REFRESH_EXPIRATION_DAYS`
   - 添加 `SECURITY_ENABLED` 和 `SECURITY_MODE`

3. 更新 `system/security/config.py`（如需要）

   - 添加 Refresh Token 過期時間配置
   - 添加同意機制配置

#### 2.4.2 CORS和安全頭配置

**文件位置**: `api/main.py`

**任務清單**:

1. 檢查並完善 CORS 配置

   - 確保開發環境和生產環境的 CORS 策略正確

2. 完善 `SecurityMiddleware` 中的安全頭設置

   - `Content-Security-Policy`
   - `X-Frame-Options`（已設置）
   - `X-Content-Type-Options`（已設置）
   - `Strict-Transport-Security` (HSTS)
   - `Referrer-Policy`

#### 2.4.3 安全測試

**文件位置**: `tests/test_security/` (新建測試目錄)

**任務清單**:

1. 實現 JWT 認證測試

   - 測試 Token 生成和驗證
   - 測試 Token 刷新
   - 測試 Token 黑名單
   - 測試過期 Token 處理

2. 實現未授權訪問測試

   - 測試未認證請求被拒絕
   - 測試無效 Token 被拒絕
   - 測試已登出 Token 被拒絕

3. 實現同意機制測試

   - 測試同意記錄和查詢
   - 測試未同意時的訪問拒絕
   - 測試同意撤銷

4. 實現審計日誌測試

   - 測試日誌記錄
   - 測試日誌查詢
   - 測試日誌導出

## 3. 實施順序和依賴關係

### 實施順序

1. **JWT服務實現** → 基礎認證功能
2. **認證路由實現** → 提供登錄/登出端點
3. **更新文件上傳API** → 應用認證保護
4. **數據使用同意機制** → 添加同意檢查
5. **審計日誌系統** → 記錄所有操作
6. **安全配置和測試** → 完善配置並驗證

### 依賴關係

- 數據使用同意機制依賴 JWT 認證（需要識別用戶）
- 審計日誌系統依賴 JWT 認證（需要記錄用戶信息）
- 文件上傳API更新依賴 JWT 認證和同意機制

## 4. 技術細節

### 4.1 依賴庫

- `python-jose[cryptography]` - JWT 處理
- `redis` - Token 黑名單存儲（應已存在）
- `python-arango` - 數據存儲（應已存在）

### 4.2 配置結構

```json
{
  "services": {
    "security": {
      "enabled": true,
      "mode": "production",
      "jwt": {
        "enabled": true,
        "secret_key": "從環境變數讀取",
        "algorithm": "HS256",
        "expiration_hours": 24,
        "refresh_expiration_days": 7
      }
    }
  }
}
```

## 5. 驗收標準

### 功能驗收

- ✅ JWT Token 可以正常生成和驗證
- ✅ 未認證請求被正確拒絕（返回 401）
- ✅ Token 刷新功能正常工作
- ✅ Token 黑名單機制正常工作
- ✅ 用戶同意狀態正確記錄和檢查
- ✅ 未同意用戶無法上傳文件（返回 403）
- ✅ 所有關鍵操作都有審計日誌
- ✅ 審計日誌可以查詢和導出

### 安全驗收

- ✅ Token 使用強密鑰簽名（生產環境）
- ✅ Token 過期時間合理
- ✅ 敏感信息不在日誌中記錄
- ✅ CORS 策略正確配置
- ✅ 安全頭正確設置

### 性能驗收

- ✅ Token 驗證響應時間 < 10ms
- ✅ 審計日誌記錄不影響 API 性能（異步記錄）

## 6. 文件更新清單

### 新建文件

- `system/security/jwt_service.py`
- `api/routers/auth.py`
- `services/api/models/data_consent.py`
- `services/api/services/data_consent_service.py`
- `api/routers/data_consent.py`
- `system/security/consent_middleware.py`
- `ai-bot/src/components/ConsentModal.tsx`
- `services/api/models/audit_log.py`
- `services/api/services/audit_log_service.py`
- `system/security/audit_decorator.py`
- `api/routers/audit_log.py`
- `tests/test_security/` (測試目錄和測試文件)

### 修改文件

- `system/security/auth.py` - 完善 JWT 驗證邏輯
- `api/routers/file_upload.py` - 添加認證和同意檢查
- `api/main.py` - 註冊新的路由
- `system/security/middleware.py` - 完善安全頭設置
- `system/security/config.py` - 添加 Refresh Token 配置（如需要）
- `config/config.example.json` - 添加安全配置示例
- `.env.example` - 添加環境變數示例

### 計劃文件更新

- `docs/plans/rag-file-upload/file-upload-implement-plan.md` - 更新階段0進度狀態

### To-dos

- [ ] 確認當前準確時間（2025-12-06 11:15:28 +0800）並更新計劃文件進度狀態
- [ ] 實現 JWT 服務（system/security/jwt_service.py）：Token 簽發、驗證、刷新和黑名單管理
- [ ] 實現認證路由（api/routers/auth.py）：登錄、刷新、登出端點
- [ ] 更新文件上傳API（api/routers/file_upload.py）：添加認證依賴和從Token獲取user_id
- [ ] 實現數據使用同意數據模型（services/api/models/data_consent.py）和服務（services/api/services/data_consent_service.py）
- [ ] 實現數據使用同意API（api/routers/data_consent.py）和同意檢查中間件（system/security/consent_middleware.py）
- [ ] 實現前端同意UI組件（ai-bot/src/components/ConsentModal.tsx）
- [ ] 實現審計日誌數據模型（services/api/models/audit_log.py）和服務（services/api/services/audit_log_service.py）
- [ ] 實現審計日誌裝飾器（system/security/audit_decorator.py）並應用到關鍵API端點
- [ ] 實現審計日誌查詢和導出API（api/routers/audit_log.py）
- [ ] 更新安全配置（config/config.example.json、.env.example、system/security/config.py）
- [ ] 實現安全測試（tests/test_security/）：JWT認證測試、未授權訪問測試、同意機制測試、審計日誌測試
- [ ] 更新計劃文件（docs/plans/rag-file-upload/file-upload-implement-plan.md）：標記階段0為進行中並更新進度
