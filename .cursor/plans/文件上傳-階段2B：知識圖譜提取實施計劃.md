<!-- 7f8029d4-8f20-4d06-ae76-818cf9d11195 d4a7580a-3f15-4854-9c27-6373599d80b4 -->
# 階段2B：知識圖譜提取實施計劃

**當前時間**: 2025-12-06 12:29:59 +0800

## 1. 當前狀態確認

### 1.1 已完成基礎設施

- ✅ 文件上傳功能（階段1完成）
- ✅ 文件分塊和向量化（階段2A完成）
- ✅ NER 服務 (`genai/api/services/ner_service.py`)
- ✅ RE 服務 (`genai/api/services/re_service.py`)
- ✅ RT 服務 (`genai/api/services/rt_service.py`)
- ✅ 三元組提取服務 (`genai/api/services/triple_extraction_service.py`)
- ✅ 知識圖譜構建服務 (`genai/api/services/kg_builder_service.py`)
- ✅ ArangoDB 客戶端封裝
- ✅ Redis 進度追蹤機制
- ✅ 處理狀態API框架

### 1.2 待完成任務

- ⏸️ 文件上傳後自動觸發知識圖譜提取
- ⏸️ 從文件分塊中提取三元組
- ⏸️ 三元組存儲到 ArangoDB
- ⏸️ 處理狀態查詢完善（包含知識圖譜提取狀態）
- ⏸️ 配置選項（提取範圍：所有分塊/部分分塊/整個文件）

## 2. 實施任務分解

### 2.1 知識圖譜提取服務封裝（1-2天）

**文件位置**: `services/api/services/kg_extraction_service.py` (新建)

**任務清單**:

1. 創建 KGExtractionService 類

   - 封裝三元組提取和圖譜構建流程
   - 整合 TripleExtractionService 和 KGBuilderService

2. 實現從分塊提取三元組的方法

   - `extract_triples_from_chunks(chunks: List[Dict], options: Dict) -> List[Triple]`
   - 支持批量處理分塊
   - 支持過濾選項（只處理重要分塊等）

3. 實現從文件提取三元組的方法

   - `extract_triples_from_file(file_id: str, options: Dict) -> List[Triple]`
   - 從文件分塊中提取，或直接從完整文件提取

4. 實現圖譜構建和存儲

   - `build_kg_from_file(file_id: str, triples: List[Triple], user_id: str) -> Dict`
   - 調用 KGBuilderService 將三元組存入 ArangoDB
   - 關聯文件ID和用戶ID

### 2.2 異步處理流程集成（2-3天）

**文件位置**: `api/routers/file_upload.py` (修改)

**任務清單**:

1. 創建知識圖譜提取異步處理函數

   - `process_kg_extraction(file_id: str, chunks: List[Dict], user_id: str, options: Dict)`
   - 從分塊提取三元組
   - 構建知識圖譜並存儲到 ArangoDB
   - 更新處理狀態到 Redis

2. 修改文件處理流程

   - 選項A：在 `process_file_chunking_and_vectorization` 中，分塊完成後觸發KG提取
   - 選項B：創建獨立的處理函數，與分塊處理並行執行
   - 建議：選項A（串行），因為KG提取依賴分塊結果

3. 處理狀態更新

   - 添加 kg_extraction 階段狀態
   - 更新進度：KG提取階段（0-100%）
   - 記錄提取的三元組數量

### 2.3 配置選項支持（1天）

**文件位置**:

- `config/config.example.json` (修改)
- `api/routers/file_upload.py` (修改)

**任務清單**:

1. 添加知識圖譜提取配置

   - `enable_kg_extraction`: 是否啟用KG提取
   - `kg_extraction_mode`: 提取模式（"all_chunks", "selected_chunks", "entire_file"）
   - `kg_chunk_filter`: 分塊過濾條件（最小長度、重要性閾值等）
   - `kg_min_confidence`: 最小置信度閾值（過濾低置信度三元組）

2. 實現配置讀取和應用

   - 從配置文件讀取KG提取選項
   - 在處理函數中應用配置

### 2.4 處理狀態查詢完善（0.5天）

**文件位置**: `api/routers/file_upload.py` (修改 `get_processing_status`)

**任務清單**:

1. 實現KG提取狀態查詢

   - 從 Redis 讀取KG提取狀態
   - 從 ArangoDB 查詢已提取的三元組統計
   - 返回詳細的提取結果

2. 返回數據結構擴展
   ```python
   {
       "file_id": str,
       "status": "pending|processing|completed|failed",
       "chunking": {...},
       "vectorization": {...},
       "storage": {...},
       "kg_extraction": {
           "status": str,
           "progress": int,
           "triples_count": int,
           "entities_count": int,
           "relations_count": int,
           "mode": str,  # "all_chunks", "selected_chunks", "entire_file"
       }
   }
   ```


### 2.5 知識圖譜查詢API（1-2天，可選）

**文件位置**: `api/routers/file_upload.py` (新增端點)

**任務清單**:

1. 實現文件相關的KG查詢端點

   - `GET /api/files/{file_id}/kg` - 獲取文件相關的知識圖譜
   - `GET /api/files/{file_id}/kg/triples` - 獲取文件提取的三元組
   - `GET /api/files/{file_id}/kg/stats` - 獲取KG統計信息

2. 實現KG可視化數據端點（可選）

   - 返回適合前端圖譜可視化的數據格式

## 3. 技術實現細節

### 3.1 知識圖譜提取流程

```python
# services/api/services/kg_extraction_service.py
class KGExtractionService:
    def __init__(self):
        self.triple_service = TripleExtractionService()
        self.kg_builder = KGBuilderService()

    async def extract_triples_from_chunks(
        self, chunks: List[Dict], options: Dict
    ) -> List[Triple]:
        # 根據配置過濾分塊
        if options.get("mode") == "selected_chunks":
            chunks = self._filter_chunks(chunks, options.get("filter"))

        # 批量提取三元組
        all_triples = []
        for chunk in chunks:
            triples = await self.triple_service.extract_triples(
                text=chunk["text"],
                entities=None,  # 自動識別實體
                enable_ner=True
            )
            # 過濾低置信度三元組
            triples = [t for t in triples if t.confidence >= options.get("min_confidence", 0.5)]
            all_triples.extend(triples)

        return self._deduplicate_triples(all_triples)
```

### 3.2 異步處理集成

```python
# api/routers/file_upload.py
async def process_file_chunking_and_vectorization(...):
    # ... 現有的分塊和向量化邏輯 ...

    # 在分塊完成後，觸發KG提取
    if config.get("kg_extraction", {}).get("enabled", True):
        await process_kg_extraction(
            file_id=file_id,
            chunks=chunks,  # 從分塊處理獲得的結果
            user_id=user_id,
            options=config.get("kg_extraction", {})
        )

async def process_kg_extraction(
    file_id: str,
    chunks: List[Dict],
    user_id: str,
    options: Dict,
) -> None:
    _update_processing_status(
        file_id=file_id,
        kg_extraction={"status": "processing", "progress": 0},
        overall_progress=85,  # KG提取在向量化之後
    )

    # 提取三元組
    kg_service = get_kg_extraction_service()
    triples = await kg_service.extract_triples_from_chunks(chunks, options)

    _update_processing_status(
        file_id=file_id,
        kg_extraction={
            "status": "processing",
            "progress": 50,
            "triples_count": len(triples),
        },
        overall_progress=92,
    )

    # 構建知識圖譜
    result = await kg_service.build_kg_from_file(file_id, triples, user_id)

    _update_processing_status(
        file_id=file_id,
        kg_extraction={
            "status": "completed",
            "progress": 100,
            "triples_count": len(triples),
            "entities_count": result.get("entities_created", 0),
            "relations_count": result.get("relations_created", 0),
        },
        overall_status="completed",
        overall_progress=100,
    )
```

### 3.3 配置示例

```json
{
  "services": {
    "kg_extraction": {
      "enabled": true,
      "mode": "all_chunks",  // "all_chunks", "selected_chunks", "entire_file"
      "min_confidence": 0.5,
      "chunk_filter": {
        "min_length": 100,
        "max_chunks": 100
      }
    }
  }
}
```

## 4. 依賴關係

### 4.1 前置條件

- ✅ 階段1必須完成（文件上傳功能）
- ✅ 階段2A必須完成（文件分塊，KG提取需要分塊結果）
- ✅ ArangoDB 服務可用
- ✅ Redis 可用（用於狀態追蹤）
- ✅ NER/RE/RT 服務可用

### 4.2 後續任務

- 階段3：整合測試
- 階段6：AI治理（可能需要KG數據）

## 5. 驗收標準

### 5.1 功能驗收

- ✅ 文件上傳完成後自動觸發知識圖譜提取
- ✅ 成功從文件分塊中提取三元組
- ✅ 三元組成功存儲到 ArangoDB
- ✅ 處理狀態可查詢（包含KG提取進度和結果）
- ✅ 配置選項生效（提取模式、過濾條件等）
- ✅ 錯誤處理正確（失敗時記錄錯誤信息）

### 5.2 性能驗收

- 小文件（< 1MB）KG提取時間 < 1分鐘
- 中文件（1-10MB）KG提取時間 < 5分鐘
- 大文件（10-50MB）KG提取時間 < 15分鐘
- 支持批量處理分塊（提高效率）

### 5.3 可靠性驗收

- 處理失敗時有明確錯誤信息
- 支持重試機制（可選）
- 狀態持久化（Redis）
- 三元組存儲成功後可查詢驗證
- 去重機制正確（避免重複三元組）

## 6. 文件更新清單

### 新建文件

- `services/api/services/kg_extraction_service.py` - 知識圖譜提取服務封裝

### 修改文件

- `api/routers/file_upload.py` - 添加KG提取異步處理和狀態查詢
- `config/config.example.json` - 添加KG提取配置
- `.env.example` - 添加KG提取相關環境變數（如需要）
- `docs/plans/rag-file-upload/file-upload-implement-plan.md` - 更新階段2B進度

### 可能的新增端點

- `GET /api/files/{file_id}/kg` - 獲取文件相關的知識圖譜
- `GET /api/files/{file_id}/kg/triples` - 獲取文件提取的三元組
- `GET /api/files/{file_id}/kg/stats` - 獲取KG統計信息

## 7. 風險與注意事項

### 7.1 技術風險

- NER/RE/RT 服務不可用時需要優雅降級
- ArangoDB 連接失敗處理
- 大文件處理可能超時（需要優化或分段處理）
- 三元組提取可能耗時較長（需要異步處理）

### 7.2 性能風險

- 批量提取三元組需要控制並發，避免過載服務
- ArangoDB 寫入性能需要測試
- 三元組去重邏輯需要優化（避免內存溢出）

### 7.3 解決方案

- 實現重試機制和超時控制
- 添加處理進度追蹤
- 實現三元組去重和過濾機制
- 支持增量更新（避免重複處理）

### To-dos

- [ ] 創建知識圖譜提取服務（KGExtractionService）：封裝三元組提取和圖譜構建流程
- [ ] 異步處理流程集成：在文件分塊完成後自動觸發知識圖譜提取
- [ ] 配置選項支持：添加KG提取配置（模式、過濾條件、置信度閾值等）
- [ ] 處理狀態查詢完善：實現KG提取狀態查詢，包含三元組數量、實體數量、關係數量
- [ ] 知識圖譜查詢API（可選）：實現文件相關的KG查詢端點
- [ ] 更新計劃文件：標記階段2B為進行中並更新進度
