<!-- ca6e6b76-34cd-4a55-811b-42bca1c2dd9c efa35aa9-3bc4-419d-9584-33d8f46ed974 -->
# 阶段 0: 准备阶段执行计划

## 目标

完成目录重构前的准备工作：备份测试代码、创建新目录结构、创建迁移日志、设置 Git 分支

## 当前状态分析

- 当前分支: `develop`
- 测试文件数量: 约 65 个测试文件需要备份
- 未提交更改: 存在一些修改的文件（需要先处理）
- pytest.ini: 存在，需要备份

## 执行步骤

### 步骤 1: 处理当前 Git 状态

**目标**: 确保工作区干净，或保存当前更改

**操作**:

1. 检查当前未提交的更改
2. 选择处理方式：

   - 选项 A: 提交当前更改到 develop 分支
   - 选项 B: 暂存当前更改（git stash）
   - 选项 C: 创建备份分支保存当前状态

**文件**:

- `agents/crewai/llm_adapter.py`
- `agents/workflows/langchain_graph/checkpoint.py`
- `services/api/main.py`
- 等 9 个修改的文件

### 步骤 2: 创建 Git 重构分支

**目标**: 创建专门的重构分支用于迁移工作

**操作**:

```bash
git checkout -b refactoring/directory-restructure
```

**检查点**:

- [ ] 分支创建成功
- [ ] 当前在重构分支上

### 步骤 3: 备份测试代码

**目标**: 备份所有现有测试文件到 `tests_backup/` 目录

**操作**:

1. 创建 `tests_backup/` 目录
2. 备份所有测试文件（test_*.py 和*_test.py）
3. 备份测试配置文件（pytest.ini）
4. 备份测试相关的其他文件（如果有）

**备份范围**:

- `tests/` 目录下的所有测试文件
- `databases/*/tests/` 目录下的测试文件
- `agents/*/tests/` 目录下的测试文件
- `pytest.ini` 配置文件

**检查点**:

- [ ] `tests_backup/` 目录已创建
- [ ] 所有测试文件已备份（验证文件数量）
- [ ] pytest.ini 已备份

### 步骤 4: 创建新目录结构

**目标**: 创建重构后的目标目录结构（空目录）

**操作**: 按照 DIRECTORY_STRUCTURE.md 创建以下目录结构：

**Database 模块**:

- `database/chromadb/`
- `database/arangodb/`
- `database/redis/`
- `database/personnel/`

**LLM 模块**:

- `llm/moe/`
- `llm/abstraction/`
- `llm/clients/` (已存在，保持)
- `llm/routing/strategies/`

**MCP 模块**:

- `mcp/server/protocol/`
- `mcp/server/tools/`
- `mcp/client/connection/`

**GenAI 模块**:

- `genai/api/routers/`
- `genai/api/services/`
- `genai/api/models/`
- `genai/workflows/langchain/`
- `genai/workflows/rag/`
- `genai/workflows/context/`
- `genai/prompt/`

**Agents 模块**:

- `agents/services/registry/`
- `agents/services/orchestrator/`
- `agents/services/processing/`
- `agents/services/file_service/`
- `agents/core/planning/`
- `agents/core/execution/`
- `agents/core/review/`
- `agents/workflows/langchain_graph/` (部分已存在)
- `agents/workflows/crewai/` (已存在)
- `agents/workflows/autogen/` (已存在)

**System 模块**:

- `system/security/`
- `system/infra/config/`
- `system/infra/logging/`
- `system/infra/monitoring/`
- `system/n8n/workflows/`

**API 模块**:

- `api/routers/`
- `api/middleware/`
- `api/core/`

**其他**:

- `storage/`
- `tests/genai/`
- `tests/mcp/`
- `tests/database/`
- `tests/llm/`
- `tests/agents/`
- `tests/system/`
- `tests/api/`

**检查点**:

- [ ] 所有新目录已创建
- [ ] 目录结构符合 DIRECTORY_STRUCTURE.md

### 步骤 5: 创建迁移日志文件

**目标**: 创建用于记录迁移过程的日志文件

**操作**:

1. 创建 `docs/REFACTORING_LOG.md` 文件
2. 添加日志模板和阶段 0 的初始记录

**日志文件内容**:

- 迁移日志模板
- 阶段 0 完成记录
- 问题追踪区域

**检查点**:

- [ ] `docs/REFACTORING_LOG.md` 已创建
- [ ] 包含日志模板和初始记录

### 步骤 6: 创建 **init**.py 文件

**目标**: 为新创建的 Python 包目录添加 **init**.py 文件

**操作**:

为所有新创建的 Python 包目录添加 `__init__.py` 文件，确保它们可以作为 Python 包导入

**检查点**:

- [ ] 所有新目录都有 `__init__.py` 文件

### 步骤 7: 验证和提交

**目标**: 验证所有准备工作完成，提交到 Git

**操作**:

1. 验证所有检查点
2. 提交阶段 0 的更改
3. 创建阶段 0 完成标签

**提交信息**:

```
refactor(stage-0): 完成阶段 0 准备工作

- 备份所有测试代码到 tests_backup/
- 创建新目录结构
- 创建迁移日志文件
- 设置重构分支
```

**检查点**:

- [ ] 所有检查点通过
- [ ] 更改已提交
- [ ] Git 标签已创建

## 最终检查清单

- [ ] Git 分支已创建并切换
- [ ] 所有测试文件已备份（约 65 个文件）
- [ ] pytest.ini 已备份
- [ ] 新目录结构已创建（所有目标目录）
- [ ] 所有新目录都有 **init**.py 文件
- [ ] 迁移日志文件已创建
- [ ] 所有更改已提交到 Git
- [ ] 阶段 0 完成标签已创建

## 注意事项

1. **Git 状态**: 当前有未提交的更改，需要先处理
2. **目录冲突**: 某些目录可能已存在（如 `llm/clients/`），需要确认处理方式
3. **备份验证**: 备份后需要验证文件数量和完整性
4. **init.py**: 确保所有新目录都有 `__init__.py`，避免导入错误

## 预计时间

- 步骤 1: 5-10 分钟（处理 Git 状态）
- 步骤 2: 1 分钟（创建分支）
- 步骤 3: 2-3 分钟（备份测试）
- 步骤 4: 3-5 分钟（创建目录）
- 步骤 5: 2-3 分钟（创建日志）
- 步骤 6: 2-3 分钟（创建 **init**.py）
- 步骤 7: 2-3 分钟（验证和提交）

**总计**: 约 15-25 分钟

### To-dos

- [ ] 处理当前 Git 状态：检查未提交更改，决定提交或暂存
- [ ] 创建重构分支：git checkout -b refactoring/directory-restructure
- [ ] 备份测试代码：创建 tests_backup/ 目录，备份所有测试文件和 pytest.ini
- [ ] 创建新目录结构：按照 DIRECTORY_STRUCTURE.md 创建所有目标目录
- [ ] 创建迁移日志文件：创建 docs/REFACTORING_LOG.md 并添加模板
- [ ] 创建 **init**.py 文件：为所有新创建的 Python 包目录添加 **init**.py
- [ ] 验证和提交：验证所有检查点，提交更改并创建阶段 0 完成标签
