<!-- 7f8029d4-8f20-4d06-ae76-818cf9d11195 2559575b-fcbd-4df3-878c-b9218eef8bb3 -->
# 阶段3和阶段4并行实施计划

**当前时间**: 2025-12-06 13:42:26 +0800

## 1. 准备任务（必须首先完成）

### 1.1 确认当前准确时间

- 任务：获取当前UTC+8时间，用于后续文件记录
- 方法：访问 https://tw.piliapp.com/time/ 确认准确时间
- 输出：记录到计划文件的时间戳

### 1.2 详阅开发规则

- 任务：阅读并理解 `@AI-Box/.cursor/rules/develop-rule.mdc` 开发规则
- 重点检查：
  - 代码文件创建规范（功能说明、创建日期、创建人、最后修改日期）
  - 类型注解规范（Optional类型使用、None检查）
  - 防御性编程规范（数据库连接检查、参数验证）
  - Git提交前检查规范（pre-commit hooks、black、ruff、mypy）
  - 项目控制表更新规范（必须读取现有文件，局部更新）

### 1.3 更新计划文件进度状态

- 文件：`docs/plans/rag-file-upload/file-upload-implement-plan.md`
- 任务：
  - 更新阶段3状态为"🔄 进行中"
  - 更新阶段4状态为"🔄 进行中"
  - 设置开始日期为当前日期
  - 更新总进度百分比
  - 更新最后修改日期

## 2. 阶段3：整合测试（与阶段4并行执行）

### 2.1 第一阶段：基础测试（不依赖阶段4）

#### 2.1.1 单元测试（2-3天）

- **任务 3.1.1.1**: FileUploadModal组件测试
  - 位置：`tests/frontend/components/test_file_upload_modal.py` 或 `tests/frontend/components/FileUploadModal.test.tsx`
  - 测试：文件选择、拖拽上传、文件类型验证、文件大小限制
  - 工具：Jest (前端) 或 pytest (如果使用Python测试前端)

- **任务 3.1.1.2**: UploadProgress组件测试
  - 位置：`tests/frontend/components/UploadProgress.test.tsx`
  - 测试：进度显示、状态管理、错误处理

- **任务 3.1.1.3**: ChatInput组件集成测试
  - 位置：`tests/frontend/components/ChatInput.test.tsx`
  - 测试：文件上传触发、模态框集成

- **任务 3.1.2.1**: 文件上传API测试
  - 位置：`tests/api/routers/test_file_upload.py`
  - 测试：文件验证、文件存储、进度追踪、错误处理
  - 工具：pytest, httpx

- **任务 3.1.2.2**: 文件分块处理测试
  - 位置：`tests/api/routers/test_chunk_processing.py`
  - 测试：文件解析、分块生成、元数据提取

- **任务 3.1.2.3**: 向量化处理测试
  - 位置：`tests/api/services/test_embedding_service.py`
  - 测试：Ollama集成、批量向量化、错误重试

- **任务 3.1.2.4**: ChromaDB存储测试
  - 位置：`tests/api/services/test_vector_store_service.py`
  - 测试：向量存储、查询、集合管理

- **任务 3.1.2.5**: NER/RE/RT服务测试
  - 位置：`tests/genai/services/test_ner_service.py`, `test_re_service.py`, `test_rt_service.py`
  - 测试：服务调用、结果验证

- **任务 3.1.2.6**: 知识图谱构建测试
  - 位置：`tests/api/services/test_kg_extraction_service.py`
  - 测试：三元组提取、图谱构建、去重

- **任务 3.1.2.7**: ArangoDB存储测试
  - 位置：`tests/genai/services/test_kg_builder_service.py`
  - 测试：实体创建、关系创建、图谱查询

#### 2.1.2 集成测试 - 核心流程（2-3天）

- **任务 3.2.1.1**: 完整上传流程测试
  - 位置：`tests/integration/test_file_upload_flow.py`
  - 测试：文件上传 → 存储 → 返回file_id

- **任务 3.2.1.2**: 完整处理流程测试
  - 位置：`tests/integration/test_file_processing_flow.py`
  - 测试：上传 → 分块 → 向量化 → 存储到ChromaDB

- **任务 3.2.1.3**: 完整图谱提取流程测试
  - 位置：`tests/integration/test_kg_extraction_flow.py`
  - 测试：上传 → 分块 → KG提取 → 存储到ArangoDB

- **任务 3.2.2.1**: 前端-后端集成测试
  - 位置：`tests/integration/test_frontend_backend.py`
  - 测试：前端上传 → 后端处理 → 状态查询

- **任务 3.2.2.2**: 后端-数据库集成测试
  - 位置：`tests/integration/test_backend_database.py`
  - 测试：ChromaDB连接、ArangoDB连接、Redis连接

- **任务 3.2.2.3**: 后端-外部服务集成测试
  - 位置：`tests/integration/test_backend_external_services.py`
  - 测试：Ollama服务调用、错误处理

#### 2.1.3 性能测试（2-3天）

- **任务 3.3.1.1**: 单文件上传性能测试
  - 位置：`tests/performance/test_single_file_upload.py`
  - 工具：Locust 或 pytest-benchmark
  - 指标：上传时间、响应时间

- **任务 3.3.1.2**: 多文件并发上传测试
  - 位置：`tests/performance/test_concurrent_upload.py`
  - 测试：并发上传、资源竞争、错误处理

- **任务 3.3.1.3**: 处理性能测试
  - 位置：`tests/performance/test_processing_performance.py`
  - 测试：分块时间、向量化时间、KG提取时间

- **任务 3.3.2.1**: 高并发测试
  - 位置：`tests/performance/test_high_concurrency.py`
  - 工具：Locust
  - 测试：100+并发用户场景

- **任务 3.3.2.2**: 长时间运行测试
  - 位置：`tests/performance/test_long_running.py`
  - 测试：稳定性、内存泄漏、资源释放

#### 2.1.4 安全测试（1-2天）

- **任务 3.4.1.1**: 恶意文件检测测试
  - 位置：`tests/security/test_malicious_file.py`
  - 测试：病毒文件、恶意代码、路径遍历攻击

- **任务 3.4.1.2**: 文件类型伪造测试
  - 位置：`tests/security/test_file_type_spoofing.py`
  - 测试：扩展名伪造、MIME类型伪造

- **任务 3.4.1.3**: 文件大小限制测试
  - 位置：`tests/security/test_file_size_limit.py`
  - 测试：超大文件、边界值测试

- **任务 3.4.2.1**: 认证授权测试
  - 位置：`tests/security/test_auth_authorization.py`
  - 测试：Token验证、权限检查、未授权访问

- **任务 3.4.2.2**: 输入验证测试
  - 位置：`tests/security/test_input_validation.py`
  - 测试：SQL注入、XSS攻击、参数验证

- **任务 3.4.2.3**: 速率限制测试
  - 位置：`tests/security/test_rate_limiting.py`
  - 测试：API限流、DDoS防护

#### 2.1.5 兼容性测试（1天）

- **任务 3.5.1.1**: Chrome测试
- **任务 3.5.1.2**: Firefox测试
- **任务 3.5.1.3**: Safari测试
- **任务 3.5.1.4**: Edge测试
- 位置：`tests/compatibility/test_browser_compatibility.py`
- 工具：Selenium 或 Playwright

### 2.2 第二阶段：完整测试（依赖阶段4完成后）

#### 2.2.1 端到端流程测试 - 文件管理集成（1-2天）

- **任务 3.2.1.4**: 完整RAG流程测试（包含文件管理）
  - 位置：`tests/integration/test_complete_rag_flow.py`
  - 测试：上传 → 处理 → 查询 → 下载 → 删除

- **任务 3.2.3.1**: 文件管理功能测试
  - 位置：`tests/integration/test_file_management.py`
  - 测试：文件列表查询、文件搜索、文件下载、文件删除

## 3. 阶段4：文件管理系统（与阶段3并行执行）

### 3.1 后端开发（2-3天）

#### 3.1.1 文件元数据管理（1-2天）

- **任务 4.1.1.1**: 扩展文件元数据模型
  - 位置：`services/api/models/file_metadata.py` (检查是否存在，如存在则扩展)
  - 字段：file_id, user_id, task_id, filename, file_type, file_size, upload_time, status, processing_status, chunk_count, vector_count, kg_status
  - 参考：检查现有 `FileMetadataService` 和 `FileMetadataCreate` 模型

- **任务 4.1.1.2**: 实现文件元数据API
  - 位置：`api/routers/file_metadata.py` (检查是否存在)
  - 功能：查询、更新文件元数据
  - 端点：`GET /api/files/{file_id}/metadata`, `PUT /api/files/{file_id}/metadata`

- **任务 4.1.1.3**: 实现文件列表查询API
  - 位置：`api/routers/file_upload.py` 或新建 `api/routers/file_management.py`
  - 功能：按用户ID、任务ID查询文件列表
  - 端点：`GET /api/files?user_id={user_id}&task_id={task_id}&limit={limit}&offset={offset}`

- **任务 4.1.1.4**: 实现文件搜索API
  - 位置：`api/routers/file_management.py`
  - 功能：按文件名、类型、时间范围搜索
  - 端点：`GET /api/files/search?user_id={user_id}&query={keyword}&file_type={type}&start_date={date}&end_date={date}`

#### 3.1.2 文件操作API（1天）

- **任务 4.1.2.1**: 实现文件下载API
  - 位置：`api/routers/file_upload.py` 或 `api/routers/file_management.py`
  - 功能：文件下载、权限验证、下载记录
  - 端点：`GET /api/files/{file_id}/download`
  - 注意：需要权限验证（使用 `get_current_user`）

- **任务 4.1.2.2**: 实现文件预览API
  - 位置：`api/routers/file_management.py`
  - 功能：文件内容预览（文本文件）、预览链接生成
  - 端点：`GET /api/files/{file_id}/preview`

- **任务 4.1.2.3**: 增强文件删除API
  - 位置：`api/routers/file_upload.py` (检查现有删除功能)
  - 功能：删除文件、删除关联的向量、删除关联的KG数据
  - 端点：`DELETE /api/files/{file_id}`
  - 注意：需要级联删除（ChromaDB向量、ArangoDB KG数据）

- **任务 4.1.2.4**: 实现文件树结构API
  - 位置：`api/routers/file_management.py`
  - 功能：按任务ID组织文件树结构
  - 端点：`GET /api/files/tree?user_id={user_id}&task_id={task_id}`

### 3.2 前端开发（2-3天）

#### 3.2.1 文件列表组件（1天）

- **任务 4.2.1.1**: 创建FileList组件
  - 位置：`ai-bot/src/components/FileList.tsx`
  - 功能：显示文件列表，支持按任务分组、分页、排序

- **任务 4.2.1.2**: 实现文件列表视图
  - 功能：表格视图、卡片视图、列表视图切换

- **任务 4.2.1.3**: 实现文件操作按钮
  - 功能：下载、预览、删除按钮，操作确认对话框

#### 3.2.2 文件操作组件（1天）

- **任务 4.2.2.1**: 实现文件下载功能
  - 位置：`ai-bot/src/lib/api.ts`
  - 功能：调用下载API、处理下载响应、错误处理

- **任务 4.2.2.2**: 实现文件预览功能
  - 位置：`ai-bot/src/components/FilePreview.tsx`
  - 功能：文本预览、PDF预览（如支持）、图片预览

- **任务 4.2.2.3**: 实现文件删除功能
  - 位置：`ai-bot/src/components/FileList.tsx`
  - 功能：删除确认对话框、删除API调用、列表更新

#### 3.2.3 文件搜索和过滤（0.5天）

- **任务 4.2.3.1**: 实现文件搜索组件
  - 位置：`ai-bot/src/components/FileSearch.tsx`
  - 功能：搜索输入框、搜索API调用、搜索结果展示

- **任务 4.2.3.2**: 实现文件过滤功能
  - 功能：按文件类型过滤、按时间范围过滤、按状态过滤

#### 3.2.4 文件管理页面集成（1天）

- **任务 4.2.4.1**: 创建FileManagement页面
  - 位置：`ai-bot/src/pages/FileManagement.tsx`
  - 功能：整合FileList、FileSearch组件，实现完整文件管理页面

- **任务 4.2.4.2**: 在侧边栏添加文件管理入口
  - 位置：`ai-bot/src/components/Sidebar.tsx`
  - 功能：添加"文件管理"菜单项、路由跳转

- **任务 4.2.4.3**: 实现文件管理页面路由
  - 位置：`ai-bot/src/App.tsx` 或路由配置文件
  - 功能：添加 `/files` 路由

### 3.3 集成和优化（1天）

#### 3.3.1 文件上传后自动挂载（0.5天）

- **任务 4.3.1.1**: 修改文件上传API响应
  - 位置：`api/routers/file_upload.py`
  - 功能：返回文件元数据，包含user_id和task_id

- **任务 4.3.1.2**: 实现文件自动挂载逻辑
  - 位置：`ai-bot/src/components/FileUploadModal.tsx` 或 `ChatInput.tsx`
  - 功能：上传完成后自动添加到当前任务的文件列表

#### 3.3.2 文件列表同步（0.5天）

- **任务 4.3.2.1**: 实现文件列表自动刷新
  - 位置：`ai-bot/src/components/FileList.tsx`
  - 功能：上传后自动更新文件列表、实时状态更新

- **任务 4.3.2.2**: 实现文件状态显示
  - 位置：`ai-bot/src/components/FileList.tsx`
  - 功能：显示上传状态、处理状态（分块、向量化、KG提取）

## 4. 并行执行策略

### 4.1 时间线

```
Week 1-2: 阶段3基础测试 + 阶段4后端开发（并行）
Week 2-3: 阶段3集成测试 + 阶段4前端开发（并行）
Week 3-4: 阶段3性能/安全测试 + 阶段4集成优化（并行）
Week 4:   阶段3完整测试（使用阶段4功能）+ 阶段4完成
```

### 4.2 依赖关系

- 阶段3的基础测试（单元测试、核心集成测试、性能测试、安全测试）可以独立进行
- 阶段3的完整端到端测试需要阶段4的文件管理API支持
- 阶段4完成后，阶段3可以补充文件管理相关的测试用例

### 4.3 协调点

- 阶段4的文件列表查询API完成后，阶段3可以开始文件管理功能测试
- 阶段4的文件下载/删除API完成后，阶段3可以完成完整的端到端测试

## 5. 文件更新清单

### 5.1 计划文件更新

- `docs/plans/rag-file-upload/file-upload-implement-plan.md`
  - 更新阶段3和阶段4的状态为"🔄 进行中"
  - 设置开始日期
  - 更新总进度

### 5.2 新建文件（阶段3）

- `tests/frontend/components/FileUploadModal.test.tsx`
- `tests/frontend/components/UploadProgress.test.tsx`
- `tests/frontend/components/ChatInput.test.tsx`
- `tests/api/routers/test_file_upload.py`
- `tests/api/routers/test_chunk_processing.py`
- `tests/api/services/test_embedding_service.py`
- `tests/api/services/test_vector_store_service.py`
- `tests/api/services/test_kg_extraction_service.py`
- `tests/genai/services/test_kg_builder_service.py`
- `tests/integration/test_file_upload_flow.py`
- `tests/integration/test_file_processing_flow.py`
- `tests/integration/test_kg_extraction_flow.py`
- `tests/integration/test_frontend_backend.py`
- `tests/integration/test_backend_database.py`
- `tests/integration/test_backend_external_services.py`
- `tests/performance/test_single_file_upload.py`
- `tests/performance/test_concurrent_upload.py`
- `tests/performance/test_processing_performance.py`
- `tests/performance/test_high_concurrency.py`
- `tests/performance/test_long_running.py`
- `tests/security/test_malicious_file.py`
- `tests/security/test_file_type_spoofing.py`
- `tests/security/test_file_size_limit.py`
- `tests/security/test_auth_authorization.py`
- `tests/security/test_input_validation.py`
- `tests/security/test_rate_limiting.py`
- `tests/compatibility/test_browser_compatibility.py`
- `tests/integration/test_file_management.py` (阶段4完成后)

### 5.3 新建/修改文件（阶段4）

- `services/api/models/file_metadata.py` (检查并扩展)
- `api/routers/file_metadata.py` (检查是否存在)
- `api/routers/file_management.py` (新建)
- `api/routers/file_upload.py` (修改：增强删除功能，添加下载功能)
- `ai-bot/src/components/FileList.tsx` (新建)
- `ai-bot/src/components/FilePreview.tsx` (新建)
- `ai-bot/src/components/FileSearch.tsx` (新建)
- `ai-bot/src/pages/FileManagement.tsx` (新建)
- `ai-bot/src/components/Sidebar.tsx` (修改：添加文件管理入口)
- `ai-bot/src/components/FileUploadModal.tsx` (修改：上传后自动挂载)
- `ai-bot/src/components/ChatInput.tsx` (修改：文件列表同步)
- `ai-bot/src/lib/api.ts` (修改：添加文件管理API调用)

## 6. 验收标准

### 6.1 阶段3验收

- 所有单元测试通过率 > 90%
- 所有集成测试通过
- 性能测试满足指标（上传时间、处理时间）
- 安全测试无严重漏洞
- 兼容性测试通过主流浏览器

### 6.2 阶段4验收

- 文件列表查询功能正常
- 文件搜索功能正常
- 文件下载功能正常（含权限验证）
- 文件删除功能正常（含级联删除）
- 文件上传后自动显示在列表中
- 前端文件管理页面可用

## 7. 注意事项

1. **代码规范**：所有新建文件必须遵循开发规则，包含文件头注释（功能说明、创建日期、创建人、最后修改日期）
2. **类型注解**：Python代码必须使用完整的类型注解，特别是Optional类型
3. **防御性编程**：所有数据库操作前必须检查连接状态
4. **测试覆盖**：确保关键功能有测试覆盖
5. **进度更新**：每完成一个主要任务，更新WBS文件的checkbox和进度表
6. **Git提交**：提交前必须通过pre-commit hooks检查（black、ruff、mypy）

### To-dos

- [ ] 确认当前准确时间（UTC+8），用于后续文件记录
- [ ] 详阅并遵循开发规则（develop-rule.mdc），特别关注代码规范、类型注解、防御性编程、Git提交规范
- [ ] 更新计划文件进度状态：阶段3和阶段4状态改为进行中，设置开始日期，更新总进度
- [ ] 阶段3：实现前端组件单元测试（FileUploadModal、UploadProgress、ChatInput）
- [ ] 阶段3：实现后端服务单元测试（文件上传、分块、向量化、ChromaDB、KG提取、ArangoDB）
- [ ] 阶段3：实现核心集成测试（上传流程、处理流程、KG提取流程、服务间集成）
- [ ] 阶段3：实现性能测试（单文件上传、并发上传、处理性能、高并发、长时间运行）
- [ ] 阶段3：实现安全测试（恶意文件检测、文件类型伪造、文件大小限制、认证授权、输入验证、速率限制）
- [ ] 阶段3：实现兼容性测试（Chrome、Firefox、Safari、Edge）
- [ ] 阶段4：实现文件元数据管理（扩展模型、元数据API、列表查询API、搜索API）
- [ ] 阶段4：实现文件操作API（下载、预览、删除增强、文件树结构）
- [ ] 阶段4：实现前端文件管理组件（FileList、FilePreview、FileSearch）
- [ ] 阶段4：实现文件管理页面集成（FileManagement页面、侧边栏入口、路由配置）
- [ ] 阶段4：实现集成和优化（上传后自动挂载、文件列表同步、状态显示）
- [ ] 阶段3：完成端到端测试（使用阶段4的文件管理功能进行完整RAG流程测试）
