# ⚠️ AI 開發規範檢查清單 - 強制執行

**創建日期**: 2025-12-21
**創建人**: Daniel Chung
**最後修改日期**: 2025-12-21
**優先級**: 🔴 **最高優先級** - 每次代碼修改前後必須執行

> **🚨 重要提醒**：無論在任何聊天室，AI 助手都必須在每次代碼修改前後嚴格遵循此檢查清單！

---

## 📋 每次代碼修改後的標準檢查流程

### 第一步：更新文件頭註釋（優先級最高） ⚠️

**必須執行的操作**：

1. **確認當前日期**：
   - 使用網絡搜索工具確認當天的日期和時間（UTC+8）
   - 例如：`https://tw.piliapp.com/time/`

2. **更新文件頭註釋**：
   - ✅ **所有修改的文件**都必須更新「最後修改日期」
   - ✅ **所有新建的文件**都必須包含完整的文件頭：

     ```python
     # 代碼功能說明: [功能描述]
     # 創建日期: [YYYY-MM-DD]
     # 創建人: Daniel Chung
     # 最後修改日期: [YYYY-MM-DD]
     ```

**檢查命令**：

```bash
# 檢查文件頭註釋格式
grep -r "^# 最後修改日期:" <修改的文件>
```

---

### 第二步：代碼格式檢查（必須全部通過） ✅

**執行順序**：

1. **Black 格式化**：

   ```bash
   black <修改的文件>
   ```

2. **Ruff 檢查和修復**：

   ```bash
   ruff check --fix <修改的文件>
   ```

3. **Mypy 類型檢查**：

   ```bash
   mypy <修改的文件>
   ```

**必須條件**：

- ✅ 所有檢查必須通過
- ✅ 如果失敗，必須修復錯誤後重新檢查
- ✅ 不能跳過任何檢查步驟

---

### 第三步：代碼質量檢查清單

**類型注解要求**：

- [ ] 所有函數參數都有類型注解
- [ ] 所有返回值都有類型注解
- [ ] 使用 `Optional[T]` 而不是 `T = None`
- [ ] 沒有隱式的 Optional 類型

**防禦性編程要求**：

- [ ] 所有可能為 None 的值都有檢查
- [ ] 數據庫連接使用前有 None 檢查
- [ ] 模型對象使用前有可用性檢查

**代碼結構要求**：

- [ ] Import 語句在文件頂部
- [ ] 沒有未使用的變量（除非在 scripts 目錄）
- [ ] 代碼符合 pyproject.toml 中的配置

---

## 🚨 強制執行規則

### 規則 1：任何代碼修改都必須執行完整檢查流程

**禁止**：

- ❌ 跳過文件頭日期更新
- ❌ 跳過代碼格式檢查
- ❌ 跳過類型檢查
- ❌ 在檢查失敗時標記任務為完成

**必須**：

- ✅ 按順序執行所有檢查步驟
- ✅ 修復所有檢查錯誤
- ✅ 確認所有檢查通過後才能標記完成

---

### 規則 2：文件頭註釋更新是最高優先級

**執行時機**：

- ✅ **修改文件前**：確認當前日期
- ✅ **修改文件後**：立即更新「最後修改日期」
- ✅ **創建新文件時**：添加完整文件頭註釋

**日期格式**：

- 格式：`YYYY-MM-DD`
- 時區：UTC+8
- 來源：必須通過網絡搜索確認，不得使用假設日期

---

### 規則 3：檢查失敗時必須修復，不得跳過

**流程**：

```
代碼修改完成
    ↓
更新文件頭日期
    ↓
運行 black 格式化
    ↓ (如果失敗，修復後重新運行)
運行 ruff 檢查
    ↓ (如果失敗，修復後重新運行)
運行 mypy 檢查
    ↓ (如果失敗，修復後重新運行)
所有檢查通過 ✅
    ↓
標記任務完成
```

---

## 📝 標準檢查腳本

創建一個腳本來自動化檢查流程：

```bash
#!/bin/bash
# check_code_quality.sh
# 自動化代碼質量檢查腳本

FILE=$1

if [ -z "$FILE" ]; then
    echo "❌ 錯誤: 請指定要檢查的文件"
    echo "用法: ./check_code_quality.sh <文件路徑>"
    exit 1
fi

echo "🔍 檢查文件: $FILE"
echo ""

# 1. Black 格式化
echo "1️⃣ 運行 Black 格式化..."
black "$FILE" || {
    echo "❌ Black 格式化失敗"
    exit 1
}
echo "✅ Black 格式化通過"
echo ""

# 2. Ruff 檢查
echo "2️⃣ 運行 Ruff 檢查..."
ruff check --fix "$FILE" || {
    echo "❌ Ruff 檢查失敗"
    exit 1
}
echo "✅ Ruff 檢查通過"
echo ""

# 3. Mypy 檢查
echo "3️⃣ 運行 Mypy 類型檢查..."
mypy "$FILE" || {
    echo "❌ Mypy 檢查失敗"
    exit 1
}
echo "✅ Mypy 檢查通過"
echo ""

echo "🎉 所有檢查通過！"
```

---

## 🔍 AI 助手執行檢查的標準流程

當 AI 助手修改任何代碼文件時，必須按以下流程執行：

### 步驟 1：修改前準備

1. 確認要修改的文件
2. 讀取文件內容
3. **確認當前日期**（使用網絡搜索）

### 步驟 2：執行修改

1. 進行代碼修改
2. 保存文件
3. **立即更新文件頭「最後修改日期」**

### 步驟 3：執行檢查（順序執行）

1. **運行 Black**：

   ```bash
   black <文件路徑>
   ```

2. **運行 Ruff**：

   ```bash
   ruff check --fix <文件路徑>
   ```

3. **運行 Mypy**：

   ```bash
   mypy <文件路徑>
   ```

### 步驟 4：處理檢查結果

- 如果所有檢查通過：✅ 繼續下一步
- 如果有檢查失敗：
  1. 讀取錯誤信息
  2. 修復錯誤
  3. 重新運行失敗的檢查
  4. 重複直到所有檢查通過

### 步驟 5：確認完成

- ✅ 文件頭日期已更新
- ✅ Black 格式化通過
- ✅ Ruff 檢查通過
- ✅ Mypy 檢查通過
- ✅ 所有錯誤已修復

---

## 📚 參考文檔

**規範文檔**：

- 📋 [系統整改計劃.md](docs/第三次整改/系統整改計劃.md) - 開發規範詳細說明
- 📋 [pyproject.toml](services/api/pyproject.toml) - 項目配置與工具設置
- 📋 [AI編寫代碼規範指南.md](docs/開發規範/AI編寫代碼規範指南.md) - AI 編寫代碼規範

**工具配置**：

- `pyproject.toml`: Black、Ruff、Mypy 配置
- `.pre-commit-config.yaml`: Pre-commit hooks 配置

---

## ⚡ 快速參考

### 單文件檢查命令

```bash
# 完整檢查流程（一行命令）
FILE="path/to/file.py" && \
  black "$FILE" && \
  ruff check --fix "$FILE" && \
  mypy "$FILE" && \
  echo "✅ 所有檢查通過"
```

### 批量檢查命令

```bash
# 檢查所有修改的文件
git diff --name-only HEAD | grep '\.py$' | xargs -I {} sh -c 'black {} && ruff check --fix {} && mypy {}'
```

---

## 🎯 檢查清單總結

**每次代碼修改後，AI 助手必須確認**：

- [ ] ✅ 文件頭「最後修改日期」已更新為當前日期（通過網絡搜索確認）
- [ ] ✅ Black 格式化已運行並通過
- [ ] ✅ Ruff 檢查已運行並通過
- [ ] ✅ Mypy 類型檢查已運行並通過
- [ ] ✅ 所有錯誤已修復
- [ ] ✅ 新文件包含完整的文件頭註釋

**只有當所有項目都完成並通過檢查後，才能標記任務為完成！**

---

**最後更新**: 2025-12-21
**維護人**: Daniel Chung
