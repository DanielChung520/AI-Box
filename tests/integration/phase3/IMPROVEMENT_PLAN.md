# 階段三測試跳過率改善計劃

**創建日期**: 2025-11-30
**創建人**: Daniel Chung
**狀態**: 待實施

---

## 一、問題分析

### 當前測試結果

- **總測試數**: 14
- **通過**: 6 (42.9%)
- **跳過**: 8 (57.1%) ⚠️
- **失敗**: 0
- **執行時間**: 420.56 秒

### 主要問題

#### 1. IT-3.1 LangChain 測試（3個全部跳過）

**錯誤類型**: 500 Internal Server Error
**測試端點**: `/api/v1/workflows/langchain/execute`

**根本原因**:
1. 工作流工廠構建失敗（依賴服務未啟動）
2. 異常處理不完善，只返回 500，未記錄詳細錯誤
3. 可能缺少 LLM 服務或數據庫連接

#### 2. IT-3.2 CrewAI 測試（5個全部跳過）⚠️ **關鍵問題**

**錯誤類型**: 404 Not Found
**測試端點**: `/api/v1/crews`

**根本原因**: **路由路徑重複**
- 路由定義: `@router.post("/api/v1/crews", ...)` (已包含 `/api/v1`)
- 路由註冊: `app.include_router(crewai.router, prefix=API_PREFIX)` (又加了 `/api/v1`)
- **實際路徑變成**: `/api/v1/api/v1/crews` → 404

---

## 二、立即修復方案

### 修復 1: CrewAI 路由路徑（優先級 P0）

**問題**: 路由定義重複包含 `/api/v1` 前綴

**解決方案**: 移除路由定義中的 `/api/v1` 前綴

**需要修改的文件**:
- `services/api/routers/crewai.py`: 所有路由定義移除 `/api/v1` 前綴

### 修復 2: LangChain 錯誤處理（優先級 P0）

**問題**: 異常處理不完善，無法獲知具體錯誤

**解決方案**:
1. 添加詳細錯誤日誌
2. 返回更詳細的錯誤信息給客戶端

---

## 三、改善建議

### 1. 添加依賴檢查 Fixture
- 測試執行前檢查所有必需服務
- 明確提示缺失的依賴

### 2. 改善錯誤處理
- 記錄詳細錯誤日誌
- 返回結構化的錯誤信息

### 3. 添加健康檢查端點
- 為每個工作流類型添加健康檢查
- 測試執行前驗證服務狀態

---

## 四、預期效果

**短期（修復後）**:
- CrewAI 測試不再 404
- LangChain 測試能顯示詳細錯誤
- 跳過率降至 < 30%

**中期（1週內）**:
- 跳過率降至 < 20%
- 所有依賴檢查到位

**長期（1個月內）**:
- 跳過率降至 < 10%
- 完善的測試文檔和監控
