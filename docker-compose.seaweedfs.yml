# 代碼功能說明: SeaweedFS Docker Compose 配置（AI-Box 服務）
# 創建日期: 2025-12-29
# 創建人: Daniel Chung
# 最後修改日期: 2026-01-29
# 說明: 移除 version（Docker Compose v2 已棄用）；Filer 改掛載 config/seaweedfs 提供 s3.json

services:
  # SeaweedFS Master 節點
  seaweedfs-master:
    image: chrislusf/seaweedfs:latest
    container_name: seaweedfs-ai-box-master
    command: "master -ip=seaweedfs-master -port=9333"
    ports:
      - "9333:9333"
    networks:
      - seaweedfs-network
    volumes:
      - seaweedfs-master-data:/data
    restart: unless-stopped

  # SeaweedFS Volume 節點
  seaweedfs-volume:
    image: chrislusf/seaweedfs:latest
    container_name: seaweedfs-ai-box-volume
    command: "volume -mserver=seaweedfs-master:9333 -port=8080"
    depends_on:
      - seaweedfs-master
    networks:
      - seaweedfs-network
    volumes:
      - seaweedfs-volume-data:/data
    restart: unless-stopped

  # SeaweedFS Filer 節點（提供 S3 API 和 Filer API）
  seaweedfs-filer:
    image: chrislusf/seaweedfs:latest
    container_name: seaweedfs-ai-box-filer
    # 修改時間：2026-01-28 - 恢復使用 -s3.config 參數（文件已存在，需要配置才能看到 buckets）
    # 修改時間：2026-01-28 - 添加 filer 數據持久化 volume，避免刪除容器時丟失元數據
    command: "filer -master=seaweedfs-master:9333 -s3 -s3.port=8333 -s3.config=/etc/seaweedfs/s3.json"
    ports:
      - "8888:8888" # Filer API
      - "8333:8333" # S3 API
    depends_on:
      - seaweedfs-master
      - seaweedfs-volume
    networks:
      - seaweedfs-network
    environment:
      - SEAWEEDFS_S3_ACCESS_KEY=${AI_BOX_SEAWEEDFS_S3_ACCESS_KEY:-admin}
      - SEAWEEDFS_S3_SECRET_KEY=${AI_BOX_SEAWEEDFS_S3_SECRET_KEY:-admin123}
    volumes:
      - ./config/seaweedfs:/etc/seaweedfs:ro  # s3.json 須存在，否則 Filer 會崩潰
      - seaweedfs-ai-box-filer-data:/data  # 持久化 Filer 元數據（filerldb2）
    restart: unless-stopped

networks:
  seaweedfs-network:
    driver: bridge

volumes:
  seaweedfs-master-data:
  seaweedfs-volume-data:
  seaweedfs-ai-box-filer-data:  # Filer 元數據持久化存儲
