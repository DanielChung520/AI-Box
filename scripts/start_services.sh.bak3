#!/bin/bash
# ä»£ç¢¼åŠŸèƒ½èªªæ˜: å•Ÿå‹• AI-Box æœå‹™è…³æœ¬

# åŠ è¼‰ .env æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
if [ -f .env ]; then
    set -a
    source .env
    set +a
fi

# å‰µå»ºæ—¥æœŸ: 2025-01-27
# å‰µå»ºäºº: Daniel Chung
# æœ€å¾Œä¿®æ”¹æ—¥æœŸ: 2025-12-29

set -e

# é¡è‰²å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æœå‹™é…ç½®
ARANGODB_PORT=8529
CHROMADB_PORT=8001
FASTAPI_PORT=8000
REDIS_PORT=6379
MCP_SERVER_PORT=8002
FRONTEND_PORT=3000

# SeaweedFS ç«¯å£é…ç½®
AI_BOX_SEAWEEDFS_MASTER_PORT=9333
AI_BOX_SEAWEEDFS_FILER_PORT=8888
AI_BOX_SEAWEEDFS_S3_PORT=8333
DATALAKE_SEAWEEDFS_MASTER_PORT=9334
DATALAKE_SEAWEEDFS_FILER_PORT=8889
DATALAKE_SEAWEEDFS_S3_PORT=8334

# é …ç›®æ ¹ç›®éŒ„
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$PROJECT_ROOT"

# æ—¥èªŒç›®éŒ„
LOG_DIR="$PROJECT_ROOT/logs"
mkdir -p "$LOG_DIR"

# å‡½æ•¸ï¼šæª¢æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
check_port() {
    local port=$1
    # æ£€æŸ¥ LISTEN çŠ¶æ€çš„ç«¯å£
    if lsof -Pi :$port -sTCP:LISTEN -t >/dev/null 2>&1; then
        return 0  # ç«¯å£è¢«å ç”¨ï¼ˆLISTEN çŠ¶æ€ï¼‰
    fi
    # æ£€æŸ¥å…¶ä»–çŠ¶æ€çš„ç«¯å£ï¼ˆåŒ…æ‹¬ CLOSEDï¼‰
    if lsof -ti :$port >/dev/null 2>&1; then
        return 0  # ç«¯å£è¢«å ç”¨ï¼ˆå…¶ä»–çŠ¶æ€ï¼‰
    fi
    return 1  # ç«¯å£æœªè¢«å ç”¨
}

# å‡½æ•¸ï¼šé—œé–‰å ç”¨ç«¯å£çš„é€²ç¨‹
kill_port() {
    local port=$1
    local service_name=$2

    if check_port $port; then
        echo -e "${YELLOW}æª¢æ¸¬åˆ°ç«¯å£ $port å·²è¢«å ç”¨ï¼Œæ­£åœ¨é—œé–‰...${NC}"
        local pids=$(lsof -ti :$port)
        if [ -n "$pids" ]; then
            for pid in $pids; do
                local proc_name=$(ps -p $pid -o comm= 2>/dev/null || echo "unknown")
                echo -e "${YELLOW}  é—œé–‰é€²ç¨‹ $pid ($proc_name) - ç«¯å£ $port${NC}"
                # å…ˆå˜—è©¦å„ªé›…é—œé–‰
                kill $pid 2>/dev/null || true
                sleep 1
                # å¦‚æœé‚„åœ¨é‹è¡Œï¼Œå¼·åˆ¶é—œé–‰
                if kill -0 $pid 2>/dev/null; then
                    kill -9 $pid 2>/dev/null || true
                fi
            done
            # ç­‰å¾…é€²ç¨‹å®Œå…¨é€€å‡º
            sleep 2
            # å†æ¬¡æª¢æŸ¥
            local remaining_pids=$(lsof -ti :$port 2>/dev/null)
            if [ -n "$remaining_pids" ]; then
                echo -e "${RED}  è­¦å‘Š: ç«¯å£ $port ä»è¢«å ç”¨ (PID: $remaining_pids)${NC}"
                echo -e "${YELLOW}  å˜—è©¦å¼·åˆ¶é—œé–‰...${NC}"
                for pid in $remaining_pids; do
                    kill -9 $pid 2>/dev/null || true
                done
                sleep 1
                if check_port $port; then
                    echo -e "${RED}  éŒ¯èª¤: ç„¡æ³•é‡‹æ”¾ç«¯å£ $port${NC}"
                    return 1
                fi
            fi
            echo -e "${GREEN}  ç«¯å£ $port å·²é‡‹æ”¾${NC}"
        fi
    fi
    return 0
}

# å‡½æ•¸ï¼šå•Ÿå‹• ArangoDB
start_arangodb() {
    echo -e "${BLUE}=== å•Ÿå‹• ArangoDB ===${NC}"

    kill_port $ARANGODB_PORT "ArangoDB"

    # æª¢æŸ¥ Docker æ˜¯å¦å®‰è£
    if ! command -v docker &> /dev/null; then
        echo -e "${RED}éŒ¯èª¤: Docker æœªå®‰è£${NC}"
        echo -e "${YELLOW}è«‹å…ˆå®‰è£ Docker Desktop: https://www.docker.com/products/docker-desktop${NC}"
        return 1
    fi

    # æª¢æŸ¥ Docker daemon æ˜¯å¦é‹è¡Œ
    if ! docker ps &> /dev/null 2>&1; then
        echo -e "${RED}éŒ¯èª¤: Docker daemon æœªé‹è¡Œ${NC}"
        echo -e "${YELLOW}è«‹åŸ·è¡Œä»¥ä¸‹æ“ä½œä¹‹ä¸€ï¼š${NC}"
        echo -e "${YELLOW}  1. å•Ÿå‹• Docker Desktop æ‡‰ç”¨ç¨‹å¼${NC}"
        echo -e "${YELLOW}  2. æˆ–é‹è¡Œ: open -a Docker${NC}"
        echo ""

        # å˜—è©¦è‡ªå‹•å•Ÿå‹• Docker Desktop (macOS)
        if [[ "$OSTYPE" == "darwin"* ]]; then
            echo -e "${BLUE}å˜—è©¦è‡ªå‹•å•Ÿå‹• Docker Desktop...${NC}"
            if open -a Docker 2>/dev/null; then
                echo -e "${GREEN}å·²å˜—è©¦å•Ÿå‹• Docker Desktopï¼Œè«‹ç­‰å¾…å…¶å®Œå…¨å•Ÿå‹•å¾Œé‡æ–°é‹è¡Œæ­¤å‘½ä»¤${NC}"
                echo -e "${YELLOW}æç¤º: Docker Desktop é€šå¸¸éœ€è¦ 10-30 ç§’æ‰èƒ½å®Œå…¨å•Ÿå‹•${NC}"
            else
                echo -e "${YELLOW}ç„¡æ³•è‡ªå‹•å•Ÿå‹• Docker Desktopï¼Œè«‹æ‰‹å‹•å•Ÿå‹•${NC}"
            fi
        fi

        return 1
    fi

    # æŸ¥æ‰¾ ArangoDB å®¹å™¨
    local container=$(docker ps -a --format '{{.Names}}' | grep -i arango | head -1)
    if [ -n "$container" ]; then
        echo -e "${GREEN}ç™¼ç¾ ArangoDB Docker å®¹å™¨: $container${NC}"

        # æª¢æŸ¥å®¹å™¨æ˜¯å¦å·²åœ¨é‹è¡Œ
        if docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
            echo -e "${GREEN}âœ… ArangoDB å·²åœ¨é‹è¡Œ (ç«¯å£ $ARANGODB_PORT)${NC}"
            echo -e "${GREEN}   Web UI: http://localhost:$ARANGODB_PORT${NC}"
            return 0
        fi

        # å•Ÿå‹•å®¹å™¨
        echo -e "${GREEN}å•Ÿå‹• ArangoDB å®¹å™¨...${NC}"
        docker start "$container"

        if [ $? -ne 0 ]; then
            echo -e "${RED}âŒ å•Ÿå‹• ArangoDB å®¹å™¨å¤±æ•—${NC}"
            echo -e "${YELLOW}è«‹æª¢æŸ¥æ—¥èªŒ: docker logs $container${NC}"
            return 1
        fi

        sleep 5

        if check_port $ARANGODB_PORT; then
            echo -e "${GREEN}âœ… ArangoDB å·²å•Ÿå‹• (ç«¯å£ $ARANGODB_PORT)${NC}"
            echo -e "${GREEN}   Web UI: http://localhost:$ARANGODB_PORT${NC}"
            return 0
        else
            echo -e "${RED}âŒ ArangoDB å•Ÿå‹•å¤±æ•—ï¼ˆç«¯å£æœªç›£è½ï¼‰${NC}"
            echo -e "${YELLOW}è«‹æª¢æŸ¥æ—¥èªŒ: docker logs $container${NC}"
            return 1
        fi
    else
        echo -e "${YELLOW}æœªæ‰¾åˆ° ArangoDB Docker å®¹å™¨${NC}"
        echo -e "${BLUE}æ­£åœ¨å‰µå»º ArangoDB å®¹å™¨...${NC}"

        # å¾ç’°å¢ƒè®Šæ•¸ç²å–å¯†ç¢¼ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨é»˜èªå€¼
        ARANGO_PASSWORD=${ARANGO_ROOT_PASSWORD:-"changeme"}

        if docker run -d \
            -p $ARANGODB_PORT:8529 \
            -e ARANGO_ROOT_PASSWORD="$ARANGO_PASSWORD" \
            --name arangodb \
            arangodb/arangodb:latest; then
            echo -e "${GREEN}âœ… ArangoDB å®¹å™¨å·²å‰µå»º${NC}"
            echo -e "${YELLOW}   å¯†ç¢¼: $ARANGO_PASSWORD${NC}"
            echo -e "${YELLOW}   æç¤º: å»ºè­°è¨­ç½®ç’°å¢ƒè®Šæ•¸ ARANGO_ROOT_PASSWORD ä¾†ä½¿ç”¨è‡ªå®šç¾©å¯†ç¢¼${NC}"
            sleep 5

            if check_port $ARANGODB_PORT; then
                echo -e "${GREEN}âœ… ArangoDB å·²å•Ÿå‹• (ç«¯å£ $ARANGODB_PORT)${NC}"
                echo -e "${GREEN}   Web UI: http://localhost:$ARANGODB_PORT${NC}"
                return 0
            else
                echo -e "${YELLOW}âš ï¸ å®¹å™¨å·²å‰µå»ºï¼Œä½†ç«¯å£å°šæœªå°±ç·’ï¼Œè«‹ç¨å¾Œæª¢æŸ¥${NC}"
                return 0
            fi
        else
            echo -e "${RED}âŒ å‰µå»º ArangoDB å®¹å™¨å¤±æ•—${NC}"
            return 1
        fi
    fi
}


# å‡½æ•¸ï¼šå•Ÿå‹• ChromaDB
start_chromadb() {
    echo -e "${BLUE}=== å•Ÿå‹• ChromaDB ===${NC}"

    kill_port $CHROMADB_PORT "ChromaDB"

    # æª¢æŸ¥ Docker æ˜¯å¦å®‰è£
    if ! command -v docker &> /dev/null; then
        echo -e "${RED}éŒ¯èª¤: Docker æœªå®‰è£${NC}"
        echo -e "${YELLOW}è«‹å…ˆå®‰è£ Docker Desktop: https://www.docker.com/products/docker-desktop${NC}"
        return 1
    fi

    # æª¢æŸ¥ Docker daemon æ˜¯å¦é‹è¡Œ
    if ! docker ps &> /dev/null 2>&1; then
        echo -e "${RED}éŒ¯èª¤: Docker daemon æœªé‹è¡Œ${NC}"
        echo -e "${YELLOW}è«‹åŸ·è¡Œä»¥ä¸‹æ“ä½œä¹‹ä¸€ï¼š${NC}"
        echo -e "${YELLOW}  1. å•Ÿå‹• Docker Desktop æ‡‰ç”¨ç¨‹å¼${NC}"
        echo -e "${YELLOW}  2. æˆ–é‹è¡Œ: open -a Docker${NC}"
        echo ""

        # å˜—è©¦è‡ªå‹•å•Ÿå‹• Docker Desktop (macOS)
        if [[ "$OSTYPE" == "darwin"* ]]; then
            echo -e "${BLUE}å˜—è©¦è‡ªå‹•å•Ÿå‹• Docker Desktop...${NC}"
            if open -a Docker 2>/dev/null; then
                echo -e "${GREEN}å·²å˜—è©¦å•Ÿå‹• Docker Desktopï¼Œè«‹ç­‰å¾…å…¶å®Œå…¨å•Ÿå‹•å¾Œé‡æ–°é‹è¡Œæ­¤å‘½ä»¤${NC}"
                echo -e "${YELLOW}æç¤º: Docker Desktop é€šå¸¸éœ€è¦ 10-30 ç§’æ‰èƒ½å®Œå…¨å•Ÿå‹•${NC}"
            else
                echo -e "${YELLOW}ç„¡æ³•è‡ªå‹•å•Ÿå‹• Docker Desktopï¼Œè«‹æ‰‹å‹•å•Ÿå‹•${NC}"
            fi
        fi

        return 1
    fi

    # æŸ¥æ‰¾ ChromaDB å®¹å™¨
    local container=$(docker ps -a --format '{{.Names}}' | grep -i chroma | head -1)
    if [ -n "$container" ]; then
        echo -e "${GREEN}ç™¼ç¾ ChromaDB Docker å®¹å™¨: $container${NC}"

        # æª¢æŸ¥å®¹å™¨æ˜¯å¦å·²åœ¨é‹è¡Œ
        if docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
            echo -e "${GREEN}âœ… ChromaDB å·²åœ¨é‹è¡Œ (ç«¯å£ $CHROMADB_PORT)${NC}"
            echo -e "${GREEN}   API: http://localhost:$CHROMADB_PORT${NC}"
            return 0
        fi

        # å•Ÿå‹•å®¹å™¨
        echo -e "${GREEN}å•Ÿå‹• ChromaDB å®¹å™¨...${NC}"
        docker start "$container"

        if [ $? -ne 0 ]; then
            echo -e "${RED}âŒ å•Ÿå‹• ChromaDB å®¹å™¨å¤±æ•—${NC}"
            echo -e "${YELLOW}è«‹æª¢æŸ¥æ—¥èªŒ: docker logs $container${NC}"
            return 1
        fi

        sleep 5

        if check_port $CHROMADB_PORT; then
            echo -e "${GREEN}âœ… ChromaDB å·²å•Ÿå‹• (ç«¯å£ $CHROMADB_PORT)${NC}"
            echo -e "${GREEN}   API: http://localhost:$CHROMADB_PORT${NC}"
            return 0
        else
            echo -e "${RED}âŒ ChromaDB å•Ÿå‹•å¤±æ•—ï¼ˆç«¯å£æœªç›£è½ï¼‰${NC}"
            echo -e "${YELLOW}è«‹æª¢æŸ¥æ—¥èªŒ: docker logs $container${NC}"
            return 1
        fi
    else
        echo -e "${YELLOW}æœªæ‰¾åˆ° ChromaDB Docker å®¹å™¨${NC}"
        echo -e "${BLUE}æ­£åœ¨å‰µå»º ChromaDB å®¹å™¨...${NC}"

        # å¾ç’°å¢ƒè®Šæ•¸ç²å–é…ç½®
        CHROMADB_PERSIST_DIR=${CHROMADB_PERSIST_DIR:-"./chroma_data"}

        # å‰µå»ºæŒä¹…åŒ–ç›®éŒ„ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        mkdir -p "$CHROMADB_PERSIST_DIR"

        if docker run -d \
            -p $CHROMADB_PORT:8000 \
            -v "$(pwd)/$CHROMADB_PERSIST_DIR:/chroma/chroma" \
            --name chromadb \
            chromadb/chroma:latest; then
            echo -e "${GREEN}âœ… ChromaDB å®¹å™¨å·²å‰µå»º${NC}"
            echo -e "${GREEN}   æŒä¹…åŒ–ç›®éŒ„: $CHROMADB_PERSIST_DIR${NC}"
            sleep 5

            if check_port $CHROMADB_PORT; then
                echo -e "${GREEN}âœ… ChromaDB å·²å•Ÿå‹• (ç«¯å£ $CHROMADB_PORT)${NC}"
                echo -e "${GREEN}   API: http://localhost:$CHROMADB_PORT${NC}"
                return 0
            else
                echo -e "${YELLOW}âš ï¸ å®¹å™¨å·²å‰µå»ºï¼Œä½†ç«¯å£å°šæœªå°±ç·’ï¼Œè«‹ç¨å¾Œæª¢æŸ¥${NC}"
                return 0
            fi
        else
            echo -e "${RED}âŒ å‰µå»º ChromaDB å®¹å™¨å¤±æ•—${NC}"
            return 1
        fi
    fi
}



# å‡½æ•¸ï¼šå•Ÿå‹• Redis
start_redis() {
    echo -e "${BLUE}=== å•Ÿå‹• Redis ===${NC}"

    # æª¢æŸ¥ Docker æ˜¯å¦å®‰è£
    if ! command -v docker &> /dev/null; then
        echo -e "${RED}éŒ¯èª¤: Docker æœªå®‰è£${NC}"
        echo -e "${YELLOW}è«‹å…ˆå®‰è£ Docker Desktop: https://www.docker.com/products/docker-desktop${NC}"
        return 1
    fi

    # æª¢æŸ¥ Docker daemon æ˜¯å¦é‹è¡Œ
    if ! docker ps &> /dev/null 2>&1; then
        echo -e "${RED}éŒ¯èª¤: Docker daemon æœªé‹è¡Œ${NC}"
        echo -e "${YELLOW}è«‹åŸ·è¡Œä»¥ä¸‹æ“ä½œä¹‹ä¸€ï¼š${NC}"
        echo -e "${YELLOW}  1. å•Ÿå‹• Docker Desktop æ‡‰ç”¨ç¨‹å¼${NC}"
        echo -e "${YELLOW}  2. æˆ–é‹è¡Œ: open -a Docker${NC}"
        echo ""

        # å˜—è©¦è‡ªå‹•å•Ÿå‹• Docker Desktop (macOS)
        if [[ "$OSTYPE" == "darwin"* ]]; then
            echo -e "${BLUE}å˜—è©¦è‡ªå‹•å•Ÿå‹• Docker Desktop...${NC}"
            if open -a Docker 2>/dev/null; then
                echo -e "${GREEN}å·²å˜—è©¦å•Ÿå‹• Docker Desktopï¼Œè«‹ç­‰å¾…å…¶å®Œå…¨å•Ÿå‹•å¾Œé‡æ–°é‹è¡Œæ­¤å‘½ä»¤${NC}"
                echo -e "${YELLOW}æç¤º: Docker Desktop é€šå¸¸éœ€è¦ 10-30 ç§’æ‰èƒ½å®Œå…¨å•Ÿå‹•${NC}"
            else
                echo -e "${YELLOW}ç„¡æ³•è‡ªå‹•å•Ÿå‹• Docker Desktopï¼Œè«‹æ‰‹å‹•å•Ÿå‹•${NC}"
            fi
        fi

        return 1
    fi

    # æª¢æŸ¥æ˜¯å¦ä½¿ç”¨ docker-compose
    if [ -f "docker-compose.yml" ]; then
        echo -e "${GREEN}ç™¼ç¾ docker-compose.ymlï¼Œä½¿ç”¨ docker-compose ç®¡ç† Redis${NC}"

        # æª¢æŸ¥ Redis å®¹å™¨æ˜¯å¦å·²åœ¨é‹è¡Œ
        if docker-compose ps redis 2>/dev/null | grep -q "Up"; then
            echo -e "${GREEN}âœ… Redis å·²åœ¨é‹è¡Œ (ç«¯å£ $REDIS_PORT)${NC}"
            echo -e "${GREEN}   ä½¿ç”¨ docker-compose ç®¡ç†: docker-compose ps redis${NC}"
            return 0
        fi

        # å•Ÿå‹• Redis å®¹å™¨
        echo -e "${GREEN}å•Ÿå‹• Redis å®¹å™¨...${NC}"
        if docker-compose up -d redis 2>/dev/null; then
            sleep 3

            # æª¢æŸ¥å®¹å™¨ç‹€æ…‹
            if docker-compose ps redis 2>/dev/null | grep -q "Up"; then
                echo -e "${GREEN}âœ… Redis å·²å•Ÿå‹• (ç«¯å£ $REDIS_PORT)${NC}"
                echo -e "${GREEN}   ä½¿ç”¨ docker-compose ç®¡ç†: docker-compose ps redis${NC}"
                return 0
            else
                echo -e "${YELLOW}âš ï¸  Redis å®¹å™¨å·²å•Ÿå‹•ï¼Œä½†ç‹€æ…‹æª¢æŸ¥å¤±æ•—${NC}"
                echo -e "${YELLOW}   è«‹æª¢æŸ¥: docker-compose logs redis${NC}"
                return 0
            fi
        else
            echo -e "${RED}âŒ å•Ÿå‹• Redis å®¹å™¨å¤±æ•—${NC}"
            echo -e "${YELLOW}   è«‹æª¢æŸ¥: docker-compose logs redis${NC}"
            return 1
        fi
    fi

    # æŸ¥æ‰¾ Redis å®¹å™¨ï¼ˆä¸ä½¿ç”¨ docker-composeï¼‰
    local container=$(docker ps -a --format '{{.Names}}' | grep -i redis | head -1)
    if [ -n "$container" ]; then
        echo -e "${GREEN}ç™¼ç¾ Redis Docker å®¹å™¨: $container${NC}"

        # æª¢æŸ¥å®¹å™¨æ˜¯å¦å·²åœ¨é‹è¡Œ
        if docker ps --format '{{.Names}}' | grep -q "^${container}$"; then
            echo -e "${GREEN}âœ… Redis å·²åœ¨é‹è¡Œ (ç«¯å£ $REDIS_PORT)${NC}"
            return 0
        fi

        # å•Ÿå‹•å®¹å™¨
        echo -e "${GREEN}å•Ÿå‹• Redis å®¹å™¨...${NC}"
        docker start "$container"

        if [ $? -ne 0 ]; then
            echo -e "${RED}âŒ å•Ÿå‹• Redis å®¹å™¨å¤±æ•—${NC}"
            echo -e "${YELLOW}è«‹æª¢æŸ¥æ—¥èªŒ: docker logs $container${NC}"
            return 1
        fi

        sleep 3

        if check_port $REDIS_PORT; then
            echo -e "${GREEN}âœ… Redis å·²å•Ÿå‹• (ç«¯å£ $REDIS_PORT)${NC}"
            return 0
        else
            echo -e "${YELLOW}âš ï¸  Redis å®¹å™¨å·²å•Ÿå‹•ï¼Œä½†ç«¯å£å°šæœªå°±ç·’${NC}"
            echo -e "${YELLOW}è«‹æª¢æŸ¥æ—¥èªŒ: docker logs $container${NC}"
            return 0
        fi
    else
        echo -e "${YELLOW}æœªæ‰¾åˆ° Redis Docker å®¹å™¨${NC}"
        echo -e "${BLUE}æ­£åœ¨å‰µå»º Redis å®¹å™¨...${NC}"

        if docker run -d             -p $REDIS_PORT:6379             --name redis             redis:7-alpine; then
            echo -e "${GREEN}âœ… Redis å®¹å™¨å·²å‰µå»º${NC}"
            sleep 3

            if check_port $REDIS_PORT; then
                echo -e "${GREEN}âœ… Redis å·²å•Ÿå‹• (ç«¯å£ $REDIS_PORT)${NC}"
                return 0
            else
                echo -e "${YELLOW}âš ï¸ å®¹å™¨å·²å‰µå»ºï¼Œä½†ç«¯å£å°šæœªå°±ç·’ï¼Œè«‹ç¨å¾Œæª¢æŸ¥${NC}"
                return 0
            fi
        else
            echo -e "${RED}âŒ å‰µå»º Redis å®¹å™¨å¤±æ•—${NC}"
            return 1
        fi
    fi
}

# å‡½æ•¸ï¼šå•Ÿå‹• FastAPI
start_fastapi() {
    echo -e "${BLUE}=== å•Ÿå‹• FastAPI ===${NC}"

    kill_port $FASTAPI_PORT "FastAPI"

    # ç¢ºå®š Python å’Œ uvicorn è·¯å¾‘
    local PYTHON_CMD="python3"
    local UVICORN_CMD="uvicorn"

    # æª¢æŸ¥è™›æ“¬ç’°å¢ƒ
    if [ -d "venv" ]; then
        source venv/bin/activate
        PYTHON_CMD="venv/bin/python"
        UVICORN_CMD="venv/bin/uvicorn"
    elif [ -d ".venv" ]; then
        source .venv/bin/activate
        PYTHON_CMD=".venv/bin/python"
        UVICORN_CMD=".venv/bin/uvicorn"
    fi

    # æª¢æŸ¥ uvicorn æ˜¯å¦å®‰è£
    if ! command -v "$UVICORN_CMD" &> /dev/null && ! "$PYTHON_CMD" -m uvicorn --help &> /dev/null; then
        echo -e "${RED}éŒ¯èª¤: uvicorn æœªå®‰è£${NC}"
        echo -e "${YELLOW}è«‹å®‰è£: pip install uvicorn${NC}"
        return 1
    fi

    # æª¢æŸ¥ä¾è³´æ¨¡çµ„
    # è®¾ç½® PYTHONPATH ä»¥ç¡®ä¿å¯ä»¥å¯¼å…¥æ¨¡å—
    export PYTHONPATH="$PROJECT_ROOT:$PYTHONPATH"
    # æ£€æŸ¥æ¨¡å—æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆä¸å®é™…å¯¼å…¥ï¼Œé¿å…å¾ªç¯å¯¼å…¥é—®é¢˜ï¼‰
    if [ ! -f "$PROJECT_ROOT/api/main.py" ]; then
        echo -e "${RED}éŒ¯èª¤: FastAPI ä¸»æ–‡ä»¶ä¸å­˜åœ¨${NC}"
        echo -e "${YELLOW}è«‹æª¢æŸ¥é …ç›®çµæ§‹æ˜¯å¦å®Œæ•´${NC}"
        return 1
    fi
    # å°è¯•å¯¼å…¥ï¼ˆå…è®¸å¤±è´¥ï¼Œå› ä¸ºå¯èƒ½æ˜¯å¾ªç¯å¯¼å…¥é—®é¢˜ï¼‰
    if ! "$PYTHON_CMD" -c "from api.main import app" 2>/dev/null; then
        echo -e "${YELLOW}è­¦å‘Š: ç„¡æ³•å°å…¥ FastAPI æ‡‰ç”¨ï¼ˆå¯èƒ½æ˜¯å¾ªç’°å°å…¥å•é¡Œï¼‰${NC}"
        echo -e "${YELLOW}å°‡å˜—è©¦ç›´æ¥å•Ÿå‹•æœå‹™...${NC}"
    fi

    echo -e "${GREEN}å•Ÿå‹• FastAPI æœå‹™ (ç«¯å£ $FASTAPI_PORT)...${NC}"
    if command -v "$UVICORN_CMD" &> /dev/null; then
    export PYTHONPATH="$PROJECT_ROOT:$PYTHONPATH"

        nohup "$UVICORN_CMD" api.main:app \
            --host 0.0.0.0 \
            --port $FASTAPI_PORT \
            --reload \
            > "$LOG_DIR/fastapi.log" 2>&1 &
    else
        nohup "$PYTHON_CMD" -m uvicorn api.main:app \
            --host 0.0.0.0 \
            --port $FASTAPI_PORT \
            --reload \
            > "$LOG_DIR/fastapi.log" 2>&1 &
    fi

    # ç­‰å¾…æœå‹™å•Ÿå‹•ï¼Œä¸¦é‡è©¦æª¢æŸ¥
    local max_attempts=10
    local attempt=0
    local started=false

    while [ $attempt -lt $max_attempts ]; do
        sleep 1
        if check_port $FASTAPI_PORT; then
            started=true
            break
        fi
        attempt=$((attempt + 1))
    done

    if [ "$started" = true ]; then
        echo -e "${GREEN}âœ… FastAPI å·²å•Ÿå‹• (ç«¯å£ $FASTAPI_PORT)${NC}"
        echo -e "${GREEN}   æ—¥èªŒæ–‡ä»¶: $LOG_DIR/fastapi.log${NC}"
        echo -e "${GREEN}   API æ–‡æª”: http://localhost:$FASTAPI_PORT/docs${NC}"
        return 0
    else
        echo -e "${RED}âŒ FastAPI å•Ÿå‹•å¤±æ•—${NC}"
        echo -e "${YELLOW}è«‹æª¢æŸ¥æ—¥èªŒ: $LOG_DIR/fastapi.log${NC}"
        echo -e "${YELLOW}æœ€å¾Œ 20 è¡Œæ—¥èªŒ:${NC}"
        tail -20 "$LOG_DIR/fastapi.log" 2>/dev/null || echo "ç„¡æ³•è®€å–æ—¥èªŒæ–‡ä»¶"
        return 1
    fi
}

# å‡½æ•¸ï¼šå•Ÿå‹• MCP Server
start_mcp_server() {
    echo -e "${BLUE}=== å•Ÿå‹• MCP Server ===${NC}"

    kill_port $MCP_SERVER_PORT "MCP Server"

    # ç¢ºå®š Python è·¯å¾‘
    local PYTHON_CMD="python3"

    # æª¢æŸ¥è™›æ“¬ç’°å¢ƒ
    if [ -d "venv" ]; then
        source venv/bin/activate
        PYTHON_CMD="venv/bin/python"
    elif [ -d ".venv" ]; then
        source .venv/bin/activate
        PYTHON_CMD=".venv/bin/python"
    fi

    # æª¢æŸ¥ Python æ¨¡çµ„
    if ! "$PYTHON_CMD" -c "import mcp.server.main" 2>/dev/null; then
        echo -e "${RED}éŒ¯èª¤: MCP Server æ¨¡çµ„æœªæ‰¾åˆ°${NC}"
        return 1
    fi

    echo -e "${GREEN}å•Ÿå‹• MCP Server (ç«¯å£ $MCP_SERVER_PORT)...${NC}"
    nohup "$PYTHON_CMD" -m mcp.server.main \
        --host 0.0.0.0 \
        --port $MCP_SERVER_PORT \
        > "$LOG_DIR/mcp_server.log" 2>&1 &

    sleep 3

    if check_port $MCP_SERVER_PORT; then
        echo -e "${GREEN}âœ… MCP Server å·²å•Ÿå‹• (ç«¯å£ $MCP_SERVER_PORT)${NC}"
        echo -e "${GREEN}   æ—¥èªŒæ–‡ä»¶: $LOG_DIR/mcp_server.log${NC}"
        return 0
    else
        echo -e "${RED}âŒ MCP Server å•Ÿå‹•å¤±æ•—${NC}"
        echo -e "${YELLOW}è«‹æª¢æŸ¥æ—¥èªŒ: $LOG_DIR/mcp_server.log${NC}"
        echo -e "${YELLOW}æœ€å¾Œ 20 è¡Œæ—¥èªŒ:${NC}"
        tail -20 "$LOG_DIR/mcp_server.log" 2>/dev/null || echo "ç„¡æ³•è®€å–æ—¥èªŒæ–‡ä»¶"
        return 1
    fi
}

# å‡½æ•¸ï¼šå•Ÿå‹•å‰ç«¯æœå‹™ (Vite)
start_frontend() {
    echo -e "${BLUE}=== å•Ÿå‹•å‰ç«¯æœå‹™ (Vite) ===${NC}"

    kill_port $FRONTEND_PORT "Frontend"

    # æª¢æŸ¥å‰ç«¯ç›®éŒ„æ˜¯å¦å­˜åœ¨
    if [ ! -d "$PROJECT_ROOT/ai-bot" ]; then
        echo -e "${RED}éŒ¯èª¤: å‰ç«¯ç›®éŒ„ä¸å­˜åœ¨${NC}"
        echo -e "${YELLOW}è«‹æª¢æŸ¥é …ç›®çµæ§‹æ˜¯å¦å®Œæ•´${NC}"
        return 1
    fi

    cd "$PROJECT_ROOT/ai-bot"

    # æª¢æŸ¥ node_modules æ˜¯å¦å­˜åœ¨
    if [ ! -d "node_modules" ]; then
        echo -e "${YELLOW}è­¦å‘Š: node_modules ä¸å­˜åœ¨ï¼Œæ­£åœ¨å®‰è£ä¾è³´...${NC}"
        if command -v pnpm &> /dev/null; then
            pnpm install
        elif command -v npm &> /dev/null; then
            npm install
        else
            echo -e "${RED}éŒ¯èª¤: æœªæ‰¾åˆ° pnpm æˆ– npm${NC}"
            echo -e "${YELLOW}è«‹å®‰è£ Node.js å’ŒåŒ…ç®¡ç†å™¨${NC}"
            return 1
        fi
    fi

    # æª¢æŸ¥ pnpm æˆ– npm
    local PKG_MANAGER="pnpm"
    if ! command -v pnpm &> /dev/null; then
        if command -v npm &> /dev/null; then
            PKG_MANAGER="npm"
        else
            echo -e "${RED}éŒ¯èª¤: æœªæ‰¾åˆ° pnpm æˆ– npm${NC}"
            return 1
        fi
    fi

    echo -e "${GREEN}å•Ÿå‹•å‰ç«¯æœå‹™ (ç«¯å£ $FRONTEND_PORT)...${NC}"
    nohup $PKG_MANAGER dev         > "$LOG_DIR/frontend.log" 2>&1 &

    # ç­‰å¾…æœå‹™å•Ÿå‹•
    local max_attempts=15
    local attempt=0
    local started=false

    while [ $attempt -lt $max_attempts ]; do
        sleep 1
        if check_port $FRONTEND_PORT; then
            started=true
            break
        fi
        attempt=$((attempt + 1))
    done

    if [ "$started" = true ]; then
        echo -e "${GREEN}âœ… å‰ç«¯æœå‹™å·²å•Ÿå‹• (ç«¯å£ $FRONTEND_PORT)${NC}"
        echo -e "${GREEN}   æ—¥èªŒæ–‡ä»¶: $LOG_DIR/frontend.log${NC}"
        echo -e "${GREEN}   æœ¬åœ°è¨ªå•: http://localhost:$FRONTEND_PORT${NC}"
        return 0
    else
        echo -e "${RED}âŒ å‰ç«¯æœå‹™å•Ÿå‹•å¤±æ•—${NC}"
        echo -e "${YELLOW}è«‹æª¢æŸ¥æ—¥èªŒ: $LOG_DIR/frontend.log${NC}"
        echo -e "${YELLOW}æœ€å¾Œ 20 è¡Œæ—¥èªŒ:${NC}"
        tail -20 "$LOG_DIR/frontend.log" 2>/dev/null || echo "ç„¡æ³•è®€å–æ—¥èªŒæ–‡ä»¶"
        return 1
    fi
}

show_usage() {
    echo -e "${BLUE}AI-Box æœå‹™å•Ÿå‹•è…³æœ¬${NC}"
    echo ""
    echo "ç”¨æ³•: $0 [é¸é …]"
    echo ""
    echo "é¸é …:"
    echo "  all        å•Ÿå‹•æ‰€æœ‰æœå‹™ (ArangoDB, ChromaDB, FastAPI)"
    echo "  arangodb   å•Ÿå‹• ArangoDB"
    echo "  chromadb   å•Ÿå‹• ChromaDB"
    echo "  fastapi|api  å•Ÿå‹• FastAPI (API æœå‹™)"
    echo "  mcp        å•Ÿå‹• MCP Server"
    echo "  frontend   å•Ÿå‹•å‰ç«¯æœå‹™ (Vite)"
    echo "  worker     å•Ÿå‹• RQ Worker (å¾Œå°ä»»å‹™è™•ç†)"
    echo "  seaweedfs          å•Ÿå‹• SeaweedFS (AI-Box å’Œ DataLake)
  seaweedfs-ai-box    å•Ÿå‹• AI-Box SeaweedFS
  seaweedfs-datalake  å•Ÿå‹• DataLake SeaweedFS"
    echo "  buckets      å‰µå»º SeaweedFS Buckets"
    echo "  dashboard  å•Ÿå‹• RQ Dashboard (ä»»å‹™ç›£æ§ç•Œé¢)"
    echo "  status     æª¢æŸ¥æœå‹™ç‹€æ…‹"
    echo "  monitor    å¯¦æ™‚ç›£æ§ FastAPI é‹è¡Œç‹€æ…‹"
    echo "  stop       åœæ­¢æ‰€æœ‰æœå‹™"
    echo "  help       é¡¯ç¤ºæ­¤å¹«åŠ©ä¿¡æ¯"
    echo ""
    echo "ç¯„ä¾‹:"
    echo "  $0 all              # å•Ÿå‹•æ‰€æœ‰æœå‹™"
    echo "  $0 fastapi          # åªå•Ÿå‹• FastAPI"
    echo "  $0 arangodb chromadb # å•Ÿå‹• ArangoDB å’Œ ChromaDB"
}

# å‡½æ•¸ï¼šå•Ÿå‹• RQ Worker
start_worker() {
    echo -e "${BLUE}=== å•Ÿå‹• RQ Worker ===${NC}"

    # æª¢æŸ¥ Redis æ˜¯å¦é‹è¡Œ
    if ! check_port $REDIS_PORT; then
        echo -e "${YELLOW}è­¦å‘Š: Redis æœªé‹è¡Œï¼ŒWorker éœ€è¦ Redis æ‰èƒ½é‹è¡Œ${NC}"
        echo -e "${YELLOW}æ­£åœ¨å•Ÿå‹• Redis...${NC}"
        start_redis || {
            echo -e "${RED}âŒ ç„¡æ³•å•Ÿå‹• Redisï¼ŒWorker å•Ÿå‹•å¤±æ•—${NC}"
            return 1
        }
        sleep 2
    fi

    # æª¢æŸ¥ Worker æ˜¯å¦å·²åœ¨é‹è¡Œï¼Œå¦‚æœåœ¨é‹è¡Œå‰‡å…ˆåœæ­¢
    local worker_pids=$(ps aux | grep -E "rq worker|workers.service" | grep -v grep | awk "{print \$2}")
    if [ -n "$worker_pids" ]; then
        echo -e "${YELLOW}âš ï¸  RQ Worker æ­£åœ¨é‹è¡Œ (PID: $worker_pids)ï¼Œå…ˆåœæ­¢...${NC}"
        for pid in $worker_pids; do
            echo -e "${YELLOW}  åœæ­¢ Worker é€²ç¨‹ $pid...${NC}"
            kill -TERM $pid 2>/dev/null || true
        done
        sleep 2
        # å¼·åˆ¶çµ‚æ­¢ä»åœ¨é‹è¡Œçš„ Worker
        local remaining_pids=$(ps aux | grep -E "rq worker|workers.service" | grep -v grep | awk "{print \$2}")
        if [ -n "$remaining_pids" ]; then
            for pid in $remaining_pids; do
                echo -e "${YELLOW}  å¼·åˆ¶çµ‚æ­¢ Worker é€²ç¨‹ $pid...${NC}"
                kill -9 $pid 2>/dev/null || true
            done
        fi
        echo -e "${GREEN}âœ… RQ Worker å·²åœæ­¢${NC}"
        sleep 1
    fi

    # ç¢ºå®š Python è·¯å¾‘
    PYTHON_CMD="python3"
    if [ -d "venv" ]; then
        source venv/bin/activate
        PYTHON_CMD="venv/bin/python"
    elif [ -d ".venv" ]; then
        source .venv/bin/activate
        PYTHON_CMD=".venv/bin/python"
    fi

    # æª¢æŸ¥ RQ æ˜¯å¦å®‰è£
    if ! "$PYTHON_CMD" -c "import rq" 2>/dev/null; then
        echo -e "${RED}éŒ¯èª¤: RQ æœªå®‰è£${NC}"
        echo -e "${YELLOW}è«‹å®‰è£: pip install rq${NC}"
        return 1
    fi

    # è¨­ç½® PYTHONPATH
    export PYTHONPATH="$PROJECT_ROOT:$PYTHONPATH"

    # å•Ÿå‹• Worker Serviceï¼ˆç›£è½æ‰€æœ‰éšŠåˆ—ï¼Œå•Ÿç”¨ç›£æ§ï¼‰
    echo -e "${GREEN}å•Ÿå‹• RQ Worker Service...${NC}"
    echo -e "${GREEN}  ç›£è½éšŠåˆ—: kg_extraction, vectorization, file_processing${NC}"
    echo -e "${GREEN}  ç›£æ§æ¨¡å¼: å•Ÿç”¨${NC}"
    echo -e "${GREEN}  æ—¥èªŒæ–‡ä»¶: $LOG_DIR/worker_service.log${NC}"

    nohup "$PYTHON_CMD" -m workers.service         --queues kg_extraction vectorization file_processing         --monitor         --check-interval 30         --name rq_worker_ai_box         > "$LOG_DIR/worker_service.log" 2>&1 &

    local worker_pid=$!
    sleep 2

    # æª¢æŸ¥ Worker æ˜¯å¦æˆåŠŸå•Ÿå‹•
    if ps -p $worker_pid > /dev/null 2>&1; then
        echo -e "${GREEN}âœ… RQ Worker å·²å•Ÿå‹• (PID: $worker_pid)${NC}"
        echo -e "${GREEN}  æ—¥èªŒ: $LOG_DIR/worker_service.log${NC}"
        echo -e "${YELLOW}  æç¤º: ä½¿ç”¨ 'tail -f $LOG_DIR/worker_service.log' æŸ¥çœ‹æ—¥èªŒ${NC}"
        return 0
    else
        echo -e "${RED}âŒ RQ Worker å•Ÿå‹•å¤±æ•—${NC}"
        echo -e "${YELLOW}è«‹æª¢æŸ¥æ—¥èªŒ: $LOG_DIR/worker_service.log${NC}"
        return 1
    fi
}

# å‡½æ•¸ï¼šå•Ÿå‹• RQ Dashboard
start_rq_dashboard() {
    echo -e "${BLUE}=== å•Ÿå‹• RQ Dashboard ===${NC}"

    # æª¢æŸ¥ Redis æ˜¯å¦é‹è¡Œ
    if ! check_port $REDIS_PORT; then
        echo -e "${YELLOW}è­¦å‘Š: Redis æœªé‹è¡Œï¼ŒDashboard éœ€è¦ Redis æ‰èƒ½é‹è¡Œ${NC}"
        echo -e "${YELLOW}æ­£åœ¨å•Ÿå‹• Redis...${NC}"
        start_redis || {
            echo -e "${RED}âŒ ç„¡æ³•å•Ÿå‹• Redisï¼ŒDashboard å•Ÿå‹•å¤±æ•—${NC}"
            return 1
        }
        sleep 2
    fi

    # Dashboard ç«¯å£ï¼ˆå¯å¾ç’°å¢ƒè®Šæ•¸è®€å–ï¼‰
    DASHBOARD_PORT=${RQ_DASHBOARD_PORT:-9181}

    # æª¢æŸ¥ Dashboard æ˜¯å¦å·²åœ¨é‹è¡Œ
    if check_port $DASHBOARD_PORT; then
        local pid=$(lsof -ti :$DASHBOARD_PORT | head -1)
        echo -e "${GREEN}âœ… RQ Dashboard å·²åœ¨é‹è¡Œ (ç«¯å£ $DASHBOARD_PORT, PID: $pid)${NC}"
        echo -e "${GREEN}  è¨ªå•åœ°å€: http://localhost:$DASHBOARD_PORT${NC}"
        return 0
    fi

    # ç¢ºå®š Python è·¯å¾‘
    PYTHON_CMD="python3"
    if [ -d "venv" ]; then
        source venv/bin/activate
        PYTHON_CMD="venv/bin/python"
    elif [ -d ".venv" ]; then
        source .venv/bin/activate
        PYTHON_CMD=".venv/bin/python"
    fi

    # æª¢æŸ¥ rq-dashboard æ˜¯å¦å®‰è£
    if ! "$PYTHON_CMD" -c "import rq_dashboard" 2>/dev/null; then
        echo -e "${RED}éŒ¯èª¤: rq-dashboard æœªå®‰è£${NC}"
        echo -e "${YELLOW}è«‹å®‰è£: pip install rq-dashboard${NC}"
        return 1
    fi

    # è¨­ç½® PYTHONPATH
    export PYTHONPATH="$PROJECT_ROOT:$PYTHONPATH"

    # å¾ç’°å¢ƒè®Šæ•¸è®€å– Redis URL
    REDIS_URL="${REDIS_URL:-redis://localhost:6379/0}"

    # å•Ÿå‹• RQ Dashboard
    echo -e "${GREEN}å•Ÿå‹• RQ Dashboard...${NC}"
    echo -e "${GREEN}  Redis URL: $REDIS_URL${NC}"
    echo -e "${GREEN}  ç«¯å£: $DASHBOARD_PORT${NC}"
    echo -e "${GREEN}  è¨ªå•åœ°å€: http://localhost:$DASHBOARD_PORT${NC}"

    nohup "$PYTHON_CMD" -m rq_dashboard         --redis-url "$REDIS_URL"         --port "$DASHBOARD_PORT"         > "$LOG_DIR/rq_dashboard.log" 2>&1 &

    local dashboard_pid=$!
    sleep 2

    # æª¢æŸ¥ Dashboard æ˜¯å¦æˆåŠŸå•Ÿå‹•
    if check_port $DASHBOARD_PORT; then
        echo -e "${GREEN}âœ… RQ Dashboard å·²å•Ÿå‹• (ç«¯å£ $DASHBOARD_PORT, PID: $dashboard_pid)${NC}"
        echo -e "${GREEN}  è¨ªå•åœ°å€: http://localhost:$DASHBOARD_PORT${NC}"
        echo -e "${GREEN}  æ—¥èªŒ: $LOG_DIR/rq_dashboard.log${NC}"
        return 0
    else
        echo -e "${RED}âŒ RQ Dashboard å•Ÿå‹•å¤±æ•—${NC}"
        echo -e "${YELLOW}è«‹æª¢æŸ¥æ—¥èªŒ: $LOG_DIR/rq_dashboard.log${NC}"
        return 1
    fi
}

# å‡½æ•¸ï¼šå•Ÿå‹• AI-Box SeaweedFSï¼ˆDocker Composeï¼‰
start_seaweedfs_ai_box() {
    echo -e "${BLUE}=== å•Ÿå‹• AI-Box SeaweedFS (Docker Compose) ===${NC}"

    local compose_file="docker-compose.seaweedfs.yml"

    if [ ! -f "$compose_file" ]; then
        echo -e "${YELLOW}âš ï¸  æœªæ‰¾åˆ° $compose_fileï¼Œè·³é AI-Box SeaweedFS å•Ÿå‹•${NC}"
        return 1
    fi

    echo -e "${BLUE}æª¢æŸ¥ AI-Box SeaweedFS æ˜¯å¦å·²é‹è¡Œ...${NC}"

    if check_port $AI_BOX_SEAWEEDFS_S3_PORT; then
        echo -e "${GREEN}âœ… AI-Box SeaweedFS å·²åœ¨é‹è¡Œï¼ˆç«¯å£ $AI_BOX_SEAWEEDFS_S3_PORTï¼‰${NC}"
        return 0
    fi

    echo -e "${BLUE}å•Ÿå‹• AI-Box SeaweedFSï¼ˆDocker Composeï¼‰...${NC}"

    if command -v docker-compose &> /dev/null; then
        DOCKER_COMPOSE_CMD="docker-compose"
    elif command -v docker &> /dev/null && docker compose version &> /dev/null 2>&1; then
        DOCKER_COMPOSE_CMD="docker compose"
    else
        echo -e "${RED}âŒ éŒ¯èª¤ï¼šæœªæ‰¾åˆ° docker-compose æˆ– docker compose å‘½ä»¤${NC}"
        return 1
    fi

    $DOCKER_COMPOSE_CMD -f "$compose_file" up -d

    if [ $? -ne 0 ]; then
        echo -e "${RED}âŒ AI-Box SeaweedFS å•Ÿå‹•å¤±æ•—${NC}"
        return 1
    fi

    echo -e "${BLUE}ç­‰å¾… AI-Box SeaweedFS å•Ÿå‹•...${NC}"
    local max_attempts=30
    local attempt=0

    while [ $attempt -lt $max_attempts ]; do
        if check_port $AI_BOX_SEAWEEDFS_S3_PORT; then
            echo -e "${GREEN}âœ… AI-Box SeaweedFS å•Ÿå‹•æˆåŠŸï¼ˆç«¯å£ $AI_BOX_SEAWEEDFS_S3_PORTï¼‰${NC}"
            sleep 2
            return 0
        fi
        sleep 1
        attempt=$((attempt + 1))
        echo -e "${YELLOW}  ç­‰å¾…ä¸­... ($attempt/$max_attempts)${NC}"
    done

    echo -e "${RED}âŒ AI-Box SeaweedFS å•Ÿå‹•è¶…æ™‚${NC}"
    return 1
}

# å‡½æ•¸ï¼šå•Ÿå‹• DataLake SeaweedFSï¼ˆDocker Composeï¼‰
start_seaweedfs_datalake() {
    echo -e "${BLUE}=== å•Ÿå‹• DataLake SeaweedFS (Docker Compose) ===${NC}"

    local compose_file="docker-compose.seaweedfs-datalake.yml"

    if [ ! -f "$compose_file" ]; then
        echo -e "${YELLOW}âš ï¸  æœªæ‰¾åˆ° $compose_fileï¼Œè·³é DataLake SeaweedFS å•Ÿå‹•${NC}"
        return 1
    fi

    echo -e "${BLUE}æª¢æŸ¥ DataLake SeaweedFS æ˜¯å¦å·²é‹è¡Œ...${NC}"

    if check_port $DATALAKE_SEAWEEDFS_S3_PORT; then
        echo -e "${GREEN}âœ… DataLake SeaweedFS å·²åœ¨é‹è¡Œï¼ˆç«¯å£ $DATALAKE_SEAWEEDFS_S3_PORTï¼‰${NC}"
        return 0
    fi

    echo -e "${BLUE}å•Ÿå‹• DataLake SeaweedFSï¼ˆDocker Composeï¼‰...${NC}"

    if command -v docker-compose &> /dev/null; then
        DOCKER_COMPOSE_CMD="docker-compose"
    elif command -v docker &> /dev/null && docker compose version &> /dev/null 2>&1; then
        DOCKER_COMPOSE_CMD="docker compose"
    else
        echo -e "${RED}âŒ éŒ¯èª¤ï¼šæœªæ‰¾åˆ° docker-compose æˆ– docker compose å‘½ä»¤${NC}"
        return 1
    fi

    $DOCKER_COMPOSE_CMD -f "$compose_file" up -d

    if [ $? -ne 0 ]; then
        echo -e "${RED}âŒ DataLake SeaweedFS å•Ÿå‹•å¤±æ•—${NC}"
        return 1
    fi

    echo -e "${BLUE}ç­‰å¾… DataLake SeaweedFS å•Ÿå‹•...${NC}"
    local max_attempts=30
    local attempt=0

    while [ $attempt -lt $max_attempts ]; do
        if check_port $DATALAKE_SEAWEEDFS_S3_PORT; then
            echo -e "${GREEN}âœ… DataLake SeaweedFS å•Ÿå‹•æˆåŠŸï¼ˆç«¯å£ $DATALAKE_SEAWEEDFS_S3_PORTï¼‰${NC}"
            sleep 2
            return 0
        fi
        sleep 1
        attempt=$((attempt + 1))
        echo -e "${YELLOW}  ç­‰å¾…ä¸­... ($attempt/$max_attempts)${NC}"
    done

    echo -e "${RED}âŒ DataLake SeaweedFS å•Ÿå‹•è¶…æ™‚${NC}"
    return 1
}

# å‡½æ•¸ï¼šå•Ÿå‹•æ‰€æœ‰ SeaweedFS æœå‹™ï¼ˆå…¼å®¹èˆŠç‰ˆæœ¬ï¼‰
start_seaweedfs_docker() {
    echo -e "${BLUE}=== å•Ÿå‹• SeaweedFS æœå‹™ï¼ˆAI-Box å’Œ DataLakeï¼‰ ===${NC}"
    start_seaweedfs_ai_box || true
    start_seaweedfs_datalake || true
}

# å‡½æ•¸ï¼šå‰µå»º SeaweedFS Buckets
create_seaweedfs_buckets() {
    echo -e "${BLUE}=== å‰µå»º SeaweedFS Buckets ===${NC}"

    local script_path="scripts/migration/create_seaweedfs_buckets.py"

    if [ ! -f "$script_path" ]; then
        echo -e "${YELLOW}âš ï¸  æœªæ‰¾åˆ° $script_pathï¼Œè·³é Buckets å‰µå»º${NC}"
        return 1
    fi

    # æª¢æŸ¥æ˜¯å¦é…ç½®äº† SeaweedFS ç’°å¢ƒè®Šæ•¸
    if [ -z "$AI_BOX_SEAWEEDFS_S3_ENDPOINT" ] && [ -z "$DATALAKE_SEAWEEDFS_S3_ENDPOINT" ]; then
        echo -e "${YELLOW}âš ï¸  æœªé…ç½® SeaweedFS ç’°å¢ƒè®Šæ•¸ï¼Œè·³é Buckets å‰µå»º${NC}"
        echo -e "${YELLOW}æç¤º: å¦‚éœ€ä½¿ç”¨ SeaweedFSï¼Œè«‹åœ¨ .env æ–‡ä»¶ä¸­é…ç½®ç›¸é—œç’°å¢ƒè®Šæ•¸${NC}"
        return 1
    fi

    echo -e "${BLUE}å‰µå»º SeaweedFS Buckets...${NC}"

    # ç¢ºå®š Python è·¯å¾‘
    PYTHON_CMD="python3"
    if [ -d "venv" ]; then
        source venv/bin/activate
        PYTHON_CMD="venv/bin/python"
    elif [ -d ".venv" ]; then
        source .venv/bin/activate
        PYTHON_CMD=".venv/bin/python"
    fi

    # é‹è¡Œ Buckets å‰µå»ºè…³æœ¬
    if "$PYTHON_CMD" "$script_path" --service all; then
        echo -e "${GREEN}âœ… SeaweedFS Buckets å‰µå»ºæˆåŠŸ${NC}"
        return 0
    else
        echo -e "${YELLOW}âš ï¸  SeaweedFS Buckets å‰µå»ºå¤±æ•—æˆ–å·²å­˜åœ¨${NC}"
        return 1
    fi
}
# å‡½æ•¸ï¼šæª¢æŸ¥æœå‹™ç‹€æ…‹
check_status() {
    echo -e "${BLUE}=== æœå‹™ç‹€æ…‹æª¢æŸ¥ ===${NC}"
    echo ""

    services=(
        "ArangoDB:$ARANGODB_PORT"
        "ChromaDB:$CHROMADB_PORT"
        "Redis:$REDIS_PORT"
        "FastAPI:$FASTAPI_PORT"
        "MCP Server:$MCP_SERVER_PORT"
        "Frontend:$FRONTEND_PORT"
    )

    # æª¢æŸ¥ Worker ç‹€æ…‹
    echo -e "${BLUE}Worker ç‹€æ…‹:${NC}"
    local worker_pids=$(ps aux | grep -E "rq worker|workers.service" | grep -v grep | awk "{print \$2}")
    if [ -n "$worker_pids" ]; then
        # å°‡å¤šå€‹ PID ç”¨é€—è™Ÿåˆ†éš”ï¼Œé¿å…æ›è¡Œ
        local formatted_pids=$(echo "$worker_pids" | tr '
' ' ' | sed 's/ $//')
        echo -e "${GREEN}âœ… RQ Worker${NC} - é‹è¡Œä¸­ (PID: $formatted_pids)"
    else
        echo -e "${RED}âŒ RQ Worker${NC} - æœªé‹è¡Œ"
    fi
    # æª¢æŸ¥ Dashboard ç‹€æ…‹
    echo -e "${BLUE}Dashboard ç‹€æ…‹:${NC}"
    local dashboard_port=${RQ_DASHBOARD_PORT:-9181}
    if check_port $dashboard_port; then
        local dashboard_pid=$(lsof -ti :$dashboard_port | head -1)
        echo -e "${GREEN}âœ… RQ Dashboard${NC} - é‹è¡Œä¸­ (ç«¯å£ $dashboard_port, PID: $dashboard_pid)"
        echo -e "${GREEN}  è¨ªå•åœ°å€: http://localhost:$dashboard_port${NC}"
    else
        echo -e "${RED}âŒ RQ Dashboard${NC} - æœªé‹è¡Œ (ç«¯å£ $dashboard_port)"
    fi
    # æª¢æŸ¥ SeaweedFS ç‹€æ…‹
    echo -e "${BLUE}SeaweedFS ç‹€æ…‹:${NC}"
    if check_port $AI_BOX_SEAWEEDFS_S3_PORT; then
        local pid=$(lsof -ti :$AI_BOX_SEAWEEDFS_S3_PORT | head -1)
        echo -e "${GREEN}âœ… AI-Box SeaweedFS${NC} - é‹è¡Œä¸­ (S3 API: $AI_BOX_SEAWEEDFS_S3_PORT, Filer: $AI_BOX_SEAWEEDFS_FILER_PORT)"
    else
        echo -e "${RED}âŒ AI-Box SeaweedFS${NC} - æœªé‹è¡Œ (S3 API: $AI_BOX_SEAWEEDFS_S3_PORT)"
    fi
    if check_port $DATALAKE_SEAWEEDFS_S3_PORT; then
        local pid=$(lsof -ti :$DATALAKE_SEAWEEDFS_S3_PORT | head -1)
        echo -e "${GREEN}âœ… DataLake SeaweedFS${NC} - é‹è¡Œä¸­ (S3 API: $DATALAKE_SEAWEEDFS_S3_PORT, Filer: $DATALAKE_SEAWEEDFS_FILER_PORT)"
    else
        echo -e "${RED}âŒ DataLake SeaweedFS${NC} - æœªé‹è¡Œ (S3 API: $DATALAKE_SEAWEEDFS_S3_PORT)"
    fi

    for service_info in "${services[@]}"; do
        IFS=':' read -r name port <<< "$service_info"
        if check_port $port; then
            local pid=$(lsof -ti :$port | head -1)
            echo -e "${GREEN}âœ… $name${NC} - é‹è¡Œä¸­ (ç«¯å£ $port, PID: $pid)"
        else
            echo -e "${RED}âŒ $name${NC} - æœªé‹è¡Œ (ç«¯å£ $port)"
        fi
    done
}

# å‡½æ•¸ï¼šå¯¦æ™‚ç›£æ§ FastAPI é‹è¡Œç‹€æ…‹
monitor_fastapi() {
    echo -e "${BLUE}=== FastAPI å¯¦æ™‚ç›£æ§ ===${NC}"
    echo -e "${YELLOW}æŒ‰ Ctrl+C é€€å‡ºç›£æ§${NC}"
    echo ""

    local FASTAPI_URL="http://localhost:$FASTAPI_PORT"
    local LOG_FILE="$LOG_DIR/fastapi.log"
    local UPDATE_INTERVAL=2  # æ›´æ–°é–“éš”ï¼ˆç§’ï¼‰

    # æª¢æŸ¥ FastAPI æ˜¯å¦é‹è¡Œ
    if ! check_port $FASTAPI_PORT; then
        echo -e "${RED}âŒ FastAPI æœªé‹è¡Œ (ç«¯å£ $FASTAPI_PORT)${NC}"
        echo -e "${YELLOW}è«‹å…ˆå•Ÿå‹• FastAPI: $0 fastapi${NC}"
        return 1
    fi

    # ç²å–é€²ç¨‹ PID
    local pid=$(lsof -ti :$FASTAPI_PORT | head -1)
    if [ -z "$pid" ]; then
        echo -e "${RED}âŒ ç„¡æ³•ç²å– FastAPI é€²ç¨‹ ID${NC}"
        return 1
    fi

    echo -e "${GREEN}âœ… FastAPI é‹è¡Œä¸­ (PID: $pid, ç«¯å£: $FASTAPI_PORT)${NC}"
    echo ""

    # ç›£æ§å¾ªç’°
    while true; do
        clear
        echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${BLUE}â•‘          FastAPI å¯¦æ™‚ç›£æ§ - $(date '+%Y-%m-%d %H:%M:%S')          â•‘${NC}"
        echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""

        # 1. é€²ç¨‹ç‹€æ…‹
        echo -e "${YELLOW}ğŸ“Š é€²ç¨‹ç‹€æ…‹:${NC}"
        if ps -p $pid > /dev/null 2>&1; then
            local cpu=$(ps -p $pid -o %cpu= | tr -d ' ')
            local mem=$(ps -p $pid -o %mem= | tr -d ' ')
            local vsz=$(ps -p $pid -o vsz= | tr -d ' ')
            local rss=$(ps -p $pid -o rss= | tr -d ' ')
            local mem_mb=$((rss / 1024))
            local vsz_mb=$((vsz / 1024))

            echo -e "  PID: ${GREEN}$pid${NC}"
            echo -e "  CPU ä½¿ç”¨ç‡: ${GREEN}${cpu}%${NC}"
            echo -e "  å…§å­˜ä½¿ç”¨ç‡: ${GREEN}${mem}%${NC}"
            echo -e "  è™›æ“¬å…§å­˜: ${GREEN}${vsz_mb} MB${NC}"
            echo -e "  å¯¦éš›å…§å­˜: ${GREEN}${mem_mb} MB${NC}"
        else
            echo -e "  ${RED}âŒ é€²ç¨‹ä¸å­˜åœ¨${NC}"
            break
        fi
        echo ""

        # 2. ç«¯å£ç‹€æ…‹
        echo -e "${YELLOW}ğŸ”Œ ç«¯å£ç‹€æ…‹:${NC}"
        if check_port $FASTAPI_PORT; then
            echo -e "  ç«¯å£ $FASTAPI_PORT: ${GREEN}âœ… ç›£è½ä¸­${NC}"
        else
            echo -e "  ç«¯å£ $FASTAPI_PORT: ${RED}âŒ æœªç›£è½${NC}"
        fi
        echo ""

        # 3. å¥åº·æª¢æŸ¥
        echo -e "${YELLOW}ğŸ¥ å¥åº·æª¢æŸ¥:${NC}"
        local health_response=$(curl -s -w "
%{http_code}" --max-time 2 "$FASTAPI_URL/api/v1/health" 2>/dev/null || echo -e "
000")
        local health_code=$(echo "$health_response" | tail -1)
        if [ "$health_code" = "200" ]; then
            echo -e "  API ç«¯é»: ${GREEN}âœ… æ­£å¸¸ (HTTP $health_code)${NC}"
        elif [ "$health_code" = "404" ]; then
            echo -e "  API ç«¯é»: ${YELLOW}âš ï¸  ç«¯é»ä¸å­˜åœ¨ (HTTP $health_code)${NC}"
        elif [ "$health_code" = "000" ]; then
            echo -e "  API ç«¯é»: ${RED}âŒ ç„¡æ³•é€£æ¥${NC}"
        else
            echo -e "  API ç«¯é»: ${YELLOW}âš ï¸  HTTP $health_code${NC}"
        fi

        # æ¸¬è©¦ç™»éŒ„ç«¯é»
        local login_response=$(curl -s -w "
%{http_code}" --max-time 2 -X POST "$FASTAPI_URL/api/v1/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"username":"test","password":"test"}' 2>/dev/null || echo -e "
000")
        local login_code=$(echo "$login_response" | tail -1)
        if [ "$login_code" = "200" ] || [ "$login_code" = "401" ]; then
            echo -e "  ç™»éŒ„ç«¯é»: ${GREEN}âœ… éŸ¿æ‡‰æ­£å¸¸ (HTTP $login_code)${NC}"
        elif [ "$login_code" = "000" ]; then
            echo -e "  ç™»éŒ„ç«¯é»: ${RED}âŒ ç„¡æ³•é€£æ¥${NC}"
        else
            echo -e "  ç™»éŒ„ç«¯é»: ${YELLOW}âš ï¸  HTTP $login_code${NC}"
        fi
        echo ""

        # 4. æ—¥èªŒçµ±è¨ˆ
        echo -e "${YELLOW}ğŸ“ æ—¥èªŒçµ±è¨ˆ (æœ€è¿‘ 100 è¡Œ):${NC}"
        if [ -f "$LOG_FILE" ]; then
            local total_lines=$(wc -l < "$LOG_FILE" 2>/dev/null || echo "0")
            local error_count=$(tail -100 "$LOG_FILE" 2>/dev/null | grep -i "ERROR\|Exception\|Traceback" | wc -l | tr -d ' ')
            local warn_count=$(tail -100 "$LOG_FILE" 2>/dev/null | grep -i "WARNING\|WARN" | wc -l | tr -d ' ')
            local info_count=$(tail -100 "$LOG_FILE" 2>/dev/null | grep -i "INFO" | wc -l | tr -d ' ')

            echo -e "  ç¸½æ—¥èªŒè¡Œæ•¸: ${GREEN}$total_lines${NC}"
            echo -e "  éŒ¯èª¤æ•¸é‡: ${RED}$error_count${NC}"
            echo -e "  è­¦å‘Šæ•¸é‡: ${YELLOW}$warn_count${NC}"
            echo -e "  ä¿¡æ¯æ•¸é‡: ${GREEN}$info_count${NC}"
        else
            echo -e "  ${RED}âŒ æ—¥èªŒæ–‡ä»¶ä¸å­˜åœ¨: $LOG_FILE${NC}"
        fi
        echo ""

        # 5. æœ€è¿‘çš„éŒ¯èª¤ï¼ˆå¦‚æœæœ‰ï¼‰
        if [ -f "$LOG_FILE" ] && [ "$error_count" -gt 0 ]; then
            echo -e "${YELLOW}âš ï¸  æœ€è¿‘çš„éŒ¯èª¤ (æœ€å¾Œ 3 æ¢):${NC}"
            tail -100 "$LOG_FILE" 2>/dev/null | grep -i "ERROR\|Exception\|Traceback" | tail -3 | while IFS= read -r line; do
                echo -e "  ${RED}$line${NC}" | cut -c1-80
            done
            echo ""
        fi

        # 6. æœ€è¿‘çš„æ—¥èªŒï¼ˆæœ€å¾Œ 5 è¡Œï¼‰
        echo -e "${YELLOW}ğŸ“‹ æœ€è¿‘çš„æ—¥èªŒ (æœ€å¾Œ 5 è¡Œ):${NC}"
        if [ -f "$LOG_FILE" ]; then
            tail -5 "$LOG_FILE" 2>/dev/null | while IFS= read -r line; do
                if echo "$line" | grep -qi "ERROR\|Exception"; then
                    echo -e "  ${RED}$line${NC}" | cut -c1-80
                elif echo "$line" | grep -qi "WARNING\|WARN"; then
                    echo -e "  ${YELLOW}$line${NC}" | cut -c1-80
                else
                    echo -e "  ${GREEN}$line${NC}" | cut -c1-80
                fi
            done
        fi
        echo ""

        # 7. ç³»çµ±è³‡æº
        echo -e "${YELLOW}ğŸ’» ç³»çµ±è³‡æº:${NC}"
        local load_avg=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | tr -d ',')
        echo -e "  ç³»çµ±è² è¼‰: ${GREEN}$load_avg${NC}"
        echo ""

        echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo -e "${YELLOW}æ›´æ–°é–“éš”: ${UPDATE_INTERVAL} ç§’ | æŒ‰ Ctrl+C é€€å‡º${NC}"

        sleep $UPDATE_INTERVAL
    done
}

# å‡½æ•¸ï¼šåœæ­¢æ‰€æœ‰æœå‹™
stop_all() {
    echo -e "${BLUE}=== åœæ­¢æ‰€æœ‰æœå‹™ ===${NC}"

    ports=($ARANGODB_PORT $CHROMADB_PORT $REDIS_PORT $FASTAPI_PORT $MCP_SERVER_PORT $FRONTEND_PORT)
    service_names=("ArangoDB" "ChromaDB" "Redis" "FastAPI" "MCP Server" "Frontend")

    for i in "${!ports[@]}"; do
        port=${ports[$i]}
        name=${service_names[$i]}
        if check_port $port; then
            echo -e "${YELLOW}åœæ­¢ $name (ç«¯å£ $port)...${NC}"
            kill_port $port "$name"
        fi
    done

    # åœæ­¢ Worker
    echo -e "${YELLOW}åœæ­¢ RQ Worker...${NC}"
    local worker_pids=$(ps aux | grep -E "rq worker|workers.service" | grep -v grep | awk "{print \$2}")
    if [ -n "$worker_pids" ]; then
        for pid in $worker_pids; do
            echo -e "${YELLOW}  åœæ­¢ Worker é€²ç¨‹ $pid...${NC}"
            kill -TERM $pid 2>/dev/null || true
        done
        sleep 2
        # å¼·åˆ¶çµ‚æ­¢ä»åœ¨é‹è¡Œçš„ Worker
        local remaining_pids=$(ps aux | grep -E "rq worker|workers.service" | grep -v grep | awk "{print \$2}")
        if [ -n "$remaining_pids" ]; then
            for pid in $remaining_pids; do
                kill -9 $pid 2>/dev/null || true
            done
        fi
    fi
    # åœæ­¢ Dashboard
    echo -e "${YELLOW}åœæ­¢ RQ Dashboard...${NC}"
    local dashboard_port=${RQ_DASHBOARD_PORT:-9181}
    if check_port $dashboard_port; then
        local dashboard_pids=$(lsof -ti :$dashboard_port)
        if [ -n "$dashboard_pids" ]; then
            for pid in $dashboard_pids; do
                echo -e "${YELLOW}  åœæ­¢ Dashboard é€²ç¨‹ $pid...${NC}"
                kill -TERM $pid 2>/dev/null || true
            done
            sleep 1
            # å¼·åˆ¶çµ‚æ­¢ä»åœ¨é‹è¡Œçš„ Dashboard
            local remaining_pids=$(lsof -ti :$dashboard_port 2>/dev/null)
            if [ -n "$remaining_pids" ]; then
                for pid in $remaining_pids; do
                    kill -9 $pid 2>/dev/null || true
                done
            fi
        fi
    fi
    echo -e "${GREEN}âœ… æ‰€æœ‰æœå‹™å·²åœæ­¢${NC}"
}

# ä¸»é‚è¼¯
main() {
    if [ $# -eq 0 ]; then
        show_usage
        exit 0
    fi

    # è™•ç†å¤šå€‹åƒæ•¸
    for arg in "$@"; do
        case "$arg" in
            all)
                echo -e "${BLUE}å•Ÿå‹•æ‰€æœ‰æœå‹™...${NC}"
                start_seaweedfs_docker || true
                create_seaweedfs_buckets || true
                start_arangodb || true
                start_chromadb || true
                start_redis || true
                start_fastapi || true
                start_mcp || true
                start_frontend || true
                start_worker || true
                start_rq_dashboard || true
                echo -e "${GREEN}=== å•Ÿå‹•å®Œæˆ ===${NC}"
                check_status
                ;;
            arangodb)
                start_arangodb
                ;;
            chromadb)
                start_chromadb
                ;;
            redis)
                start_redis
                ;;
            fastapi|api)
                start_fastapi
                ;;
            mcp)
                start_mcp_server
                ;;
            frontend)
                start_frontend
                ;;
            worker)
                start_worker
                ;;
            dashboard)
                start_rq_dashboard
                ;;
            seaweedfs)
                start_seaweedfs_docker
                ;;
            seaweedfs-ai-box)
                start_seaweedfs_ai_box
                ;;
            seaweedfs-datalake)
                start_seaweedfs_datalake
                ;;
            buckets)
                create_seaweedfs_buckets
                ;;
            status)
                check_status
                ;;
            monitor)
                monitor_fastapi
                ;;
            stop)
                stop_all
                ;;
            help|--help|-h)
                show_usage
                ;;
            *)
                echo -e "${RED}éŒ¯èª¤: æœªçŸ¥é¸é … '$arg'${NC}"
                show_usage
                exit 1
                ;;
        esac
    done
}

# åŸ·è¡Œä¸»å‡½æ•¸
main "$@"
