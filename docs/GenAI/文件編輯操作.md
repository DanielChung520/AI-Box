---
文件名稱: 文件編輯操作.md
用途: GenAI 文件編輯/新增（Cursor-like）功能的操作手冊與系統設計基準（供後續迭代）
創建日期: 2025-12-14 11:12:09 (UTC+8)
創建人: Daniel Chung
最後修改日期: 2025-12-14 11:12:09 (UTC+8)
---

## 1. 範圍與限制（MVP）

- **支援格式**：`md` / `txt` / `json`
- **一次只處理 1 個檔案**（Edit 或 Generate 皆同）
- **Preview-first**：
  - 系統先產生 **diff/patch 預覽**（或 JSON Patch / 新檔內容）
  - 使用者按下 **Apply** 後才真正寫入
- **可取消（Abort）**：若 preview/generation 尚在背景執行，可呼叫 abort

> 註：本文件同時涵蓋「聊天輸入框意圖 → 自動新增檔案」的行為規則：
> - 若使用者訊息有新增檔案意圖（例如："幫我整理以上對話"），預設在 **任務工作區根目錄** 建檔
> - 若使用者訊息指定目錄（例如：`docs/meeting.md`），則在指定目錄建檔（邏輯資料夾）

---

## 2. 前端操作（使用者流程）

### 2.1 文件助手（Document Assistant）

入口：`FileManagement` 頁面 → 點擊「**文件助手**」→ 進入 `/docs`

#### A) Edit（編輯既有檔案）

1. **選擇檔案**：左側 FileTree 選取目標檔案（僅建議 `md/txt/json`）
2. **輸入指令**：在指令輸入框描述要修改的內容（例如："把第二段改成條列"、"新增一段 FAQ"）
3. **Generate Preview**：送出後端建立 preview request
4. **等待預覽**：前端輪詢 request state（queued/running/succeeded/failed/aborted）
5. **檢視預覽**：
   - `md/txt`：以 unified diff 方式呈現
   - `json`：以 JSON Patch（RFC 6902）呈現
6. **Apply**：使用者確認後按 Apply，才會真正寫入檔案並更新版本
7. （可選）**Rollback**：若要回復舊版本，從 Versions 選擇版本並 rollback

#### B) Generate（新增檔案）

1. **設定檔名/格式**（或由 UI 預設，如 `ai-output.md`）
2. **輸入生成指令**（例如："生成會議記錄模板"、"產出 SOP"）
3. **Generate Preview**：後端產生「新檔內容預覽」
4. **Apply**：確認後寫入新檔，並回傳 `file_id`

### 2.2 聊天輸入框（Chat）觸發新增檔案

當使用者在 Chat 輸入：
- **明確建檔指令**：例如「新增檔案」、「建立檔案」、「輸出成檔案」
- **隱含意圖**：例如「幫我整理以上對話」
- **直接含檔案路徑**：例如 `docs/meeting.md`

系統行為：
- 預設在 **任務工作區根目錄** 建立檔案（若有 `task_id`）
- 若指定目錄（`docs/xxx.md`），則在該目錄（邏輯資料夾）建立
- `/api/v1/chat` 回傳 `actions=[{type:"file_created", ...}]`
- 前端會顯示「已建立檔案」的訊息，並觸發 FileTree refresh

---

## 3. 系統架構（後端流程與資料結構）

### 3.1 Preview-first 工作流（Edit）

```text
Frontend
  └─ POST /api/v1/docs/edits  (create request)
      └─ background task 產生 patch preview
  └─ GET  /api/v1/docs/edits/{request_id} (poll state)
  └─ POST /api/v1/docs/edits/{request_id}/apply (apply patch)
      └─ 寫入檔案 + 更新 file_metadata 版本

Abort:
  └─ POST /api/v1/docs/edits/{request_id}/abort
```

- **非同步背景執行**：使用 `asyncio.create_task`（若 event loop 已在跑）
  - 若無法 create_task，fallback 到 FastAPI `BackgroundTasks`
- **狀態儲存**：`DocEditRequestStoreService`（Redis-first，fallback memory）
- **Patch 引擎**：
  - `md/txt`：unified diff（自實作解析與套用）
  - `json`：`jsonpatch` 套用 RFC 6902
- **Apply 安全性**：
  - 比對 `base_version`（避免預覽基礎版本與現況不一致）
  - 權限檢查：必須具備對檔案/任務的存取權
- **版本管理**：每次 Apply 會 bump `doc_version` 並 append `doc_versions`

### 3.2 Preview-first 工作流（Generate）

```text
Frontend
  └─ POST /api/v1/docs/generations  (create request)
      └─ background task 產生 new file preview
  └─ GET  /api/v1/docs/generations/{request_id} (poll state)
  └─ POST /api/v1/docs/generations/{request_id}/apply (create file)
  └─ POST /api/v1/docs/generations/{request_id}/abort
```

- Apply 時才真正呼叫 storage 寫入，並建立 `file_metadata`

### 3.3 邏輯資料夾（folder_metadata）與「指定目錄建檔」

- FileTree 的「目錄」是 **邏輯層**（ArangoDB `folder_metadata`）
- 實體檔案路徑仍依 task workspace 管理
- Chat 建檔規則：
  - 若使用者訊息包含 `dir/file.ext`（只允許 `md/txt/json`）
  - 系統會確保 `dir` 對應的 folder chain 存在，並把 `file_metadata.folder_id` 指向最深層 folder

---

## 4. API（端點一覽）

### 4.1 Docs Editing

- **建立編輯預覽**：`POST /api/v1/docs/edits`
- **查詢編輯狀態**：`GET /api/v1/docs/edits/{request_id}`
- **取消編輯**：`POST /api/v1/docs/edits/{request_id}/abort`
- **套用編輯**：`POST /api/v1/docs/edits/{request_id}/apply`
- **列出版本**：`GET /api/v1/docs/files/{file_id}/versions`
- **回滾版本**：`POST /api/v1/docs/files/{file_id}/rollback`

### 4.2 Docs Generation

- **建立生成預覽**：`POST /api/v1/docs/generations`
- **查詢生成狀態**：`GET /api/v1/docs/generations/{request_id}`
- **取消生成**：`POST /api/v1/docs/generations/{request_id}/abort`
- **套用生成（建立檔案）**：`POST /api/v1/docs/generations/{request_id}/apply`

### 4.3 Chat → 建檔 actions

- `POST /api/v1/chat`
  - 回傳 `actions`，若觸發建檔：

```json
{
  "type": "file_created",
  "file_id": "...",
  "filename": "conversation-summary.md",
  "task_id": "...",
  "folder_id": null,
  "folder_path": null
}
```

---

## 5. 代碼說明（核心檔案與責任）

### 5.1 Backend

- `api/routers/docs_editing.py`
  - Docs Editing / Generation 的主要路由
  - Preview request 建立、輪詢、Abort、Apply、Versions、Rollback
  - 背景任務啟動（`asyncio.create_task` / `BackgroundTasks`）
  - 權限檢查 + audit log（套用/回滾/新建）

- `services/api/models/doc_edit_request.py`
  - `DocEditStatus/DocFormat/PatchKind` 等 model
  - `DocEditCreateRequest / DocEditPreview / DocEditRequestRecord` 等資料結構

- `services/api/services/doc_edit_request_store_service.py`
  - `DocEditRequestStoreService`：Redis-first、fallback memory

- `services/api/models/doc_generation_request.py`
  - Generation request 的 model / state / preview

- `services/api/services/doc_generation_request_store_service.py`
  - `DocGenRequestStoreService`：Redis-first、fallback memory

- `services/api/services/doc_patch_service.py`
  - Patch 套用引擎：
    - `apply_unified_diff()`：md/txt
    - `apply_json_patch()`：json（jsonpatch）
  - 版本 bump helper：`bump_version_meta()`

- `storage/file_storage.py`
  - 實體檔案儲存（task workspace 路徑）

- `services/api/services/file_metadata_service.py`
  - `file_metadata` 的 CRUD（Apply/Generate 後會更新/建立 metadata）

### 5.2 Chat：輸入意圖 → 新增檔案

- `api/routers/chat.py`
  - `_looks_like_create_file_intent()`：heuristic 意圖判斷（含「幫我整理以上對話」）
  - `_parse_target_path()`：解析 `docs/meeting.md` 等路徑
  - `_ensure_folder_path()`：確保 `folder_metadata` 的路徑節點存在
  - `_try_create_file_from_chat_output()`：把 assistant content 寫入新檔
  - `ChatResponse.actions`：回傳 `file_created` action

- `services/api/models/chat.py`
  - `ChatResponse` 新增 `actions` 欄位

### 5.3 Frontend

- `ai-bot/src/pages/DocumentAssistant.tsx`
  - 文件助手 UI（Edit/Generate tab）
  - 輪詢 request state、展示 preview、觸發 Apply/Rollback

- `ai-bot/src/lib/api.ts`
  - docs editing/generation 的 API client
  - chat 回傳 `actions` 的型別（`ChatAction`）

- `ai-bot/src/pages/FileManagement.tsx`
  - 提供入口按鈕導向 `/docs`

- `ai-bot/src/pages/Home.tsx`
  - 接收 `/api/v1/chat` 回傳 `actions`
  - 顯示「已建立檔案」訊息並派發 `fileUploaded` 事件刷新 FileTree

---

## 6. 迭代建議（下一步）

- **更嚴格的 Patch Prompt / 自動補 context**：降低無法套用 patch 的機率
- **更漂亮的 diff viewer（前端）**：包含行內高亮、分割視圖、衝突提示
- **編輯衝突處理**：base_version mismatch 時提供 rebase（重新產生 patch）
- **多檔案工作流**：目前限制一次 1 檔，後續可升級成「多檔案變更集合」
- **審批與審計**：Apply 需二次確認（或管理者審批），並強化 audit detail
- **與 Agent 長任務整合**：文件生成/編輯可交給 agent flow（RQ/async request lifecycle）
