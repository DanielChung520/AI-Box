# 文件上傳 504 Gateway Timeout 設定指南

**代碼功能說明**: 解決 iee.sunlyc.com 等生產環境文件上傳與 Ontology 匯入 504 超時問題
**創建日期**: 2026-01-31 17:30 UTC+8
**創建人**: Daniel Chung
**最後修改日期**: 2026-01-31 17:30 UTC+8

---

## 1. 問題描述

### 1.1 症狀

- `POST /api/v1/files/v2/upload` 返回 **504 Gateway Timeout**
- `POST /api/v1/ontologies/import` 返回 **504 Gateway Timeout**
- 前端顯示：「上傳超時 (504)：檔案較大或伺服器繁忙...」

### 1.2 根因

504 表示**反向代理**在等待後端（FastAPI）回應時超時，而非 FastAPI 本身錯誤。常見原因：

| 層級 | 預設超時 | 說明 |
|------|----------|------|
| Nginx | 60s（常見） | `proxy_read_timeout` 過短 |
| Cloudflare | 100–120s | 免費方案不可調，Enterprise 可申請延長 |
| FastAPI | 依應用 | 通常足夠，非瓶頸 |

大檔上傳、知識庫上架（含向量化）可能超過 60–120 秒，導致 504。

---

## 2. 解決方案

### 2.1 Nginx 反向代理（優先調整）

若 iee.sunlyc.com 前有 Nginx，需提高上傳相關路徑的超時：

```nginx
# 針對 API 上傳路徑單獨設定
location /api/v1/files/v2/upload {
    proxy_pass http://127.0.0.1:8000;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 600s;   # 10 分鐘
    proxy_send_timeout 600s;
    client_max_body_size 500M;
}

location /api/v1/ontologies/import {
    proxy_pass http://127.0.0.1:8000;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 600s;   # 10 分鐘
    proxy_send_timeout 600s;
    client_max_body_size 500M;
}

# 或對整個 /api 路徑統一設定
location /api/ {
    proxy_pass http://127.0.0.1:8000;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 600s;   # 10 分鐘
    proxy_send_timeout 600s;
    client_max_body_size 500M;
}
```

**修改後重載 Nginx**：

```bash
sudo nginx -t && sudo systemctl reload nginx
```

### 2.2 Cloudflare Tunnel / Cloudflare Proxy

若流量經由 **Cloudflare**（含 Tunnel）：

- **免費方案**：Proxy Read Timeout 約 100–120 秒，**無法調整**
- **Enterprise**：可透過 API 或客服申請延長

**可行做法**：

1. **縮短處理時間**：減少單次上傳檔案大小、數量
2. **分階段上傳**：大檔拆成多個小檔分批上傳
3. **直連後端**：在內網或 VPN 環境直接訪問後端，繞過 Cloudflare
4. **升級方案**：若需長時間上傳，考慮 Enterprise 或自建反向代理

### 2.3 檢查專案內 Nginx 設定

專案內若有 `config/nginx.conf`，可參考上述範例調整，並確保部署時覆蓋到實際使用的 Nginx 配置。

---

## 3. 驗證步驟

1. 修改 Nginx 後重載服務
2. 使用較小檔案（< 5MB）測試上傳
3. 若小檔成功，再逐步測試較大檔案
4. 若仍 504，檢查是否經過 Cloudflare，並確認其 timeout 限制

---

## 4. 相關端點

| 端點 | 用途 | 建議超時 |
|------|------|----------|
| `POST /api/v1/files/v2/upload` | 文件上傳 | 300–600s |
| `POST /api/v1/ontologies/import` | 知識庫 Ontology 匯入 | 300–600s |

---

## 5. 參考

- [AI-Box-v2-部署指南](./AI-Box-v2-部署指南.md)
- [Cloudflare Proxy Read Timeout](https://developers.cloudflare.com/api/resources/zones/subresources/settings/models/proxy_read_timeout/)
