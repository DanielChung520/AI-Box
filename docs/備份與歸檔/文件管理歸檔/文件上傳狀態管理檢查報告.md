# æ–‡ä»¶ä¸Šå‚³ç‹€æ…‹ç®¡ç†æª¢æŸ¥å ±å‘Š

**å‰µå»ºæ—¥æœŸ**: 2026-01-02
**å‰µå»ºäºº**: Daniel Chung
**æœ€å¾Œä¿®æ”¹æ—¥æœŸ**: 2026-01-02

---

## ğŸ“‹ æ¦‚è¿°

æœ¬å ±å‘Šæª¢æŸ¥ AI-Box ç³»çµ±ä¸­æ–‡ä»¶ä¸Šå‚³ã€å‘é‡åŒ–å’ŒçŸ¥è­˜åœ–è­œæå–çš„ç‹€æ…‹ç®¡ç†æ©Ÿåˆ¶ï¼ŒåŒ…æ‹¬ç‹€æ…‹è¨˜éŒ„ã€æ–‡ä»¶å‚™ä»½ä½ç½®å’Œç‹€æ…‹è½‰æ›å‡½æ•¸ã€‚

---

## 1. ç‹€æ…‹è¨˜éŒ„æª¢æŸ¥

### âœ… 1.1 ä¸Šå‚³ç‹€æ…‹è¨˜éŒ„

**å­˜å„²ä½ç½®**ï¼š
- **Redis**: `upload:progress:{file_id}` (TTL: 1å°æ™‚)
- **ArangoDB**: `upload_progress` collection (TTLç´¢å¼•: 1å°æ™‚)

**è¨˜éŒ„å­—æ®µ**ï¼š
```python
{
    "file_id": str,
    "status": str,              # "uploading", "completed", "failed"
    "progress": int,            # 0-100
    "file_size": int,           # æ–‡ä»¶å¤§å°ï¼ˆå­—ç¯€ï¼‰
    "uploaded_bytes": int,      # å·²ä¸Šå‚³å­—ç¯€æ•¸
    "updated_at": datetime      # æ›´æ–°æ™‚é–“
}
```

**æ›´æ–°å‡½æ•¸**ï¼š
- `_update_upload_progress()` - `api/routers/file_upload.py:299`

---

### âœ… 1.2 è™•ç†ç‹€æ…‹è¨˜éŒ„

**å­˜å„²ä½ç½®**ï¼š
- **Redis**: `processing:status:{file_id}` (TTL: 2å°æ™‚ï¼Œç”¨æ–¼å¯¦æ™‚æŸ¥è©¢)
- **ArangoDB**: `processing_status` collection (æŒä¹…åŒ–å­˜å„²ï¼ŒTTLç´¢å¼•: 24å°æ™‚)

**è¨˜éŒ„å­—æ®µ**ï¼š
```python
{
    "file_id": str,
    "overall_status": str,      # "pending", "processing", "completed", "failed"
    "overall_progress": int,    # 0-100
    "message": str,             # ç‹€æ…‹æ¶ˆæ¯
    "chunking": {               # åˆ†å¡Šéšæ®µç‹€æ…‹
        "status": str,
        "progress": int,
        "message": str,
        "chunk_count": int      # åˆ†å¡Šæ•¸é‡
    },
    "vectorization": {          # å‘é‡åŒ–éšæ®µç‹€æ…‹
        "status": str,
        "progress": int,
        "message": str
    },
    "storage": {                # å­˜å„²éšæ®µç‹€æ…‹
        "status": str,
        "progress": int,
        "message": str,
        "collection_name": str, # ChromaDB collectionåç¨±
        "vector_count": int     # å‘é‡æ•¸é‡
    },
    "kg_extraction": {          # çŸ¥è­˜åœ–è­œæå–éšæ®µç‹€æ…‹
        "status": str,
        "progress": int,
        "message": str,
        "entities_count": int,  # âœ… å¯¦é«”æ•¸é‡ï¼ˆNERï¼‰
        "relations_count": int, # âœ… é—œä¿‚æ•¸é‡ï¼ˆREï¼‰
        "triples_count": int,   # âœ… ä¸‰å…ƒçµ„æ•¸é‡
        "mode": str,            # "all_chunks", "incremental"
        "job_id": str,          # RQ job ID
        "remaining_chunks": List, # å‰©é¤˜åˆ†å¡Šï¼ˆå¦‚æœæœªå®Œæˆï¼‰
        "failed_chunks": List,    # å¤±æ•—çš„åˆ†å¡Š
        "failed_permanent_chunks": List # æ°¸ä¹…å¤±æ•—çš„åˆ†å¡Š
    },
    "created_at": datetime,
    "updated_at": datetime
}
```

**æ›´æ–°å‡½æ•¸**ï¼š
- `_update_processing_status()` - `api/routers/file_upload.py:334`
  - **é›™å¯«æ¨¡å¼**ï¼šåŒæ™‚å¯«å…¥ Redis å’Œ ArangoDBï¼Œç¢ºä¿æ•¸æ“šä¸€è‡´æ€§
- `UploadStatusService.create_processing_status()` - `services/api/services/upload_status_service.py:257`
- `UploadStatusService.update_processing_status()` - `services/api/services/upload_status_service.py:320`

---

### âœ… 1.3 æ–‡ä»¶å…ƒæ•¸æ“šè¨˜éŒ„

**å­˜å„²ä½ç½®**ï¼š
- **ArangoDB**: `file_metadata` collection (æ°¸ä¹…å­˜å„²)

**è¨˜éŒ„å­—æ®µ**ï¼š
```python
{
    "_key": str,                # file_id
    "file_id": str,
    "filename": str,
    "file_type": str,           # MIMEé¡å‹
    "file_size": int,
    "user_id": str,
    "task_id": str,
    "folder_id": Optional[str],
    "storage_path": str,        # âœ… æ–‡ä»¶å­˜å„²è·¯å¾‘ï¼ˆæœ¬åœ°è·¯å¾‘æˆ–S3 URIï¼‰
    "tags": List[str],
    "description": Optional[str],
    "custom_metadata": Dict,
    "status": str,              # "uploaded", "generated", etc.
    "processing_status": Optional[str], # è™•ç†ç‹€æ…‹æ‘˜è¦
    "chunk_count": Optional[int],       # âœ… åˆ†å¡Šæ•¸é‡
    "vector_count": Optional[int],      # âœ… å‘é‡æ•¸é‡
    "kg_status": Optional[str],         # âœ… KGç‹€æ…‹ï¼ˆå­—ç¬¦ä¸²ï¼Œå¦‚"completed"ï¼‰
    "upload_time": datetime,            # âœ… ä¸Šå‚³æ™‚é–“
    "created_at": datetime,
    "updated_at": datetime
}
```

**æ³¨æ„**ï¼š`file_metadata` **æ²’æœ‰**è¨˜éŒ„ `entities_count` å’Œ `relations_count`ï¼Œé€™äº›ä¿¡æ¯å­˜å„²åœ¨ `processing_status.kg_extraction` ä¸­ã€‚

**æ›´æ–°å‡½æ•¸**ï¼š
- `FileMetadataService.create()` - `services/api/services/file_metadata_service.py:52`
- `FileMetadataService.update()` - `services/api/services/file_metadata_service.py:121`

---

## 2. æ–‡ä»¶å‚™ä»½ä½ç½®

### âš ï¸ é‡è¦èªªæ˜ï¼šå–®ä¸€å­˜å„²å¾Œç«¯ï¼Œéé›™é‡å‚™ä»½

**ç³»çµ±æ¡ç”¨å–®ä¸€å­˜å„²å¾Œç«¯æ©Ÿåˆ¶**ï¼Œæ ¹æ“šé…ç½®é¸æ“‡ä½¿ç”¨æœ¬åœ°æ–‡ä»¶ç³»çµ±æˆ– SeaweedFSï¼Œ**ä¸æ˜¯åŒæ™‚å‚™ä»½åˆ°å…©å€‹åœ°æ–¹**ã€‚

**å­˜å„²å¾Œç«¯é¸æ“‡é‚è¼¯**ï¼š
1. å¦‚æœæ˜ç¢ºæŒ‡å®š `storage_backend="local"` â†’ ä½¿ç”¨æœ¬åœ°æ–‡ä»¶ç³»çµ±
2. å¦‚æœæ˜ç¢ºæŒ‡å®š `storage_backend="s3"` â†’ ä½¿ç”¨ SeaweedFS/S3
3. å¦‚æœæœªæŒ‡å®šï¼Œæ ¹æ“šç’°å¢ƒè‡ªå‹•é¸æ“‡ï¼š
   - ç”Ÿç”¢ç’°å¢ƒ (`ENV=production`) â†’ å„ªå…ˆä½¿ç”¨ SeaweedFS
   - é–‹ç™¼ç’°å¢ƒ â†’ å„ªå…ˆä½¿ç”¨æœ¬åœ°æ–‡ä»¶ç³»çµ±

**å¯¦ç¾ä½ç½®**ï¼š
- `create_storage_from_config()` - `storage/file_storage.py:560`
- `get_storage()` - `api/routers/file_upload.py:135`

---

### âœ… 2.1 æœ¬åœ°æ–‡ä»¶ç³»çµ±å­˜å„²

**ä½¿ç”¨æ¢ä»¶**ï¼š
- `storage_backend="local"` æˆ–æœªé…ç½®ä¸” S3 ä¸å¯ç”¨

**å­˜å„²è·¯å¾‘**ï¼š

1. **ä»»å‹™å·¥ä½œå€æ¨¡å¼**ï¼ˆå„ªå…ˆï¼‰ï¼š
   ```
   data/tasks/{task_id}/workspace/{file_id}.{ext}
   ```

2. **å‚³çµ±æ¨¡å¼**ï¼ˆå‘å¾Œå…¼å®¹ï¼‰ï¼š
   ```
   ./data/datasets/files/{file_id[:2]}/{file_id}.{ext}
   ```

**å¯¦ç¾**ï¼š
- `LocalFileStorage` - `storage/file_storage.py:125`
- `_get_file_path()` - `storage/file_storage.py:159`
- `save_file()` - `storage/file_storage.py:206`

**é…ç½®**ï¼š
- é…ç½®æ–‡ä»¶ï¼š`config/config.json` â†’ `file_upload.storage_path`
- é»˜èªå€¼ï¼š`"./data/datasets/files"`

**storage_path å­—æ®µ**ï¼š
- å­˜å„²åœ¨ `file_metadata.storage_path` ä¸­
- æ ¼å¼ï¼šæœ¬åœ°æ–‡ä»¶è·¯å¾‘ï¼ˆå¦‚ `data/tasks/{task_id}/workspace/{file_id}.{ext}`ï¼‰

---

### âœ… 2.2 SeaweedFS/S3 å­˜å„²

**ä½¿ç”¨æ¢ä»¶**ï¼š
- `storage_backend="s3"` æˆ–ç”Ÿç”¢ç’°å¢ƒä¸” S3 é…ç½®å¯ç”¨

**å­˜å„²ä½ç½®**ï¼š

1. **AI-Box æœå‹™**ï¼ˆé»˜èªï¼‰ï¼š
   - **Bucket**: `bucket-ai-box-assets`
   - **Key**: `tasks/{task_id}/workspace/{file_id}.{ext}`
   - **S3 URIæ ¼å¼**: `s3://bucket-ai-box-assets/tasks/{task_id}/workspace/{file_id}.{ext}`

2. **DataLake æœå‹™**ï¼ˆå¯é¸ï¼Œç”¨æ–¼ DataLake é …ç›®ï¼‰ï¼š
   - **Bucket**: `bucket-datalake-assets`
   - **Key**: `tasks/{task_id}/workspace/{file_id}.{ext}`
   - **S3 URIæ ¼å¼**: `s3://bucket-datalake-assets/tasks/{task_id}/workspace/{file_id}.{ext}`

**å¯¦ç¾**ï¼š
- `S3FileStorage` - `storage/s3_storage.py:30`
- `SeaweedFSService` enum - `storage/s3_storage.py:23`

**é…ç½®**ï¼š
- ç’°å¢ƒè®Šæ•¸ï¼š
  - `AI_BOX_SEAWEEDFS_S3_ENDPOINT`
  - `AI_BOX_SEAWEEDFS_S3_ACCESS_KEY`
  - `AI_BOX_SEAWEEDFS_S3_SECRET_KEY`
- é…ç½®æ–‡ä»¶ï¼š`config/config.json` â†’ `file_upload.storage_backend = "s3"`

**storage_path å­—æ®µ**ï¼š
- å­˜å„²åœ¨ `file_metadata.storage_path` ä¸­
- æ ¼å¼ï¼š`s3://{bucket}/{key}`ï¼ˆå¦‚ `s3://bucket-ai-box-assets/tasks/{task_id}/workspace/{file_id}.{ext}`ï¼‰

---

### âš ï¸ 2.3 æ–‡ä»¶é·ç§»æ©Ÿåˆ¶ï¼ˆéé›™é‡å‚™ä»½ï¼‰

**é·ç§»è…³æœ¬**ï¼š`scripts/migration/migrate_files_to_seaweedfs.py`

**ç”¨é€”**ï¼š
- ä¸€æ¬¡æ€§å°‡æ–‡ä»¶å¾æœ¬åœ°æ–‡ä»¶ç³»çµ±é·ç§»åˆ° SeaweedFS
- æ›´æ–° `file_metadata.storage_path` ç‚º S3 URI
- **ä¸æ˜¯æŒçºŒçš„é›™é‡å‚™ä»½æ©Ÿåˆ¶**

**é·ç§»å¾Œ**ï¼š
- æ–‡ä»¶å¾æœ¬åœ°é·ç§»åˆ° SeaweedFS
- `storage_path` æ›´æ–°ç‚º S3 URI
- æœ¬åœ°æ–‡ä»¶å¯é¸åˆªé™¤ï¼ˆéœ€æ‰‹å‹•å‚™ä»½ï¼‰

**ç›¸é—œæ–‡æª”**ï¼š
- [æ–‡ä»¶é·ç§»æŒ‡å—](../../è³‡æ–™å­˜å„²æ¶æ§‹é‡æ§‹/æ–‡ä»¶é·ç§»æŒ‡å—.md)

---

## 3. ç‹€æ…‹è½‰æ›å‡½æ•¸

### âœ… 3.1 ä¸Šå‚³é€²åº¦æ›´æ–°

**å‡½æ•¸**ï¼š`_update_upload_progress()`
- **ä½ç½®**ï¼š`api/routers/file_upload.py:299`
- **åŠŸèƒ½**ï¼šæ›´æ–°æ–‡ä»¶ä¸Šå‚³é€²åº¦
- **å­˜å„²**ï¼šRedis + ArangoDB (`upload_progress` collection)

**èª¿ç”¨ä½ç½®**ï¼š
- `api/routers/file_upload.py:1934` - æ–‡ä»¶ä¿å­˜å®Œæˆå¾Œ
- `api/routers/file_upload.py:1986` - æ–‡ä»¶ä¸Šå‚³æˆåŠŸå¾Œ

---

### âœ… 3.2 è™•ç†ç‹€æ…‹æ›´æ–°

**å‡½æ•¸**ï¼š`_update_processing_status()`
- **ä½ç½®**ï¼š`api/routers/file_upload.py:334`
- **åŠŸèƒ½**ï¼šæ›´æ–°è™•ç†ç‹€æ…‹ï¼ˆé›™å¯«æ¨¡å¼ï¼šRedis + ArangoDBï¼‰
- **åƒæ•¸**ï¼š
  - `file_id`: æ–‡ä»¶ID
  - `chunking`: åˆ†å¡Šç‹€æ…‹å­—å…¸ï¼ˆå¯é¸ï¼‰
  - `vectorization`: å‘é‡åŒ–ç‹€æ…‹å­—å…¸ï¼ˆå¯é¸ï¼‰
  - `storage`: å­˜å„²ç‹€æ…‹å­—å…¸ï¼ˆå¯é¸ï¼‰
  - `kg_extraction`: KGæå–ç‹€æ…‹å­—å…¸ï¼ˆå¯é¸ï¼‰
  - `overall_status`: ç¸½é«”ç‹€æ…‹ï¼ˆå¯é¸ï¼‰
  - `overall_progress`: ç¸½é«”é€²åº¦ï¼ˆå¯é¸ï¼‰
  - `message`: ç‹€æ…‹æ¶ˆæ¯ï¼ˆå¯é¸ï¼‰

**èª¿ç”¨ä½ç½®**ï¼ˆéƒ¨åˆ†ï¼‰ï¼š
- `api/routers/file_upload.py:478` - åˆå§‹åŒ–è™•ç†ç‹€æ…‹
- `api/routers/file_upload.py:490` - é–‹å§‹åˆ†å¡Š
- `api/routers/file_upload.py:562` - åˆ†å¡Šå®Œæˆ
- `api/routers/file_upload.py:620` - å‘é‡åŒ–é–‹å§‹
- `api/routers/file_upload.py:639` - å‘é‡åŒ–å®Œæˆ
- `api/routers/file_upload.py:707` - å‘é‡å­˜å„²å®Œæˆ
- `api/routers/file_upload.py:805` - KGæå–é–‹å§‹
- `api/routers/file_upload.py:1299` - KGæå–é€²è¡Œä¸­
- `api/routers/file_upload.py:1321` - KGæå–å®Œæˆ
- `api/routers/file_upload.py:855` - è™•ç†å®Œæˆ
- `api/routers/file_upload.py:877` - è™•ç†å¤±æ•—

---

### âœ… 3.3 è™•ç†ç‹€æ…‹æœå‹™

**é¡**ï¼š`UploadStatusService`
- **ä½ç½®**ï¼š`services/api/services/upload_status_service.py:97`

**ä¸»è¦æ–¹æ³•**ï¼š

1. **`create_processing_status()`** - `services/api/services/upload_status_service.py:257`
   - å‰µå»ºè™•ç†ç‹€æ…‹è¨˜éŒ„
   - åƒæ•¸ï¼š`ProcessingStatusCreate`

2. **`get_processing_status()`** - `services/api/services/upload_status_service.py:295`
   - ç²å–è™•ç†ç‹€æ…‹è¨˜éŒ„
   - åƒæ•¸ï¼š`file_id`
   - è¿”å›ï¼š`Optional[ProcessingStatusModel]`

3. **`update_processing_status()`** - `services/api/services/upload_status_service.py:320`
   - æ›´æ–°è™•ç†ç‹€æ…‹è¨˜éŒ„
   - åƒæ•¸ï¼š`file_id`, `ProcessingStatusUpdate`
   - è¿”å›ï¼š`Optional[ProcessingStatusModel]`

4. **`delete_processing_status()`** - `services/api/services/upload_status_service.py:370`
   - åˆªé™¤è™•ç†ç‹€æ…‹è¨˜éŒ„
   - åƒæ•¸ï¼š`file_id`
   - è¿”å›ï¼š`bool`

---

### âœ… 3.4 æ–‡ä»¶å…ƒæ•¸æ“šæœå‹™

**é¡**ï¼š`FileMetadataService`
- **ä½ç½®**ï¼š`services/api/services/file_metadata_service.py:21`

**ä¸»è¦æ–¹æ³•**ï¼š

1. **`create()`** - `services/api/services/file_metadata_service.py:52`
   - å‰µå»ºæ–‡ä»¶å…ƒæ•¸æ“šè¨˜éŒ„
   - åƒæ•¸ï¼š`FileMetadataCreate`
   - è¿”å›ï¼š`FileMetadata`

2. **`get()`** - `services/api/services/file_metadata_service.py:105`
   - ç²å–æ–‡ä»¶å…ƒæ•¸æ“šè¨˜éŒ„
   - åƒæ•¸ï¼š`file_id`
   - è¿”å›ï¼š`Optional[FileMetadata]`

3. **`update()`** - `services/api/services/file_metadata_service.py:121`
   - æ›´æ–°æ–‡ä»¶å…ƒæ•¸æ“šè¨˜éŒ„
   - åƒæ•¸ï¼š`file_id`, `FileMetadataUpdate`
   - è¿”å›ï¼š`Optional[FileMetadata]`

---

## 4. ç‹€æ…‹è¨˜éŒ„å®Œæ•´æ€§æª¢æŸ¥

### âœ… 4.1 ä¸Šå‚³éšæ®µè¨˜éŒ„

| é …ç›® | è¨˜éŒ„ä½ç½® | å­—æ®µ | ç‹€æ…‹ |
|------|---------|------|------|
| ä¸Šå‚³æ™‚é–“ | `file_metadata.upload_time` | `datetime` | âœ… |
| æ–‡ä»¶å¤§å° | `file_metadata.file_size` | `int` | âœ… |
| ä¸Šå‚³é€²åº¦ | `upload_progress.progress` | `int (0-100)` | âœ… |
| ä¸Šå‚³ç‹€æ…‹ | `upload_progress.status` | `str` | âœ… |

---

### âœ… 4.2 å‘é‡åŒ–éšæ®µè¨˜éŒ„

| é …ç›® | è¨˜éŒ„ä½ç½® | å­—æ®µ | ç‹€æ…‹ |
|------|---------|------|------|
| åˆ†å¡Šæ•¸é‡ | `file_metadata.chunk_count`<br>`processing_status.chunking.chunk_count` | `int` | âœ… |
| å‘é‡æ•¸é‡ | `file_metadata.vector_count`<br>`processing_status.storage.vector_count` | `int` | âœ… |
| å‘é‡åŒ–ç‹€æ…‹ | `processing_status.vectorization.status` | `str` | âœ… |
| å‘é‡åŒ–é€²åº¦ | `processing_status.vectorization.progress` | `int (0-100)` | âœ… |
| ChromaDB Collection | `processing_status.storage.collection_name` | `str` | âœ… |

---

### âœ… 4.3 çŸ¥è­˜åœ–è­œæå–éšæ®µè¨˜éŒ„

| é …ç›® | è¨˜éŒ„ä½ç½® | å­—æ®µ | ç‹€æ…‹ |
|------|---------|------|------|
| å¯¦é«”æ•¸é‡ï¼ˆNERï¼‰ | `processing_status.kg_extraction.entities_count` | `int` | âœ… |
| é—œä¿‚æ•¸é‡ï¼ˆREï¼‰ | `processing_status.kg_extraction.relations_count` | `int` | âœ… |
| ä¸‰å…ƒçµ„æ•¸é‡ | `processing_status.kg_extraction.triples_count` | `int` | âœ… |
| KGæå–ç‹€æ…‹ | `processing_status.kg_extraction.status`<br>`file_metadata.kg_status` | `str` | âœ… |
| KGæå–é€²åº¦ | `processing_status.kg_extraction.progress` | `int (0-100)` | âœ… |
| å‰©é¤˜åˆ†å¡Š | `processing_status.kg_extraction.remaining_chunks` | `List` | âœ… |
| å¤±æ•—åˆ†å¡Š | `processing_status.kg_extraction.failed_chunks` | `List` | âœ… |

**æ³¨æ„**ï¼š
- âš ï¸ `file_metadata` **æ²’æœ‰**ç›´æ¥è¨˜éŒ„ `entities_count` å’Œ `relations_count`
- âœ… é€™äº›æ•¸æ“šå­˜å„²åœ¨ `processing_status.kg_extraction` ä¸­
- âœ… å¯ä»¥é€šé `GET /files/upload/{file_id}/kg/stats` API ç²å–

---

### âš ï¸ 4.4 æ™‚é–“è¨˜éŒ„

| é …ç›® | è¨˜éŒ„ä½ç½® | å­—æ®µ | ç‹€æ…‹ |
|------|---------|------|------|
| ä¸Šå‚³æ™‚é–“ | `file_metadata.upload_time` | `datetime` | âœ… |
| è™•ç†é–‹å§‹æ™‚é–“ | `processing_status.created_at` | `datetime` | âœ… |
| è™•ç†çµæŸæ™‚é–“ | `processing_status.updated_at` | `datetime` | âœ… |
| å„éšæ®µé–‹å§‹æ™‚é–“ | `processing_status.{stage}.started_at` | `datetime` | âš ï¸ (éƒ¨åˆ†æ”¯æŒ) |
| å„éšæ®µçµæŸæ™‚é–“ | `processing_status.{stage}.completed_at` | `datetime` | âš ï¸ (éƒ¨åˆ†æ”¯æŒ) |

**æ³¨æ„**ï¼šå„éšæ®µçš„ `started_at` å’Œ `completed_at` æ™‚é–“æˆ³åœ¨ `UploadStatusService.update_processing_status()` ä¸­è‡ªå‹•è¨­ç½®ï¼ˆ`services/api/services/upload_status_service.py:354-357`ï¼‰ï¼Œä½†éœ€è¦ç¢ºä¿åœ¨èª¿ç”¨æ™‚å‚³éäº†å°æ‡‰çš„éšæ®µç‹€æ…‹æ•¸æ“šã€‚

---

## 5. æª¢æŸ¥çµè«–

### âœ… 5.1 ç‹€æ…‹è¨˜éŒ„å®Œæ•´æ€§

**çµè«–**ï¼šâœ… **ç‹€æ…‹è¨˜éŒ„å®Œæ•´**

æ‰€æœ‰ä¸Šå‚³æ–‡ä»¶éƒ½æœ‰å®Œæ•´çš„ç‹€æ…‹ç®¡åˆ¶ï¼š

1. **ä¸Šå‚³ç‹€æ…‹**ï¼šè¨˜éŒ„åœ¨ `upload_progress` collection å’Œ Redis ä¸­
2. **è™•ç†ç‹€æ…‹**ï¼šè¨˜éŒ„åœ¨ `processing_status` collection å’Œ Redis ä¸­ï¼ˆé›™å¯«æ¨¡å¼ï¼‰
3. **æ–‡ä»¶å…ƒæ•¸æ“š**ï¼šè¨˜éŒ„åœ¨ `file_metadata` collection ä¸­ï¼ˆæ°¸ä¹…å­˜å„²ï¼‰
4. **å‘é‡åŒ–çµ±è¨ˆ**ï¼š`chunk_count`, `vector_count` è¨˜éŒ„åœ¨ `file_metadata` å’Œ `processing_status` ä¸­
5. **KGæå–çµ±è¨ˆ**ï¼š`entities_count`, `relations_count`, `triples_count` è¨˜éŒ„åœ¨ `processing_status.kg_extraction` ä¸­

---

### âš ï¸ 5.2 æ–‡ä»¶å‚™ä»½ä½ç½®

**çµè«–**ï¼šâš ï¸ **å–®ä¸€å­˜å„²å¾Œç«¯ï¼Œéé›™é‡å‚™ä»½**

**é‡è¦æ¾„æ¸…**ï¼š
- âŒ **ä¸æ˜¯é›™é‡å‚™ä»½**ï¼šæ–‡ä»¶ä¸æœƒåŒæ™‚å­˜å„²åœ¨æœ¬åœ°å’Œ SeaweedFS
- âœ… **å–®ä¸€å­˜å„²å¾Œç«¯**ï¼šæ ¹æ“šé…ç½®é¸æ“‡ä½¿ç”¨å…¶ä¸­ä¸€å€‹
- âœ… **å­˜å„²ä½ç½®æ˜ç¢º**ï¼š`file_metadata.storage_path` è¨˜éŒ„å¯¦éš›å­˜å„²ä½ç½®

**å­˜å„²æ©Ÿåˆ¶**ï¼š

1. **æœ¬åœ°å­˜å„²**ï¼ˆ`storage_backend="local"`ï¼‰ï¼š
   - è·¯å¾‘ï¼š`./data/datasets/files/` æˆ– `data/tasks/{task_id}/workspace/`
   - è¨˜éŒ„åœ¨ `file_metadata.storage_path` ä¸­ï¼ˆæœ¬åœ°è·¯å¾‘ï¼‰

2. **SeaweedFS/S3 å­˜å„²**ï¼ˆ`storage_backend="s3"`ï¼‰ï¼š
   - Bucketï¼š`bucket-ai-box-assets` æˆ– `bucket-datalake-assets`
   - Keyï¼š`tasks/{task_id}/workspace/{file_id}.{ext}`
   - S3 URIï¼š`s3://bucket/key`ï¼Œè¨˜éŒ„åœ¨ `file_metadata.storage_path` ä¸­

**é·ç§»æ©Ÿåˆ¶**ï¼š
- æä¾›é·ç§»è…³æœ¬å°‡æ–‡ä»¶å¾æœ¬åœ°é·ç§»åˆ° SeaweedFS
- é·ç§»å¾Œæ›´æ–° `storage_path` ç‚º S3 URI
- **ä¸æ˜¯æŒçºŒçš„é›™é‡å‚™ä»½**

---

### âœ… 5.3 ç‹€æ…‹è½‰æ›å‡½æ•¸

**çµè«–**ï¼šâœ… **ç‹€æ…‹è½‰æ›å‡½æ•¸å®Œæ•´**

ä¸»è¦ç‹€æ…‹è½‰æ›å‡½æ•¸ï¼š

1. **`_update_upload_progress()`** - æ›´æ–°ä¸Šå‚³é€²åº¦
2. **`_update_processing_status()`** - æ›´æ–°è™•ç†ç‹€æ…‹ï¼ˆé›™å¯«æ¨¡å¼ï¼‰
3. **`UploadStatusService`** - è™•ç†ç‹€æ…‹æœå‹™ï¼ˆCRUDæ“ä½œï¼‰
4. **`FileMetadataService`** - æ–‡ä»¶å…ƒæ•¸æ“šæœå‹™ï¼ˆCRUDæ“ä½œï¼‰

æ‰€æœ‰ç‹€æ…‹è½‰æ›éƒ½é€šéé€™äº›å‡½æ•¸é€²è¡Œï¼Œç¢ºä¿ç‹€æ…‹ä¸€è‡´æ€§ã€‚

---

## 6. å»ºè­°æ”¹é€²

### 6.1 æ–‡ä»¶å…ƒæ•¸æ“šå¢å¼·ï¼ˆå¯é¸ï¼‰

**å»ºè­°**ï¼šåœ¨ `file_metadata` ä¸­å¢åŠ  `entities_count` å’Œ `relations_count` å­—æ®µï¼Œæ–¹ä¾¿å¿«é€ŸæŸ¥è©¢ï¼Œé¿å…æ¯æ¬¡éƒ½æŸ¥è©¢ `processing_status`ã€‚

**å½±éŸ¿**ï¼š
- éœ€è¦ä¿®æ”¹ `FileMetadata` æ¨¡å‹å’Œ `FileMetadataUpdate` æ¨¡å‹
- éœ€è¦åœ¨ KG æå–å®Œæˆæ™‚åŒæ­¥æ›´æ–° `file_metadata`
- å¢åŠ æ•¸æ“šä¸€è‡´æ€§ç¶­è­·æˆæœ¬

**å„ªå…ˆç´š**ï¼šä½ï¼ˆç•¶å‰å¯é€šé `processing_status` ç²å–ï¼Œå·²æ»¿è¶³éœ€æ±‚ï¼‰

---

### 6.2 æ™‚é–“æˆ³è¨˜éŒ„å¢å¼·ï¼ˆå¯é¸ï¼‰

**å»ºè­°**ï¼šç¢ºä¿æ‰€æœ‰éšæ®µçš„ `started_at` å’Œ `completed_at` æ™‚é–“æˆ³éƒ½è¢«æ­£ç¢ºè¨˜éŒ„ã€‚

**ç•¶å‰ç‹€æ…‹**ï¼š
- `UploadStatusService.update_processing_status()` æœƒè‡ªå‹•è¨­ç½®é€™äº›æ™‚é–“æˆ³
- ä½†éœ€è¦ç¢ºä¿èª¿ç”¨æ™‚å‚³éäº†éšæ®µç‹€æ…‹æ•¸æ“š

**å„ªå…ˆç´š**ï¼šä¸­ï¼ˆæœ‰åŠ©æ–¼æ€§èƒ½åˆ†æå’Œèª¿è©¦ï¼‰

---

## 7. ç›¸é—œæ–‡æª”

- [æ–‡ä»¶ä¸Šå‚³æ¶æ§‹èªªæ˜](./ä¸Šå‚³çš„åŠŸèƒ½æ¶æ§‹èªªæ˜-v2.0.md)
- [ArangoDBæ•¸æ“šå­˜å„²è¦ç¯„](../../.cursorrules#-arangodb-æ•¸æ“šå­˜å„²è¦ç¯„)
- [UploadStatusService API](../../services/api/services/upload_status_service.py)
- [FileMetadataService API](../../services/api/services/file_metadata_service.py)

---

**æœ€å¾Œæ›´æ–°æ—¥æœŸ**: 2026-01-02

