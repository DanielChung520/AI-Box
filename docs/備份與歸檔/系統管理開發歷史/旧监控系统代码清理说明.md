# 旧监控系统代码清理说明

**文档编号**: CLEANUP-MONITOR-001
**版本**: 1.0
**创建日期**: 2026-01-18 18:54 UTC+8
**创建人**: Daniel Chung
**状态**: 待执行（观察期后）

---

## 📋 文档说明

### 目的

本文档说明在新监控系统（Prometheus + Grafana）稳定运行后，可以移除或归档的旧监控系统代码。

### 重要提示

⚠️ **建议保留旧代码作为回滚方案**，直到新系统稳定运行至少 1 个月后再考虑移除。

---

## 🔍 代码分析

### 需要保留的代码

以下代码需要保留，因为它们提供了兼容层、仍在使用或作为回滚方案：

#### 1. 兼容层和功能开关

- ✅ `api/routers/prometheus_compat.py` - Prometheus 兼容层 API（必须保留）
- ✅ `api/routers/service_monitor.py` - 服务监控路由（已添加功能开关，必须保留）
- ✅ `api/routers/service_alert.py` - 服务告警路由（仍在使用）
- ✅ `api/routers/alert_webhook.py` - Alertmanager Webhook 端点（新系统）

#### 2. 告警系统

- ✅ `services/api/models/service_alert.py` - 告警数据模型（新系统也使用）
- ✅ `services/api/services/service_alert_service.py` - 告警服务（新系统也使用）

#### 3. 数据模型（部分）

- ✅ `services/api/models/service_status.py` - 服务状态模型（兼容层需要）

---

## 🗑️ 可移除的代码（观察期后）

### 条件

移除前必须满足以下条件：

1. ✅ 新系统已稳定运行至少 24 小时（观察期）
2. ✅ 所有功能已迁移到新系统并验证通过
3. ✅ 已备份所有重要数据
4. ✅ 已获得项目负责人批准
5. ✅ 已确认不再需要回滚到旧系统

### 可移除的文件

#### 1. 旧监控服务（如果不再需要）

**文件**: `services/api/services/service_monitor_service.py`

**说明**:

- 提供旧系统的服务监控逻辑
- 如果新系统完全替代，可以考虑移除
- **建议**: 先标记为 deprecated，观察 1 个月后再移除

**移除步骤**:

```bash
# 1. 标记为 deprecated（添加注释）
# 2. 确认没有其他地方引用
# 3. 移除文件
git rm services/api/services/service_monitor_service.py
```

#### 2. 旧状态存储服务（如果不再需要）

**文件**: `services/api/services/service_status_store_service.py`

**说明**:

- 提供旧系统的服务状态存储逻辑
- 如果新系统完全替代，可以考虑移除
- **建议**: 先标记为 deprecated，观察 1 个月后再移除

**移除步骤**:

```bash
# 1. 标记为 deprecated（添加注释）
# 2. 确认没有其他地方引用
# 3. 移除文件
git rm services/api/services/service_status_store_service.py
```

#### 3. 旧数据模型（如果不再需要）

**文件**: `services/api/models/service_status.py`

**说明**:

- 旧系统的服务状态数据模型
- 如果兼容层不再需要，可以考虑移除
- **注意**: 兼容层 API 可能仍在使用此模型

**移除前检查**:

```bash
# 检查是否有其他地方引用
grep -r "from services.api.models.service_status import" .
grep -r "ServiceStatusModel" .
```

---

## 📦 归档方案

### 方案 1：Git 归档（推荐）

将旧代码移动到归档分支，而不是直接删除：

```bash
# 1. 创建归档分支
git checkout -b archive/old-monitoring-system

# 2. 移除旧代码
git rm services/api/services/service_monitor_service.py
git rm services/api/services/service_status_store_service.py

# 3. 提交归档
git commit -m "Archive: Remove old monitoring system code"

# 4. 切换回主分支
git checkout main
```

### 方案 2：标记为 Deprecated

在代码中添加 deprecated 标记，但不立即移除：

```python
# services/api/services/service_monitor_service.py

"""
⚠️ DEPRECATED: 此服务已废弃，请使用 Prometheus 监控系统
此文件将在 2026-02-18 后移除（新系统稳定运行 1 个月后）
"""

import warnings

warnings.warn(
    "ServiceMonitorService is deprecated. Use Prometheus monitoring system instead.",
    DeprecationWarning,
    stacklevel=2
)
```

---

## 📊 数据库清理

### 可清理的 Collections

如果新系统稳定运行，可以考虑清理以下 Collections：

1. **service_status** - 旧服务状态数据
2. **service_logs** - 旧服务日志数据

### 保留的 Collections

以下 Collections 需要保留，因为新系统也会使用：

1. **service_alerts** - 告警数据（新系统告警也存储 here）
2. **service_alert_rules** - 告警规则（新系统告警规则也存储 here）

### 清理步骤

使用清理脚本（已创建）：

```bash
# 1. 试运行
python scripts/cleanup_old_monitoring_data.py --dry-run

# 2. 确认后执行清理
python scripts/cleanup_old_monitoring_data.py --execute
```

---

## ⏰ 清理时间表

### 建议时间表

| 时间点 | 操作 | 说明 |
|--------|------|------|
| 切换后 24 小时 | 观察期监控 | 使用 `monitor_observation_period.py` |
| 切换后 1 周 | 评估新系统稳定性 | 检查是否有问题 |
| 切换后 1 个月 | 标记旧代码为 deprecated | 添加废弃警告 |
| 切换后 3 个月 | 归档旧代码 | 移动到归档分支或删除 |
| 切换后 6 个月 | 清理数据库 | 清理旧监控数据（可选） |

---

## 🔙 回滚方案

如果移除旧代码后需要回滚，可以：

1. **从 Git 历史恢复**:

   ```bash
   git checkout <commit-hash> -- services/api/services/service_monitor_service.py
   ```

2. **从归档分支恢复**:

   ```bash
   git checkout archive/old-monitoring-system -- services/api/services/service_monitor_service.py
   ```

3. **从备份恢复**:
   - 使用 `backup_monitoring_data.py` 创建的备份文件
   - 恢复 ArangoDB 数据

---

## ✅ 清理检查清单

在执行清理前，请确认：

- [ ] 新系统已稳定运行至少 24 小时
- [ ] 所有功能已迁移并验证通过
- [ ] 已备份所有重要数据
- [ ] 已获得项目负责人批准
- [ ] 已确认不再需要回滚
- [ ] 已通知相关团队成员
- [ ] 已更新相关文档

---

## 📞 联系与支持

如有疑问，请联系：

- **项目经理**: Daniel Chung
- **开发负责人**: Daniel Chung

---

**文档版本**: 1.0
**最后更新**: 2026-01-18 18:54 UTC+8
**维护人**: Daniel Chung
