# 文件遷移指南

**創建日期**: 2025-01-27
**創建人**: Daniel Chung
**最後修改日期**: 2025-12-29

**更新記錄**：

- 2025-12-29：驗證遷移腳本可用性，更新遷移步驟說明，添加遷移驗證檢查清單

---

## 📋 概述

本文檔說明如何將文件從本地文件系統遷移到 SeaweedFS，實現無狀態擴展和統一對象存儲。

## 🎯 遷移目標

- 將所有文件從本地文件系統（`./data/datasets/files`）遷移到 SeaweedFS
- 更新文件元數據中的 `storage_path` 字段為 S3 URI
- 確保文件完整性和數據一致性
- 支持增量遷移和中斷後繼續

## 📋 遷移前準備

### 1. 環境檢查

確保以下環境已配置：

- ✅ SeaweedFS 服務已部署並運行
- ✅ S3 API 端點可訪問
- ✅ 環境變數已配置（`AI_BOX_SEAWEEDFS_S3_ENDPOINT`, `AI_BOX_SEAWEEDFS_S3_ACCESS_KEY`, `AI_BOX_SEAWEEDFS_S3_SECRET_KEY`）
- ✅ Buckets 已創建（`bucket-ai-box-assets`）

### 2. 備份

**重要**：遷移前必須完整備份本地文件：

```bash
# 備份本地文件
tar -czf backup_files_$(date +%Y%m%d).tar.gz ./data/datasets/files

# 驗證備份
tar -tzf backup_files_$(date +%Y%m%d).tar.gz | head -20
```

### 3. 檢查配置

確認 `config/config.json` 中的 `file_upload` 配置正確：

```json
{
  "file_upload": {
    "storage_backend": "s3",
    "service_type": "ai_box"
  }
}
```

## 🚀 遷移步驟

### 步驟 1：乾運行測試

首先執行乾運行，檢查將要遷移的文件：

```bash
python scripts/migration/migrate_files_to_seaweedfs.py --dry-run
```

這將：

- 掃描本地文件
- 顯示將要遷移的文件列表
- 不實際上傳文件

### 步驟 2：執行遷移

執行實際遷移：

```bash
python scripts/migration/migrate_files_to_seaweedfs.py
```

遷移過程會：

- 掃描本地文件系統
- 上傳每個文件到 SeaweedFS
- 更新文件元數據中的 `storage_path` 為 S3 URI
- 驗證文件完整性（SHA256 哈希）
- 記錄遷移進度和狀態

### 步驟 3：驗證遷移結果

遷移完成後，驗證結果：

```bash
# 檢查遷移狀態
cat data/migration_state.json

# 檢查遷移日誌
tail -20 data/migration_log.jsonl
```

### 步驟 4：測試文件訪問

測試遷移後的文件是否可以正常訪問：

```bash
# 通過 API 測試文件下載
curl -X GET "http://localhost:8000/api/v1/files/{file_id}/download" \
  -H "Authorization: Bearer {token}"
```

## 📊 遷移選項

### 增量遷移（默認）

支持從上次中斷的地方繼續：

```bash
# 從上次中斷的地方繼續（默認行為）
python scripts/migration/migrate_files_to_seaweedfs.py
```

### 重新開始遷移

如果需要重新開始遷移：

```bash
# 不從上次中斷的地方繼續
python scripts/migration/migrate_files_to_seaweedfs.py --no-resume
```

### 跳過驗證

如果不需要驗證文件完整性（不推薦）：

```bash
# 跳過文件完整性檢查
python scripts/migration/migrate_files_to_seaweedfs.py --no-verify
```

### 刪除本地文件

**謹慎使用**：遷移完成後刪除本地文件：

```bash
# 遷移完成後刪除本地文件（需要確認）
python scripts/migration/migrate_files_to_seaweedfs.py --delete-local
```

## 🔍 遷移驗證

### 文件完整性檢查

遷移腳本會自動驗證每個文件：

1. 計算本地文件的 SHA256 哈希值
2. 上傳文件到 SeaweedFS
3. 從 SeaweedFS 讀取文件
4. 計算上傳文件的 SHA256 哈希值
5. 比較兩個哈希值，確保一致

### 元數據驗證

檢查文件元數據是否正確更新：

```python
from services.api.services.file_metadata_service import FileMetadataService

metadata_service = FileMetadataService()
file_metadata = metadata_service.get(file_id)

# 檢查 storage_path 是否為 S3 URI
assert file_metadata.storage_path.startswith("s3://")
```

## 📈 遷移進度追蹤

遷移狀態保存在 `data/migration_state.json`：

```json
{
  "migrated_files": ["file_id_1", "file_id_2", ...],
  "failed_files": [
    {"file_id": "file_id_x", "error": "error message"}
  ],
  "total_files": 1000,
  "migrated_count": 950,
  "failed_count": 50
}
```

遷移日誌保存在 `data/migration_log.jsonl`（JSON Lines 格式）：

```json
{"type": "migrated", "timestamp": "...", "file_id": "...", "s3_uri": "s3://..."}
{"type": "failed", "timestamp": "...", "file_id": "...", "error": "..."}
```

## 🔄 回滾步驟

如果遷移出現問題，可以回滾：

### 1. 停止遷移

如果遷移正在進行，停止遷移腳本（Ctrl+C）。

### 2. 恢復本地文件

從備份恢復本地文件：

```bash
# 恢復備份
tar -xzf backup_files_YYYYMMDD.tar.gz -C ./

# 驗證恢復
ls -la ./data/datasets/files
```

### 3. 恢復元數據

如果需要恢復元數據中的 `storage_path`：

```python
# 從備份的元數據恢復（需要手動操作）
# 或使用數據庫備份恢復
```

## ⚠️ 常見問題

### 問題 1：遷移中斷

**解決方案**：

- 遷移腳本支持增量遷移，可以從上次中斷的地方繼續
- 使用 `--no-resume` 選項可以重新開始

### 問題 2：文件哈希不匹配

**可能原因**：

- 文件在上傳過程中損壞
- SeaweedFS 存儲問題

**解決方案**：

- 檢查 SeaweedFS 服務狀態
- 重新遷移失敗的文件
- 檢查網絡連接

### 問題 3：元數據更新失敗

**可能原因**：

- ArangoDB 連接問題
- 文件元數據不存在

**解決方案**：

- 檢查 ArangoDB 連接
- 確認文件元數據存在
- 手動更新元數據

## 📝 遷移後檢查清單

- [ ] 所有文件已成功上傳到 SeaweedFS
- [ ] 文件元數據中的 `storage_path` 已更新為 S3 URI
- [ ] 文件完整性驗證通過
- [ ] 文件可以通過 API 正常訪問
- [ ] 遷移日誌已記錄
- [ ] 本地文件已備份（如果未刪除）

## 🔗 相關文檔

- [資料存儲架構重構分析與計劃](../資料存儲架構重構分析與計劃.md)
- [資料架構建議報告](../資料架构建议报告.md)
- [存儲架構文檔](../核心组件/存储架构.md)

---

**最後更新**: 2025-01-27
**維護者**: Daniel Chung
