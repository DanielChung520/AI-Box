# 為什麼執行 ruff check . 和 mypy . 還是有很多錯誤？

**版本**: 1.0
**創建日期**: 2025-01-27
**創建人**: Daniel Chung
**最後修改日期**: 2025-01-27

---

## 當前錯誤統計

### Ruff 檢查結果

- **總錯誤數**: 8,763 個
- **可自動修復**: 3,310 個
- **高優先級錯誤**（F821, E722）: **5 個** ✅（已基本修復）
- **基本錯誤**（E, F, W）: **139 個**

### Mypy 檢查結果

- **總錯誤數**: 1,163 個
- **檢查的文件**: 580 個源文件
- **有錯誤的文件**: 178 個

---

## 為什麼還有很多錯誤？

### 原因分析

#### 1. **啟用了太多規則類別**

當前配置啟用了以下規則：

- E: pycodestyle errors
- F: pyflakes
- W: pycodestyle warnings
- **I: isort**（導入排序）- 239 個錯誤
- **UP: pyupgrade**（Python 版本升級建議）- 約 3,000+ 個錯誤
- B: flake8-bugbear
- **SIM: flake8-simplify**（簡化建議）- 約 20+ 個錯誤
- **RET: flake8-return**（返回值檢查）- 約 50+ 個錯誤
- **RUF: ruff-specific rules**（ruff 特定規則）- 約 5,000+ 個錯誤

#### 2. **主要錯誤類型分布**

根據統計，主要錯誤類型：

1. **RUF002/RUF003** (3,895 個): 模糊的 Unicode 字符
   - 在文檔字符串和註釋中使用了可能混淆的 Unicode 字符
   - **優先級**: 低（主要是中文註釋中的字符）

2. **UP006** (1,402 個): 使用 `List` 而不是 `list`
   - Python 3.9+ 建議使用內建類型 `list` 而不是 `typing.List`
   - **優先級**: 中（可以逐步修復）

3. **UP045** (1,265 個): 使用 `X | None` 而不是 `Optional[X]`
   - Python 3.10+ 支持使用 `X | None` 語法
   - **優先級**: 中（但項目規範要求使用 `Optional[X]`）

4. **RUF001** (884 個): 模糊的 Unicode 字符（字符串中）
   - **優先級**: 低

5. **I001** (239 個): 導入未排序
   - **優先級**: 低（可以自動修復）

6. **其他規則**: 各種簡化建議、返回值檢查等
   - **優先級**: 低到中

---

## 解決方案

### 方案 1: 調整配置，只啟用核心規則（推薦）

**當前問題**: 啟用了太多規則（UP, SIM, RET, RUF），導致檢查出大量非關鍵問題。

**解決方案**: 調整 `pyproject.toml`，只啟用核心規則，暫時忽略非關鍵規則。

#### 調整後的配置

```toml
[tool.ruff.lint]
# 只啟用核心規則，避免過於嚴格
select = [
    "E",      # pycodestyle errors (基本錯誤)
    "F",      # pyflakes (未定義變量、未使用導入等)
    "W",      # pycodestyle warnings (基本警告)
    # 以下規則暫時不啟用，待代碼質量提升後再啟用
    # "I",      # isort (導入排序) - 可以自動修復，但暫時不強制
    # "UP",     # pyupgrade (Python 版本升級建議) - 非關鍵
    # "B",      # flake8-bugbear (常見 bug 模式) - 可選
    # "SIM",    # flake8-simplify (簡化建議) - 非關鍵
    # "RET",    # flake8-return (返回值檢查) - 非關鍵
    # "RUF",    # ruff-specific rules - 包含很多非關鍵規則
]

# 全局忽略非關鍵規則
ignore = [
    "E501",   # line too long (handled by black)
    "RUF002", # ambiguous-unicode-character-docstring (中文註釋中的字符)
    "RUF003", # ambiguous-unicode-character-comment (中文註釋中的字符)
    "RUF001", # ambiguous-unicode-character-string (中文字符串)
    "UP006",  # non-pep585-annotation (使用 List 而不是 list) - 可以逐步修復
    "UP045",  # non-pep604-annotation-optional (使用 Optional 而不是 |) - 項目規範要求使用 Optional
]
```

### 方案 2: 分階段啟用規則

**階段 1**（當前）: 只啟用核心規則（E, F, W）

- 錯誤數: 約 139 個
- 優先級: 高

**階段 2**（未來）: 啟用導入排序（I）

- 錯誤數: 約 239 個
- 優先級: 中（可以自動修復）

**階段 3**（長期）: 逐步啟用其他規則

- UP: Python 版本升級建議
- SIM: 簡化建議
- RET: 返回值檢查
- RUF: ruff 特定規則

### 方案 3: 配置忽略特定規則

對於非關鍵規則，可以在配置中忽略：

```toml
[tool.ruff.lint]
ignore = [
    "E501",   # line too long
    "RUF002", # 模糊的 Unicode 字符（文檔字符串）
    "RUF003", # 模糊的 Unicode 字符（註釋）
    "RUF001", # 模糊的 Unicode 字符（字符串）
    "UP006",  # 使用 List 而不是 list（可以逐步修復）
    "UP045",  # 使用 Optional 而不是 |（項目規範要求使用 Optional）
    "I001",   # 導入未排序（可以自動修復，但不強制）
]
```

---

## 推薦配置

### 最小配置（只檢查關鍵錯誤）

```toml
[tool.ruff.lint]
select = [
    "E",      # pycodestyle errors
    "F",      # pyflakes
    "W",      # pycodestyle warnings
]

ignore = [
    "E501",   # line too long (handled by black)
]
```

**預期錯誤數**: 約 139 個（基本錯誤）

### 推薦配置（平衡檢查和實用性）

```toml
[tool.ruff.lint]
select = [
    "E",      # pycodestyle errors
    "F",      # pyflakes
    "W",      # pycodestyle warnings
    "I",      # isort (可以自動修復)
]

ignore = [
    "E501",   # line too long (handled by black)
    "RUF002", # 模糊的 Unicode 字符（中文註釋）
    "RUF003", # 模糊的 Unicode 字符（中文註釋）
    "RUF001", # 模糊的 Unicode 字符（中文字符串）
    "UP006",  # 使用 List 而不是 list（逐步修復）
    "UP045",  # 使用 Optional 而不是 |（項目規範要求）
]
```

**預期錯誤數**: 約 400 個（基本錯誤 + 導入排序）

---

## Mypy 錯誤分析

### 主要錯誤類型

1. **類型注解不完整**: 大量函數缺少類型注解
2. **類型不匹配**: 類型使用不正確
3. **未定義的導入**: 某些模塊找不到類型存根
4. **不可達代碼**: 某些代碼路徑不可達

### 解決方案

Mypy 錯誤主要是因為：

- 項目中有大量未類型化的代碼
- 這是正常的，需要逐步改進

**建議**：

- 不啟用 `strict = true`（當前配置正確）
- 逐步改進類型注解
- 新代碼必須包含完整類型注解

---

## 實際建議

### 1. 調整 Ruff 配置（立即執行）

只啟用核心規則，忽略非關鍵規則：

```toml
[tool.ruff.lint]
select = ["E", "F", "W"]  # 只啟用核心規則

ignore = [
    "E501",   # line too long
    "RUF002", # 模糊的 Unicode 字符
    "RUF003", # 模糊的 Unicode 字符
    "RUF001", # 模糊的 Unicode 字符
    "UP006",  # 使用 List 而不是 list
    "UP045",  # 使用 Optional 而不是 |
]
```

### 2. 分階段改進

**階段 1**（當前）:

- 只檢查核心錯誤（E, F, W）
- 錯誤數: 約 139 個

**階段 2**（1-2 週後）:

- 啟用導入排序（I），自動修復
- 錯誤數: 約 400 個

**階段 3**（1-2 個月後）:

- 逐步修復 UP006（使用 `list` 而不是 `List`）
- 逐步改進類型注解

### 3. 使用自動修復

對於可以自動修復的錯誤：

```bash
# 自動修復導入排序
ruff check --fix --select I .

# 自動修復類型注解（UP006, UP045）
ruff check --fix --select UP006,UP045 .
```

---

## 總結

### 為什麼還有很多錯誤？

1. **啟用了太多規則**: UP, SIM, RET, RUF 規則檢查出大量非關鍵問題
2. **非關鍵錯誤占多數**:
   - Unicode 字符問題（約 4,000+ 個）- 主要是中文註釋
   - 類型注解風格（約 2,600+ 個）- 可以逐步修復
   - 導入排序（239 個）- 可以自動修復
3. **高優先級錯誤已修復**: F821, E722 只有 5 個

### 解決方案

1. **調整配置**: 只啟用核心規則（E, F, W）
2. **忽略非關鍵規則**: RUF002, RUF003, UP006, UP045 等
3. **分階段改進**: 逐步啟用更多規則

### 預期結果

調整配置後：

- **Ruff 錯誤**: 從 8,763 個降至約 139 個（核心錯誤）
- **Mypy 錯誤**: 保持約 1,163 個（需要逐步改進類型注解）

---

**文檔版本**: 1.0
**最後更新**: 2025-01-27
**維護者**: Daniel Chung
