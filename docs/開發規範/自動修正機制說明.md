# 自動修正機制說明

**版本**: 1.0
**創建日期**: 2025-01-27
**創建人**: Daniel Chung
**最後修改日期**: 2025-01-27

---

## 概述

配置了 `pyproject.toml` 和 `.pre-commit-config.yaml` 後，**部分工具會自動修正代碼**，但**不是所有工具都會自動修正**。

---

## 自動修正的工具

### ✅ 會自動修正的工具

以下工具在 pre-commit hooks 中**會自動修正**代碼問題：

#### 1. **trailing-whitespace** ✅

**功能**: 移除行尾空格

**自動修正**: ✅ 是

**觸發時機**: 每次 `git commit` 時

**示例**:

```python
# 修正前
def hello():
    return "world"

# 修正後（自動）
def hello():
    return "world"
```

---

#### 2. **end-of-file-fixer** ✅

**功能**: 確保文件末尾有換行符

**自動修正**: ✅ 是

**觸發時機**: 每次 `git commit` 時

---

#### 3. **black** ✅

**功能**: Python 代碼格式化

**自動修正**: ✅ 是

**觸發時機**: 每次 `git commit` 時

**修正內容**:

- 代碼縮進
- 引號風格
- 行長度（根據配置）
- 運算符周圍的空格
- 等等

**示例**:

```python
# 修正前
def hello( name:str,age:int )->str:
    return f"Hello {name}, you are {age} years old"

# 修正後（自動）
def hello(name: str, age: int) -> str:
    return f"Hello {name}, you are {age} years old"
```

---

#### 4. **isort** ✅

**功能**: 導入語句排序

**自動修正**: ✅ 是

**觸發時機**: 每次 `git commit` 時

**修正內容**:

- 標準庫導入
- 第三方庫導入
- 第一方包導入
- 按字母順序排序

**示例**:

```python
# 修正前
from fastapi import APIRouter
import os
from typing import Optional
from services.api import SomeService

# 修正後（自動）
import os
from typing import Optional

from fastapi import APIRouter

from services.api import SomeService
```

---

#### 5. **ruff** ✅

**功能**: 快速代碼檢查和修正

**自動修正**: ✅ 是（部分問題）

**觸發時機**: 每次 `git commit` 時

**修正內容**:

- 未使用的導入（可自動移除）
- 簡單的語法問題
- 代碼風格問題

**配置**: 在 `.pre-commit-config.yaml` 中已配置 `--fix` 參數

**示例**:

```python
# 修正前
import os
import sys  # 未使用
from typing import Optional, List

def hello():
    return "world"

# 修正後（自動移除未使用的導入）
import os
from typing import Optional, List

def hello():
    return "world"
```

---

#### 6. **markdownlint** ✅

**功能**: Markdown 格式檢查和修正

**自動修正**: ✅ 是（部分問題）

**觸發時機**: 每次 `git commit` 時

**修正內容**:

- 標題格式
- 列表格式
- 代碼塊格式
- 等等

**配置**: 在 `.pre-commit-config.yaml` 中已配置 `--fix` 參數

---

### ⚠️ 只檢查不自動修正的工具

以下工具**只檢查不自動修正**，需要手動修復：

#### 1. **mypy** ⚠️

**功能**: 類型檢查

**自動修正**: ❌ 否

**觸發時機**: 每次 `git commit` 時

**作用**: 報告類型錯誤，但**不會自動修正**

**需要手動修復**:

- 添加類型注解
- 修復類型不匹配
- 添加 `# type: ignore` 註釋（如需要）

**示例**:

```python
# mypy 會報告錯誤，但不會自動修正
def hello(name):  # ❌ mypy: 缺少類型注解
    return f"Hello {name}"

# 需要手動修復
def hello(name: str) -> str:  # ✅
    return f"Hello {name}"
```

---

#### 2. **bandit** ⚠️

**功能**: 安全掃描

**自動修正**: ❌ 否

**觸發時機**: 每次 `git commit` 時

**作用**: 報告安全問題，但**不會自動修正**

**需要手動修復**:

- 修復安全漏洞
- 添加 `# nosec` 註釋（如需要）
- 使用更安全的替代方案

---

#### 3. **check-yaml**, **check-json**, **check-toml** ⚠️

**功能**: 配置文件語法檢查

**自動修正**: ❌ 否

**觸發時機**: 每次 `git commit` 時

**作用**: 報告語法錯誤，但**不會自動修正**

---

## 工作流程

### 1. 創建或修改代碼時

**不會自動修正**，需要手動運行工具或等待提交時修正。

### 2. 執行 `git commit` 時

**Pre-commit hooks 會自動運行**，並嘗試修正可以自動修正的問題：

```bash
git commit -m "your message"
```

**流程**:

1. Pre-commit hooks 自動運行
2. 自動修正工具（black, isort, ruff 等）修正代碼
3. 如果修正了文件，會自動重新添加到暫存區
4. 如果仍有錯誤（如 mypy 錯誤），提交會被阻止
5. 修復錯誤後，需要重新提交

---

## 手動運行自動修正

### 在提交前手動修正

如果不想等到提交時才修正，可以手動運行：

```bash
# 運行所有 pre-commit hooks（包括自動修正）
pre-commit run --all-files

# 或只運行特定工具
pre-commit run black --all-files
pre-commit run isort --all-files
pre-commit run ruff --all-files
```

### 直接運行工具

```bash
# Black 格式化
black .

# isort 排序導入
isort .

# Ruff 檢查和修正
ruff check --fix .
```

---

## 配置說明

### pyproject.toml

**作用**: 定義工具的配置規則

**不會自動運行**: `pyproject.toml` 本身**不會自動運行**，只是定義配置

**需要配合**: 需要配合 pre-commit hooks 或手動運行工具

### .pre-commit-config.yaml

**作用**: 定義 pre-commit hooks 的行為

**自動運行**: 在 `git commit` 時**自動運行**

**自動修正**: 配置了 `--fix` 的工具會自動修正

---

## 實際示例

### 場景 1: 創建新文件

```bash
# 1. 創建新文件
echo 'def hello(name):return f"Hello {name}"' > test.py

# 2. 提交時會自動修正
git add test.py
git commit -m "add test"
# black 會自動格式化代碼
# isort 會自動排序導入（如果有）
# ruff 會自動修正可修正的問題
```

### 場景 2: 修改現有文件

```bash
# 1. 修改文件
vim some_file.py  # 添加一些代碼

# 2. 提交時會自動修正
git add some_file.py
git commit -m "update file"
# 所有自動修正工具都會運行
```

### 場景 3: 有類型錯誤

```bash
# 1. 創建有類型錯誤的文件
echo 'def hello(name): return name + 1' > test.py

# 2. 提交時
git add test.py
git commit -m "add test"
# black 會自動格式化 ✅
# isort 會自動排序導入 ✅
# mypy 會報告類型錯誤 ❌（不會自動修正）
# 提交會被阻止，需要手動修復類型錯誤
```

---

## 注意事項

### 1. 自動修正的限制

- **不是所有問題都能自動修正**
- **類型錯誤需要手動修復**
- **邏輯錯誤需要手動修復**
- **安全問題需要手動修復**

### 2. 提交時的行為

- 如果自動修正了文件，**文件會自動重新添加到暫存區**
- 如果仍有錯誤，**提交會被阻止**
- 需要**修復錯誤後重新提交**

### 3. IDE 集成

- 許多 IDE（如 VS Code, PyCharm）可以配置在保存時自動運行 black/isort
- 這樣可以在編輯時就看到修正後的效果
- 但提交時的 pre-commit hooks 仍然會運行

---

## 總結

### ✅ 會自動修正

- **trailing-whitespace**: 移除行尾空格
- **end-of-file-fixer**: 文件末尾換行符
- **black**: 代碼格式化
- **isort**: 導入排序
- **ruff**: 部分代碼問題（配置了 `--fix`）
- **markdownlint**: 部分 Markdown 問題（配置了 `--fix`）

### ⚠️ 只檢查不修正

- **mypy**: 類型檢查（需要手動修復）
- **bandit**: 安全掃描（需要手動修復）
- **check-yaml/json/toml**: 語法檢查（需要手動修復）

### 📝 觸發時機

- **自動觸發**: 執行 `git commit` 時
- **手動觸發**: 運行 `pre-commit run --all-files` 時

### 🔧 配置位置

- **pyproject.toml**: 定義工具配置規則
- **.pre-commit-config.yaml**: 定義 pre-commit hooks 行為

---

## 建議

### 1. 在提交前檢查

```bash
# 運行所有 hooks，查看是否有問題
pre-commit run --all-files
```

### 2. 配置 IDE 自動格式化

- VS Code: 安裝 Python 擴展，配置保存時自動格式化
- PyCharm: 配置保存時運行 black/isort

### 3. 逐步改進

- 新代碼：確保通過所有檢查
- 舊代碼：逐步改進，不要求一次性修復所有問題

---

**文檔版本**: 1.0
**最後更新**: 2025-01-27
**維護者**: Daniel Chung
