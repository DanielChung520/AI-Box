# AI-Box 環境重裝計劃

**創建日期**: 2026-01-29
**創建人**: Daniel Chung
**最後修改日期**: 2026-01-29
**關聯文檔**: [開發環境設置指南](./系统设计文档/开发环境设置指南.md)、[start_services 腳本更新說明](./備份與歸檔/start_services脚本更新说明.md)

---

## 1. 概述

本文檔說明在**新環境**（例如遷移專案後）如何依 `scripts/start_services.sh` 與相關 docker-compose 配置，依序重建所有服務與 Docker 容器，使 AI-Box 可正常運行。

### 1.1 適用情境

- 專案遷移到新機器或新路徑
- 開發環境重裝（Docker、Python、Node 等）
- 需從頭建立所有依賴服務與容器

### 1.2 前置條件

- 已安裝 **Docker**（含 Docker Compose：`docker-compose` 或 `docker compose`）
- 已安裝 **Python 3.11+**（建議使用 venv）
- 已安裝 **Node.js**（前端與部分工具）
- 專案路徑：`/home/daniel/ai-box`（可依實際路徑替換）

---

## 2. 服務與容器清單

### 2.1 Docker 容器（需重建或確保存在）

| 服務                 | 容器名稱        | 端口             | 配置來源                                               | 備註                  |
| -------------------- | --------------- | ---------------- | ------------------------------------------------------ | --------------------- |
| ArangoDB             | `arangodb`    | 8529             | 腳本內 `docker run` 或既有容器                       | 圖資料庫              |
| Qdrant               | `qdrant`      | 6333, 6334       | 腳本內 `docker run` 或 `docker-compose.qdrant.yml` | 向量資料庫            |
| Redis                | 依 compose/腳本 | 6379             | 腳本假設有 Redis 容器                                  | 快取與 RQ             |
| SeaweedFS (AI-Box)   | 見下表          | 9333, 8888, 8333 | `docker-compose.seaweedfs.yml`                       | 文件存儲 S3           |
| SeaweedFS (DataLake) | 見下表          | 9334, 8889, 8334 | `docker-compose.seaweedfs-datalake.yml`              | DataLake 存儲         |
| 監控（可選）         | 見下表          | 見下表           | `docker-compose.monitoring.yml`                      | Prometheus/Grafana 等 |

**SeaweedFS AI-Box**（`docker-compose.seaweedfs.yml`）：

- `seaweedfs-ai-box-master` — 9333
- `seaweedfs-ai-box-volume` — 無對外端口
- `seaweedfs-ai-box-filer` — 8888（Filer）, 8333（S3）

**SeaweedFS DataLake**（`docker-compose.seaweedfs-datalake.yml`）：

- `seaweedfs-datalake-master` — 9334
- `seaweedfs-datalake-volume` — 無對外端口
- `seaweedfs-datalake-filer` — 8889（Filer）, 8334（S3）

**監控**（`docker-compose.monitoring.yml`）：

- `aibox-prometheus` — 9090
- `aibox-grafana` — 3001
- `aibox-alertmanager` — 9093
- `aibox-node-exporter` — 9100
- `aibox-redis-exporter` — 9121

### 2.2 非 Docker 服務（本機進程）

| 服務         | 端口 | 說明              |
| ------------ | ---- | ----------------- |
| FastAPI      | 8000 | 後端 API          |
| MCP Server   | 8002 | MCP 服務          |
| Frontend     | 3000 | 前端（如 ai-bot） |
| RQ Worker    | -    | 任務隊列 Worker   |
| RQ Dashboard | 9181 | RQ 監控介面       |

### 2.3 監控與儀表板（Grafana / Performance / Streamlit）

| 類型                     | 說明                                               | 端口／路徑 | 備註                                                         |
| ------------------------ | -------------------------------------------------- | ---------- | ------------------------------------------------------------ |
| **Grafana**        | 監控可視化，含多個儀表板                           | 3001       | 需先啟動 `monitoring` 堆疊                                 |
| **Grafana 儀表板** | 系統概覽、服務狀態、性能監控、Redis、Node Exporter | 見 3.5 節  | 由 `monitoring/grafana/` 自動 provisioning                 |
| **Performance**    | 效能測試腳本與 Grafana 性能儀表板                  | 見 3.5 節  | 腳本：`scripts/performance/`、測試：`tests/performance/` |
| **Streamlit**      | 儀表板應用（若專案有引入）                         | 預設 8501  | 需安裝 `streamlit` 並依專案路徑啟動                        |

### 2.4 端口佔用清單

以下為 `start_services.sh` 與各 docker-compose 會佔用的端口；重裝前請確認本機或容器未佔用，避免衝突。

| 端口               | 服務                      | 來源                                           | 備註                                       |
| ------------------ | ------------------------- | ---------------------------------------------- | ------------------------------------------ |
| **3000**     | Frontend（ai-bot / Vite） | start_services.sh、ai-bot/vite.config.ts       | 前端開發／生產                             |
| **3001**     | Grafana                   | docker-compose.monitoring.yml                  | 監控可視化（容器內 3000 映射到主機 3001）  |
| **5432**     | PostgreSQL                | docker-compose.yml / docker-compose.qdrant.yml | 若使用主 compose 或 qdrant compose         |
| **6333**     | Qdrant REST API           | start_services.sh、docker-compose.qdrant.yml   | 向量資料庫                                 |
| **6334**     | Qdrant gRPC               | start_services.sh、docker-compose.qdrant.yml   | 向量資料庫                                 |
| **6379**     | Redis                     | start_services.sh、docker-compose*.yml         | 快取與 RQ                                  |
| **8000**     | FastAPI                   | start_services.sh                              | 後端 API                                   |
| **8002**     | MCP Server                | start_services.sh、docker-compose.qdrant.yml   | MCP 服務                                   |
| **8001**     | ChromaDB                  | docker-compose.prod.yml                        | 僅生產 compose，本專案已遷移 Qdrant 可忽略 |
| **8333**     | SeaweedFS AI-Box S3       | docker-compose.seaweedfs.yml                   | 文件存儲 S3 API                            |
| **8334**     | SeaweedFS DataLake S3     | docker-compose.seaweedfs-datalake.yml          | DataLake S3 API                            |
| **8529**     | ArangoDB                  | start_services.sh、docker-compose*.yml         | 圖資料庫                                   |
| **8888**     | SeaweedFS AI-Box Filer    | docker-compose.seaweedfs.yml                   | Filer API                                  |
| **8889**     | SeaweedFS DataLake Filer  | docker-compose.seaweedfs-datalake.yml          | Filer API                                  |
| **9090**     | Prometheus                | docker-compose.monitoring.yml                  | 監控指標                                   |
| **9093**     | Alertmanager              | docker-compose.monitoring.yml                  | 告警                                       |
| **9100**     | Node Exporter             | docker-compose.monitoring.yml                  | 主機指標                                   |
| **9121**     | Redis Exporter            | docker-compose.monitoring.yml                  | Redis 指標                                 |
| **9181**     | RQ Dashboard              | start_services.sh（`RQ_DASHBOARD_PORT`）     | 任務隊列監控介面                           |
| **9333**     | SeaweedFS AI-Box Master   | docker-compose.seaweedfs.yml                   | Master API                                 |
| **9334**     | SeaweedFS DataLake Master | docker-compose.seaweedfs-datalake.yml          | Master API                                 |
| **11434**    | Ollama                    | docker-compose.prod.yml                        | 僅生產／本機 LLM，可選                     |
| **8501**     | Streamlit                 | 文檔說明                                       | 可選，專案未內建時不需佔用                 |
| **80 / 443** | Nginx                     | docker-compose.prod.yml                        | 僅生產環境反向代理                         |

**檢查指令**（Linux/macOS）：`lsof -i :<端口>` 或 `nc -z 127.0.0.1 <端口>` 可確認端口是否已被佔用。

**前端啟動說明**：`./scripts/start_services.sh frontend` 會執行 **`run dev:client`**（即 `vite --host --port 3000`），與 npm／pnpm 皆相容。若腳本仍寫成 `dev`，npm 會報 "Unknown command: dev"（需改為 `npm run dev`）；且 `npm run dev` 會呼叫 `start-dev.sh`，該腳本內使用 `pnpm dev:client`，在僅安裝 npm 的環境會失敗，故腳本已改為直接執行 `run dev:client`。

**只用 Docker 啟動（推薦若你習慣用 Docker）**：在專案根目錄執行一條指令即可啟動基礎設施與後端：

```bash
docker compose -f docker-compose.qdrant.yml up -d
```

會啟動：Redis、Qdrant、SeaweedFS（AI-Box）、Postgres、API、MCP。**ArangoDB** 已設為可選（profile）：若你**已有**名為 `arangodb` 的容器在跑，上述指令不會再建一個，避免名稱衝突；若**沒有** ArangoDB 且希望由 compose 建立，請先移除舊容器再加 profile：`docker compose -f docker-compose.qdrant.yml --profile with-arangodb up -d`。需先有 `config/seaweedfs/s3.json`（專案已提供）。若還需要 **DataLake SeaweedFS** 或 **監控**，再分別執行：

```bash
docker compose -f docker-compose.seaweedfs-datalake.yml up -d
docker compose -f docker-compose.monitoring.yml up -d
```

**若出現「container name already in use」**：代表已有同名容器（例如之前用腳本或別次 compose 建的 qdrant、redis、seaweedfs-ai-box-* 等）。可**先移除會衝突的容器（僅刪容器，不刪 volume，資料會保留）**，再執行 compose：

```bash
cd /home/daniel/ai-box
docker stop qdrant redis seaweedfs-ai-box-master seaweedfs-ai-box-volume seaweedfs-ai-box-filer postgres api mcp-server 2>/dev/null
docker rm   qdrant redis seaweedfs-ai-box-master seaweedfs-ai-box-volume seaweedfs-ai-box-filer postgres api mcp-server 2>/dev/null
docker compose -f docker-compose.qdrant.yml up -d
```

上述未包含 `arangodb`（已用 profile 可選）。若你也要讓 compose 管理 ArangoDB，再執行：`docker stop arangodb 2>/dev/null; docker rm arangodb 2>/dev/null`，然後 `docker compose -f docker-compose.qdrant.yml --profile with-arangodb up -d`。

**Redis / SeaweedFS 須由 Docker 啟動**：兩者皆為 Docker 容器服務，腳本會透過 **Docker Compose** 啟動。

- **Redis**：腳本會偵測 `docker-compose` 或 **`docker compose`**（Docker 內建子命令），並用主專案 `docker-compose.yml` 的 redis 服務啟動。若系統只有 `docker compose`（無獨立 `docker-compose` 指令），舊版腳本會失敗；已修正為與 SeaweedFS 相同，先偵測再呼叫對應指令。
- **SeaweedFS**：腳本已使用 `docker compose -f docker-compose.seaweedfs.yml up -d` 等，與 `docker compose` 相容。若 **AI-Box SeaweedFS** 啟動後 Filer 一直重啟，多半是缺少 S3 設定（如 volume 內 `s3.json`），需依 [SeaweedFS 使用指南](./系统设计文档/核心组件/系統管理/SeaweedFS使用指南.md) 補齊後再啟動。

**SeaweedFS 啟動失敗修復（2026-01-29）**：Filer 需讀取 `/etc/seaweedfs/s3.json`，若 volume 為空會崩潰（Restarting 255）。已改為掛載專案內 **`config/seaweedfs/s3.json`**：

- 已建立 `config/seaweedfs/s3.json`（identities: admin / admin123）；
- `docker-compose.seaweedfs.yml` 與 `docker-compose.seaweedfs-datalake.yml` 的 Filer 改為 `./config/seaweedfs:/etc/seaweedfs:ro`，且兩檔皆**未使用** `version`（Docker Compose v2 已棄用）。
- 若仍出現 "the attribute \`version\` is obsolete"：請確認使用的 compose 檔內無 `version: \"3.8\"`；專案內已從 `docker-compose.qdrant.yml`、`docker-compose.prod.yml` 移除該欄位。
  重裝後執行 `docker compose -f docker-compose.seaweedfs.yml up -d` 與 `docker compose -f docker-compose.seaweedfs-datalake.yml up -d` 即可。
  **Orphan 警告**：若出現 "Found orphan containers (...)"，為其他 compose 專案的容器，**不影響本 compose 啟動**；可加 `--remove-orphans` 清理（會移除未在當前 compose 中定義的容器，請確認無需保留再執行），或直接忽略。

**status 與 Docker 端口（2026-01-29）**：`./scripts/start_services.sh status` 依「端口是否在監聽」判斷服務是否運行。在 Linux 下，**Docker 綁定的端口** 用 `lsof` 可能偵測不到，導致腳本誤報「未運行」。已調整 `check_port`：在 lsof 偵測不到時改用 `ss -tln` 或 bash `/dev/tcp` 再檢查一次，Docker 跑的服務（Qdrant、SeaweedFS、Grafana 等）會正確顯示為運行中。若某服務仍顯示 ❌，多為該容器確未啟動（例如狀態為 Created 未 Up），可先執行 `docker ps -a` 確認。

---

## 3. 重裝步驟

### 3.1 階段一：環境與配置

1. **進入專案目錄**

   ```bash
   cd /home/daniel/ai-box
   ```
2. **環境變數**

   - 若有 `env.example` 或 `.env.example`，複製為 `.env` 並依新環境修改。
   - 確認 `AI_BOX_CONFIG_PATH` 指向正確的 `config/config.json`。
   - SeaweedFS 相關變數（可選，見 [開發環境設置指南](./系统设计文档/开发环境设置指南.md)）：
     - `AI_BOX_SEAWEEDFS_S3_ENDPOINT`、`AI_BOX_SEAWEEDFS_S3_ACCESS_KEY`、`AI_BOX_SEAWEEDFS_S3_SECRET_KEY`
     - `DATALAKE_SEAWEEDFS_S3_ENDPOINT` 等（若使用 DataLake）。
3. **Python 虛擬環境**

   ```bash
   python3 -m venv venv
   source venv/bin/activate   # Linux/macOS
   pip install -r requirements.txt   # 或專案指定之依賴檔
   ```
4. **Qdrant 資料目錄**

   ```bash
   mkdir -p data/qdrant
   ```
5. **確認 Docker**

   ```bash
   docker --version
   docker compose version   # 或 docker-compose --version
   docker ps                # 確認 daemon 正常
   ```

### 3.2 階段二：Docker 基礎設施

依下列順序啟動（與 `start_services.sh all` 對齊）。

1. **Redis**

   ```bash
   ./scripts/start_services.sh redis
   ```
2. **ArangoDB**

   ```bash
   ./scripts/start_services.sh arangodb
   ```

   - 若無現有容器，腳本會建立 `arangodb`；密碼可由 `ARANGO_ROOT_PASSWORD` 設定。
3. **Qdrant**

   ```bash
   ./scripts/start_services.sh qdrant
   ```

   - 若無現有容器，腳本會建立並掛載 `./data/qdrant`。

### 3.3 階段三：存儲與監控（可選）

4. **SeaweedFS（AI-Box + DataLake）**

   ```bash
   ./scripts/start_services.sh seaweedfs
   ```

   或分別啟動：

   ```bash
   ./scripts/start_services.sh seaweedfs-ai-box
   ./scripts/start_services.sh seaweedfs-datalake
   ```
5. **SeaweedFS Buckets**

   ```bash
   ./scripts/start_services.sh buckets
   ```

   - 需在 SeaweedFS 已啟動且 `.env` 中已設定對應端點時執行。
6. **監控（可選）**

   ```bash
   ./scripts/start_services.sh monitoring
   ```

### 3.4 階段四：應用服務

7. **FastAPI**

   ```bash
   ./scripts/start_services.sh fastapi
   ```
8. **MCP Server**

   ```bash
   ./scripts/start_services.sh mcp
   ```
9. **Frontend**

   ```bash
   ./scripts/start_services.sh frontend
   ```

   - 需先完成前端依賴安裝（如 `npm install`），依專案說明操作。
10. **RQ Worker**

    ```bash
    ./scripts/start_services.sh worker
    ```
11. **RQ Dashboard**

    ```bash
    ./scripts/start_services.sh dashboard
    ```

### 3.5 階段五：Grafana、Performance 與 Streamlit 儀表板

12. **Grafana 與儀表板**

    - 監控堆疊已於步驟 6 啟動後，Grafana 會透過 `monitoring/grafana/provisioning/` 自動載入資料源與儀表板。
    - 訪問：`http://localhost:3001`（預設帳號 `admin` / `admin`，依 `monitoring/grafana/grafana.ini` 或環境變數）。
    - 儀表板清單（位於 `monitoring/grafana/dashboards/`）：| 儀表板             | 檔案                    | 用途                    |
      | ------------------ | ----------------------- | ----------------------- |
      | 系統概覽           | system-overview.json    | 整體健康與關鍵指標      |
      | 服務狀態           | service-status.json     | 各服務 UP/DOWN 與可用性 |
      | 性能監控           | performance.json        | API 性能、延遲等        |
      | Redis              | redis-dashboard.json    | Redis 指標              |
      | Node Exporter Full | node-exporter-full.json | 主機資源                |
    - 若儀表板無資料：確認 Prometheus 已抓取目標（Redis、Node Exporter 等），並檢查 Grafana 資料源 `Prometheus` 為可用。
13. **Performance 效能測試／腳本**

    - **Grafana 性能儀表板**：已含於上述 Grafana，無需額外安裝。
    - **效能測試腳本**（需依賴與服務已就緒）：
      ```bash
      # ChromaDB 效能測試（若仍使用 ChromaDB）
      python scripts/performance/chromadb_benchmark.py

      # Ollama/LLM 壓測
      python scripts/performance/ollama_benchmark.py
      ```
    - **pytest 效能測試**：
      ```bash
      ./tests/run_performance_tests.sh
      # 或
      pytest tests/performance/ -m "performance" -v
      ```
    - 參考：[PERFORMANCE_VERIFICATION.md](./開發過程文件/performance/PERFORMANCE_VERIFICATION.md)、[阶段4完成报告](./備份與歸檔/系統管理開發歷史/阶段4完成报告.md)。
14. **Streamlit 儀表板（若需安裝）**

    - 專案目前未內建 Streamlit 應用；若日後新增或需在本機跑 Streamlit：
      ```bash
      pip install streamlit
      # 若有儀表板入口，例如：
      # streamlit run path/to/your_app.py --server.port=8501
      ```
    - 預設訪問：`http://localhost:8501`。若專案內有指定路徑（如 `dashboard/streamlit_app.py`），請依專案說明替換上述路徑。

### 3.6 一鍵啟動（可選）

若希望與腳本 `all` 行為一致，可直接：

```bash
./scripts/start_services.sh all
```

順序為：Redis → ArangoDB → Qdrant → SeaweedFS → Buckets → Monitoring → FastAPI → MCP → Frontend → Worker → Dashboard。

### 3.7 以後全部要啟動（每日／開機後）

兩種做法擇一即可。

**做法一：Docker 為主（推薦，與你習慣一致）**

在專案根目錄依序執行：

```bash
cd /home/daniel/ai-box

# 1. 基礎設施與後端（Redis、Qdrant、SeaweedFS、Postgres、API、MCP）
docker compose -f docker-compose.qdrant.yml up -d

# 2. 若需要 DataLake SeaweedFS
docker compose -f docker-compose.seaweedfs-datalake.yml up -d

# 3. 若需要監控（Grafana、Prometheus 等）
docker compose -f docker-compose.monitoring.yml up -d

# 4. 本機進程：前端、RQ Worker、RQ Dashboard（需先啟用 venv）
source venv/bin/activate
./scripts/start_services.sh frontend
./scripts/start_services.sh worker
./scripts/start_services.sh dashboard
```

若出現「container name already in use」，先移除會衝突的容器再執行（見本文「若出現 container name already in use」小節）。

**做法二：腳本一鍵 all**

```bash
cd /home/daniel/ai-box
source venv/bin/activate
./scripts/start_services.sh all
```

會依序啟動 Redis（Docker）、ArangoDB（Docker／腳本）、Qdrant（Docker）、SeaweedFS（Docker）、Buckets、Monitoring、FastAPI、MCP、Frontend、Worker、Dashboard。若已有同名 Docker 容器，可能發生衝突，需先依本文說明處理再執行。

**檢查狀態**

```bash
./scripts/start_services.sh status
# 或
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
```

### 3.8 全部停止

**做法一：Docker 為主（與啟動對應）**

先停本機進程（前端、Worker、Dashboard、FastAPI、MCP），再停 Docker：

```bash
cd /home/daniel/ai-box

# 1. 停止腳本啟動的本機進程（Frontend、Worker、Dashboard、FastAPI、MCP；會跳過 Docker 佔用的端口）
./scripts/start_services.sh stop

# 2. 停止 Docker 堆疊（依你實際有啟動的 compose 執行）
docker compose -f docker-compose.qdrant.yml down
docker compose -f docker-compose.seaweedfs-datalake.yml down
docker compose -f docker-compose.monitoring.yml down
# 若也有用獨立 SeaweedFS compose：
docker compose -f docker-compose.seaweedfs.yml down
```

**做法二：只停腳本管理的本機進程**

```bash
./scripts/start_services.sh stop
```

僅停止由腳本啟動的服務（端口 8000、8002、3000、9181 及 RQ Worker）；**不會**停止 Docker 容器（Redis、Qdrant、ArangoDB、SeaweedFS 等）。若要一併停容器，需手動執行上述 `docker compose ... down`。

**只停 Docker、保留本機進程**

```bash
cd /home/daniel/ai-box
docker compose -f docker-compose.qdrant.yml down
docker compose -f docker-compose.seaweedfs-datalake.yml down
docker compose -f docker-compose.monitoring.yml down
```

`down` 只會停止並移除**該 compose 檔定義的**容器，不刪除 volume，資料會保留。

---

## 4. 驗證與檢查

### 4.1 狀態檢查

```bash
./scripts/start_services.sh status
```

預期會列出各服務端口與運行狀態（含 Worker、Dashboard、SeaweedFS、ArangoDB、Qdrant、Redis、FastAPI、MCP、Frontend、監控等）。

### 4.2 手動驗證要點

- **ArangoDB**: 瀏覽 `http://localhost:8529`，使用設定的 root 密碼登入。
- **Qdrant**: 瀏覽 `http://localhost:6333/dashboard`。
- **Redis**: `redis-cli -p 6379 ping` 應回傳 `PONG`。
- **FastAPI**: `curl http://localhost:8000/api/v1/health`（或專案實際 health 路徑）。
- **SeaweedFS S3**: 端口 8333（AI-Box）、8334（DataLake）可連通。
- **Grafana**: 瀏覽 `http://localhost:3001`，登入後於 Dashboards 檢視系統概覽、服務狀態、性能監控等。
- **Streamlit**（若已安裝）：瀏覽 `http://localhost:8501`。

### 4.3 資料庫與 Schema

- **ArangoDB**：若專案有 Schema 或遷移腳本（例如 `scripts/migration/create_schema.py`），需在首次重裝後執行。
- **Qdrant**：若使用向量集合，需依專案說明建立或遷移 collections。

---

## 5. 注意事項

### 5.1 路徑與 Volume

- `docker-compose.prod.yml` 內若有綁定舊路徑（如 `/Users/daniel/...`），在新環境應改為當前專案路徑（如 `/home/daniel/ai-box/...`）或改用 named volume。
- Qdrant 資料目錄預設為 `./data/qdrant`，請勿刪除以保留向量資料。

### 5.2 Ollama

- 若應用會呼叫 Ollama（如 11434），腳本未包含啟動 Ollama，需在本機或另行以 Docker 啟動。

### 5.3 監控

- 監控為可選；不影響核心業務時可略過 `monitoring` 步驟。

### 5.4 故障排查

- 端口衝突：腳本會嘗試釋放被佔用端口，但會跳過由 Docker 容器佔用的端口。
- 日誌：Docker 容器可用 `docker logs <container_name>`；FastAPI 等可查看專案 `logs/` 目錄。
- 更多部署與故障排查可參考 [文件編輯-Agent-v2-部署指南](./运维文档/文件編輯-Agent-v2-部署指南.md)、[文件編輯-Agent-v2-故障排查](./运维文档/文件編輯-Agent-v2-故障排查.md)。

---

## 6. 重裝檢查清單

| 步驟 | 項目                  | 指令/動作                                                                       | 完成                                                                     |
| ---- | --------------------- | ------------------------------------------------------------------------------- | ------------------------------------------------------------------------ |
| 1    | 專案目錄與 .env       | `cd /home/daniel/ai-box`，配置 .env                                           | ✅ 階段一                                                                |
| 2    | Python venv 與依賴    | `venv` + `pip install -r requirements.txt`（可選 `requirements-dev.txt`） | ✅ 已完成                                                                |
| 3    | data/qdrant 目錄      | `mkdir -p data/qdrant`                                                        | ✅ 階段一                                                                |
| 4    | Redis                 | `./scripts/start_services.sh redis`                                           | ✅ 階段二（或 `docker compose -f docker-compose.yml up -d redis`）     |
| 5    | ArangoDB              | `./scripts/start_services.sh arangodb`                                        | ✅ 階段二                                                                |
| 6    | Qdrant                | `./scripts/start_services.sh qdrant`                                          | ✅ 階段二                                                                |
| 7    | SeaweedFS             | `./scripts/start_services.sh seaweedfs`                                       | ✅ 階段三（AI-Box / DataLake 皆可啟動，需 `config/seaweedfs/s3.json`） |
| 8    | SeaweedFS Buckets     | `./scripts/start_services.sh buckets`                                         | ⏸️ 待 AI-Box S3 就緒                                                   |
| 9    | 監控（可選）          | `./scripts/start_services.sh monitoring`                                      | ✅ 階段三（docker compose -f docker-compose.monitoring.yml up -d）       |
| 10   | FastAPI               | `./scripts/start_services.sh fastapi`                                         | ☐                                                                       |
| 11   | MCP Server            | `./scripts/start_services.sh mcp`                                             | ☐                                                                       |
| 12   | Frontend              | `./scripts/start_services.sh frontend`                                        | ☐                                                                       |
| 13   | RQ Worker             | `./scripts/start_services.sh worker`                                          | ☐                                                                       |
| 14   | RQ Dashboard          | `./scripts/start_services.sh dashboard`                                       | ☐                                                                       |
| 15   | 狀態檢查              | `./scripts/start_services.sh status`                                          | ☐                                                                       |
| 16   | ArangoDB Schema/遷移  | 依專案執行 create_schema 或遷移腳本                                             | ☐                                                                       |
| 17   | Grafana 儀表板        | 訪問 http://localhost:3001，確認 5 個儀表板可開啟且有資料                       | ✅ 階段五（Grafana 已啟動，可手動驗證）                                  |
| 18   | Performance 腳本/測試 | 依需執行 `scripts/performance/*.py` 或 `./tests/run_performance_tests.sh`   | ⏸️ 需完整依賴                                                          |
| 19   | Streamlit（若適用）   | `pip install streamlit`，依專案路徑執行 `streamlit run ...`                 | ⏸️ 專案未內建                                                          |

---

## 7. 部署測試回報

### 階段一：環境與配置（2026-01-29）

| 項目                 | 結果           | 備註                                                                                                                                                                                                       |
| -------------------- | -------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 專案目錄             | ✅             | `/home/daniel/ai-box`                                                                                                                                                                                    |
| .env                 | ✅             | 已存在，內含 `AI_BOX_CONFIG_PATH`                                                                                                                                                                        |
| config/config.json   | ✅             | 已存在                                                                                                                                                                                                     |
| Python venv          | ✅             | 已建立 `venv/`，Python 3.12.3                                                                                                                                                                            |
| 依賴安裝             | ✅             | 已執行 `pip install -r requirements.txt` 與 `pip install -r requirements-dev.txt`；另已安裝 `qdrant-client`、`python-jose[cryptography]`（requirements.txt 未列但 API 需用）。API app 可正常載入。 |
| data/qdrant          | ✅             | 目錄已存在且含既有 collections                                                                                                                                                                             |
| Docker               | ✅             | Docker 28.5.1、Docker Compose v2.40.0，daemon 正常                                                                                                                                                         |
| **階段一測試** | **通過** | 環境與配置可進行下一階段                                                                                                                                                                                   |

**需手動修正**：`.env` 內 `AI_BOX_CONFIG_PATH` 目前為舊路徑 `/Users/daniel/GitHub/AI-Box/config/config.json`，建議改為新環境路徑：`/home/daniel/ai-box/config/config.json`，否則後續 FastAPI 等服務可能讀不到設定。

---

### 階段二：Docker 基礎設施（2026-01-29）

| 項目                 | 結果           | 備註                                                                                                                                                                 |
| -------------------- | -------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Redis                | ✅             | 使用 `docker compose -f docker-compose.yml up -d redis` 啟動（腳本偵測到 docker-compose.yml 時曾失敗，改用手動 compose 成功）。容器 `redis` Up，端口 6379 可連。 |
| ArangoDB             | ✅             | 腳本建立新容器 `arangodb`，端口 8529 可連（API 回 401 為正常需認證）。密碼為 `changeme`，建議設 `ARANGO_ROOT_PASSWORD`。                                       |
| Qdrant               | ✅             | 腳本建立新容器 `qdrant`，掛載 `./data/qdrant`，端口 6333/6334 可連。                                                                                             |
| **階段二測試** | **通過** | Redis、ArangoDB、Qdrant 皆運行中，可進行階段三。                                                                                                                     |

**備註**：Redis 若用腳本 `./scripts/start_services.sh redis` 失敗，可改執行：`docker compose -f docker-compose.yml up -d redis`。

---

### 階段三：存儲與監控（2026-01-29）

| 項目                                              | 結果           | 備註                                                                                                                                                                        |
| ------------------------------------------------- | -------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| SeaweedFS (AI-Box)                                | ✅             | 三容器皆 Up，端口 9333（Master）、8888（Filer）、8333（S3）可連；需有 `config/seaweedfs/s3.json`。                                                                        |
| SeaweedFS (DataLake)                              | ✅             | 三容器皆 Up，端口 8334（S3）、8889（Filer）、9334（Master）可連。                                                                                                           |
| SeaweedFS Buckets                                 | ⏸️           | 未執行（需 AI-Box SeaweedFS S3 就緒且 .env 設定端點）。                                                                                                                     |
| 監控（Prometheus/Grafana/Alertmanager/Exporters） | ✅             | `docker compose -f docker-compose.monitoring.yml up -d` 已執行，aibox-prometheus、aibox-grafana、aibox-alertmanager、aibox-node-exporter、aibox-redis-exporter 皆已啟動。 |
| **階段三測試**                              | **通過** | 監控與兩套 SeaweedFS（AI-Box / DataLake）皆正常；可繼續階段四。                                                                                                             |

---

### 階段四：應用服務（2026-01-29，待完成）

| 項目                                | 結果             | 備註                                                                                                                                                                                                                                                                                             |
| ----------------------------------- | ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| FastAPI                             | ⏸️ 未啟動      | 載入需 `dotenv` 等依賴；專案為 flat layout，`pip install -e .` 不可用。建議：修正 `.env` 的 `AI_BOX_CONFIG_PATH` 為 `/home/daniel/ai-box/config/config.json`，並依專案慣例安裝完整依賴（如使用 `uv sync` 或各子目錄 requirements）後再執行 `./scripts/start_services.sh fastapi`。 |
| MCP / Frontend / Worker / Dashboard | ⏸️ 未啟動      | 依賴 FastAPI 與 Redis 等；完成依賴與 config 後依序執行腳本對應選項。                                                                                                                                                                                                                             |
| **階段四測試**                | **待完成** | 完成階段一「需手動修正」與完整依賴後，再執行階段四並回報。                                                                                                                                                                                                                                       |

---

### 階段五：Grafana / Performance / Streamlit（2026-01-29）

| 項目                   | 結果               | 備註                                                                                                                                                  |
| ---------------------- | ------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------- |
| Grafana                | ✅ 已啟動          | 監控堆疊已於階段三啟動，Grafana 端口 3001；可訪問 http://localhost:3001（預設 admin/admin），儀表板由 `monitoring/grafana/provisioning/` 自動載入。 |
| Performance 儀表板     | ✅ 已含於 Grafana  | 見 Grafana 內「AI-Box 性能監控」等 5 個儀表板。                                                                                                       |
| Performance 腳本／測試 | ⏸️ 未執行        | 依需執行 `scripts/performance/*.py` 或 `./tests/run_performance_tests.sh`（需完整依賴）。                                                         |
| Streamlit              | ⏸️ 未安裝        | 專案目前未內建 Streamlit app；若需使用則 `pip install streamlit` 並依日後 app 路徑啟動。                                                            |
| **階段五測試**   | **部分通過** | Grafana 與儀表板已就緒；Performance 腳本與 Streamlit 依需再執行。                                                                                     |

docker start seaweedfs-ai-box-filer arangodb api



---

**最後更新日期**: 2026-01-29
**維護人**: Daniel Chung
