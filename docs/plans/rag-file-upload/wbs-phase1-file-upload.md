# WBS-階段一：文件選擇與上傳功能

**文檔功能說明**: 文件上傳功能實施工作分解結構
**創建日期**: 2025-01-27
**創建人**: Daniel Chung
**最後修改日期**: 2025-01-27

## 1. 工作分解結構

### 1.1 前端開發 (3-4天)

#### 1.1.1 文件選擇UI組件 (1天)
- [x] **任務 1.1.1.1**: 創建 FileUploadModal 組件
  - 位置: `ai-bot/src/components/FileUploadModal.tsx`
  - 功能: 文件選擇對話框
  - 依賴: 無
  - 預計時間: 4小時

- [x] **任務 1.1.1.2**: 實現文件拖拽上傳
  - 功能: 支持拖拽文件到對話框
  - 預計時間: 2小時

- [x] **任務 1.1.1.3**: 實現文件類型驗證（前端）
  - 支持格式: PDF, DOCX, TXT, MD, CSV, XLSX
  - 預計時間: 2小時

- [x] **任務 1.1.1.4**: 實現文件大小限制提示
  - 最大文件大小: 50MB
  - 預計時間: 1小時

#### 1.1.2 回紋針按鈕功能集成 (0.5天)
- [x] **任務 1.1.2.1**: 修改 ChatInput 組件
  - 位置: `ai-bot/src/components/ChatInput.tsx`
  - 功能: 為回紋針按鈕添加點擊事件
  - 預計時間: 1小時

- [x] **任務 1.1.2.2**: 實現文件選擇觸發
  - 功能: 點擊回紋針打開文件選擇對話框
  - 預計時間: 1小時

- [x] **任務 1.1.2.3**: 實現多文件選擇
  - 功能: 支持一次選擇多個文件
  - 預計時間: 2小時

#### 1.1.3 文件上傳進度顯示 (1天)
- [x] **任務 1.1.3.1**: 創建上傳進度組件
  - 位置: `ai-bot/src/components/UploadProgress.tsx`
  - 功能: 顯示上傳進度條
  - 預計時間: 3小時

- [x] **任務 1.1.3.2**: 實現上傳狀態管理
  - 狀態: 等待、上傳中、完成、失敗
  - 預計時間: 2小時

- [x] **任務 1.1.3.3**: 實現上傳進度實時更新
  - 使用 WebSocket 或輪詢獲取進度
  - 預計時間: 3小時

#### 1.1.4 API 集成 (0.5天)
- [x] **任務 1.1.4.1**: 創建文件上傳 API 客戶端
  - 位置: `ai-bot/src/lib/api.ts`
  - 功能: 封裝文件上傳請求
  - 預計時間: 2小時

- [x] **任務 1.1.4.2**: 實現文件上傳錯誤處理
  - 處理網絡錯誤、文件大小超限等
  - 預計時間: 2小時

### 1.2 後端整合 (1-2天)

#### 1.2.1 文件上傳API整合 (0.5天)
- [x] **任務 1.2.1.1**: 檢查現有文件上傳API
  - 位置: `api/routers/file_upload.py`
  - 功能: 確認API端點和參數
  - 預計時間: 1小時

- [x] **任務 1.2.1.2**: 添加CORS支持（如需要）
  - 確保前端可以調用API
  - 預計時間: 1小時

- [x] **任務 1.2.1.3**: 實現文件上傳進度追蹤
  - 使用 Redis 或內存存儲進度
  - 預計時間: 2小時

#### 1.2.2 文件驗證增強 (0.5天)
- [x] **任務 1.2.2.1**: 增強文件類型驗證
  - 支持更多文件格式
  - 預計時間: 2小時

- [x] **任務 1.2.2.2**: 實現文件內容驗證
  - 檢查文件是否損壞
  - 預計時間: 2小時

#### 1.2.3 異步處理觸發 (0.5天)
- [x] **任務 1.2.3.1**: 創建文件處理觸發器
  - 位置: `api/routers/file_upload.py`
  - 功能: 上傳完成後觸發異步處理
  - 預計時間: 2小時


#### 1.2.4 安全驗證增強 (1天)
- [ ] **任務 1.2.4.1**: 實現文件內容掃描
  - 位置: `services/api/services/file_scanner.py`
  - 功能: 病毒掃描、惡意代碼檢測
  - 預計時間: 4小時

- [ ] **任務 1.2.4.2**: 實現文件名清理和驗證
  - 功能: 移除路徑遍歷字符、特殊字符驗證
  - 預計時間: 2小時

- [ ] **任務 1.2.4.3**: 實現文件大小和數量限制
  - 功能: 用戶級別和全局限制
  - 預計時間: 2小時

- [ ] **任務 1.2.4.4**: 實現權限驗證中間件
  - 功能: 驗證用戶上傳權限
  - 預計時間: 2小時
- [x] **任務 1.2.3.2**: 實現處理狀態API
  - 提供查詢處理狀態的端點
  - 預計時間: 2小時

## 2. 技術規格

### 2.1 前端技術棧
- React + TypeScript
- Tailwind CSS (樣式)
- Axios (HTTP請求)

### 2.2 後端技術棧
- FastAPI
- 現有文件存儲服務
- Redis (進度追蹤，可選)

### 2.3 API 端點

#### 文件上傳
```
POST /api/files/upload
Content-Type: multipart/form-data

Request:
- files: File[] (多文件)
- user_id: string (可選)

Response:
{
  "success": true,
  "data": {
    "uploaded": [
      {
        "file_id": "uuid",
        "filename": "example.pdf",
        "file_type": "application/pdf",
        "file_size": 1024000,
        "file_path": "/path/to/file"
      }
    ],
    "errors": [],
    "total": 1,
    "success_count": 1,
    "error_count": 0
  }
}
```

#### 上傳進度查詢
```
GET /api/files/upload/{file_id}/progress

Response:
{
  "success": true,
  "data": {
    "file_id": "uuid",
    "status": "uploading|completed|failed",
    "progress": 75,
    "message": "上傳中..."
  }
}
```

## 3. 驗收標準

### 3.1 功能驗收
- ✅ 用戶可以點擊回紋針按鈕打開文件選擇對話框
- ✅ 支持拖拽文件上傳
- ✅ 支持多文件選擇和上傳
- ✅ 顯示上傳進度
- ✅ 上傳完成後顯示成功/失敗狀態
- ✅ 文件類型驗證正確
- ✅ 文件大小限制生效

### 3.2 性能驗收
- 文件選擇對話框打開時間 < 100ms
- 小文件（< 1MB）上傳響應時間 < 2秒
- 大文件（10MB）上傳進度更新頻率 > 1次/秒

### 3.3 兼容性驗收
- 支持 Chrome, Firefox, Safari, Edge
- 支持移動端瀏覽器（響應式設計）

## 4. 測試計劃

### 4.1 單元測試
- FileUploadModal 組件測試
- 文件驗證邏輯測試
- API 客戶端測試

### 4.2 集成測試
- 文件上傳端到端測試
- 多文件上傳測試
- 錯誤處理測試

### 4.3 手動測試
- 不同文件格式測試
- 大文件上傳測試
- 網絡中斷恢復測試

## 5. 依賴關係

### 5.1 前置任務
- 無（階段一為起始階段）

### 5.2 後續任務
- 階段二A：需要文件上傳完成後觸發
- 階段二B：需要文件ID和元數據

## 6. 風險與緩解

### 6.1 技術風險
- **風險**: 大文件上傳可能導致瀏覽器內存問題
- **緩解**: 實現分片上傳，限制單次上傳文件大小

- **風險**: 並發上傳可能導致服務器負載過高
- **緩解**: 實現上傳隊列，限制並發數量

### 6.2 業務風險
- **風險**: 用戶上傳惡意文件
- **緩解**: 實現文件類型驗證和內容掃描

## 7. 交付物

- [x] FileUploadModal 組件
- [x] UploadProgress 組件
- [x] 修改後的 ChatInput 組件
- [x] 文件上傳 API 客戶端
- [x] 上傳進度追蹤功能
- [ ] 單元測試代碼
- [ ] 集成測試代碼
- [ ] 技術文檔

## 8. 時間估算

| 任務 | 預計時間 | 實際時間 | 狀態 |
|------|---------|---------|------|
| 文件選擇UI組件 | 1天 | - | ⏸️ 待開始 |
| 回紋針按鈕集成 | 0.5天 | - | ⏸️ 待開始 |
| 上傳進度顯示 | 1天 | - | ⏸️ 待開始 |
| API集成 | 0.5天 | - | ⏸️ 待開始 |
| 後端整合 | 2-3天 |
| 文件上傳後自動掛載 | 0.5天 | - | ⏸️ 待開始 |
| **總計** | **3-4天** | - | - |

## 9. 更新日誌

| 日期 | 版本 | 更新內容 | 更新人 |
|------|------|---------|--------|
| 2025-01-27 | 1.0 | 初始版本創建 | Daniel Chung |

### 1.3 文件上傳後自動掛載到文件區 (0.5天)

#### 1.3.1 上傳完成後處理 (0.3天)
- [ ] **任務 1.3.1.1**: 修改文件上傳API響應
  - 位置: `api/routers/file_upload.py`
  - 功能: 返回文件元數據，包含user_id和task_id
  - 預計時間: 1小時

- [ ] **任務 1.3.1.2**: 實現文件自動掛載邏輯
  - 位置: `ai-bot/src/components/FileUploadModal.tsx`
  - 功能: 上傳完成後自動添加到當前任務的文件列表
  - 預計時間: 2小時

#### 1.3.2 文件列表更新 (0.2天)
- [ ] **任務 1.3.2.1**: 實現文件列表自動刷新
  - 位置: `ai-bot/src/components/ResultPanel.tsx`
  - 功能: 上傳後自動更新ResultPanel中的文件樹
  - 預計時間: 1小時

- [ ] **任務 1.3.2.2**: 實現文件狀態顯示
  - 功能: 在文件列表中顯示上傳和處理狀態
  - 預計時間: 1小時
