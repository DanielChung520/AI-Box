# WBS-階段二B：知識圖譜提取與標簽化

**文檔功能說明**: 知識圖譜提取與標簽化處理實施工作分解結構
**創建日期**: 2025-01-27
**創建人**: Daniel Chung
**最後修改日期**: 2025-01-27

## 1. 工作分解結構

### 1.1 NER服務集成 (2-3天)

#### 1.1.1 NER服務調用 (1天)

- [x] **任務 1.1.1.1**: 檢查現有NER服務
  - 位置: `genai/api/services/ner_service.py`
  - 功能: 確認API接口和功能
  - 預計時間: 2小時

- [ ] **任務 1.1.1.2**: 實現批量NER提取
  - 功能: 對文件chunk進行批量命名實體識別
  - 預計時間: 4小時

- [ ] **任務 1.1.1.3**: 實現實體去重和合併
  - 功能: 合併相同實體的不同提及
  - 預計時間: 3小時

- [ ] **任務 1.1.1.4**: 實現實體置信度評分
  - 功能: 評估實體識別的可信度
  - 預計時間: 3小時

#### 1.1.2 實體標準化 (1-2天)

- [ ] **任務 1.1.2.1**: 實現實體類型映射
  - 功能: 將不同模型的實體類型映射到標準類型
  - 預計時間: 4小時

- [ ] **任務 1.1.2.2**: 實現實體鏈接（Entity Linking）
  - 功能: 將實體鏈接到知識庫（可選）
  - 預計時間: 6小時

- [ ] **任務 1.1.2.3**: 實現實體屬性提取
  - 功能: 提取實體的額外屬性（如日期、位置等）
  - 預計時間: 4小時

### 1.2 RE服務集成 (2-3天)

#### 1.2.1 RE服務調用 (1天)

- [x] **任務 1.2.1.1**: 檢查現有RE服務
  - 位置: `genai/api/services/re_service.py`
  - 功能: 確認API接口和功能
  - 預計時間: 2小時

- [ ] **任務 1.2.1.2**: 實現關係抽取
  - 功能: 從文本中提取實體間的關係
  - 預計時間: 6小時

- [ ] **任務 1.2.1.3**: 實現關係類型分類
  - 功能: 識別關係類型（如"屬於"、"位於"等）
  - 預計時間: 4小時

#### 1.2.2 關係驗證和過濾 (1-2天)

- [ ] **任務 1.2.2.1**: 實現關係置信度評分
  - 功能: 評估關係抽取的可信度
  - 預計時間: 4小時

- [ ] **任務 1.2.2.2**: 實現關係過濾
  - 功能: 過濾低置信度的關係
  - 預計時間: 2小時

- [ ] **任務 1.2.2.3**: 實現關係去重
  - 功能: 合併重複的關係
  - 預計時間: 3小時

### 1.3 RT服務集成 (2-3天)

#### 1.3.1 RT服務調用 (1天)

- [x] **任務 1.3.1.1**: 檢查現有RT服務
  - 位置: `genai/api/services/rt_service.py`
  - 功能: 確認API接口和功能
  - 預計時間: 2小時

- [ ] **任務 1.3.1.2**: 實現三元組提取
  - 功能: 提取(主體, 關係, 客體)三元組
  - 預計時間: 6小時

- [ ] **任務 1.3.1.3**: 實現三元組驗證
  - 功能: 驗證三元組的完整性和正確性
  - 預計時間: 4小時

#### 1.3.2 三元組標準化 (1-2天)

- [ ] **任務 1.3.2.1**: 實現三元組格式標準化
  - 功能: 統一三元組表示格式
  - 預計時間: 3小時

- [ ] **任務 1.3.2.2**: 實現三元組去重
  - 功能: 合併重複的三元組
  - 預計時間: 3小時

- [ ] **任務 1.3.2.3**: 實現三元組質量評分
  - 功能: 評估三元組質量
  - 預計時間: 4小時

### 1.4 知識圖譜構建 (3-4天)

#### 1.4.1 圖譜數據模型設計 (1天)

- [x] **任務 1.4.1.1**: 設計節點（Node）模型
  - 實體類型、屬性、標簽等
  - 預計時間: 3小時

- [x] **任務 1.4.1.2**: 設計邊（Edge）模型
  - 關係類型、權重、屬性等
  - 預計時間: 3小時

- [x] **任務 1.4.1.3**: 設計圖譜元數據
  - 文件ID、提取時間、版本等
  - 預計時間: 2小時

#### 1.4.2 圖譜構建邏輯 (1-2天)

- [x] **任務 1.4.2.1**: 實現節點創建
  - 從NER結果創建實體節點
  - 預計時間: 4小時

- [x] **任務 1.4.2.2**: 實現邊創建
  - 從RE/RT結果創建關係邊
  - 預計時間: 4小時

- [x] **任務 1.4.2.3**: 實現圖譜合併
  - 合併同一文件的不同chunk的圖譜
  - 預計時間: 6小時

#### 1.4.3 標簽化處理 (1天)

- [ ] **任務 1.4.3.1**: 實現實體標簽生成
  - 根據實體類型和屬性生成標簽
  - 預計時間: 4小時

- [ ] **任務 1.4.3.2**: 實現關係標簽生成
  - 根據關係類型生成標簽
  - 預計時間: 3小時

- [ ] **任務 1.4.3.3**: 實現標簽層次結構
  - 支持多層級標簽（如：人物 > 員工 > 經理）
  - 預計時間: 3小時

### 1.5 ArangoDB存儲 (2-3天)

#### 1.5.1 ArangoDB集成 (1天)

- [x] **任務 1.5.1.1**: 檢查現有ArangoDB客戶端
  - 位置: `database/arangodb/`
  - 功能: 確認連接和操作接口
  - 預計時間: 2小時

- [x] **任務 1.5.1.2**: 設計圖譜集合結構
  - 節點集合、邊集合設計
  - 預計時間: 3小時

- [x] **任務 1.5.1.3**: 實現圖譜存儲邏輯
  - 批量插入節點和邊
  - 預計時間: 5小時

#### 1.5.2 圖譜查詢優化 (1-2天)

- [x] **任務 1.5.2.1**: 實現圖譜查詢接口
  - 根據實體查詢、根據關係查詢等
  - 預計時間: 6小時

- [ ] **任務 1.5.2.2**: 實現索引優化
  - 為常用查詢字段創建索引
  - 預計時間: 3小時

- [ ] **任務 1.5.2.3**: 實現圖譜可視化數據接口
  - 提供前端可視化所需的數據格式
  - 預計時間: 3小時

### 1.6 偏見檢測集成 (1-2天)

#### 1.6.1 偏見檢測實現 (1天)

- [ ] **任務 1.6.1.1**: 實現基礎偏見檢測
  - 位置: `services/api/services/bias_detection_service.py`
  - 功能: 檢測NER/RE/RT結果中的偏見
  - 預計時間: 4小時

- [ ] **任務 1.6.1.2**: 集成到知識圖譜構建流程
  - 功能: 在圖譜構建後進行偏見檢測
  - 預計時間: 2小時

- [ ] **任務 1.6.1.3**: 實現偏見標記
  - 功能: 標記可能偏見的結果
  - 預計時間: 2小時

#### 1.6.2 偏見報告 (0.5天)

- [ ] **任務 1.6.2.1**: 實現偏見報告生成
  - 功能: 生成偏見檢測報告
  - 預計時間: 2小時

- [ ] **任務 1.6.2.2**: 實現偏見數據導出
  - 功能: 導出偏見檢測結果
  - 預計時間: 2小時

## 2. 技術規格

### 2.1 NER配置

- **實體類型**: PERSON, ORG, LOC, DATE, MONEY, PRODUCT, EVENT等
- **批量大小**: 10-20 chunks/批次
- **置信度閾值**: 0.7

### 2.2 RE配置

- **關係類型**: 自定義關係類型集合
- **批量大小**: 10-20 chunks/批次
- **置信度閾值**: 0.6

### 2.3 RT配置

- **三元組格式**: (subject, relation, object)
- **批量大小**: 10-20 chunks/批次
- **質量閾值**: 0.65

### 2.4 ArangoDB配置

- **圖名稱**: `kg_{file_id}` 或 `kg_{user_id}`
- **節點集合**: `entities_{file_id}`
- **邊集合**: `relations_{file_id}`
- **索引**:
  - 實體類型索引
  - 關係類型索引
  - 標簽索引

### 2.5 API端點

#### 觸發圖譜提取

```
POST /api/files/{file_id}/extract-kg

Response:
{
  "success": true,
  "data": {
    "file_id": "uuid",
    "task_id": "task_uuid",
    "status": "processing"
  }
}
```

#### 查詢提取狀態

```
GET /api/files/{file_id}/kg/status

Response:
{
  "success": true,
  "data": {
    "file_id": "uuid",
    "status": "processing|completed|failed",
    "progress": {
      "ner": 100,
      "re": 80,
      "rt": 60,
      "graph_build": 40
    },
    "entities_count": 150,
    "relations_count": 200,
    "triples_count": 180
  }
}
```

#### 查詢圖譜

```
GET /api/files/{file_id}/kg

Query Parameters:
- entity_type: 實體類型（可選）
- relation_type: 關係類型（可選）
- limit: 返回數量限制

Response:
{
  "success": true,
  "data": {
    "nodes": [...],
    "edges": [...],
    "metadata": {...}
  }
}
```

## 3. 驗收標準

### 3.1 功能驗收

- ✅ NER成功識別實體
- ✅ RE成功提取關係
- ✅ RT成功提取三元組
- ✅ 知識圖譜成功構建
- ✅ 標簽成功生成
- ✅ 圖譜成功存儲到ArangoDB
- ✅ 可以從ArangoDB查詢圖譜

### 3.2 性能驗收

- NER處理時間 < chunk數量 × 0.2秒/chunk
- RE處理時間 < chunk數量 × 0.3秒/chunk
- RT處理時間 < chunk數量 × 0.25秒/chunk
- 圖譜構建時間 < 實體數量 × 0.01秒/實體
- 存儲時間 < 節點數量 × 0.05秒/節點

### 3.3 質量驗收

- 實體識別準確率 > 85%
- 關係抽取準確率 > 80%
- 三元組提取準確率 > 75%
- 圖譜完整性 > 90%

## 4. 測試計劃

### 4.1 單元測試

- NER服務調用測試
- RE服務調用測試
- RT服務調用測試
- 圖譜構建邏輯測試
- 標簽生成測試
- ArangoDB存儲測試

### 4.2 集成測試

- 端到端圖譜提取測試
- 多文件圖譜合併測試
- 圖譜查詢測試

### 4.3 質量測試

- 實體識別準確率測試
- 關係抽取準確率測試
- 三元組質量測試

## 5. 依賴關係

### 5.1 前置任務

- 階段一：文件上傳功能完成（需要文件ID）

### 5.2 後續任務

- 階段三：需要圖譜數據進行整合測試

### 5.3 外部依賴

- NER服務可用
- RE服務可用
- RT服務可用
- ArangoDB數據庫運行正常

## 6. 風險與緩解

### 6.1 技術風險

- **風險**: NER/RE/RT服務不穩定
- **緩解**: 實現重試機制、降級策略、錯誤處理

- **風險**: 大文件圖譜構建耗時過長
- **緩解**: 實現異步處理、進度追蹤、批量優化

- **風險**: ArangoDB存儲失敗
- **緩解**: 實現重試、事務處理、數據驗證

### 6.2 質量風險

- **風險**: 實體/關係識別準確率低
- **緩解**: 實現多模型投票、置信度過濾、人工審核接口

## 7. 交付物

- [ ] NER服務集成
- [ ] RE服務集成
- [ ] RT服務集成
- [x] 知識圖譜構建邏輯
- [ ] 標簽化處理邏輯
- [x] ArangoDB存儲集成
- [x] 圖譜查詢API
- [x] 處理狀態API
- [ ] 單元測試代碼
- [ ] 集成測試代碼
- [ ] 技術文檔

## 8. 時間估算

| 任務 | 預計時間 | 實際時間 | 狀態 |
|------|---------|---------|------|
| NER服務集成 | 2-3天 | - | ⏸️ 待開始 |
| RE服務集成 | 2-3天 | - | ⏸️ 待開始 |
| RT服務集成 | 2-3天 | - | ⏸️ 待開始 |
| 知識圖譜構建 | 3-4天 | - | ⏸️ 待開始 |
| ArangoDB存儲 | 2-3天 |
| 偏見檢測集成 | 1-2天 | - | ⏸️ 待開始 |
| **總計** | **12-18天** | | - | - |

## 9. 更新日誌

| 日期 | 版本 | 更新內容 | 更新人 |
|------|------|---------|--------|
| 2025-01-27 | 1.0 | 初始版本創建 | Daniel Chung |
