# WBS-階段四：文件管理系統

**文檔功能說明**: 文件管理系統實施工作分解結構
**創建日期**: 2025-01-27
**創建人**: Daniel Chung
**最後修改日期**: 2025-12-06

## 1. 工作分解結構

### 1.1 後端文件目錄結構管理 (2-3天)

#### 1.1.1 目錄結構設計 (0.5天)

- [x] **任務 1.1.1.1**: 設計文件存儲目錄結構
  - 位置: `storage/file_storage.py`
  - 結構: `files/{user_id}/{task_id}/{file_id}.{ext}`
  - 預計時間: 2小時

- [x] **任務 1.1.1.2**: 實現目錄創建邏輯
  - 功能: 自動創建用戶和任務目錄
  - 預計時間: 2小時

- [ ] **任務 1.1.1.3**: 實現目錄權限管理
  - 功能: 確保用戶只能訪問自己的文件
  - 預計時間: 2小時

#### 1.1.2 文件存儲服務增強 (1天)

- [x] **任務 1.1.2.1**: 修改文件存儲邏輯
  - 位置: `storage/file_storage.py`
  - 功能: 按用戶ID和任務ID組織文件
  - 預計時間: 4小時

- [x] **任務 1.1.2.2**: 實現文件路徑生成
  - 功能: 根據用戶ID、任務ID生成文件路徑
  - 預計時間: 3小時

- [ ] **任務 1.1.2.3**: 實現文件移動和重命名
  - 功能: 支持文件在不同任務間移動
  - 預計時間: 3小時

#### 1.1.3 文件元數據管理 (1-2天)

- [x] **任務 1.1.3.1**: 擴展文件元數據模型
  - 位置: `services/api/models/file_metadata.py`
  - 新增字段: user_id, task_id, directory_path
  - 預計時間: 2小時

- [x] **任務 1.1.3.2**: 實現文件元數據API
  - 位置: `api/routers/file_metadata.py`
  - 功能: 查詢、更新文件元數據
  - 預計時間: 4小時

- [x] **任務 1.1.3.3**: 實現文件列表查詢API
  - 功能: 按用戶ID、任務ID查詢文件列表
  - 預計時間: 4小時

- [x] **任務 1.1.3.4**: 實現文件搜索API
  - 功能: 支持按文件名、類型、日期搜索
  - 預計時間: 4小時

### 1.2 前端文件管理組件 (2-3天)

#### 1.2.1 文件列表組件 (1天)

- [x] **任務 1.2.1.1**: 創建 FileManager 組件
  - 位置: `ai-bot/src/components/FileManager.tsx`
  - 功能: 顯示文件列表，支持按任務分組
  - 預計時間: 4小時

- [x] **任務 1.2.1.2**: 實現文件樹視圖
  - 功能: 樹形結構顯示文件目錄
  - 預計時間: 3小時

- [x] **任務 1.2.1.3**: 實現文件列表視圖
  - 功能: 表格形式顯示文件信息
  - 預計時間: 3小時

#### 1.2.2 文件操作功能 (1天)

- [x] **任務 1.2.2.1**: 實現文件下載功能
  - 功能: 下載文件到本地
  - 預計時間: 2小時

- [x] **任務 1.2.2.2**: 實現文件預覽功能
  - 功能: 在線預覽文件（PDF、圖片等）
  - 預計時間: 4小時

- [ ] **任務 1.2.2.3**: 實現文件刪除功能
  - 功能: 刪除文件（需要確認）
  - 預計時間: 2小時

#### 1.2.3 文件搜索和過濾 (0.5天)

- [x] **任務 1.2.3.1**: 實現文件搜索組件
  - 功能: 按文件名、類型搜索
  - 預計時間: 2小時

- [x] **任務 1.2.3.2**: 實現文件過濾功能
  - 功能: 按任務、日期、類型過濾
  - 預計時間: 2小時

### 1.3 文件上傳後自動掛載 (1天)

#### 1.3.1 上傳完成後處理 (0.5天)

- [x] **任務 1.3.1.1**: 修改文件上傳API響應
  - 位置: `api/routers/file_upload.py`
  - 功能: 返回文件元數據和路徑信息
  - 預計時間: 2小時

- [x] **任務 1.3.1.2**: 實現文件掛載邏輯
  - 位置: `ai-bot/src/components/FileUploadModal.tsx`
  - 功能: 上傳完成後自動添加到文件列表
  - 預計時間: 3小時

#### 1.3.2 文件列表同步 (0.5天)

- [x] **任務 1.3.2.1**: 實現文件列表自動刷新
  - 功能: 上傳後自動更新文件列表
  - 預計時間: 2小時

- [ ] **任務 1.3.2.2**: 實現文件狀態同步
  - 功能: 實時顯示文件處理狀態
  - 預計時間: 2小時

### 1.4 文件管理區集成 (1天)

#### 1.4.1 側邊欄集成 (0.5天)

- [x] **任務 1.4.1.1**: 在側邊欄添加文件管理入口
  - 位置: `ai-bot/src/components/Sidebar.tsx`
  - 功能: 添加"文件管理"菜單項
  - 預計時間: 2小時

- [x] **任務 1.4.1.2**: 實現文件管理頁面路由
  - 位置: `ai-bot/src/pages/FileManagement.tsx`
  - 功能: 文件管理主頁面
  - 預計時間: 2小時

#### 1.4.2 ResultPanel 集成 (0.5天)

- [ ] **任務 1.4.2.1**: 增強 ResultPanel 文件顯示
  - 位置: `ai-bot/src/components/ResultPanel.tsx`
  - 功能: 顯示當前任務的文件列表
  - 預計時間: 3小時

- [ ] **任務 1.4.2.2**: 實現文件拖拽功能
  - 功能: 支持拖拽文件到任務
  - 預計時間: 1小時

## 2. 技術規格

### 2.1 目錄結構

```
storage/
  files/
    {user_id}/
      {task_id}/
        {file_id}.{ext}
        metadata.json (可選)
```

**示例**:

```
storage/files/
  user_123/
    task_456/
      file_789.pdf
      file_790.docx
    task_457/
      file_791.txt
  user_124/
    task_458/
      file_792.pdf
```

### 2.2 文件元數據模型

```typescript
interface FileMetadata {
  file_id: string;
  filename: string;
  file_type: string;
  file_size: number;
  user_id: string;
  task_id: string;
  directory_path: string;
  upload_time: string;
  last_modified: string;
  status: 'uploaded' | 'processing' | 'completed' | 'failed';
  chunk_count?: number;
  vector_count?: number;
  kg_extracted?: boolean;
}
```

### 2.3 API 端點

#### 獲取文件列表

```
GET /api/files?user_id={user_id}&task_id={task_id}

Query Parameters:
- user_id: 用戶ID（必需）
- task_id: 任務ID（可選，不提供則返回所有任務的文件）
- page: 頁碼（可選）
- limit: 每頁數量（可選）

Response:
{
  "success": true,
  "data": {
    "files": [
      {
        "file_id": "uuid",
        "filename": "example.pdf",
        "file_type": "application/pdf",
        "file_size": 1024000,
        "task_id": "task_uuid",
        "upload_time": "2025-01-27T10:00:00Z",
        "status": "completed"
      }
    ],
    "total": 10,
    "page": 1,
    "limit": 20
  }
}
```

#### 獲取文件樹結構

```
GET /api/files/tree?user_id={user_id}

Response:
{
  "success": true,
  "data": {
    "tree": [
      {
        "task_id": "task_uuid",
        "task_name": "任務名稱",
        "files": [
          {
            "file_id": "uuid",
            "filename": "example.pdf",
            "file_type": "application/pdf",
            "file_size": 1024000
          }
        ]
      }
    ]
  }
}
```

#### 搜索文件

```
GET /api/files/search?user_id={user_id}&query={keyword}&file_type={type}

Response:
{
  "success": true,
  "data": {
    "files": [...],
    "total": 5
  }
}
```

#### 下載文件

```
GET /api/files/{file_id}/download

Response: 文件流
```

#### 刪除文件

```
DELETE /api/files/{file_id}

Response:
{
  "success": true,
  "message": "文件刪除成功"
}
```

### 2.4 前端組件結構

```
FileManager/
  ├── FileManager.tsx (主組件)
  ├── FileList.tsx (文件列表)
  ├── FileTree.tsx (文件樹)
  ├── FileItem.tsx (文件項)
  ├── FileSearch.tsx (搜索組件)
  └── FileActions.tsx (操作按鈕)
```

## 3. 驗收標準

### 3.1 功能驗收

- ✅ 文件按用戶ID和任務ID正確組織存儲
- ✅ 文件上傳後自動顯示在文件列表中
- ✅ 可以按任務查看文件列表
- ✅ 可以搜索和過濾文件
- ✅ 可以下載和預覽文件
- ✅ 文件刪除功能正常
- ✅ 文件狀態實時更新

### 3.2 性能驗收

- 文件列表加載時間 < 1秒（100個文件以內）
- 文件搜索響應時間 < 500ms
- 文件下載速度 > 10MB/s（本地網絡）

### 3.3 安全驗收

- ✅ 用戶只能訪問自己的文件
- ✅ 文件路徑驗證，防止路徑遍歷攻擊
- ✅ 文件下載需要權限驗證

## 4. 測試計劃

### 4.1 單元測試

- 目錄結構創建測試
- 文件路徑生成測試
- 文件元數據管理測試
- 文件列表查詢測試

### 4.2 集成測試

- 文件上傳後自動掛載測試
- 文件列表顯示測試
- 文件搜索功能測試
- 文件下載功能測試

### 4.3 安全測試

- 權限驗證測試
- 路徑遍歷攻擊測試
- 跨用戶訪問測試

## 5. 依賴關係

### 5.1 前置任務

- 階段一：文件上傳功能完成
- 需要用戶認證系統（獲取user_id）

### 5.2 後續任務

- 階段三：需要文件管理功能進行整合測試

## 6. 風險與緩解

### 6.1 技術風險

- **風險**: 大量文件導致目錄結構複雜
- **緩解**: 實現文件索引，優化查詢性能

- **風險**: 文件存儲空間不足
- **緩解**: 實現文件大小限制，定期清理舊文件

### 6.2 安全風險

- **風險**: 用戶訪問其他用戶的文件
- **緩解**: 嚴格驗證用戶ID，實現權限檢查

## 7. 交付物

- [x] 文件目錄結構管理服務
- [x] 文件元數據管理API
- [x] 文件列表查詢API
- [x] FileManager 組件
- [x] 文件上傳後自動掛載功能
- [x] 文件搜索和過濾功能
- [x] 文件下載和預覽功能
- [ ] 單元測試代碼
- [ ] 集成測試代碼
- [ ] 技術文檔

## 8. 時間估算

| 任務 | 預計時間 | 實際時間 | 狀態 |
|------|---------|---------|------|
| 後端文件目錄結構管理 | 2-3天 | 2025-12-06 | ✅ 已完成 |
| 前端文件管理組件 | 2-3天 | 2025-12-06 | ✅ 已完成 |
| 文件上傳後自動掛載 | 1天 | 2025-12-06 | ✅ 已完成 |
| 文件管理區集成 | 1天 | 2025-12-06 | ✅ 已完成 |
| **總計** | **4-6天** | 2025-12-06 | ✅ 已完成 |

## 9. 更新日誌

| 日期 | 版本 | 更新內容 | 更新人 |
|------|------|---------|--------|
| 2025-01-27 | 1.0 | 初始版本創建 | Daniel Chung |
