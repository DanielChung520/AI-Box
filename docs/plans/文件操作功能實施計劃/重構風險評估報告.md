
# 文件操作功能重構風險評估報告

**創建日期**: 2025-01-27
**創建人**: Daniel Chung
**最後修改日期**: 2025-01-27

## 執行摘要

經過深入分析現有代碼結構和依賴關係，發現**原計劃中的大規模重構存在較高風險**，可能導致現有功能崩潰。

**建議採用保守的「零風險新增」方案**，在現有文件中新增功能，不進行大規模重構。

---

## 一、現有代碼結構分析

### 1.1 現有路由文件

- `api/routers/file_upload.py` - 文件上傳功能（已實現）
- `api/routers/file_management.py` - 文件管理功能（已實現）

### 1.2 現有服務層

- `services/api/services/file_metadata_service.py` - 文件元數據服務（已實現）
- `storage/file_storage.py` - 文件存儲抽象（已實現）
- `services/api/services/vector_store_service.py` - 向量存儲服務（已實現）
- `services/api/services/kg_extraction_service.py` - 圖譜提取服務（已實現）

### 1.3 現有API端點

**file_upload.py**:
- POST `/api/v1/files/upload` - 文件上傳
- DELETE `/api/v1/files/upload/{file_id}` - 文件刪除

**file_management.py**:
- GET `/api/v1/files` - 文件列表
- GET `/api/v1/files/search` - 文件搜尋
- GET `/api/v1/files/tree` - 文件樹
- GET `/api/v1/files/{file_id}/download` - 文件下載
- GET `/api/v1/files/{file_id}/preview` - 文件預覽

### 1.4 依賴關係

- `file_upload.py` 和 `file_management.py` 都依賴：
  - `FileMetadataService`
  - `FileStorage`
  - `VectorStoreService`
  - `KGExtractionService`
  - `FilePermissionService`

- 這些服務被多個路由文件使用，重構會影響多個模塊

---

## 二、重構風險評估

### 2.1 高風險操作

#### 風險1：移動現有路由文件
- **風險等級**: 🔴 高
- **影響範圍**: 所有引用該路由的地方
- **可能後果**:
  - `api/main.py` 中的 `include_router` 需要更新
  - 其他模塊的導入路徑需要更新
  - 可能導致應用無法啟動

#### 風險2：重構服務層目錄結構
- **風險等級**: 🔴 高
- **影響範圍**: 所有使用該服務的路由
- **可能後果**:
  - 多個路由文件的導入需要更新
  - 可能導致循環導入問題
  - 服務初始化可能失敗

#### 風險3：修改現有API路徑
- **風險等級**: 🔴 高
- **影響範圍**: 前端所有API調用
- **可能後果**:
  - 前端功能完全崩潰
  - 需要更新所有前端API調用
  - 可能影響生產環境

### 2.2 中風險操作

#### 風險4：拆分大文件
- **風險等級**: 🟡 中
- **影響範圍**: 需要更新導入路徑
- **可能後果**: 需要全局搜索替換，容易遺漏

#### 風險5：重命名函數或類
- **風險等級**: 🟡 中
- **影響範圍**: 所有調用處
- **可能後果**: 需要全局搜索替換，容易遺漏

### 2.3 低風險操作

#### 風險6：在現有文件中新增功能
- **風險等級**: 🟢 低
- **影響範圍**: 無
- **可能後果**: 不影響現有功能

#### 風險7：新增獨立的API路由文件
- **風險等級**: 🟢 低
- **影響範圍**: 無
- **可能後果**: 不影響現有功能

---

## 三、推薦方案：零風險新增

### 3.1 實施原則

1. ✅ **不移動現有文件** - 保持所有現有文件位置不變
2. ✅ **不修改現有代碼** - 只在現有文件中新增功能
3. ✅ **不改變現有API路徑** - 新增功能使用新路徑
4. ✅ **重用現有服務** - 直接使用現有服務，不重構

### 3.2 具體實施步驟

#### 步驟1：在 `file_management.py` 中新增文件操作API

```python
# 在 api/routers/file_management.py 中新增

@router.put("/{file_id}/rename")
async def rename_file(
    file_id: str,
    new_name: str,
    current_user: User = Depends(get_current_user),
) -> JSONResponse:
    """重命名文件"""
    # 重用現有的 get_metadata_service() 和 get_storage()
    service = get_metadata_service()
    storage = get_storage()
    # 實現重命名邏輯
    pass

@router.post("/{file_id}/copy")
async def copy_file(
    file_id: str,
    target_task_id: Optional[str] = None,
    current_user: User = Depends(get_current_user),
) -> JSONResponse:
    """複製文件"""
    # 重用現有的服務
    pass

@router.put("/{file_id}/move")
async def move_file(
    file_id: str,
    target_task_id: str,
    current_user: User = Depends(get_current_user),
) -> JSONResponse:
    """移動文件"""
    # 重用現有的服務
    pass
```

#### 步驟2：在 `file_management.py` 中新增資料夾操作API

```python
@router.post("/folders")
async def create_folder(
    folder_name: str,
    parent_task_id: Optional[str] = None,
    current_user: User = Depends(get_current_user),
) -> JSONResponse:
    """創建資料夾（實際上是創建任務）"""
    pass

@router.put("/folders/{folder_id}")
async def rename_folder(
    folder_id: str,
    new_name: str,
    current_user: User = Depends(get_current_user),
) -> JSONResponse:
    """重命名資料夾（實際上是更新任務名稱）"""
    pass

@router.delete("/folders/{folder_id}")
async def delete_folder(
    folder_id: str,
    current_user: User = Depends(get_current_user),
) -> JSONResponse:
    """刪除資料夾（級聯刪除文件和相關數據）"""
    # 重用現有的 delete_file 邏輯
    pass
```

#### 步驟3：前端實現獨立功能

- 剪貼板狀態管理（localStorage）
- 批量選擇（前端 state）
- 文件樹狀態（前端緩存）
- 聚焦狀態（前端 state）

### 3.3 優點

- ✅ **零風險** - 不影響現有功能
- ✅ **不需要更新導入路徑** - 所有導入保持不變
- ✅ **不需要更新前端調用** - 現有API路徑不變
- ✅ **重用現有服務** - 直接使用現有服務和工具函數
- ✅ **代碼集中** - 相關功能在同一文件中，易於維護
- ✅ **易於測試** - 新增功能可以獨立測試

### 3.4 工作量估算

- 文件重命名API: 1 天
- 文件複製API: 2 天
- 文件移動API: 1 天
- 資料夾創建API: 1 天
- 資料夾重命名API: 1 天
- 資料夾刪除API: 2 天（級聯刪除）
- 前端剪貼板和批量選擇: 2 天
- 測試和文檔: 2 天

**總計**: 約 12 天（2.4 週）

**相比原計劃的 45 天，減少約 73%**

---

## 四、未來優化方案（可選，低風險）

如果未來確實需要重構，建議採用漸進式遷移：

### 4.1 創建新目錄結構（不移動現有文件）

```bash
mkdir -p api/routers/file_operations
mkdir -p services/api/services/file_operations
```

### 4.2 在新目錄中創建新文件（不刪除舊文件）

- 新功能寫在新文件中
- 舊功能保持在原文件

### 4.3 使用別名導入（向後兼容）

```python
# 在新文件中
from api.routers.file_upload import router as file_upload_router
from api.routers.file_management import router as file_management_router

# 在 main.py 中保持原有導入
from api.routers import file_upload, file_management
```

### 4.4 逐步遷移（可選）

- 只有當新功能穩定後，才考慮遷移舊功能
- 遷移時保持舊路徑的別名導入，確保向後兼容

---

## 五、風險對比

| 方案 | 風險等級 | 工作量 | 影響範圍 | 推薦度 |
|------|---------|--------|----------|--------|
| 原計劃（大規模重構） | 🔴 高 | 45 天 | 全系統 | ❌ 不推薦 |
| 零風險新增方案 | 🟢 低 | 12 天 | 無 | ✅ 強烈推薦 |
| 漸進式遷移方案 | 🟡 中 | 20 天 | 可控 | ⚠️ 可選 |

---

## 六、結論與建議

### 6.1 立即實施（推薦）

採用「零風險新增」方案：
1. ✅ 在 `file_management.py` 中新增文件操作API
2. ✅ 在 `file_management.py` 中新增資料夾操作API
3. ✅ 前端實現剪貼板和批量選擇功能

### 6.2 避免的操作

1. ❌ 移動現有路由文件
2. ❌ 重構現有服務層
3. ❌ 修改現有API路徑
4. ❌ 重命名現有函數或類

### 6.3 後續優化（可選）

如果未來確實需要重構，採用漸進式遷移方案，確保風險可控。

---

## 七、測試建議

### 7.1 回歸測試

實施前後都需要進行完整的回歸測試：
- ✅ 文件上傳功能
- ✅ 文件列表查詢
- ✅ 文件搜尋功能
- ✅ 文件下載功能
- ✅ 文件預覽功能
- ✅ 文件刪除功能

### 7.2 新功能測試

新增功能需要獨立測試：
- ✅ 文件重命名
- ✅ 文件複製
- ✅ 文件移動
- ✅ 資料夾操作

### 7.3 集成測試

確保新功能與現有功能的集成：
- ✅ 新API與現有服務的集成
- ✅ 前端與新API的集成
- ✅ 權限檢查的正確性

---

## 更新日誌

### 2025-01-27
- ✅ 創建風險評估報告
- ✅ 分析現有代碼結構和依賴關係
- ✅ 提出零風險新增方案
- ✅ 制定測試建議
