# WBS計劃 - 階段四：批量操作功能（S4）

**創建日期**: 2025-01-27
**創建人**: Daniel Chung
**最後修改日期**: 2025-01-27

## 階段概述

**目標**: 實現批量文件操作
**工作量**: 4 天（原3天 + 新增1天）
**優先級**: P1
**依賴**: S1, S2, S3

**更新說明**（2025-01-27）：
- 根據《文件操作功能檢核報告》補充批量下載功能（S4.4）

---

## 任務分解

### S4.1 前端批量操作實現（2 天）

**任務描述**: 實現前端批量操作功能（循環調用單個API）

**實施位置**: `ai-bot/src/lib/api.ts`（已實現）

**功能**:
- 批量重命名
- 批量複製
- 批量移動
- 批量刪除

**實現步驟**:
1. [x] 在 `api.ts` 中實現批量操作函數（已完成）
2. [x] 實現批量重命名（循環調用 `rename` API）（已完成）
3. [x] 實現批量複製（循環調用 `copy` API）（已完成）
4. [x] 實現批量移動（循環調用 `move` API）（已完成）
5. [x] 實現批量刪除（循環調用 `delete` API）（已完成）
6. [x] 實現進度追蹤（已完成）
7. [x] 實現錯誤處理和重試機制（已完成）
8. [x] 實現操作結果匯總（已完成）

**驗收標準**:
- [x] 批量重命名功能正常（已完成）
- [x] 批量複製功能正常（已完成）
- [x] 批量移動功能正常（已完成）
- [x] 批量刪除功能正常（已完成）
- [x] 進度追蹤正常（已完成）
- [x] 錯誤處理完善（已完成）
- [x] 操作結果正確匯總（已完成）

---

### S4.2 批量操作UI組件（1 天）

**任務描述**: 實現批量操作UI組件

**實施位置**: `ai-bot/src/components/file-operations/BatchOperations/`（新建）或直接在現有組件中實現

**功能**:
- 批量操作工具欄
- 批量操作進度顯示
- 批量操作結果顯示

**實現步驟**:
1. [x] 實現批量操作API函數（batchRenameFiles等）（已完成）
2. [ ] 創建 `BatchOperationBar.tsx` 組件（可選）
3. [ ] 創建 `BatchProgress.tsx` 組件（可選）
4. [ ] 創建 `BatchResults.tsx` 組件（可選）
5. [ ] 實現批量操作工具欄UI
6. [ ] 實現進度顯示UI
7. [ ] 實現結果顯示UI
8. [ ] 集成到文件樹組件

**驗收標準**:
- [x] 批量操作API函數正常（已完成）
- [ ] 批量操作工具欄正常顯示（可選）
- [ ] 進度顯示正常（可選）
- [ ] 結果顯示正常（可選）
- [ ] UI交互流暢

---

### S4.3 後端批量API（可選，P2優先級）（0 天）

**任務描述**: 實現後端批量API（優化性能，可選）

**實施位置**: `api/routers/file_management.py`

**API設計**:
- **端點**: `POST /api/v1/files/batch`
- **請求體**:
```json
{
  "operations": [
    {"type": "rename", "file_id": "...", "new_name": "..."},
    {"type": "copy", "file_id": "...", "target_task_id": "..."},
    ...
  ]
}
```

**實現步驟**:
1. [ ] 在 `file_management.py` 中新增 `batch_operations` 函數
2. [ ] 實現批量操作處理邏輯
3. [ ] 實現事務處理（確保原子性）
4. [ ] 實現錯誤處理和部分成功處理
5. [ ] 返回每個操作的結果

**優先級**: P2（可選，如果性能需要）

**驗收標準**:
- [ ] 批量API可以成功處理多個操作
- [ ] 事務處理正確
- [ ] 錯誤處理完善
- [ ] 部分成功處理正確

---

### S4.4 批量下載功能（1 天 - 新增）

**任務描述**: 實現批量下載選中的文件

**實施位置**:
- 後端：`api/routers/file_management.py`（如果需要新API）
- 前端：`ai-bot/src/lib/api.ts`

**功能描述**:
- 批量下載選中的文件
- 支持打包下載（ZIP格式）
- 顯示下載進度

**API設計**（如果需要新API）:
- **端點**: `POST /api/v1/files/batch/download`
- **請求體**: `{"file_ids": ["file_id1", "file_id2", ...]}`
- **響應**: ZIP文件流或下載鏈接

**實現步驟**:
1. [ ] 確認使用現有下載功能或新增批量下載API
2. [ ] 如果新增API，在 `file_management.py` 中實現批量下載端點
3. [ ] 實現文件打包邏輯（ZIP格式）
4. [ ] 在 `api.ts` 中實現批量下載函數
5. [ ] 實現下載進度追蹤
6. [ ] 實現前端下載觸發（點擊下載按鈕）
7. [ ] 實現錯誤處理

**下載方式選擇**:
- **方式一**：後端打包ZIP，前端下載ZIP文件（推薦，適合大量文件）
- **方式二**：前端循環調用單個下載API（簡單，但可能較慢）

**驗收標準**:
- [ ] 批量下載功能正常
- [ ] 文件打包正確（ZIP格式）
- [ ] 下載進度顯示正常
- [ ] 錯誤處理完善
- [ ] 下載的文件完整且正確

---

## 階段交付物

- ✅ 前端批量操作實現完成
- ✅ 批量操作UI組件實現完成（可選）
- ✅ 批量下載功能實現完成
- ✅ 單元測試完成
- ✅ 集成測試完成

---

## 測試要求

### 單元測試
- [ ] 測試批量重命名功能
- [ ] 測試批量複製功能
- [ ] 測試批量移動功能
- [ ] 測試批量刪除功能
- [ ] 測試批量下載功能
- [ ] 測試進度追蹤
- [ ] 測試錯誤處理

### 集成測試
- [ ] 測試與文件樹組件的集成
- [ ] 測試與API的集成
- [ ] 測試UI交互
- [ ] 測試批量下載（ZIP打包）

---

## 注意事項

- ✅ **優先使用前端循環調用單個API的方式**
- ✅ **後端批量API是可選的，優先級P2**
- ✅ **確保錯誤處理和進度追蹤完善**
- ✅ **批量下載建議使用ZIP打包方式**（適合大量文件）
