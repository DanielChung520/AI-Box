# WBS計劃 - 階段二：資料夾操作功能（S2）

**創建日期**: 2025-01-27
**創建人**: Daniel Chung
**最後修改日期**: 2025-01-27

## 階段概述

**目標**: 實現資料夾的基本操作（創建、重命名、刪除、新增檔案）
**工作量**: 5 天（原4天 + 新增1天）
**優先級**: P0
**依賴**: S1

**更新說明**（2025-01-27）：
- 根據《文件操作功能檢核報告》補充新增檔案功能（S2.4）
- 補充數據驗證規則（S2.5）

---

## 任務分解

### S2.1 創建資料夾功能（1 天）

**任務描述**: 實現創建資料夾API

**實施位置**: `api/routers/file_management.py`

**API設計**:
- **端點**: `POST /api/v1/files/folders`
- **請求體**: `{"folder_name": "資料夾名稱", "parent_task_id": "父任務ID（可選）"}`
- **響應**: 新任務的信息

**數據驗證規則**:
- 資料夾名稱長度不超過255字符
- 不能包含特殊字符：`/ \ : * ? " < > |`
- 同一父資料夾下不能有重名的資料夾

**實現步驟**:
1. [ ] 在 `file_management.py` 中新增 `create_folder` 函數
2. [ ] 實現資料夾名稱驗證（使用數據驗證規則）
3. [ ] 實現任務創建邏輯（資料夾實際上是任務）
4. [ ] 實現父任務關聯（如果提供 `parent_task_id`）
5. [ ] 實現唯一性檢查（同一父資料夾下不能有重名）
6. [ ] 添加錯誤處理和日誌記錄
7. [ ] 添加審計日誌

**注意**: 資料夾在系統中實際上是任務（task），所以創建資料夾就是創建任務。

**驗收標準**:
- [ ] API可以成功創建資料夾
- [ ] 資料夾名稱驗證正確（符合驗證規則）
- [ ] 任務記錄正確創建
- [ ] 父任務關聯正確（如果提供）
- [ ] 唯一性檢查正確
- [ ] 錯誤處理完善
- [ ] 現有功能不受影響

---

### S2.2 重命名資料夾功能（1 天）

**任務描述**: 實現重命名資料夾API

**實施位置**: `api/routers/file_management.py`

**API設計**:
- **端點**: `PUT /api/v1/files/folders/{folder_id}`
- **請求體**: `{"new_name": "新資料夾名稱"}`
- **響應**: 更新後的任務信息

**數據驗證規則**:
- 資料夾名稱長度不超過255字符
- 不能包含特殊字符：`/ \ : * ? " < > |`
- 同一父資料夾下不能有重名的資料夾

**實現步驟**:
1. [ ] 在 `file_management.py` 中新增 `rename_folder` 函數
2. [ ] 實現資料夾存在性檢查
3. [ ] 實現資料夾名稱驗證（使用數據驗證規則）
4. [ ] 實現唯一性檢查（同一父資料夾下不能有重名）
5. [ ] 實現任務名稱更新
6. [ ] 添加錯誤處理和日誌記錄
7. [ ] 添加審計日誌

**重用服務**:
- `get_metadata_service()` - 文件元數據服務（用於更新任務名稱）

**驗收標準**:
- [ ] API可以成功重命名資料夾
- [ ] 資料夾名稱驗證正確（符合驗證規則）
- [ ] 唯一性檢查正確
- [ ] 錯誤處理完善
- [ ] 現有功能不受影響

---

### S2.3 刪除資料夾功能（1 天）

**任務描述**: 實現刪除資料夾API（級聯刪除）

**實施位置**: `api/routers/file_management.py`

**API設計**:
- **端點**: `DELETE /api/v1/files/folders/{folder_id}`
- **響應**: 刪除結果

**級聯刪除邏輯**:
1. 獲取該任務下的所有文件
2. 對每個文件調用刪除邏輯（重用 `file_upload.py` 中的 `delete_file`）
3. 刪除任務記錄

**實現步驟**:
1. [ ] 在 `file_management.py` 中新增 `delete_folder` 函數
2. [ ] 實現資料夾存在性檢查
3. [ ] 實現權限檢查
4. [ ] 獲取該任務下的所有文件
5. [ ] 對每個文件調用刪除邏輯（重用 `file_upload.py` 中的 `delete_file`）
6. [ ] 刪除任務記錄
7. [ ] 實現事務處理（確保原子性）
8. [ ] 添加錯誤處理和日誌記錄
9. [ ] 添加審計日誌

**重用邏輯**:
- 重用 `file_upload.py` 中的 `delete_file` 函數邏輯

**驗收標準**:
- [ ] API可以成功刪除資料夾
- [ ] 級聯刪除正確（所有文件都被刪除）
- [ ] 事務處理正確（原子性保證）
- [ ] 權限檢查正確
- [ ] 錯誤處理完善
- [ ] 現有功能不受影響

---

### S2.4 新增檔案功能（1 天 - 新增）

**任務描述**: 確認並實現新增檔案功能

**實施位置**:
- 後端：`api/routers/file_management.py`（如果需要新API）
- 前端：`ai-bot/src/components/FileTree.tsx`（右鍵選單）
- 前端：`ai-bot/src/components/Sidebar.tsx`（Header工具欄）

**功能描述**:
- 在資料夾右鍵選單中：上傳新文件到當前資料夾
- 在Header工具欄中：根據當前聚焦狀態決定上傳位置

**實施方式確認**:
1. [ ] 確認是否使用現有上傳功能（`file_upload.py`）
2. [ ] 如果需要特定功能，新增API端點
3. [ ] 實現前端右鍵選單觸發上傳
4. [ ] 實現Header工具欄觸發上傳
5. [ ] 實現聚焦狀態判斷（根據當前聚焦的資料夾決定上傳位置）

**API設計**（如果需要新API）:
- **端點**: `POST /api/v1/files/upload`（可能重用現有上傳API）
- **請求體**: 文件上傳表單數據
- **響應**: 上傳結果

**實現步驟**:
1. [ ] 確認使用現有上傳功能或新增API
2. [ ] 在 `FileTree.tsx` 中實現右鍵選單「新增檔案」功能
3. [ ] 在 `Sidebar.tsx` 中實現Header工具欄「新增檔案」功能
4. [ ] 實現聚焦狀態判斷邏輯
5. [ ] 打開文件上傳對話框
6. [ ] 上傳後自動進行處理（分塊、向量化、KG提取）
7. [ ] 上傳成功後更新文件樹顯示

**驗收標準**:
- [ ] 右鍵選單「新增檔案」功能正常
- [ ] Header工具欄「新增檔案」功能正常
- [ ] 聚焦狀態判斷正確
- [ ] 文件上傳成功
- [ ] 文件處理正常（分塊、向量化、KG提取）
- [ ] 文件樹更新正確

---

### S2.5 數據驗證規則（資料夾）（0.5 天 - 新增）

**任務描述**: 實現資料夾相關的數據驗證規則

**實施位置**: `api/routers/file_management.py` 或 `api/utils/file_validator.py`

**驗證規則**:

1. **資料夾名稱規則**:
   - 長度限制：不超過255個字符
   - 字符限制：不能包含 `/ \ : * ? " < > |`
   - 唯一性：同一父資料夾下不能有重名的資料夾

**實現步驟**:
1. [ ] 在 `file_validator.py` 中實現 `validate_folder_name()` 函數（或直接在 `file_management.py` 中實現）
2. [ ] 實現長度驗證
3. [ ] 實現字符驗證
4. [ ] 實現唯一性檢查（查詢同一父資料夾下的其他資料夾）
5. [ ] 在創建、重命名資料夾操作中應用驗證規則
6. [ ] 添加錯誤提示（驗證失敗時返回友好的錯誤信息）

**驗收標準**:
- [ ] 資料夾名稱驗證正確
- [ ] 唯一性檢查正確
- [ ] 驗證失敗時返回友好的錯誤信息
- [ ] 所有資料夾操作都應用驗證規則

---

## 階段交付物

- ✅ 創建資料夾API實現完成
- ✅ 重命名資料夾API實現完成
- ✅ 刪除資料夾API實現完成（級聯刪除）
- ✅ 新增檔案功能實現完成
- ✅ 數據驗證規則實現完成
- ✅ 單元測試完成
- ✅ 集成測試完成
- ✅ API文檔更新完成

---

## 測試要求

### 單元測試
- [ ] 測試創建資料夾功能
- [ ] 測試重命名資料夾功能
- [ ] 測試刪除資料夾功能（級聯刪除）
- [ ] 測試新增檔案功能
- [ ] 測試數據驗證規則
- [ ] 測試錯誤處理

### 集成測試
- [ ] 測試與現有服務的集成
- [ ] 測試權限檢查
- [ ] 測試審計日誌
- [ ] 測試級聯刪除（刪除資料夾時所有文件都被刪除）

### 回歸測試
- [ ] 測試現有文件上傳功能
- [ ] 測試現有文件列表查詢
- [ ] 測試現有文件搜尋功能

---

## 注意事項

- ⚠️ **禁止移動現有文件**
- ⚠️ **禁止修改現有代碼**（只新增）
- ⚠️ **禁止改變現有API路徑**
- ✅ **重用現有服務和函數**
- ✅ **新增功能使用新API路徑**
- ✅ **刪除資料夾時必須級聯刪除所有文件**（包括多數據源清理）
- ✅ **所有資料夾操作都必須應用數據驗證規則**
