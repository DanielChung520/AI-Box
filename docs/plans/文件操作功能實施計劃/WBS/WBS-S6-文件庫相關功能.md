# WBS計劃 - 階段六：文件庫相關功能（S6 - 新增）

**創建日期**: 2025-01-27
**創建人**: Daniel Chung
**最後修改日期**: 2025-01-27

## 階段概述

**目標**: 實現Header工具欄「其他選項」功能
**工作量**: 4 天
**優先級**: P2（低優先級）
**依賴**: S1, S2

**更新說明**（2025-01-27）：
- 根據《文件操作功能檢核報告》新增文件庫相關功能階段

---

## 任務分解

### S6.1 從文件庫上傳功能（1 天）

**任務描述**: 實現從文件庫選擇文件上傳到當前任務

**實施位置**:
- 後端：`api/routers/file_management.py`
- 前端：`ai-bot/src/components/Sidebar.tsx`（Header工具欄）

**API設計**:
- **端點**: `POST /api/v1/files/library/upload`
- **請求體**: `{"file_ids": ["file_id1", "file_id2", ...], "target_task_id": "目標任務ID"}`
- **響應**: 上傳結果

**功能描述**:
- 從文件庫選擇文件
- 上傳選中的文件到當前任務
- 保持文件元數據和關聯關係

**實現步驟**:
1. [ ] 在 `file_management.py` 中新增 `upload_from_library` 函數
2. [ ] 實現文件庫查詢邏輯（查詢不在任務中的文件）
3. [ ] 實現文件複製邏輯（重用 `copy_file` 函數）
4. [ ] 實現目標任務關聯
5. [ ] 在前端實現文件庫選擇對話框
6. [ ] 在Header工具欄「其他選項」中添加入口
7. [ ] 實現上傳進度顯示
8. [ ] 添加錯誤處理

**重用服務**:
- `get_metadata_service()` - 文件元數據服務
- `copy_file()` - 文件複製功能（重用S1.2）

**驗收標準**:
- [ ] 可以從文件庫選擇文件
- [ ] 文件成功上傳到當前任務
- [ ] 文件元數據正確
- [ ] 上傳進度顯示正常
- [ ] 錯誤處理完善

---

### S6.2 傳回文件庫功能（1 天）

**任務描述**: 實現將當前任務的文件傳回文件庫

**實施位置**:
- 後端：`api/routers/file_management.py`
- 前端：`ai-bot/src/components/Sidebar.tsx`（Header工具欄）

**API設計**:
- **端點**: `POST /api/v1/files/library/return`
- **請求體**: `{"file_ids": ["file_id1", "file_id2", ...]}`
- **響應**: 傳回結果

**功能描述**:
- 將當前任務的文件傳回文件庫
- 從任務中移除文件關聯
- 保持文件在文件庫中

**實現步驟**:
1. [ ] 在 `file_management.py` 中新增 `return_to_library` 函數
2. [ ] 實現文件從任務中移除邏輯（更新 `task_id` 為空或特殊值）
3. [ ] 實現文件庫標記邏輯
4. [ ] 在前端實現確認對話框
5. [ ] 在Header工具欄「其他選項」中添加入口
6. [ ] 實現操作進度顯示
7. [ ] 添加錯誤處理

**重用服務**:
- `get_metadata_service()` - 文件元數據服務

**驗收標準**:
- [ ] 可以將文件傳回文件庫
- [ ] 文件從任務中正確移除
- [ ] 文件在文件庫中正確標記
- [ ] 操作進度顯示正常
- [ ] 錯誤處理完善

---

### S6.3 同步文件功能（1 天）

**任務描述**: 實現同步文件狀態和元數據

**實施位置**:
- 後端：`api/routers/file_management.py`
- 前端：`ai-bot/src/components/Sidebar.tsx`（Header工具欄）

**API設計**:
- **端點**: `POST /api/v1/files/sync`
- **請求體**: `{"task_id": "任務ID（可選）"}` 或 `{"file_ids": ["file_id1", ...]}`
- **響應**: 同步結果

**功能描述**:
- 同步文件狀態（處理狀態、向量化狀態等）
- 同步文件元數據
- 檢查文件完整性

**實現步驟**:
1. [ ] 在 `file_management.py` 中新增 `sync_files` 函數
2. [ ] 實現文件狀態檢查邏輯
3. [ ] 實現文件元數據同步邏輯
4. [ ] 實現文件完整性檢查
5. [ ] 在前端實現同步按鈕
6. [ ] 在Header工具欄「其他選項」中添加入口
7. [ ] 實現同步進度顯示
8. [ ] 實現同步結果顯示
9. [ ] 添加錯誤處理

**重用服務**:
- `get_metadata_service()` - 文件元數據服務
- `get_vector_store_service()` - 向量存儲服務（檢查向量狀態）
- `get_kg_extraction_service()` - 圖譜提取服務（檢查圖譜狀態）

**驗收標準**:
- [ ] 文件狀態同步正確
- [ ] 文件元數據同步正確
- [ ] 文件完整性檢查正確
- [ ] 同步進度顯示正常
- [ ] 同步結果顯示正確
- [ ] 錯誤處理完善

---

### S6.4 搜尋文件庫功能（1 天）

**任務描述**: 實現在文件庫中搜尋文件

**實施位置**:
- 後端：`api/routers/file_management.py`
- 前端：`ai-bot/src/components/Sidebar.tsx`（Header工具欄）

**API設計**:
- **端點**: `GET /api/v1/files/library/search`
- **查詢參數**: `?query=搜尋關鍵詞&page=1&limit=20`
- **響應**: 搜尋結果列表

**功能描述**:
- 在文件庫中搜尋文件
- 支持按文件名、內容搜尋
- 顯示搜尋結果列表

**實現步驟**:
1. [ ] 在 `file_management.py` 中新增 `search_library` 函數
2. [ ] 實現文件庫文件查詢邏輯
3. [ ] 實現文件名搜尋邏輯
4. [ ] 實現文件內容搜尋邏輯（可選，使用向量搜尋）
5. [ ] 在前端實現搜尋對話框
6. [ ] 在Header工具欄「其他選項」中添加入口
7. [ ] 實現搜尋結果列表顯示
8. [ ] 實現搜尋結果選擇和操作
9. [ ] 添加錯誤處理

**重用服務**:
- `get_metadata_service()` - 文件元數據服務
- `get_vector_store_service()` - 向量存儲服務（內容搜尋）

**驗收標準**:
- [ ] 可以搜尋文件庫
- [ ] 文件名搜尋正確
- [ ] 文件內容搜尋正確（如果實現）
- [ ] 搜尋結果列表顯示正常
- [ ] 搜尋結果選擇和操作正常
- [ ] 錯誤處理完善

---

## 階段交付物

- ✅ 從文件庫上傳功能實現完成
- ✅ 傳回文件庫功能實現完成
- ✅ 同步文件功能實現完成
- ✅ 搜尋文件庫功能實現完成
- ✅ 單元測試完成
- ✅ 集成測試完成
- ✅ API文檔更新完成

---

## 測試要求

### 單元測試
- [ ] 測試從文件庫上傳功能
- [ ] 測試傳回文件庫功能
- [ ] 測試同步文件功能
- [ ] 測試搜尋文件庫功能
- [ ] 測試錯誤處理

### 集成測試
- [ ] 測試與文件庫的集成
- [ ] 測試與任務的集成
- [ ] 測試與Header工具欄的集成
- [ ] 測試UI交互

---

## 注意事項

- ⚠️ **禁止移動現有文件**
- ⚠️ **禁止修改現有代碼**（只新增）
- ⚠️ **禁止改變現有API路徑**
- ✅ **重用現有服務和函數**
- ✅ **新增功能使用新API路徑**
- ✅ **文件庫功能為低優先級（P2），可根據實際需求調整實施順序**
