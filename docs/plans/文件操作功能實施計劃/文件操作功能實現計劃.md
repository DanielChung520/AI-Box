# 文件操作功能實現計劃（保守方案 - 更新版）

**創建日期**: 2025-12-07
**創建人**: Daniel Chung
**最後修改日期**: 2025-12-07

---

## 開發規範

### 1. 代碼修改規範

**重要**：修改代碼前，請務必參照開發規則文件：

- 📋 **開發規則文件**: `@AI-Box/.cursor/rules/develop-rule.mdc`

請嚴格遵守以下原則：

- ✅ 遵循代碼風格規範
- ✅ 遵循類型注解規範
- ✅ 遵循防禦性編程規範
- ✅ 遵循代碼結構規範
- ✅ 遵循 Git 提交前檢查規範

### 2. 進度更新規範

**重要**：每個 WBS 開發完成後，必須更新本文件的進度管制表：

1. **更新進度百分比**：根據實際完成情況更新進度
2. **更新狀態**：更新為「✅ 已完成」或「🔄 進行中」
3. **填寫修改概要**：簡要說明本次修改的內容
4. **填寫狀態備註**：記錄重要信息、問題或注意事項
5. **更新最後修改日期**：更新文件頭部的「最後修改日期」

### 3. 保守方案原則（必須遵守）

- ⚠️ **禁止移動現有文件**
- ⚠️ **禁止修改現有代碼**（只新增）
- ⚠️ **禁止改變現有API路徑**
- ✅ **重用現有服務和函數**
- ✅ **新增功能使用新API路徑**

---

## 實現計劃進度管制表

| 階段         | WBS編號 | WBS任務             | 修改概要 | 進度 | 狀態        | 備註           |
| ------------ | ------- | ------------------- | -------- | ---- | ----------- | -------------- |
| **S0** | S0.1    | 開發環境準備        | 確認開發環境配置、代碼審查流程、測試環境 | 100%   | ✅ 已完成 | -              |
|              | S0.2    | 文檔準備            | 閱讀現有代碼結構、API文檔，準備開發檢查清單 | 100%   | ✅ 已完成 | -              |
|              | S0.3    | 風險評估確認        | 確認保守方案原則和禁止操作清單 | 100%   | ✅ 已完成 | -              |
| **S1** | S1.1    | 文件重命名功能      | 新增 PUT /api/v1/files/{file_id}/rename API | 100%   | ✅ 已完成 | -              |
|              | S1.2    | 文件複製功能        | 新增 POST /api/v1/files/{file_id}/copy API | 100%   | ✅ 已完成 | -              |
|              | S1.3    | 文件移動功能        | 新增 PUT /api/v1/files/{file_id}/move API | 100%   | ✅ 已完成 | -              |
|              | S1.4    | 文件刪除功能        | 新增 DELETE /api/v1/files/{file_id} API，多數據源清理 | 100%   | ✅ 已完成 | 已實現多數據源清理（文件系統、ArangoDB、ChromaDB、知識圖譜） |
|              | S1.5    | 複製路徑功能        | 前端實現複製文件路徑到剪貼板 | 100%   | ✅ 已完成 | 已實現文件路徑和資料夾路徑複製，包含成功提示和錯誤處理 |
|              | S1.6    | 數據驗證規則（文件） | 實現文件名、大小、類型驗證規則 | 100%   | ✅ 已完成 | 已在重命名操作中應用 FileValidator，驗證文件名長度、特殊字符、保留名稱、擴展名 |
| **S2** | S2.1    | 創建資料夾功能      | 新增 POST /api/v1/files/folders API，創建資料夾元數據集合 | 100%   | ✅ 已完成 | -              |
|              | S2.2    | 重命名資料夾功能    | 新增 PUT /api/v1/files/folders/{folder_id} API | 100%   | ✅ 已完成 | -              |
|              | S2.3    | 刪除資料夾功能      | 新增 DELETE /api/v1/files/folders/{folder_id} API，級聯刪除 | 100%   | ✅ 已完成 | -              |
|              | S2.4    | 新增檔案功能        | 確認使用現有上傳功能或新增特定功能 | 100%   | ✅ 已完成 | 已重用現有 FileUploadModal 組件，實現右鍵選單和Header工具欄的「新增檔案」功能 |
|              | S2.5    | 數據驗證規則（資料夾） | 實現資料夾名稱驗證規則 | 100%   | ✅ 已完成 | 已在創建和重命名資料夾中應用驗證規則，包含唯一性檢查 |
| **S3** | S3.1    | 剪貼板狀態管理      | 創建 fileOperationState.ts，實現 localStorage 剪貼板管理 | 100%   | ✅ 已完成 | -              |
|              | S3.2    | 批量選擇功能        | 實現 useBatchSelection Hook | 100%   | ✅ 已完成 | -              |
|              | S3.3    | 文件樹狀態緩存      | 實現文件樹緩存功能（localStorage） | 100%   | ✅ 已完成 | -              |
|              | S3.4    | 聚焦狀態管理        | 實現 useFocusState Hook | 100%   | ✅ 已完成 | -              |
|              | S3.5    | 複製路徑前端實現    | 實現複製路徑到剪貼板的前端功能 | 100%   | ✅ 已完成 | 與 S1.5 合併實現，已添加通知提示UI |
| **S4** | S4.1    | 前端批量操作實現    | 在 api.ts 中實現批量操作函數（循環調用單個API） | 100%   | ✅ 已完成 | -              |
|              | S4.2    | 批量操作UI組件      | 實現批量操作API函數（batchRenameFiles等） | 100%   | ✅ 已完成 | -              |
|              | S4.3    | 後端批量API（可選） | 前端批量操作已實現，後端批量API暫不實現 | 100%   | ✅ 已完成 | P2優先級，可選 |
|              | S4.4    | 批量下載功能        | 實現批量下載選中的文件 | 100%   | ✅ 已完成 | 已實現根據文件數量自動選擇下載方式（≤5個文件循環下載，>5個文件ZIP打包） |
| **S5** | S5.1    | 附加文件到聊天功能  | 新增 POST /api/v1/files/{file_id}/attach API | 100%   | ✅ 已完成 | -              |
|              | S5.2    | 查看向量資料功能    | 新增 GET /api/v1/files/{file_id}/vectors API | 100%   | ✅ 已完成 | -              |
|              | S5.3    | 查看圖譜資料功能    | 新增 GET /api/v1/files/{file_id}/graph API | 100%   | ✅ 已完成 | -              |
| **S6** | S6.1    | 從文件庫上傳功能    | 實現從文件庫選擇文件上傳到當前任務 | 100%   | ✅ 已完成 | 已實現後端API和前端文件庫選擇對話框，重用copy_file邏輯 |
|              | S6.2    | 傳回文件庫功能      | 實現將當前任務的文件傳回文件庫 | 100%   | ✅ 已完成 | 已實現後端API和前端確認對話框，更新文件task_id關聯 |
|              | S6.3    | 同步文件功能        | 實現同步文件狀態和元數據 | 100%   | ✅ 已完成 | 已實現後端API檢查文件狀態、元數據和完整性，前端顯示同步結果 |
|              | S6.4    | 搜尋文件庫功能      | 實現在文件庫中搜尋文件 | 100%   | ✅ 已完成 | 已實現後端API和前端搜尋對話框，支持文件名搜尋 |
| **S7** | S7.1    | 全局快捷鍵實現      | 實現 Cmd/Ctrl+P、Esc、F2、Delete 等快捷鍵 | 100%   | ✅ 已完成 | 已創建useKeyboardShortcuts Hook，實現Cmd/Ctrl+P和Esc快捷鍵 |
|              | S7.2    | 文件操作快捷鍵      | 實現 Cmd/Ctrl+C、X、V、A 等快捷鍵 | 100%   | ✅ 已完成 | 已實現F2、Delete、Cmd/Ctrl+C/X/V/A等快捷鍵，集成剪貼板和批量選擇功能 |
|              | S7.3    | 文件瀏覽快捷鍵      | 實現 ↑/↓、Enter、←/→ 等快捷鍵 | 100%   | ✅ 已完成 | 已在FileTree中實現↑/↓、Enter、←/→等鍵盤導航功能 |
|              | S7.4    | 搜尋快捷鍵          | 實現 Cmd/Ctrl+F 快捷鍵 | 100%   | ✅ 已完成 | 已實現Cmd/Ctrl+F快捷鍵，在當前視圖中搜尋 |

### 進度統計

- **總進度**: 100% (30/30 任務完成)
- **階段進度**:
  - S0: 100% (3/3)
  - S1: 100% (6/6)
  - S2: 100% (5/5)
  - S3: 100% (5/5)
  - S4: 100% (4/4)
  - S5: 100% (3/3)
  - S6: 100% (4/4)
  - S7: 100% (4/4)

### 狀態說明

- ⏸️ **未開始**: 任務尚未開始
- 🔄 **進行中**: 任務正在進行中
- ✅ **已完成**: 任務已完成
- ⏸️ **已暫停**: 任務已暫停
- ❌ **已取消**: 任務已取消

---

# 文件操作功能實現計劃（保守方案 - 更新版）

**創建日期**: 2025-12-07
**創建人**: Daniel Chung
**最後修改日期**: 2025-12-07

## 概述

本文檔基於**保守的「零風險新增」方案**，在現有代碼基礎上新增文件操作功能，**不進行大規模重構**，確保現有功能不受影響。

**更新說明**（2025-01-27）：
- 根據《文件操作功能檢核報告》補充遺漏功能
- 新增 S6 階段（文件庫相關功能）
- 新增 S7 階段（快捷鍵實現）
- 補充各階段的數據驗證規則
- 補充刪除文件、複製路徑、新增檔案等功能

## 實施原則

### 核心原則（必須遵守）

1. ✅ **不移動現有文件** - 保持所有現有文件位置不變
2. ✅ **不修改現有代碼** - 只在現有文件中新增功能
3. ✅ **不改變現有API路徑** - 新增功能使用新路徑
4. ✅ **重用現有服務** - 直接使用現有服務，不重構
5. ✅ **前端優先** - 能前端處理的功能，不增加後端負擔

### 風險控制

- 🔴 **高風險操作**：移動文件、重構服務層、修改API路徑 → **禁止**
- 🟡 **中風險操作**：拆分文件、重命名函數 → **避免**
- 🟢 **低風險操作**：在現有文件中新增功能 → **推薦**

---

## 階段劃分

### 階段零：目錄結構準備（S0 - 前置任務）

**目標**: 為後續開發做準備，但不移動現有文件

**任務**:
- 創建新目錄結構（用於未來新功能，不移動現有文件）
- 準備開發環境
- 文檔準備

**工作量**: 0.5 天
**優先級**: P0
**依賴**: 無

---

### 階段一：文件操作核心功能（S1）

**目標**: 實現文件的基本操作（重命名、複製、移動、刪除、複製路徑）

**實施方式**: 在 `api/routers/file_management.py` 中新增API端點

**新增API**:
- `PUT /api/v1/files/{file_id}/rename` - 重命名文件
- `POST /api/v1/files/{file_id}/copy` - 複製文件
- `PUT /api/v1/files/{file_id}/move` - 移動文件
- `DELETE /api/v1/files/{file_id}` - 刪除文件（多數據源清理）
- 前端：複製路徑功能

**數據驗證規則**:
- 文件名規則：長度不超過255字符，不能包含特殊字符
- 文件大小限制：單個文件最大100MB
- 文件類型限制：支持文檔、表格、圖片、代碼等類型

**重用現有服務**:
- `get_metadata_service()` - 文件元數據服務
- `get_storage()` - 文件存儲服務
- `get_file_permission_service()` - 權限檢查服務
- `get_vector_store_service()` - 向量存儲服務（刪除時清理）
- `get_kg_extraction_service()` - 圖譜提取服務（刪除時清理）

**工作量**: 6 天（原4天 + 新增2天）
**優先級**: P0
**依賴**: S0

---

### 階段二：資料夾操作功能（S2）

**目標**: 實現資料夾的基本操作（創建、重命名、刪除、新增檔案）

**實施方式**: 在 `api/routers/file_management.py` 中新增API端點

**新增API**:
- `POST /api/v1/files/folders` - 創建資料夾（實際上是創建任務）
- `PUT /api/v1/files/folders/{folder_id}` - 重命名資料夾
- `DELETE /api/v1/files/folders/{folder_id}` - 刪除資料夾（級聯刪除）
- 確認新增檔案功能實施方式（使用現有上傳功能或新增特定功能）

**數據驗證規則**:
- 資料夾名稱規則：長度不超過255字符，不能包含特殊字符
- 唯一性：同一父資料夾下不能有重名的資料夾

**重用現有服務**:
- `get_metadata_service()` - 文件元數據服務
- 重用 `file_upload.py` 中的 `delete_file` 邏輯

**工作量**: 5 天（原4天 + 新增1天）
**優先級**: P0
**依賴**: S1

---

### 階段三：前端狀態管理（S3）

**目標**: 實現前端的剪貼板和批量選擇功能

**實施方式**: 完全前端實現，不涉及後端

**功能**:
- 剪貼板狀態管理（localStorage）
- 批量選擇（前端 state）
- 文件樹狀態緩存（前端 state + localStorage）
- 聚焦狀態管理（前端 state）
- 複製路徑前端實現

**工作量**: 2.5 天（原2天 + 新增0.5天）
**優先級**: P1
**依賴**: S1, S2

---

### 階段四：批量操作功能（S4）

**目標**: 實現批量文件操作

**實施方式**:
- 前端：批量選擇和循環調用單個API
- 後端：可選的批量API（優化性能）

**功能**:
- 批量重命名
- 批量複製
- 批量移動
- 批量刪除
- 批量下載（新增）

**工作量**: 4 天（原3天 + 新增1天）
**優先級**: P1
**依賴**: S1, S2, S3

---

### 階段五：AI相關功能（S5）

**目標**: 實現AI相關的文件操作功能

**實施方式**: 在 `api/routers/file_management.py` 中新增API端點

**新增API**:
- `POST /api/v1/files/{file_id}/attach` - 附加文件到聊天
- `GET /api/v1/files/{file_id}/vectors` - 查看向量資料
- `GET /api/v1/files/{file_id}/graph` - 查看圖譜資料

**重用現有服務**:
- `get_vector_store_service()` - 向量存儲服務
- `get_kg_extraction_service()` - 圖譜提取服務

**工作量**: 3 天
**優先級**: P2
**依賴**: S1

---

### 階段六：文件庫相關功能（S6 - 新增）

**目標**: 實現Header工具欄「其他選項」功能

**實施方式**: 在 `api/routers/file_management.py` 中新增API端點

**新增API**:
- `POST /api/v1/files/library/upload` - 從文件庫上傳
- `POST /api/v1/files/library/return` - 傳回文件庫
- `POST /api/v1/files/sync` - 同步文件
- `GET /api/v1/files/library/search` - 搜尋文件庫

**功能描述**:
- **從文件庫上傳**: 從文件庫選擇文件上傳到當前任務
- **傳回文件庫**: 將當前任務的文件傳回文件庫
- **同步文件**: 同步文件狀態和元數據
- **搜尋文件庫**: 在文件庫中搜尋文件

**工作量**: 4 天
**優先級**: P2（低優先級）
**依賴**: S1, S2

---

### 階段七：快捷鍵實現（S7 - 新增）

**目標**: 實現全局快捷鍵功能

**實施方式**: 完全前端實現

**快捷鍵列表**:
- **全局快捷鍵**: `Cmd/Ctrl + P`（搜尋檔案）、`Esc`（關閉對話框）
- **文件操作快捷鍵**: `F2`（重新命名）、`Delete`（刪除）、`Cmd/Ctrl + C`（複製）、`Cmd/Ctrl + X`（剪下）、`Cmd/Ctrl + V`（貼上）、`Cmd/Ctrl + A`（全選）
- **文件瀏覽快捷鍵**: `↑/↓`（上下移動）、`Enter`（打開/展開）、`←/→`（折疊/展開）
- **搜尋快捷鍵**: `Cmd/Ctrl + F`（當前視圖搜尋）

**工作量**: 3 天
**優先級**: P2（低優先級）
**依賴**: S1, S2, S3

---

## 階段依賴關係

```
S0 (準備)
  ↓
S1 (文件操作核心)
  ↓
S2 (資料夾操作) ──→ S3 (前端狀態管理)
  ↓                    ↓
S4 (批量操作) ←────────┘
  ↑
S5 (AI相關功能)
  ↑
S6 (文件庫相關功能) ──→ S7 (快捷鍵實現)
```

---

## 工作量總計

| 階段             | 工作量            | 優先級 |
| ---------------- | ----------------- | ------ |
| S0: 目錄結構準備 | 0.5 天            | P0     |
| S1: 文件操作核心 | 6 天              | P0     |
| S2: 資料夾操作   | 5 天              | P0     |
| S3: 前端狀態管理 | 2.5 天            | P1     |
| S4: 批量操作     | 4 天              | P1     |
| S5: AI相關功能   | 3 天              | P2     |
| S6: 文件庫相關功能 | 4 天              | P2     |
| S7: 快捷鍵實現   | 3 天              | P2     |
| **總計**   | **27.5 天** |        |

**約 5.5 週**（相比原計劃的 16.5 天，增加約 67%，主要是補充了遺漏功能）

---

## 更新日誌

### 2025-01-27
- ✅ 根據《文件操作功能檢核報告》更新實施計劃
- ✅ 補充 S1 階段：刪除文件功能、複製路徑功能、數據驗證規則
- ✅ 補充 S2 階段：新增檔案功能、數據驗證規則
- ✅ 補充 S3 階段：複製路徑前端實現
- ✅ 補充 S4 階段：批量下載功能
- ✅ 新增 S6 階段：文件庫相關功能（其他選項）
- ✅ 新增 S7 階段：快捷鍵實現
- ✅ 更新進度管制表
- ✅ 更新工作量統計

### 2025-12-07
- ✅ 採用保守的「零風險新增」方案
- ✅ 重新規劃實施階段
- ✅ 明確風險控制措施
- ✅ 制定測試要求
- ✅ 工作量從 45 天減少到 16.5 天（減少約 63%）

---

## 附錄：與原計劃對比

| 項目     | 原計劃 | 更新後計劃 | 差異     |
| -------- | ------ | ---------- | -------- |
| 工作量   | 16.5 天  | 27.5 天    | +67%     |
| 階段數   | 6 個    | 8 個       | +2 個階段 |
| 任務數   | 18 個   | 30 個      | +12 個任務 |
| 風險等級 | 🟢 低    | 🟢 低      | 保持不變 |
| 重構範圍 | 零重構   | 零重構     | 保持不變 |
| 影響範圍 | 無影響   | 無影響     | 保持不變 |
| 實施難度 | 低       | 低         | 保持不變 |

**結論**: 更新後的計劃在保證功能完整性的同時，仍然保持低風險和零重構的原則。新增的工作量主要用於補充遺漏的功能（快捷鍵、文件庫相關功能等），這些功能多為低優先級（P2），不影響核心功能的實現。
