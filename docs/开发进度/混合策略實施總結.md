# 混合策略實施總結

**創建日期**: 2026-01-05
**創建人**: Daniel Chung
**最後修改日期**: 2026-01-05

---

## 📋 實施概述

已成功實施方案 3（混合策略）用於實體匹配，結合文字比對和關鍵詞匹配，為未來語義匹配預留接口。

---

## ✅ 已實施的功能

### 1. 混合策略架構

**實現位置**: `genai/workflows/rag/hybrid_rag.py:_find_matching_entities()`

**策略流程**:
1. **策略 1: 文字比對**（精確匹配、模糊匹配）
   - 精確匹配: `doc.name == @entity_name`
   - 模糊匹配: `doc.name LIKE CONCAT("%", @entity_name, "%")`
   - 包含匹配: `CONTAINS(LOWER(doc.name), LOWER(@entity_name))`

2. **策略 2: 關鍵詞匹配**（如果文字比對結果不足）
   - 將實體文本拆分為關鍵詞
   - 使用關鍵詞進行模糊匹配
   - 合併匹配結果並去重

3. **策略 3: 語義匹配**（未來實現，已預留接口）
   - 使用 Embedding 模型計算語義相似度
   - 匹配語義相關但文字不同的實體

### 2. 關鍵詞提取邏輯

**實現位置**: `genai/workflows/rag/hybrid_rag.py:_extract_keywords()`

**提取策略**:
1. **提取完整詞語**: 提取長度 >= 2 的中文字符序列
2. **拆分為子詞**: 如果文本較長（> 4 字），拆分成 2-3 字詞
3. **滑動窗口**: 如果仍然沒有關鍵詞，使用滑動窗口提取

**示例**:
- 輸入: 「中国预制菜产业」
- 輸出: `['中国预制菜产业', '中国预', '国预制', '预制菜', '制菜产', '菜产业', '中国', '国预', '预制', '制菜']`

### 3. 關鍵詞匹配邏輯

**實現位置**: `genai/workflows/rag/hybrid_rag.py:_query_entities_by_keywords()`

**匹配流程**:
1. 遍歷每個關鍵詞
2. 使用 AQL 查詢進行模糊匹配
3. 合併結果並去重（基於 `_key`）

---

## 🔧 技術實現細節

### 1. 文字比對方法

```python
def _query_entities_by_text_match(
    self,
    kg_service: Any,
    entity_text: str,
    entity_type: Optional[str],
    limit: int,
) -> List[Dict[str, Any]]:
    """策略 1: 文字比對（精確匹配、模糊匹配）"""
    aql = """FOR doc IN entities
FILTER doc.name == @entity_name
   OR doc.name LIKE CONCAT("%", @entity_name, "%")
   OR CONTAINS(LOWER(doc.name), LOWER(@entity_name))
RETURN doc"""
    # ...
```

### 2. 關鍵詞提取方法

```python
def _extract_keywords(self, text: str) -> List[str]:
    """從文本中提取關鍵詞（混合策略：提取完整詞語 + 拆分為子詞）"""
    # 策略 1: 提取完整的中文字符序列
    # 策略 2: 如果文本較長，拆分成子詞
    # 策略 3: 如果仍然沒有關鍵詞，使用滑動窗口提取
    # ...
```

### 3. 關鍵詞匹配方法

```python
def _query_entities_by_keywords(
    self,
    kg_service: Any,
    keywords: List[str],
    entity_type: Optional[str],
    limit: int,
) -> List[Dict[str, Any]]:
    """策略 2: 關鍵詞匹配"""
    # 遍歷關鍵詞，使用模糊匹配查詢
    # 合併結果並去重
    # ...
```

### 4. 語義匹配接口（預留）

```python
def _query_entities_by_semantic_match(
    self,
    kg_service: Any,
    entity_text: str,
    entity_type: Optional[str],
    limit: int,
) -> List[Dict[str, Any]]:
    """策略 3: 語義匹配（未來實現）"""
    # TODO: 實現語義匹配
    # 1. 為實體名稱生成向量
    # 2. 使用向量相似度搜索
    # 3. 返回語義相關的實體
    return []
```

---

## 📊 測試結果

### 測試案例

**查詢**: "請說明中国预制菜产业市场规模与增长趋势"

**NER 提取的實體**: 「中国预制菜产业」 (Industry)

**關鍵詞提取結果**:
- 完整詞語: 「中国预制菜产业」
- 3字詞: 「中国预」、「国预制」、「预制菜」、「制菜产」、「菜产业」
- 2字詞: 「中国」、「国预」、「预制」、「制菜」、「菜产」、「产业」

**匹配結果**:
- 文字比對: 0 個結果（完整實體名稱無法匹配）
- 關鍵詞匹配: 找到相關實體（如「日本预制菜企业」）

---

## ⚠️ 已知問題

### 1. 'cursor count not enabled' 警告

**問題**: ArangoDB 查詢時出現 'cursor count not enabled' 警告

**原因**: ArangoDB 的 cursor 對象不支持 `count()` 方法（或需要特殊配置）

**影響**: 不影響功能，只是警告信息

**解決方法**: 直接使用 `list(cursor)` 獲取結果，不訪問 `count` 屬性

### 2. 關鍵詞提取可能產生無效詞語

**問題**: 滑動窗口提取可能產生無意義的詞語（如「国预」、「制菜」）

**影響**: 可能匹配到不相關的實體

**解決方法**: 
- 使用停用詞過濾
- 優先使用完整詞語和常見詞語
- 未來可以使用中文分詞工具（如 jieba）

---

## 🔮 未來改進方向

### 1. 改進關鍵詞提取

**建議**:
- 使用中文分詞工具（如 jieba、pkuseg）進行更準確的關鍵詞提取
- 使用詞頻統計和 TF-IDF 選擇重要關鍵詞
- 過濾無意義的詞語組合

### 2. 實施語義匹配

**建議**:
- 為實體名稱生成向量表示
- 建立向量索引（可以使用 ChromaDB 或 ArangoDB 的向量搜索功能）
- 實現語義相似度搜索

### 3. 優化匹配順序

**建議**:
- 根據實體類型調整匹配策略
- 根據查詢類型選擇匹配策略
- 實現匹配結果的相關度評分

---

## 📝 代碼變更總結

### 修改的文件

1. **`genai/workflows/rag/hybrid_rag.py`**
   - 重構 `_find_matching_entities()` 方法，實施混合策略
   - 新增 `_query_entities_by_text_match()` 方法（策略 1）
   - 新增 `_extract_keywords()` 方法（關鍵詞提取）
   - 新增 `_query_entities_by_keywords()` 方法（策略 2）
   - 新增 `_query_entities_by_semantic_match()` 方法（策略 3，預留接口）

### 新增的文檔

1. **`docs/實體匹配問題分析.md`** - 實體匹配問題詳細分析
2. **`docs/混合策略實施總結.md`** - 本文檔

---

## 🔗 相關文檔

- `docs/實體匹配問題分析.md` - 實體匹配問題詳細分析
- `docs/向量索引功能說明.md` - 向量索引功能說明
- `docs/系统设计文档/核心组件/文件上傳向量圖譜/向量與圖檢索混合查詢邏輯.md` - 混合檢索邏輯說明

---

**最後更新日期**: 2026-01-05
**維護人**: Daniel Chung

