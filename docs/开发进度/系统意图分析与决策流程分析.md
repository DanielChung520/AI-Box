# ç³»ç»Ÿæ„å›¾åˆ†æä¸å†³ç­–æµç¨‹åˆ†æ

**åˆ›å»ºæ—¥æœŸ**: 2025-12-30
**åˆ›å»ºäºº**: Daniel Chung
**æœ€åä¿®æ”¹æ—¥æœŸ**: 2025-12-30

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£åŸºäºå®é™…ä»£ç åˆ†æï¼Œè¯¦ç»†è¯´æ˜ AI-Box ç³»ç»Ÿå¦‚ä½•åˆ†æç”¨æˆ·æ„å›¾å¹¶åšå‡ºåç»­å·¥ä½œå†³ç­–ã€‚ç³»ç»Ÿé‡‡ç”¨**4 å±‚æ¸è¿›å¼è·¯ç”±æ¶æ„ï¼ˆProgressive Routingï¼‰**ï¼Œä»å¿«é€Ÿè¿‡æ»¤åˆ°å®Œæ•´å†³ç­–ï¼Œæ¯ä¸ªå±‚çº§éƒ½æœ‰æ˜ç¡®çš„èŒè´£å’Œå†³ç­–é€»è¾‘ã€‚

### æ ¸å¿ƒè®¾è®¡ç†å¿µ

> **"æ˜¯å¦å…ˆç”¨é«˜éš LLM ç›´æ¥å›ç­”"æœ¬èº«å°±æ˜¯ä¸€å€‹æ„åœ–æ±ºç­–çµæœ**
> **ä¸æ˜¯æ¯å€‹å•é¡Œéƒ½æ‡‰è©²é€²å…¥ Agent / Tool / Workflow**

ç³»ç»Ÿé‡‡ç”¨**æ¸è¿›å¼è·¯ç”±ï¼ˆProgressive Routingï¼‰**æ¶æ„ï¼Œå…ˆå°è¯•ä½æˆæœ¬ã€ä½å»¶è¿Ÿçš„å¿«é€Ÿè·¯å¾„ï¼Œåªæœ‰å½“éœ€è¦ç³»ç»Ÿè¡ŒåŠ¨æ—¶æ‰è¿›å…¥å®Œæ•´çš„å†³ç­–æµç¨‹ã€‚

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„æµç¨‹ï¼ˆ4 å±‚æ¸è¿›å¼è·¯ç”±ï¼‰

```mermaid
flowchart TD
    %% === User Input ===
    U[User Query / Instruction] --> G0[Fast Check / Heuristic Layer<br/>ç°¡å–®æŸ¥è©¢æˆ–å­—é¢ä¿¡æ¯]

    %% === Fast Path ===
    G0 -->|ç°¡å–®å•é¡Œ| L1[Internal Knowledge / Embeddings / Retrieval<br/>å¿«é€Ÿå›ç­”]

    L1 -->|å¯ä»¥ç›´æ¥å›ç­”| R0[Return Response]
    L1 -->|éœ€è¦ç†è§£æ“ä½œæˆ–å·¥å…·| T0[Trigger Semantic Intent Analysis]

    %% === Semantic Intent Analysis ===
    T0 --> L2[Internal Semantic Parser<br/>Task / Action / Constraint Extraction]

    %% === Router / Decision Engine ===
    L2 --> DE[Model Selection / Tool Orchestration<br/>Rule + Score / Policy Engine]

    DE -->|Select Model| MR[Choose Best Model / MoE Experts]
    DE -->|Select Tool| TR[Choose External Tool / API / Retrieval]
    DE -->|Select Action| AR[Internal Agent Modules]

    %% === Execution ===
    MR --> EX[Execution Layer]
    TR --> EX
    AR --> EX
    EX --> OUT[Final Response to User]

    %% === Memory & Feedback ===
    DE --> DL[Decision Log / Context Storage]
    DL --> RM[Routing Memory / Vector + Metadata]
    RM -.->|Next Query| RL[Router / Small Model Learning]
    RM -.->|Policy Update| PE[Policy Engine Evolution]

    OUT --> Feedback[Optional User Feedback / Success Rate]
    Feedback --> DL
```

### 4 å±‚æ¶æ„è¯´æ˜ï¼ˆChatGPT ä¼˜åŒ–æµç¨‹ï¼‰

| å±‚çº§ | åç§° | ç›®çš„ | æŠ€æœ¯æ ˆ | è¾“å‡º |
|------|------|------|--------|------|
| **Layer 0** | Fast Check / Heuristic Layer | å¿«é€Ÿæ£€æŸ¥ï¼ˆRegex / Heuristic / Length / Risk Filterï¼‰ï¼Œè¯†åˆ«ç®€å•æŸ¥è¯¢æˆ–å­—é¢ä¿¡æ¯ | è§„åˆ™å¼•æ“ | è·¯ç”±åˆ° Layer 1 æˆ– Layer 2 |
| **Layer 1** | Internal Knowledge / Embeddings / Retrieval | å†…éƒ¨çŸ¥è¯†æ£€ç´¢ï¼ˆä¼˜å…ˆä½¿ç”¨å†…éƒ¨çŸ¥è¯†åº“ï¼‰ï¼Œå¿«é€Ÿå›ç­” | å‘é‡æ£€ç´¢ + çŸ¥è¯†å›¾è°± + Embeddings | ç›´æ¥ç­”æ¡ˆ æˆ– è§¦å‘è¯­ä¹‰æ„å›¾åˆ†æ |
| **Layer 2** | Internal Semantic Parser | å†…éƒ¨è¯­ä¹‰è§£æå™¨ï¼ˆTask / Action / Constraint Extractionï¼‰ | è§„åˆ™å¼•æ“ + å°æ¨¡å‹ï¼ˆå¯é€‰ï¼‰ | RouterDecisionï¼ˆæ„å›¾åˆ†ç±»ç»“æœï¼‰ |
| **Layer 3** | Model Selection / Tool Orchestration | æ¨¡å‹é€‰æ‹©å’Œå·¥å…·ç¼–æ’ï¼ˆRule + Score / Policy Engineï¼‰ | Rule + Score Hybrid + Policy Engine | DecisionResultï¼ˆæœ€ç»ˆå†³ç­–ï¼‰ |

### æ¶æ„æµç¨‹è¯´æ˜ï¼ˆChatGPT ä¼˜åŒ–æµç¨‹ï¼‰

1. **Layer 0 (Fast Check / Heuristic Layer)**ï¼š
   - ä½¿ç”¨è§„åˆ™å’Œå¯å‘å¼æ–¹æ³•å¿«é€Ÿæ£€æŸ¥
   - ç®€å•é—®é¢˜ â†’ Layer 1ï¼ˆInternal Knowledge / Retrievalï¼‰
   - å¤æ‚/è¡ŒåŠ¨/æ¨¡ç³ŠæŸ¥è¯¢ â†’ Layer 2ï¼ˆSemantic Intent Parserï¼‰

2. **Layer 1 (Internal Knowledge / Embeddings / Retrieval)**ï¼š
   - **ä¼˜å…ˆç­–ç•¥**ï¼šä½¿ç”¨å†…éƒ¨çŸ¥è¯†åº“æ£€ç´¢ï¼ˆå‘é‡æ£€ç´¢ + çŸ¥è¯†å›¾è°±ï¼‰
   - å¦‚æœå†…éƒ¨çŸ¥è¯†åº“å¯ä»¥å›ç­” â†’ ç›´æ¥è¿”å›ç»“æœ
   - å¦‚æœå†…éƒ¨çŸ¥è¯†åº“æ— æ³•å›ç­” â†’ Fallback åˆ°é«˜çº§ LLM
   - å¦‚æœéœ€è¦ç†è§£æ“ä½œæˆ–å·¥å…· â†’ è§¦å‘è¯­ä¹‰æ„å›¾åˆ†æï¼Œè¿›å…¥ Layer 2

3. **Layer 2 (Internal Semantic Parser)**ï¼š
   - å†…éƒ¨è¯­ä¹‰è§£æå™¨è¿›è¡Œæ„å›¾åˆ†æ
   - Task / Action / Constraint Extraction
   - Rule Override åº”ç”¨ç¡¬æ€§è§„åˆ™ï¼ˆPolicy Engineï¼‰
   - è¾“å‡º RouterDecision

4. **Layer 3 (Model Selection / Tool Orchestration)**ï¼š
   - ç»¼åˆå†³ç­–ï¼ˆRule + Score / Policy Engineï¼‰
   - é€‰æ‹©æœ€ä½³æ¨¡å‹ï¼ˆMoE Expertsï¼‰
   - é€‰æ‹©å¤–éƒ¨å·¥å…·ï¼ˆAPI / Retrievalï¼‰
   - é€‰æ‹©å†…éƒ¨ Agent æ¨¡å—
   - è¾“å‡º DecisionResult

5. **Execution Layer**ï¼š
   - æ‰§è¡Œé€‰å®šçš„ Model/Tool/Action
   - ç”Ÿæˆæœ€ç»ˆå“åº”ç»™ç”¨æˆ·

6. **Memory & Learning**ï¼š
   - è®°å½•å†³ç­–æ—¥å¿—ï¼ˆDecision Log / Context Storageï¼‰
   - å­˜å‚¨åˆ° Routing Memoryï¼ˆVector + Metadataï¼‰
   - Router / Small Model Learningï¼ˆç”¨äºä¸‹æ¬¡æŸ¥è¯¢ï¼‰
   - Policy Engine Evolutionï¼ˆç­–ç•¥å¼•æ“æ¼”è¿›ï¼‰
   - ç”¨æˆ·åé¦ˆå’ŒæˆåŠŸç‡ç”¨äºä¼˜åŒ–

### å…³é”®è®¾è®¡åŸåˆ™

1. **æ¸è¿›å¼è·¯ç”±**ï¼šå…ˆå°è¯•ä½æˆæœ¬è·¯å¾„ï¼Œéœ€è¦æ—¶å†è¿›å…¥å®Œæ•´å†³ç­–
2. **æˆæœ¬ä¼˜åŒ–**ï¼šå……åˆ†åˆ©ç”¨é«˜çº§ LLM çš„å†…å»ºçŸ¥è¯†ï¼Œé¿å…ä¸å¿…è¦çš„ç³»ç»Ÿå¼€é”€
3. **å»¶è¿Ÿä¼˜åŒ–**ï¼šç›´æ¥å›ç­”è·¯å¾„å»¶è¿Ÿæœ€ä½ï¼Œç”¨æˆ·ä½“éªŒæœ€å¥½
4. **æ™ºèƒ½è§¦å‘**ï¼šåªæœ‰å½“éœ€è¦ç³»ç»Ÿè¡ŒåŠ¨æ—¶æ‰è¿›å…¥ Layer 2/3

---

## ğŸ” è¯¦ç»†æµç¨‹åˆ†æ

### ç¬¬ä¸€æ­¥ï¼šè¯·æ±‚å…¥å£ï¼ˆOrchestratorï¼‰

**æ–‡ä»¶**: `agents/services/orchestrator/orchestrator.py`

**å…¥å£å‡½æ•°**: `process_natural_language_request()`

**ä¸»è¦æ­¥éª¤**ï¼š

1. **ç”Ÿæˆ trace_id**ï¼šç”¨äºè¿½è¸ªæ•´ä¸ªè¯·æ±‚ç”Ÿå‘½å‘¨æœŸ
2. **è®°å½•ä»»åŠ¡å¼€å§‹æ—¥å¿—**
3. **è°ƒç”¨ Task Analyzer**ï¼šè§£æè‡ªç„¶è¯­è¨€æ„å›¾
4. **è®°å½•è·¯ç”±å†³ç­–**
5. **æ ¹æ®å†³ç­–ç±»å‹æ‰§è¡Œåç»­æµç¨‹**

---

### ç¬¬äºŒæ­¥ï¼šTask Analyzer æ ¸å¿ƒåˆ†ææµç¨‹ï¼ˆ4 å±‚æ¶æ„ï¼‰

**æ–‡ä»¶**: `agents/task_analyzer/analyzer.py`

**æ ¸å¿ƒå‡½æ•°**: `TaskAnalyzer.analyze()`

#### Layer 0: Cheap Gatingï¼ˆå¿«é€Ÿè¿‡æ»¤ï¼‰

**ç›®çš„**ï¼šæä½æˆæœ¬å¿«é€Ÿè¿‡æ»¤ï¼ˆRegex / Heuristic / Length / Risk Filterï¼‰ï¼Œè¯†åˆ«ç®€å•æŸ¥è¯¢å’Œå¤æ‚/è¡ŒåŠ¨æŸ¥è¯¢

**åˆ¤æ–­é€»è¾‘**ï¼š

```python
def _is_direct_answer_candidate(self, task: str) -> bool:
    """
    Layer 0: åˆ¤æ–­æ˜¯å¦åº”è¯¥ç›´æ¥ç”± LLM å›ç­”ï¼ˆFactoid / Simple Queryï¼‰
    è¿˜æ˜¯éœ€è¦è¿›å…¥ Layer 2 è¿›è¡Œè¯­ä¹‰æ„å›¾åˆ†æï¼ˆComplex / Action / Ambiguousï¼‰
    """
    task_lower = task.lower().strip()

    # 1. é•¿åº¦æ£€æŸ¥
    if len(task_lower) < 10:
        return True  # ç®€å•æŸ¥è¯¢ â†’ Layer 1

    # 2. ç®€å•å…³é”®è¯
    simple_keywords = ["ä½ å¥½", "hello", "hi", "è¬è¬", "thanks"]
    if task_lower in simple_keywords:
        return True  # ç®€å•æŸ¥è¯¢ â†’ Layer 1

    # 3. Factoid / Definition æ¨¡å¼
    factoid_patterns = [
        r"ä»€éº¼æ˜¯\s*\w+",  # "ä»€éº¼æ˜¯ DevSecOps?"
        r"ä»€éº¼å«\s*\w+",
        r"^[\w\s]+æ˜¯å“ªå®¶å…¬å¸",  # "HCI æ˜¯å“ªå®¶å…¬å¸ï¼Ÿ"
        r"^[\w\s]+æ˜¯ä»€éº¼",
    ]
    if any(re.match(pattern, task_lower) for pattern in factoid_patterns):
        return True  # Factoid æŸ¥è¯¢ â†’ Layer 1

    # 4. æ£€æŸ¥æ˜¯å¦æœ‰å‰¯ä½œç”¨å…³é”®è¯ï¼ˆéœ€è¦ç³»ç»Ÿè¡ŒåŠ¨ï¼‰
    action_keywords = ["å¹«æˆ‘", "å¹«", "åŸ·è¡Œ", "é‹è¡Œ", "åŸ·è¡Œ", "æŸ¥è©¢", "ç²å–"]
    if any(keyword in task_lower for keyword in action_keywords):
        return False  # éœ€è¦ç³»ç»Ÿè¡ŒåŠ¨ â†’ Layer 2

    # 5. æ£€æŸ¥æ˜¯å¦æ¶‰åŠå†…éƒ¨çŠ¶æ€/å·¥å…·
    tool_indicators = ["è‚¡åƒ¹", "è‚¡ç¥¨", "å¤©æ°£", "åŒ¯ç‡", "æ™‚é–“", "ä½ç½®"]
    if any(keyword in task_lower for keyword in tool_indicators):
        return False  # éœ€è¦å·¥å…· â†’ Layer 2

    return True  # é»˜è®¤ï¼šå°è¯•ç›´æ¥å›ç­” â†’ Layer 1
```

**å¤„ç†é€»è¾‘**ï¼š

- **Factoid / Simple Query** â†’ è¿›å…¥ Layer 1ï¼ˆFast Answer Layerï¼‰
- **Complex / Action / Ambiguous** â†’ ç›´æ¥è¿›å…¥ Layer 2ï¼ˆSemantic Intent Triggerï¼‰

---

#### Layer 1: Internal Knowledge / Embeddings / Retrievalï¼ˆå†…éƒ¨çŸ¥è¯†æ£€ç´¢ï¼‰

**ç›®çš„**ï¼šä¼˜å…ˆä½¿ç”¨å†…éƒ¨çŸ¥è¯†åº“ï¼ˆå‘é‡æ£€ç´¢ + çŸ¥è¯†å›¾è°±ï¼‰å¿«é€Ÿå›ç­”ï¼Œé¿å…ä¸å¿…è¦çš„ LLM è°ƒç”¨

**è®¾è®¡ç†å¿µ**ï¼š

> **è¿™ä¸€å±‚ä¼˜å…ˆä½¿ç”¨å†…éƒ¨çŸ¥è¯†ï¼Œè€Œä¸æ˜¯å¤–éƒ¨ LLMï¼Œæˆæœ¬æ›´ä½ã€å»¶è¿Ÿæ›´ä½**

**æŠ€æœ¯æ ˆ**ï¼š

- **å‘é‡æ£€ç´¢**ï¼šä½¿ç”¨ EmbeddingService ç”ŸæˆæŸ¥è¯¢å‘é‡ï¼Œä» Vector Store æ£€ç´¢ç›¸ä¼¼å†…å®¹
- **çŸ¥è¯†å›¾è°±æ£€ç´¢**ï¼šä» ArangoDB çŸ¥è¯†å›¾è°±ä¸­æ£€ç´¢ç›¸å…³å®ä½“å’Œå…³ç³»
- **æ··åˆæ£€ç´¢**ï¼šç»“åˆå‘é‡æ£€ç´¢å’ŒçŸ¥è¯†å›¾è°±æ£€ç´¢çš„ç»“æœ
- **Fallback æœºåˆ¶**ï¼šå¦‚æœå†…éƒ¨çŸ¥è¯†åº“æ— æ³•å›ç­”ï¼Œfallback åˆ°é«˜çº§ LLM

**å¤„ç†æµç¨‹**ï¼š

1. **ä¼˜å…ˆç­–ç•¥ï¼šå†…éƒ¨çŸ¥è¯†åº“æ£€ç´¢**
   - ä½¿ç”¨ `ChatMemoryService.retrieve_for_prompt()` æ£€ç´¢ç›¸å…³è®°å¿†å’Œ RAG å†…å®¹
   - ä½¿ç”¨ `EmbeddingService` ç”ŸæˆæŸ¥è¯¢å‘é‡
   - ä» Vector Store æ£€ç´¢ç›¸ä¼¼å†…å®¹
   - ä»çŸ¥è¯†å›¾è°±æ£€ç´¢ç›¸å…³å®ä½“å’Œå…³ç³»

2. **åˆ¤æ–­æ˜¯å¦å¯ä»¥å›ç­”**
   - å¦‚æœæ£€ç´¢åˆ°çš„å†…å®¹è¶³å¤Ÿç›¸å…³ï¼ˆç›¸ä¼¼åº¦ > é˜ˆå€¼ï¼‰â†’ ç›´æ¥è¿”å›ç­”æ¡ˆ
   - å¦‚æœæ£€ç´¢åˆ°çš„å†…å®¹ä¸å¤Ÿç›¸å…³ â†’ Fallback åˆ°é«˜çº§ LLM

3. **Fallbackï¼šé«˜çº§ LLM ç›´æ¥å›ç­”**
   - ä½¿ç”¨é«˜çº§ LLMï¼ˆgpt-4o æˆ– gemini-1.5-proï¼‰å°è¯•ç›´æ¥å›ç­”
   - LLM åˆ¤æ–­æ˜¯å¦éœ€è¦ç³»ç»Ÿè¡ŒåŠ¨
   - **å¦‚æœä¸éœ€è¦ç³»ç»Ÿè¡ŒåŠ¨**ï¼š
     - ç›´æ¥è¿”å›ç­”æ¡ˆ
     - ä¸è¿›å…¥ Layer 2/3
   - **å¦‚æœéœ€è¦ç³»ç»Ÿè¡ŒåŠ¨**ï¼š
     - è¿”å› `needs_system_action: true`
     - è¿›å…¥ Layer 2ï¼ˆSemantic Intent Parserï¼‰

**ä¼˜åŠ¿**ï¼š

- âœ… **æˆæœ¬æ›´ä½**ï¼šå†…éƒ¨æ£€ç´¢æˆæœ¬è¿œä½äº LLM API è°ƒç”¨
- âœ… **å»¶è¿Ÿæ›´ä½**ï¼šå‘é‡æ£€ç´¢æ¯” LLM è°ƒç”¨æ›´å¿«
- âœ… **å¯æ§åˆ¶æ€§æ›´å¼º**ï¼šå†…éƒ¨çŸ¥è¯†åº“å¯ä»¥ç²¾ç¡®æ§åˆ¶
- âœ… **Fallback æœºåˆ¶**ï¼šå¦‚æœå†…éƒ¨çŸ¥è¯†ä¸è¶³ï¼Œè‡ªåŠ¨ fallback åˆ° LLM

---

#### Layer 2: Internal Semantic Parserï¼ˆå†…éƒ¨è¯­ä¹‰è§£æå™¨ï¼‰

**ç›®çš„**ï¼šå½“ Layer 0 è¯†åˆ«ä¸ºå¤æ‚/è¡ŒåŠ¨æŸ¥è¯¢ï¼Œæˆ– Layer 1 åˆ¤æ–­éœ€è¦ç³»ç»Ÿè¡ŒåŠ¨æ—¶ï¼Œè¿›è¡Œè¯­ä¹‰æ„å›¾åˆ†æå’Œæå–

**åŒ…å«ç»„ä»¶**ï¼š

1. **Internal Semantic Parser**ï¼šå†…éƒ¨è¯­ä¹‰è§£æå™¨ï¼ˆTask / Action / Constraint Extractionï¼‰
   - è§„åˆ™å¼•æ“è¿›è¡Œæ„å›¾æå–
   - å°æ¨¡å‹ï¼ˆå¯é€‰ï¼‰è¿›è¡Œè¯­ä¹‰ç†è§£
   - æå–ä»»åŠ¡ç±»å‹ã€è¡ŒåŠ¨ç±»å‹ã€çº¦æŸæ¡ä»¶
2. **Rule Override**ï¼šç¡¬æ€§è§„åˆ™è¦†ç›–ï¼ˆPolicy Engineï¼‰
3. **Router å‰ç½® Recall**ï¼šæ£€ç´¢ç›¸ä¼¼å†³ç­–ï¼ˆå¯é€‰ï¼Œæä¾› Context Biasï¼‰

**æŠ€æœ¯æ ˆ**ï¼š

- **è§„åˆ™å¼•æ“**ï¼šåŸºäºè§„åˆ™çš„æ¨¡å¼åŒ¹é…å’Œæ„å›¾æå–
- **å°æ¨¡å‹ï¼ˆå¯é€‰ï¼‰**ï¼šä½¿ç”¨å°å‹ LLM è¿›è¡Œè¯­ä¹‰ç†è§£ï¼ˆæˆæœ¬ä½äº Router LLMï¼‰
- **Fallback æœºåˆ¶**ï¼šå¦‚æœå†…éƒ¨è§£æå™¨æ— æ³•å‡†ç¡®æå–ï¼Œfallback åˆ° Router LLM

##### 2.2.1 Router å‰ç½® Recallï¼ˆå¯é€‰ï¼‰

**ç›®çš„**ï¼šä» Routing Memory æ£€ç´¢ç›¸ä¼¼çš„å†å²å†³ç­–ï¼Œä¸º Router LLM æä¾›ä¸Šä¸‹æ–‡åç½®

**å®ç°**ï¼š

```python
similar_decisions = await self.routing_memory.recall_similar_decisions(
    request.task, top_k=3, filters={"success": True}
)
```

**æ³¨æ„**ï¼šå¤±è´¥ä¸å½±å“ä¸»æµç¨‹ï¼Œåªæ˜¯æä¾›é¢å¤–çš„ä¸Šä¸‹æ–‡ä¿¡æ¯

##### 2.2.2 Router LLMï¼ˆè¯­ä¹‰æ„å›¾åˆ†ç±»ï¼‰

**æ–‡ä»¶**: `agents/task_analyzer/router_llm.py`

**æ ¸å¿ƒç»„ä»¶**: `RouterLLM.route()`

**å›ºå®š System Prompt**ï¼ˆä¸å¯åŠ¨ï¼‰ï¼š

```
You are a routing and classification engine inside an enterprise GenAI system.

Your ONLY responsibility is to classify the user's query and system context
into a routing decision object.

STRICT RULES:
- You must NOT answer the user's question.
- You must NOT perform reasoning, planning, or step-by-step thinking.
- You must NOT select specific tools, agents, or models.
- You must NOT include explanations, markdown, or extra text.

You must ALWAYS return a valid JSON object that strictly follows the given JSON Schema.
If the query is ambiguous, unsafe, or unclear, choose the SAFEST and LOWEST-COST routing option.
```

**Router è¾“å‡º Schema**ï¼ˆ`RouterDecision`ï¼‰ï¼š

```python
class RouterDecision(BaseModel):
    intent_type: Literal["conversation", "retrieval", "analysis", "execution"]
    complexity: Literal["low", "mid", "high"]
    needs_agent: bool
    needs_tools: bool
    determinism_required: bool
    risk_level: Literal["low", "mid", "high"]
    confidence: float  # 0.0-1.0
```

**å¤±è´¥ä¿æŠ¤æœºåˆ¶**ï¼š

- JSON è§£æå¤±è´¥ â†’ ä½¿ç”¨ `SAFE_FALLBACK`
- Schema éªŒè¯å¤±è´¥ â†’ ä½¿ç”¨ `SAFE_FALLBACK`
- Confidence < 0.6 â†’ ä½¿ç”¨ `SAFE_FALLBACK`
- **ä¸é‡è¯• Router LLM**ï¼ˆé¿å…ç³»ç»Ÿé›ªå´©ï¼‰

**Safe Fallback**ï¼š

```python
SAFE_FALLBACK = RouterDecision(
    intent_type="conversation",
    complexity="low",
    needs_agent=False,
    needs_tools=False,
    determinism_required=False,
    risk_level="low",
    confidence=0.0
)
```

##### 2.2.3 Rule Overrideï¼ˆç¡¬æ€§è§„åˆ™è¦†ç›– / Policy Engineï¼‰

**æ–‡ä»¶**: `agents/task_analyzer/rule_override.py`

**æ ¸å¿ƒç»„ä»¶**: `RuleOverride.apply()`

**è®¾è®¡åŸåˆ™**ï¼š**Rule > LLM æ°¸è¿œæˆç«‹**ï¼ˆPolicy Engine ä¼˜å…ˆï¼‰

**è§„åˆ™ç±»å‹**ï¼š

1. **å±é™©å…³é”®è¯æ£€æµ‹**ï¼š
   - å…³é”®è¯ï¼š`["delete", "execute", "deploy", "drop", "shutdown", "remove", "destroy"]`
   - è§„åˆ™ï¼šæ£€æµ‹åˆ°å±é™©å…³é”®è¯ â†’ `risk_level = "high"`ï¼Œ`needs_agent = True`

2. **æˆæœ¬æ•æ„Ÿæ£€æµ‹**ï¼š
   - å…³é”®è¯ï¼š`["ä¾¿å®œ", "ä½æˆæœ¬", "å…è²»", "cheap", "low cost", "free"]`
   - è§„åˆ™ï¼šå½±å“åç»­æ¨¡å‹é€‰æ‹©ï¼ˆé€šè¿‡ `system_constraints`ï¼‰

3. **ä½å»¶è¿Ÿè¦æ±‚æ£€æµ‹**ï¼š
   - å…³é”®è¯ï¼š`["å¿«é€Ÿ", "ç«‹å³", "å¯¦æ™‚", "fast", "immediate", "realtime", "real-time"]`
   - è§„åˆ™ï¼šä¼˜å…ˆä½¿ç”¨æœ¬åœ°æ¨¡å‹ï¼ˆé€šè¿‡ `system_constraints`ï¼‰

**è¾“å‡º**ï¼š`RouterDecision`ï¼ˆåŒ…å«æ„å›¾ç±»å‹ã€å¤æ‚åº¦ã€é£é™©ç­‰çº§ç­‰ï¼‰

**æœªæ¥æ‰©å±•**ï¼š

- é›†æˆ OPA (Open Policy Agent) æˆ–è‡ªå®šä¹‰ Policy Engine
- æ”¯æŒåŠ¨æ€ç­–ç•¥æ›´æ–°
- ä» Routing Memory ä¸­å­¦ä¹ ç­–ç•¥

---

#### Layer 3: Decision Engineï¼ˆå®Œæ•´å†³ç­–å¼•æ“ï¼‰

**ç›®çš„**ï¼šç»¼åˆæ‰€æœ‰ä¿¡æ¯ï¼Œé€‰æ‹©æœ€ä½³ Agentã€Toolã€Model

##### 2.3.1 Capability Matchingï¼ˆèƒ½åŠ›åŒ¹é…ï¼‰

**æ–‡ä»¶**: `agents/task_analyzer/capability_matcher.py`

**æ ¸å¿ƒç»„ä»¶**: `CapabilityMatcher`

**åŒ¹é…ä¸‰ä¸ªç»´åº¦**ï¼š

##### 2.5.1 Agent èƒ½åŠ›åŒ¹é…

**æ•°æ®æº**ï¼š

- Agent Registryï¼ˆ`agents/services/registry/registry.py`ï¼‰
- Agent Discoveryï¼ˆ`agents/services/registry/discovery.py`ï¼‰

**åŒ¹é…é€»è¾‘**ï¼š

1. ä» Router Decision æå–æ‰€éœ€èƒ½åŠ›
2. ä» Agent Registry å‘ç°å¯ç”¨ Agent
3. è®¡ç®—èƒ½åŠ›åŒ¹é…åº¦ï¼š`len(intersection(required, agent)) / len(required)`
4. è®¡ç®—æ€»è¯„åˆ†ï¼ˆåŠ æƒå¹³å‡ï¼‰ï¼š
   - capability_match: 35%
   - cost_score: 20%
   - latency_score: 15%
   - success_history: 20%
   - stability: 10%

##### 2.5.2 Tool èƒ½åŠ›åŒ¹é…

**æ•°æ®æº**ï¼š

- Tool Registryï¼ˆ`tools/registry_loader.py`ï¼‰
- ArangoDB `tools_registry` collection

**åŒ¹é…é€»è¾‘**ï¼š

1. æ ¹æ® `needs_tools` å’Œ `determinism_required` ç­›é€‰å·¥å…·
2. æ ¹æ®ä»»åŠ¡ç±»å‹å’Œæ„å›¾åŒ¹é…å·¥å…·ç”¨é€”
3. è®¡ç®—å·¥å…·åŒ¹é…åº¦
4. æŒ‰æ€»è¯„åˆ†æ’åº

##### 2.5.3 Model èƒ½åŠ›åŒ¹é…

**æ•°æ®æº**ï¼š

- LLM Model Serviceï¼ˆä» ArangoDB è·å–æ‰€æœ‰å¯ç”¨æ¨¡å‹ï¼‰
- Model Registry

**åŒ¹é…é€»è¾‘**ï¼š

1. **æå–æ‰€éœ€ Model Capabilities**ï¼š
   - `conversation` â†’ `CHAT`, `STREAMING`
   - `retrieval` â†’ `CHAT`, `COMPLETION`
   - `analysis` â†’ `CHAT`, `REASONING`
   - `execution` â†’ `CHAT`, `FUNCTION_CALLING`

2. **è®¡ç®—æ¨¡å‹è¯„åˆ†**ï¼š
   - **èƒ½åŠ›åŒ¹é…åº¦**ï¼š`len(intersection(required, model)) / len(required)`
   - **æˆæœ¬è¯„åˆ†**ï¼š
     - OLLAMAï¼ˆæœ¬åœ°æ¨¡å‹ï¼‰ï¼š0.95ï¼ˆæˆæœ¬æœ€ä½ï¼‰
     - å¤§ä¸Šä¸‹æ–‡çª—å£ï¼ˆ>100Kï¼‰ï¼š0.5
     - ä¸­ç­‰ä¸Šä¸‹æ–‡çª—å£ï¼ˆ>32Kï¼‰ï¼š0.7
     - å°ä¸Šä¸‹æ–‡çª—å£ï¼š0.8
   - **å»¶è¿Ÿè¯„åˆ†**ï¼š
     - OLLAMAï¼š0.9ï¼ˆå»¶è¿Ÿæœ€ä½ï¼‰
     - äº‘æœåŠ¡ï¼š0.7ï¼ˆå»¶è¿Ÿä¸­ç­‰ï¼‰
   - **å†å²æˆåŠŸç‡**ï¼š0.8ï¼ˆé»˜è®¤å€¼ï¼Œåç»­å¯ä» Routing Memory è·å–ï¼‰
   - **ç¨³å®šåº¦**ï¼š
     - Active çŠ¶æ€ + ç¨³å®šæä¾›å•†ï¼ˆOLLAMA/OPENAI/GOOGLEï¼‰ï¼š0.9
     - Active çŠ¶æ€ + å…¶ä»–æä¾›å•†ï¼š0.8
     - é Active çŠ¶æ€ï¼š0.5

3. **æ ¹æ®å¤æ‚åº¦è°ƒæ•´è¯„åˆ†**ï¼š
   - å¤æ‚ä»»åŠ¡ï¼ˆ`high`ï¼‰ï¼šèƒ½åŠ›åŒ¹é…åº¦ Ã— 1.1
   - ç®€å•ä»»åŠ¡ï¼ˆ`low`ï¼‰ï¼šæˆæœ¬è¯„åˆ† Ã— 1.1

4. **æ€»è¯„åˆ†è®¡ç®—**ï¼ˆä¸ Agent/Tool ç›¸åŒçš„æƒé‡ï¼‰

##### 2.3.2 Decision Engineï¼ˆç»¼åˆå†³ç­– - Rule + Score Hybridï¼‰

**æ–‡ä»¶**: `agents/task_analyzer/decision_engine.py`

**æ ¸å¿ƒç»„ä»¶**: `DecisionEngine.decide()`

**å†³ç­–æµç¨‹**ï¼š

```
Router Output (from Layer 2)
   â†“
Capability Matchingï¼ˆèƒ½åŠ›åŒ¹é…ï¼‰
   - Agent Registry
   - Tool Registry
   - Model Capability List
   â†“
Rule Filterï¼ˆç¡¬æ€§æ·˜æ±° / Policy Engineï¼‰
   - é£é™©ç­‰çº§è¿‡æ»¤
   - æˆæœ¬é™åˆ¶è¿‡æ»¤
   - çº¦æŸå’Œæ”¿ç­–åº”ç”¨
   â†“
Scoring Engineï¼ˆåŠ æƒè¯„åˆ†ï¼‰
   - capability_match: 35%
   - cost_score: 20%
   - latency_score: 15%
   - success_history: 20%
   - stability: 10%
   â†“
Best Candidate Selection
   â†“
Fallback / Override
   â†“
DecisionResult
```

**Rule Filterï¼ˆç¡¬æ€§è§„åˆ™è¿‡æ»¤ï¼‰**ï¼š

1. **é£é™©ç­‰çº§è¿‡æ»¤**ï¼š
   - `candidate.risk_level <= router.risk_level`

2. **æˆæœ¬é™åˆ¶è¿‡æ»¤**ï¼š
   - `max_cost = "low"` â†’ `candidate.cost_score >= 0.7`
   - `max_cost = "medium"` â†’ `candidate.cost_score >= 0.5`
   - `max_cost = "high"` â†’ ä¸é™åˆ¶

**é€‰æ‹©é€»è¾‘**ï¼š

1. **é€‰æ‹© Agent**ï¼š
   - å¦‚æœ `router_decision.needs_agent` ä¸” `agent_candidates` ä¸ä¸ºç©º
   - é€‰æ‹© `total_score` æœ€é«˜çš„ Agent
   - æœ€ä½å¯æ¥å—è¯„åˆ†ï¼š0.5

2. **é€‰æ‹© Tool**ï¼š
   - å¦‚æœ `router_decision.needs_tools` ä¸” `tool_candidates` ä¸ä¸ºç©º
   - é€‰æ‹©è¯„åˆ†æœ€é«˜çš„å·¥å…·ï¼ˆæœ€å¤š 3 ä¸ªï¼‰
   - æœ€ä½å¯æ¥å—è¯„åˆ†ï¼š0.5

3. **é€‰æ‹© Model**ï¼š
   - ä» `model_candidates` ä¸­é€‰æ‹© `total_score` æœ€é«˜çš„æ¨¡å‹

4. **Fallback æ£€æŸ¥**ï¼š
   - å¦‚æœæ€»è¯„åˆ† < 0.5 â†’ ä½¿ç”¨ Fallback
   - Fallbackï¼šä¸ä½¿ç”¨ Agentï¼Œåªä½¿ç”¨åŸºç¡€æ¨¡å‹

**å†³ç­–ç»“æœ**ï¼ˆ`DecisionResult`ï¼‰ï¼š

```python
class DecisionResult(BaseModel):
    router_result: RouterDecision
    chosen_agent: Optional[str]
    chosen_tools: List[str]
    chosen_model: Optional[str]
    score: float  # æ€»è¯„åˆ†
    fallback_used: bool
    reasoning: str  # å†³ç­–ç†ç”±
```

##### 2.3.3 ä¼ ç»Ÿæµç¨‹ï¼ˆå‘åå…¼å®¹ï¼‰

ä¸ºäº†ä¿æŒå‘åå…¼å®¹ï¼Œç³»ç»Ÿè¿˜ä¿ç•™äº†ä¼ ç»Ÿçš„åˆ†ç±»å’Œå·¥ä½œæµé€‰æ‹©æµç¨‹ï¼š

1. **ä»»åŠ¡åˆ†ç±»**ï¼š`TaskClassifier.classify()`
2. **å·¥ä½œæµé€‰æ‹©**ï¼š`WorkflowSelector.select()`
3. **LLM è·¯ç”±é€‰æ‹©**ï¼š`LLMRouter.route()`

**æ³¨æ„**ï¼šè¿™äº›ä¼ ç»Ÿæµç¨‹çš„ç»“æœä¸»è¦ç”¨äºå‘åå…¼å®¹ï¼Œå®é™…å†³ç­–ä¸»è¦åŸºäºæ–°çš„ 4 å±‚æ¶æ„æµç¨‹ã€‚

---

#### Layer 4: Routing Memoryï¼ˆå†³ç­–è®°å¿†ï¼‰

**ç›®çš„**ï¼šè®°å½•å†³ç­–å†å²ï¼Œç”¨äºåç»­ç›¸ä¼¼å†³ç­–çš„æ£€ç´¢

**å­˜å‚¨æ–¹æ¡ˆ**ï¼ˆæ··åˆæ–¹æ¡ˆï¼‰ï¼š

- **å‘é‡å­˜å‚¨**ï¼šChromaDBï¼ˆå†³ç­–è¯­ä¹‰ï¼‰
- **å…ƒæ•°æ®å­˜å‚¨**ï¼šArangoDBï¼ˆå†³ç­–äº‹å®ï¼‰

**Decision Log ç»“æ„**ï¼š

```python
class DecisionLog(BaseModel):
    decision_id: str
    timestamp: datetime
    query: Dict[str, Any]  # text, embedding (optional)
    router_output: RouterDecision
    decision_engine: DecisionResult
    execution_result: Optional[Dict[str, Any]]  # success, latency_ms, cost
```

**å†™å…¥æµç¨‹**ï¼š

- **å¼‚æ­¥å†™å…¥**ï¼ˆFire-and-Forgetï¼‰ï¼šä¸åœ¨æ‰§è¡Œè·¯å¾„ä¸Šï¼Œé¿å…å»¶è¿Ÿ
- å¤±è´¥ä¸å½±å“ä¸»æµç¨‹
- æ”¯æŒæ‰¹é‡å†™å…¥

---

### ç¬¬ä¸‰æ­¥ï¼šåç»­å¤„ç†ï¼ˆOrchestratorï¼‰

æ ¹æ® Task Analyzer çš„å†³ç­–ç»“æœï¼ŒOrchestrator æ‰§è¡Œåç»­å¤„ç†ï¼š

#### 3.1 æ—¥å¿—æŸ¥è¯¢ï¼ˆLOG_QUERYï¼‰

**ç›´æ¥å¤„ç†**ï¼šä¸è·¯ç”±åˆ° Agentï¼Œç›´æ¥è°ƒç”¨ `LogService` æ‰§è¡ŒæŸ¥è¯¢

**åŸå› **ï¼š

1. æ—¥å¿—æŸ¥è¯¢æ˜¯æŸ¥è¯¢æ“ä½œï¼Œä¸æ˜¯ä¸šåŠ¡é€»è¾‘æ‰§è¡Œ
2. å‡å°‘æ¶æ„å¤æ‚åº¦
3. æ€§èƒ½æ›´å¥½ï¼ˆå‡å°‘ä¸€å±‚è°ƒç”¨å¼€é”€ï¼‰

#### 3.2 é…ç½®æ“ä½œï¼ˆConfigIntentï¼‰

**å¤„ç†æµç¨‹**ï¼š

1. **æ¾„æ¸…æ£€æŸ¥**ï¼šå¦‚æœ `clarification_needed = true`ï¼Œè¿”å›æ¾„æ¸…é—®é¢˜
2. **é¢„æ£€**ï¼šæ ¼å¼ä¸è¾¹ç•ŒéªŒè¯
3. **æƒé™æ£€æŸ¥**ï¼šé€šè¿‡ Security Agent
4. **è·¯ç”±åˆ° System Config Agent**ï¼šæ‰§è¡Œé…ç½®æ“ä½œ

#### 3.3 ä¸€èˆ¬ä»»åŠ¡

**å¤„ç†æµç¨‹**ï¼š

1. **æ£€æŸ¥æ˜¯å¦éœ€è¦ Agent**ï¼šæ ¹æ® `requires_agent` å’Œ `suggested_agents`
2. **è·¯ç”±åˆ° Agent**ï¼šä½¿ç”¨ `suggested_agents[0]` ä½œä¸ºç›®æ ‡ Agent
3. **ä¼ é€’å†³ç­–ç»“æœ**ï¼šå°† `decision_result` ä¼ é€’ç»™ Agent

---

## ğŸ“Š å†³ç­–ç»´åº¦æ€»ç»“

### æ„å›¾ç±»å‹ï¼ˆIntent Typeï¼‰

| ç±»å‹ | è¯´æ˜ | å…¸å‹åœºæ™¯ |
|------|------|----------|
| `conversation` | å¯¹è¯ | æ—¥å¸¸èŠå¤©ã€è§£é‡Šè¯´æ˜ |
| `retrieval` | æ£€ç´¢ | æŸ¥æ‰¾ä¿¡æ¯ã€æœç´¢æ•°æ® |
| `analysis` | åˆ†æ | æ¨ç†ã€æ¯”è¾ƒã€è¯„ä¼° |
| `execution` | æ‰§è¡Œ | æ“ä½œã€å‘½ä»¤ã€æ‰§è¡ŒåŠ¨ä½œ |

### å¤æ‚åº¦ï¼ˆComplexityï¼‰

| çº§åˆ« | è¯´æ˜ | å†³ç­–å½±å“ |
|------|------|----------|
| `low` | å•æ­¥ã€æ˜æ˜¾ | ä¼˜å…ˆè€ƒè™‘æˆæœ¬ï¼Œç®€å•æ¨¡å‹å³å¯ |
| `mid` | ç»“æ„åŒ–æ¨ç† | å¹³è¡¡æˆæœ¬å’Œè´¨é‡ |
| `high` | å¤šæ­¥æˆ–ç¼–æ’ | ä¼˜å…ˆè€ƒè™‘èƒ½åŠ›åŒ¹é…åº¦ï¼Œéœ€è¦å¼ºå¤§æ¨¡å‹ |

### é£é™©ç­‰çº§ï¼ˆRisk Levelï¼‰

| çº§åˆ« | è¯´æ˜ | å†³ç­–å½±å“ |
|------|------|----------|
| `low` | ä½é£é™© | å¯ä»¥ä½¿ç”¨ä»»ä½• Agent/Tool/Model |
| `mid` | ä¸­ç­‰é£é™© | é¿å…é«˜é£é™©æ“ä½œ |
| `high` | é«˜é£é™© | å¼ºåˆ¶ä½¿ç”¨ Agent å®¡æ ¸ï¼Œé™åˆ¶ Tool ä½¿ç”¨ |

---

## ğŸ”§ è¯„åˆ†ä½“ç³»

### è¯„åˆ†ç»´åº¦æƒé‡

| ç»´åº¦ | æƒé‡ | è¯´æ˜ |
|------|------|------|
| capability_match | 35% | èƒ½åŠ›åŒ¹é…åº¦ï¼ˆæœ€é‡è¦ï¼‰ |
| cost_score | 20% | æˆæœ¬è¯„åˆ†ï¼ˆè¶Šä¾¿å®œè¶Šé«˜ï¼‰ |
| latency_score | 15% | å»¶è¿Ÿè¯„åˆ†ï¼ˆè¶Šå¿«è¶Šé«˜ï¼‰ |
| success_history | 20% | å†å²æˆåŠŸç‡ |
| stability | 10% | è¾“å‡ºç¨³å®šåº¦ |

### æ€»è¯„åˆ†è®¡ç®—å…¬å¼

```python
total_score = (
    0.35 * capability_match +
    0.20 * cost_score +
    0.15 * latency_score +
    0.20 * success_history +
    0.10 * stability
)
```

### è¯„åˆ†é˜ˆå€¼

- **æœ€ä½å¯æ¥å—è¯„åˆ†**ï¼š0.5
- **Router LLM æœ€ä½ç½®ä¿¡åº¦**ï¼š0.6
- **Fallback è§¦å‘é˜ˆå€¼**ï¼šæ€»è¯„åˆ† < 0.5

---

## ğŸ¯ å…³é”®è®¾è®¡åŸåˆ™

### 1. æ¸è¿›å¼è·¯ç”±ï¼ˆProgressive Routingï¼‰

- **Layer 0 â†’ Layer 1**ï¼šå…ˆå°è¯•ä½æˆæœ¬ã€ä½å»¶è¿Ÿçš„å¿«é€Ÿè·¯å¾„
- **Layer 1 â†’ Layer 2/3**ï¼šåªæœ‰å½“éœ€è¦ç³»ç»Ÿè¡ŒåŠ¨æ—¶æ‰è¿›å…¥å®Œæ•´å†³ç­–
- **æˆæœ¬ä¼˜åŒ–**ï¼šå……åˆ†åˆ©ç”¨é«˜çº§ LLM çš„å†…å»ºçŸ¥è¯†ï¼Œé¿å…ä¸å¿…è¦çš„ç³»ç»Ÿå¼€é”€

### 2. åˆ†å±‚å†³ç­–

- **Layer 1 (Fast Answer)**ï¼šå°è¯•ç›´æ¥å›ç­”ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦ç³»ç»Ÿè¡ŒåŠ¨
- **Layer 2 (Semantic Intent)**ï¼šRouter LLM åªåšæ„å›¾åˆ†ç±»ï¼Œä¸åšèµ„æºé€‰æ‹©
- **Layer 3 (Decision Engine)**ï¼šCapability Matcher åªåšèƒ½åŠ›åŒ¹é…ï¼ŒDecision Engine åšæœ€ç»ˆå†³ç­–

### 3. è§„åˆ™ä¼˜å…ˆï¼ˆRule > LLMï¼‰

- ç¡¬æ€§è§„åˆ™ï¼ˆRule Overrideï¼‰æ°¸è¿œè¦†ç›– LLM å†³ç­–
- ç¡®ä¿ç³»ç»Ÿå®‰å…¨æ€§å’Œå¯æ§æ€§

### 4. å¤±è´¥ä¿æŠ¤

- Layer 1 å¤±è´¥ â†’ è¿›å…¥ Layer 2/3
- Router LLM å¤±è´¥ â†’ ä½¿ç”¨ Safe Fallback
- ä¸é‡è¯• Router LLMï¼ˆé¿å…ç³»ç»Ÿé›ªå´©ï¼‰
- Routing Memory å†™å…¥å¤±è´¥ä¸å½±å“ä¸»æµç¨‹

### 5. æˆæœ¬ä¸å»¶è¿Ÿä¼˜åŒ–

- **Layer 0**ï¼šæä½æˆæœ¬è§„åˆ™æ£€æŸ¥
- **Layer 1**ï¼šä¸€æ¬¡é«˜çº§ LLM è°ƒç”¨ï¼ˆæˆæœ¬ < å¯åŠ¨ Agent/Tool/Workflowï¼‰
- **Layer 2/3**ï¼šä»…åœ¨éœ€è¦æ—¶æ‰§è¡Œï¼Œé¿å…ä¸å¿…è¦çš„å¼€é”€
- ä¼˜å…ˆä½¿ç”¨æœ¬åœ°æ¨¡å‹ï¼ˆOLLAMAï¼‰

### 6. æ™ºèƒ½è§¦å‘

- Layer 1 åˆ¤æ–­æ˜¯å¦éœ€è¦ç³»ç»Ÿè¡ŒåŠ¨ï¼ˆä¸æ˜¯å­—è¯åŒ¹é…ï¼Œè€Œæ˜¯è¯­ä¹‰æ„å›¾ï¼‰
- åªæœ‰å½“éœ€è¦å¤–éƒ¨çŠ¶æ€ã€å·¥å…·å‰¯ä½œç”¨ã€ç³»ç»Ÿæ“ä½œæ—¶æ‰è¿›å…¥ Layer 2/3

---

## ğŸ“ æ•°æ®æ¨¡å‹å…³é”®å­—æ®µ

### RouterDecision

```python
{
    "intent_type": "conversation" | "retrieval" | "analysis" | "execution",
    "complexity": "low" | "mid" | "high",
    "needs_agent": bool,
    "needs_tools": bool,
    "determinism_required": bool,
    "risk_level": "low" | "mid" | "high",
    "confidence": float  # 0.0-1.0
}
```

### DecisionResult

```python
{
    "router_result": RouterDecision,
    "chosen_agent": Optional[str],
    "chosen_tools": List[str],
    "chosen_model": Optional[str],
    "score": float,  # 0.0-1.0
    "fallback_used": bool,
    "reasoning": str
}
```

### CapabilityMatch

```python
{
    "candidate_id": str,
    "candidate_type": "agent" | "tool" | "model",
    "capability_match": float,  # 0.0-1.0
    "cost_score": float,  # 0.0-1.0
    "latency_score": float,  # 0.0-1.0
    "success_history": float,  # 0.0-1.0
    "stability": float,  # 0.0-1.0
    "total_score": float,  # 0.0-1.0
    "metadata": Dict[str, Any]
}
```

---

## ğŸ” å®é™…æ‰§è¡Œç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šç®€å•æŸ¥è¯¢ï¼ˆLayer 0 â†’ Layer 1ï¼‰

**ç”¨æˆ·è¾“å…¥**ï¼š"ä½ å¥½"

**å¤„ç†æµç¨‹**ï¼š

1. **Layer 0 (Cheap Gating)**ï¼šè¯†åˆ«ä¸ºç®€å•æŸ¥è¯¢ï¼ˆ`simple_keywords` åŒ¹é…ï¼‰
2. **Layer 1 (Fast Answer)**ï¼šä½¿ç”¨é«˜çº§ LLM ç›´æ¥å›ç­”
   - ç›´æ¥è¿”å›ï¼š"ä½ å¥½ï¼æˆ‘å¯ä»¥å¸®åŠ©ä½ ä»€ä¹ˆï¼Ÿ"
   - ä¸è¿›å…¥ Layer 2/3
   - æˆæœ¬æœ€ä½ï¼Œå»¶è¿Ÿæœ€ä½

### ç¤ºä¾‹ 1bï¼šçŸ¥è¯†æ€§é—®é¢˜ï¼ˆLayer 0 â†’ Layer 1ï¼‰

**ç”¨æˆ·è¾“å…¥**ï¼š"ä»€éº¼æ˜¯ DevSecOps?"

**å¤„ç†æµç¨‹**ï¼š

1. **Layer 0 (Fast Check / Heuristic Layer)**ï¼šåŒ¹é… `factoid_patterns`ï¼Œè¯†åˆ«ä¸ºç®€å•é—®é¢˜
2. **Layer 1 (Internal Knowledge / Retrieval)**ï¼š
   - **ä¼˜å…ˆç­–ç•¥**ï¼šä½¿ç”¨å†…éƒ¨çŸ¥è¯†åº“æ£€ç´¢ï¼ˆå‘é‡æ£€ç´¢ + çŸ¥è¯†å›¾è°±ï¼‰
   - å¦‚æœæ£€ç´¢åˆ°ç›¸å…³å†…å®¹ â†’ åŸºäºæ£€ç´¢å†…å®¹ç”Ÿæˆç­”æ¡ˆ
   - å¦‚æœæ£€ç´¢ä¸åˆ°ç›¸å…³å†…å®¹ â†’ Fallback åˆ°é«˜çº§ LLM
   - é«˜çº§ LLM åˆ¤æ–­ï¼šä¸éœ€è¦ç³»ç»Ÿè¡ŒåŠ¨ï¼ˆä»…éœ€çŸ¥è¯†å›ç­”ï¼‰
   - ç›´æ¥è¿”å› DevSecOps çš„å®šä¹‰å’Œè¯´æ˜
   - ä¸è¿›å…¥ Layer 2/3

### ç¤ºä¾‹ 2ï¼šéœ€è¦å®æ—¶æ•°æ®ï¼ˆLayer 0 â†’ Layer 1 â†’ Layer 2/3ï¼‰

**ç”¨æˆ·è¾“å…¥**ï¼š"å¹«æˆ‘çœ‹çœ‹å°ç©é›»ä»Šå¤©çš„è‚¡åƒ¹"

**å¤„ç†æµç¨‹**ï¼š

1. **Layer 0 (Fast Check / Heuristic Layer)**ï¼šæ£€æµ‹åˆ°å·¥å…·å…³é”®è¯ `"è‚¡åƒ¹"`ï¼Œè¯†åˆ«ä¸ºå¤æ‚/è¡ŒåŠ¨æŸ¥è¯¢
2. **Layer 1 (Internal Knowledge / Retrieval)**ï¼š
   - **ä¼˜å…ˆç­–ç•¥**ï¼šä½¿ç”¨å†…éƒ¨çŸ¥è¯†åº“æ£€ç´¢
   - æ£€ç´¢ç»“æœï¼šæ— æ³•æä¾›å®æ—¶è‚¡åƒ¹æ•°æ®
   - **Fallback**ï¼šä½¿ç”¨é«˜çº§ LLM åˆ¤æ–­
   - é«˜çº§ LLM åˆ¤æ–­ï¼šéœ€è¦å®æ—¶æ•°æ® â†’ `{"needs_system_action": true}`
   - è¿›å…¥ Layer 2/3
3. **Layer 2 (Semantic Intent Analysis)**ï¼š
   - Router LLM è¾“å‡ºï¼š

     ```json
     {
         "intent_type": "retrieval",
         "complexity": "low",
         "needs_agent": false,
         "needs_tools": true,
         "determinism_required": true,
         "risk_level": "mid",
         "confidence": 0.90
     }
     ```

4. **Layer 3 (Decision Engine)**ï¼š
   - Tool åŒ¹é…ï¼š`stock_price_tool`ï¼ˆè¯„åˆ†ï¼š0.915ï¼‰
   - Model åŒ¹é…ï¼š`ollama:llama3:8b`ï¼ˆè¯„åˆ†ï¼š0.895ï¼‰
   - é€‰æ‹©å·¥å…·å’Œæ¨¡å‹ï¼Œæ‰§è¡ŒæŸ¥è¯¢

### ç¤ºä¾‹ 3ï¼šå¤æ‚åˆ†æä»»åŠ¡ï¼ˆLayer 0 â†’ Layer 1 â†’ Layer 2/3ï¼‰

**ç”¨æˆ·è¾“å…¥**ï¼š"åˆ†æä¸Šä¸ªæœˆçš„é”€å”®æ•°æ®ï¼Œæ‰¾å‡ºå¼‚å¸¸è¶‹åŠ¿"

**å¤„ç†æµç¨‹**ï¼š

1. **Layer 0 (Cheap Gating)**ï¼šæ£€æµ‹åˆ° `"å¹«æˆ‘"`ï¼Œéœ€è¦ç³»ç»Ÿè¡ŒåŠ¨
2. **Layer 1 (Fast Answer)**ï¼š
   - é«˜çº§ LLM åˆ¤æ–­ï¼šéœ€è¦è®¿é—®å†…éƒ¨æ•°æ® â†’ `{"needs_system_action": true}`
   - è¿›å…¥ Layer 2/3
3. **Layer 2 (Semantic Intent Analysis)**ï¼š
   - Router å‰ç½® Recallï¼šæ£€ç´¢ç›¸ä¼¼å†³ç­–ï¼ˆå¦‚æœæœ‰ï¼‰
   - Router LLM è¾“å‡ºï¼š

   ```json
   {
       "intent_type": "analysis",
       "complexity": "high",
       "needs_agent": true,
       "needs_tools": true,
       "determinism_required": false,
       "risk_level": "low",
       "confidence": 0.85
   }
   ```

4. Rule Overrideï¼šæ— å±é™©å…³é”®è¯ï¼Œæ— ç‰¹æ®Šè§„åˆ™
5. Capability Matchingï¼š
   - Agent åŒ¹é…ï¼šæ‰¾åˆ° `data_analysis_agent`ï¼ˆè¯„åˆ†ï¼š0.82ï¼‰
   - Tool åŒ¹é…ï¼šæ‰¾åˆ° `sql_query_tool`ï¼ˆè¯„åˆ†ï¼š0.75ï¼‰
   - Model åŒ¹é…ï¼šæ‰¾åˆ° `gpt-4o`ï¼ˆè¯„åˆ†ï¼š0.78ï¼‰
6. Decision Engine å†³ç­–ï¼š
   - `chosen_agent="data_analysis_agent"`
   - `chosen_tools=["sql_query_tool"]`
   - `chosen_model="gpt-4o"`
   - `score=0.78`
7. è®°å½•å†³ç­–åˆ° Routing Memory
8. Orchestrator è·¯ç”±åˆ° `data_analysis_agent`

### ç¤ºä¾‹ 4ï¼šå±é™©æ“ä½œï¼ˆLayer 0 â†’ Layer 1 â†’ Layer 2/3ï¼‰

**ç”¨æˆ·è¾“å…¥**ï¼š"åˆ é™¤æ‰€æœ‰æµ‹è¯•æ•°æ®"

**å¤„ç†æµç¨‹**ï¼š

1. **Layer 0 (Cheap Gating)**ï¼šæ£€æµ‹åˆ° `"åˆªé™¤"`ï¼Œéœ€è¦ç³»ç»Ÿè¡ŒåŠ¨
2. **Layer 1 (Fast Answer)**ï¼š
   - é«˜çº§ LLM åˆ¤æ–­ï¼šéœ€è¦æ‰§è¡Œæ“ä½œ â†’ `{"needs_system_action": true}`
   - è¿›å…¥ Layer 2/3
3. **Layer 2 (Semantic Intent Analysis)**ï¼š
   - Router LLM è¾“å‡ºï¼š

   ```json
   {
       "intent_type": "execution",
       "complexity": "mid",
       "needs_agent": false,
       "needs_tools": true,
       "determinism_required": true,
       "risk_level": "low",
       "confidence": 0.70
   }
   ```

2. Rule Override æ£€æµ‹åˆ°å±é™©å…³é”®è¯ `"delete"`ï¼š
   - è¦†ç›–ï¼š`risk_level = "high"`
   - è¦†ç›–ï¼š`needs_agent = true`
3. Capability Matchingï¼š
   - Agent åŒ¹é…ï¼šæ‰¾åˆ° `security_agent`ï¼ˆè¯„åˆ†ï¼š0.88ï¼‰
   - Tool åŒ¹é…ï¼šæ‰¾åˆ° `database_tool`ï¼ˆè¯„åˆ†ï¼š0.65ï¼‰
   - Model åŒ¹é…ï¼šæ‰¾åˆ° `gpt-4o`ï¼ˆè¯„åˆ†ï¼š0.72ï¼‰
4. Decision Engine å†³ç­–ï¼š
   - `chosen_agent="security_agent"`ï¼ˆå¼ºåˆ¶å®¡æ ¸ï¼‰
   - `chosen_tools=["database_tool"]`
   - `chosen_model="gpt-4o"`
   - `score=0.75`
5. Orchestrator è·¯ç”±åˆ° `security_agent`ï¼ˆè¿›è¡Œæƒé™æ£€æŸ¥å’Œå®‰å…¨å®¡æ ¸ï¼‰

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–ç‚¹

### 1. Layer 0 (Cheap Gating) å¿«é€Ÿè·¯å¾„

- æä½æˆæœ¬è§„åˆ™æ£€æŸ¥ï¼ˆæ­£åˆ™è¡¨è¾¾å¼ã€å…³é”®è¯åŒ¹é…ï¼‰
- å¿«é€Ÿè¯†åˆ« Direct Answer Candidate å’Œéœ€è¦ç³»ç»Ÿè¡ŒåŠ¨çš„æŸ¥è¯¢

### 2. Layer 1 (Fast Answer) æˆæœ¬ä¼˜åŒ–

- **ä¸€æ¬¡é«˜çº§ LLM è°ƒç”¨** vs å¤šæ¬¡è°ƒç”¨ + å†³ç­–å¼€é”€
- å……åˆ†åˆ©ç”¨ LLM å†…å»ºçŸ¥è¯†ï¼Œé¿å…ä¸å¿…è¦çš„ç³»ç»Ÿå¼€é”€
- å»¶è¿Ÿæœ€ä½ï¼šç›´æ¥å›ç­”æ¯”å¤æ‚å†³ç­–æ›´å¿«

### 3. æ¡ä»¶åŒ–æ‰§è¡Œ Layer 2/3

- åªæœ‰å½“ Layer 1 åˆ¤æ–­éœ€è¦ç³»ç»Ÿè¡ŒåŠ¨æ—¶æ‰æ‰§è¡Œ
- å‡å°‘ä¸å¿…è¦çš„ Router LLM è°ƒç”¨
- å‡å°‘ä¸å¿…è¦çš„ Capability Matching å’Œ Decision Engine å¼€é”€

### 4. å¼‚æ­¥å†™å…¥ Routing Memory

- å†³ç­–è®°å½•å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡ä¸»æµç¨‹
- å¤±è´¥ä¸å½±å“ä¸»æµç¨‹

### 5. æœ¬åœ°æ¨¡å‹ä¼˜å…ˆ

- OLLAMA æ¨¡å‹æˆæœ¬æœ€ä½ã€å»¶è¿Ÿæœ€ä½
- ä¼˜å…ˆä½¿ç”¨æœ¬åœ°æ¨¡å‹ï¼ˆå¦‚æœå¯ç”¨ï¼‰

### 6. æ‰¹é‡æ“ä½œ

- Routing Memory æ”¯æŒæ‰¹é‡å†™å…¥
- å®šæœŸæ‰¹é‡å‘é‡åŒ–

---

## ğŸ”® æœªæ¥æ”¹è¿›æ–¹å‘

### 1. Layer 1 åˆ¤æ–­ä¼˜åŒ–

- ä¼˜åŒ– System Promptï¼Œæé«˜åˆ¤æ–­å‡†ç¡®ç‡
- ä½¿ç”¨ Function Calling è®© LLM è¿”å›ç»“æ„åŒ–åˆ¤æ–­ç»“æœ
- æ ¹æ®å†å²æ•°æ®è°ƒæ•´åˆ¤æ–­é˜ˆå€¼

### 2. Router LLM ç¼“å­˜

- å¯¹ç›¸ä¼¼æŸ¥è¯¢ç¼“å­˜ Router å†³ç­–
- ä½¿ç”¨ query embedding ä½œä¸ºç¼“å­˜ key

### 3. å†å²æ•°æ®é›†æˆ

- ä» Routing Memory è¯»å–å†å²æˆåŠŸç‡
- è®¡ç®—ç¨³å®šæ€§æŒ‡æ ‡
- åŠ¨æ€è°ƒæ•´è¯„åˆ†æƒé‡
- ä¼˜åŒ– Layer 0 çš„è§„åˆ™ï¼ˆåŸºäºå†å²æ•°æ®ï¼‰

### 4. å°æ¨¡å‹ Router

- ä½¿ç”¨å†å²å†³ç­–è®­ç»ƒå°æ¨¡å‹
- é™ä½ Router LLM æˆæœ¬
- è€ƒè™‘ç”¨å°å‹æ¨¡å‹æ›¿ä»£ Layer 2 çš„ Router LLM

### 5. Policy Engine

- ä» Routing Memory æå–ç­–ç•¥
- ä½¿ç”¨ OPA æˆ–è‡ªç ” Policy Engine
- è‡ªåŠ¨åŒ– Layer 0 è§„åˆ™çš„ç”Ÿæˆå’Œä¼˜åŒ–

### 6. Layer 1 ç¼“å­˜ä¼˜åŒ–

- å¯¹å¸¸è§çŸ¥è¯†æ€§é—®é¢˜ç¼“å­˜ç­”æ¡ˆ
- ä½¿ç”¨ query embedding ä½œä¸ºç¼“å­˜ key
- å®šæœŸæ›´æ–°ç¼“å­˜å†…å®¹

### 7. Policy Engine é›†æˆ

- é›†æˆ OPA (Open Policy Agent) æˆ–è‡ªå®šä¹‰ Policy Engine
- ä» Routing Memory ä¸­å­¦ä¹ ç­–ç•¥
- æ”¯æŒåŠ¨æ€ç­–ç•¥æ›´æ–°

### 8. Router å°æ¨¡å‹è®­ç»ƒ

- ä½¿ç”¨å†å²å†³ç­–æ•°æ®è®­ç»ƒå°å‹ Router æ¨¡å‹
- é™ä½ Router LLM æˆæœ¬
- è€ƒè™‘ç”¨å°å‹æ¨¡å‹æ›¿ä»£ Layer 2 çš„ Router LLM

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Task-Analyzer-ç»†åŒ–å¼€å‘è§„æ ¼](../æ ¸å¿ƒç»„ä»¶/Task-Analyzer-ç»†åŒ–å¼€å‘è§„æ ¼.md)
- [ä»»åŠ¡åˆ†ææµç¨‹è¿½è¸ª](../../ä»»åŠ¡åˆ†ææµç¨‹è¿½è¸ª.md)
- [LLMæ¨¡å‹åˆ—è¡¨](./LLMæ¨¡å‹åˆ—è¡¨.md)

---

---

## ğŸ“ æ¶æ„å˜æ›´è¯´æ˜

### 2025-12-30ï¼šé‡‡ç”¨ ChatGPT ä¼˜åŒ–æµç¨‹ï¼ˆ4 å±‚æ¸è¿›å¼è·¯ç”±æ¶æ„ï¼‰

**å˜æ›´å†…å®¹**ï¼š

1. **ä¼˜åŒ– Layer 1 (Internal Knowledge / Embeddings / Retrieval)**ï¼š
   - **ä¼˜å…ˆç­–ç•¥**ï¼šä½¿ç”¨å†…éƒ¨çŸ¥è¯†åº“æ£€ç´¢ï¼ˆå‘é‡æ£€ç´¢ + çŸ¥è¯†å›¾è°±ï¼‰
   - **Fallback æœºåˆ¶**ï¼šå¦‚æœå†…éƒ¨çŸ¥è¯†åº“æ— æ³•å›ç­”ï¼Œfallback åˆ°é«˜çº§ LLM
   - **æˆæœ¬ä¼˜åŒ–**ï¼šå†…éƒ¨æ£€ç´¢æˆæœ¬è¿œä½äº LLM API è°ƒç”¨
   - **å»¶è¿Ÿä¼˜åŒ–**ï¼šå‘é‡æ£€ç´¢æ¯” LLM è°ƒç”¨æ›´å¿«

2. **æ‰©å±• Layer 0 (Fast Check / Heuristic Layer)**ï¼š
   - æ›´ä¸°å¯Œçš„è§„åˆ™æ£€æŸ¥ï¼ˆfactoidã€definitionã€å‰¯ä½œç”¨æ£€æŸ¥ï¼‰
   - è¯†åˆ«ç®€å•é—®é¢˜å’Œå¤æ‚/è¡ŒåŠ¨æŸ¥è¯¢

3. **ä¼˜åŒ– Layer 2 (Internal Semantic Parser)**ï¼š
   - å†…éƒ¨è¯­ä¹‰è§£æå™¨ï¼ˆè§„åˆ™å¼•æ“ + å°æ¨¡å‹ï¼‰
   - Fallback åˆ° Router LLMï¼ˆå¦‚æœå†…éƒ¨è§£æå™¨æ— æ³•å‡†ç¡®æå–ï¼‰

4. **æ¡ä»¶åŒ–æ‰§è¡Œ Layer 2/3**ï¼š
   - åªæœ‰å½“ Layer 1 åˆ¤æ–­éœ€è¦ç³»ç»Ÿè¡ŒåŠ¨æ—¶æ‰æ‰§è¡Œ
   - å‡å°‘ä¸å¿…è¦çš„ç³»ç»Ÿå¼€é”€

**ä¼˜åŠ¿**ï¼š

- âœ… **æˆæœ¬ä¼˜åŒ–**ï¼šå†…éƒ¨æ£€ç´¢æˆæœ¬è¿œä½äº LLM API è°ƒç”¨
- âœ… **å»¶è¿Ÿä¼˜åŒ–**ï¼šå‘é‡æ£€ç´¢æ¯” LLM è°ƒç”¨æ›´å¿«
- âœ… **å¯æ§åˆ¶æ€§æ›´å¼º**ï¼šå†…éƒ¨çŸ¥è¯†åº“å¯ä»¥ç²¾ç¡®æ§åˆ¶
- âœ… **Fallback æœºåˆ¶**ï¼šå¦‚æœå†…éƒ¨çŸ¥è¯†ä¸è¶³ï¼Œè‡ªåŠ¨ fallback åˆ° LLM
- âœ… **ç”¨æˆ·ä½“éªŒ**ï¼šæ›´ç¬¦åˆ ChatGPT/Gemini çš„äº¤äº’æ¨¡å¼
- âœ… **æ™ºèƒ½è§¦å‘**ï¼šåŸºäºè¯­ä¹‰æ„å›¾åˆ¤æ–­ï¼Œè€Œéå­—è¯åŒ¹é…

---

---

## ğŸ“Š æ¶æ„å¯¹æ¯”åˆ†æ

è¯¦ç»†å¯¹æ¯” ChatGPT ä¼˜åŒ–æµç¨‹ä¸å½“å‰å®ç°çš„å·®å¼‚ï¼Œè¯·å‚é˜…ï¼š

- [æ¶æ„å¯¹æ¯”åˆ†æ-ChatGPTä¼˜åŒ–æµç¨‹](./æ¶æ„å¯¹æ¯”åˆ†æ-ChatGPTä¼˜åŒ–æµç¨‹.md)

---

**æœ€åæ›´æ–°æ—¥æœŸ**: 2025-12-30
**ç»´æŠ¤äºº**: Daniel Chung
