# MCP å·¥å…·ç³»ç»Ÿå¢å¼ºå®ŒæˆæŠ¥å‘Š

**åˆ›å»ºæ—¥æœŸ**: 2025-12-30
**åˆ›å»ºäºº**: Daniel Chung
**æœ€åä¿®æ”¹æ—¥æœŸ**: 2025-12-30

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°å®Œæˆäº† MCP å·¥å…·ç³»ç»Ÿçš„å¢å¼ºåŠŸèƒ½ï¼ŒåŒ…æ‹¬å¤–éƒ¨å·¥å…·è®¤è¯æ”¯æŒã€å·¥å…·è°ƒç”¨ç»Ÿè®¡å’Œç›‘æ§ã€ä»¥åŠç›¸å…³ API ç«¯ç‚¹ã€‚

---

## âœ… å®Œæˆçš„åŠŸèƒ½

### 1. MCP Client è®¤è¯æ”¯æŒ

**æ–‡ä»¶**: `mcp/client/client.py`

**æ–°å¢åŠŸèƒ½**:

- âœ… æ”¯æŒè‡ªå®šä¹‰è¯·æ±‚å¤´ï¼ˆ`headers` å‚æ•°ï¼‰
- âœ… `set_headers()` æ–¹æ³•ç”¨äºåŠ¨æ€è®¾ç½®è¯·æ±‚å¤´
- âœ… æ”¯æŒ API Keyã€Bearer Tokenã€OAuth ç­‰å¤šç§è®¤è¯æ–¹å¼

**ä½¿ç”¨ç¤ºä¾‹**:

```python
client = MCPClient(
    endpoint="https://api.example.com/mcp",
    headers={"Authorization": "Bearer token123"}
)

# æˆ–åŠ¨æ€è®¾ç½®
client.set_headers({"X-API-Key": "key123"})
```

### 2. å¤–éƒ¨å·¥å…·è®¤è¯å®ç°

**æ–‡ä»¶**: `mcp/server/tools/external_tool.py`

**å¢å¼ºåŠŸèƒ½**:

- âœ… å®Œæ•´å®ç° `_apply_auth()` æ–¹æ³•
- âœ… æ”¯æŒ API Key è®¤è¯ï¼ˆè‡ªå®šä¹‰è¯·æ±‚å¤´åç§°ï¼‰
- âœ… æ”¯æŒ Bearer Token è®¤è¯
- âœ… æ”¯æŒ OAuth 2.0 è®¤è¯ï¼ˆåŸºç¡€å®ç°ï¼‰
- âœ… ç¯å¢ƒå˜é‡è§£ææ”¯æŒï¼ˆ`${ENV_VAR}` æ ¼å¼ï¼‰

**è®¤è¯é…ç½®ç¤ºä¾‹**:

```yaml
auth_type: "api_key"
auth_config:
  api_key: "${GLAMA_API_KEY}"
  header_name: "X-API-Key"
```

### 3. å·¥å…·è°ƒç”¨ç»Ÿè®¡å’Œç›‘æ§

**æ–‡ä»¶**: `mcp/server/tools/metrics.py`

**åŠŸèƒ½ç‰¹æ€§**:

- âœ… å·¥å…·è°ƒç”¨æ¬¡æ•°ç»Ÿè®¡ï¼ˆæ€»è°ƒç”¨ã€æˆåŠŸã€å¤±è´¥ï¼‰
- âœ… å»¶è¿Ÿç»Ÿè®¡ï¼ˆå¹³å‡ã€æœ€å°ã€æœ€å¤§å»¶è¿Ÿï¼‰
- âœ… é”™è¯¯ç±»å‹ç»Ÿè®¡
- âœ… æœ€åè°ƒç”¨æ—¶é—´è¿½è¸ª
- âœ… å·¥å…·ç»Ÿè®¡æ‘˜è¦

**ç»Ÿè®¡æŒ‡æ ‡**:

- `total_calls`: æ€»è°ƒç”¨æ¬¡æ•°
- `success_calls`: æˆåŠŸè°ƒç”¨æ¬¡æ•°
- `failure_calls`: å¤±è´¥è°ƒç”¨æ¬¡æ•°
- `success_rate`: æˆåŠŸç‡
- `average_latency_ms`: å¹³å‡å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
- `min_latency_ms`: æœ€å°å»¶è¿Ÿ
- `max_latency_ms`: æœ€å¤§å»¶è¿Ÿ
- `error_types`: é”™è¯¯ç±»å‹åˆ†å¸ƒ
- `last_call_time`: æœ€åè°ƒç”¨æ—¶é—´

### 4. å·¥å…·è°ƒç”¨ç»Ÿè®¡é›†æˆ

**æ–‡ä»¶**: `mcp/server/server.py`, `mcp/server/tools/external_tool.py`

**é›†æˆç‚¹**:

- âœ… MCP Server å·¥å…·è°ƒç”¨å¤„ç†å™¨è‡ªåŠ¨è®°å½•ç»Ÿè®¡
- âœ… ExternalMCPTool è‡ªåŠ¨è®°å½•å¤–éƒ¨å·¥å…·è°ƒç”¨ç»Ÿè®¡
- âœ… å·¥å…·æ³¨å†Œè¡¨è‡ªåŠ¨æ›´æ–°è°ƒç”¨ç»Ÿè®¡

**ç»Ÿè®¡è®°å½•**:

- æ¯æ¬¡å·¥å…·è°ƒç”¨éƒ½ä¼šè®°å½•å»¶è¿Ÿå’Œç»“æœ
- æˆåŠŸè°ƒç”¨è®°å½•æˆåŠŸç»Ÿè®¡
- å¤±è´¥è°ƒç”¨è®°å½•å¤±è´¥ç»Ÿè®¡å’Œé”™è¯¯ç±»å‹

### 5. å·¥å…·ç»Ÿè®¡ API ç«¯ç‚¹

**æ–‡ä»¶**: `mcp/server/server.py`

**æ–°å¢ç«¯ç‚¹**:

1. **GET `/metrics/tools`**
   - è·å–æ‰€æœ‰å·¥å…·çš„ç»Ÿè®¡ä¿¡æ¯
   - è¿”å›ç»Ÿè®¡æ‘˜è¦å’Œè¯¦ç»†ç»Ÿè®¡

2. **GET `/metrics/tools/{tool_name}`**
   - è·å–å•ä¸ªå·¥å…·çš„ç»Ÿè®¡ä¿¡æ¯
   - å¦‚æœå·¥å…·ä¸å­˜åœ¨æˆ–æ²¡æœ‰ç»Ÿè®¡ï¼Œè¿”å› 404

**API å“åº”ç¤ºä¾‹**:

```json
{
  "summary": {
    "total_tools": 5,
    "total_calls": 1000,
    "total_success": 950,
    "total_failure": 50,
    "overall_success_rate": 0.95,
    "tools": ["task_analyzer", "file_tool", "yahoo_finance_quote"]
  },
  "tools": {
    "task_analyzer": {
      "tool_name": "task_analyzer",
      "total_calls": 500,
      "success_calls": 490,
      "failure_calls": 10,
      "success_rate": 0.98,
      "average_latency_ms": 120.5,
      "min_latency_ms": 50.0,
      "max_latency_ms": 500.0,
      "error_types": {
        "ValueError": 5,
        "TimeoutError": 5
      },
      "last_call_time": 1703952000.0,
      "last_success_time": 1703952000.0,
      "last_failure_time": 1703951900.0
    }
  }
}
```

---

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### è®¤è¯æµç¨‹

1. **é…ç½®åŠ è½½**: ä» `external_mcp_tools.yaml` åŠ è½½è®¤è¯é…ç½®
2. **ç¯å¢ƒå˜é‡è§£æ**: è§£æ `${ENV_VAR}` æ ¼å¼çš„ç¯å¢ƒå˜é‡
3. **è¯·æ±‚å¤´æ„å»º**: æ ¹æ®è®¤è¯ç±»å‹æ„å»ºè¯·æ±‚å¤´
4. **Client é…ç½®**: å°†è¯·æ±‚å¤´è®¾ç½®åˆ° MCPClient

### ç»Ÿè®¡è®°å½•æµç¨‹

1. **è°ƒç”¨å¼€å§‹**: è®°å½•å¼€å§‹æ—¶é—´
2. **è°ƒç”¨æ‰§è¡Œ**: æ‰§è¡Œå·¥å…·è°ƒç”¨
3. **è°ƒç”¨ç»“æŸ**: è®¡ç®—å»¶è¿Ÿæ—¶é—´
4. **ç»“æœè®°å½•**: æ ¹æ®æˆåŠŸ/å¤±è´¥è®°å½•ç»Ÿè®¡
5. **é”™è¯¯åˆ†ç±»**: è®°å½•é”™è¯¯ç±»å‹ï¼ˆå¦‚æœå¤±è´¥ï¼‰

### ç»Ÿè®¡æŸ¥è¯¢æµç¨‹

1. **API è¯·æ±‚**: å®¢æˆ·ç«¯è¯·æ±‚ç»Ÿè®¡ç«¯ç‚¹
2. **æ•°æ®èšåˆ**: ä» ToolMetrics è·å–ç»Ÿè®¡æ•°æ®
3. **æ ¼å¼åŒ–å“åº”**: æ ¼å¼åŒ–ç»Ÿè®¡æ•°æ®ä¸º JSON
4. **è¿”å›ç»“æœ**: è¿”å›ç»Ÿè®¡ä¿¡æ¯

---

## ğŸ“Š ä½¿ç”¨ç¤ºä¾‹

### 1. æŸ¥çœ‹æ‰€æœ‰å·¥å…·ç»Ÿè®¡

```bash
curl http://localhost:8002/metrics/tools
```

### 2. æŸ¥çœ‹å•ä¸ªå·¥å…·ç»Ÿè®¡

```bash
curl http://localhost:8002/metrics/tools/task_analyzer
```

### 3. åœ¨ä»£ç ä¸­ä½¿ç”¨ç»Ÿè®¡

```python
from mcp.server.tools.metrics import get_tool_metrics

metrics = get_tool_metrics()

# è·å–æ‰€æœ‰å·¥å…·ç»Ÿè®¡
all_stats = metrics.get_stats()

# è·å–å•ä¸ªå·¥å…·ç»Ÿè®¡
tool_stats = metrics.get_stats("task_analyzer")

# è·å–ç»Ÿè®¡æ‘˜è¦
summary = metrics.get_summary()
```

---

## ğŸ” ä»£ç è´¨é‡æ£€æŸ¥

- âœ… æ‰€æœ‰ä»£ç é€šè¿‡ lint æ£€æŸ¥
- âœ… ç±»å‹æ³¨è§£å®Œæ•´
- âœ… é”™è¯¯å¤„ç†å®Œå–„
- âœ… æ—¥å¿—è®°å½•å®Œæ•´
- âœ… æ–‡æ¡£å­—ç¬¦ä¸²å®Œæ•´

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

### æ–°å¢æ–‡ä»¶

- `mcp/server/tools/metrics.py`: å·¥å…·ç»Ÿè®¡æ¨¡å—

### ä¿®æ”¹æ–‡ä»¶

- `mcp/client/client.py`: æ·»åŠ è®¤è¯å¤´æ”¯æŒ
- `mcp/server/tools/external_tool.py`: å®Œå–„è®¤è¯å®ç°å’Œç»Ÿè®¡é›†æˆ
- `mcp/server/server.py`: æ·»åŠ ç»Ÿè®¡ç«¯ç‚¹å’Œç»Ÿè®¡è®°å½•
- `mcp/server/tools/__init__.py`: å¯¼å‡ºæ–°æ¨¡å—

---

## ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’

### å¾…å®ç°åŠŸèƒ½

1. **å·¥å…·è°ƒç”¨ç¼“å­˜æœºåˆ¶**
   - ç¼“å­˜ç›¸åŒå‚æ•°çš„è°ƒç”¨ç»“æœ
   - æ”¯æŒç¼“å­˜è¿‡æœŸæ—¶é—´é…ç½®
   - æ”¯æŒç¼“å­˜å¤±æ•ˆç­–ç•¥

2. **å®é™…å¤–éƒ¨å·¥å…·ç¤ºä¾‹**
   - Yahoo Finance MCP å·¥å…·é›†æˆ
   - Slack MCP å·¥å…·é›†æˆç¤ºä¾‹
   - Office æ–‡æ¡£å¤„ç†å·¥å…·ç¤ºä¾‹

3. **OAuth 2.0 å®Œæ•´å®ç°**
   - Token è‡ªåŠ¨åˆ·æ–°
   - æˆæƒç æµç¨‹æ”¯æŒ
   - Token å­˜å‚¨å’Œç®¡ç†

4. **å·¥å…·æƒé™æ§åˆ¶**
   - åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶
   - å·¥å…·è°ƒç”¨å®¡è®¡
   - è®¿é—®æ§åˆ¶åˆ—è¡¨ï¼ˆACLï¼‰

5. **å·¥å…·æ€§èƒ½ä¼˜åŒ–**
   - å¹¶å‘è°ƒç”¨æ§åˆ¶
   - è¯·æ±‚é™æµ
   - è¿æ¥æ± ä¼˜åŒ–

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [MCP å·¥å…·ç³»ç»Ÿè§„æ ¼](../æ ¸å¿ƒç»„ä»¶/MCPå·¥å…·/MCPå·¥å…·.md)
- [MCP ç³»ç»Ÿæ¦‚å†µ](./MCPç³»ç»Ÿæ¦‚å†µ.md)

---

**æœ€åæ›´æ–°æ—¥æœŸ**: 2025-12-30
**ç»´æŠ¤äºº**: Daniel Chung
