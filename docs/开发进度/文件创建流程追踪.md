# æ–‡ä»¶åˆ›å»ºæµç¨‹è¿½è¸ªæ–‡æ¡£

**ç‰ˆæœ¬**: 1.0
**å‰µå»ºæ—¥æœŸ**: 2026-01-06
**å‰µå»ºäºº**: Daniel Chung
**æœ€å¾Œä¿®æ”¹æ—¥æœŸ**: 2026-01-06

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æª”è¿½è¹¤ç•¶ç”¨æˆ¶èªª"å¹«æˆ‘ç”¢ç”ŸData Agentæ–‡ä»¶"æ™‚ï¼Œç³»çµ±å¦‚ä½•é€šéèªç¾©åˆ†æè­˜åˆ¥æ–‡æª”å‰µå»ºæ„åœ–ä¸¦ç”Ÿæˆæ–‡ä»¶çš„å®Œæ•´æµç¨‹ã€‚

---

## ğŸ” å®Œæ•´æµç¨‹

### 1. ç”¨æˆ¶è¼¸å…¥

**ç”¨æˆ¶æŸ¥è©¢**: "å¹«æˆ‘ç”¢ç”ŸData Agentæ–‡ä»¶"

**é æœŸè¡Œç‚º**:

- ç³»çµ±æ‡‰è©²é€šéèªç¾©åˆ†æè­˜åˆ¥å‡ºé€™æ˜¯æ–‡æª”å‰µå»ºæ„åœ–
- é¸æ“‡ `document_editing` å·¥å…·
- å¢å¼· System Prompt æŒ‡ç¤º AI ç”Ÿæˆæ–‡æª”å…§å®¹
- AI ç”Ÿæˆå®Œæ•´çš„æ–‡æª”å…§å®¹
- è‡ªå‹•å‰µå»ºæ–‡ä»¶ä¸¦å°‡å…§å®¹å¯«å…¥

---

## ğŸ”„ æµç¨‹æ­¥é©Ÿ

### Step 1: API å…¥å£ (`api/routers/chat.py:1168`)

**æµå¼éŸ¿æ‡‰å…¥å£**: `/api/v1/chat/stream`

**é—œéµä»£ç¢¼**:

```python
@router.post("/stream", status_code=status.HTTP_200_OK)
async def chat_product_stream(...)
```

**è™•ç†**:

- ç²å–ç”¨æˆ¶è¼¸å…¥: `last_user_text = "å¹«æˆ‘ç”¢ç”ŸData Agentæ–‡ä»¶"`
- ç²å– `allowed_tools`: å¾ Assistant é…ç½®ä¸­ç²å–ï¼ˆæ‡‰åŒ…å« `document_editing`ï¼‰
- å¦‚æœ `document_editing` åœ¨ `allowed_tools` ä¸­ï¼Œè‡ªå‹•æ·»åŠ  `datetime` å·¥å…·

---

### Step 2: Task Analyzer èªç¾©åˆ†æ (`api/routers/chat.py:1332`)

**èª¿ç”¨ Task Analyzer**:

```python
task_analyzer = get_task_analyzer()
analysis_result = await task_analyzer.analyze(
    TaskAnalysisRequest(
        task=last_user_text,
        context={...},
    )
)
task_analyzer_result = analysis_result
```

**é æœŸçµæœ**:

- Router LLM è­˜åˆ¥: `needs_tools=true`, `intent_type="execution"`
- Capability Matcher åŒ¹é…: `document_editing` å·¥å…·
- Decision Engine é¸æ“‡: `document_editing` å·¥å…·

**æ—¥èªŒæª¢æŸ¥é»**:

- `task_analyzer_result_assigned`: æª¢æŸ¥ `chosen_tools` æ˜¯å¦åŒ…å« `document_editing`

---

### Step 3: Router LLM æ„åœ–åˆ†é¡ (`agents/task_analyzer/router_llm.py`)

**System Prompt æª¢æŸ¥**:

- âœ… åŒ…å«æ–‡æª”å‰µå»ºç¤ºä¾‹: "å¹«æˆ‘ç”¢ç”ŸData Agentæ–‡ä»¶" â†’ `needs_tools=true`
- âœ… æ˜ç¢ºèªªæ˜: Document creation or editing â†’ `needs_tools=true`

**é æœŸ RouterDecision**:

```python
RouterDecision(
    intent_type="execution",  # åŸ·è¡Œæ“ä½œ
    complexity="mid",
    needs_agent=False,
    needs_tools=True,  # âœ… éœ€è¦å·¥å…·
    determinism_required=False,
    risk_level="low",
    confidence=0.85
)
```

---

### Step 4: Capability Matcher å·¥å…·åŒ¹é… (`agents/task_analyzer/capability_matcher.py:363`)

**åŒ¹é…é‚è¼¯** (å·²æ›´æ–°):

```python
elif tool_name in ["document_editing", "file_editing"]:
    # åŸºæ–¼ Router LLM çš„èªç¾©åˆ†æçµæœåŒ¹é…
    if router_decision.needs_tools and router_decision.intent_type == "execution":
        name_category_match = 1.0  # âœ… å®Œç¾åŒ¹é…
```

**é æœŸçµæœ**:

- `document_editing` å·¥å…·åŒ¹é…åº¦: `1.0` (å®Œç¾åŒ¹é…)
- ç¸½è©•åˆ†: `>= 0.5` (æœƒè¢« Decision Engine é¸æ“‡)

---

### Step 5: Decision Engine å·¥å…·é¸æ“‡ (`agents/task_analyzer/decision_engine.py`)

**é¸æ“‡é‚è¼¯**:

```python
if tool.total_score >= 0.5:
    chosen_tools.append(tool.candidate_id)
```

**é æœŸçµæœ**:

- `chosen_tools = ["document_editing"]`

---

### Step 6: System Prompt å¢å¼· (`api/routers/chat.py:1813`)

**æª¢æŸ¥æ¢ä»¶**:

```python
if (
    task_analyzer_result
    and decision_result.chosen_tools
    and ("document_editing" in decision_result.chosen_tools)
):
    # å¢å¼· System Prompt
```

**å¢å¼·å…§å®¹**:

```
ã€é‡è¦ï¼šç”¨æˆ¶è¦æ±‚ç”Ÿæˆæ–‡æª”ã€‘
ç”¨æˆ¶æŒ‡ä»¤ï¼šå¹«æˆ‘ç”¢ç”ŸData Agentæ–‡ä»¶
ç›®æ¨™æ–‡ä»¶åï¼šData Agentæ–‡ä»¶.md
æ–‡æª”æ ¼å¼ï¼šmd

è«‹æ ¹æ“šç”¨æˆ¶æŒ‡ä»¤ç”Ÿæˆå®Œæ•´çš„æ–‡æª”å…§å®¹ï¼ˆMarkdown æ ¼å¼ï¼‰ã€‚
- ä¸è¦è¼¸å‡ºè§£é‡‹æ–‡å­—ï¼Œåªè¼¸å‡ºæ–‡æª”å…§å®¹
- æ–‡æª”æ‡‰è©²åŒ…å«å®Œæ•´çš„çµæ§‹å’Œå…§å®¹
- å¦‚æœç”¨æˆ¶è¦æ±‚ç”Ÿæˆç‰¹å®šä¸»é¡Œçš„æ–‡æª”ï¼ˆå¦‚ã€ŒData Agent çš„èªªæ˜ã€ï¼‰ï¼Œè«‹ç”Ÿæˆè©²ä¸»é¡Œçš„å®Œæ•´æ–‡æª”
- æ–‡æª”æ‡‰è©²åŒ…å«æ¨™é¡Œã€ç« ç¯€ã€è©³ç´°èªªæ˜ç­‰å®Œæ•´å…§å®¹
```

**æ—¥èªŒæª¢æŸ¥é»**:

- `document_generation_intent_detected_via_task_analyzer`: æª¢æŸ¥æ˜¯å¦å¢å¼·äº† System Prompt

---

### Step 7: AI ç”Ÿæˆæ–‡æª”å…§å®¹ (`api/routers/chat.py:1975`)

**èª¿ç”¨ MoE Manager**:

```python
async for chunk in moe.chat_stream(
    messages_for_llm,  # åŒ…å«å¢å¼·å¾Œçš„ System Prompt
    ...
):
    full_content += chunk
```

**é æœŸè¡Œç‚º**:

- AI æ ¹æ“šå¢å¼·å¾Œçš„ System Prompt ç”Ÿæˆå®Œæ•´çš„æ–‡æª”å…§å®¹
- ä¸è¼¸å‡ºè§£é‡‹æ–‡å­—ï¼Œåªè¼¸å‡ºæ–‡æª”å…§å®¹

---

### Step 8: æ–‡ä»¶å‰µå»º (`api/routers/chat.py:2055`)

**æª¢æŸ¥æ¢ä»¶**:

```python
if (
    task_analyzer_result
    and decision_result.chosen_tools
    and ("document_editing" in decision_result.chosen_tools)
):
    create_action = _try_create_file_from_chat_output(
        user_text=last_user_text,
        assistant_text=full_content,
        task_id=task_id,
        current_user=current_user,
        force_create=True,  # âœ… å¼·åˆ¶å‰µå»ºï¼Œä¸ä¾è³´é—œéµè©åŒ¹é…
    )
```

**æ–‡ä»¶å‰µå»ºæµç¨‹** (`api/routers/chat.py:573`):

1. æª¢æŸ¥ `task_id` æ˜¯å¦å­˜åœ¨
2. å¦‚æœ `force_create=True`ï¼Œè·³éé—œéµè©åŒ¹é…
3. è§£æç›®æ¨™æ–‡ä»¶åï¼ˆå¦‚æœç”¨æˆ¶æŒ‡å®šäº†ï¼‰
4. å¦‚æœæ²’æœ‰æŒ‡å®šæ–‡ä»¶åï¼Œä½¿ç”¨ `_default_filename_for_intent` ç”Ÿæˆ
5. ä¿å­˜æ–‡ä»¶åˆ° storage
6. å‰µå»ºæ–‡ä»¶å…ƒæ•¸æ“š

**æ—¥èªŒæª¢æŸ¥é»**:

- `checking_file_creation_intent`: æª¢æŸ¥æ˜¯å¦é€²å…¥æ–‡ä»¶å‰µå»ºæµç¨‹
- `document_editing_tool_detected_for_file_creation`: æª¢æŸ¥æ˜¯å¦æª¢æ¸¬åˆ° document_editing å·¥å…·
- `file_created_from_stream`: æª¢æŸ¥æ–‡ä»¶æ˜¯å¦æˆåŠŸå‰µå»º
- `file_creation_returned_none`: å¦‚æœæ–‡ä»¶å‰µå»ºè¿”å› Noneï¼Œæª¢æŸ¥åŸå› 

---

## ğŸ› å¯èƒ½å•é¡Œæ’æŸ¥

### å•é¡Œ 1: Task Analyzer æ²’æœ‰é¸æ“‡ document_editing å·¥å…·

**æª¢æŸ¥é»**:

- æŸ¥çœ‹æ—¥èªŒ: `task_analyzer_result_assigned`
- æª¢æŸ¥ `chosen_tools` æ˜¯å¦åŒ…å« `document_editing`
- æª¢æŸ¥ `needs_tools` æ˜¯å¦ç‚º `true`
- æª¢æŸ¥ `intent_type` æ˜¯å¦ç‚º `execution`

**å¯èƒ½åŸå› **:

1. Router LLM æ²’æœ‰è­˜åˆ¥å‡ºæ–‡æª”å‰µå»ºæ„åœ–
2. Capability Matcher æ²’æœ‰åŒ¹é…åˆ° document_editing å·¥å…·
3. Decision Engine è©•åˆ†å¤ªä½ï¼Œæ²’æœ‰é¸æ“‡ document_editing å·¥å…·

**è§£æ±ºæ–¹æ¡ˆ**:

- æª¢æŸ¥ Router LLM çš„ System Prompt æ˜¯å¦åŒ…å«æ–‡æª”å‰µå»ºçš„ç¤ºä¾‹
- æª¢æŸ¥ Capability Matcher çš„åŒ¹é…é‚è¼¯
- æª¢æŸ¥ document_editing å·¥å…·æ˜¯å¦åœ¨ Tool Registry ä¸­è¨»å†Š

---

### å•é¡Œ 2: System Prompt æ²’æœ‰è¢«å¢å¼·

**æª¢æŸ¥é»**:

- æŸ¥çœ‹æ—¥èªŒ: `document_generation_intent_detected_via_task_analyzer`
- æª¢æŸ¥ `task_analyzer_result` æ˜¯å¦ç‚º `None`
- æª¢æŸ¥ `decision_result.chosen_tools` æ˜¯å¦åŒ…å« `document_editing`

**å¯èƒ½åŸå› **:

1. `task_analyzer_result` ç‚º `None`ï¼ˆTask Analyzer å¤±æ•—ï¼‰
2. `decision_result` ç‚º `None`
3. `chosen_tools` ä¸åŒ…å« `document_editing`

**è§£æ±ºæ–¹æ¡ˆ**:

- æª¢æŸ¥ Task Analyzer æ˜¯å¦æˆåŠŸåŸ·è¡Œ
- æª¢æŸ¥ Decision Engine æ˜¯å¦é¸æ“‡äº† document_editing å·¥å…·

---

### å•é¡Œ 3: AI æ²’æœ‰ç”Ÿæˆæ–‡æª”å…§å®¹

**æª¢æŸ¥é»**:

- æª¢æŸ¥ AI çš„å›å¾©å…§å®¹æ˜¯å¦ç‚ºæ–‡æª”æ ¼å¼
- æª¢æŸ¥ System Prompt æ˜¯å¦è¢«æ­£ç¢ºå¢å¼·
- æª¢æŸ¥ AI æ˜¯å¦éµå¾ªäº† System Prompt çš„æŒ‡ç¤º

**å¯èƒ½åŸå› **:

1. System Prompt æ²’æœ‰è¢«å¢å¼·
2. AI æ²’æœ‰éµå¾ª System Prompt çš„æŒ‡ç¤º
3. AI ç”Ÿæˆäº†è§£é‡‹æ–‡å­—è€Œä¸æ˜¯æ–‡æª”å…§å®¹

**è§£æ±ºæ–¹æ¡ˆ**:

- å¢å¼· System Promptï¼Œæ˜ç¢ºæŒ‡ç¤º AI åªè¼¸å‡ºæ–‡æª”å…§å®¹
- æª¢æŸ¥ AI çš„å›å¾©å…§å®¹ï¼Œç¢ºèªæ˜¯å¦ç¬¦åˆé æœŸ

---

### å•é¡Œ 4: æ–‡ä»¶æ²’æœ‰è¢«å‰µå»º

**æª¢æŸ¥é»**:

- æŸ¥çœ‹æ—¥èªŒ: `checking_file_creation_intent`
- æŸ¥çœ‹æ—¥èªŒ: `document_editing_tool_detected_for_file_creation`
- æŸ¥çœ‹æ—¥èªŒ: `file_created_from_stream` æˆ– `file_creation_returned_none`
- æª¢æŸ¥ `task_id` æ˜¯å¦å­˜åœ¨
- æª¢æŸ¥æ–‡ä»¶å‰µå»ºå‡½æ•¸æ˜¯å¦è¿”å›äº†éŒ¯èª¤

**å¯èƒ½åŸå› **:

1. `task_id` ç‚º `None`ï¼ˆæ–‡ä»¶å‰µå»ºéœ€è¦ task_idï¼‰
2. æ–‡ä»¶å‰µå»ºå‡½æ•¸è¿”å›äº† `None`ï¼ˆæ¬Šé™å•é¡Œã€æ–‡ä»¶åå•é¡Œç­‰ï¼‰
3. æ–‡ä»¶å‰µå»ºéç¨‹ä¸­ç™¼ç”Ÿç•°å¸¸

**è§£æ±ºæ–¹æ¡ˆ**:

- ç¢ºä¿ `task_id` å­˜åœ¨
- æª¢æŸ¥æ–‡ä»¶å‰µå»ºå‡½æ•¸çš„è¿”å›å€¼
- æª¢æŸ¥ç•°å¸¸æ—¥èªŒ: `file_creation_failed_in_stream`

---

## ğŸ“Š æ—¥èªŒè¿½è¹¤æ¸…å–®

ç•¶ç”¨æˆ¶èªª"å¹«æˆ‘ç”¢ç”ŸData Agentæ–‡ä»¶"æ™‚ï¼Œæ‡‰è©²çœ‹åˆ°ä»¥ä¸‹æ—¥èªŒï¼ˆæŒ‰é †åºï¼‰:

1. âœ… `chat_request_tools_received`: æª¢æŸ¥ `allowed_tools` æ˜¯å¦åŒ…å« `document_editing`
2. âœ… `task_analyzer_result_assigned`: æª¢æŸ¥ `chosen_tools` æ˜¯å¦åŒ…å« `document_editing`
3. âœ… `document_editing_tool_selected_by_task_analyzer`: Task Analyzer é¸æ“‡äº† document_editing å·¥å…·
4. âœ… `document_generation_intent_detected_via_task_analyzer`: System Prompt è¢«å¢å¼·
5. âœ… `moe_chat_stream_completed`: AI ç”Ÿæˆå®Œæˆ
6. âœ… `checking_file_creation_intent`: é–‹å§‹æª¢æŸ¥æ–‡ä»¶å‰µå»ºæ„åœ–
7. âœ… `document_editing_tool_detected_for_file_creation`: æª¢æ¸¬åˆ° document_editing å·¥å…·
8. âœ… `file_created_from_stream`: æ–‡ä»¶å‰µå»ºæˆåŠŸ

**å¦‚æœç¼ºå°‘æŸå€‹æ—¥èªŒï¼Œèªªæ˜æµç¨‹åœ¨è©²æ­¥é©Ÿå¤±æ•—ã€‚**

---

## ğŸ”§ èª¿è©¦æ­¥é©Ÿ

### æ­¥é©Ÿ 1: æª¢æŸ¥ Task Analyzer çµæœ

æŸ¥çœ‹æ—¥èªŒä¸­çš„ `task_analyzer_result_assigned`:

- `has_task_analyzer_result`: æ‡‰è©²ç‚º `True`
- `has_decision_result`: æ‡‰è©²ç‚º `True`
- `chosen_tools`: æ‡‰è©²åŒ…å« `document_editing`

### æ­¥é©Ÿ 2: æª¢æŸ¥ System Prompt å¢å¼·

æŸ¥çœ‹æ—¥èªŒä¸­çš„ `document_generation_intent_detected_via_task_analyzer`:

- å¦‚æœæ²’æœ‰é€™å€‹æ—¥èªŒï¼Œèªªæ˜ System Prompt æ²’æœ‰è¢«å¢å¼·
- æª¢æŸ¥ `chosen_tools` æ˜¯å¦åŒ…å« `document_editing`

### æ­¥é©Ÿ 3: æª¢æŸ¥æ–‡ä»¶å‰µå»º

æŸ¥çœ‹æ—¥èªŒä¸­çš„ `checking_file_creation_intent`:

- å¦‚æœæ²’æœ‰é€™å€‹æ—¥èªŒï¼Œèªªæ˜æ–‡ä»¶å‰µå»ºæµç¨‹æ²’æœ‰è¢«è§¸ç™¼
- æª¢æŸ¥ `task_id` æ˜¯å¦å­˜åœ¨
- æª¢æŸ¥ `task_analyzer_result` æ˜¯å¦ç‚º `None`

### æ­¥é©Ÿ 4: æª¢æŸ¥æ–‡ä»¶å‰µå»ºçµæœ

æŸ¥çœ‹æ—¥èªŒä¸­çš„ `file_created_from_stream` æˆ– `file_creation_returned_none`:

- å¦‚æœçœ‹åˆ° `file_created_from_stream`ï¼Œèªªæ˜æ–‡ä»¶å‰µå»ºæˆåŠŸ
- å¦‚æœçœ‹åˆ° `file_creation_returned_none`ï¼Œæª¢æŸ¥æ–‡ä»¶å‰µå»ºå‡½æ•¸çš„è¿”å›å€¼
- å¦‚æœçœ‹åˆ° `file_creation_failed_in_stream`ï¼Œæª¢æŸ¥ç•°å¸¸ä¿¡æ¯

---

## ğŸ“ ä»»å‹™"dd"æª¢æŸ¥æ¸…å–®

å°æ–¼ä»»å‹™"dd"çš„å°è©±è¨˜éŒ„ï¼Œè«‹æª¢æŸ¥ï¼š

1. **Task Analyzer æ˜¯å¦æˆåŠŸåŸ·è¡Œ**:
   - æŸ¥çœ‹æ—¥èªŒ: `task_analyzer_result_assigned`
   - æª¢æŸ¥ `chosen_tools` æ˜¯å¦åŒ…å« `document_editing`

2. **System Prompt æ˜¯å¦è¢«å¢å¼·**:
   - æŸ¥çœ‹æ—¥èªŒ: `document_generation_intent_detected_via_task_analyzer`
   - å¦‚æœæ²’æœ‰ï¼Œæª¢æŸ¥ `chosen_tools`

3. **æ–‡ä»¶å‰µå»ºæ˜¯å¦è¢«è§¸ç™¼**:
   - æŸ¥çœ‹æ—¥èªŒ: `checking_file_creation_intent`
   - æŸ¥çœ‹æ—¥èªŒ: `document_editing_tool_detected_for_file_creation`

4. **æ–‡ä»¶æ˜¯å¦æˆåŠŸå‰µå»º**:
   - æŸ¥çœ‹æ—¥èªŒ: `file_created_from_stream`
   - æª¢æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨æ–¼ task workspace

---

## ğŸ¯ é æœŸè¡Œç‚º

ç•¶ç”¨æˆ¶èªª"å¹«æˆ‘ç”¢ç”ŸData Agentæ–‡ä»¶"æ™‚ï¼š

1. âœ… Router LLM è­˜åˆ¥: `needs_tools=true`, `intent_type="execution"`
2. âœ… Capability Matcher åŒ¹é…: `document_editing` å·¥å…·ï¼ˆåŸºæ–¼èªç¾©åˆ†æï¼‰
3. âœ… Decision Engine é¸æ“‡: `document_editing` å·¥å…·
4. âœ… System Prompt è¢«å¢å¼·ï¼ŒæŒ‡ç¤º AI ç”Ÿæˆæ–‡æª”å…§å®¹
5. âœ… AI ç”Ÿæˆå®Œæ•´çš„æ–‡æª”å…§å®¹ï¼ˆMarkdown æ ¼å¼ï¼‰
6. âœ… æ–‡ä»¶è‡ªå‹•å‰µå»º: `Data Agentæ–‡ä»¶.md`ï¼ˆæˆ–æ ¹æ“šç”¨æˆ¶æŒ‡ä»¤ç”Ÿæˆçš„æ–‡ä»¶åï¼‰
7. âœ… æ–‡ä»¶å…§å®¹å¯«å…¥ task workspace

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [GenAI å·¥ä½œæµæŒ‡ä»¤-èªç¾©-å·¥å…·-æ¨¡å‹-Agent ç­‰èª¿ç”¨](./GenAI%20å·¥ä½œæµæŒ‡ä»¤-èªç¾©-å·¥å…·-æ¨¡å‹-Agent%20ç­‰èª¿ç”¨.md)
- [æ–‡ä»¶ç·¨è¼¯Agenté–‹ç™¼è¦åŠƒæ›¸](../ç³»ç»Ÿè®¾è®¡æ–‡æ¡£/æ ¸å¿ƒç»„ä»¶/IEEå°è©±å¼é–‹ç™¼æ–‡ä»¶ç·¨è¼¯/æ–‡ä»¶ç·¨è¼¯Agenté–‹ç™¼è¦åŠƒæ›¸.md)

---

**æœ€å¾Œæ›´æ–°æ—¥æœŸ**: 2026-01-06
**æ–‡æª”ç‰ˆæœ¬**: 1.0
**ç¶­è­·äºº**: Daniel Chung
