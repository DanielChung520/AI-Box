# API 超时问题修复总结

**修复日期**: 2026-01-18
**修复人**: AI Assistant
**问题报告**: 用户反馈系统服务状态查询时发生 API 请求超时错误

---

## 问题描述

用户在刷新系统服务状态查询时，遇到以下错误：

```
main.tsx:37 [apiRequest] Request timeout for https://iee.k84.org/api/v1/admin/users?page=1&page_size=20
main.tsx:37 Failed to load users: Error: API request timeout after 30 seconds
```

多个系统管理相关的 API 端点都出现相同的超时问题：

- `/api/v1/admin/users`
- `/api/v1/admin/agent-requests`
- `/api/v1/agent-display-configs`
- `/api/v1/admin/services`

---

## 根本原因

### 1. **后端 API 错误**（主要问题）

在之前的修复中，使用了 `functools.partial` 来包装 `require_permission` 依赖函数：

```python
from functools import partial

@router.get("/endpoint")
async def endpoint(
    current_user: User = Depends(partial(require_permission, Permission.ALL.value))
):
    ...
```

**问题**：`functools.partial` 与 FastAPI 的 `async def` 依赖注入机制不兼容，导致：

- `current_user` 被传递为 coroutine 对象而不是解析后的 `User` 实例
- 调用 `user.has_permission()` 时出错：`'coroutine' object has no attribute 'has_permission'`
- 请求挂起或超时

### 2. **导入缺失**

在修复过程中，部分文件缺少 `get_current_user` 的导入，导致后端启动失败：

```python
NameError: name 'get_current_user' is not defined
```

---

## 修复方案

### 修复步骤

#### 1. 创建 `require_system_admin` 依赖函数

在每个需要系统管理员权限的路由文件中添加：

```python
from system.security.dependencies import get_current_user
from system.security.models import Permission, User

async def require_system_admin(user: User = Depends(get_current_user)) -> User:
    """檢查用戶是否擁有系統管理員權限的依賴函數"""
    from fastapi import HTTPException
    from system.security.config import get_security_settings

    settings = get_security_settings()

    # 開發模式下自動通過權限檢查
    if settings.should_bypass_auth:
        return user

    # 生產模式下進行真實權限檢查
    if not settings.rbac.enabled:
        return user

    if not user.has_permission(Permission.ALL.value):
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Insufficient permissions. Required: system_admin",
        )

    return user
```

#### 2. 替換所有 `partial` 調用

將所有使用 `partial(require_permission, Permission.ALL.value)` 的地方替換為 `require_system_admin`：

```python
# ❌ 錯誤（使用 partial）
@router.get("/endpoint")
async def endpoint(
    current_user: User = Depends(partial(require_permission, Permission.ALL.value))
):
    ...

# ✅ 正確（使用 require_system_admin）
@router.get("/endpoint")
async def endpoint(
    current_user: User = Depends(require_system_admin)
):
    ...
```

#### 3. 更新導入語句

- 移除 `from functools import partial`
- 移除 `require_permission` 導入（如果不再需要）
- 確保導入 `get_current_user`

```python
# Before
from functools import partial
from system.security.dependencies import require_permission
from system.security.models import Permission, User

# After
from system.security.dependencies import get_current_user
from system.security.models import Permission, User
```

---

## 修復範圍

### 受影響的路由文件（共 11 個）

| 文件名 | 修復的 `partial` 調用數量 | 狀態 |
|--------|--------------------------|------|
| `api/routers/agent_registration.py` | 7 | ✅ 已修復 |
| `api/routers/audit_log.py` | 2 | ✅ 已修復 |
| `api/routers/file_audit.py` | 2 | ✅ 已修復 |
| `api/routers/rbac.py` | 5 | ✅ 已修復 |
| `api/routers/security_group.py` | 7 | ✅ 已修復 |
| `api/routers/service_alert.py` | 8 | ✅ 已修復 |
| `api/routers/system_admin.py` | 7 | ✅ 已修復 |
| `api/routers/system_config.py` | 10 | ✅ 已修復 |
| `api/routers/user_sessions.py` | 5 | ✅ 已修復 |
| `api/routers/service_monitor.py` | 9 | ✅ 已修復 |
| `api/routers/user_account.py` | 10 | ✅ 已修復 |
| **總計** | **72** | **✅ 全部完成** |

---

## 驗證結果

### 1. 代碼質量檢查

```bash
# Ruff 檢查
$ ruff check --fix api/routers/*.py
✓ All checks passed!

# 導入測試
$ python -c "from api.routers import agent_registration, audit_log, ..."
✓ All router imports successful
```

### 2. 後端啟動

```bash
$ uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload
✓ Backend started successfully
✓ Health check: {"status":"healthy","service":"api"}
```

### 3. API 端點測試

```bash
# 測試服務狀態 API
$ curl http://localhost:8000/api/v1/admin/services
✓ {"success":true,"message":"Services retrieved successfully","data":{"services":[],"total":0}}
```

---

## 其他相關修復

在同一次修復中，還解決了以下問題：

### 1. 前端返回按鈕導航問題

**問題**: 系統管理頁面的返回按鈕導航到歡迎頁 (`/`) 而不是原進入點

**修復**: 將 `navigate('/')` 改為 `navigate('/home')` 在以下文件：

- `SystemServiceStatus.tsx`
- `AccountSecuritySettings.tsx`
- `AgentRequestManagement.tsx`
- `SystemSettings.tsx`

### 2. 主題未跟隨系統偏好

**問題**: 應用主題不跟隨系統深色模式設置

**修復**:

- **`useTheme.ts`**: 添加系統主題檢測 (`window.matchMedia`)
- **`SystemServiceStatus.tsx`**: 添加 `dark:` Tailwind 類支持深色模式

### 3. PWA 緩存問題

**修復**: 在 `service-worker.js` 中臨時禁用緩存以便調試

- 添加 `DISABLE_CACHE = true` 標誌
- 更新 `CACHE_NAME` 到 `aibox-admin-v3`

---

## 經驗教訓

1. **避免使用 `functools.partial` 與 FastAPI 依賴注入**
   - `partial` 不適用於 `async def` 依賴函數
   - 應該創建專門的包裝函數

2. **統一權限檢查邏輯**
   - 所有需要系統管理員權限的端點使用相同的 `require_system_admin` 函數
   - 便於維護和修改

3. **批量修復的挑戰**
   - 多個文件需要同步修改時，容易遺漏導入
   - 應該使用腳本工具自動化批量修復

4. **測試的重要性**
   - 修復後立即進行導入測試和啟動測試
   - 避免部署後才發現問題

---

## 後續建議

1. **添加單元測試**
   - 為 `require_system_admin` 添加單元測試
   - 測試各種權限場景（開發模式、生產模式、RBAC 啟用/禁用）

2. **代碼審查清單**
   - 在 PR 審查時檢查是否有 `functools.partial` 用於依賴注入
   - 確保所有依賴函數都是 `async def`

3. **文檔更新**
   - 更新開發規範文檔，說明正確的權限檢查方式
   - 添加常見錯誤和解決方案

4. **監控與告警**
   - 添加 API 超時監控
   - 當超時率超過閾值時自動告警

---

## 附錄：修復腳本

### 批量替換 `partial` 調用的 Python 腳本

```python
#!/usr/bin/env python3
import re
from pathlib import Path

def fix_file(filepath):
    """修復單個文件中的 partial 調用"""
    path = Path(filepath)
    content = path.read_text(encoding='utf-8')

    # 替換 partial 調用
    pattern = r'Depends\(\s*partial\(require_permission,\s*Permission\.ALL\.value\)\s*\)'
    replacement = r'Depends(require_system_admin)'
    content = re.sub(pattern, replacement, content)

    # 移除 partial 導入
    content = re.sub(r'from functools import partial\n', '', content)

    path.write_text(content, encoding='utf-8')
    print(f"✓ Fixed {path.name}")

# 使用方式
# fix_file("/path/to/router.py")
```

---

**修復完成時間**: 2026-01-18 11:55 UTC+8
**後端狀態**: ✅ 正常運行
**前端狀態**: ✅ 正常運行（需要用戶刷新瀏覽器）
