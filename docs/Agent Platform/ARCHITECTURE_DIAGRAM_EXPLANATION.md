# AI-Box Agent Platform 架構設計圖說明

**創建日期**: 2025-01-27
**創建人**: Daniel Chung
**最後修改日期**: 2025-01-27
**對應文檔**: `docs/AGENT_DEVELOPMENT_GUIDE.md`

---

## 目錄

1. [整體架構概述](#1-整體架構概述)
2. [協調層詳細說明](#2-協調層詳細說明)
3. [執行層詳細說明](#3-執行層詳細說明)
4. [基礎設施層詳細說明](#4-基礎設施層詳細說明)
5. [通信協議與數據流](#5-通信協議與數據流)
6. [架構設計原則](#6-架構設計原則)

---

## 1. 整體架構概述

### 1.1 三層架構設計

AI-Box Agent Platform 採用**三層分離架構**，從上到下分別是：

```
┌─────────────────────────────────────────────────────────┐
│  第一層：協調層（AI-Box 內建服務）                      │
│  - 任務路由、調度、協調                                  │
└─────────────────────────────────────────────────────────┘
                        ↓ HTTP / MCP
┌─────────────────────────────────────────────────────────┐
│  第二層：執行層（獨立 Agent 服務）                        │
│  - 具體的 Agent 邏輯實現                                 │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│  第三層：基礎設施層（共享資源）                          │
│  - 記憶、工具、LLM、數據庫                               │
└─────────────────────────────────────────────────────────┘
```

### 1.2 設計理念

**職責分離原則**:

- **協調層**: 負責"做什麼"和"誰來做"（What & Who）
- **執行層**: 負責"怎麼做"（How）
- **基礎設施層**: 提供"資源支持"（Resources）

**獨立部署原則**:

- 每一層都可以獨立部署和擴展
- 層與層之間通過標準協議通信
- 支持水平擴展和負載均衡

---

## 2. 協調層詳細說明

### 2.1 Agent Registry（註冊表）

**職責**:

- Agent 服務的註冊和發現
- 健康狀態監控
- 負載均衡和服務選擇

**核心功能**:

```
Agent Registry
├── 服務註冊
│   ├── 接收 Agent 註冊請求
│   ├── 驗證 Agent 信息
│   └── 存儲 Agent 元數據
│
├── 服務發現
│   ├── 根據 Agent 類型查詢
│   ├── 根據能力查詢
│   └── 根據狀態過濾
│
├── 健康監控
│   ├── 定期健康檢查
│   ├── 心跳監控
│   └── 自動故障轉移
│
└── 負載均衡
    ├── 根據負載選擇 Agent
    ├── 輪詢分配
    └── 最少連接分配
```

**數據結構**:

```python
AgentRegistryInfo {
    agent_id: str              # Agent 唯一標識
    agent_type: str            # Agent 類型
    status: AgentStatus        # 當前狀態（online/offline/busy）
    endpoints: AgentEndpoints  # 服務端點（HTTP/MCP）
    capabilities: List[str]    # 能力列表
    load: int                  # 當前負載
    last_heartbeat: datetime   # 最後心跳時間
}
```

**工作流程**:

1. Agent 啟動 → 向 Registry 註冊
2. Registry 驗證 → 存儲 Agent 信息
3. Registry 定期檢查 → 更新健康狀態
4. 其他服務查詢 → Registry 返回可用 Agent

### 2.2 Agent Orchestrator（協調器）

**職責**:

- 任務路由和分發
- 任務執行協調
- 結果聚合和管理

**核心功能**:

```
Agent Orchestrator
├── 任務路由
│   ├── 分析任務類型
│   ├── 選擇合適的 Agent
│   └── 路由到目標 Agent
│
├── 任務分發
│   ├── 創建任務請求
│   ├── 調用 Agent Service
│   └── 處理異步任務
│
├── 執行協調
│   ├── 管理任務狀態
│   ├── 處理任務依賴
│   └── 協調多 Agent 協作
│
└── 結果聚合
    ├── 收集執行結果
    ├── 合併多個結果
    └── 返回最終結果
```

**工作流程**:

```
用戶請求
    ↓
Task Analyzer 分析任務
    ↓
Orchestrator 選擇 Agent
    ↓
通過 Registry 獲取 Agent Client
    ↓
調用 Agent Service
    ↓
收集結果並返回
```

### 2.3 Task Analyzer（任務分析器）

**職責**:

- 任務分類和解析
- Agent 選擇策略
- 任務優先級管理

**核心功能**:

```
Task Analyzer
├── 任務分類
│   ├── 識別任務類型
│   ├── 提取任務特徵
│   └── 確定任務需求
│
├── Agent 選擇
│   ├── 匹配 Agent 能力
│   ├── 評估 Agent 狀態
│   └── 選擇最佳 Agent
│
└── 優先級管理
    ├── 設置任務優先級
    ├── 調度任務執行
    └── 處理優先級衝突
```

**任務分類示例**:

```python
任務類型映射:
- "planning" → Planning Agent
- "execution" → Execution Agent
- "review" → Review Agent
- "research" → Research Agent
- "custom" → Custom Agent
```

---

## 3. 執行層詳細說明

### 3.1 Planning Agent Service（計劃 Agent）

**職責**:

- 生成任務執行計劃
- 驗證計劃可行性
- 優化計劃結構

**典型工作流程**:

```
接收任務
    ↓
分析任務需求
    ↓
生成執行計劃
    ↓
驗證計劃可行性
    ↓
返回計劃結果
```

**輸入/輸出**:

```python
輸入: {
    "task": "研究 AI 最新趨勢",
    "context": {...},
    "requirements": [...]
}

輸出: {
    "plan_id": "plan-123",
    "steps": [
        {"step": 1, "action": "搜索相關論文"},
        {"step": 2, "action": "分析數據"},
        {"step": 3, "action": "生成報告"}
    ],
    "estimated_duration": 3600
}
```

### 3.2 Execution Agent Service（執行 Agent）

**職責**:

- 執行具體任務
- 管理執行狀態
- 處理執行錯誤

**典型工作流程**:

```
接收執行請求
    ↓
解析任務步驟
    ↓
按順序執行步驟
    ↓
記錄執行狀態
    ↓
返回執行結果
```

**狀態管理**:

```python
執行狀態:
- PENDING: 等待執行
- RUNNING: 執行中
- COMPLETED: 執行完成
- FAILED: 執行失敗
- CANCELLED: 已取消
```

### 3.3 Review Agent Service（審查 Agent）

**職責**:

- 審查執行結果
- 質量檢查
- 提供改進建議

**典型工作流程**:

```
接收審查請求
    ↓
分析執行結果
    ↓
檢查結果質量
    ↓
生成審查報告
    ↓
返回審查結果
```

**審查維度**:

- 完整性檢查
- 準確性驗證
- 一致性檢查
- 質量評分

### 3.4 Custom Agent Service（自定義 Agent）

**職責**:

- 實現團隊特定功能
- 處理業務邏輯
- 擴展平台能力

**特點**:

- 由協作夥伴團隊開發
- 獨立部署和運維
- 通過標準協議接入

**示例場景**:

- 數據分析 Agent
- 報告生成 Agent
- 特定領域專家 Agent

---

## 4. 基礎設施層詳細說明

### 4.1 Memory Manager（記憶管理）

**職責**:

- 管理 Agent 記憶
- 存儲對話歷史
- 提供記憶檢索

**功能模塊**:

```
Memory Manager
├── 短期記憶
│   ├── 會話記憶
│   └── 上下文記憶
│
├── 長期記憶
│   ├── 知識庫
│   └── 經驗庫
│
└── 記憶檢索
    ├── 語義搜索
    ├── 時間序列檢索
    └── 關聯檢索
```

**存儲方式**:

- ChromaDB: 向量記憶存儲
- ArangoDB: 圖結構記憶存儲
- Redis: 臨時記憶緩存

### 4.2 Tool Registry（工具註冊表）

**職責**:

- 註冊和管理工具
- 工具發現和調用
- 工具權限管理

**工具類型**:

```python
工具分類:
- 數據處理工具
- API 調用工具
- 文件操作工具
- 計算工具
- 自定義工具
```

**工具調用流程**:

```
Agent 請求工具
    ↓
Tool Registry 查找工具
    ↓
驗證工具權限
    ↓
執行工具邏輯
    ↓
返回工具結果
```

### 4.3 LLM Clients（LLM 客戶端）

**職責**:

- 管理多個 LLM 服務
- 負載均衡和故障轉移
- 統一 LLM 接口

**支持的 LLM**:

```
LLM Clients
├── OpenAI (GPT-4, GPT-3.5)
├── Anthropic (Claude)
├── Google (Gemini)
├── Qwen
├── Grok
└── Ollama (本地模型)
```

**功能特性**:

- MoE (Mixture of Experts) 路由
- 自動故障轉移
- 負載均衡
- 成本優化

### 4.4 Database（數據庫）

**職責**:

- 持久化數據存儲
- 數據查詢和管理
- 數據備份和恢復

**數據庫類型**:

```
Database Layer
├── ArangoDB (圖數據庫)
│   ├── 知識圖譜
│   └── 關係數據
│
├── ChromaDB (向量數據庫)
│   ├── 向量檢索
│   └── 語義搜索
│
└── PostgreSQL (關係數據庫)
    ├── 結構化數據
    └── 事務處理
```

---

## 5. 通信協議與數據流

### 5.1 HTTP REST API 通信流程

**請求流程**:

```
協調層 (Orchestrator)
    ↓ HTTP POST /v1/execute
    {
        "task_id": "task-123",
        "task_type": "planning",
        "task_data": {...}
    }
    ↓
執行層 (Agent Service)
    ↓ 處理任務
    ↓ HTTP 200 OK
    {
        "task_id": "task-123",
        "status": "success",
        "result": {...}
    }
    ↓
協調層 (Orchestrator)
```

**優點**:

- 簡單易用
- 標準化協議
- 易於調試
- 支持負載均衡

**適用場景**:

- 簡單的請求-響應
- 不需要實時通信
- 標準的 RESTful API

### 5.2 MCP Protocol 通信流程

**請求流程**:

```
協調層 (Orchestrator)
    ↓ WebSocket 連接
    ↓ MCP Request
    {
        "jsonrpc": "2.0",
        "method": "tools/call",
        "params": {
            "name": "execute_task",
            "arguments": {...}
        }
    }
    ↓
執行層 (Agent Service)
    ↓ 處理任務
    ↓ MCP Response
    {
        "jsonrpc": "2.0",
        "result": {
            "content": [...],
            "isError": false
        }
    }
    ↓
協調層 (Orchestrator)
```

**優點**:

- 高性能
- 低延遲
- 雙向通信
- 實時協作

**適用場景**:

- 需要實時狀態更新
- 複雜的 Agent 協作
- 高性能要求

### 5.3 數據流示例

**完整任務執行流程**:

```
1. 用戶請求
   ↓
2. Task Analyzer 分析任務
   ↓
3. Orchestrator 選擇 Agent
   ↓
4. Registry 查找可用 Agent
   ↓
5. 創建 Agent Service Client
   ↓
6. 通過 HTTP/MCP 調用 Agent
   ↓
7. Agent 執行任務
   ├── 使用 Memory Manager 檢索記憶
   ├── 使用 Tool Registry 調用工具
   ├── 使用 LLM Clients 生成內容
   └── 使用 Database 存儲數據
   ↓
8. Agent 返回結果
   ↓
9. Orchestrator 聚合結果
   ↓
10. 返回最終結果給用戶
```

---

## 6. 架構設計原則

### 6.1 分層原則

**清晰的分層邊界**:

- 每一層只與相鄰層通信
- 上層不直接訪問下層的實現細節
- 通過標準接口進行通信

**優點**:

- 降低耦合度
- 提高可維護性
- 支持獨立部署

### 6.2 服務化原則

**微服務架構**:

- 每個 Agent 是獨立的服務
- 服務之間通過協議通信
- 支持獨立擴展和部署

**優點**:

- 靈活的擴展性
- 獨立的技術棧選擇
- 故障隔離

### 6.3 協議標準化

**統一的協議接口**:

- Agent Service Protocol 標準接口
- HTTP 和 MCP 兩種協議支持
- 統一的數據模型

**優點**:

- 易於集成
- 降低開發成本
- 支持多團隊協作

### 6.4 可擴展性設計

**水平擴展**:

- 支持多實例部署
- 負載均衡
- 自動故障轉移

**垂直擴展**:

- 資源動態分配
- 性能優化
- 緩存機制

### 6.5 可靠性設計

**故障處理**:

- 健康檢查機制
- 自動故障轉移
- 重試機制
- 降級策略

**監控和日誌**:

- 完整的日誌記錄
- 性能監控
- 錯誤追蹤
- 告警機制

---

## 7. 架構優勢總結

### 7.1 對內部開發團隊

**優勢**:

- ✅ 直接訪問 AI-Box 內部服務
- ✅ 可以使用內部 SDK 和工具
- ✅ 緊密集成到 AI-Box 生態系統
- ✅ 快速開發和部署

**適用場景**:

- 核心 Agent 開發
- 與 AI-Box 深度集成
- 需要訪問內部資源

### 7.2 對協作夥伴團隊

**優勢**:

- ✅ 通過標準協議接入
- ✅ 獨立部署和運維
- ✅ 最小化對 AI-Box 的依賴
- ✅ 靈活的技術選擇

**適用場景**:

- 第三方 Agent 開發
- 獨立部署的服務
- 需要隔離的業務邏輯

### 7.3 整體架構優勢

**可擴展性**:

- 支持水平擴展
- 支持垂直擴展
- 靈活的資源分配

**可維護性**:

- 清晰的分層結構
- 標準化的接口
- 完善的文檔

**可靠性**:

- 故障隔離
- 自動恢復
- 完善的監控

**靈活性**:

- 多協議支持
- 多技術棧支持
- 快速集成

---

**文檔結束**
