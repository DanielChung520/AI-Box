# 實體匹配問題分析

**創建日期**: 2026-01-05
**創建人**: Daniel Chung
**最後修改日期**: 2026-01-05

---

## 📋 問題概述

在 HybridRAG 系統的圖檢索功能中，實體匹配返回 0 個結果。本文檔分析問題的根本原因和解決方案。

---

## 🔍 問題定位

### 1. 當前匹配策略

**策略類型**: 文字比對（Text-based Matching）

**實現位置**: `genai/workflows/rag/hybrid_rag.py:_find_matching_entities()`

**匹配邏輯**:
```python
aql = """FOR doc IN entities
FILTER doc.name == @entity_name
   OR doc.name LIKE CONCAT("%", @entity_name, "%")
   OR CONTAINS(LOWER(doc.name), LOWER(@entity_name))
RETURN doc"""
```

**匹配方式**:
1. **精確匹配**: `doc.name == @entity_name`
2. **模糊匹配**: `doc.name LIKE CONCAT("%", @entity_name, "%")`
3. **包含匹配**: `CONTAINS(LOWER(doc.name), LOWER(@entity_name))`

### 2. 問題分析

**測試案例**:
- NER 提取的實體: 「中国预制菜产业」
- 實體類型: Industry
- 查詢結果: 0 個匹配的實體

**根本原因**:
1. **實體名稱長度不匹配**: NER 提取的實體名稱「中国预制菜产业」是一個完整的短語，而 ArangoDB 中存儲的實體可能是更細粒度的單詞，如「预制菜」、「市场」、「规模」等。
2. **匹配策略限制**: 當前的文字比對策略無法匹配部分相關的實體。
3. **缺少語義匹配**: 系統未實現語義相似度匹配，無法匹配語義相關但文字不同的實體。

---

## 📊 匹配策略對比

### 文字比對（Text-based Matching）

**優點**:
- ✅ 簡單、快速、準確
- ✅ 不需要額外的計算資源
- ✅ 適合精確匹配場景

**缺點**:
- ❌ 無法匹配語義相關但文字不同的實體
- ❌ 長實體名稱無法匹配短實體名稱
- ❌ 對同義詞、變體不敏感

**適用場景**:
- 精確的實體名稱匹配
- 已知實體名稱格式的場景
- 需要快速匹配的場景

### 語義比對（Semantic Matching）

**優點**:
- ✅ 可以匹配語義相關但文字不同的實體
- ✅ 對同義詞、變體敏感
- ✅ 可以匹配部分相關的實體

**缺點**:
- ❌ 需要實體名稱的向量表示
- ❌ 計算複雜度高
- ❌ 需要 Embedding 模型

**適用場景**:
- 語義相關的實體匹配
- 實體名稱格式不確定的場景
- 需要更高召回率的場景

---

## 💡 解決方案

### 方案 1: 關鍵詞匹配（推薦 - 短期）

**策略**: 將實體文本拆分為關鍵詞，使用關鍵詞進行匹配

**實現**:
```python
def _find_matching_entities(self, entities: List[Any], limit: int = 20) -> List[Dict[str, Any]]:
    """在 ArangoDB 中查找匹配的實體"""
    matched_entities = []
    
    for entity in entities:
        entity_text = entity.text if hasattr(entity, "text") else str(entity)
        
        # 先嘗試完整匹配
        results = self._query_entities_by_name(entity_text, limit)
        
        # 如果沒有結果，嘗試關鍵詞匹配
        if not results:
            keywords = self._extract_keywords(entity_text)
            for keyword in keywords:
                keyword_results = self._query_entities_by_name(keyword, limit)
                results.extend(keyword_results)
                if len(results) >= limit:
                    break
        
        matched_entities.extend(results)
        if len(matched_entities) >= limit:
            break
    
    return matched_entities[:limit]
```

**優點**:
- ✅ 簡單、快速實現
- ✅ 可以匹配部分相關的實體
- ✅ 不需要額外的計算資源

**缺點**:
- ❌ 關鍵詞提取可能不準確
- ❌ 仍然無法匹配語義相關但文字不同的實體

### 方案 2: 語義匹配（長期）

**策略**: 使用 Embedding 模型計算實體名稱的語義相似度

**實現**:
```python
def _find_matching_entities_semantic(self, entities: List[Any], limit: int = 20) -> List[Dict[str, Any]]:
    """使用語義匹配查找實體"""
    matched_entities = []
    
    for entity in entities:
        entity_text = entity.text if hasattr(entity, "text") else str(entity)
        
        # 生成實體文本的向量
        entity_embedding = self._generate_embedding(entity_text)
        
        # 使用向量相似度搜索（需要實體名稱的向量索引）
        # 這需要預先為實體名稱生成向量並建立索引
        
        # 或者使用 ChromaDB 的語義搜索功能
        # 但這需要實體名稱存儲在 ChromaDB 中
        
    return matched_entities[:limit]
```

**優點**:
- ✅ 可以匹配語義相關但文字不同的實體
- ✅ 對同義詞、變體敏感
- ✅ 可以匹配部分相關的實體

**缺點**:
- ❌ 需要實體名稱的向量表示
- ❌ 計算複雜度高
- ❌ 需要額外的存儲和計算資源

### 方案 3: 混合策略（推薦 - 長期）

**策略**: 結合文字比對和語義匹配

**實現流程**:
1. 先嘗試文字比對（精確匹配、模糊匹配）
2. 如果結果不足，使用關鍵詞匹配
3. 如果仍然不足，使用語義匹配（未來實現）

**優點**:
- ✅ 結合兩種策略的優點
- ✅ 可以逐步實現
- ✅ 平衡準確性和召回率

**缺點**:
- ❌ 實現複雜度較高
- ❌ 需要多種匹配策略的協調

---

## 📝 建議實施方案

### 短期（立即可實施）

1. **實施關鍵詞匹配**:
   - 將實體文本拆分為關鍵詞
   - 使用關鍵詞進行模糊匹配
   - 合併匹配結果

2. **優化匹配邏輯**:
   - 改進關鍵詞提取邏輯
   - 添加匹配結果去重
   - 優化匹配順序

### 長期（未來實施）

1. **實施語義匹配**:
   - 為實體名稱生成向量
   - 建立向量索引
   - 實現語義相似度搜索

2. **實施混合策略**:
   - 結合文字比對和語義匹配
   - 根據場景選擇匹配策略
   - 優化匹配性能

---

## 🔗 相關文檔

- `docs/系统设计文档/核心组件/文件上傳向量圖譜/向量與圖檢索混合查詢邏輯.md`
- `docs/向量索引功能說明.md`

---

**最後更新日期**: 2026-01-05
**維護人**: Daniel Chung

