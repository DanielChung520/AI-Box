# 工具組開發規格

**創建日期**: 2025-12-30
**創建人**: Daniel Chung
**最後修改日期**: 2025-12-30

**關聯文檔**: [工具組需求分析](./工具組需求分析.md)

---

## 📋 規格概述

本文檔定義了 AI-Box 工具組（Tools）的技術規格、架構設計和實現細節。

---

## 🏗️ 架構設計

### 目錄結構

請在專案根目錄下增加tools/

```
tools/
├── __init__.py                 # 工具組初始化，導出主要接口
├── base.py                     # 工具基類定義
├── registry.py                 # 工具註冊表
├── time/                       # 時間與日期工具
│   ├── __init__.py
│   ├── datetime_tool.py        # 日期時間工具
│   ├── formatter.py            # 日期格式化工具
│   └── calculator.py           # 日期計算工具
├── weather/                    # 天氣工具
│   ├── __init__.py
│   ├── weather_tool.py         # 天氣查詢工具
│   ├── forecast_tool.py        # 天氣預報工具
│   └── providers/              # 天氣 API 提供商
│       ├── __init__.py
│       ├── base.py             # 天氣提供商基類
│       ├── openweathermap.py   # OpenWeatherMap 提供商
│       └── accuweather.py      # AccuWeather 提供商
├── location/                   # 地理位置工具
│   ├── __init__.py
│   ├── ip_location.py          # IP 地址定位
│   ├── geocoding.py            # 地理編碼
│   ├── distance.py             # 距離計算
│   └── timezone.py             # 時區查詢
├── conversion/                 # 單位轉換工具（第二階段）
│   ├── __init__.py
│   ├── length.py              # 長度單位轉換
│   ├── weight.py               # 重量單位轉換
│   ├── temperature.py          # 溫度單位轉換
│   └── currency.py             # 貨幣轉換
├── calculator/                 # 計算工具（第二階段）
│   ├── __init__.py
│   ├── math_calculator.py     # 數學計算
│   └── statistics.py           # 統計計算
├── text/                       # 文本處理工具（第二階段）
│   ├── __init__.py
│   ├── formatter.py            # 文本格式化
│   ├── cleaner.py              # 文本清理
│   └── converter.py            # 文本轉換
└── utils/                      # 工具組通用工具
    ├── __init__.py
    ├── cache.py                # 緩存工具
    ├── validator.py            # 參數驗證工具
    └── errors.py               # 錯誤定義
```

### 核心組件設計

#### 1. 工具基類（Base Tool）

所有工具都必須繼承自 `BaseTool` 基類，實現統一的接口規範。

```python
from abc import ABC, abstractmethod
from typing import Any, Dict, Optional
from pydantic import BaseModel

class ToolInput(BaseModel):
    """工具輸入參數基類"""
    pass

class ToolOutput(BaseModel):
    """工具輸出結果基類"""
    pass

class BaseTool(ABC):
    """工具基類"""

    @property
    @abstractmethod
    def name(self) -> str:
        """工具名稱"""
        pass

    @property
    @abstractmethod
    def description(self) -> str:
        """工具描述"""
        pass

    @property
    @abstractmethod
    def version(self) -> str:
        """工具版本"""
        pass

    @abstractmethod
    async def execute(self, input_data: ToolInput) -> ToolOutput:
        """
        執行工具

        Args:
            input_data: 工具輸入參數

        Returns:
            工具輸出結果
        """
        pass

    def validate_input(self, input_data: Dict[str, Any]) -> ToolInput:
        """
        驗證輸入參數

        Args:
            input_data: 原始輸入參數

        Returns:
            驗證後的輸入參數

        Raises:
            ValidationError: 輸入參數驗證失敗
        """
        pass
```

#### 2. 工具註冊表（Tool Registry）

工具註冊表負責管理所有工具，支持動態註冊和查詢。

```python
from typing import Dict, List, Optional
from tools.base import BaseTool

class ToolRegistry:
    """工具註冊表"""

    def __init__(self):
        self._tools: Dict[str, BaseTool] = {}

    def register(self, tool: BaseTool) -> None:
        """
        註冊工具

        Args:
            tool: 工具實例
        """
        if tool.name in self._tools:
            raise ValueError(f"Tool '{tool.name}' already registered")
        self._tools[tool.name] = tool

    def get_tool(self, name: str) -> Optional[BaseTool]:
        """
        獲取工具

        Args:
            name: 工具名稱

        Returns:
            工具實例，如果不存在返回 None
        """
        return self._tools.get(name)

    def list_tools(self) -> List[str]:
        """
        列出所有工具名稱

        Returns:
            工具名稱列表
        """
        return list(self._tools.keys())

    def unregister(self, name: str) -> bool:
        """
        取消註冊工具

        Args:
            name: 工具名稱

        Returns:
            是否成功取消註冊
        """
        if name in self._tools:
            del self._tools[name]
            return True
        return False
```

---

## 🔧 工具實現規格

### 1. 時間與日期工具（Time Tools）

#### 1.0 時間服務（TimeService）

**文件**: `tools/time/smart_time_service.py`

**功能**：

- 使用緩存機制提供高精度時間
- 減少系統調用開銷（每 100ms 更新一次系統時間）
- 使用 `time.perf_counter()` 計算經過的時間，提供高精度

**設計特點**：

1. **緩存機制**：

   - 每 100ms（可配置）更新一次系統時間
   - 其餘時間使用 `time.perf_counter()` 計算經過的時間
   - 減少頻繁的系統調用，提高性能
2. **高精度**：

   - 使用 `time.perf_counter()` 提供微秒級精度
   - 避免系統時間調整導致的時間跳躍
3. **線程安全**：

   - 使用 Lock 保護共享狀態
   - 支持多線程環境下的安全使用

**使用方式**：

```python
from tools.time.smart_time_service import get_time_service

# 獲取服務實例（單例模式）
time_service = get_time_service()

# 獲取當前時間
current_time = time_service.now()  # Unix 時間戳
current_datetime = time_service.now_datetime()  # datetime 對象（本地時區）
current_utc_datetime = time_service.now_utc_datetime()  # UTC datetime 對象
```

**配置參數**：

```python
TimeService(
    cache_duration=0.1  # 緩存持續時間（秒），默認 0.1 秒（100ms）
)
```

**性能特點**：

- 減少系統調用：每 100ms 才調用一次 `time.time()`
- 高精度：使用 `time.perf_counter()` 提供微秒級精度
- 低開銷：緩存機制大幅減少系統調用開銷

#### 1.1 日期時間工具（DateTimeTool）

**文件**: `tools/time/datetime_tool.py`

**功能**：

- 獲取當前日期時間（UTC 和本地時區）
- 時區轉換
- 日期時間格式化
- 從配置服務讀取默認格式和時區設置
- **使用 TimeService 獲取高精度時間**

**配置管理**：

日期格式化配置通過 `ConfigStoreService` 存儲在 ArangoDB 中，支持三層配置：

- **系統級配置**（`system_configs`）：默認的日期格式、時區、語言環境
  - Scope: `tools.datetime`
  - 配置內容：

    ```json
    {
      "default_format": "%Y-%m-%d %H:%M:%S",
      "default_timezone": "UTC",
      "default_locale": "en_US",
      "iso_format": "%Y-%m-%dT%H:%M:%S%z",
      "date_only_format": "%Y-%m-%d",
      "time_only_format": "%H:%M:%S"
    }
    ```

- **租戶級配置**（`tenant_configs`）：租戶特定的格式（如不同地區的日期格式）
  - Scope: `tools.datetime`
  - 可以覆蓋系統級配置
- **用戶級配置**（`user_configs`）：用戶個性化格式
  - Scope: `tools.datetime`
  - 優先級最高，可以覆蓋租戶和系統級配置

**配置讀取邏輯**：

```python
from services.api.services.config_store_service import get_config_store_service

# 讀取有效配置（自動合併 system > tenant > user）
config_service = get_config_store_service()
effective_config = config_service.get_effective_config(
    scope="tools.datetime",
    tenant_id=tenant_id,
    user_id=user_id
)

# 使用配置中的默認值
default_format = effective_config.config_data.get("default_format", "%Y-%m-%d %H:%M:%S")
default_timezone = effective_config.config_data.get("default_timezone", "UTC")
```

**輸入參數**：

```python
class DateTimeInput(ToolInput):
    """日期時間工具輸入參數"""
    timezone: Optional[str] = None  # 時區（如 "Asia/Taipei"），None 表示使用配置中的默認時區
    format: Optional[str] = None   # 輸出格式（如 "%Y-%m-%d %H:%M:%S"），None 表示使用配置中的默認格式
    tenant_id: Optional[str] = None  # 租戶 ID（用於讀取租戶級配置）
    user_id: Optional[str] = None    # 用戶 ID（用於讀取用戶級配置）
```

**輸出結果**：

```python
class DateTimeOutput(ToolOutput):
    """日期時間工具輸出結果"""
    datetime: str                  # 格式化後的日期時間字符串
    timestamp: float               # Unix 時間戳
    timezone: str                  # 時區名稱
    iso_format: str                # ISO 8601 格式
    local_format: str              # 本地格式
```

**使用示例**：

```python
from tools.time import DateTimeTool
from tools.time.smart_time_service import get_time_service

# 使用默認配置（從 ConfigStoreService 讀取）
tool = DateTimeTool()
result = await tool.execute(DateTimeInput(
    tenant_id="tenant_123",
    user_id="user_456"
))
print(result.datetime)  # 使用配置中的默認格式

# 覆蓋配置中的格式
result = await tool.execute(DateTimeInput(
    timezone="Asia/Taipei",
    format="%Y-%m-%d %H:%M:%S",
    tenant_id="tenant_123"
))
print(result.datetime)  # 2025-12-30 10:43:26

# 直接使用 TimeService 獲取高精度時間
time_service = get_time_service()
current_time = time_service.now()  # Unix 時間戳
current_datetime = time_service.now_datetime()  # datetime 對象
print(f"Current time: {current_datetime}")
```

#### 1.2 日期格式化工具（DateFormatter）

**文件**: `tools/time/formatter.py`

**功能**：

- 日期格式化
- 日期解析

**輸入參數**：

```python
class FormatInput(ToolInput):
    """日期格式化輸入參數"""
    date: str                      # 日期字符串或 ISO 8601 格式
    format: str                    # 目標格式（如 "%Y年%m月%d日"）
    source_format: Optional[str] = None  # 源格式（如果 date 不是 ISO 8601）
```

**輸出結果**：

```python
class FormatOutput(ToolOutput):
    """日期格式化輸出結果"""
    formatted: str                 # 格式化後的日期字符串
    iso_format: str                # ISO 8601 格式
    timestamp: float               # Unix 時間戳
```

#### 1.3 日期計算工具（DateCalculator）

**文件**: `tools/time/calculator.py`

**功能**：

- 日期差值計算
- 日期加減運算
- 工作日計算

**輸入參數**：

```python
class CalculateInput(ToolInput):
    """日期計算輸入參數"""
    operation: str                 # 操作類型：add, subtract, diff
    date1: str                     # 第一個日期（ISO 8601）
    date2: Optional[str] = None    # 第二個日期（用於 diff 操作）
    days: Optional[int] = None     # 天數（用於 add/subtract）
    months: Optional[int] = None   # 月數（用於 add/subtract）
    years: Optional[int] = None    # 年數（用於 add/subtract）
```

**輸出結果**：

```python
class CalculateOutput(ToolOutput):
    """日期計算輸出結果"""
    result: str                    # 計算結果（ISO 8601 格式）
    days_diff: Optional[int] = None  # 天數差值（diff 操作）
    hours_diff: Optional[float] = None  # 小時差值（diff 操作）
```

---

### 2. 天氣工具（Weather Tools）

#### 2.1 天氣查詢工具（WeatherTool）

**文件**: `tools/weather/weather_tool.py`

**功能**：

- 根據城市名稱獲取當前天氣
- 根據經緯度獲取當前天氣
- 支持多種天氣 API 提供商

**輸入參數**：

```python
class WeatherInput(ToolInput):
    """天氣查詢輸入參數"""
    city: Optional[str] = None     # 城市名稱（如 "Taipei"）
    lat: Optional[float] = None    # 緯度
    lon: Optional[float] = None    # 經度
    units: str = "metric"          # 單位：metric (攝氏度), imperial (華氏度)
    provider: Optional[str] = None  # 天氣 API 提供商（如 "openweathermap"）
```

**輸出結果**：

```python
class WeatherOutput(ToolOutput):
    """天氣查詢輸出結果"""
    city: str                      # 城市名稱
    country: str                   # 國家代碼
    temperature: float             # 溫度
    feels_like: float             # 體感溫度
    humidity: int                  # 濕度（百分比）
    pressure: int                  # 氣壓（hPa）
    description: str               # 天氣描述
    icon: str                      # 天氣圖標代碼
    wind_speed: float             # 風速
    wind_direction: int           # 風向（度數）
    visibility: Optional[int] = None  # 能見度（米）
    uv_index: Optional[float] = None  # UV 指數
    timestamp: float              # 數據時間戳
```

**提供商接口**：

```python
class WeatherProvider(ABC):
    """天氣 API 提供商基類"""

    @abstractmethod
    async def get_current_weather(
        self,
        city: Optional[str] = None,
        lat: Optional[float] = None,
        lon: Optional[float] = None,
        units: str = "metric"
    ) -> WeatherOutput:
        """獲取當前天氣"""
        pass
```

**緩存策略**：

- 使用 Redis 緩存天氣數據
- 緩存時間：10 分鐘（當前天氣）
- 緩存鍵格式：`weather:{city}:{lat}:{lon}`

#### 2.2 天氣預報工具（ForecastTool）

**文件**: `tools/weather/forecast_tool.py`

**功能**：

- 獲取未來幾天的天氣預報
- 獲取小時級別預報

**輸入參數**：

```python
class ForecastInput(ToolInput):
    """天氣預報輸入參數"""
    city: Optional[str] = None
    lat: Optional[float] = None
    lon: Optional[float] = None
    days: int = 3                 # 預報天數（1-7）
    hourly: bool = False          # 是否獲取小時級別預報
    units: str = "metric"
    provider: Optional[str] = None
```

**輸出結果**：

```python
class ForecastOutput(ToolOutput):
    """天氣預報輸出結果"""
    city: str
    country: str
    forecasts: List[ForecastItem]  # 預報列表

class ForecastItem(BaseModel):
    """單個預報項"""
    date: str                      # 日期（ISO 8601）
    temperature: float             # 溫度
    min_temp: float               # 最低溫度
    max_temp: float               # 最高溫度
    description: str               # 天氣描述
    icon: str                      # 天氣圖標
    humidity: int                  # 濕度
    wind_speed: float             # 風速
    precipitation: Optional[float] = None  # 降水量（mm）
    hourly: Optional[List[HourlyForecast]] = None  # 小時級別預報
```

---

### 3. 地理位置工具（Location Tools）

#### 3.1 IP 地址定位工具（IPLocationTool）

**文件**: `tools/location/ip_location.py`

**功能**：

- 根據 IP 地址獲取地理位置信息

**輸入參數**：

```python
class IPLocationInput(ToolInput):
    """IP 定位輸入參數"""
    ip: str                        # IP 地址（IPv4 或 IPv6）
    provider: Optional[str] = None  # IP 定位服務提供商
```

**輸出結果**：

```python
class IPLocationOutput(ToolOutput):
    """IP 定位輸出結果"""
    ip: str                        # IP 地址
    country: str                   # 國家名稱
    country_code: str              # 國家代碼（ISO 3166-1 alpha-2）
    region: Optional[str] = None  # 地區/州
    city: Optional[str] = None     # 城市
    latitude: Optional[float] = None  # 緯度
    longitude: Optional[float] = None  # 經度
    timezone: Optional[str] = None  # 時區
    isp: Optional[str] = None      # ISP 提供商
    org: Optional[str] = None     # 組織
```

**提供商**：

- ipapi.co（免費，有限制）
- ip-api.com（免費，有限制）
- MaxMind GeoIP2（商業）

**緩存策略**：

- 緩存時間：24 小時（IP 地址地理位置變化較少）
- 緩存鍵格式：`ip_location:{ip}`

#### 3.2 地理編碼工具（GeocodingTool）

**文件**: `tools/location/geocoding.py`

**功能**：

- 正向地理編碼（地址 → 坐標）
- 反向地理編碼（坐標 → 地址）

**輸入參數**：

```python
class GeocodingInput(ToolInput):
    """地理編碼輸入參數"""
    address: Optional[str] = None  # 地址（正向編碼）
    lat: Optional[float] = None    # 緯度（反向編碼）
    lon: Optional[float] = None    # 經度（反向編碼）
    language: str = "zh-TW"        # 結果語言
    provider: Optional[str] = None  # 地理編碼服務提供商
```

**輸出結果**：

```python
class GeocodingOutput(ToolOutput):
    """地理編碼輸出結果"""
    address: str                   # 完整地址
    formatted_address: str         # 格式化地址
    latitude: float                # 緯度
    longitude: float               # 經度
    country: str                   # 國家
    country_code: str              # 國家代碼
    region: Optional[str] = None    # 地區
    city: Optional[str] = None      # 城市
    district: Optional[str] = None  # 區/縣
    street: Optional[str] = None    # 街道
    postal_code: Optional[str] = None  # 郵政編碼
    place_id: Optional[str] = None  # 地點 ID（某些提供商）
```

**提供商**：

- Google Maps Geocoding API（需要 API Key）
- OpenStreetMap Nominatim（免費，有限制）
- Mapbox Geocoding API（需要 API Key）

#### 3.3 距離計算工具（DistanceTool）

**文件**: `tools/location/distance.py`

**功能**：

- 計算兩個地理位置之間的距離
- 支持多種距離計算方法

**輸入參數**：

```python
class DistanceInput(ToolInput):
    """距離計算輸入參數"""
    lat1: float                    # 起點緯度
    lon1: float                    # 起點經度
    lat2: float                    # 終點緯度
    lon2: float                    # 終點經度
    method: str = "haversine"      # 計算方法：haversine, driving, walking
    unit: str = "km"               # 單位：km, mile, meter
    provider: Optional[str] = None  # 地圖服務提供商（用於 driving/walking）
```

**輸出結果**：

```python
class DistanceOutput(ToolOutput):
    """距離計算輸出結果"""
    distance: float                # 距離（指定單位）
    distance_km: float             # 距離（公里）
    distance_mile: float           # 距離（英里）
    method: str                    # 使用的計算方法
    duration: Optional[float] = None  # 預計時間（秒，僅 driving/walking）
    route: Optional[Dict[str, Any]] = None  # 路線信息（僅 driving/walking）
```

**計算方法**：

- **Haversine**：直線距離（大圓距離），不需要 API
- **Driving**：駕車距離，需要地圖 API（Google Maps、Mapbox）
- **Walking**：步行距離，需要地圖 API

#### 3.4 時區查詢工具（TimezoneTool）

**文件**: `tools/location/timezone.py`

**功能**：

- 根據地理位置獲取時區信息

**輸入參數**：

```python
class TimezoneInput(ToolInput):
    """時區查詢輸入參數"""
    lat: float                     # 緯度
    lon: float                     # 經度
    timestamp: Optional[float] = None  # 時間戳（用於歷史時區查詢）
```

**輸出結果**：

```python
class TimezoneOutput(ToolOutput):
    """時區查詢輸出結果"""
    timezone: str                  # 時區名稱（如 "Asia/Taipei"）
    offset: int                    # UTC 偏移量（秒）
    offset_hours: float           # UTC 偏移量（小時）
    dst: bool                      # 是否使用夏令時
    abbreviation: str              # 時區縮寫（如 "CST"）
```

---

## 🔌 集成接口

### 1. MCP Server 集成

工具可以通過 MCP Server 暴露給外部系統使用。

```python
from mcp.server.tools import register_tool
from tools.time import DateTimeTool

# 註冊工具到 MCP Server
register_tool(DateTimeTool())
```

### 2. Agent 平台集成

工具可以通過 Agent 平台的工具註冊表使用。

```python
from agents.services.tool_registry import ToolRegistry
from tools.time import DateTimeTool

# 註冊工具到 Agent 平台
registry = ToolRegistry()
registry.register(DateTimeTool())
```

### 3. API 路由集成

工具可以通過 FastAPI 路由暴露為 REST API。

```python
from fastapi import APIRouter
from tools.time import DateTimeTool

router = APIRouter()
tool = DateTimeTool()

@router.post("/tools/time/datetime")
async def get_datetime(input_data: dict):
    result = await tool.execute(DateTimeInput(**input_data))
    return result.dict()
```

---

## ⚙️ 配置管理

### 時間服務配置

**TimeService 配置**：

TimeService 的配置可以通過代碼參數設置：

```python
from tools.time.smart_time_service import TimeService

# 自定義緩存持續時間
time_service = TimeService(cache_duration=0.1)  # 100ms 緩存
```

**配置參數**：

- `cache_duration`: 緩存持續時間（秒），默認 0.1 秒（100ms）
  - 較小的值：更頻繁更新系統時間，精度更高但開銷更大
  - 較大的值：減少系統調用，性能更好但精度略低

**依賴要求**：

- 無額外依賴，僅使用 Python 標準庫（`time`, `datetime`, `threading`）

### 日期格式化配置

日期格式化配置通過 `ConfigStoreService` 存儲在 ArangoDB 中，**不使用 `config.json` 文件**。

**配置 Scope**: `tools.datetime`

**配置層級**：

- **系統級**（`system_configs`）：默認配置，所有用戶共享
- **租戶級**（`tenant_configs`）：租戶特定配置，可覆蓋系統級
- **用戶級**（`user_configs`）：用戶個性化配置，優先級最高

**配置數據結構**：

```json
{
  "default_format": "%Y-%m-%d %H:%M:%S",
  "default_timezone": "UTC",
  "default_locale": "en_US",
  "iso_format": "%Y-%m-%dT%H:%M:%S%z",
  "date_only_format": "%Y-%m-%d",
  "time_only_format": "%H:%M:%S",
  "localized_formats": {
    "zh_TW": "%Y年%m月%d日 %H:%M:%S",
    "en_US": "%B %d, %Y %I:%M:%S %p",
    "ja_JP": "%Y年%m月%d日 %H時%M分%S秒"
  }
}
```

**配置讀取示例**：

```python
from services.api.services.config_store_service import get_config_store_service

config_service = get_config_store_service()

# 讀取有效配置（自動合併三層配置）
effective_config = config_service.get_effective_config(
    scope="tools.datetime",
    tenant_id="tenant_123",
    user_id="user_456"
)

# 使用配置值
default_format = effective_config.config_data.get("default_format", "%Y-%m-%d %H:%M:%S")
default_timezone = effective_config.config_data.get("default_timezone", "UTC")
```

**初始化系統配置**：

系統首次啟動時，需要創建默認的系統級配置：

```python
from services.api.services.config_store_service import get_config_store_service
from services.api.models.config import ConfigCreate

config_service = get_config_store_service()

# 創建系統級默認配置
default_config = ConfigCreate(
    scope="tools.datetime",
    config_data={
        "default_format": "%Y-%m-%d %H:%M:%S",
        "default_timezone": "UTC",
        "default_locale": "en_US",
        "iso_format": "%Y-%m-%dT%H:%M:%S%z",
        "date_only_format": "%Y-%m-%d",
        "time_only_format": "%H:%M:%S"
    },
    metadata={
        "description": "日期時間工具默認配置",
        "version": "1.0"
    }
)

config_service.save_config(default_config)
```

---

## 📦 依賴管理

### 必需依賴

```toml
# pyproject.toml
[tool.poetry.dependencies]
python = "^3.11"
pydantic = "^2.0.0"
httpx = "^0.25.0"   # 用於 HTTP 請求
pytz = "^2024.1"    # 用於時區處理
python-dateutil = "^2.8.2"  # 用於日期解析
```

**注意**：TimeService 僅使用 Python 標準庫，無需額外依賴。

### 可選依賴

```toml
[tool.poetry.group.dev.dependencies]
redis = "^5.0.0"   # 用於緩存（如果使用 Redis）
```

---

## 🧪 測試規範

### 單元測試

每個工具都必須有完整的單元測試：

```python
# tests/tools/test_time_datetime.py
import pytest
from tools.time import DateTimeTool, DateTimeInput

@pytest.mark.asyncio
async def test_get_current_datetime():
    tool = DateTimeTool()
    result = await tool.execute(DateTimeInput(timezone="Asia/Taipei"))
    assert result.datetime is not None
    assert result.timestamp > 0
    assert result.timezone == "Asia/Taipei"
```

### 集成測試

測試工具與外部 API 的集成：

```python
# tests/tools/test_weather_integration.py
import pytest
from tools.weather import WeatherTool, WeatherInput

@pytest.mark.asyncio
async def test_get_weather_integration():
    tool = WeatherTool()
    result = await tool.execute(WeatherInput(city="Taipei"))
    assert result.city == "Taipei"
    assert result.temperature is not None
```

### Mock 測試

對於外部 API，使用 Mock 進行測試：

```python
# tests/tools/test_weather_mock.py
from unittest.mock import AsyncMock, patch
from tools.weather import WeatherTool

@pytest.mark.asyncio
async def test_get_weather_mock():
    with patch('tools.weather.providers.openweathermap.OpenWeatherMapProvider.get_current_weather') as mock:
        mock.return_value = WeatherOutput(...)
        tool = WeatherTool()
        result = await tool.execute(WeatherInput(city="Taipei"))
        assert result.city == "Taipei"
```

---

## 📝 代碼規範

### 1. 文件頭註釋

每個文件必須包含文件頭註釋：

```python
# 代碼功能說明: 日期時間工具實現
# 創建日期: 2025-12-30
# 創建人: Daniel Chung
# 最後修改日期: 2025-12-30
```

### 2. 類型注解

所有函數參數和返回值必須有類型注解：

```python
async def execute(self, input_data: DateTimeInput) -> DateTimeOutput:
    """執行工具"""
    pass
```

### 3. 文檔字符串

所有公共方法必須有文檔字符串：

```python
async def execute(self, input_data: DateTimeInput) -> DateTimeOutput:
    """
    執行日期時間工具

    Args:
        input_data: 工具輸入參數

    Returns:
        工具輸出結果

    Raises:
        ValidationError: 輸入參數驗證失敗
        ToolExecutionError: 工具執行失敗
    """
    pass
```

### 4. 錯誤處理

所有工具必須實現完善的錯誤處理：

```python
from tools.utils.errors import ToolExecutionError

try:
    # 執行工具邏輯
    result = await some_operation()
except Exception as e:
    logger.error(f"Tool execution failed: {e}", exc_info=True)
    raise ToolExecutionError(f"Failed to execute tool: {e}") from e
```

---

## 🔐 安全規範

### 1. API 密鑰管理

所有 API 密鑰必須通過配置服務獲取，不得硬編碼：

```python
from services.api.services.llm_provider_config_service import get_llm_provider_config_service

# 從配置服務獲取 API Key
config_service = get_llm_provider_config_service()
api_key = config_service.get_api_key(LLMProvider.OPENAI)
```

### 2. 輸入驗證

所有輸入參數必須使用 Pydantic 進行驗證：

```python
class WeatherInput(ToolInput):
    city: Optional[str] = None
    lat: Optional[float] = Field(None, ge=-90, le=90)  # 緯度範圍驗證
    lon: Optional[float] = Field(None, ge=-180, le=180)  # 經度範圍驗證
```

### 3. 速率限制

對於外部 API 調用，實現速率限制：

```python
from tools.utils.rate_limiter import RateLimiter

rate_limiter = RateLimiter(max_calls=60, period=60)  # 每分鐘最多 60 次

@rate_limiter.limit
async def get_weather(...):
    pass
```

---

## 📊 性能優化

### 1. 緩存策略

- **天氣數據**：緩存 10 分鐘
- **IP 定位**：緩存 24 小時
- **地理編碼**：緩存 7 天（地址不常變化）

### 2. 並發處理

使用異步編程和連接池：

```python
import httpx

async with httpx.AsyncClient() as client:
    results = await asyncio.gather(
        client.get(url1),
        client.get(url2),
        client.get(url3)
    )
```

### 3. 超時控制

所有網絡請求設置超時：

```python
async with httpx.AsyncClient(timeout=10.0) as client:
    response = await client.get(url)
```

---

## 📚 文檔要求

### 1. API 文檔

每個工具都必須有完整的 API 文檔，包括：

- 工具名稱和描述
- 輸入參數說明
- 輸出結果說明
- 使用示例
- 錯誤處理說明

### 2. 使用指南

創建工具使用指南文檔：

- 快速開始
- 常見使用場景
- 最佳實踐
- 故障排除

---

## ✅ 開發檢查清單

### 代碼質量

- [ ] 所有代碼通過 ruff 檢查
- [ ] 所有代碼通過 mypy 類型檢查
- [ ] 所有代碼通過 black 格式化
- [ ] 代碼覆蓋率 > 80%

### 功能完整性

- [ ] 所有工具實現完成
- [ ] 所有工具都有單元測試
- [ ] 所有工具都有集成測試
- [ ] 所有工具都有 API 文檔

### 性能與安全

- [ ] 實現緩存機制
- [ ] 實現速率限制
- [ ] API 密鑰安全存儲
- [ ] 輸入參數驗證完整

---

**配置說明**：

⚠️ **重要**：日期格式化配置**不存儲在 `config.json` 文件中**，而是通過 `ConfigStoreService` 存儲在 ArangoDB 中。

**原因**：

1. **多租戶支持**：不同租戶可能有不同的日期格式偏好
2. **用戶個性化**：用戶可以設置自己的日期格式
3. **動態配置**：可以在運行時修改配置，無需重啟服務
4. **配置統一管理**：與系統其他配置（如 `genai.policy`）使用相同的配置架構

**配置位置**：

- **存儲位置**：ArangoDB (`system_configs` / `tenant_configs` / `user_configs`)
- **Scope**: `tools.datetime`
- **讀取方式**：通過 `ConfigStoreService.get_effective_config()` 讀取

---

**最後更新**: 2025-12-30
**維護人**: Daniel Chung
