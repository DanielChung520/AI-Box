# 配置优先级逻辑分析

**分析日期**: 2026-01-04

---

## 📋 当前代码逻辑分析

### NER/RE/RT 服务的配置优先级

从 `ner_service.py`、`re_service.py`、`rt_service.py` 的代码来看，当前的优先级顺序是：

#### 当前逻辑（有问题）

**model_type 优先级**：
1. **優先級1**: 從 ArangoDB system_configs 讀取 ✅
2. **優先級2**: 從環境變量讀取（**允許覆蓋 ArangoDB 配置**）❌ **这是问题！**
3. **優先級3**: 從 config.json 讀取（向後兼容）

**model_name 优先级**：
1. **優先級1**: 從 ArangoDB system_configs 讀取 ✅
2. **優先級2**: 從環境變量讀取（**只在 model_type 匹配時覆蓋**）❌ **这是问题！**
3. **優先級3**: 從 config.json 讀取（向後兼容）
4. **優先級4**: 使用硬編碼默認值

### 问题所在

**代码位置**：`ner_service.py` 第 467-498 行

```python
# 優先級2: 從環境變量讀取 model_type（允許覆蓋 ArangoDB 配置）
env_model_type = os.getenv("NER_MODEL_TYPE")
if env_model_type:
    model_type = env_model_type  # ❌ 无条件覆盖

# 優先級2: 從環境變量讀取（只在 model_type 匹配時覆蓋）
if self.model_type == "ollama":
    env_model_name = os.getenv("OLLAMA_NER_MODEL")
    if env_model_name:
        model_name = env_model_name  # ❌ 如果环境变量存在就覆盖
```

**问题**：
- 环境变量会**无条件覆盖** ArangoDB 配置
- 用户期望的逻辑是：**优先使用 ArangoDB，只有 ArangoDB 无效时才 fallback 到 .env**

---

## ✅ 正确的逻辑应该是

### 期望的优先级顺序

1. **優先級1**: 從 ArangoDB system_configs 讀取
   - 如果 ArangoDB 配置存在且有效，使用 ArangoDB 配置
   - **不再检查环境变量**

2. **優先級2**: 從環境變量讀取（fallback）
   - 只有在 ArangoDB 配置不存在或无效时，才使用环境变量

3. **優先級3**: 從 config.json 讀取（向後兼容）

4. **優先級4**: 使用硬編碼默認值

### 修改建议

**应该改为**：
```python
# 優先級1: 從 ArangoDB system_configs 讀取
model_type = None
model_name = None
try:
    config_service = ConfigStoreService()
    kg_config = config_service.get_config("kg_extraction", tenant_id=None)
    if kg_config and kg_config.config_data:
        model_type = kg_config.config_data.get("ner_model_type")
        model_name = kg_config.config_data.get("ner_model")
        if model_type and model_name:
            # ✅ ArangoDB 配置有效，直接使用，不再检查环境变量
            self.model_type = model_type
            self.model_name = model_name
            return  # 或继续到下一步初始化模型
except Exception as e:
    logger.debug("從 ArangoDB 讀取配置失敗，使用 fallback 方式")

# 優先級2: 從環境變量讀取（fallback - 只有在 ArangoDB 无效时）
if not model_type or not model_name:
    env_model_type = os.getenv("NER_MODEL_TYPE")
    env_model_name = os.getenv("OLLAMA_NER_MODEL")
    if env_model_type:
        model_type = env_model_type
    if env_model_name:
        model_name = env_model_name

# 優先級3: 從 config.json 讀取（向後兼容）
if not model_type:
    model_type = self.config.get("model_type", "ollama")
if not model_name:
    model_name = self.config.get("model_name")

# 優先級4: 使用硬編碼默認值
self.model_type = model_type or "ollama"
self.model_name = model_name or "mistral-nemo:12b"
```

---

## 📝 总结

### 当前逻辑（错误）

- ❌ 环境变量会覆盖 ArangoDB 配置
- ❌ 不符合用户期望

### 正确逻辑（用户期望）

- ✅ ArangoDB 配置优先
- ✅ 只有在 ArangoDB 配置无效时，才使用环境变量作为 fallback
- ✅ 这样可以通过 ArangoDB 灵活配置，而不需要修改 .env 文件

### 需要修改的文件

1. `genai/api/services/ner_service.py`
2. `genai/api/services/re_service.py`
3. `genai/api/services/rt_service.py`

### 修改原则

- 如果 ArangoDB 配置存在且有效（model_type 和 model_name 都存在），直接使用，跳过环境变量检查
- 只有在 ArangoDB 配置不存在或无效时，才使用环境变量作为 fallback

