# AI-Box æ–‡ä»¶ç®¡ç†æ¶æ§‹é¢¨éšªè©•ä¼°å ±å‘Š

**ä»£ç¢¼åŠŸèƒ½èªªæ˜**: æ–‡ä»¶ç®¡ç†æ¶æ§‹é¢¨éšªè©•ä¼°èˆ‡æ”¹é€²å»ºè­°
**å‰µå»ºæ—¥æœŸ**: 2025-12-25
**å‰µå»ºäºº**: Daniel Chung
**æœ€å¾Œä¿®æ”¹æ—¥æœŸ**: 2025-12-25

---

## ğŸ“‹ åŸ·è¡Œæ‘˜è¦

æœ¬å ±å‘Šå¾**å°ˆæ¥­æ¶æ§‹å¸«è§’åº¦**ç³»çµ±è©•ä¼° AI-Box æ–‡ä»¶ç®¡ç†ç³»çµ±çš„æ¶æ§‹è¨­è¨ˆï¼Œè­˜åˆ¥æ½›åœ¨é¢¨éšªé»ä¸¦æä¾›æ”¹é€²å»ºè­°ã€‚

**è©•ä¼°ç¯„åœ**ï¼š

- æ–‡ä»¶ä¸Šå‚³èˆ‡å­˜å„²æ¶æ§‹
- æ–‡ä»¶æ¨¹ç®¡ç†èˆ‡åŒæ­¥æ©Ÿåˆ¶
- å¤šæ•¸æ“šæºä¸€è‡´æ€§
- ä¸¦ç™¼æ§åˆ¶èˆ‡ç«¶æ…‹æ¢ä»¶
- éŒ¯èª¤è™•ç†èˆ‡æ¢å¾©æ©Ÿåˆ¶
- æ€§èƒ½èˆ‡å¯æ“´å±•æ€§

**è©•ä¼°çµè«–**ï¼š

- âœ… **è¨­è¨ˆå„ªå‹¢**: æ¸…æ™°çš„åˆ†å±¤æ¶æ§‹ã€ä»»å‹™é©…å‹•è¨­è¨ˆã€å¤šæ•¸æ“šæºé›†æˆ
- âš ï¸ **ä¸­é¢¨éšª**: ç¼ºå°‘äº‹å‹™ç®¡ç†ã€ä¸¦ç™¼æ§åˆ¶ä¸è¶³ã€éŒ¯èª¤æ¢å¾©æ©Ÿåˆ¶ä¸å®Œæ•´
- ğŸ”´ **é«˜é¢¨éšª**: å¤šæ•¸æ“šæºæ“ä½œç¼ºå°‘åŸå­æ€§ä¿è­‰ã€æ–‡ä»¶æ¨¹åŒæ­¥æ©Ÿåˆ¶å­˜åœ¨ç«¶æ…‹æ¢ä»¶

---

## ğŸ”´ é«˜é¢¨éšªé …ç›®

### 1. å¤šæ•¸æ“šæºæ“ä½œç¼ºå°‘åŸå­æ€§ä¿è­‰

#### å•é¡Œæè¿°

**ç•¶å‰å¯¦ç¾**ï¼š

- æ–‡ä»¶åˆªé™¤æ“ä½œæ¶‰åŠ 4 å€‹æ•¸æ“šæºï¼š
  1. æ–‡ä»¶ç³»çµ±ï¼ˆå¯¦éš›æ–‡ä»¶åˆªé™¤ï¼‰
  2. ArangoDBï¼ˆæ–‡ä»¶å…ƒæ•¸æ“šï¼‰
  3. ChromaDBï¼ˆå‘é‡æ•¸æ“šï¼‰
  4. ArangoDBï¼ˆçŸ¥è­˜åœ–è­œå¯¦é«”/é—œä¿‚ï¼‰

**é¢¨éšªå ´æ™¯**ï¼š

```python
# ç•¶å‰å¯¦ç¾ï¼ˆapi/routers/file_management.pyï¼‰
async def delete_file(...):
    # 1. åˆªé™¤å‘é‡ï¼ˆChromaDBï¼‰
    vector_service.delete(...)  # å¯èƒ½æˆåŠŸ

    # 2. åˆªé™¤åœ–è­œï¼ˆArangoDBï¼‰
    # å¯èƒ½å¤±æ•— â†’ å‘é‡å·²åˆªé™¤ï¼Œä½†åœ–è­œä»å­˜åœ¨

    # 3. åˆªé™¤å…ƒæ•¸æ“šï¼ˆArangoDBï¼‰
    # å¯èƒ½å¤±æ•— â†’ å‘é‡å’Œåœ–è­œå·²åˆªé™¤ï¼Œä½†å…ƒæ•¸æ“šä»å­˜åœ¨

    # 4. åˆªé™¤æ–‡ä»¶ï¼ˆæ–‡ä»¶ç³»çµ±ï¼‰
    # å¯èƒ½å¤±æ•— â†’ æ‰€æœ‰æ•¸æ“šå·²åˆªé™¤ï¼Œä½†æ–‡ä»¶ä»åœ¨
```

#### å½±éŸ¿è©•ä¼°

- **æ•¸æ“šä¸ä¸€è‡´**: éƒ¨åˆ†æ•¸æ“šåˆªé™¤æˆåŠŸï¼Œéƒ¨åˆ†å¤±æ•—ï¼Œå°è‡´æ•¸æ“šåº«èˆ‡å¯¦éš›ç‹€æ…‹ä¸ç¬¦
- **è³‡æºæ´©æ¼**: å­¤å…’æ•¸æ“šï¼ˆorphaned dataï¼‰ç„¡æ³•æ¸…ç†
- **ç”¨æˆ¶å›°æƒ‘**: æ–‡ä»¶çœ‹ä¼¼å·²åˆªé™¤ï¼Œä½†å¯¦éš›å¯èƒ½ä»ä½”ç”¨è³‡æº

#### æ”¹é€²å»ºè­°

**æ–¹æ¡ˆ 1ï¼šå¯¦ç¾è£œå„Ÿæ€§äº‹å‹™ï¼ˆSaga Patternï¼‰**

```python
class FileDeletionSaga:
    """æ–‡ä»¶åˆªé™¤è£œå„Ÿæ€§äº‹å‹™ç®¡ç†å™¨"""

    def __init__(self):
        self.compensation_actions = []

    async def delete_file_with_compensation(self, file_id: str):
        try:
            # æ­¥é©Ÿ 1: åˆªé™¤å‘é‡
            vector_result = await self._delete_vector(file_id)
            self.compensation_actions.append(
                lambda: self._restore_vector(file_id, vector_result)
            )

            # æ­¥é©Ÿ 2: åˆªé™¤åœ–è­œ
            kg_result = await self._delete_kg(file_id)
            self.compensation_actions.append(
                lambda: self._restore_kg(file_id, kg_result)
            )

            # æ­¥é©Ÿ 3: åˆªé™¤å…ƒæ•¸æ“š
            metadata_result = await self._delete_metadata(file_id)
            self.compensation_actions.append(
                lambda: self._restore_metadata(file_id, metadata_result)
            )

            # æ­¥é©Ÿ 4: åˆªé™¤æ–‡ä»¶
            await self._delete_file(file_id)

        except Exception as e:
            # åŸ·è¡Œè£œå„Ÿæ“ä½œ
            await self._compensate()
            raise

    async def _compensate(self):
        """åŸ·è¡Œè£œå„Ÿæ“ä½œï¼ˆåå‘æ“ä½œï¼‰"""
        for action in reversed(self.compensation_actions):
            try:
                await action()
            except Exception as e:
                logger.error("è£œå„Ÿæ“ä½œå¤±æ•—", error=str(e))
```

**æ–¹æ¡ˆ 2ï¼šå…©éšæ®µæäº¤ï¼ˆ2PCï¼‰- é©ç”¨æ–¼åŒæ§‹æ•¸æ“šåº«**

å¦‚æœæ‰€æœ‰æ•¸æ“šéƒ½åœ¨ ArangoDB ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ AQL äº‹å‹™ï¼š

```python
async def delete_file_atomic(file_id: str):
    """ä½¿ç”¨ AQL äº‹å‹™ä¿è­‰åŸå­æ€§"""
    aql = """
    BEGIN TRANSACTION

    // 1. åˆªé™¤æ–‡ä»¶å…ƒæ•¸æ“š
    REMOVE {_key: @file_id} IN file_metadata

    // 2. åˆªé™¤çŸ¥è­˜åœ–è­œå¯¦é«”
    FOR entity IN entities
        FILTER entity.file_id == @file_id
        REMOVE entity IN entities

    // 3. åˆªé™¤çŸ¥è­˜åœ–è­œé—œä¿‚
    FOR relation IN relations
        FILTER relation.file_id == @file_id
        REMOVE relation IN relations

    COMMIT
    """
    # æ³¨æ„ï¼šChromaDB ä¸æ”¯æŒäº‹å‹™ï¼Œéœ€è¦å–®ç¨è™•ç†
```

**æ–¹æ¡ˆ 3ï¼šæ¨™è¨˜åˆªé™¤ï¼ˆSoft Deleteï¼‰**

```python
# 1. å…ˆæ¨™è¨˜ç‚ºã€Œå¾…åˆªé™¤ã€
file_metadata.status = "pending_deletion"
file_metadata.marked_for_deletion_at = datetime.utcnow()

# 2. ç•°æ­¥ä»»å‹™åŸ·è¡Œå¯¦éš›åˆªé™¤
# 3. æˆåŠŸå¾Œæ›´æ–°ç‹€æ…‹ç‚ºã€Œå·²åˆªé™¤ã€
# 4. å¤±æ•—å¾Œå¯ä»¥é‡è©¦æˆ–æ‰‹å‹•ä¿®å¾©
```

---

### 2. æ–‡ä»¶æ¨¹åŒæ­¥ç«¶æ…‹æ¢ä»¶

#### å•é¡Œæè¿°

**ç•¶å‰å¯¦ç¾**ï¼š

- å‰ç«¯å’Œå¾Œç«¯éƒ½æœ‰æ–‡ä»¶æ¨¹ç·©å­˜
- å¤šå€‹æ“ä½œå¯èƒ½åŒæ™‚ä¿®æ”¹æ–‡ä»¶æ¨¹
- ç¼ºå°‘ç‰ˆæœ¬æ§åˆ¶æˆ–æ¨‚è§€é–æ©Ÿåˆ¶

**é¢¨éšªå ´æ™¯**ï¼š

```
ç”¨æˆ¶ A: ç§»å‹•æ–‡ä»¶ file1 åˆ° folder1
ç”¨æˆ¶ B: åŒæ™‚ç§»å‹•æ–‡ä»¶ file1 åˆ° folder2

æ™‚é–“ç·šï¼š
T1: A è®€å–æ–‡ä»¶æ¨¹ (version=1)
T2: B è®€å–æ–‡ä»¶æ¨¹ (version=1)
T3: A ç§»å‹• file1 â†’ folder1ï¼Œå¯«å…¥ (version=2)
T4: B ç§»å‹• file1 â†’ folder2ï¼Œå¯«å…¥ (version=2) â† è¦†è“‹ A çš„æ“ä½œ
```

#### å½±éŸ¿è©•ä¼°

- **æ•¸æ“šä¸Ÿå¤±**: å¾ŒçºŒæ“ä½œå¯èƒ½è¦†è“‹å‰é¢çš„æ“ä½œ
- **ç‹€æ…‹ä¸ä¸€è‡´**: å‰ç«¯é¡¯ç¤ºèˆ‡å¾Œç«¯å¯¦éš›ç‹€æ…‹ä¸ç¬¦
- **ç”¨æˆ¶é«”é©—å·®**: ç”¨æˆ¶æ“ä½œå¯èƒ½è¢«ç„¡è²è¦†è“‹

#### æ”¹é€²å»ºè­°

**æ–¹æ¡ˆ 1ï¼šæ¨‚è§€é–æ©Ÿåˆ¶**

```python
# åœ¨ file_metadata ä¸­æ·»åŠ ç‰ˆæœ¬å­—æ®µ
class FileMetadata:
    _key: str
    _rev: str  # ArangoDB è‡ªå‹•ç‰ˆæœ¬è™Ÿ
    file_tree_version: int  # æ–‡ä»¶æ¨¹ç‰ˆæœ¬è™Ÿ

# æ›´æ–°æ™‚æª¢æŸ¥ç‰ˆæœ¬
async def move_file(file_id: str, target_task_id: str, expected_version: int):
    metadata = get_metadata(file_id)
    if metadata.file_tree_version != expected_version:
        raise ConflictError("æ–‡ä»¶æ¨¹å·²è¢«å…¶ä»–æ“ä½œä¿®æ”¹ï¼Œè«‹åˆ·æ–°å¾Œé‡è©¦")

    # æ›´æ–°ç‰ˆæœ¬è™Ÿ
    metadata.file_tree_version += 1
    update_metadata(metadata)
```

**æ–¹æ¡ˆ 2ï¼šæ“ä½œæ—¥èªŒèˆ‡äº‹ä»¶æº¯æº**

```python
# ä½¿ç”¨äº‹ä»¶æº¯æºæ¨¡å¼
class FileTreeEvent:
    event_id: str
    event_type: str  # "file_moved", "file_deleted", etc.
    file_id: str
    timestamp: datetime
    user_id: str
    data: dict

# æ‰€æœ‰æ“ä½œéƒ½è¨˜éŒ„ç‚ºäº‹ä»¶
# æ–‡ä»¶æ¨¹é€šéé‡æ”¾äº‹ä»¶æ§‹å»º
async def move_file(...):
    # 1. è¨˜éŒ„äº‹ä»¶
    event = FileTreeEvent(
        event_type="file_moved",
        file_id=file_id,
        data={"from": old_task_id, "to": new_task_id}
    )
    save_event(event)

    # 2. æ‡‰ç”¨è®Šæ›´
    apply_event(event)
```

**æ–¹æ¡ˆ 3ï¼šWebSocket å¯¦æ™‚åŒæ­¥**

```python
# ç•¶æ–‡ä»¶æ¨¹è®Šæ›´æ™‚ï¼Œé€šé WebSocket é€šçŸ¥æ‰€æœ‰å®¢æˆ¶ç«¯
async def move_file(...):
    # åŸ·è¡Œç§»å‹•æ“ä½œ
    result = await _execute_move(...)

    # å»£æ’­è®Šæ›´äº‹ä»¶
    await websocket_manager.broadcast({
        "type": "file_tree_updated",
        "file_id": file_id,
        "operation": "move",
        "data": result
    })
```

---

### 3. æ–‡ä»¶ä¸Šå‚³å¤±æ•—æ¢å¾©æ©Ÿåˆ¶ä¸å®Œæ•´

#### å•é¡Œæè¿°

**ç•¶å‰å¯¦ç¾**ï¼š

- æ–‡ä»¶ä¸Šå‚³æ¶‰åŠå¤šå€‹æ­¥é©Ÿï¼š
  1. ä¿å­˜æ–‡ä»¶åˆ°æ–‡ä»¶ç³»çµ±
  2. å‰µå»ºæ–‡ä»¶å…ƒæ•¸æ“šï¼ˆArangoDBï¼‰
  3. æäº¤ç•°æ­¥è™•ç†ä»»å‹™ï¼ˆRQï¼‰
  4. æ›´æ–°è™•ç†ç‹€æ…‹ï¼ˆRedisï¼‰

**é¢¨éšªå ´æ™¯**ï¼š

```
æ­¥é©Ÿ 1: æ–‡ä»¶ä¿å­˜æˆåŠŸ âœ…
æ­¥é©Ÿ 2: å…ƒæ•¸æ“šå‰µå»ºå¤±æ•— âŒ
çµæœ: æ–‡ä»¶å·²ä¿å­˜ï¼Œä½†å…ƒæ•¸æ“šä¸å­˜åœ¨
å¾ŒçºŒ: æ–‡ä»¶æˆç‚ºå­¤å…’æ–‡ä»¶ï¼Œç„¡æ³•è¢«è¨ªå•æˆ–æ¸…ç†
```

#### å½±éŸ¿è©•ä¼°

- **å­˜å„²æ´©æ¼**: å­¤å…’æ–‡ä»¶ä½”ç”¨ç£ç›¤ç©ºé–“
- **æ•¸æ“šä¸ä¸€è‡´**: æ–‡ä»¶ç³»çµ±èˆ‡æ•¸æ“šåº«ä¸ä¸€è‡´
- **ç”¨æˆ¶å›°æƒ‘**: ä¸Šå‚³çœ‹ä¼¼å¤±æ•—ï¼Œä½†æ–‡ä»¶å·²éƒ¨åˆ†ä¿å­˜

#### æ”¹é€²å»ºè­°

**æ–¹æ¡ˆ 1ï¼šé ç•™è³‡æºæ¨¡å¼**

```python
async def upload_file(...):
    # 1. å…ˆå‰µå»ºå…ƒæ•¸æ“šï¼ˆç‹€æ…‹ç‚º "uploading"ï¼‰
    metadata = create_metadata(status="uploading")
    file_id = metadata.file_id

    try:
        # 2. ä¿å­˜æ–‡ä»¶
        save_file(file_id, file_content)

        # 3. æ›´æ–°ç‹€æ…‹ç‚º "uploaded"
        update_metadata(file_id, status="uploaded")

        # 4. æäº¤è™•ç†ä»»å‹™
        enqueue_processing_task(file_id)

    except Exception as e:
        # æ¸…ç†å·²å‰µå»ºçš„è³‡æº
        await cleanup_upload_failure(file_id)
        raise
```

**æ–¹æ¡ˆ 2ï¼šå®šæœŸæ¸…ç†ä»»å‹™**

```python
# å®šæœŸæƒæå­¤å…’æ–‡ä»¶
async def cleanup_orphaned_files():
    # 1. æƒææ–‡ä»¶ç³»çµ±ä¸­çš„æ–‡ä»¶
    files_in_fs = list_files_in_storage()

    # 2. æŸ¥è©¢æ•¸æ“šåº«ä¸­çš„å…ƒæ•¸æ“š
    metadata_in_db = get_all_metadata()

    # 3. æ‰¾å‡ºå­¤å…’æ–‡ä»¶ï¼ˆå­˜åœ¨æ–¼ FSï¼Œä½†ä¸å­˜åœ¨æ–¼ DBï¼‰
    orphaned_files = set(files_in_fs) - set(metadata_in_db)

    # 4. å¦‚æœæ–‡ä»¶è¶…é 24 å°æ™‚æœªé—œè¯ï¼Œåˆªé™¤
    for file_path in orphaned_files:
        if is_older_than_24h(file_path):
            delete_file(file_path)
```

---

## âš ï¸ ä¸­é¢¨éšªé …ç›®

### 4. æ–‡ä»¶æ¨¹æŸ¥è©¢æ€§èƒ½å•é¡Œ

#### å•é¡Œæè¿°

**ç•¶å‰å¯¦ç¾**ï¼š

- `get_file_tree` API æ¯æ¬¡æŸ¥è©¢éƒ½è¦ï¼š
  1. æŸ¥è©¢æ‰€æœ‰æ–‡ä»¶å…ƒæ•¸æ“š
  2. æŸ¥è©¢æ‰€æœ‰è³‡æ–™å¤¾å…ƒæ•¸æ“š
  3. åœ¨å…§å­˜ä¸­æ§‹å»ºæ¨¹çµæ§‹
  4. è¿”å›å®Œæ•´çš„æ¨¹çµæ§‹

**æ€§èƒ½ç“¶é ¸**ï¼š

- æ–‡ä»¶æ•¸é‡å¢åŠ æ™‚ï¼ŒæŸ¥è©¢æ™‚é–“ç·šæ€§å¢é•·
- æ²’æœ‰ç·©å­˜æ©Ÿåˆ¶
- æ¯æ¬¡æŸ¥è©¢éƒ½è¦æ§‹å»ºå®Œæ•´æ¨¹çµæ§‹

#### æ”¹é€²å»ºè­°

**æ–¹æ¡ˆ 1ï¼šç·©å­˜æ–‡ä»¶æ¨¹**

```python
from functools import lru_cache
import redis

class FileTreeCache:
    def __init__(self):
        self.redis = get_redis_client()
        self.cache_ttl = 300  # 5 åˆ†é˜

    def get_tree(self, user_id: str, task_id: str):
        cache_key = f"file_tree:{user_id}:{task_id}"

        # å˜—è©¦å¾ç·©å­˜è®€å–
        cached = self.redis.get(cache_key)
        if cached:
            return json.loads(cached)

        # ç·©å­˜æœªå‘½ä¸­ï¼Œæ§‹å»ºæ¨¹
        tree = self._build_tree(user_id, task_id)

        # å¯«å…¥ç·©å­˜
        self.redis.setex(
            cache_key,
            self.cache_ttl,
            json.dumps(tree)
        )

        return tree

    def invalidate_cache(self, user_id: str, task_id: str):
        cache_key = f"file_tree:{user_id}:{task_id}"
        self.redis.delete(cache_key)
```

**æ–¹æ¡ˆ 2ï¼šå¢é‡æ›´æ–°**

```python
# åªè¿”å›è®Šæ›´çš„éƒ¨åˆ†
async def get_file_tree_changes(
    user_id: str,
    task_id: str,
    last_version: int
):
    """ç²å–è‡ªæŒ‡å®šç‰ˆæœ¬ä»¥ä¾†çš„è®Šæ›´"""
    changes = get_changes_since_version(task_id, last_version)
    return {
        "version": current_version,
        "changes": changes  # åªè¿”å›è®Šæ›´çš„éƒ¨åˆ†
    }
```

**æ–¹æ¡ˆ 3ï¼šåˆ†é æŸ¥è©¢**

```python
# å°æ–¼å¤§å‹æ–‡ä»¶æ¨¹ï¼Œä½¿ç”¨åˆ†é 
async def get_file_tree_paginated(
    user_id: str,
    task_id: str,
    page: int = 1,
    page_size: int = 50
):
    """åˆ†é æŸ¥è©¢æ–‡ä»¶æ¨¹"""
    offset = (page - 1) * page_size
    return {
        "tree": get_tree_page(task_id, offset, page_size),
        "total": get_tree_count(task_id),
        "page": page,
        "page_size": page_size
    }
```

---

### 5. å‰ç«¯ç‹€æ…‹ç®¡ç†è¤‡é›œåº¦é«˜

#### å•é¡Œæè¿°

**ç•¶å‰å¯¦ç¾**ï¼š

- `FileTree.tsx` çµ„ä»¶ç‹€æ…‹è¤‡é›œï¼š
  - `treeData`: æ–‡ä»¶æ¨¹æ•¸æ“š
  - `expandedTasks`: å±•é–‹ç‹€æ…‹
  - `contextMenu`: ä¸Šä¸‹æ–‡èœå–®ç‹€æ…‹
  - `selectedFileId`: é¸ä¸­æ–‡ä»¶
  - å¤šå€‹ Modal ç‹€æ…‹

**å•é¡Œ**ï¼š

- ç‹€æ…‹åˆ†æ•£åœ¨å¤šå€‹ useState ä¸­
- ç‹€æ…‹æ›´æ–°é‚è¼¯è¤‡é›œ
- å®¹æ˜“å‡ºç¾ç‹€æ…‹ä¸ä¸€è‡´

#### æ”¹é€²å»ºè­°

**æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ç‹€æ…‹ç®¡ç†åº«ï¼ˆRedux/Zustandï¼‰**

```typescript
// ä½¿ç”¨ Zustandï¼ˆè¼•é‡ç´šç‹€æ…‹ç®¡ç†ï¼‰
import create from 'zustand'

interface FileTreeState {
  treeData: FileTreeResponse | null
  expandedTasks: Set<string>
  selectedFileId: string | null
  setTreeData: (data: FileTreeResponse | null) => void
  toggleTask: (taskId: string) => void
  selectFile: (fileId: string | null) => void
}

const useFileTreeStore = create<FileTreeState>((set) => ({
  treeData: null,
  expandedTasks: new Set(['temp-workspace']),
  selectedFileId: null,
  setTreeData: (data) => set({ treeData: data }),
  toggleTask: (taskId) => set((state) => {
    const newExpanded = new Set(state.expandedTasks)
    if (newExpanded.has(taskId)) {
      newExpanded.delete(taskId)
    } else {
      newExpanded.add(taskId)
    }
    return { expandedTasks: newExpanded }
  }),
  selectFile: (fileId) => set({ selectedFileId: fileId }),
}))
```

**æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ React Query ç®¡ç†æœå‹™å™¨ç‹€æ…‹**

```typescript
// ä½¿ç”¨ React Query ç®¡ç†æ–‡ä»¶æ¨¹æ•¸æ“š
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'

function useFileTree(userId: string, taskId: string) {
  return useQuery({
    queryKey: ['fileTree', userId, taskId],
    queryFn: () => getFileTree({ user_id: userId, task_id: taskId }),
    staleTime: 5 * 60 * 1000, // 5 åˆ†é˜
  })
}

function useMoveFile() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: moveFile,
    onSuccess: (data, variables) => {
      // ç„¡æ•ˆåŒ–ç›¸é—œæŸ¥è©¢ï¼Œè§¸ç™¼é‡æ–°ç²å–
      queryClient.invalidateQueries(['fileTree'])
    },
  })
}
```

---

### 6. ç¼ºå°‘æ“ä½œå¯©è¨ˆèˆ‡å›æ»¾æ©Ÿåˆ¶

#### å•é¡Œæè¿°

**ç•¶å‰å¯¦ç¾**ï¼š

- æœ‰ `operation_log_service` è¨˜éŒ„æ“ä½œæ—¥èªŒ
- ä½†ç¼ºå°‘æ“ä½œå›æ»¾æ©Ÿåˆ¶
- ç„¡æ³•è¿½æº¯æ“ä½œæ­·å²

#### æ”¹é€²å»ºè­°

**æ–¹æ¡ˆ 1ï¼šå¯¦ç¾æ“ä½œæ­·å²èˆ‡å›æ»¾**

```python
class FileOperationHistory:
    """æ–‡ä»¶æ“ä½œæ­·å²ç®¡ç†å™¨"""

    async def log_operation(
        self,
        operation_type: str,
        file_id: str,
        user_id: str,
        before_state: dict,
        after_state: dict
    ):
        """è¨˜éŒ„æ“ä½œå‰å¾Œç‹€æ…‹"""
        history_record = {
            "operation_id": generate_uuid(),
            "operation_type": operation_type,
            "file_id": file_id,
            "user_id": user_id,
            "before_state": before_state,
            "after_state": after_state,
            "timestamp": datetime.utcnow(),
        }
        save_to_history(history_record)

    async def rollback_operation(self, operation_id: str):
        """å›æ»¾æ“ä½œ"""
        history = get_history(operation_id)
        if not history:
            raise ValueError("æ“ä½œä¸å­˜åœ¨")

        # æ¢å¾©åˆ°æ“ä½œå‰ç‹€æ…‹
        restore_state(history.file_id, history.before_state)

        # è¨˜éŒ„å›æ»¾æ“ä½œ
        log_operation("rollback", history.file_id, current_user_id,
                     history.after_state, history.before_state)
```

**æ–¹æ¡ˆ 2ï¼šå¯¦ç¾æ“ä½œç¢ºèªæ©Ÿåˆ¶**

```python
# å°æ–¼å±éšªæ“ä½œï¼ˆå¦‚åˆªé™¤ï¼‰ï¼Œå¯¦ç¾å…©éšæ®µç¢ºèª
async def delete_file_with_confirmation(
    file_id: str,
    confirmation_token: str
):
    # 1. å‰µå»ºåˆªé™¤è«‹æ±‚ï¼ˆç‹€æ…‹ç‚º "pending"ï¼‰
    delete_request = create_delete_request(file_id, confirmation_token)

    # 2. ç™¼é€ç¢ºèªéƒµä»¶/é€šçŸ¥
    send_confirmation_notification(delete_request)

    # 3. ç”¨æˆ¶ç¢ºèªå¾ŒåŸ·è¡Œåˆªé™¤
    # é€šé confirmation_token é©—è­‰å¾ŒåŸ·è¡Œå¯¦éš›åˆªé™¤
```

---

## âœ… è¨­è¨ˆå„ªå‹¢

### 1. æ¸…æ™°çš„åˆ†å±¤æ¶æ§‹

- âœ… å‰ç«¯ã€APIã€æœå‹™å±¤ã€æ•¸æ“šå±¤æ¸…æ™°åˆ†é›¢
- âœ… è·è²¬å–®ä¸€ï¼Œæ˜“æ–¼ç¶­è­·

### 2. ä»»å‹™é©…å‹•è¨­è¨ˆ

- âœ… ä»¥ä»»å‹™ç‚ºå–®ä½çš„æ–‡ä»¶çµ„ç¹”ï¼Œç¬¦åˆæ¥­å‹™é‚è¼¯
- âœ… æ¯å€‹ä»»å‹™ç¨ç«‹çš„ã€Œä»»å‹™å·¥ä½œå€ã€

### 3. å¤šæ•¸æ“šæºé›†æˆ

- âœ… æ”¯æŒå‘é‡æ•¸æ“šï¼ˆChromaDBï¼‰ã€åœ–æ•¸æ“šï¼ˆArangoDBï¼‰ã€æ–‡ä»¶å­˜å„²
- âœ… çµ±ä¸€çš„æœå‹™å±¤å°è£

### 4. æ¬Šé™æ§åˆ¶

- âœ… åŸºæ–¼ç”¨æˆ¶çš„æ¬Šé™æª¢æŸ¥
- âœ… æ“ä½œå¯©è¨ˆæ—¥èªŒ

---

## ğŸ“Š å„ªå…ˆç´šå»ºè­°

### ğŸ”´ ç«‹å³è™•ç†ï¼ˆP0ï¼‰

1. **å¯¦ç¾æ–‡ä»¶åˆªé™¤çš„è£œå„Ÿæ€§äº‹å‹™** - é˜²æ­¢æ•¸æ“šä¸ä¸€è‡´
2. **å¯¦ç¾æ–‡ä»¶ä¸Šå‚³çš„é ç•™è³‡æºæ¨¡å¼** - é˜²æ­¢å­¤å…’æ–‡ä»¶
3. **æ·»åŠ æ–‡ä»¶æ¨¹ç‰ˆæœ¬æ§åˆ¶** - é˜²æ­¢ç«¶æ…‹æ¢ä»¶

### âš ï¸ çŸ­æœŸæ”¹é€²ï¼ˆP1ï¼‰

4. **å¯¦ç¾æ–‡ä»¶æ¨¹ç·©å­˜** - æå‡æ€§èƒ½
5. **å¯¦ç¾æ“ä½œæ­·å²èˆ‡å›æ»¾** - æå‡å¯è¿½æº¯æ€§
6. **å„ªåŒ–å‰ç«¯ç‹€æ…‹ç®¡ç†** - é™ä½è¤‡é›œåº¦

### ğŸ“‹ é•·æœŸå„ªåŒ–ï¼ˆP2ï¼‰

7. **å¯¦ç¾ WebSocket å¯¦æ™‚åŒæ­¥** - æå‡ç”¨æˆ¶é«”é©—
8. **å¯¦ç¾åˆ†é æŸ¥è©¢** - æ”¯æŒå¤§å‹æ–‡ä»¶æ¨¹
9. **å¯¦ç¾å®šæœŸæ¸…ç†ä»»å‹™** - ç¶­è­·ç³»çµ±å¥åº·

---

## ğŸ¯ ç¸½çµ

### æ ¸å¿ƒé¢¨éšª

1. **å¤šæ•¸æ“šæºæ“ä½œç¼ºå°‘åŸå­æ€§** â†’ å¯èƒ½å°è‡´æ•¸æ“šä¸ä¸€è‡´
2. **æ–‡ä»¶æ¨¹åŒæ­¥ç«¶æ…‹æ¢ä»¶** â†’ å¯èƒ½å°è‡´æ“ä½œä¸Ÿå¤±
3. **ä¸Šå‚³å¤±æ•—æ¢å¾©æ©Ÿåˆ¶ä¸å®Œæ•´** â†’ å¯èƒ½å°è‡´è³‡æºæ´©æ¼

### é—œéµæ”¹é€²æ–¹å‘

1. **äº‹å‹™ç®¡ç†**: å¯¦ç¾è£œå„Ÿæ€§äº‹å‹™æˆ–å…©éšæ®µæäº¤
2. **ç‰ˆæœ¬æ§åˆ¶**: å¯¦ç¾æ¨‚è§€é–æˆ–äº‹ä»¶æº¯æº
3. **éŒ¯èª¤æ¢å¾©**: å¯¦ç¾é ç•™è³‡æºæ¨¡å¼å’Œå®šæœŸæ¸…ç†

### æ•´é«”è©•ä¼°

- **æ¶æ§‹è¨­è¨ˆ**: â­â­â­â­ (4/5) - æ¸…æ™°çš„åˆ†å±¤æ¶æ§‹ï¼Œä½†ç¼ºå°‘äº‹å‹™ç®¡ç†
- **å¯é æ€§**: â­â­â­ (3/5) - åŸºæœ¬åŠŸèƒ½å®Œæ•´ï¼Œä½†éŒ¯èª¤è™•ç†ä¸è¶³
- **æ€§èƒ½**: â­â­â­ (3/5) - åŠŸèƒ½æ­£å¸¸ï¼Œä½†ç¼ºå°‘ç·©å­˜å’Œå„ªåŒ–
- **å¯ç¶­è­·æ€§**: â­â­â­â­ (4/5) - ä»£ç¢¼çµæ§‹æ¸…æ™°ï¼Œä½†ç‹€æ…‹ç®¡ç†è¤‡é›œ

---

**æœ€å¾Œæ›´æ–°**: 2025-12-25
**è©•ä¼°è€…**: AI Assistant (Auto)
