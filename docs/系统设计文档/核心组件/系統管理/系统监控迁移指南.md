# ç³»ç»Ÿç›‘æ§è¿ç§»æŒ‡å—

**æ–‡æ¡£ç¼–å·**: GUIDE-MONITOR-001
**ç‰ˆæœ¬**: 1.0
**åˆ›å»ºæ—¥æœŸ**: 2026-01-18 18:54 UTC+8
**åˆ›å»ºäºº**: Daniel Chung
**æœ€åæ›´æ–°**: 2026-01-18 18:54 UTC+8

---

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

### ç›®çš„

æœ¬æŒ‡å—æä¾›ç³»ç»Ÿç›‘æ§ä»æ—§ç³»ç»Ÿï¼ˆArangoDBï¼‰è¿ç§»åˆ°æ–°ç³»ç»Ÿï¼ˆPrometheus + Grafanaï¼‰çš„è¯¦ç»†æ“ä½œæ­¥éª¤ã€‚

### é€‚ç”¨èŒƒå›´

- è¿ç»´äººå‘˜ï¼šä½œä¸ºè¿ç§»æ“ä½œæ‰‹å†Œ
- å¼€å‘äººå‘˜ï¼šä½œä¸ºä»£ç æ¸…ç†å’Œä¼˜åŒ–å‚è€ƒ
- é¡¹ç›®ç»ç†ï¼šä½œä¸ºè¿ç§»è¿›åº¦è·Ÿè¸ªä¾æ®

---

## ğŸš€ è¿ç§»å‰å‡†å¤‡

### 1. å¤‡ä»½ç°æœ‰ç³»ç»Ÿæ•°æ®

**æ‰§è¡Œå¤‡ä»½è„šæœ¬**ï¼š

```bash
cd /Users/daniel/GitHub/AI-Box
python scripts/backup_monitoring_data.py
```

**å¤‡ä»½å†…å®¹**ï¼š

- `service_status` - æœåŠ¡çŠ¶æ€æ•°æ®
- `service_logs` - æœåŠ¡æ—¥å¿—æ•°æ®
- `service_alerts` - æœåŠ¡å‘Šè­¦æ•°æ®
- `service_alert_rules` - å‘Šè­¦è§„åˆ™æ•°æ®

**å¤‡ä»½ä½ç½®**ï¼š

```
backup/monitoring_backup_YYYYMMDD_HHMMSS/
â”œâ”€â”€ service_status.json
â”œâ”€â”€ service_logs.json
â”œâ”€â”€ service_alerts.json
â”œâ”€â”€ service_alert_rules.json
â””â”€â”€ backup_info.json
```

### 2. éªŒè¯æ–°ç³»ç»Ÿè¿è¡Œ

**æ‰§è¡ŒéªŒè¯è„šæœ¬**ï¼š

```bash
python scripts/verify_monitoring_system.py
```

**éªŒè¯é¡¹ç›®**ï¼š

- âœ… Prometheus å¯è®¿é—®
- âœ… Alertmanager å¯è®¿é—®
- âœ… Grafana å¯è®¿é—®
- âœ… FastAPI /metrics ç«¯ç‚¹å¯è®¿é—®
- âœ… Prometheus Targets çŠ¶æ€æ­£å¸¸

### 3. ç¡®è®¤å›æ»šæ–¹æ¡ˆ

å¦‚æœè¿ç§»å¤±è´¥ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å›æ»šï¼š

```bash
# 1. ç¦ç”¨æ–°ç³»ç»Ÿ
python scripts/switch_monitoring_system.py disable

# 2. é‡å¯ FastAPI æœåŠ¡
pkill -f "uvicorn api.main:app"
uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload &

# 3. éªŒè¯æ—§ç³»ç»Ÿæ­£å¸¸è¿è¡Œ
curl http://localhost:8000/api/v1/admin/services
```

---

## ğŸ”„ è¿ç§»æ­¥éª¤

### æ­¥éª¤ 1ï¼šåˆ‡æ¢åŠŸèƒ½å¼€å…³

**å¯ç”¨æ–°ç›‘æ§ç³»ç»Ÿ**ï¼š

```bash
python scripts/switch_monitoring_system.py enable
```

**éªŒè¯ç¯å¢ƒå˜é‡**ï¼š

```bash
grep USE_NEW_MONITORING .env
# åº”è¯¥æ˜¾ç¤º: USE_NEW_MONITORING=true
```

### æ­¥éª¤ 2ï¼šé‡å¯æœåŠ¡

**é‡å¯ FastAPI æœåŠ¡**ï¼š

```bash
# åœæ­¢ç°æœ‰æœåŠ¡
pkill -f "uvicorn api.main:app"

# å¯åŠ¨æœåŠ¡ï¼ˆåŠ è½½æ–°çš„ç¯å¢ƒå˜é‡ï¼‰
uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload &
```

**é‡å¯å‰ç«¯æœåŠ¡**ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼š

```bash
cd ai-bot
npm run dev
```

### æ­¥éª¤ 3ï¼šéªŒè¯æ–°ç³»ç»Ÿè¿è¡Œ

**æ‰§è¡ŒéªŒè¯è„šæœ¬**ï¼š

```bash
python scripts/verify_monitoring_system.py
```

**æ‰‹åŠ¨éªŒè¯**ï¼š

1. è®¿é—® Prometheus UI: <http://localhost:9090>
2. è®¿é—® Grafana UI: <http://localhost:3001>
3. è®¿é—® Alertmanager UI: <http://localhost:9093>
4. æµ‹è¯• API ç«¯ç‚¹: `curl http://localhost:8000/api/v1/admin/services`

### æ­¥éª¤ 4ï¼šè§‚å¯ŸæœŸç›‘æ§ï¼ˆ24å°æ—¶ï¼‰

**ä½¿ç”¨è§‚å¯ŸæœŸç›‘æ§è„šæœ¬**ï¼ˆæ¨èï¼‰ï¼š

```bash
# æ¯ 2 å°æ—¶æ£€æŸ¥ä¸€æ¬¡ï¼ŒæŒç»­ 24 å°æ—¶
python scripts/monitor_observation_period.py --interval 7200 --duration 86400

# è‡ªå®šä¹‰æ£€æŸ¥é—´éš”å’ŒæŒç»­æ—¶é—´
python scripts/monitor_observation_period.py --interval 3600 --duration 43200  # æ¯ 1 å°æ—¶æ£€æŸ¥ï¼ŒæŒç»­ 12 å°æ—¶
```

**ç›‘æ§æ£€æŸ¥æ¸…å•**ï¼š

- [ ] æ¯ 2 å°æ—¶æ£€æŸ¥ä¸€æ¬¡ç³»ç»ŸçŠ¶æ€
- [ ] æ£€æŸ¥ Prometheus targets çŠ¶æ€
- [ ] æ£€æŸ¥å‘Šè­¦æ˜¯å¦æ­£å¸¸è§¦å‘
- [ ] æ£€æŸ¥å‰ç«¯æ˜¾ç¤ºæ˜¯å¦æ­£å¸¸
- [ ] è®°å½•ä»»ä½•å¼‚å¸¸æƒ…å†µ
- [ ] æ”¶é›†ç”¨æˆ·åé¦ˆ

**æ‰‹åŠ¨ç›‘æ§å‘½ä»¤**ï¼š

```bash
# æ£€æŸ¥ Prometheus targets
curl http://localhost:9090/api/v1/targets | jq '.data.activeTargets[] | {job: .labels.job, health: .health}'

# æ£€æŸ¥æœåŠ¡çŠ¶æ€ API
curl http://localhost:8000/api/v1/admin/services | jq '.data.services[] | {service_name, status, health_status}'

# æ£€æŸ¥å‘Šè­¦
curl http://localhost:8000/api/v1/admin/service-alerts | jq '.data.alerts[] | {alert_id, status, severity}'
```

**ç›‘æ§æ—¥å¿—ä½ç½®**ï¼š

```
backup/observation_log_YYYYMMDD_HHMMSS.json
```

---

## ğŸ§¹ ä»£ç æ¸…ç†ï¼ˆå¯é€‰ï¼‰

### ä¿ç•™çš„ä»£ç 

ä»¥ä¸‹ä»£ç éœ€è¦ä¿ç•™ï¼Œå› ä¸ºå®ƒä»¬æä¾›äº†å…¼å®¹å±‚æˆ–ä»åœ¨ä½¿ç”¨ï¼š

1. **å…¼å®¹å±‚ API**ï¼š
   - `api/routers/prometheus_compat.py` - Prometheus å…¼å®¹å±‚ API
   - `api/routers/service_monitor.py` - æœåŠ¡ç›‘æ§è·¯ç”±ï¼ˆå·²æ·»åŠ åŠŸèƒ½å¼€å…³ï¼‰

2. **å‘Šè­¦ç³»ç»Ÿ**ï¼š
   - `api/routers/service_alert.py` - æœåŠ¡å‘Šè­¦è·¯ç”±ï¼ˆä»åœ¨ä½¿ç”¨ï¼‰
   - `api/routers/alert_webhook.py` - Alertmanager Webhook ç«¯ç‚¹ï¼ˆæ–°ç³»ç»Ÿï¼‰

3. **æ•°æ®æ¨¡å‹å’ŒæœåŠ¡**ï¼š
   - `services/api/models/service_alert.py` - å‘Šè­¦æ•°æ®æ¨¡å‹
   - `services/api/services/service_alert_service.py` - å‘Šè­¦æœåŠ¡ï¼ˆä»åœ¨ä½¿ç”¨ï¼‰

### å¯ç§»é™¤çš„ä»£ç ï¼ˆè§‚å¯ŸæœŸåï¼‰

å¦‚æœæ–°ç³»ç»Ÿè¿è¡Œç¨³å®šï¼ˆè§‚å¯ŸæœŸ 24 å°æ—¶åï¼‰ï¼Œå¯ä»¥è€ƒè™‘ç§»é™¤ä»¥ä¸‹ä»£ç ï¼š

1. **æ—§ç›‘æ§æœåŠ¡**ï¼ˆå¦‚æœä¸å†éœ€è¦ï¼‰ï¼š
   - `services/api/services/service_monitor_service.py` - æ—§ç›‘æ§æœåŠ¡
   - `services/api/services/service_status_store_service.py` - æ—§çŠ¶æ€å­˜å‚¨æœåŠ¡

2. **æ—§æ•°æ®æ¨¡å‹**ï¼ˆå¦‚æœä¸å†éœ€è¦ï¼‰ï¼š
   - `services/api/models/service_status.py` - æ—§çŠ¶æ€æ¨¡å‹ï¼ˆå¦‚æœå®Œå…¨è¿ç§»åˆ° Prometheusï¼‰

**æ³¨æ„**ï¼šç§»é™¤å‰è¯·ç¡®ä¿ï¼š

- æ–°ç³»ç»Ÿå·²ç¨³å®šè¿è¡Œè‡³å°‘ 24 å°æ—¶
- æ‰€æœ‰åŠŸèƒ½å·²è¿ç§»åˆ°æ–°ç³»ç»Ÿ
- å·²å¤‡ä»½æ‰€æœ‰é‡è¦æ•°æ®
- å·²è·å¾—é¡¹ç›®è´Ÿè´£äººæ‰¹å‡†

---

## ğŸ“Š æ•°æ®åº“æ¸…ç†ï¼ˆå¯é€‰ï¼‰

### æ¸…ç†æ—§ç›‘æ§æ•°æ®

å¦‚æœæ–°ç³»ç»Ÿè¿è¡Œç¨³å®šï¼ˆè§‚å¯ŸæœŸ 24 å°æ—¶åï¼‰ï¼Œå¯ä»¥è€ƒè™‘æ¸…ç† ArangoDB ä¸­çš„æ—§ç›‘æ§æ•°æ®ï¼š

**ä½¿ç”¨æ¸…ç†è„šæœ¬**ï¼ˆæ¨èï¼‰ï¼š

```bash
# 1. å…ˆè¯•è¿è¡Œï¼ŒæŸ¥çœ‹å°†åˆ é™¤çš„æ•°æ®
python scripts/cleanup_old_monitoring_data.py --dry-run

# 2. ç¡®è®¤æ— è¯¯åï¼Œå®é™…æ‰§è¡Œæ¸…ç†ï¼ˆéœ€è¦è¾“å…¥ 'YES' ç¡®è®¤ï¼‰
python scripts/cleanup_old_monitoring_data.py --execute
```

**æ¸…ç†çš„ Collections**ï¼š

- `service_status` - æ—§æœåŠ¡çŠ¶æ€æ•°æ®
- `service_logs` - æ—§æœåŠ¡æ—¥å¿—æ•°æ®

**ä¿ç•™çš„ Collections**ï¼š

- `service_alerts` - å‘Šè­¦æ•°æ®ï¼ˆæ–°ç³»ç»Ÿä¹Ÿä¼šä½¿ç”¨ï¼‰
- `service_alert_rules` - å‘Šè­¦è§„åˆ™ï¼ˆæ–°ç³»ç»Ÿä¹Ÿä¼šä½¿ç”¨ï¼‰

**è­¦å‘Š**ï¼š

- âš ï¸ æ¸…ç†å‰å¿…é¡»å¤‡ä»½æ•°æ®ï¼ˆä½¿ç”¨ `backup_monitoring_data.py`ï¼‰
- âš ï¸ æ¸…ç†å‰å¿…é¡»ç¡®è®¤æ–°ç³»ç»Ÿå·²ç¨³å®šè¿è¡Œè‡³å°‘ 24 å°æ—¶
- âš ï¸ å»ºè®®å…ˆæ¸…ç†æµ‹è¯•ç¯å¢ƒï¼ŒéªŒè¯æ— è¯¯åå†æ¸…ç†ç”Ÿäº§ç¯å¢ƒ
- âš ï¸ æ¸…ç†æ“ä½œä¸å¯é€†ï¼Œè¯·è°¨æ…æ“ä½œ

---

## âœ… è¿ç§»åéªŒè¯

### åŠŸèƒ½éªŒè¯æ¸…å•

- [ ] æœåŠ¡ç›‘æ§æ­£å¸¸ï¼ˆæ‰€æœ‰æœåŠ¡çŠ¶æ€å¯æŸ¥è¯¢ï¼‰
- [ ] å‘Šè­¦æ­£å¸¸è§¦å‘å’Œé€šçŸ¥ï¼ˆæµ‹è¯•å‘Šè­¦è§¦å‘ï¼‰
- [ ] å‰ç«¯æ˜¾ç¤ºæ­£å¸¸ï¼ˆSystemServiceStatus å’Œ SystemMonitoring é¡µé¢ï¼‰
- [ ] æ€§èƒ½ç¬¦åˆè¦æ±‚ï¼ˆAPI å“åº”æ—¶é—´ã€èµ„æºå ç”¨ï¼‰
- [ ] æ—¥å¿—æ— å¼‚å¸¸ï¼ˆæ£€æŸ¥ FastAPI å’Œ Prometheus æ—¥å¿—ï¼‰

### æ€§èƒ½éªŒè¯

**API å“åº”æ—¶é—´**ï¼š

```bash
time curl http://localhost:8000/api/v1/admin/services
# åº”è¯¥ < 60msï¼ˆæ—§ç³»ç»ŸåŸºçº¿çš„ 1.2 å€ï¼‰
```

**èµ„æºå ç”¨**ï¼š

```bash
# æ£€æŸ¥å†…å­˜å ç”¨
ps aux | grep uvicorn

# æ£€æŸ¥ CPU å ç”¨
top -p $(pgrep -f "uvicorn api.main:app")
```

---

## ğŸ”™ å›æ»šæ­¥éª¤

å¦‚æœè¿ç§»å¤±è´¥ï¼ŒæŒ‰ä»¥ä¸‹æ­¥éª¤å›æ»šï¼š

### 1. ç¦ç”¨æ–°ç³»ç»Ÿ

```bash
python scripts/switch_monitoring_system.py disable
```

### 2. é‡å¯ FastAPI æœåŠ¡

```bash
pkill -f "uvicorn api.main:app"
uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload &
```

### 3. éªŒè¯æ—§ç³»ç»Ÿæ­£å¸¸

```bash
# æµ‹è¯• API
curl http://localhost:8000/api/v1/admin/services

# æ£€æŸ¥æ—¥å¿—
tail -f logs/api.log
```

### 4. æ¢å¤æ•°æ®ï¼ˆå¦‚æœéœ€è¦ï¼‰

å¦‚æœæ•°æ®ä¸¢å¤±ï¼Œå¯ä»¥ä»å¤‡ä»½æ¢å¤ï¼š

```python
# scripts/restore_monitoring_data.py
# ä»å¤‡ä»½æ–‡ä»¶æ¢å¤æ•°æ®åˆ° ArangoDB
```

---

## ğŸ“ æ”¯æŒä¸è”ç³»

### é—®é¢˜æŠ¥å‘Š

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ï¼š`logs/api.log`
2. æ‰§è¡ŒéªŒè¯è„šæœ¬ï¼š`python scripts/verify_monitoring_system.py`
3. æŸ¥çœ‹ Prometheus å’Œ Grafana æ—¥å¿—
4. è”ç³»å¼€å‘å›¢é˜Ÿ

### ç›¸å…³æ–‡æ¡£

- ã€Šç³»ç»Ÿç›‘æ§æ¶æ„æŠ€æœ¯è§„æ ¼ä¹¦ã€‹ï¼ˆSPEC-MONITOR-001ï¼‰
- ã€Šç³»ç»Ÿç›‘æ§è¿ç§»å®æ–½è®¡åˆ’ä¹¦ã€‹ï¼ˆPLAN-MONITOR-001ï¼‰
- Prometheus å®˜æ–¹æ–‡æ¡£: <https://prometheus.io/docs/>
- Grafana å®˜æ–¹æ–‡æ¡£: <https://grafana.com/docs/>

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2026-01-18 18:54 UTC+8
**ç»´æŠ¤äºº**: Daniel Chung
