# AI-Box 數據備份規範

**創建日期**: 2026-01-27
**創建人**: Daniel Chung
**最後修改日期**: 2026-01-27
**文檔版本**: 1.0

---

## 概述

本規範定義 AI-Box 專案的數據備份策略、頻率、保留規則和操作流程，嚴約束所有開發者、AI Agent 和執行者，防止數據丟失事件重演發生。

---

## 備份範圍

### 1. ArangoDB

| 項目 | 說明 |
|------|------|
| **備份內容** | 完整資料庫（所有 collections 和索引）|
| **備份方式** | `arangodump` 工具（Docker 容器內）|
| **備份位置** | `backups/arangodb/YYYYMMDD/arangodb_backup_HHMMSS.dump.gz` |
| **容器名稱** | `arangodb` |
| **數據卷** | `ai-box_arangodb_data` |

### 2. Qdrant

| 項目 | 說明 |
|------|------|
| **備份內容** | 向量資料庫（collections、vectors、payloads）|
| **備份方式** | 直接備份 `/qdrant/storage` 目錄 |
| **備份位置** | `backups/qdrant/YYYYMMDD/qdrant_backup_HHMMSS.tar.gz` |
| **容器名稱** | `qdrant` |
| **數據卷** | `qdrant_data` |

### 3. SeaWeedFS (AI-Box)

| 項目 | 說明 |
|------|------|
| **備份內容** | S3 兼容對象存儲（文件、buckets）|
| **備份方式** | 直接備份 `/data` 目錄 |
| **備份位置** | `backups/seaweedfs_ai_box/YYYYMMDD/seaweedfs_ai_box_backup_HHMMSS.tar.gz` |
| **容器名稱** | `seaweedfs` |
| **數據卷** | `seaweedfs_data` |

### 4. SeaWeedFS (DataLake)

| 項目 | 說明 |
|------|------|
| **備份內容** | DataLake 專案的 S3 存儲 |
| **備份方式** | 直接備份 `/data` 目錄 |
| **備份位置** | `backups/seaweedfs_datalake/YYYYMMDD/seaweedfs_datalake_backup_HHMMSS.tar.gz` |
| **容器名稱** | `seaweedfs-datalake` |
| **數據卷** | `seaweedfs_datalake_data` |

---

## 備份策略

### 頻率

| 類型 | 頻率 | 執行時間 |
|------|------|---------|
| **全量備份** | 每小時 | 每小時的第 0 分鐘 |

### 保留規則

| 類型 | 保留時間 | 清理策略 |
|------|---------|---------|
| **所有備份** | 7 天 | 自動刪除 7 天前的備份 |
| **每日第一個備份** | 30 天 |額外保留每日 00:00 的備份（未實現，待擴展）|

### 備份目錄結構

```
/Users/daniel/GitHub/AI-Box/backups/
├── arangodb/
│   ├── 20260127/
│   │   ├── arangodb_backup_000001.dump.gz
│   │   ├── arangodb_backup_010001.dump.gz
│   │   └── ...
│   └── 20260128/
├── qdrant/
│   ├── 20260127/
│   │   └── qdrant_backup_000001.tar.gz
│   └── ...
├── seaweedfs_ai_box/
│   └── ...
└── seaweedfs_datalake/
    └── ...
```

---

## 操作規範

### 禁止操作（嚴禁執行）

**任何操作者（人類或 AI Agent）均不得執行以下操作：**

1. ❌ **刪除 Docker 容器**（除非用戶明確要求且已確認備份）
   - `docker rm <container_name>`
   - `docker stop <container> && docker rm <container>`
   - `docker-compose down`（會刪除容器）
   - **特別禁止**：刪除包含數據的容器（如 `seaweedfs-ai-box-filer`、`arangodb`、`qdrant`）
   - **必須**：先檢查數據持久化狀態和備份狀態

2. ❌ **刪除或重建數據卷**（除非有明確的備份恢復計劃）
   - `docker volume rm ai-box_arangodb_data`
   - `docker volume rm qdrant_data`
   - `docker volume rm seaweedfs_data`
   - `docker volume rm seaweedfs-ai-box-filer-data`（2026-01-28 新增）

3. ❌ **清空數據庫**（除非有明確授權）
   - `DROP DATABASE ai_box_kg`
   - `FOR c IN collections DROP c` (AQL)

4. ❌ **直接刪除備份檔案**
   - 備份檔案只能通過備份腳本的自動清理機制刪除
   - 手動刪除需要文檔記錄原因和批准人

5. ❌ **修改備份腳本邏輯**
   - 任何對 `scripts/backup_all.py` 的修改需要審查
   - 修改前必須測試備份恢復流程

6. ❌ **忽略備份失敗**
   - 備份失敗必須立即報告
   - 不能繼續進行可能影響數據的操作

7. ❌ **停止關鍵服務容器**（除非用戶明確要求）
   - `docker stop arangodb`
   - `docker stop seaweedfs-ai-box-filer`
   - `docker stop qdrant`
   - `docker stop redis`

### 強制操作（必須執行）

1. ✅ **定時備份**
   - 必須設置 cron job 每小時執行備份
   - 監控備份執行日誌

2. ✅ **數據修改前備份**
   - 在重大系統升級、架構變更前手動執行一次全量備份
   - 標記備份用途（如 `pre_upgrade_20260127`）

3. ✅ **備份驗證**
   - 定期（每週）執行一次備份恢復測試
   - 記錄恢復結果

4. ✅ **監控備份存儲空間**
   - 監控 `backups/` 目錄大小
   - 當超過閾值時告警

5. ✅ **文檔記錄**
   - 所有手動數據操作（清空、重建、遷移）必須在 AGENTS.md 或 issue 中記錄
   - 記錄原因、影響範圍、恢復計劃

---

## 恢復流程

### 推薦方式：使用統一恢復腳本

**使用 `scripts/restore_all.py` 統一恢復所有服務：**

```bash
# 恢復單個服務（會自動選擇最新備份，並提示確認）
python scripts/restore_all.py arangodb
python scripts/restore_all.py qdrant
python scripts/restore_all.py seaweedfs_ai_box
python scripts/restore_all.py seaweedfs_datalake

# 恢復所有服務
python scripts/restore_all.py all

# 指定備份文件恢復
python scripts/restore_all.py arangodb --backup backups/arangodb/20260127/arangodb_backup_120000.dump.gz

# 跳過確認提示
python scripts/restore_all.py arangodb --no-confirm
```

### 手動恢復方式（不推薦，僅供參考）

#### ArangoDB 恢復

```bash
# 1. 停止 ArangoDB 容器
docker stop arangodb

# 2. 清空數據卷（謹慎！）
docker volume rm ai-box_arangodb_data

# 3. 創建新的數據卷
docker volume create ai-box_arangodb_data

# 4. 啟動容器
docker start arangodb
sleep 10

# 5. 從備份恢復
docker exec arangodb arangorestore \
  --server.endpoint tcp://localhost:8529 \
  --server.username root \
  --server.password ai_box_arangodb_password \
  --server.database ai_box_kg \
  --input-directory /tmp/backup \
  --overwrite true

# 6. 驗證恢復
curl -u root:ai_box_arangodb_password http://localhost:8529/_api/collection
```

#### Qdrant 恢復

```bash
# 1. 停止 Qdrant 容器
docker stop qdrant

# 2. 清空數據卷（謹慎！）
docker volume rm qdrant_data

# 3. 創建新的數據卷
docker volume create qdrant_data

# 4. 解壓備份到臨時目錄
tar -xzf backups/qdrant/20260127/qdrant_backup_000001.tar.gz -C /tmp

# 5. 複製到數據卷
docker cp /tmp/storage qdrant:/qdrant/

# 6. 啟動容器
docker start qdrant

# 7. 驗證恢復
curl http://localhost:6333/collections
```

#### SeaWeedFS 恢復

```bash
# 1. 停止 SeaWeedFS 容器
docker stop seaweedfs

# 2. 清空數據卷（謹慎！）
docker volume rm seaweedfs_data

# 3. 創建新的數據卷
docker volume create seaweedfs_data

# 4. 解壓備份到臨時目錄
tar -xzf backups/seaweedfs_ai_box/20260127/seaweedfs_ai_box_backup_000001.tar.gz -C /tmp

# 5. 複製到數據卷
docker cp /tmp/data seaweedfs:/data

# 6. 啟動容器
docker start seaweedfs

# 7. 驗證恢復
curl http://localhost:8888/healthz
```

---

## 定時任務設置

### Crontab 配置

```bash
# 編輯 crontab
crontab -e

# 添加定時備份（每小時執行）
0 * * * * cd /Users/daniel/GitHub/AI-Box && /Users/daniel/GitHub/AI-Box/venv/bin/python scripts/backup_all.py >> /Users/daniel/GitHub/AI-Box/logs/backup.log 2>&1

# 保存並退出
```

### 或使用 launchd (macOS)

創建 `/Library/LaunchDaemons/com.aibox.backup.plist`:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.aibox.backup</string>
    <key>ProgramArguments</key>
    <array>
        <string>/Users/daniel/GitHub/AI-Box/venv/bin/python</string>
        <string>/Users/daniel/GitHub/AI-Box/scripts/backup_all.py</string>
    </array>
    <key>StartInterval</key>
    <integer>3600</integer>
    <key>WorkingDirectory</key>
    <string>/Users/daniel/GitHub/AI-Box</string>
    <key>StandardOutPath</key>
    <string>/Users/daniel/GitHub/AI-Box/logs/backup.log</string>
    <key>StandardErrorPath</key>
    <string>/Users/daniel/GitHub/AI-Box/logs/backup.error.log</string>
</dict>
</plist>
```

載入：

```bash
sudo launchctl load /Library/LaunchDaemons/com.aibox.backup.plist
sudo launchctl start com.aibox.backup
```

---

## 監控和告警

### 日誌位置

| 類型 | 位置 |
|------|------|
| 備份日誌 | `logs/backup.log` |
| 備份錯誤 | `logs/backup.error.log` |
| structlog 日誌 | 通過日志服務聚合 |

### 監控指標

1. **備份成功率**
   - 預期: > 95%
   - 告警: < 90% 連續 3 次失敗

2. **備份完成時間**
   - 預期: < 10 分鐘
   - 告警: > 30 分鐘

3. **備份存儲空間**
   - 預期: < 50GB
   - 告警: > 80GB

4. **備份檔案完整性**
   - 定期驗證備份檔案可解壓
   - 告警: 備份檔案損壞

---

## 緊急處理流程

### 備份失敗時

1. 立即檢查日誌：`tail -f logs/backup.error.log`
2. 手動執行備份：`python scripts/backup_all.py`
3. 若手動備份也失敗：
   - 檢查 Docker 容器狀態：`docker ps -a`
   - 檢查磁盤空間：`df -h`
   - 檢查網絡連接
4. 若無法恢復：
   - 立即通知團隊
   - 考慮手動備份關鍵數據
   - 標記系統為"只讀"狀態

### 數據丟失時

1. **立即停止所有數據修改操作**
   - 停止 API Server
   - 停止 RQ Workers
   - 停止相關服務

2. **確認丟失範圍**
   - 檢查哪些 collections/檔案受影響
   - 記錄丟失時間範圍

3. **選擇恢復策略**
   - 全量恢復：從最近的完整備份恢復
   - 增量恢復：從最近的備份開始，重放日誌（未實現）

4. **執行恢復**
   - 按照上文「恢復流程」執行
   - 驗證恢復結果

5. **事故回顧**
   - 分析原因
   - 更新規範
   - 防止再次發生

---

## 培訂歷史

| 版本 | 日期 | 修改人員 | 修改內容 |
|------|------|---------|---------|
| 1.0 | 2026-01-27 | Daniel Chung | 初始版本，回應 2026-01-25 數據丟失事件 |

---

## 參考文檔

### 腳本文檔
- **備份腳本**: `scripts/backup_all.py` - 自動備份所有服務
- **恢復腳本**: `scripts/restore_all.py` - 統一恢復所有服務
- **配置恢復腳本**: `scripts/migration/restore_configs.py` - 恢復 GenAI 配置
- **Ontology 遷移腳本**: `scripts/migration/migrate_ontologies.py` - 從 JSON 文件導入 Ontology

### 架構文檔
- [AI-Box 架構規劃](../../白皮書/AI-Box-架構規劃.md)
- [ArangoDB 備份文檔](https://docs.arangodb.com/stable/deployment/backup-restore/)
- [Qdrant 備份文檔](https://qdrant.tech/documentation/guides/operations/production_backups/)
- [Docker Volume 最佳實踐](https://docs.docker.com/storage/volumes/)

### 設置腳本
- **備份任務設置**: `scripts/setup_backup_cron.sh` - 設置定時備份任務
- **launchd 配置**: `scripts/com.aibox.backup.plist` - macOS 定時任務配置

---

**重要提醒**：

⚠️ **任何數據相關操作（清空、重建、遷移）前必須**：
1. 確認最近的備份成功
2. 手動執行一次完整備份
3. 在 AGENTS.md 或 issue 中記錄操作原因和計劃
4. 獲得團隊批准（對於生產環境）

❌ **嚴禁**在未完成上述步驟的情況下執行數據銷毀操作。
