# æ¨¡å‹å ´æ™¯èª¿ç”¨åƒæ•¸é…ç½®å¯¦æ–½å·¥è¨ˆåŠƒæ›¸

**ç‰ˆæœ¬**: 1.0
**å‰µå»ºæ—¥æœŸ**: 2026-01-20
**å‰µå»ºäºº**: Daniel Chung
**è¨ˆåŠƒé€±æœŸ**: 2026-01-20 ~ 2026-02-20 (4é€±)

---

## 1. å°ˆæ¡ˆæ¦‚è¿°

### 1.1 å°ˆæ¡ˆç›®æ¨™

å¯¦ä½œ AI-Box LLM æ¨¡å‹å ´æ™¯èª¿ç”¨åƒæ•¸é…ç½®ç³»çµ±ï¼Œå¯¦ç¾ï¼š

- 6 å€‹å·¥ä½œå ´æ™¯çš„æ¨¡å‹å„ªå…ˆç´šé…ç½®
- å®Œæ•´çš„åƒæ•¸æ§åˆ¶ï¼ˆcontext_sizeã€temperatureã€timeout ç­‰ï¼‰
- ç”¨æˆ¶åå¥½ç®¡ç†ï¼ˆåªé‡å° chat å ´æ™¯ï¼‰
- ç›£æ§èˆ‡æˆæœ¬è¿½è¹¤

### 1.2 å°ˆæ¡ˆç¯„åœ

| åŒ…å« | ä¸åŒ…å« |
|------|--------|
| config.json é…ç½®çµæ§‹æ›´æ–° | ç¾æœ‰ LLM Client é‡æ§‹ |
| MoE Manager å ´æ™¯è·¯ç”± | Gemini æ¨¡å‹é·ç§» |
| ç”¨æˆ¶åå¥½æœå‹™ | å‰ç«¯ç•Œé¢é–‹ç™¼ |
| ç›£æ§æŒ‡æ¨™æ”¶é›† | æˆæœ¬è¨ˆè²»ç³»çµ± |

---

## 2. ç¾æœ‰åŠŸèƒ½ç›¤é»

### 2.1 é…ç½®ç›¸é—œ

| ç¾æœ‰åŠŸèƒ½ | ä½ç½® | ç‹€æ…‹ | èªªæ˜ |
|----------|------|------|------|
| ollama é…ç½® | `config/config.json` | âœ… å­˜åœ¨ | åªåŒ…å« hostã€portã€timeout |
| LLM Provider é…ç½® | `services/api/services/llm_provider_config_service.py` | âœ… å­˜åœ¨ | Provider ç´šåˆ¥é…ç½® |
| OllamaSettings | `services/api/core/settings.py` | âœ… å­˜åœ¨ | åŸºç¤è¨­ç½® |
| æ¨¡å‹é…ç½®å®šç¾© | `services/api/core/config/definitions/` | âœ… å­˜åœ¨ | JSON Schema å®šç¾© |

### 2.2 æ¨¡å‹èª¿ç”¨ç›¸é—œ

| ç¾æœ‰åŠŸèƒ½ | ä½ç½® | ç‹€æ…‹ | èªªæ˜ |
|----------|------|------|------|
| NER Service | `genai/api/services/ner_service.py` | âœ… å­˜åœ¨ | ä½¿ç”¨ config + ç’°å¢ƒè®Šæ•¸ |
| RE Service | `genai/api/services/re_service.py` | âœ… å­˜åœ¨ | åŒä¸Š |
| RT Service | `genai/api/services/rt_service.py` | âœ… å­˜åœ¨ | åŒä¸Š |
| Embedding Service | `services/api/services/embedding_service.py` | âœ… å­˜åœ¨ | ä½¿ç”¨ config |
| Router LLM | `agents/task_analyzer/router_llm.py` | âœ… å­˜åœ¨ | ç¡¬ç·¨ç¢¼é è¨­æ¨¡å‹ |
| MoE Manager | `llm/moe/moe_manager.py` | âœ… å­˜åœ¨ | åŸºç¤è·¯ç”±åŠŸèƒ½ |

### 2.3 æ•¸æ“šåº«ç›¸é—œ

| ç¾æœ‰åŠŸèƒ½ | ä½ç½® | ç‹€æ…‹ | èªªæ˜ |
|----------|------|------|------|
| ArangoDB Client | `database/arangodb/client.py` | âœ… å­˜åœ¨ | åŸºç¤é€£æ¥ |
| Config Store Service | `services/api/services/config_store_service.py` | âœ… å­˜åœ¨ | é…ç½®å­˜å– |
| System Config Registry | `services/api/services/system_config_registry_service.py` | âœ… å­˜åœ¨ | ç³»çµ±é…ç½® |

### 2.4 éœ€è¦ä¿®æ”¹çš„åŠŸèƒ½

| åŠŸèƒ½ | ä¿®æ”¹é» | ä¿®æ”¹é¡å‹ |
|------|--------|----------|
| NER Service | `model_name` é è¨­å€¼ | åƒæ•¸åŒ– |
| RE Service | `model_name` é è¨­å€¼ | åƒæ•¸åŒ– |
| RT Service | `model_name` é è¨­å€¼ | åƒæ•¸åŒ– |
| Router LLM | `ROUTER_LLM_DEFAULT_MODEL` | åƒæ•¸åŒ– |
| MoE Manager | æ–°å¢ `select_model(scene)` æ–¹æ³• | æ–°åŠŸèƒ½ |
| config.json | æ–°å¢ `moe.model_priority` å€å¡Š | æ–°å¢ |

---

## 3. æº–å‚™å·¥ä½œ

### 3.1 ç’°å¢ƒæº–å‚™

```bash
# 1. ç¢ºèª Python ç‰ˆæœ¬
python --version  # éœ€ 3.12+

# 2. ç¢ºèªè™›æ“¬ç’°å¢ƒ
source venv/bin/activate

# 3. å®‰è£ç›¸ä¾å¥—ä»¶ï¼ˆå¦‚éœ€è¦ï¼‰
pip install qdrant-client  # å·²å®‰è£
```

### 3.2 æ–‡æª”æº–å‚™

| æ–‡æª” | ç‹€æ…‹ |
|------|------|
| æ¨¡å‹å ´æ™¯èª¿ç”¨åƒæ•¸é…ç½®è¦æ ¼æ›¸.md | âœ… å·²å»ºç«‹ |
| config/config.json çµæ§‹å®šç¾© | âœ… å·²å»ºç«‹ |
| API æ¥å£è¨­è¨ˆæ–‡æª” | âœ… è¦æ ¼æ›¸ä¸­åŒ…å« |
| æ•¸æ“šåº« Schema | âœ… è¦æ ¼æ›¸ä¸­åŒ…å« |

### 3.3 æ¸¬è©¦æ•¸æ“šæº–å‚™

```python
# æ¸¬è©¦æ¨¡å‹å¯ç”¨æ€§
import httpx

# æ¸¬è©¦ Ollama æ¨¡å‹åˆ—è¡¨
response = httpx.get("http://localhost:11434/api/tags")
models = response.json()["models"]

# é æœŸæ¨¡å‹åˆ—è¡¨
expected_models = [
    "gpt-oss:120b-cloud",
    "glm-4.7:cloud",
    "llama3.2:latest",
    "nomic-embed-text:latest",
    "mistral-nemo:12b"
]
```

---

## 4. è©³ç´°ä¿®æ”¹è¨ˆåŠƒ

### 4.1 Phase 1: é…ç½®çµæ§‹æ›´æ–° (ç¬¬1é€±)

| ä»»å‹™ | è² è²¬äºº | é ä¼°å·¥æ™‚ | äº¤ä»˜ç‰© |
|------|--------|----------|--------|
| æ›´æ–° config/config.json | Daniel | 2h | æ–°å¢ moe.model_priority |
| å»ºç«‹ç’°å¢ƒè®Šæ•¸å°æ‡‰ | Daniel | 1h | ç’°å¢ƒè®Šæ•¸åˆ—è¡¨ |
| å–®å…ƒæ¸¬è©¦åŸºç¤çµæ§‹ | Daniel | 2h | test_moe_config.py |

**è©³ç´°æ­¥é©Ÿ**:

```bash
# 1. å‚™ä»½ç¾æœ‰ config
cp config/config.json config/config.json.backup

# 2. æ–°å¢ moe é…ç½®å€å¡Šï¼ˆä½¿ç”¨ JSON Patchï¼‰
# è¦‹é™„éŒ„ A: config.json patch
```

**é©—æ”¶æ¨™æº–**:

- [ ] config.json èªæ³•æ­£ç¢º
- [ ] ç’°å¢ƒè®Šæ•¸å¯è¦†è“‹é…ç½®
- [ ] å–®å…ƒæ¸¬è©¦é€šé

---

### 4.2 Phase 2: MoE Manager æ“´å±• (ç¬¬2é€±)

| ä»»å‹™ | è² è²¬äºº | é ä¼°å·¥æ™‚ | äº¤ä»˜ç‰© |
|------|--------|----------|--------|
| æ–°å¢å ´æ™¯è·¯ç”±æ–¹æ³• | Daniel | 4h | `select_model(scene, user_id)` |
| å¯¦ç¾å‚™ç”¨æ¨¡å‹åˆ‡æ› | Daniel | 3h | auto_fallback é‚è¼¯ |
| å¯¦ç¾ç”¨æˆ¶åå¥½è®€å– | Daniel | 2h | user_preference è®€å– |
| æ›´æ–°é…ç½®è®€å–é‚è¼¯ | Daniel | 2h | config è§£æ |

**è©³ç´°æ­¥é©Ÿ**:

```python
# llm/moe/moe_manager.py æ–°å¢æ–¹æ³•

class LLMMoEManager:
    async def select_model(
        self,
        scene: str,
        user_id: Optional[str] = None,
        context: Optional[Dict[str, Any]] = None
    ) -> ModelSelectionResult:
        """
        æ ¹æ“šå ´æ™¯é¸æ“‡æ¨¡å‹

        1. è®€å–å ´æ™¯é…ç½®
        2. å¦‚æœæ˜¯ chat ä¸”æœ‰ç”¨æˆ¶åå¥½ï¼Œå„ªå…ˆä½¿ç”¨
        3. æŒ‰å„ªå…ˆç´šéæ­·æ¨¡å‹
        4. æª¢æŸ¥æ¨¡å‹å¯ç”¨æ€§
        5. è¿”å›å¯ç”¨æ¨¡å‹
        """
        # å®ç°é€»è¾‘
```

**é©—æ”¶æ¨™æº–**:

- [ ] 6 å€‹å ´æ™¯éƒ½èƒ½æ­£ç¢ºé¸æ“‡æ¨¡å‹
- [ ] å‚™ç”¨æ¨¡å‹åˆ‡æ›æ­£å¸¸å·¥ä½œ
- [ ] ç”¨æˆ¶åå¥½å° chat å ´æ™¯ç”Ÿæ•ˆ

---

### 4.3 Phase 3: æœå‹™æ›´æ–° (ç¬¬2-3é€±)

| ä»»å‹™ | è² è²¬äºº | é ä¼°å·¥æ™‚ | äº¤ä»˜ç‰© |
|------|--------|----------|--------|
| æ›´æ–° NER Service | Daniel | 2h | ä½¿ç”¨ MoE é…ç½® |
| æ›´æ–° RE Service | Daniel | 2h | ä½¿ç”¨ MoE é…ç½® |
| æ›´æ–° RT Service | Daniel | 2h | ä½¿ç”¨ MoE é…ç½® |
| æ›´æ–° Router LLM | Daniel | 2h | ä½¿ç”¨ MoE é…ç½® |
| æ›´æ–° Embedding Service | Daniel | 2h | ä½¿ç”¨ MoE é…ç½® |
| æ›´æ–° KG Extraction | Daniel | 2h | ä½¿ç”¨ MoE é…ç½® |

**æ›´æ–°æ¨¡æ¿**:

```python
# Before (èˆŠç¨‹å¼ç¢¼)
class NERService:
    def __init__(self):
        self.model_name = "mistral-nemo:12b"  # ç¡¬ç·¨ç¢¼

# After (æ–°ç¨‹å¼ç¢¼)
class NERService:
    def __init__(self):
        moe = LLMMoEManager()
        result = moe.select_model("knowledge_graph_extraction")
        self.model_name = result.model
        self.timeout = result.timeout
```

**é©—æ”¶æ¨™æº–**:

- [ ] æ‰€æœ‰æœå‹™ä½¿ç”¨é…ç½®çš„åƒæ•¸
- [ ] åƒæ•¸è¦†è“‹æ­£ç¢ºç”Ÿæ•ˆ
- [ ] å‚™ç”¨æ¨¡å‹æ­£å¸¸å·¥ä½œ

---

### 4.4 Phase 4: API èˆ‡ç›£æ§ (ç¬¬3é€±)

| ä»»å‹™ | è² è²¬äºº | é ä¼°å·¥æ™‚ | äº¤ä»˜ç‰© |
|------|--------|----------|--------|
| æ¨¡å‹é¸æ“‡ API | Daniel | 3h | `/api/v1/moe/select` |
| ç”¨æˆ¶åå¥½ API | Daniel | 3h | `/api/v1/moe/user-preference` |
| é…ç½®æŸ¥è©¢ API | Daniel | 2h | `/api/v1/moe/config/{scene}` |
| ç›£æ§æŒ‡æ¨™ | Daniel | 2h | prometheus metrics |

**API å¯¦ç¾**:

```python
# api/routers/moe_router.py

@router.get("/select")
async def select_model(
    scene: str,
    user_id: str = Depends(get_current_user),
    context: Optional[str] = None
) -> JSONResponse:
    """æ ¹æ“šå ´æ™¯é¸æ“‡æ¨¡å‹"""
    moe = get_moe_manager()
    result = await moe.select_model(
        scene=scene,
        user_id=user_id.user_id,
        context=json.loads(context) if context else None
    )
    return APIResponse.success(data=result)
```

**é©—æ”¶æ¨™æº–**:

- [ ] API è¿”å›æ­£ç¢ºçš„æ¨¡å‹é…ç½®
- [ ] ç›£æ§æŒ‡æ¨™å¯æ”¶é›†
- [ ] æ—¥èªŒè¨˜éŒ„å®Œæ•´

---

### 4.5 Phase 5: ç”¨æˆ¶åå¥½èˆ‡æ•¸æ“šåº« (ç¬¬3-4é€±)

| ä»»å‹™ | è² è²¬äºº | é ä¼°å·¥æ™‚ | äº¤ä»˜ç‰© |
|------|--------|----------|--------|
| å»ºç«‹ Collection | Daniel | 1h | ArangoDB collection |
| User Preference Service | Daniel | 3h | CRUD æœå‹™ |
| å‰ç«¯ API å°æ¥ | Daniel | 2h | API æ–‡ä»¶ |

**æ•¸æ“šåº« Collection**:

```json
{
  "collection": "user_model_preferences",
  "schema": {
    "user_id": "string (primary key)",
    "chat_model": "string",
    "created_at": "datetime",
    "updated_at": "datetime"
  }
}
```

**é©—æ”¶æ¨™æº–**:

- [ ] ç”¨æˆ¶åå¥½å¯æ­£ç¢ºå­˜å–
- [ ] chat å ´æ™¯å„ªå…ˆä½¿ç”¨ç”¨æˆ¶åå¥½
- [ ] æ•¸æ“šåº«æŸ¥è©¢æ•ˆèƒ½æ­£å¸¸

---

### 4.6 Phase 6: æ¸¬è©¦èˆ‡æ–‡æª” (ç¬¬4é€±)

| ä»»å‹™ | è² è²¬äºº | é ä¼°å·¥æ™‚ | äº¤ä»˜ç‰© |
|------|--------|----------|--------|
| å–®å…ƒæ¸¬è©¦ | Daniel | 4h | test_moe_*.py |
| é›†æˆæ¸¬è©¦ | Daniel | 4h | test_moe_integration.py |
| API æ–‡ä»¶ | Daniel | 2h | OpenAPI spec |
| æ›´æ–° AGENTS.md | Daniel | 1h | æ–°å¢é…ç½®èªªæ˜ |

---

## 5. é€²åº¦ç®¡æ§

### 5.1 åŸ·è¡Œé€²åº¦è¿½è¹¤è¡¨

| Phase | å·¥ä½œé …ç›® | é–‹å§‹æ—¥æœŸ | å®Œæˆæ—¥æœŸ | ç‹€æ…‹ | é©—æ”¶çµæœ |
|-------|----------|----------|----------|------|----------|
| **Phase 1** | é…ç½®çµæ§‹æ›´æ–° | 2026-01-20 | 2026-01-20 | âœ… å®Œæˆ | JSON èªæ³•é©—è­‰é€šéï¼Œ6 å ´æ™¯é…ç½®å®Œæˆ |
| **Phase 2** | MoE Manager æ“´å±• | 2026-01-20 | 2026-01-20 | âœ… å®Œæˆ | select_model() æ–¹æ³•æ­£å¸¸å·¥ä½œ |
| **Phase 3** | æœå‹™æ›´æ–° | 2026-01-20 | 2026-01-20 | âœ… å®Œæˆ | NER/RE/RT/Embedding Service æ•´åˆ MoE é…ç½® |
| **Phase 4** | API èˆ‡ç›£æ§ | 2026-01-20 | 2026-01-20 | âœ… å®Œæˆ | å»ºç«‹ /api/v1/moe/* API Endpoints |
| **Phase 5** | ç”¨æˆ¶åå¥½èˆ‡æ•¸æ“šåº« | 2026-01-20 | 2026-01-20 | âœ… å®Œæˆ | ArangoDB + å›é€€å­˜å„²ï¼Œselect_model æ•´åˆç”¨æˆ¶åå¥½ |
| **Phase 6** | æ¸¬è©¦èˆ‡æ–‡æª” | 2026-01-20 | 2026-01-20 | âœ… å®Œæˆ | 41 å–®å…ƒæ¸¬è©¦é€šéï¼ŒAGENTS.md å·²æ›´æ–° |

### 5.2 å ´æ™¯é…ç½®å®Œæˆç‹€æ…‹

| å ´æ™¯ | å‰ç«¯å¯ç·¨è¼¯ | é¦–é¸æ¨¡å‹ | å‚™ç”¨æ•¸ | ç‹€æ…‹ |
|------|------------|----------|--------|------|
| chat | âœ… | gpt-oss:120b-cloud | 2 | âœ… å®Œæˆ |
| semantic_understanding | âŒ | gpt-oss:120b-cloud | 2 | âœ… å®Œæˆ |
| task_analysis | âŒ | gpt-oss:120b-cloud | 2 | âœ… å®Œæˆ |
| orchestrator | âŒ | gpt-oss:120b-cloud | 2 | âœ… å®Œæˆ |
| embedding | âŒ | nomic-embed-text:latest | 1 | âœ… å®Œæˆ |
| knowledge_graph_extraction | âŒ | gpt-oss:120b-cloud | 2 | âœ… å®Œæˆ |

### 5.3 åŠŸèƒ½é–‹é—œç‹€æ…‹

| åŠŸèƒ½ | è¨­å®šå€¼ | ç‹€æ…‹ |
|------|--------|------|
| user_preference_enabled | true | âœ… å·²å¯¦ä½œ |
| adaptive_learning_enabled | false | âŒ (æœªå¯¦ä½œ) |
| cost_tracking_enabled | false | âŒ (æœªå¯¦ä½œ) |
| auto_fallback_enabled | true | âœ… å·²å¯¦ä½œ |

### 5.4 æ–°å¢/ä¿®æ”¹æª”æ¡ˆ

| æª”æ¡ˆ | èªªæ˜ | ç‹€æ…‹ |
|------|------|------|
| `llm/moe/scene_routing.py` | å ´æ™¯è·¯ç”±é…ç½®æ¨¡çµ„ (ModelConfig, SceneConfig, ModelSelectionResult) | âœ… å·²å»ºç«‹ |
| `llm/moe/user_preference.py` | ç”¨æˆ¶åå¥½è®€å–ä»‹é¢ | âœ… å·²å»ºç«‹ |
| `LLMMoEManager.select_model()` | å ´æ™¯æ¨¡å‹é¸æ“‡æ–¹æ³• | âœ… å·²å¯¦ä½œ |
| `LLMMoEManager.get_available_scenes()` | ç²å–å¯ç”¨å ´æ™¯ | âœ… å·²å¯¦ä½œ |
| `LLMMoEManager.get_scene_config()` | ç²å–å ´æ™¯é…ç½® | âœ… å·²å¯¦ä½œ |
| `LLMMoEManager._get_user_preference()` | ç²å–ç”¨æˆ¶åå¥½ | âœ… å·²å¯¦ä½œ |
| `api/routers/moe.py` | MoE API Router (10 å€‹ endpoints) | âœ… å·²å»ºç«‹ |
| `services/api/services/moe_user_preference_service.py` | MoE ç”¨æˆ¶åå¥½æœå‹™ (ArangoDB + å›é€€) | âœ… å·²å»ºç«‹ |
| `genai/api/services/ner_service.py` | æ•´åˆ MoE é…ç½® | âœ… å·²ä¿®æ”¹ |
| `genai/api/services/re_service.py` | æ•´åˆ MoE é…ç½® | âœ… å·²ä¿®æ”¹ |
| `genai/api/services/rt_service.py` | æ•´åˆ MoE é…ç½® | âœ… å·²ä¿®æ”¹ |
| `services/api/services/embedding_service.py` | æ•´åˆ MoE é…ç½® | âœ… å·²ä¿®æ”¹ |
| `api/main.py` | è¨»å†Š MoE Router | âœ… å·²ä¿®æ”¹ |

### 5.5 æœå‹™æ•´åˆç‹€æ…‹

| æœå‹™ | å ´æ™¯ | ä½¿ç”¨ MoE é…ç½® | é©—è­‰çµæœ |
|------|------|--------------|----------|
| NER Service | knowledge_graph_extraction | âœ… | gpt-oss:120b-cloud, temp=0.2, timeout=180s |
| RE Service | knowledge_graph_extraction | âœ… | gpt-oss:120b-cloud, temp=0.2, timeout=180s |
| RT Service | knowledge_graph_extraction | âœ… | gpt-oss:120b-cloud, temp=0.2, timeout=180s |
| Embedding Service | embedding | âœ… | nomic-embed-text:latest, timeout=120s |

### 5.6 API Endpoints

| Method | Endpoint | åŠŸèƒ½ | ç‹€æ…‹ |
|--------|----------|------|------|
| GET | `/api/v1/moe/scenes` | ç²å–æ‰€æœ‰å¯ç”¨å ´æ™¯ | âœ… å·²å¯¦ä½œ |
| GET | `/api/v1/moe/scenes/{scene}/config` | ç²å–ç‰¹å®šå ´æ™¯é…ç½® | âœ… å·²å¯¦ä½œ |
| POST | `/api/v1/moe/select` | æ ¹æ“šå ´æ™¯é¸æ“‡æ¨¡å‹ | âœ… å·²å¯¦ä½œ |
| GET | `/api/v1/moe/select` | æ ¹æ“šå ´æ™¯é¸æ“‡æ¨¡å‹ (GET) | âœ… å·²å¯¦ä½œ |
| GET | `/api/v1/moe/features` | ç²å–åŠŸèƒ½é–‹é—œç‹€æ…‹ | âœ… å·²å¯¦ä½œ |
| GET | `/api/v1/moe/user-preferences` | ç²å–ç”¨æˆ¶æ‰€æœ‰åå¥½ | âœ… å·²å¯¦ä½œ |
| GET | `/api/v1/moe/user-preferences/{scene}` | ç²å–ç”¨æˆ¶ç‰¹å®šå ´æ™¯åå¥½ | âœ… å·²å¯¦ä½œ |
| PUT | `/api/v1/moe/user-preferences/{scene}` | è¨­ç½®ç”¨æˆ¶ç‰¹å®šå ´æ™¯åå¥½ | âœ… å·²å¯¦ä½œ |
| DELETE | `/api/v1/moe/user-preferences/{scene}` | åˆªé™¤ç”¨æˆ¶ç‰¹å®šå ´æ™¯åå¥½ | âœ… å·²å¯¦ä½œ |

### 5.7 ç”¨æˆ¶åå¥½åŠŸèƒ½

| åŠŸèƒ½ | ç‹€æ…‹ | èªªæ˜ |
|------|------|------|
| ç”¨æˆ¶åå¥½è®€å– | âœ… | å¾ ArangoDB æˆ–å›é€€å­˜å„²è®€å– |
| ç”¨æˆ¶åå¥½å¯«å…¥ | âœ… | å­˜å…¥ ArangoDB æˆ–å›é€€å­˜å„² |
| ç”¨æˆ¶åå¥½åˆªé™¤ | âœ… | åˆªé™¤ç”¨æˆ¶åå¥½ |
| MoE æ•´åˆ | âœ… | select_model() å„ªå…ˆä½¿ç”¨ç”¨æˆ¶åå¥½ |
| å›é€€å­˜å„² | âœ… | ç•¶ ArangoDB ä¸å¯ç”¨æ™‚ä½¿ç”¨å…§å­˜å›é€€ |

### 5.8 ç”˜ç‰¹åœ–

```
é€±æ¬¡    | 1    | 2    | 3    | 4    |
--------|------|------|------|------|
Phase 1 | â–ˆâ–ˆâ–ˆâ–ˆ |      |      |      | âœ… å·²å®Œæˆ
Phase 2 | â–ˆâ–ˆâ–ˆâ–ˆ |      |      |      | âœ… å·²å®Œæˆ
Phase 3 | â–ˆâ–ˆâ–ˆâ–ˆ |      |      |      | âœ… å·²å®Œæˆ
Phase 4 | â–ˆâ–ˆâ–ˆâ–ˆ |      |      |      | âœ… å·²å®Œæˆ
Phase 5 | â–ˆâ–ˆâ–ˆâ–ˆ |      |      |      | âœ… å·²å®Œæˆ
Phase 6 |      |      | â–ˆâ–ˆâ–ˆâ–ˆ | â–ˆâ–ˆâ–ˆâ–ˆ | ğŸ”„ é€²è¡Œä¸­
```

### 5.9 æ¯é€±æª¢æŸ¥é»

| é€±æ¬¡ | æª¢æŸ¥æ—¥æœŸ | æª¢æŸ¥é …ç›® | ç‹€æ…‹ |
|------|----------|----------|------|
| 1 | 2026-01-20 | Phase 1-6: æ‰€æœ‰éšæ®µå…¨éƒ¨å®Œæˆ | âœ… å®Œæˆ |

### 5.10 æ¸¬è©¦çµæœæ‘˜è¦

| æ¸¬è©¦é¡åˆ¥ | æ¸¬è©¦æ•¸é‡ | é€šé | å¤±æ•— |
|----------|----------|------|------|
| å ´æ™¯è·¯ç”±æ¸¬è©¦ | 15 | 15 | 0 |
| MoE Manager æ¸¬è©¦ | 13 | 13 | 0 |
| ç”¨æˆ¶åå¥½æœå‹™æ¸¬è©¦ | 13 | 13 | 0 |
| **ç¸½è¨ˆ** | **41** | **41** | **0** |

### 5.11 æ¸¬è©¦æª”æ¡ˆåˆ—è¡¨

| æª”æ¡ˆ | èªªæ˜ |
|------|------|
| `tests/llm/moe/test_scene_routing.py` | å ´æ™¯è·¯ç”±é…ç½®æ¸¬è©¦ |
| `tests/llm/moe/test_moe_manager.py` | MoE Manager åŠŸèƒ½æ¸¬è©¦ |
| `tests/llm/moe/test_user_preference.py` | ç”¨æˆ¶åå¥½æœå‹™æ¸¬è©¦ |

### 5.12 é‹è¡Œæ¸¬è©¦å‘½ä»¤

```bash
# é‹è¡Œæ‰€æœ‰ MoE æ¸¬è©¦
MOE_USE_FALLBACK_STORAGE=true python3 -m pytest tests/llm/moe/ -v

# é‹è¡Œç‰¹å®šæ¸¬è©¦æª”æ¡ˆ
MOE_USE_FALLBACK_STORAGE=true python3 -m pytest tests/llm/moe/test_moe_manager.py -v

# é‹è¡Œç‰¹å®šæ¸¬è©¦
MOE_USE_FALLBACK_STORAGE=true python3 -m pytest tests/llm/moe/test_moe_manager.py::TestLLMMoEManagerSelectModel::test_select_chat_model -v
```

### 5.3 é¢¨éšªè©•ä¼°

| é¢¨éšª | å¯èƒ½æ€§ | å½±éŸ¿ | ç·©è§£æªæ–½ |
|------|--------|------|----------|
| é…ç½®æ ¼å¼éŒ¯èª¤ | ä½ | ä¸­ | ä½¿ç”¨ JSON Schema é©—è­‰ |
| æ¨¡å‹ä¸å¯ç”¨ | ä¸­ | é«˜ | å®Œå–„å‚™ç”¨æ¨¡å‹æ©Ÿåˆ¶ |
| API æ€§èƒ½å•é¡Œ | ä½ | ä½ | å¢åŠ ç·©å­˜ |
| ç’°å¢ƒç›¸å®¹æ€§ | ä½ | ä¸­ | è©³ç´°æ¸¬è©¦ |

---

## 6. é©—æ”¶æ¨™æº–

### 6.1 åŠŸèƒ½é©—æ”¶

| é …ç›® | é©—è­‰æ–¹æ³• | é€šéæ¨™æº– |
|------|----------|----------|
| 6 å ´æ™¯é…ç½®æ­£ç¢º | å–®å…ƒæ¸¬è©¦ | 100% é€šé |
| æ¨¡å‹å„ªå…ˆç´šæ­£ç¢º | é›†æˆæ¸¬è©¦ | æŒ‰é…ç½®é †åºé¸æ“‡ |
| å‚™ç”¨æ¨¡å‹åˆ‡æ› | æ•…éšœæ³¨å…¥æ¸¬è©¦ | 5 ç§’å…§åˆ‡æ› |
| ç”¨æˆ¶åå¥½ç”Ÿæ•ˆ | UI æ¸¬è©¦ | chat å ´æ™¯ç”Ÿæ•ˆ |
| API è¿”å›æ­£ç¢º | API æ¸¬è©¦ | 200 OK + æ­£ç¢ºæ•¸æ“š |

### 6.2 æ€§èƒ½é©—è­‰

| æŒ‡æ¨™ | ç›®æ¨™å€¼ | æ¸¬è©¦æ–¹æ³• |
|------|--------|----------|
| æ¨¡å‹é¸æ“‡å»¶é² | < 100ms | P95 ç›£æ§ |
| API éŸ¿æ‡‰æ™‚é–“ | < 200ms | API æ¸¬è©¦ |
| ä¸¦ç™¼è™•ç† | > 50 req/s | å£“åŠ›æ¸¬è©¦ |

---

## 7. è³‡æºéœ€æ±‚

### 7.1 äººåŠ›è³‡æº

| è§’è‰² | æŠ•å…¥å·¥æ™‚ |
|------|----------|
| Developer (Daniel) | 40 å°æ™‚ |

### 7.2 æ¸¬è©¦ç’°å¢ƒ

| ç’°å¢ƒ | éœ€æ±‚ |
|------|------|
| Ollama | gpt-oss:120b-cloud, glm-4.7:cloud, llama3.2:latest |
| å‘é‡åŒ– | nomic-embed-text:latest, bge-large-zh-v1.5 |
| ArangoDB | æ–°å¢ collection |

---

## 8. é™„éŒ„

### é™„éŒ„ A: config.json Patch

```json
{
  "op": "add",
  "path": "/services/moe",
  "value": {
    "model_priority": {
      "chat": {
        "frontend_editable": true,
        "user_default": "gpt-oss:120b-cloud",
        "priority": [
          {
            "model": "gpt-oss:120b-cloud",
            "context_size": 131072,
            "max_tokens": 4096,
            "temperature": 0.7,
            "timeout": 60,
            "retries": 3,
            "rpm": 30,
            "concurrency": 5
          }
        ]
      },
      "semantic_understanding": {
        "frontend_editable": false,
        "priority": [
          {
            "model": "gpt-oss:120b-cloud",
            "context_size": 131072,
            "max_tokens": 2048,
            "temperature": 0.3,
            "timeout": 30,
            "retries": 2,
            "rpm": 50,
            "concurrency": 10
          }
        ]
      },
      "task_analysis": { /* ... */ },
      "orchestrator": { /* ... */ },
      "embedding": { /* ... */ },
      "knowledge_graph_extraction": { /* ... */ }
    },
    "features": {
      "user_preference_enabled": true,
      "adaptive_learning_enabled": false,
      "cost_tracking_enabled": false,
      "auto_fallback_enabled": true
    }
  }
}
```

### é™„éŒ„ B: ç’°å¢ƒè®Šæ•¸åˆ—è¡¨

```bash
# æ¨¡å‹é…ç½®
export MOE_CHAT_MODEL="gpt-oss:120b-cloud"
export MOE_CHAT_TEMPERATURE="0.7"
export MOE_CHAT_TIMEOUT="60"
export MOE_SEMANTIC_MODEL="gpt-oss:120b-cloud"
export MOE_KG_MODEL="gpt-oss:120b-cloud"
export MOE_EMBEDDING_MODEL="nomic-embed-text:latest"

# åŠŸèƒ½é–‹é—œ
export MOE_ENABLE_USER_PREFERENCE="true"
export MOE_ENABLE_AUTO_FALLBACK="true"
```

### é™„éŒ„ C: æ¸¬è©¦è…³æœ¬

```python
# tests/test_moe_config.py
import pytest
from llm.moe.moe_manager import LLMMoEManager

def test_scene_priority():
    moe = LLMMoEManager()

    # Test chat scene
    result = moe.select_model("chat")
    assert result.model == "gpt-oss:120b-cloud"

    # Test knowledge_graph_extraction scene
    result = moe.select_model("knowledge_graph_extraction")
    assert result.model == "gpt-oss:120b-cloud"

def test_fallback():
    # Test fallback when primary model unavailable
    pass
```

---

**æ–‡ä»¶ç‰ˆæœ¬**: 1.2
**å‰µå»ºæ—¥æœŸ**: 2026-01-20
**æœ€å¾Œä¿®æ”¹æ—¥æœŸ**: 2026-01-20
**ç¶­è­·äºº**: Daniel Chung
**ä¿®æ”¹è¨˜éŒ„**:

- 2026-01-20 v1.1: Phase 1-4 å…¨éƒ¨å®Œæˆï¼Œæ›´æ–°é€²åº¦è¿½è¹¤è¡¨ã€ç”˜ç‰¹åœ–ã€æ–°å¢æª”æ¡ˆåˆ—è¡¨
- 2026-01-20 v1.2: Phase 5 ç”¨æˆ¶åå¥½èˆ‡æ•¸æ“šåº«å®Œæˆï¼Œæ–°å¢ 4 å€‹ API Endpointsï¼Œæ›´æ–°ç”˜ç‰¹åœ–
