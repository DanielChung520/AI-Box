# 模型場景調用參數配置規格書

**版本**: 1.0
**創建日期**: 2026-01-20
**創建人**: Daniel Chung
**最後修改日期**: 2026-01-20

---

## 1. 文檔概述

### 1.1 目的

本文檔定義 AI-Box 系統中 LLM 模型在不同工作場景下的調用參數配置規範，確保模型選擇、參數設置、資源管理的一致性和可維護性。

### 1.2 適用範圍

| 適用系統組件 | 狀態 |
|-------------|------|
| MoE (Mixture of Experts) 管理器 | ✅ 適用 |
| Task Analyzer (任務分析器) | ✅ 適用 |
| Orchestrator (協調層) | ✅ 適用 |
| Knowledge Graph Extraction (知識圖譜抽取) | ✅ 適用 |
| Embedding Service (向量化服務) | ✅ 適用 |
| GenAI Chat (生成式對話) | ✅ 適用 |

### 1.3 相關文檔

| 文檔 | 說明 |
|------|------|
| [AI-Box 語義與任務工程-設計說明書-v4.md](../語義與任務分析/AI-Box 語義與任務工程-設計說明書-v4.md) | v4 架構 5 層處理流程 |
| [MoE系統](../MoE系统.md) | MoE 系統架構說明 |
| [Orchestrator-協調層規格書.md](../Agent平台/Orchestrator-協調層規格書.md) | Orchestrator 詳細規格 |
| [LLM 模型效能測試報告](./LLM模型效能測試報告.md) | 模型性能測試數據 |

---

## 2. 術語定義

| 術語 | 定義 |
|------|------|
| **MoE** | Mixture of Experts，混合專家系統，用於智能選擇最合適的 LLM 模型 |
| **Context Size** | 上下文窗口大小，決定模型能處理的 Token 數量 |
| **Temperature** | 生成隨機性參數，影響輸出結果的多樣性 |
| **RPM** | Requests Per Minute，每分鐘請求數限制 |
| **Priority** | 模型優先級列表，按順序嘗試調用 |
| **Fallback** | 備用模型，當主模型不可用時自動切換 |

---

## 3. 配置架構

### 3.1 配置層級

```
┌─────────────────────────────────────────┐
│  Layer 1: 全局配置 (config.json)         │
│  - 模型優先級列表                        │
│  - 默認參數值                            │
│  - 環境變數覆蓋                          │
├─────────────────────────────────────────┤
│  Layer 2: 場景配置 (本文檔定義)           │
│  - chat (對話)                          │
│  - semantic_understanding (語義理解)     │
│  - task_analysis (任務分析)             │
│  - orchestrator (協調層)                │
│  - embedding (向量化)                   │
│  - knowledge_graph_extraction (知識圖譜) │
├─────────────────────────────────────────┤
│  Layer 3: 用戶偏好 (ArangoDB)            │
│  - user_model_preferences collection    │
│  - 只針對 chat 場景可編輯                │
└─────────────────────────────────────────┘
```

### 3.2 配置來源優先級

| 優先級 | 來源 | 說明 |
|--------|------|------|
| **1** | 用戶偏好 (只適用於 chat) | 前端可編輯，覆蓋其他配置 |
| **2** | 環境變數 | `MOE_*` 環境變數 |
| **3** | 場景配置 (config.json) | 本文件定義的場景配置 |
| **4** | 全局默認值 | 系統內建默認值 |

---

## 4. 場景配置詳細說明

### 4.1 場景分類

| 場景 ID | 場景名稱 | v4 層級 | 用戶可編輯 | 說明 |
|---------|----------|---------|------------|------|
| `chat` | Gen 聊天/補全 | L5 | ✅ 是 | 對話生成、代碼補全 |
| `semantic_understanding` | 語義理解 | L1 | ❌ 否 | 主題識別、實體提取 |
| `task_analysis` | 任務分析 | L2 | ❌ 否 | Intent DSL 生成 |
| `orchestrator` | Agent 協調 | L3 | ❌ 否 | 能力匹配、任務規劃 |
| `embedding` | 向量嵌入 | L3/L5 | ❌ 否 | 文本向量化 |
| `knowledge_graph_extraction` | 知識圖譜抽取 | L3/L5 | ❌ 否 | NER/RE/RT 三元組 |

### 4.2 chat (對話/補全)

#### 4.2.1 配置參數

| 參數 | 類型 | 預設值 | 範圍 | 說明 |
|------|------|--------|------|------|
| `model` | string | `gpt-oss:120b-cloud` | - | 模型名稱 |
| `context_size` | int | 131072 | 1~1M | 上下文窗口大小 (tokens) |
| `max_tokens` | int | 4096 | 1~32K | 最大輸出 tokens |
| `temperature` | float | 0.7 | 0.0~2.0 | 生成隨機性 |
| `timeout` | int | 60 | 1~300 | 請求超時 (秒) |
| `retries` | int | 3 | 0~5 | 重試次數 |
| `rpm` | int | 30 | 1~1000 | 每分鐘請求限制 |
| `concurrency` | int | 5 | 1~100 | 最大並發數 |
| `cost_per_1k_input` | float | 0.001 | - | 輸入成本 (可選) |
| `cost_per_1k_output` | float | 0.002 | - | 輸出成本 (可選) |

#### 4.2.2 優先級列表

```json
{
  "scene": "chat",
  "frontend_editable": true,
  "user_default": "gpt-oss:120b-cloud",
  "priority": [
    {
      "model": "gpt-oss:120b-cloud",
      "context_size": 131072,
      "max_tokens": 4096,
      "temperature": 0.7,
      "timeout": 60,
      "retries": 3,
      "rpm": 30,
      "concurrency": 5,
      "cost_per_1k_input": 0.001,
      "cost_per_1k_output": 0.002
    },
    {
      "model": "glm-4.7:cloud",
      "context_size": 128000,
      "max_tokens": 4096,
      "temperature": 0.7,
      "timeout": 90,
      "retries": 3,
      "rpm": 20,
      "concurrency": 3
    },
    {
      "model": "qwen3-next:latest",
      "context_size": 131072,
      "max_tokens": 4096,
      "temperature": 0.7,
      "timeout": 60,
      "retries": 3,
      "rpm": 30,
      "concurrency": 5
    }
  ]
}
```

#### 4.2.3 調用範例

```python
# 使用配置選擇模型
from llm.moe.moe_manager import LLMMoEManager

moe = LLMMoEManager()
model = moe.select_model(
    scene="chat",
    user_id="user_123",  # 用於獲取用戶偏好
    context={"task": "general_conversation"}
)
```

### 4.3 semantic_understanding (語義理解)

#### 4.3.1 配置參數

| 參數 | 類型 | 預設值 | 範圍 | 說明 |
|------|------|--------|------|------|
| `model` | string | `gpt-oss:120b-cloud` | - | 模型名稱 |
| `context_size` | int | 131072 | 1~1M | 上下文窗口大小 |
| `max_tokens` | int | 2048 | 1~8K | 最大輸出 tokens |
| `temperature` | float | 0.3 | 0.0~1.0 | 低溫度，結構化輸出 |
| `timeout` | int | 30 | 1~120 | 請求超時 |
| `retries` | int | 2 | 0~3 | 重試次數 |
| `rpm` | int | 50 | 1~1000 | 每分鐘請求限制 |
| `concurrency` | int | 10 | 1~100 | 最大並發數 |

#### 4.3.2 優先級列表

```json
{
  "scene": "semantic_understanding",
  "frontend_editable": false,
  "priority": [
    {
      "model": "gpt-oss:120b-cloud",
      "context_size": 131072,
      "max_tokens": 2048,
      "temperature": 0.3,
      "timeout": 30,
      "retries": 2,
      "rpm": 50,
      "concurrency": 10
    },
    {
      "model": "glm-4.7:cloud",
      "context_size": 128000,
      "max_tokens": 2048,
      "temperature": 0.3,
      "timeout": 45,
      "retries": 2,
      "rpm": 30,
      "concurrency": 5
    },
    {
      "model": "llama3.2:latest",
      "context_size": 131072,
      "max_tokens": 2048,
      "temperature": 0.3,
      "timeout": 45,
      "retries": 2,
      "rpm": 40,
      "concurrency": 8
    }
  ]
}
```

### 4.4 task_analysis (任務分析)

#### 4.4.1 配置參數

| 參數 | 類型 | 預設值 | 範圍 | 說明 |
|------|------|--------|------|------|
| `model` | string | `gpt-oss:120b-cloud` | - | 模型名稱 |
| `context_size` | int | 131072 | 1~1M | 上下文窗口大小 |
| `max_tokens` | int | 4096 | 1~8K | 最大輸出 tokens |
| `temperature` | float | 0.3 | 0.0~1.0 | 低溫度，意圖準確 |
| `timeout` | int | 45 | 1~120 | 請求超時 |
| `retries` | int | 2 | 0~3 | 重試次數 |
| `rpm` | int | 30 | 1~1000 | 每分鐘請求限制 |
| `concurrency` | int | 5 | 1~100 | 最大並發數 |

#### 4.4.2 優先級列表

```json
{
  "scene": "task_analysis",
  "frontend_editable": false,
  "priority": [
    {
      "model": "gpt-oss:120b-cloud",
      "context_size": 131072,
      "max_tokens": 4096,
      "temperature": 0.3,
      "timeout": 45,
      "retries": 2,
      "rpm": 30,
      "concurrency": 5
    },
    {
      "model": "glm-4.7:cloud",
      "context_size": 128000,
      "max_tokens": 4096,
      "temperature": 0.3,
      "timeout": 60,
      "retries": 2,
      "rpm": 20,
      "concurrency": 3
    },
    {
      "model": "qwen3-coder:30b",
      "context_size": 131072,
      "max_tokens": 4096,
      "temperature": 0.3,
      "timeout": 60,
      "retries": 2,
      "rpm": 25,
      "concurrency": 4
    }
  ]
}
```

### 4.5 orchestrator (Agent 協調)

#### 4.5.1 配置參數

| 參數 | 類型 | 預設值 | 範圍 | 說明 |
|------|------|--------|------|------|
| `model` | string | `gpt-oss:120b-cloud` | - | 模型名稱 |
| `context_size` | int | 131072 | 1~1M | 上下文窗口大小 |
| `max_tokens` | int | 2048 | 1~8K | 最大輸出 tokens |
| `temperature` | float | 0.2 | 0.0~1.0 | 最低溫度，決策可靠 |
| `timeout` | int | 30 | 1~120 | 請求超時 |
| `retries` | int | 2 | 0~3 | 重試次數 |
| `rpm` | int | 50 | 1~1000 | 每分鐘請求限制 |
| `concurrency` | int | 10 | 1~100 | 最大並發數 |

#### 4.5.2 優先級列表

```json
{
  "scene": "orchestrator",
  "frontend_editable": false,
  "priority": [
    {
      "model": "gpt-oss:120b-cloud",
      "context_size": 131072,
      "max_tokens": 2048,
      "temperature": 0.2,
      "timeout": 30,
      "retries": 2,
      "rpm": 50,
      "concurrency": 10
    },
    {
      "model": "llama3.2:latest",
      "context_size": 131072,
      "max_tokens": 2048,
      "temperature": 0.2,
      "timeout": 45,
      "retries": 2,
      "rpm": 40,
      "concurrency": 8
    },
    {
      "model": "mistral-nemo:12b",
      "context_size": 131072,
      "max_tokens": 2048,
      "temperature": 0.2,
      "timeout": 45,
      "retries": 2,
      "rpm": 30,
      "concurrency": 5
    }
  ]
}
```

### 4.6 embedding (向量化)

#### 4.6.1 配置參數

| 參數 | 類型 | 預設值 | 範圍 | 說明 |
|------|------|--------|------|------|
| `model` | string | `nomic-embed-text:latest` | - | 模型名稱 |
| `context_size` | int | 8192 | 1~32K | 上下文窗口大小 |
| `max_tokens` | int | 512 | 1~2K | 最大輸入 tokens |
| `timeout` | int | 120 | 1~300 | 請求超時 |
| `retries` | int | 3 | 0~5 | 重試次數 |
| `rpm` | int | 100 | 1~1000 | 每分鐘請求限制 |
| `concurrency` | int | 20 | 1~200 | 最大並發數 |
| `dimension` | int | 768 | 256~4096 | 向量維度 |

#### 4.6.2 優先級列表

```json
{
  "scene": "embedding",
  "frontend_editable": false,
  "priority": [
    {
      "model": "nomic-embed-text:latest",
      "context_size": 8192,
      "max_tokens": 512,
      "timeout": 120,
      "retries": 3,
      "rpm": 100,
      "concurrency": 20,
      "dimension": 768
    },
    {
      "model": "quentinz/bge-large-zh-v1.5:latest",
      "context_size": 8192,
      "max_tokens": 512,
      "timeout": 120,
      "retries": 3,
      "rpm": 100,
      "concurrency": 20,
      "dimension": 1024
    }
  ]
}
```

### 4.7 knowledge_graph_extraction (知識圖譜抽取)

#### 4.7.1 配置參數

| 參數 | 類型 | 預設值 | 範圍 | 說明 |
|------|------|--------|------|------|
| `model` | string | `gpt-oss:120b-cloud` | - | 模型名稱 |
| `context_size` | int | 131072 | 1~1M | 上下文窗口大小 |
| `max_tokens` | int | 8192 | 1~16K | 最大輸出 tokens |
| `temperature` | float | 0.2 | 0.0~1.0 | 低溫度，結構化三元組 |
| `timeout` | int | 180 | 1~600 | 請求超時 |
| `retries` | int | 2 | 0~3 | 重試次數 |
| `rpm` | int | 10 | 1~100 | 每分鐘請求限制 |
| `concurrency` | int | 2 | 1~10 | 最大並發數 |

#### 4.7.2 優先級列表

```json
{
  "scene": "knowledge_graph_extraction",
  "frontend_editable": false,
  "priority": [
    {
      "model": "gpt-oss:120b-cloud",
      "context_size": 131072,
      "max_tokens": 8192,
      "temperature": 0.2,
      "timeout": 180,
      "retries": 2,
      "rpm": 10,
      "concurrency": 2
    },
    {
      "model": "glm-4.7:cloud",
      "context_size": 128000_tokens": 8192,
      ",
      "maxtemperature": 0.2,
      "timeout": 180,
      "retries": 2,
      "rpm": 10,
      "concurrency": 2
    },
    {
      "model": "mistral-nemo:12b",
      "context_size": 131072,
      "max_tokens": 8192,
      "temperature": 0.2,
      "timeout": 200,
      "retries": 2,
      "rpm": 8,
      "concurrency": 1
    }
  ]
}
```

---

## 5. config.json 整合配置

### 5.1 完整配置結構

```json
{
  "services": {
    "moe": {
      "model_priority": {
        "chat": {
          "frontend_editable": true,
          "user_default": "gpt-oss:120b-cloud",
          "priority": []
        },
        "semantic_understanding": {
          "frontend_editable": false,
          "priority": []
        },
        "task_analysis": {
          "frontend_editable": false,
          "priority": []
        },
        "orchestrator": {
          "frontend_editable": false,
          "priority": []
        },
        "embedding": {
          "frontend_editable": false,
          "priority": []
        },
        "knowledge_graph_extraction": {
          "frontend_editable": false,
          "priority": []
        }
      },
      "features": {
        "user_preference_enabled": true,
        "adaptive_learning_enabled": false,
        "cost_tracking_enabled": false,
        "auto_fallback_enabled": true
      }
    }
  }
}
```

### 5.2 環境變數對應表

| 環境變數 | 場景 | 參數 | 預設值 |
|----------|------|------|--------|
| `MOE_CHAT_MODEL` | chat | model | `gpt-oss:120b-cloud` |
| `MOE_CHAT_TEMPERATURE` | chat | temperature | `0.7` |
| `MOE_CHAT_TIMEOUT` | chat | timeout | `60` |
| `MOE_SEMANTIC_MODEL` | semantic | model | `gpt-oss:120b-cloud` |
| `MOE_SEMANTIC_TEMPERATURE` | semantic | temperature | `0.3` |
| `MOE_TASK_MODEL` | task_analysis | model | `gpt-oss:120b-cloud` |
| `MOE_ORCHESTRATOR_MODEL` | orchestrator | model | `gpt-oss:120b-cloud` |
| `MOE_EMBEDDING_MODEL` | embedding | model | `nomic-embed-text:latest` |
| `MOE_EMBEDDING_TIMEOUT` | embedding | timeout | `120` |
| `MOE_KG_MODEL` | kg_extraction | model | `gpt-oss:120b-cloud` |
| `MOE_KG_TIMEOUT` | kg_extraction | timeout | `180` |
| `MOE_ENABLE_USER_PREFERENCE` | 全域 | user_preference_enabled | `true` |
| `MOE_ENABLE_AUTO_FALLBACK` | 全域 | auto_fallback_enabled | `true` |

---

## 6. API 接口設計

### 6.1 模型選擇 API

**端點**: `GET /api/v1/moe/select`

**請求參數**:

```json
{
  "scene": "chat",
  "user_id": "user_123",
  "context": {
    "task": "general_conversation"
  }
}
```

**響應**:

```json
{
  "success": true,
  "data": {
    "model": "gpt-oss:120b-cloud",
    "context_size": 131072,
    "max_tokens": 4096,
    "temperature": 0.7,
    "timeout": 60
  }
}
```

### 6.2 用戶偏好 API

**端點**: `PUT /api/v1/moe/user-preference`

**請求**:

```json
{
  "user_id": "user_123",
  "chat_model": "glm-4.7:cloud"
}
```

### 6.3 配置查詢 API

**端點**: `GET /api/v1/moe/config/{scene}`

**響應**:

```json
{
  "success": true,
  "data": {
    "scene": "chat",
    "frontend_editable": true,
    "priority": [...]
  }
}
```

---

## 7. 數據庫設計

### 7.1 用戶偏好 Collection

**Collection**: `user_model_preferences`

```json
{
  "_key": "user_xxx",
  "user_id": "user_xxx",
  "chat_model": "gpt-oss:120b-cloud",
  "created_at": "2026-01-20T08:00:00Z",
  "updated_at": "2026-01-20T08:00:00Z"
}
```

### 7.2 用量統計 Collection

**Collection**: `model_usage_stats` (可選功能)

```json
{
  "_key": "stat_xxx",
  "user_id": "user_xxx",
  "scene": "chat",
  "model": "gpt-oss:120b-cloud",
  "request_count": 100,
  "total_tokens": 50000,
  "total_cost": 0.05,
  "period": "2026-01",
  "created_at": "2026-01-20T08:00:00Z"
}
```

---

## 8. 監控與指標

### 8.1 監控指標

| 指標 | 說明 | 告警閾值 |
|------|------|----------|
| `moe.model_selection.total` | 模型選擇總次數 | - |
| `moe.model_selection.success` | 成功選擇次數 | < 99% |
| `moe.fallback.count` | 備用模型切換次數 | > 10% |
| `moe.latency.p95` | P95 延遲 | > 5s |
| `moe.error.rate` | 錯誤率 | > 1% |
| `moe.cost.total` | 總成本 | > 每日預算 |

### 8.2 日誌記錄

```python
# 模型選擇日誌
logger.info(
    "model_selected",
    scene="chat",
    model="gpt-oss:120b-cloud",
    user_id="user_123",
    latency_ms=123,
    fallback=False
)

# 備用模型切換日誌
logger.warning(
    "model_fallback",
    scene="knowledge_graph_extraction",
    primary_model="gpt-oss:120b-cloud",
    fallback_model="glm-4.7:cloud",
    reason="timeout"
)
```

---

## 9. 測試要求

### 9.1 單元測試

- [ ] 模型選擇邏輯測試
- [ ] 優先級遍歷測試
- [ ] 備用模型切換測試
- [ ] 參數覆蓋測試

### 9.2 集成測試

- [ ] 各場景 API 調用測試
- [ ] 用戶偏好 CRUD 測試
- [ ] 環境變數覆蓋測試
- [ ] 監控指標收集測試

### 9.3 性能測試

- [ ] 模型選擇延遲 < 100ms
- [ ] 並發請求壓力測試
- [ ] 備用模型切換時間 < 500ms

---

## 10. 版本歷史

| 版本 | 日期 | 變更說明 |
|------|------|----------|
| 1.0 | 2026-01-20 | 初始版本 |

---

**文檔版本**: 1.0
**最後更新**: 2026-01-20
**維護人**: Daniel Chung
