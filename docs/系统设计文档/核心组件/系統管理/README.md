# 系統管理

本目录包含 AI-Box 系统管理相关的文档和规范。

## 快速导航

### API 接入點造冊
- [API 接入點造冊](API接入點造冊.md) - 所有 API 路由／接入點彙整：代碼位置、說明、是否可由 curl 等標記

### 数据备份与恢复
- [数据备份规范](数据备份规范.md) - 完整的备份策略、频率、保留规则和操作规范
- 备份脚本: `../../scripts/backup_all.py`
- 恢复脚本: `../../scripts/restore_all.py`

### AI 系统治理
- [AI-Box 系统 AI 治理规划](AI-Box-系统AI治理规划.md) - 5 层治理框架（防護层、監控层、Agent 治理、合規层、恢復层）

### Production 环境规则管理
- [Production 环境规则管理](Production环境规则管理.md) - 完整的上架流程、测试规范、CodeReviewAgent 自动检查

### 配置管理
- [ConfigMetadata-配置元数据机制规格书](ConfigMetadata-配置元数据机制规格书.md) - 配置元数据机制
- [MCP第三方服务配置管理](MCP第三方服务配置管理.md) - MCP 服务配置

### 系統監控
- [系統監控架構技術規格書](系統監控架構技術規格書.md) - 監控系統架構

### 系統管理功能
- [系統管理功能開發計劃](系統管理功能開發計劃.md) - 功能開發計劃
- [SystemAdmin-与-SystemAgent-架構設計規格書](SystemAdmin-与-SystemAgent-架構設計規格書.md) - 系統管理架構

### 相關腳本

| 腳本 | 用途 |
|------|------|
| `scripts/backup_all.py` | 備份所有服務（ArangoDB、Qdrant、SeaWeedFS）|
| `scripts/restore_all.py` | 恢復所有服務 |
| `scripts/setup_backup_cron.sh` | 設置定時備份任務 |
| `scripts/migration/restore_configs.py` | 恢復 GenAI 配置 |
| `scripts/migration/migrate_ontologies.py` | 導入 Ontology 數據 |

## System Agents

| Agent | 職責範圍 | 腳本位置 |
|-------|---------|---------|
| CodeReviewAgent | 代碼審查、規範檢查、安全檢查 | `agents/governance/code_review_agent.py` |
| RiskAssessmentAgent | 風險評估、緩解措施建議 | `agents/governance/risk_assessment_agent.py` |
| BackupProtocolAgent | 自動備份協議 | `agents/governance/backup_protocol_agent.py` |
| PermissionControlAgent | 操作權限控制 | `agents/governance/permission_control_agent.py` |

## 重要提醒

⚠️ **任何數據相關操作前必須**：
1. 確認最近的備份成功
2. 手動執行一次完整備份
3. 在 AGENTS.md 或 issue 中記錄操作原因和計劃
4. 獲得團隊批准（對於生產環境）

❌ **嚴禁**在未完成上述步驟的情況下執行數據銷毀操作。

## 生產環境上架必讀

在將代碼部署到 Production 環境前，務必閱讀以下文檔：

1. **[Production 環境規則管理](Production環境規則管理.md)**
   - 變更管理規範
   - 測試規範（單元測試、集成測試、E2E）
   - 沙盒測試要求
   - CodeReviewAgent 自動檢查
   - CI/CD 流程
   - 灰度發布策略
   - 回滾機制

2. **[AI-Box 系統 AI 治理規劃](AI-Box-系統AI治理規劃.md)**
   - 防護層：API 危險操作保護
   - 監控層：實時監控告警
   - Agent 治理：AI Agent 風險評估
   - 合規層：ISO/IEC 42001 合規
   - 恢復層：數據恢復流程

3. **[數據備份規範](數據備份規範.md)**
   - 備份頻率和保留策略
   - 恢復流程
   - 緊急處理流程

## 上架流程簡要

```
1. 變更申請（填寫變更請求模板）
   ↓
2. CodeReviewAgent 自動檢查
   ├─ 基礎規範檢查
   ├─ 安全檢查
   ├─ 數據庫操作檢查
   └─ 治理規範檢查
   ↓
3. 代碼審查（同行審查）
   ↓
4. 測試（單元、集成、沙盒）
   ↓
5. 審批（根據變更類型）
   ↓
6. CI/CD 自動部署到沙盒
   ↓
7. 沙盒驗收測試
   ↓
8. 灰度發布到 Production
   ↓
9. 監控和驗證
   ↓
10. 全量發布（或回滾）
```

## 治理框架層次

```
┌─────────────────────────────────────────────────┐
│            AI-Box 系統 AI 治理層次            │
├─────────────────────────────────────────────────┤
│  Layer 5: 恢復層面 (Recovery Layer)             │
│  - 數據恢復腳本                                        │
│  - 定期恢復測試                                      │
│  - 災難回應流程                                        │
├─────────────────────────────────────────────────┤
│  Layer 4: 合規層面 (Compliance Layer)             │
│  - ISO/IEC 42001 合規檢查                             │
│  - 數據分類與標記                                      │
│  - 合規報告生成                                        │
├─────────────────────────────────────────────────┤
│  Layer 3: Agent 治理 (Agent Governance)            │
│  - 治理知識庫注入                                      │
│  - AI Agent 風險評估                                    │
│  - 自動備份協議                                        │
│  - 操作權限控制                                        │
├─────────────────────────────────────────────────┤
│  Layer 2: 監控層面 (Monitoring Layer)              │
│  - 實時數據量監控                                      │
│  - 異常檢測告警                                        │
│  - 備份狀態監控                                        │
│  - 風險閾值告警                                        │
└─────────────────────────────────────────────────┘
│  Layer 1: 防護層面 (Protection Layer)             │
│  - API 層危險操作攔截                                    │
│  - 數據修改前置備份                                    │
│  - 多級審批機制                                        │
│  - 操作審計日誌                                        │
└─────────────────────────────────────────────────┘
```

## 生產環境上架規則要點

### 變更分類

| 類型 | 風險 | 需要測試 | 需要審批 |
|------|------|---------|---------|
| Type 1: 緊急修復 | Critical | 基本測試 | 1 人審批 |
| Type 2: 小型變更 | Low | 單元測試 | 1 人審批 |
| Type 3: 中型變更 | Medium | 單元+集成測試 | 2 人審批 |
| Type 4: 大型變更 | High | 全部測試 | 2 人審批 |
| Type 5: 關鍵變更 | Critical | 全部測試+沙盒 | 3 人+系統管理員 |

### 測試覆蓋率要求

| 文件類型 | 最低覆蓋率 | 推薦覆蓋率 |
|---------|-----------|-----------|
| 核心業務邏輯 | 80% | 90% |
| 數據服務層 | 70% | 85% |
| API 路由層 | 60% | 75% |
| 工具函數 | 90% | 95% |
| 配置文件 | 50% | 70% |

### CodeReviewAgent 檢查項目

1. **基礎規範檢查**
   - 文件頭檢查
   - 編碼規範檢查
   - 導入順序檢查
   - 命名規範檢查
   - 註釋規範檢查

2. **安全檢查**
   - 硬編碼密碼/API Key 檢查
   - SQL 注入風險檢查
   - XSS 防護檢查
   - 敏感操作檢查

3. **數據庫操作檢查**
   - 危險數據庫操作檢查（DROP、TRUNCATE 等）
   - 備份保護檢查
   - 治理規範檢查

4. **治理規範檢查**
   - 治理知識庫規則檢查
   - 風險評估檢查
   - 合規性檢查

### 驗收標準

- [ ] 單元測試通過率 > 95%
- [ ] 集成測試全部通過
- [ ] 沙盒測試通過
- [ ] 性能測試符合要求
- [ ] Code Review 通過
- [ ] CodeReviewAgent 檢查通過
- [ ] 審批人員批准

### 部署策略

| 策略 | 適用場景 | 描述 |
|------|---------|------|
| Canary | 常規變更 | 逐步放量：5% → 10% → 25% → 50% → 100% |
| Blue-Green | 關鍵變更 | 零環境並行，一鍵切換 |
| 滾動發布 | 長期特性 | 按時間窗口滾動部署 |
| 熱部署 | 緊急修復 | 直接部署到生產 |

### 回滾機制

**回滾觸發條件**：

| 條件 | 閾值 | 自動回滾 |
|------|------|---------|
| 錯誤率 | > 5% | ✅ |
| P95 響應時間 | > 3s | ✅ |
| CPU 使用率 | > 80% | ⚠️ 警告 |
| 內存使用率 | > 90% | ✅ |
| 崩潰次數 | > 3/小時 | ✅ |
