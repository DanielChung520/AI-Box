# ç³»ç»Ÿç›‘æ§æ¶æ„æŠ€æœ¯è§„æ ¼ä¹¦

**æ–‡æ¡£ç¼–å·**: SPEC-MONITOR-001
**ç‰ˆæœ¬**: 1.0
**åˆ›å»ºæ—¥æœŸ**: 2026-01-18 12:40 UTC+8
**åˆ›å»ºäºº**: Daniel Chung
**å®¡æ‰¹çŠ¶æ€**: å¾…å®¡æ‰¹

---

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

### ç›®çš„

æœ¬è§„æ ¼ä¹¦å®šä¹‰ AI-Box ç³»ç»Ÿç›‘æ§æ¶æ„çš„æŠ€æœ¯è§„èŒƒï¼ŒåŒ…æ‹¬æ¶æ„è®¾è®¡ã€æŠ€æœ¯é€‰å‹ã€æ¥å£å®šä¹‰ã€é…ç½®è§„èŒƒç­‰ï¼Œç¡®ä¿å¼€å‘å›¢é˜Ÿå’Œ AI åŠ©æ‰‹æŒ‰ç…§ç»Ÿä¸€æ ‡å‡†å®æ–½ã€‚

### é€‚ç”¨èŒƒå›´

- å¼€å‘äººå‘˜ï¼šä½œä¸ºå¼€å‘ä¾æ®
- AI åŠ©æ‰‹ï¼šä½œä¸ºä»£ç ç”Ÿæˆè§„èŒƒ
- æµ‹è¯•äººå‘˜ï¼šä½œä¸ºæµ‹è¯•æ ‡å‡†
- è¿ç»´äººå‘˜ï¼šä½œä¸ºéƒ¨ç½²å’Œè¿ç»´æŒ‡å—

### å…³è”æ–‡æ¡£

- ã€Šç³»ç»Ÿç›‘æ§è¿ç§»å®æ–½è®¡åˆ’ä¹¦ã€‹ï¼ˆPLAN-MONITOR-001ï¼‰
- ã€Šç³»çµ±ç®¡ç†åŠŸèƒ½é–‹ç™¼è¨ˆåŠƒã€‹

---

## ğŸ¯ é¡¹ç›®ç›®æ ‡

### ä¸šåŠ¡ç›®æ ‡

1. å»ºç«‹äº§å“çº§çš„ç³»ç»Ÿç›‘æ§è§£å†³æ–¹æ¡ˆ
2. æ”¯æŒå®æ—¶ç›‘æ§ã€å‘Šè­¦å’Œå¯è§†åŒ–
3. æ»¡è¶³å•†ä¸šäº§å“çš„å¯é æ€§è¦æ±‚
4. ä¾¿äºåç»­æ‰©å±•å’Œç»´æŠ¤

### æŠ€æœ¯ç›®æ ‡

1. é‡‡ç”¨è¡Œä¸šæ ‡å‡†æŠ€æœ¯æ ˆï¼ˆPrometheus + Grafanaï¼‰
2. é›¶åœæœºè¿ç§»
3. æ”¯æŒå¤šæœåŠ¡ç›‘æ§
4. å®Œæ•´çš„å‘Šè­¦ä½“ç³»

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. æ€»ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      AI-Box ç›‘æ§æ¶æ„                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Grafana         â”‚  â† å¯è§†åŒ–å±‚ï¼ˆç”¨æˆ·ç•Œé¢ï¼‰
â”‚  Port: 3001      â”‚
â”‚  - ä»ªè¡¨æ¿        â”‚
â”‚  - å‘Šè­¦å±•ç¤º      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ HTTP API
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Prometheus      â”‚  â† æ•°æ®å±‚ï¼ˆæ—¶åºæ•°æ®åº“ï¼‰
â”‚  Port: 9090      â”‚
â”‚  - Metrics å­˜å‚¨  â”‚
â”‚  - å‘Šè­¦è§„åˆ™      â”‚
â”‚  - æ•°æ®èšåˆ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Pull Metrics (HTTP)
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              åº”ç”¨æœåŠ¡å±‚                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ FastAPI      â”‚ ArangoDB     â”‚ Redis        â”‚
â”‚ Port: 8000   â”‚ Port: 8529   â”‚ Port: 6379   â”‚
â”‚ /metrics     â”‚              â”‚              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ChromaDB     â”‚ SeaweedFS    â”‚ MCP Server   â”‚
â”‚ Port: 8001   â”‚ Multi-Port   â”‚ Port: 8002   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“ (é€šè¿‡ Exporters)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Exporters       â”‚  â† é€‚é…å±‚ï¼ˆåè®®è½¬æ¢ï¼‰
â”‚  - Redis         â”‚
â”‚  - ArangoDB      â”‚
â”‚  - Node          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. ç»„ä»¶èŒè´£

#### 2.1 Grafanaï¼ˆå¯è§†åŒ–å±‚ï¼‰

- **èŒè´£**: æ•°æ®å¯è§†åŒ–ã€ä»ªè¡¨æ¿ç®¡ç†ã€å‘Šè­¦å±•ç¤º
- **æŠ€æœ¯**: Grafana å®˜æ–¹é•œåƒï¼ˆlatestï¼‰
- **ç«¯å£**: 3001
- **å­˜å‚¨**: Docker Volume (grafana_data)
- **é…ç½®**:
  - æ•°æ®æºï¼šPrometheus
  - ä»ªè¡¨æ¿ï¼šé€šè¿‡ Provisioning è‡ªåŠ¨é…ç½®
  - ç”¨æˆ·ç®¡ç†ï¼šç¦ç”¨è‡ªæ³¨å†Œ

#### 2.2 Prometheusï¼ˆæ•°æ®å±‚ï¼‰

- **èŒè´£**: Metrics æ”¶é›†ã€å­˜å‚¨ã€æŸ¥è¯¢ã€å‘Šè­¦è§„åˆ™è¯„ä¼°
- **æŠ€æœ¯**: Prometheus å®˜æ–¹é•œåƒï¼ˆlatestï¼‰
- **ç«¯å£**: 9090
- **å­˜å‚¨**: Docker Volume (prometheus_data)
- **é…ç½®**:
  - æŠ“å–é—´éš”ï¼š15 ç§’
  - æ•°æ®ä¿ç•™ï¼š15 å¤©
  - å‘Šè­¦è¯„ä¼°ï¼š15 ç§’

#### 2.3 Alertmanagerï¼ˆå‘Šè­¦ç®¡ç†ï¼‰

- **èŒè´£**: å‘Šè­¦è·¯ç”±ã€åˆ†ç»„ã€é™é»˜ã€é€šçŸ¥
- **æŠ€æœ¯**: Alertmanager å®˜æ–¹é•œåƒï¼ˆlatestï¼‰
- **ç«¯å£**: 9093
- **å­˜å‚¨**: Docker Volume (alertmanager_data)
- **é€šçŸ¥æ¸ é“**: Webhookã€é‚®ä»¶ã€ä¼ä¸šå¾®ä¿¡

#### 2.4 Node Exporterï¼ˆç³»ç»ŸæŒ‡æ ‡ï¼‰

- **èŒè´£**: æ”¶é›†ä¸»æœºç³»ç»ŸæŒ‡æ ‡ï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œï¼‰
- **æŠ€æœ¯**: Node Exporter å®˜æ–¹é•œåƒï¼ˆlatestï¼‰
- **ç«¯å£**: 9100

#### 2.5 Redis Exporterï¼ˆRedis ç›‘æ§ï¼‰

- **èŒè´£**: å¯¼å‡º Redis metrics
- **æŠ€æœ¯**: oliver006/redis_exporter
- **ç«¯å£**: 9121

#### 2.6 ArangoDB Exporterï¼ˆæ•°æ®åº“ç›‘æ§ï¼‰

- **èŒè´£**: å¯¼å‡º ArangoDB metrics
- **æŠ€æœ¯**: arangodb/arangodb-exporter
- **ç«¯å£**: 9101

---

## ğŸ“Š æŒ‡æ ‡è§„èŒƒ

### 1. FastAPI åº”ç”¨æŒ‡æ ‡

#### 1.1 HTTP è¯·æ±‚æŒ‡æ ‡

**æŒ‡æ ‡åç§°**: `http_requests_total`
**ç±»å‹**: Counter
**è¯´æ˜**: HTTP è¯·æ±‚æ€»æ•°
**æ ‡ç­¾**:

- `method`: è¯·æ±‚æ–¹æ³•ï¼ˆGET, POST, PUT, DELETEï¼‰
- `endpoint`: è¯·æ±‚è·¯å¾„ï¼ˆå¦‚ `/api/v1/chat`ï¼‰
- `status_code`: HTTP çŠ¶æ€ç ï¼ˆ200, 404, 500 ç­‰ï¼‰

**ç¤ºä¾‹**:

```promql
http_requests_total{method="GET",endpoint="/api/v1/health",status_code="200"}
```

**æŒ‡æ ‡åç§°**: `http_request_duration_seconds`
**ç±»å‹**: Histogram
**è¯´æ˜**: HTTP è¯·æ±‚å»¶è¿Ÿï¼ˆç§’ï¼‰
**æ ‡ç­¾**:

- `method`: è¯·æ±‚æ–¹æ³•
- `endpoint`: è¯·æ±‚è·¯å¾„

**Buckets**: [0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10]

**ç¤ºä¾‹æŸ¥è¯¢**:

```promql
# 95th ç™¾åˆ†ä½å»¶è¿Ÿ
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

# å¹³å‡å»¶è¿Ÿ
rate(http_request_duration_seconds_sum[5m]) / rate(http_request_duration_seconds_count[5m])
```

#### 1.2 è¿æ¥æŒ‡æ ‡

**æŒ‡æ ‡åç§°**: `active_connections`
**ç±»å‹**: Gauge
**è¯´æ˜**: å½“å‰æ´»è·ƒè¿æ¥æ•°

#### 1.3 ç³»ç»Ÿèµ„æºæŒ‡æ ‡

**æŒ‡æ ‡åç§°**: `cpu_usage_percent`
**ç±»å‹**: Gauge
**è¯´æ˜**: CPU ä½¿ç”¨ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰

**æŒ‡æ ‡åç§°**: `memory_usage_percent`
**ç±»å‹**: Gauge
**è¯´æ˜**: å†…å­˜ä½¿ç”¨ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰

**æŒ‡æ ‡åç§°**: `disk_usage_percent`
**ç±»å‹**: Gauge
**è¯´æ˜**: ç£ç›˜ä½¿ç”¨ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰
**æ ‡ç­¾**:

- `path`: æŒ‚è½½ç‚¹è·¯å¾„ï¼ˆå¦‚ `/`ï¼‰

#### 1.4 ä¸šåŠ¡æŒ‡æ ‡

**æŒ‡æ ‡åç§°**: `db_connections_total`
**ç±»å‹**: Gauge
**è¯´æ˜**: æ•°æ®åº“è¿æ¥æ± å¤§å°
**æ ‡ç­¾**:

- `database`: æ•°æ®åº“åç§°ï¼ˆarangodb, redisï¼‰

**æŒ‡æ ‡åç§°**: `task_queue_length`
**ç±»å‹**: Gauge
**è¯´æ˜**: ä»»åŠ¡é˜Ÿåˆ—é•¿åº¦
**æ ‡ç­¾**:

- `queue_name`: é˜Ÿåˆ—åç§°

### 2. æœåŠ¡å¥åº·æŒ‡æ ‡

**æŒ‡æ ‡åç§°**: `up`
**ç±»å‹**: Gauge
**è¯´æ˜**: æœåŠ¡æ˜¯å¦åœ¨çº¿ï¼ˆ1=åœ¨çº¿, 0=ç¦»çº¿ï¼‰
**æ ‡ç­¾**:

- `job`: æœåŠ¡åç§°ï¼ˆfastapi, arangodb, redis ç­‰ï¼‰
- `instance`: æœåŠ¡å®ä¾‹åœ°å€

---

## ğŸ”§ é…ç½®è§„èŒƒ

### 1. Prometheus é…ç½®

#### æ–‡ä»¶ä½ç½®

`monitoring/prometheus/prometheus.yml`

#### é…ç½®æ¨¡æ¿

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'aibox-production'
    environment: 'production'

rule_files:
  - 'alerts.yml'

scrape_configs:
  # FastAPI ä¸»æœåŠ¡
  - job_name: 'fastapi'
    static_configs:
      - targets: ['host.docker.internal:8000']
        labels:
          service: 'fastapi'
          component: 'api'
    metrics_path: '/metrics'
    scrape_interval: 10s

  # å…¶ä»–æœåŠ¡é…ç½®...
```

#### é…ç½®è¯´æ˜

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `scrape_interval` | 15s | å…¨å±€æŠ“å–é—´éš” |
| `evaluation_interval` | 15s | å‘Šè­¦è§„åˆ™è¯„ä¼°é—´éš” |
| `external_labels` | cluster, environment | å¤–éƒ¨æ ‡ç­¾ï¼ˆç”¨äºè”é‚¦å’Œè¿œç¨‹å­˜å‚¨ï¼‰ |
| `metrics_path` | /metrics | Metrics ç«¯ç‚¹è·¯å¾„ |

### 2. å‘Šè­¦è§„åˆ™é…ç½®

#### æ–‡ä»¶ä½ç½®

`monitoring/prometheus/alerts.yml`

#### è§„åˆ™è§„èŒƒ

æ¯ä¸ªå‘Šè­¦è§„åˆ™å¿…é¡»åŒ…å«ï¼š

1. **alert**: å‘Šè­¦åç§°ï¼ˆPascalCaseï¼‰
2. **expr**: PromQL è¡¨è¾¾å¼
3. **for**: æŒç»­æ—¶é—´ï¼ˆè§¦å‘æ¡ä»¶ï¼‰
4. **labels**:
   - `severity`: critical | warning | info
5. **annotations**:
   - `summary`: ç®€çŸ­æè¿°
   - `description`: è¯¦ç»†æè¿°ï¼ˆæ”¯æŒå˜é‡ï¼‰

#### è§„åˆ™ç¤ºä¾‹

```yaml
groups:
  - name: service_alerts
    interval: 30s
    rules:
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Service {{ $labels.job }} is down"
          description: "{{ $labels.job }} at {{ $labels.instance }} has been down for more than 1 minute."
```

### 3. Grafana é…ç½®

#### æ•°æ®æºé…ç½®

**æ–‡ä»¶ä½ç½®**: `monitoring/grafana/provisioning/datasources/prometheus.yml`

```yaml
apiVersion: 1

datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
    editable: true
    jsonData:
      timeInterval: "15s"
```

#### ä»ªè¡¨æ¿é…ç½®

**æ–‡ä»¶ä½ç½®**: `monitoring/grafana/provisioning/dashboards/dashboard.yml`

```yaml
apiVersion: 1

providers:
  - name: 'AI Box Dashboards'
    orgId: 1
    folder: ''
    type: file
    disableDeletion: false
    updateIntervalSeconds: 10
    allowUiUpdates: true
    options:
      path: /etc/grafana/provisioning/dashboards
```

---

## ğŸ’» ä»£ç å®ç°è§„èŒƒ

### 1. FastAPI Metrics å®ç°

#### æ–‡ä»¶ä½ç½®

`api/main.py`

#### å¿…éœ€å¯¼å…¥

```python
from prometheus_client import Counter, Histogram, Gauge, generate_latest, CONTENT_TYPE_LATEST
from fastapi import FastAPI, Request
from fastapi.responses import Response
import psutil
import asyncio
import time
```

#### Metrics å®šä¹‰è§„èŒƒ

```python
# å‘½åè§„èŒƒï¼šå°å†™å­—æ¯ + ä¸‹åˆ’çº¿
# ç±»å‹ï¼šCounterï¼ˆåªå¢ï¼‰, Gaugeï¼ˆå¯å¢å¯å‡ï¼‰, Histogramï¼ˆåˆ†å¸ƒï¼‰

# HTTP è¯·æ±‚è®¡æ•°å™¨
http_requests_total = Counter(
    'http_requests_total',
    'Total HTTP requests',
    ['method', 'endpoint', 'status_code']
)

# HTTP è¯·æ±‚å»¶è¿Ÿ
http_request_duration_seconds = Histogram(
    'http_request_duration_seconds',
    'HTTP request latency',
    ['method', 'endpoint'],
    buckets=[0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10]
)

# ç³»ç»Ÿèµ„æºï¼ˆä½¿ç”¨ Gaugeï¼‰
cpu_usage_percent = Gauge('cpu_usage_percent', 'CPU usage percentage')
memory_usage_percent = Gauge('memory_usage_percent', 'Memory usage percentage')
```

#### Middleware å®ç°è§„èŒƒ

```python
@app.middleware("http")
async def prometheus_metrics_middleware(request: Request, call_next):
    """
    æ”¶é›† HTTP è¯·æ±‚æŒ‡æ ‡

    å¿…é¡»è®°å½•ï¼š
    1. è¯·æ±‚æ€»æ•°ï¼ˆæŒ‰ method, endpoint, status_codeï¼‰
    2. è¯·æ±‚å»¶è¿Ÿï¼ˆæŒ‰ method, endpointï¼‰
    3. æ´»è·ƒè¿æ¥æ•°
    """
    active_connections.inc()
    start_time = time.time()

    try:
        response = await call_next(request)
        duration = time.time() - start_time

        # è®°å½•æŒ‡æ ‡
        http_requests_total.labels(
            method=request.method,
            endpoint=request.url.path,
            status_code=response.status_code
        ).inc()

        http_request_duration_seconds.labels(
            method=request.method,
            endpoint=request.url.path
        ).observe(duration)

        return response
    finally:
        active_connections.dec()
```

#### Metrics ç«¯ç‚¹è§„èŒƒ

```python
@app.get("/metrics")
async def metrics():
    """
    Prometheus metrics ç«¯ç‚¹

    è¦æ±‚ï¼š
    1. è¿”å› Prometheus æ–‡æœ¬æ ¼å¼
    2. Content-Type å¿…é¡»æ˜¯ text/plain
    3. ä¸éœ€è¦è®¤è¯ï¼ˆPrometheus æ‹‰å–ï¼‰
    """
    return Response(
        content=generate_latest(),
        media_type=CONTENT_TYPE_LATEST
    )
```

#### åå°ä»»åŠ¡è§„èŒƒ

```python
async def update_system_metrics():
    """
    å®šæœŸæ›´æ–°ç³»ç»Ÿèµ„æºæŒ‡æ ‡

    è¦æ±‚ï¼š
    1. æ¯ 15 ç§’æ›´æ–°ä¸€æ¬¡
    2. å¼‚å¸¸ä¸èƒ½å¯¼è‡´ä»»åŠ¡ç»ˆæ­¢
    3. ä½¿ç”¨ psutil è·å–ç³»ç»ŸæŒ‡æ ‡
    """
    while True:
        try:
            # CPU ä½¿ç”¨ç‡
            cpu_usage_percent.set(psutil.cpu_percent(interval=1))

            # å†…å­˜ä½¿ç”¨ç‡
            memory = psutil.virtual_memory()
            memory_usage_percent.set(memory.percent)

            # ç£ç›˜ä½¿ç”¨ç‡
            disk = psutil.disk_usage('/')
            disk_usage_percent.labels(path='/').set(disk.percent)

        except Exception as e:
            logger.error(f"Failed to update system metrics: {e}")

        await asyncio.sleep(15)

@app.on_event("startup")
async def startup_event():
    """åº”ç”¨å¯åŠ¨æ—¶å¯åŠ¨åå°ä»»åŠ¡"""
    asyncio.create_task(update_system_metrics())
```

### 2. å‘Šè­¦ Webhook å¤„ç†

#### API è§„èŒƒ

**ç«¯ç‚¹**: `POST /api/v1/admin/alerts/webhook`
**è®¤è¯**: ç³»ç»Ÿç®¡ç†å‘˜æƒé™
**è¯·æ±‚æ ¼å¼**: JSON

#### è¯·æ±‚ä½“ç»“æ„

```json
{
  "receiver": "default",
  "status": "firing",
  "alerts": [
    {
      "status": "firing",
      "labels": {
        "alertname": "ServiceDown",
        "service": "fastapi",
        "severity": "critical"
      },
      "annotations": {
        "summary": "Service fastapi is down",
        "description": "fastapi has been down for more than 1 minute."
      },
      "startsAt": "2026-01-18T12:00:00Z",
      "endsAt": "0001-01-01T00:00:00Z",
      "generatorURL": "http://prometheus:9090/graph?..."
    }
  ]
}
```

#### å®ç°è§„èŒƒ

```python
from pydantic import BaseModel
from typing import List, Dict, Optional

class AlertLabel(BaseModel):
    alertname: str
    service: Optional[str]
    severity: str

class AlertAnnotation(BaseModel):
    summary: str
    description: str

class Alert(BaseModel):
    status: str
    labels: AlertLabel
    annotations: AlertAnnotation
    startsAt: str
    endsAt: Optional[str]
    generatorURL: Optional[str]

class AlertWebhook(BaseModel):
    receiver: str
    status: str
    alerts: List[Alert]

@router.post("/alerts/webhook")
async def handle_alert_webhook(
    webhook: AlertWebhook,
    current_user: User = Depends(require_system_admin),
):
    """
    æ¥æ”¶ Alertmanager çš„å‘Šè­¦ webhook

    å¤„ç†æµç¨‹ï¼š
    1. éªŒè¯è¯·æ±‚æ ¼å¼
    2. å­˜å‚¨å‘Šè­¦åˆ°æ•°æ®åº“
    3. å‘é€å®æ—¶é€šçŸ¥ï¼ˆWebSocketï¼‰
    4. è®°å½•æ—¥å¿—
    """
    try:
        alert_service = get_service_alert_service()

        for alert in webhook.alerts:
            await alert_service.create_alert(
                service_name=alert.labels.service or 'unknown',
                alert_name=alert.labels.alertname,
                severity=alert.labels.severity,
                summary=alert.annotations.summary,
                description=alert.annotations.description,
                status=alert.status,
                starts_at=alert.startsAt,
                ends_at=alert.endsAt,
                generator_url=alert.generatorURL,
            )

        return APIResponse.success(
            message=f"Received {len(webhook.alerts)} alerts"
        )

    except Exception as e:
        logger.error(f"Failed to handle alert webhook: {e}", exc_info=True)
        raise HTTPException(
            status_code=500,
            detail=f"Failed to handle alerts: {str(e)}"
        )
```

---

## ğŸ”Œ å‰ç«¯é›†æˆè§„èŒƒ

### 1. ç³»ç»Ÿç›‘æ§é¡µé¢

#### è·¯ç”±é…ç½®

```typescript
// ai-bot/src/App.tsx

import SystemMonitoring from '@/pages/SystemMonitoring';

<Route
  path="/system-monitoring"
  element={
    <AdminRoute>
      <SystemMonitoring />
    </AdminRoute>
  }
/>
```

#### é¡µé¢ç»„ä»¶è§„èŒƒ

```typescript
// ai-bot/src/pages/SystemMonitoring.tsx

interface Dashboard {
  id: string;
  title: string;
  url: string;
  description: string;
}

const SystemMonitoring: React.FC = () => {
  const grafanaBaseUrl = import.meta.env.VITE_GRAFANA_URL || 'http://localhost:3001';

  const dashboards: Dashboard[] = [
    {
      id: 'system-overview',
      title: 'ç³»ç»Ÿæ¦‚è§ˆ',
      url: `${grafanaBaseUrl}/d/system-overview?orgId=1&kiosk=tv`,
      description: 'æ•´ä½“ç³»ç»Ÿå¥åº·çŠ¶å†µå’Œæ€§èƒ½æŒ‡æ ‡'
    },
    // ... æ›´å¤šä»ªè¡¨æ¿
  ];

  // å®ç°ç»†èŠ‚...
}
```

### 2. ç¯å¢ƒå˜é‡é…ç½®

#### å¿…éœ€çš„ç¯å¢ƒå˜é‡

```bash
# .env.production

# Grafana é…ç½®
VITE_GRAFANA_URL=http://localhost:3001
GRAFANA_ADMIN_PASSWORD=your_secure_password

# Prometheus é…ç½®
PROMETHEUS_URL=http://localhost:9090

# åŠŸèƒ½å¼€å…³
VITE_USE_NEW_MONITORING=true
```

---

## ğŸ³ éƒ¨ç½²è§„èŒƒ

### 1. Docker Compose é…ç½®

#### æ–‡ä»¶ä½ç½®

`docker-compose.monitoring.yml`

#### ç‰ˆæœ¬è¦æ±‚

- Docker: 20.10+
- Docker Compose: 2.0+

#### èµ„æºé™åˆ¶

```yaml
services:
  prometheus:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  grafana:
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
```

#### ç½‘ç»œé…ç½®

```yaml
networks:
  monitoring:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
```

#### æ•°æ®æŒä¹…åŒ–

```yaml
volumes:
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
  alertmanager_data:
    driver: local
```

### 2. ç«¯å£åˆ†é…

| æœåŠ¡ | ç«¯å£ | ç”¨é€” |
|------|------|------|
| Prometheus | 9090 | Web UI & API |
| Grafana | 3001 | Web UI |
| Alertmanager | 9093 | Web UI & API |
| Node Exporter | 9100 | Metrics |
| Redis Exporter | 9121 | Metrics |
| ArangoDB Exporter | 9101 | Metrics |

---

## ğŸ§ª æµ‹è¯•è§„èŒƒ

### 1. å•å…ƒæµ‹è¯•

#### Metrics æ”¶é›†æµ‹è¯•

```python
# tests/test_metrics.py

import pytest
from fastapi.testclient import TestClient
from api.main import app

client = TestClient(app)

def test_metrics_endpoint():
    """æµ‹è¯• metrics ç«¯ç‚¹"""
    response = client.get("/metrics")
    assert response.status_code == 200
    assert "text/plain" in response.headers["content-type"]

    # éªŒè¯å¿…éœ€çš„æŒ‡æ ‡å­˜åœ¨
    content = response.text
    assert "http_requests_total" in content
    assert "http_request_duration_seconds" in content
    assert "cpu_usage_percent" in content

def test_http_metrics_collection():
    """æµ‹è¯• HTTP æŒ‡æ ‡æ”¶é›†"""
    # å‘é€æµ‹è¯•è¯·æ±‚
    response = client.get("/health")
    assert response.status_code == 200

    # æ£€æŸ¥ metrics
    metrics_response = client.get("/metrics")
    content = metrics_response.text

    # éªŒè¯è¯·æ±‚è¢«è®°å½•
    assert 'http_requests_total{endpoint="/health",method="GET",status_code="200"}' in content
```

### 2. é›†æˆæµ‹è¯•

#### Prometheus æ•°æ®æ”¶é›†æµ‹è¯•

```python
# tests/integration/test_prometheus.py

import httpx
import pytest

@pytest.mark.asyncio
async def test_prometheus_scrapes_fastapi():
    """æµ‹è¯• Prometheus èƒ½æŠ“å– FastAPI metrics"""
    async with httpx.AsyncClient() as client:
        # 1. æ£€æŸ¥ FastAPI metrics ç«¯ç‚¹
        response = await client.get("http://localhost:8000/metrics")
        assert response.status_code == 200

        # 2. ç­‰å¾… Prometheus æŠ“å–
        await asyncio.sleep(20)

        # 3. æŸ¥è¯¢ Prometheus
        response = await client.get(
            "http://localhost:9090/api/v1/query",
            params={"query": "up{job='fastapi'}"}
        )
        data = response.json()

        # 4. éªŒè¯æ•°æ®
        assert data["status"] == "success"
        assert len(data["data"]["result"]) > 0
        assert data["data"]["result"][0]["value"][1] == "1"
```

### 3. ç«¯åˆ°ç«¯æµ‹è¯•

#### å‘Šè­¦æµç¨‹æµ‹è¯•

```python
# tests/e2e/test_alerting.py

@pytest.mark.asyncio
async def test_alert_flow():
    """æµ‹è¯•å®Œæ•´çš„å‘Šè­¦æµç¨‹"""
    # 1. æ¨¡æ‹ŸæœåŠ¡å®•æœº
    # 2. ç­‰å¾…å‘Šè­¦è§¦å‘
    # 3. éªŒè¯ webhook æ”¶åˆ°å‘Šè­¦
    # 4. éªŒè¯å‘Šè­¦å­˜å‚¨åˆ°æ•°æ®åº“
    # 5. éªŒè¯å‰ç«¯æ˜¾ç¤ºå‘Šè­¦
    pass
```

---

## ğŸ“ˆ æ€§èƒ½è¦æ±‚

### 1. æŒ‡æ ‡æ”¶é›†æ€§èƒ½

| æŒ‡æ ‡ | è¦æ±‚ | è¯´æ˜ |
|------|------|------|
| Metrics ç«¯ç‚¹å“åº”æ—¶é—´ | < 100ms | P95 |
| Middleware å¼€é”€ | < 1ms | å¹³å‡æ¯è¯·æ±‚ |
| åå°ä»»åŠ¡ CPU å ç”¨ | < 5% | å¹³å‡å€¼ |
| å†…å­˜å ç”¨ | < 100MB | ä¸»è¿›ç¨‹é¢å¤–å¼€é”€ |

### 2. Prometheus æ€§èƒ½

| æŒ‡æ ‡ | è¦æ±‚ | è¯´æ˜ |
|------|------|------|
| æŸ¥è¯¢å“åº”æ—¶é—´ | < 1s | ç®€å•æŸ¥è¯¢ |
| æ•°æ®ä¿ç•™æœŸ | 15 å¤© | å¯é…ç½® |
| ç£ç›˜å ç”¨ | < 10GB | 15 å¤©æ•°æ® |
| æŠ“å–æˆåŠŸç‡ | > 99% | æ‰€æœ‰ targets |

### 3. Grafana æ€§èƒ½

| æŒ‡æ ‡ | è¦æ±‚ | è¯´æ˜ |
|------|------|------|
| ä»ªè¡¨æ¿åŠ è½½æ—¶é—´ | < 2s | åˆæ¬¡åŠ è½½ |
| ä»ªè¡¨æ¿åˆ·æ–°æ—¶é—´ | < 500ms | æ•°æ®åˆ·æ–° |
| å¹¶å‘ç”¨æˆ· | > 50 | åŒæ—¶è®¿é—® |

---

## ğŸ”’ å®‰å…¨è§„èŒƒ

### 1. è®¤è¯å’Œæˆæƒ

#### Grafana è®¤è¯

- **ç”¨æˆ·ç®¡ç†**: ç¦ç”¨è‡ªæ³¨å†Œ
- **é»˜è®¤è´¦æˆ·**: admin/admin123ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹ï¼‰
- **è§’è‰²**: Admin, Editor, Viewer

#### API è®¤è¯

- **Metrics ç«¯ç‚¹**: æ— éœ€è®¤è¯ï¼ˆPrometheus æ‹‰å–ï¼‰
- **Webhook ç«¯ç‚¹**: ç³»ç»Ÿç®¡ç†å‘˜æƒé™
- **Grafana API**: Bearer Token

### 2. ç½‘ç»œå®‰å…¨

#### é˜²ç«å¢™è§„åˆ™

```bash
# åªå…è®¸å†…ç½‘è®¿é—® Prometheus
iptables -A INPUT -p tcp --dport 9090 -s 10.0.0.0/8 -j ACCEPT
iptables -A INPUT -p tcp --dport 9090 -j DROP

# åªå…è®¸å†…ç½‘è®¿é—® Grafanaï¼ˆåå‘ä»£ç†é™¤å¤–ï¼‰
iptables -A INPUT -p tcp --dport 3001 -s 10.0.0.0/8 -j ACCEPT
iptables -A INPUT -p tcp --dport 3001 -j DROP
```

### 3. æ•°æ®å®‰å…¨

#### æ•æ„Ÿæ•°æ®å¤„ç†

- **å¯†ç **: ç¯å¢ƒå˜é‡å­˜å‚¨ï¼Œä¸å†™å…¥é…ç½®æ–‡ä»¶
- **API Token**: åŠ å¯†å­˜å‚¨
- **å‘Šè­¦é€šçŸ¥**: è¿‡æ»¤æ•æ„Ÿå­—æ®µ

---

## ğŸ“š ç»´æŠ¤è§„èŒƒ

### 1. å¤‡ä»½ç­–ç•¥

#### Prometheus æ•°æ®å¤‡ä»½

```bash
# æ¯æ—¥å¤‡ä»½ï¼ˆä¿ç•™ 7 å¤©ï¼‰
docker exec aibox-prometheus tar czf /backup/prometheus-$(date +%Y%m%d).tar.gz /prometheus

# æ¢å¤
docker exec aibox-prometheus tar xzf /backup/prometheus-20260118.tar.gz -C /
```

#### Grafana é…ç½®å¤‡ä»½

```bash
# å¤‡ä»½ä»ªè¡¨æ¿
curl -H "Authorization: Bearer $GRAFANA_TOKEN" \
  http://localhost:3001/api/dashboards/uid/system-overview > dashboard-backup.json

# æ¢å¤
curl -X POST -H "Authorization: Bearer $GRAFANA_TOKEN" \
  -H "Content-Type: application/json" \
  -d @dashboard-backup.json \
  http://localhost:3001/api/dashboards/db
```

### 2. æ—¥å¿—ç®¡ç†

#### æ—¥å¿—è·¯å¾„

- Prometheus: `/var/log/prometheus/`
- Grafana: `/var/log/grafana/`
- Alertmanager: `/var/log/alertmanager/`

#### æ—¥å¿—è½®è½¬

```bash
# /etc/logrotate.d/prometheus
/var/log/prometheus/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
}
```

### 3. ç›‘æ§ç›‘æ§ç³»ç»Ÿ

#### è‡ªç›‘æ§æŒ‡æ ‡

- Prometheus è‡ªèº«å¥åº·çŠ¶æ€
- Grafana å¯ç”¨æ€§
- å‘Šè­¦å»¶è¿Ÿ
- æ•°æ®æ”¶é›†æˆåŠŸç‡

---

## ğŸ”„ ç‰ˆæœ¬ç®¡ç†

### 1. ç»„ä»¶ç‰ˆæœ¬

| ç»„ä»¶ | ç‰ˆæœ¬ | æ›´æ–°ç­–ç•¥ |
|------|------|----------|
| Prometheus | latest | æ‰‹åŠ¨æ›´æ–°ï¼Œæµ‹è¯•åéƒ¨ç½² |
| Grafana | latest | æ‰‹åŠ¨æ›´æ–°ï¼Œæµ‹è¯•åéƒ¨ç½² |
| Alertmanager | latest | æ‰‹åŠ¨æ›´æ–°ï¼Œæµ‹è¯•åéƒ¨ç½² |
| Python Client | 0.19.0 | é”å®šç‰ˆæœ¬ |

### 2. é…ç½®ç‰ˆæœ¬æ§åˆ¶

æ‰€æœ‰é…ç½®æ–‡ä»¶å¿…é¡»çº³å…¥ Git ç‰ˆæœ¬æ§åˆ¶ï¼š

- `monitoring/prometheus/prometheus.yml`
- `monitoring/prometheus/alerts.yml`
- `monitoring/grafana/provisioning/`
- `docker-compose.monitoring.yml`

---

## ğŸ“ æ”¯æŒå’Œè”ç³»

### æŠ€æœ¯æ”¯æŒ

- **è´Ÿè´£äºº**: Daniel Chung
- **é‚®ç®±**: (å¾…è¡¥å……)
- **Slack**: #system-monitoring

### æ–‡æ¡£ç»´æŠ¤

- **æ›´æ–°é¢‘ç‡**: æ¯æ¬¡æ¶æ„å˜æ›´åæ›´æ–°
- **å®¡æ‰¹**: æŠ€æœ¯è´Ÿè´£äººå®¡æ‰¹
- **ç‰ˆæœ¬å·**: éµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼ˆMajor.Minor.Patchï¼‰

---

## ğŸ“‹ é™„å½•

### A. PromQL å¸¸ç”¨æŸ¥è¯¢

```promql
# æœåŠ¡å¯ç”¨æ€§
up{job="fastapi"}

# è¯·æ±‚é€Ÿç‡ï¼ˆQPSï¼‰
rate(http_requests_total[5m])

# é”™è¯¯ç‡
rate(http_requests_total{status_code=~"5.."}[5m]) / rate(http_requests_total[5m])

# 95th ç™¾åˆ†ä½å»¶è¿Ÿ
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

# CPU ä½¿ç”¨ç‡ï¼ˆç³»ç»Ÿçº§ï¼‰
100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

# å†…å­˜ä½¿ç”¨ç‡ï¼ˆç³»ç»Ÿçº§ï¼‰
(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100
```

### B. å¸¸è§é—®é¢˜æ’æŸ¥

#### Prometheus æ— æ³•æŠ“å– metrics

1. æ£€æŸ¥ target æ˜¯å¦é…ç½®æ­£ç¡®
2. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§ï¼š`docker exec aibox-prometheus curl http://host.docker.internal:8000/metrics`
3. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
4. æŸ¥çœ‹ Prometheus æ—¥å¿—

#### Grafana æ˜¾ç¤º "No data"

1. æ£€æŸ¥æ•°æ®æºé…ç½®
2. æ£€æŸ¥æ—¶é—´èŒƒå›´
3. æ£€æŸ¥æŸ¥è¯¢è¯­å¥
4. åœ¨ Prometheus UI ä¸­éªŒè¯æ•°æ®

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**ç”Ÿæ•ˆæ—¥æœŸ**: 2026-01-18
**ä¸‹æ¬¡å®¡æŸ¥**: 2026-02-18
