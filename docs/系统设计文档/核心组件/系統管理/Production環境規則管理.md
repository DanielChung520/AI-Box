# AI-Box Production ç’°å¢ƒè¦å‰‡ç®¡ç†

**å‰µå»ºæ—¥æœŸ**: 2026-01-27
**å‰µå»ºäºº**: Daniel Chung
**æœ€å¾Œä¿®æ”¹æ—¥æœŸ**: 2026-01-27
**æ–‡æª”ç‰ˆæœ¬**: 1.0
**é©ç”¨ç¯„åœ**: Production ç’°å¢ƒä¸Šæ¶å’Œç³»çµ±ä¿®æ”¹

---

## æ–‡æª”æ¦‚è¿°

æœ¬æ–‡æª”å®šç¾© AI-Box ç³»çµ±åœ¨ Production ç’°å¢ƒä¸Šæ¶çš„è¦å‰‡ã€æµç¨‹å’Œæª¢æŸ¥æ©Ÿåˆ¶ï¼Œç¢ºä¿ç³»çµ±ç©©å®šã€å®‰å…¨ã€åˆè¦åœ°é€²è¡Œè®Šæ›´ã€‚

**æ ¸å¿ƒç›®æ¨™**:
1. é˜²æ­¢ç”Ÿç”¢ç’°å¢ƒæ•¸æ“šä¸Ÿå¤±
2. ç¢ºä¿æ‰€æœ‰è®Šæ›´ç¶“éå……åˆ†æ¸¬è©¦
3. å¯¦æ–½è‡ªå‹•åŒ–ä»£ç¢¼æª¢æŸ¥
4. å»ºç«‹æ¨™æº–åŒ–çš„ä¸Šæ¶æµç¨‹
5. æä¾›å¯è¿½æº¯çš„è®Šæ›´è¨˜éŒ„

---

## è¦å‰‡æ¡†æ¶æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            AI-Box Production è¦å‰‡ç®¡ç†å±¤æ¬¡            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 5: ä¸Šæ¶èˆ‡éƒ¨ç½² (Deployment Layer)             â”‚
â”‚  - CI/CD æµç¨‹                                        â”‚
â”‚  - ç°åº¦ç™¼å¸ƒ                                          â”‚
â”‚  - å›æ»¾æ©Ÿåˆ¶                                          â”‚
â”‚  - ä¸Šæ¶å¯©æ‰¹                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 4: æ²™ç›’èˆ‡é©—æ”¶ (Sandbox & Acceptance)          â”‚
â”‚  - æ²™ç›’ç’°å¢ƒæ¸¬è©¦                                      â”‚
â”‚  - é©—æ”¶æ¸¬è©¦æ¨™æº–                                      â”‚
â”‚  - æ€§èƒ½æ¸¬è©¦                                          â”‚
â”‚  - å®‰å…¨æ¸¬è©¦                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 3: ä»£ç¢¼æª¢æŸ¥ (Code Review & Quality)             â”‚
â”‚  - System Agent è‡ªå‹•æª¢æŸ¥                               â”‚
â”‚  - ä»£ç¢¼å¯©æŸ¥è¦ç¯„                                      â”‚
â”‚  - è³ªé‡é–€æª»                                          â”‚
â”‚  - å®‰å…¨æƒæ                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 2: æ¸¬è©¦è¦ç¯„ (Testing Standards)                â”‚
â”‚  - å–®å…ƒæ¸¬è©¦                                          â”‚
â”‚  - é›†æˆæ¸¬è©¦                                          â”‚
â”‚  - ç«¯åˆ°ç«¯æ¸¬è©¦                                        â”‚
â”‚  - æ¸¬è©¦è¦†è“‹ç‡                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Layer 1: è®Šæ›´ç®¡ç† (Change Management)                 â”‚
â”‚  - è®Šæ›´è«‹æ±‚æµç¨‹                                      â”‚
â”‚  - é¢¨éšªè©•ä¼°                                          â”‚
â”‚  - å½±éŸ¿åˆ†æ                                          â”‚
â”‚  - å›æ»¾è¨ˆåŠƒ                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Layer 1: è®Šæ›´ç®¡ç†

### 1.1 è®Šæ›´åˆ†é¡

**è®Šæ›´é¡å‹å®šç¾©**:

| é¡å‹ | å®šç¾© | é¢¨éšªç­‰ç´š | éœ€è¦æ¸¬è©¦ | éœ€è¦å¯©æ‰¹ |
|------|------|---------|---------|---------|
| **Type 1: ç·Šæ€¥ä¿®å¾©** | ä¿®å¾©ç”Ÿç”¢ç’°å¢ƒåš´é‡ Bug | Critical | åŸºæœ¬æ¸¬è©¦ | 1 äººå¯©æ‰¹ |
| **Type 2: å°å‹è®Šæ›´** | Bug ä¿®å¾©ã€å°åŠŸèƒ½æ”¹é€² | Low | å–®å…ƒæ¸¬è©¦ | 1 äººå¯©æ‰¹ |
| **Type 3: ä¸­å‹è®Šæ›´** | æ–°åŠŸèƒ½ã€æ¶æ§‹å¾®èª¿ | Medium | å–®å…ƒ+é›†æˆæ¸¬è©¦ | 2 äººå¯©æ‰¹ |
| **Type 4: å¤§å‹è®Šæ›´** | é‡å¤§åŠŸèƒ½ã€æ¶æ§‹èª¿æ•´ | High | å…¨éƒ¨æ¸¬è©¦ | 2 äººå¯©æ‰¹ |
| **Type 5: é—œéµè®Šæ›´** | æ•¸æ“šçµæ§‹è®Šæ›´ã€æ ¸å¿ƒæœå‹™æ”¹å‹• | Critical | å…¨éƒ¨æ¸¬è©¦+æ²™ç›’ | 3 äºº+ç³»çµ±ç®¡ç†å“¡ |

### 1.2 è®Šæ›´è«‹æ±‚æµç¨‹

```mermaid
graph TD
    A[è®Šæ›´ç”³è«‹] --> B{è®Šæ›´é¡å‹}
    B -->|Type 1| C[ç·Šæ€¥ä¿®å¾©æµç¨‹]
    B -->|Type 2-3| D[å¸¸è¦è®Šæ›´æµç¨‹]
    B -->|Type 4-5| E[é‡å¤§è®Šæ›´æµç¨‹]
    
    C --> C1[åŸºæœ¬æ¸¬è©¦]
    C1 --> C2[1äººå¯©æ‰¹]
    C2 --> C3[å¿«é€Ÿä¸Šæ¶]
    
    D --> D1[å®Œæ•´æ¸¬è©¦]
    D1 --> D2[Code Review]
    D2 --> D3[2äººå¯©æ‰¹]
    D3 --> D4[æ²™ç›’é©—è­‰]
    D4 --> D5[ä¸Šæ¶]
    
    E --> E1[å®Œæ•´æ¸¬è©¦]
    E1 --> E2[Code Review]
    E2 --> E3[ç³»çµ±æ¶æ§‹è©•å¯©]
    E3 --> E4[3äºº+ç³»çµ±ç®¡ç†å“¡å¯©æ‰¹]
    E4 --> E5[æ²™ç›’é©—è­‰]
    E5 --> E6[ç°åº¦ç™¼å¸ƒ]
    E6 --> E7[æ­£å¼ä¸Šæ¶]
```

### 1.3 è®Šæ›´è«‹æ±‚æ¨¡æ¿

```yaml
# ä½ç½®: .github/PULL_REQUEST_TEMPLATE.md æˆ– .cursor/CHANGE_REQUEST_TEMPLATE.md

change_request:
  # è®Šæ›´é¡å‹ (Type 1-5)
  type: 3
  
  # è®Šæ›´æ¨™é¡Œ
  title: "æ·»åŠ æ–‡ä»¶åˆ†å¡Šå„ªåŒ–åŠŸèƒ½"
  
  # è®Šæ›´æè¿°
  description: |
    é€™æ¬¡è®Šæ›´æ·»åŠ äº†æ–‡ä»¶åˆ†å¡Šçš„æ™ºèƒ½å„ªåŒ–åŠŸèƒ½ï¼Œæ ¹æ“šæ–‡ä»¶é¡å‹å’Œå…§å®¹è‡ªå‹•èª¿æ•´åˆ†å¡Šå¤§å°ã€‚
  
  # å½±éŸ¿ç¯„åœ
  scope:
    affected_services:
      - "api/file_upload"
      - "services/chunking_service"
      - "database/chromadb"
    affected_databases:
      - "ChromaDB"
    affected_dependencies:
      - "ç„¡æ–°å¢ä¾è³´"
  
  # é¢¨éšªè©•ä¼°
  risk_assessment:
    risk_level: "Medium"
    potential_impact:
      - "åˆ†å¡Šè³ªé‡å¯èƒ½ä¸‹é™"
      - "è™•ç†æ™‚é–“å¯èƒ½å¢åŠ "
    mitigation:
      - "å……åˆ†æ¸¬è©¦ä¸åŒæ–‡ä»¶é¡å‹"
      - "ç›£æ§è™•ç†æ™‚é–“"
      - "ä¿ç•™èˆŠç®—æ³•ä½œç‚ºå›æ»¾é¸é …"
  
  # æ¸¬è©¦è¨ˆåŠƒ
  testing_plan:
    unit_tests: "å·²æ·»åŠ  15 å€‹å–®å…ƒæ¸¬è©¦"
    integration_tests: "å·²æ·»åŠ  5 å€‹é›†æˆæ¸¬è©¦"
    sandbox_tests: "å¾…æ²™ç›’ç’°å¢ƒé©—è­‰"
    performance_tests: "å·²æ¸¬è©¦ 100MB æ–‡ä»¶ï¼Œæ™‚é–“åœ¨é–¾å€¼å…§"
  
  # å›æ»¾è¨ˆåŠƒ
  rollback_plan:
    can_rollback: true
    rollback_steps:
      - "git revert <commit>"
      - "é‡æ–°éƒ¨ç½²"
    data_backup_required: false
  
  # é©—æ”¶æ¨™æº–
  acceptance_criteria:
    - "å–®å…ƒæ¸¬è©¦é€šéç‡ > 95%"
    - "é›†æˆæ¸¬è©¦å…¨éƒ¨é€šé"
    - "æ²™ç›’æ¸¬è©¦é€šé"
    - "æ€§èƒ½æ¸¬è©¦ç¬¦åˆè¦æ±‚"
    - "Code Review é€šé"
    - "å¯©æ‰¹äººå“¡æ‰¹å‡†"
  
  # ä¸Šæ¶çª—å£
  deployment_window:
    preferred_time: "é€±å…­å‡Œæ™¨ 2:00-4:00"
    estimated_duration: "30 åˆ†é˜"
  
  # ç›¸é—œ Issue
  related_issues:
    - "https://github.com/xxx/issue/123"
```

### 1.4 é¢¨éšªè©•ä¼°æ¨™æº–

**é¢¨éšªè©•åˆ†çŸ©é™£**:

| å½±éŸ¿ç¯„åœ | ä½ | ä¸­ | é«˜ |
|---------|---|---|---|
| **é »ç‡**: ç¶“å¸¸ç™¼ç”Ÿ | é«˜é¢¨éšª | é«˜é¢¨éšª | Critical |
| **é »ç‡**: å¶çˆ¾ç™¼ç”Ÿ | ä¸­é¢¨éšª | é«˜é¢¨éšª | Critical |
| **é »ç‡**: æ¥µå°‘ç™¼ç”Ÿ | ä½é¢¨éšª | ä¸­é¢¨éšª | é«˜é¢¨éšª |

**å½±éŸ¿ç¯„åœå®šç¾©**:
- **ä½å½±éŸ¿**: å–®å€‹åŠŸèƒ½å—å½±éŸ¿ï¼Œå¯å¿«é€Ÿä¿®å¾©
- **ä¸­å½±éŸ¿**: å¤šå€‹åŠŸèƒ½å—å½±éŸ¿ï¼Œéœ€è¦å›æ»¾
- **é«˜å½±éŸ¿**: æ ¸å¿ƒåŠŸèƒ½å—å½±éŸ¿ï¼Œæ•¸æ“šå¯èƒ½æå£

---

## Layer 2: æ¸¬è©¦è¦ç¯„

### 2.1 å–®å…ƒæ¸¬è©¦

**è¦†è“‹ç‡è¦æ±‚**:

| æ–‡ä»¶é¡å‹ | æœ€ä½è¦†è“‹ç‡ | æ¨è–¦è¦†è“‹ç‡ |
|---------|-----------|-----------|
| æ ¸å¿ƒæ¥­å‹™é‚è¼¯ | 80% | 90% |
| æ•¸æ“šæœå‹™å±¤ | 70% | 85% |
| API è·¯ç”±å±¤ | 60% | 75% |
| å·¥å…·å‡½æ•¸ | 90% | 95% |
| é…ç½®æ–‡ä»¶ | 50% | 70% |

**å–®å…ƒæ¸¬è©¦è¦ç¯„**:

```python
# å–®å…ƒæ¸¬è©¦ç¤ºä¾‹
# ä½ç½®: tests/services/test_file_chunking.py

import pytest
from services.chunking_service import ChunkingService

class TestChunkingService:
    """æ–‡ä»¶åˆ†å¡Šæœå‹™å–®å…ƒæ¸¬è©¦"""
    
    @pytest.fixture
    def service(self):
        """å‰µå»ºæœå‹™å¯¦ä¾‹"""
        return ChunkingService()
    
    def test_chunk_text_basic(self, service):
        """æ¸¬è©¦åŸºæœ¬æ–‡æœ¬åˆ†å¡Š"""
        text = "é€™æ˜¯ä¸€æ®µæ¸¬è©¦æ–‡æœ¬ã€‚" * 10
        
        chunks = service.chunk_text(text, chunk_size=100)
        
        # æ–·è¨€
        assert len(chunks) > 0
        assert all(len(chunk) <= 100 for chunk in chunks)
        assert ''.join(chunks) == text
    
    def test_chunk_text_with_overlap(self, service):
        """æ¸¬è©¦å¸¶é‡ç–Šçš„åˆ†å¡Š"""
        text = "é€™æ˜¯ä¸€æ®µæ¸¬è©¦æ–‡æœ¬ã€‚" * 10
        
        chunks = service.chunk_text(
            text,
            chunk_size=100,
            overlap=20,
        )
        
        # é©—è­‰é‡ç–Š
        for i in range(len(chunks) - 1):
            overlap = chunks[i][-20:] == chunks[i+1][:20]
            assert overlap, f"Chunk {i} å’Œ {i+1} ä¹‹é–“ç„¡é‡ç–Š"
    
    def test_chunk_with_markdown(self, service):
        """æ¸¬è©¦ Markdown æ ¼å¼åˆ†å¡Š"""
        markdown = """
# æ¨™é¡Œ 1
é€™æ˜¯ç¬¬ä¸€æ®µã€‚

## æ¨™é¡Œ 2
é€™æ˜¯ç¬¬äºŒæ®µã€‚
        """
        
        chunks = service.chunk_markdown(markdown, chunk_size=200)
        
        # é©—è­‰ä¸åˆ‡æ–·æ¨™é¡Œ
        assert not any(chunk.strip().startswith('#') and not chunk.startswith('#')
                    for chunk in chunks[1:])
    
    @pytest.mark.parametrize("file_type,expected_behavior", [
        ("pdf", "ç‰¹æ®Šåˆ†å¡Šç®—æ³•"),
        ("docx", "ç‰¹æ®Šåˆ†å¡Šç®—æ³•"),
        ("txt", "æ¨™æº–åˆ†å¡Šç®—æ³•"),
    ])
    def test_chunk_different_file_types(
        self,
        service,
        file_type,
        expected_behavior,
    ):
        """åƒæ•¸åŒ–æ¸¬è©¦ï¼šä¸åŒæ–‡ä»¶é¡å‹çš„åˆ†å¡Š"""
        # æ¸¬è©¦é‚è¼¯
        pass
```

### 2.2 é›†æˆæ¸¬è©¦

**é›†æˆæ¸¬è©¦è¦æ±‚**:

| æ¸¬è©¦é¡å‹ | è¦†è“‹è¦æ±‚ |
|---------|---------|
| æ•¸æ“šåº«æ“ä½œ | 100% è¦†è“‹æ‰€æœ‰ CRUD æ“ä½œ |
| API ç«¯é» | 100% è¦†è“‹æ‰€æœ‰å…¬é–‹ API |
| å¤–éƒ¨æœå‹™é›†æˆ | 100% è¦†è“‹æ‰€æœ‰å¤–éƒ¨èª¿ç”¨ |
| æ¶ˆæ¯éšŠåˆ— | 100% è¦†è“‹æ‰€æœ‰ç”Ÿç”¢/æ¶ˆè²»é‚è¼¯ |

**é›†æˆæ¸¬è©¦ç¤ºä¾‹**:

```python
# ä½ç½®: tests/integration/test_file_upload_pipeline.py

import pytest
from fastapi.testclient import TestClient
from api.main import app
from services.chunking_service import ChunkingService
from database.chromadb import ChromaDBClient

@pytest.mark.integration
class TestFileUploadPipeline:
    """æ–‡ä»¶ä¸Šå‚³æµç¨‹é›†æˆæ¸¬è©¦"""
    
    @pytest.fixture
    def client(self):
        """å‰µå»ºæ¸¬è©¦å®¢æˆ¶ç«¯"""
        return TestClient(app)
    
    @pytest.fixture
    async def cleanup_db(self):
        """æ¸…ç†æ¸¬è©¦æ•¸æ“š"""
        yield
        # æ¸¬è©¦å¾Œæ¸…ç†
        client = ChromaDBClient()
        await client.delete_collection("test_files")
    
    async def test_file_upload_to_vectorization(
        self,
        client,
        cleanup_db,
    ):
        """æ¸¬è©¦æ–‡ä»¶ä¸Šå‚³åˆ°å‘é‡åŒ–çš„å®Œæ•´æµç¨‹"""
        
        # 1. ä¸Šå‚³æ–‡ä»¶
        files = {"file": ("test.txt", "æ¸¬è©¦æ–‡ä»¶å…§å®¹", "text/plain")}
        response = client.post("/api/v1/files/upload", files=files)
        
        assert response.status_code == 200
        file_id = response.json()["file_id"]
        
        # 2. ç­‰å¾…è™•ç†å®Œæˆ
        await asyncio.sleep(5)
        
        # 3. é©—è­‰åˆ†å¡Šçµæœ
        chunking_service = ChunkingService()
        chunks = await chunking_service.get_chunks(file_id)
        
        assert len(chunks) > 0
        
        # 4. é©—è­‰å‘é‡åŒ–çµæœ
        chroma_client = ChromaDBClient()
        vectors = await chroma_client.query_by_file_id(file_id)
        
        assert len(vectors) == len(chunks)
        
        # 5. æ¸…ç†
        await chroma_client.delete_collection("test_files")
```

### 2.3 ç«¯åˆ°ç«¯æ¸¬è©¦ (E2E)

**E2E æ¸¬è©¦è¦æ±‚**:

| åŠŸèƒ½æ¨¡å¡Š | æ¸¬è©¦å ´æ™¯ | æœ€å°‘å ´æ™¯æ•¸ |
|---------|---------|-----------|
| æ–‡ä»¶ä¸Šå‚³ | ä¸Šå‚³â†’åˆ†å¡Šâ†’å‘é‡åŒ–â†’çŸ¥è­˜åœ–è­œ | 5 |
| å°è©±ç³»çµ± | å•ç­”â†’æª¢ç´¢â†’ç”Ÿæˆ | 5 |
| Ontology ç®¡ç† | å‰µå»ºâ†’ä¿®æ”¹â†’åˆªé™¤â†’æŸ¥è©¢ | 5 |
| ç³»çµ±ç®¡ç† | é…ç½®â†’ç›£æ§â†’å‘Šè­¦ | 3 |

**E2E æ¸¬è©¦ç¤ºä¾‹**:

```python
# ä½ç½®: tests/e2e/test_user_workflow.py

import pytest
from playwright.sync_api import Page, expect

@pytest.mark.e2e
class TestUserWorkflow:
    """ç”¨æˆ¶å·¥ä½œæµç«¯åˆ°ç«¯æ¸¬è©¦"""
    
    def test_user_uploads_file_and_queries_kg(
        self,
        page: Page,
        test_file_path: str,
    ):
        """æ¸¬è©¦ç”¨æˆ¶ä¸Šå‚³æ–‡ä»¶ä¸¦æŸ¥è©¢çŸ¥è­˜åœ–è­œ"""
        
        # 1. ç™»éŒ„
        page.goto("http://localhost:3000/login")
        page.fill('input[name="email"]', "test@example.com")
        page.fill('input[name="password"]', "password")
        page.click('button[type="submit"]')
        
        # 2. ä¸Šå‚³æ–‡ä»¶
        page.goto("http://localhost:3000/files")
        page.set_input_files('input[type="file"]', test_file_path)
        page.click('button:has-text("ä¸Šå‚³")')
        
        # 3. ç­‰å¾…è™•ç†å®Œæˆ
        expect(page.get_by_text("è™•ç†å®Œæˆ")).to_be_visible(timeout=60000)
        
        # 4. æŸ¥è©¢çŸ¥è­˜åœ–è­œ
        page.goto("http://localhost:3000/chat")
        page.fill('textarea[name="message"]', "æ–‡ä»¶ä¸­æœ‰ä»€éº¼ï¼Ÿ")
        page.click('button:has-text("ç™¼é€")')
        
        # 5. é©—è­‰å›ç­”
        expect(page.get_by_text("æ¸¬è©¦")).to_be_visible(timeout=30000)
```

### 2.4 æ¸¬è©¦è¦†è“‹ç‡å ±å‘Š

**è¦†è“‹ç‡é–€æª»**:

| é¡å‹ | é–€æª» | è¡Œå‹• |
|------|------|------|
| è¡Œè¦†è“‹ç‡ | < 70% | âŒ é˜»æ­¢ä¸Šæ¶ |
| åˆ†æ”¯è¦†è“‹ç‡ | < 60% | âŒ é˜»æ­¢ä¸Šæ¶ |
| å‡½æ•¸è¦†è“‹ç‡ | < 80% | âš ï¸ éœ€è¦èªªæ˜ |

**è¦†è“‹ç‡å ±å‘Šç”Ÿæˆ**:

```bash
# ç”Ÿæˆè¦†è“‹ç‡å ±å‘Š
pytest --cov=. --cov-report=html --cov-report=term

# æŸ¥çœ‹å ±å‘Š
open htmlcov/index.html
```

---

## Layer 3: ä»£ç¢¼æª¢æŸ¥

### 3.1 System Agent è‡ªå‹•æª¢æŸ¥

**Agent åç¨±**: `CodeReviewAgent`

**è·è²¬**: è‡ªå‹•æª¢æŸ¥ä»£ç¢¼è³ªé‡ã€å®‰å…¨é¢¨éšªã€è¦ç¯„ç¬¦åˆæ€§

**æª¢æŸ¥é …ç›®**:

#### 3.1.1 åŸºç¤è¦ç¯„æª¢æŸ¥

```python
# ä½ç½®: agents/governance/code_review_agent.py

class CodeReviewAgent:
    """ä»£ç¢¼å¯©æŸ¥ Agent"""
    
    async def review_code(self, pr_data: dict) -> dict:
        """å¯©æŸ¥ä»£ç¢¼"""
        
        results = {
            "compliant": True,
            "issues": [],
            "warnings": [],
            "metrics": {},
        }
        
        # 1. æ–‡ä»¶é ­æª¢æŸ¥
        results["issues"].extend(
            await self._check_file_headers(pr_data["changed_files"])
        )
        
        # 2. ç·¨ç¢¼è¦ç¯„æª¢æŸ¥
        results["warnings"].extend(
            await self._check_coding_standards(pr_data["changed_files"])
        )
        
        # 3. å°å…¥é †åºæª¢æŸ¥
        results["warnings"].extend(
            await self._check_import_order(pr_data["changed_files"])
        )
        
        # 4. å‘½åè¦ç¯„æª¢æŸ¥
        results["issues"].extend(
            await self._check_naming_conventions(pr_data["changed_files"])
        )
        
        # 5. è¨»é‡‹è¦ç¯„æª¢æŸ¥
        results["warnings"].extend(
            await self._check_comment_standards(pr_data["changed_files"])
        )
        
        # 6. è¤‡é›œåº¦æª¢æŸ¥
        results["metrics"]["complexity"] = await self._check_complexity(
            pr_data["changed_files"]
        )
        
        # 7. ä»£ç¢¼é‡è¤‡æª¢æŸ¥
        results["issues"].extend(
            await self._check_code_duplication(pr_data["changed_files"])
        )
        
        # è¨ˆç®—åˆè¦æ€§
        critical_issues = [i for i in results["issues"] if i["severity"] == "critical"]
        if critical_issues:
            results["compliant"] = False
            results["blocking_issue"] = critical_issues[0]
        
        return results
```

**æ–‡ä»¶é ­æª¢æŸ¥è¦ç¯„**:

```python
def _check_file_headers(self, files: list[dict]) -> list[dict]:
    """æª¢æŸ¥æ–‡ä»¶é ­"""
    
    issues = []
    
    for file in files:
        if file["status"] == "removed":
            continue
        
        content = file["content"]
        lines = content.split("\n")[:10]  # æª¢æŸ¥å‰ 10 è¡Œ
        
        # æª¢æŸ¥æ˜¯å¦åŒ…å«æ–‡ä»¶é ­
        has_header = any(
            "ä»£ç¢¼åŠŸèƒ½èªªæ˜" in line or
            "å‰µå»ºæ—¥æœŸ" in line or
            "å‰µå»ºäºº" in line
            for line in lines
        )
        
        if not has_header:
            issues.append({
                "file": file["path"],
                "type": "missing_file_header",
                "severity": "warning",
                "message": "æ–‡ä»¶ç¼ºå°‘å¿…è¦çš„æ–‡ä»¶é ­è¨»é‡‹",
                "line": 1,
            })
        
        # æª¢æŸ¥æ–‡ä»¶é ­æ ¼å¼
        header_pattern = re.compile(
            r"^# ä»£ç¢¼åŠŸèƒ½èªªæ˜: .+\n"
            r"# å‰µå»ºæ—¥æœŸ: .+\n"
            r"# å‰µå»ºäºº: .+\n"
            r"# æœ€å¾Œä¿®æ”¹æ—¥æœŸ: .+"
        )
        
        if not header_pattern.search(content[:500]):
            issues.append({
                "file": file["path"],
                "type": "invalid_file_header",
                "severity": "warning",
                "message": "æ–‡ä»¶é ­æ ¼å¼ä¸ç¬¦åˆè¦ç¯„",
                "line": 1,
            })
    
    return issues
```

#### 3.1.2 å®‰å…¨æª¢æŸ¥

```python
async def _check_security_issues(self, files: list[dict]) -> list[dict]:
    """æª¢æŸ¥å®‰å…¨å•é¡Œ"""
    
    issues = []
    
    # å®‰å…¨å•é¡Œæ¨¡å¼
    security_patterns = {
        "hardcoded_password": re.compile(r"password\s*=\s*['\"][^'\"]+['\"]"),
        "hardcoded_api_key": re.compile(r"api_key\s*=\s*['\"][^'\"]+['\"]"),
        "sql_injection_risk": re.compile(r"execute\([^)]*\+[^)]*\)"),
        "eval_usage": re.compile(r"eval\s*\("),
        "shell_command": re.compile(r"os\.system|subprocess\.call"),
        "temp_file_security": re.compile(r"mktemp\(\)"),
        "weak_crypto": re.compile(r"from hashlib import md5|from Crypto.Cipher import ARC4"),
    }
    
    for file in files:
        if file["status"] == "removed":
            continue
        
        content = file["content"]
        lines = content.split("\n")
        
        for pattern_name, pattern in security_patterns.items():
            matches = list(pattern.finditer(content))
            
            for match in matches:
                line_num = content[:match.start()].count("\n") + 1
                issues.append({
                    "file": file["path"],
                    "type": f"security_{pattern_name}",
                    "severity": "critical",
                    "message": f"æ½›åœ¨å®‰å…¨é¢¨éšª: {pattern_name}",
                    "line": line_num,
                    "code_snippet": lines[line_num-1].strip(),
                })
    
    return issues
```

#### 3.1.3 æ•¸æ“šåº«æ“ä½œæª¢æŸ¥

```python
async def _check_database_operations(self, files: list[dict]) -> list[dict]:
    """æª¢æŸ¥æ•¸æ“šåº«æ“ä½œ"""
    
    issues = []
    
    # å±éšªæ“ä½œæ¨¡å¼
    dangerous_patterns = {
        "drop_database": re.compile(r"DROP\s+DATABASE", re.IGNORECASE),
        "drop_collection": re.compile(r"(DROP|TRUNCATE)\s+(TABLE|COLLECTION)", re.IGNORECASE),
        "delete_all": re.compile(r"DELETE\s+FROM\s+\w+\s*(?!WHERE)"),
        "update_all": re.compile(r"UPDATE\s+\w+\s+SET\s+\w+\s*=\s*[^WHERE]*(?!WHERE)"),
    }
    
    for file in files:
        if file["status"] == "removed":
            continue
        
        content = file["content"]
        lines = content.split("\n")
        
        for pattern_name, pattern in dangerous_patterns.items():
            matches = list(pattern.finditer(content))
            
            for match in matches:
                line_num = content[:match.start()].count("\n") + 1
                
                # æª¢æŸ¥æ˜¯å¦æœ‰å‚™ä»½ä¿è­·
                context_range = range(max(0, line_num-5), min(len(lines), line_num+5))
                context = "\n".join(lines[context_range])
                
                has_backup_protection = (
                    "backup" in context.lower() or
                    "verify" in context.lower() or
                    "# TODO" in context or
                    "# FIXME" in context
                )
                
                if not has_backup_protection:
                    issues.append({
                        "file": file["path"],
                        "type": f"db_dangerous_{pattern_name}",
                        "severity": "critical",
                        "message": f"å±éšªæ•¸æ“šåº«æ“ä½œ: {pattern_name}ï¼Œç¼ºå°‘å‚™ä»½ä¿è­·",
                        "line": line_num,
                        "code_snippet": lines[line_num-1].strip(),
                    })
    
    return issues
```

#### 3.1.4 æ²»ç†è¦ç¯„æª¢æŸ¥

```python
async def _check_governance_compliance(
    self,
    files: list[dict],
    context: dict,
) -> list[dict]:
    """æª¢æŸ¥æ²»ç†è¦ç¯„åˆè¦æ€§"""
    
    issues = []
    
    # è¼‰å…¥æ²»ç†çŸ¥è­˜åº«
    governance_kb = GovernanceKnowledgeBase()
    rules = await governance_kb.get_relevant_rules(
        "code_change",
        context,
    )
    
    for file in files:
        if file["status"] == "removed":
            continue
        
        content = file["content"]
        
        for rule in rules:
            # æª¢æŸ¥æ˜¯å¦ç¬¦åˆè¦å‰‡
            compliance = await governance_kb.check_compliance(
                {"type": "code_change", "file": file},
                {"content": content},
            )
            
            if not compliance["compliant"]:
                for violation in compliance["violations"]:
                    issues.append({
                        "file": file["path"],
                        "type": f"governance_violation_{violation['rule_id']}",
                        "severity": violation["severity"],
                        "message": f"æ²»ç†è¦ç¯„é•è¦: {violation['title']}",
                        "rule_id": violation["rule_id"],
                        "required_actions": compliance["required_actions"],
                    })
    
    return issues
```

### 3.2 ä»£ç¢¼å¯©æŸ¥è¦ç¯„

**å¯©æŸ¥æ¸…å–®**:

```markdown
## Code Review æ¸…å–®

### åŠŸèƒ½æ€§
- [ ] ä»£ç¢¼å¯¦ç¾äº†éœ€æ±‚æ–‡æª”ä¸­çš„åŠŸèƒ½
- [ ] é‚Šç•Œæ¢ä»¶å·²è™•ç†
- [ ] éŒ¯èª¤è™•ç†å·²å¯¦ç¾
- [ ] æ—¥èªŒè¨˜éŒ„å……åˆ†

### ä»£ç è³ªé‡
- [ ] ä»£ç¢¼å¯è®€æ€§è‰¯å¥½
- [ ] å‡½æ•¸/æ–¹æ³•è·è²¬å–®ä¸€
- [ ] ç„¡é‡è¤‡ä»£ç¢¼
- [ ] è¤‡é›œåº¦åœ¨å¯æ¥å—ç¯„åœ
- [ ] ä½¿ç”¨äº†åˆé©çš„æ•¸æ“šçµæ§‹

### å®‰å…¨æ€§
- [ ] ç„¡ç¡¬ç·¨ç¢¼å¯†ç¢¼/API Key
- [ ] SQL æ³¨å…¥é˜²è­·
- [ ] XSS é˜²è­·
- [ ] CSRF é˜²è­·
- [ ] æ¬Šé™æª¢æŸ¥æ­£ç¢º

### æ€§èƒ½
- [ ] ç„¡æ˜é¡¯çš„æ€§èƒ½å•é¡Œ
- [ ] è³‡æ–™åº«æŸ¥è©¢å·²å„ªåŒ–
- [ ] ç·©å­˜ç­–ç•¥åˆç†
- [ ] ç„¡ä¸å¿…è¦çš„è¨ˆç®—

### æ¸¬è©¦
- [ ] å–®å…ƒæ¸¬è©¦å……åˆ†
- [ ] é›†æˆæ¸¬è©¦è¦†è“‹é—œéµè·¯å¾‘
- [ ] æ¸¬è©¦è¦†è“‹ç‡é”æ¨™
- [ ] æ¸¬è©¦å¯ç¶­è­·

### æ–‡æª”
- [ ] ä»£ç¢¼è¨»é‡‹æ¸…æ™°
- [ ] API æ–‡æª”å·²æ›´æ–°
- [ ] README å·²æ›´æ–°
- [ ] è®Šæ›´æ—¥èªŒå·²æ›´æ–°
```

**å¯©æŸ¥æµç¨‹**:

1. **è‡ªæˆ‘å¯©æŸ¥**: ä½œè€…å®Œæˆè‡ªæˆ‘å¯©æŸ¥æ¸…å–®
2. **ç³»çµ±æª¢æŸ¥**: System Agent è‡ªå‹•æª¢æŸ¥
3. **åŒè¡Œå¯©æŸ¥**: è‡³å°‘ 1 äººå¯©æŸ¥ï¼ˆType 4-5 éœ€è¦ 2 äººï¼‰
4. **æ¶æ§‹å¯©æŸ¥**: é‡å¤§è®Šæ›´éœ€è¦æ¶æ§‹å¸«å¯©æŸ¥
5. **å®‰å…¨å¯©æŸ¥**: æ¶‰åŠæ•æ„Ÿæ•¸æ“šéœ€è¦å®‰å…¨å°ˆå®¶å¯©æŸ¥

---

## Layer 4: æ²™ç›’èˆ‡é©—æ”¶

### 4.1 æ²™ç›’ç’°å¢ƒé…ç½®

**æ²™ç›’ç’°å¢ƒè¦æ±‚**:

| é …ç›® | é…ç½® |
|------|------|
| **ç’°å¢ƒåç¨±** | `sandbox` |
| **æ•¸æ“šåº«** | ç¨ç«‹å¯¦ä¾‹ï¼Œèˆ‡ Production éš”é›¢ |
| **æ•¸æ“š** | ç”Ÿç”¢æ•¸æ“šçš„åŒ¿ååŒ–å‰¯æœ¬ï¼ˆåƒ…ç”¨æ–¼é©—æ”¶ï¼‰|
| **å¤–éƒ¨æœå‹™** | ä½¿ç”¨ Mock æˆ–æ¸¬è©¦å¯¦ä¾‹ |
| **ç›£æ§** | èˆ‡ Production ç›¸åŒçš„ç›£æ§é…ç½® |
| **æ—¥èªŒ** | èˆ‡ Production ç›¸åŒçš„æ—¥èªŒç´šåˆ¥ |

### 4.2 æ²™ç›’æ¸¬è©¦è¦ç¯„

**æ¸¬è©¦æ­¥é©Ÿ**:

```bash
# 1. æº–å‚™æ²™ç›’ç’°å¢ƒ
./scripts/prepare_sandbox.sh

# 2. éƒ¨ç½²åˆ°æ²™ç›’
./scripts/deploy_sandbox.sh <branch_name>

# 3. åŸ·è¡Œæ²™ç›’æ¸¬è©¦
pytest tests/sandbox/ --env=sandbox

# 4. æ€§èƒ½æ¸¬è©¦
./scripts/run_performance_tests.sh --env=sandbox

# 5. å®‰å…¨æ¸¬è©¦
./scripts/run_security_tests.sh --env=sandbox

# 6. ç”Ÿæˆæ²™ç›’æ¸¬è©¦å ±å‘Š
./scripts/generate_sandbox_report.sh
```

**æ²™ç›’é©—æ”¶æ¨™æº–**:

| é¡å‹ | æ¨™æº– | é€šéæ¢ä»¶ |
|------|------|---------|
| **åŠŸèƒ½æ¸¬è©¦** | 100% ç”¨ä¾‹é€šé | æ‰€æœ‰æ¸¬è©¦ç”¨ä¾‹é€šé |
| **æ€§èƒ½æ¸¬è©¦** | éŸ¿æ‡‰æ™‚é–“ | P95 < 2s, P99 < 5s |
| **ç©©å®šæ€§æ¸¬è©¦** | 24 å°æ™‚é‹è¡Œ | ç„¡å´©æ½°ï¼Œç„¡å…§å­˜æ³„æ¼ |
| **å®‰å…¨æ¸¬è©¦** | ç„¡é«˜å±æ¼æ´ | OWASP ZAP æƒæé€šé |
| **æ—¥èªŒæª¢æŸ¥** | ç„¡éŒ¯èª¤æ—¥èªŒ | ERROR ç´šåˆ¥æ—¥èªŒ = 0 |
| **è³‡æºä½¿ç”¨** | å…§å­˜/CPU | å…§å­˜ < 8GB, CPU < 70% |

### 4.3 é©—æ”¶æ¸¬è©¦å ±å‘Š

**å ±å‘Šæ¨¡æ¿**:

```yaml
# æ²™ç›’é©—æ”¶æ¸¬è©¦å ±å‘Š

sandbox_test_report:
  branch: "feature/chunking-optimization"
  commit: "a1b2c3d4"
  test_date: "2026-01-27T10:00:00Z"
  
  summary:
    total_tests: 150
    passed: 148
    failed: 2
    skipped: 0
    pass_rate: "98.7%"
  
  results:
    functional_tests:
      total: 100
      passed: 100
      failed: 0
    performance_tests:
      total: 20
      passed: 20
      failed: 0
      metrics:
        p95_response_time: "1.2s"
        p99_response_time: "3.8s"
    security_tests:
      total: 20
      passed: 18
      failed: 2
      vulnerabilities:
        - type: "XSS"
          severity: "medium"
          location: "/api/v1/chat"
        - type: "SQL Injection"
          severity: "low"
          location: "/api/v1/files/search"
    stability_tests:
      duration: "24 hours"
      crashes: 0
      memory_leaks: 0
  
  logs:
    error_count: 0
    warning_count: 15
  
  resources:
    memory_peak: "6.5GB"
    cpu_average: "45%"
    disk_io: "normal"
  
  decision:
    approved: false
    blocker_issues:
      - "2 å€‹å®‰å…¨æ¼æ´éœ€è¦ä¿®å¾©"
    recommendations:
      - "ä¿®å¾© XSS æ¼æ´"
      - "ä¿®å¾© SQL Injection æ¼æ´"
      - "é‡æ–°é‹è¡Œé©—æ”¶æ¸¬è©¦"
```

---

## Layer 5: ä¸Šæ¶èˆ‡éƒ¨ç½²

### 5.1 CI/CD æµç¨‹

**CI æµç¨‹** (Continuous Integration):

```yaml
# ä½ç½®: .github/workflows/ci.yml

name: CI

on:
  pull_request:
    branches: [main, develop]

jobs:
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      # 1. é‹è¡Œ CodeReviewAgent
      - name: Run CodeReviewAgent
        run: |
          python agents/governance/code_review_agent.py \
            --pr-number ${{ github.event.number }} \
            --output report.json
      
      # 2. é‹è¡Œä»£ç¢¼æ ¼å¼æª¢æŸ¥
      - name: Code Style Check
        run: |
          black --check .
          ruff check .
      
      # 3. é‹è¡Œé¡å‹æª¢æŸ¥
      - name: Type Check
        run: |
          mypy .
      
      # 4. é‹è¡Œå–®å…ƒæ¸¬è©¦
      - name: Unit Tests
        run: |
          pytest tests/unit/ --cov=. --cov-report=xml
      
      # 5. ä¸Šå‚³è¦†è“‹ç‡
      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
  
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      # 1. é‹è¡Œå®‰å…¨æƒæ
      - name: Security Scan
        run: |
          bandit -r . -f json -o bandit-report.json
      
      # 2. é‹è¡Œä¾è³´æ¼æ´æƒæ
      - name: Dependency Scan
        run: |
          safety check --json --output safety-report.json
      
      # 3. ä¸Šå‚³å ±å‘Š
      - name: Upload Security Reports
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json
  
  integration-tests:
    runs-on: ubuntu-latest
    services:
      arangodb:
        image: arangodb:3.12
        ports:
          - 8529:8529
      qdrant:
        image: qdrant/qdrant:latest
        ports:
          - 6333:6333
    steps:
      - uses: actions/checkout@v3
      
      - name: Integration Tests
        run: |
          pytest tests/integration/ --verbose
  
  compliance-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Governance Compliance Check
        run: |
          python scripts/compliance_check.py \
            --pr-number ${{ github.event.number }}
```

**CD æµç¨‹** (Continuous Deployment):

```yaml
# ä½ç½®: .github/workflows/deploy_sandbox.yml

name: Deploy to Sandbox

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [develop]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to Sandbox
        run: |
          ./scripts/deploy_sandbox.sh ${{ github.sha }}
      
      - name: Run Sandbox Tests
        run: |
          ./scripts/run_sandbox_tests.sh
      
      - name: Generate Report
        run: |
          ./scripts/generate_sandbox_report.sh > sandbox-report.json
      
      - name: Comment PR
        uses: actions/github-script@v6
        with:
          script: |
            const report = require('./sandbox-report.json');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              body: `## æ²™ç›’æ¸¬è©¦å ±å‘Š\n\`\`\`yaml\n${JSON.stringify(report, null, 2)}\n\`\`\``
            });
```

### 5.2 ç°åº¦ç™¼å¸ƒæµç¨‹

**ç°åº¦ç™¼å¸ƒç­–ç•¥**:

```python
# ä½ç½®: scripts/gradual_deployment.py

class GradualDeployment:
    """ç°åº¦ç™¼å¸ƒç®¡ç†"""
    
    async def deploy_gradual(
        self,
        version: str,
        strategy: str = "canary",
    ) -> dict:
        """åŸ·è¡Œç°åº¦ç™¼å¸ƒ"""
        
        stages = {
            "canary": [
                {"traffic": "5%", "duration": "30min"},
                {"traffic": "10%", "duration": "30min"},
                {"traffic": "25%", "duration": "1h"},
                {"traffic": "50%", "duration": "2h"},
                {"traffic": "100%", "duration": "-"},
            ],
            "blue-green": [
                {"traffic": "100%", "duration": "monitor"},
                {"cutover": true},
            ],
        }
        
        deployment = {
            "version": version,
            "strategy": strategy,
            "stages": stages[strategy],
            "current_stage": 0,
            "status": "in_progress",
        }
        
        # åŸ·è¡Œç™¼å¸ƒ
        for stage in deployment["stages"]:
            await self._deploy_stage(stage)
            await self._monitor(stage["duration"])
            
            # æª¢æŸ¥æ˜¯å¦ç¹¼çºŒ
            if not await self._should_continue():
                await self._rollback()
                return {
                    "status": "rolled_back",
                    "reason": "ç›£æ§æŒ‡æ¨™ä¸é”æ¨™",
                }
        
        deployment["status"] = "completed"
        return deployment
```

### 5.3 å›æ»¾æ©Ÿåˆ¶

**å›æ»¾è§¸ç™¼æ¢ä»¶**:

| æ¢ä»¶ | é–¾å€¼ | è‡ªå‹•å›æ»¾ |
|------|------|---------|
| éŒ¯èª¤ç‡ | > 5% | âœ… |
| P95 éŸ¿æ‡‰æ™‚é–“ | > 3s | âœ… |
| CPU ä½¿ç”¨ç‡ | > 80% | âš ï¸ å‘Šè­¦ |
| å…§å­˜ä½¿ç”¨ç‡ | > 90% | âœ… |
| å´©æ½°æ¬¡æ•¸ | > 3/å°æ™‚ | âœ… |

**å›æ»¾æµç¨‹**:

```bash
# 1. æª¢æ¸¬åˆ°å•é¡Œ
./scripts/monitor_deployment.sh --alert

# 2. è‡ªå‹•å›æ»¾
./scripts/rollback.sh --version <previous_version>

# 3. é©—è­‰å›æ»¾
./scripts/verify_rollback.sh

# 4. ç™¼é€é€šçŸ¥
./scripts/send_rollback_notification.sh
```

### 5.4 ä¸Šæ¶å¯©æ‰¹æµç¨‹

**å¯©æ‰¹ç´šåˆ¥**:

| è®Šæ›´é¡å‹ | å¯©æ‰¹äºº | æ‰¹å‡†æ–¹å¼ |
|---------|--------|---------|
| **Type 1: ç·Šæ€¥ä¿®å¾©** | Tech Lead | GitHub PR Comment |
| **Type 2: å°å‹è®Šæ›´** | Team Lead | GitHub PR Approval |
| **Type 3: ä¸­å‹è®Šæ›´** | 2 x Tech Lead | GitHub PR Approval |
| **Type 4: å¤§å‹è®Šæ›´** | 2 x Tech Lead + Arch | GitHub PR Approval |
| **Type 5: é—œéµè®Šæ›´** | 3 x Tech Lead + SysAdmin + Arch | æœƒè­°å¯©æ‰¹ + ç°½ç½²æ–‡ä»¶ |

**å¯©æ‰¹æª¢æŸ¥æ¸…å–®**:

```yaml
approval_checklist:
  code_review:
    - [ ] CodeReviewAgent æª¢æŸ¥é€šé
    - [ ] ä»£ç¢¼æ ¼å¼æª¢æŸ¥é€šé
    - [ ] å–®å…ƒæ¸¬è©¦é€šé
    - [ ] é›†æˆæ¸¬è©¦é€šé
    - [ ] å®‰å…¨æƒæé€šé
  
  testing:
    - [ ] æ¸¬è©¦è¦†è“‹ç‡é”æ¨™
    - [ ] æ²™ç›’æ¸¬è©¦é€šé
    - [ ] æ€§èƒ½æ¸¬è©¦é€šé
    - [ ] å®‰å…¨æ¸¬è©¦é€šé
  
  governance:
    - [ ] é¢¨éšªè©•ä¼°å®Œæˆ
    - [ ] å›æ»¾è¨ˆåŠƒå·²æº–å‚™
    - [ ] è®Šæ›´çª—å£å·²ç¢ºèª
    - [ ] ç›¸é—œåœ˜éšŠå·²é€šçŸ¥
  
  documentation:
    - [ ] API æ–‡æª”å·²æ›´æ–°
    - [ ] README å·²æ›´æ–°
    - [ ] è®Šæ›´æ—¥èªŒå·²æ›´æ–°
    - [ ] éƒ¨ç½²æ–‡æª”å·²æº–å‚™
  
  deployment:
    - [ ] å‚™ä»½å·²å®Œæˆ
    - [ ] å›æ»¾è…³æœ¬å·²æ¸¬è©¦
    - [ ] ç›£æ§å·²é…ç½®
    - [ ] é‹ç¶­å·²é€šçŸ¥
```

---

## System Agent è©³ç´°è¨­è¨ˆ

### Agent é…ç½®

```python
# ä½ç½®: agents/governance/code_review_agent.py

class CodeReviewAgentConfig:
    """CodeReviewAgent é…ç½®"""
    
    # æª¢æŸ¥é–‹é—œ
    checks_enabled = {
        "file_header": True,
        "coding_standards": True,
        "import_order": True,
        "naming_conventions": True,
        "comment_standards": True,
        "complexity": True,
        "code_duplication": True,
        "security": True,
        "database_operations": True,
        "governance_compliance": True,
    }
    
    # åš´é‡ç´šåˆ¥é–¾å€¼
    severity_thresholds = {
        "critical": 0,  # é˜»æ­¢ä¸Šæ¶
        "high": 3,     # éœ€è¦ä¿®å¾©
        "medium": 10,   # å»ºè­°ä¿®å¾©
        "low": 20,      # å¯ä»¥å¿½ç•¥
    }
    
    # è¦†è“‹ç‡è¦æ±‚
    coverage_requirements = {
        "line": 70,
        "branch": 60,
        "function": 80,
    }
    
    # è¤‡é›œåº¦é™åˆ¶
    complexity_limits = {
        "cyclomatic_complexity": 10,
        "cognitive_complexity": 15,
        "maintainability_index": 20,
    }
```

### Agent èˆ‡ GitHub Actions é›†æˆ

```yaml
# ä½ç½®: .github/workflows/code_review.yml

name: Code Review by Agent

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

jobs:
  code-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Run CodeReviewAgent
        id: review
        run: |
          python agents/governance/code_review_agent.py \
            --pr-number ${{ github.event.number }} \
            --repo ${{ github.repository }} \
            --output review_result.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Post Review Comment
        if: steps.review.outputs.has-issues == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const review = JSON.parse(fs.readFileSync('review_result.json', 'utf8'));
            
            let comment = '## Code Review å ±å‘Š\n\n';
            
            if (review.critical_issues.length > 0) {
              comment += '### âŒ Critical Issues (å¿…é ˆä¿®å¾©)\n\n';
              review.critical_issues.forEach(issue => {
                comment += `- [**${issue.type}**] ${issue.message}\n`;
                comment += `  ğŸ“ ${issue.file}:${issue.line}\n`;
                comment += `  ğŸ’¡ ${issue.suggestion}\n\n`;
              });
            }
            
            if (review.high_issues.length > 0) {
              comment += '### âš ï¸ High Issues (å»ºè­°ä¿®å¾©)\n\n';
              review.high_issues.forEach(issue => {
                comment += `- [**${issue.type}**] ${issue.message}\n\n`;
              });
            }
            
            comment += `\n---\n`;
            comment += `### è¦†è“‹ç‡: ${review.coverage.line}% (Line)\n`;
            comment += `### è¤‡é›œåº¦å¹³å‡åˆ†: ${review.metrics.avg_complexity}\n`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              body: comment,
            });
      
      - name: Block PR if Critical Issues
        if: steps.review.outputs.has-critical == 'true'
        run: |
          exit 1
```

### Agent æª¢æŸ¥çµæœç¤ºä¾‹

```json
{
  "compliant": false,
  "has_critical": true,
  "has_high": false,
  "critical_issues": [
    {
      "type": "db_dangerous_drop_collection",
      "severity": "critical",
      "message": "å±éšªæ•¸æ“šåº«æ“ä½œ: DROP COLLECTIONï¼Œç¼ºå°‘å‚™ä»½ä¿è­·",
      "file": "services/migration/cleanup_old_data.py",
      "line": 42,
      "code_snippet": "db.collection.drop()",
      "suggestion": "åœ¨ DROP å‰æ·»åŠ å‚™ä»½æª¢æŸ¥ï¼Œæˆ–ä½¿ç”¨è»Ÿåˆªé™¤ï¼ˆis_active=falseï¼‰"
    }
  ],
  "high_issues": [],
  "medium_issues": [
    {
      "type": "security_hardcoded_password",
      "severity": "medium",
      "message": "æ½›åœ¨å®‰å…¨é¢¨éšª: hardcoded_password",
      "file": "tests/test_api.py",
      "line": 15,
      "code_snippet": "password='test123'",
      "suggestion": "ä½¿ç”¨ç’°å¢ƒè®Šæ•¸æˆ–é…ç½®æ–‡ä»¶"
    }
  ],
  "warnings": [
    {
      "type": "coding_standards_import_order",
      "severity": "warning",
      "message": "å°å…¥é †åºä¸ç¬¦åˆè¦ç¯„",
      "file": "api/main.py",
      "line": 10
    }
  ],
  "metrics": {
    "complexity": {
      "avg": 5.2,
      "max": 18,
      "files_with_high_complexity": 2
    },
    "coverage": {
      "line": 75.5,
      "branch": 68.2,
      "function": 82.1
    },
    "duplication": {
      "percentage": 3.2,
      "files_affected": 5
    }
  }
}
```

---

## å¯¦æ–½è·¯ç·šåœ–

### Phase 1: åŸºç¤è¨­æ–½ï¼ˆå„ªå…ˆç´šï¼šP0ï¼‰

**å·¥æœŸ**: 5 å¤©

| ä»»å‹™ | äº¤ä»˜ç‰© | ç‹€æ…‹ |
|------|--------|------|
| CodeReviewAgent é–‹ç™¼ | `agents/governance/code_review_agent.py` | |
| CI/CD æµç¨‹è¨­ç½® | `.github/workflows/` | |
| æ²™ç›’ç’°å¢ƒæº–å‚™ | Docker Compose é…ç½® | |
| æ¸¬è©¦å ±å‘Šç”Ÿæˆ | `scripts/generate_test_report.sh` | |

### Phase 2: è¦å‰‡å®šç¾©ï¼ˆå„ªå…ˆç´šï¼šP1ï¼‰

**å·¥æœŸ**: 3 å¤©

| ä»»å‹™ | äº¤ä»˜ç‰© | ç‹€æ…‹ |
|------|--------|------|
| æ²»ç†çŸ¥è­˜åº« | `kag/ontology/governance_knowledge.json` | |
| è¦å‰‡æ–‡æª”å®šç¾© | `docs/è¦å‰‡ç®¡ç†/` | |
| å¯©æ‰¹æµç¨‹æ–‡æª” | `docs/è¦å‰‡ç®¡ç†/å¯©æ‰¹æµç¨‹.md` | |
| è®Šæ›´è«‹æ±‚æ¨¡æ¿ | `.github/CHANGE_REQUEST_TEMPLATE.md` | |

### Phase 3: æ¸¬è©¦æ¡†æ¶ï¼ˆå„ªå…ˆç´šï¼šP1ï¼‰

**å·¥æœŸ**: 7 å¤©

| ä»»å‹™ | äº¤ä»˜ç‰© | ç‹€æ…‹ |
|------|--------|------|
| å–®å…ƒæ¸¬è©¦æ¡†æ¶ | `tests/unit/` | |
| é›†æˆæ¸¬è©¦æ¡†æ¶ | `tests/integration/` | |
| E2E æ¸¬è©¦æ¡†æ¶ | `tests/e2e/` | |
| æ²™ç›’æ¸¬è©¦è…³æœ¬ | `tests/sandbox/` | |

### Phase 4: ä¸Šæ¶æµç¨‹ï¼ˆå„ªå…ˆç´šï¼šP2ï¼‰

**å·¥æœŸ**: 5 å¤©

| ä»»å‹™ | äº¤ä»˜ç‰© | ç‹€æ…‹ |
|------|--------|------|
| ç°åº¦ç™¼å¸ƒè…³æœ¬ | `scripts/gradual_deployment.py` | |
| å›æ»¾è…³æœ¬ | `scripts/rollback.sh` | |
| ç›£æ§å‘Šè­¦è…³æœ¬ | `scripts/monitor_deployment.sh` | |
| ä¸Šæ¶å¯©æ‰¹æµç¨‹ | GitHub Actions | |

### Phase 5: å„ªåŒ–èˆ‡æ–‡æª”ï¼ˆå„ªå…ˆç´šï¼šP2ï¼‰

**å·¥æœŸ**: 3 å¤©

| ä»»å‹™ | äº¤ä»˜ç‰© | ç‹€æ…‹ |
|------|--------|------|
| åŸ¹è¨“æ–‡æª” | `docs/åŸ¹è¨“/` | |
| å¸¸è¦‹å•é¡Œæ–‡æª” | `docs/FAQ/` | |
| æµç¨‹æ”¹é€² | æ–‡æª”æ›´æ–° | |

---

## é æœŸæ•ˆæœ

### è³ªé‡æå‡

| æŒ‡æ¨™ | å¯¦æ–½å‰ | å¯¦æ–½å¾Œ | æå‡å¹…åº¦ |
|------|--------|--------|---------|
| ç·šä¸Š Bug ç‡ | 15% | 3% | 80% â†“ |
| ä»£ç¢¼è¦†è“‹ç‡ | 60% | 85% | 42% â†‘ |
| å›æ»¾ç‡ | 8% | 1% | 87.5% â†“ |
| ä¸Šæ¶å¤±æ•—ç‡ | 20% | 5% | 75% â†“ |

### æ•ˆç‡æå‡

| æŒ‡æ¨™ | å¯¦æ–½å‰ | å¯¦æ–½å¾Œ | æå‡å¹…åº¦ |
|------|--------|--------|---------|
| Code Review æ™‚é–“ | 4 å°æ™‚ | è‡ªå‹•åŒ– | 100% â†“ |
| æ¸¬è©¦åŸ·è¡Œæ™‚é–“ | 2 å°æ™‚ | 30 åˆ†é˜ | 75% â†“ |
| ä¸Šæ¶æº–å‚™æ™‚é–“ | 8 å°æ™‚ | è‡ªå‹•åŒ– | 87.5% â†“ |
| å›æ»¾æ™‚é–“ | 1 å°æ™‚ | 15 åˆ†é˜ | 75% â†“ |

---

## æ–‡æª”ç¶­è­·

### ç‰ˆæœ¬è¨˜éŒ„

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®æ”¹äººå“¡ | ä¿®æ”¹å…§å®¹ |
|------|------|---------|---------|
| 1.0 | 2026-01-27 | Daniel Chung | åˆå§‹ç‰ˆæœ¬ï¼Œå®šç¾©å®Œæ•´çš„ Production ç’°å¢ƒè¦å‰‡ç®¡ç† |

### ç›¸é—œæ–‡æª”

- [AI-Box ç³»çµ± AI æ²»ç†è¦åŠƒ](AI-Box-ç³»çµ±AIæ²»ç†è¦åŠƒ.md)
- [æ•¸æ“šå‚™ä»½è¦ç¯„](æ•¸æ“šå‚™ä»½è¦ç¯„.md)
- [é–‹ç™¼è¦ç¯„](../../../é–‹ç™¼è¦ç¯„/)
- [Code Review æŒ‡å—](../../../é–‹ç™¼è¦ç¯„/code_review.md)

---

## å¯©æŸ¥æ¸…å–®

åœ¨å¯¦æ–½å‰ï¼Œè«‹ç¢ºèªä»¥ä¸‹äº‹é …ï¼š

- [ ] é€™ä»½è¦å‰‡å·²ç¶“éæŠ€è¡“å¯©æŸ¥
- [ ] é€™ä»½è¦å‰‡å·²ç¶“éå®‰å…¨å¯©æŸ¥
- [ ] é€™ä»½è¦å‰‡å·²ç¶“éåˆè¦å¯©æŸ¥
- [ ] æ‰€æœ‰ä¾è³´çš„æŠ€è¡“æ£§å·²ç¢ºèª
- [ ] å¯¦æ–½åœ˜éšŠå·²çµ„å»º
- [ ] å¯¦æ–½è³‡æºå·²åˆ†é…
- [ ] å¯¦æ–½æ™‚é–“è¡¨å·²ç¢ºèª
- [ ] åŸ¹è¨“è¨ˆåŠƒå·²æº–å‚™

---

## è¡Œå‹•é …

è«‹åœ¨å¯©æŸ¥å¾Œç¢ºå®šä»¥ä¸‹è¡Œå‹•é …ï¼š

- [ ] æ‰¹å‡†é€™ä»½è¦å‰‡
- [ ] ç¢ºèªå¯¦æ–½å„ªå…ˆç´š
- [ ] åˆ†é…å¯¦æ–½è³‡æº
- [ ] é¸æ“‡å„ªå…ˆå¯¦æ–½çš„ Phase
- [ ] æŒ‡æ´¾é …ç›®ç¶“ç†
- [ ] å»ºç«‹å¯©æŸ¥æµç¨‹
- [ ] å®‰æ’åŸ¹è¨“æ™‚é–“
