# 超時問題診斷指南

**版本**: 1.0
**創建日期**: 2026-01-06
**創建人**: Daniel Chung
**最後修改日期**: 2026-01-06

---

## 📋 概述

本文檔提供超時問題的診斷指南，幫助快速定位和解決 API 請求超時問題。

---

## 🔍 超時問題類型

### 1. `createUserTask` API 超時

**錯誤信息**:

```
[apiRequest] Request timeout for https://iee.k84.org/api/v1/user-tasks
```

**可能原因**:

- 工作區創建耗時過長
- 排程目錄創建耗時過長
- ArangoDB 連接問題
- 文件系統操作緩慢

**診斷步驟**:

1. **檢查日誌**:

   ```bash
   # 查找 create_user_task 相關日誌
   grep -E "create_user_task|workspace_creation" logs/fastapi.log | tail -50
   ```

2. **檢查關鍵日誌**:
   - `create_user_task START` - 請求開始
   - `create_user_task SUCCESS` - 請求成功（包含耗時）
   - `create_user_task ERROR` - 請求失敗（包含耗時）
   - `workspace_creation_slow` - 工作區創建緩慢
   - `create_workspace_failed` - 工作區創建失敗

3. **性能指標**:
   - 正常耗時: < 1秒
   - 警告閾值: > 2秒
   - 超時時間: 30秒（前端）

**解決方案**:

- ✅ **已修復**: 添加了 `build_file_tree=False` 參數，默認不構建 fileTree
- ✅ **已修復**: 工作區創建失敗不影響任務創建
- ✅ **已修復**: 添加了性能監控和超時保護

---

### 2. `chatProductStream` API 超時（120秒）

**錯誤信息**:

```
[Home] Streaming error: Error: API request timeout after 120 seconds
```

**可能原因**:

- Task Analyzer 處理時間過長
- Router LLM 響應時間過長
- LLM 生成時間過長
- 文件創建邏輯耗時

**診斷步驟**:

1. **檢查日誌**:

   ```bash
   # 查找 chat_product_stream 相關日誌
   grep -E "chat_product_stream|task_analyzer|router_llm|llm_completed" logs/fastapi.log | tail -50
   ```

2. **檢查關鍵日誌**:
   - `chat_product_stream START` - 請求開始
   - `chat_product_stream COMPLETE` - 請求完成（包含耗時）
   - `chat_product_stream ERROR` - 請求失敗（包含耗時）
   - `router_llm_semantic_analysis_result` - Router LLM 分析結果
   - `task_analyzer_result_assigned` - Task Analyzer 結果

3. **性能指標**:
   - 正常耗時: < 30秒
   - 警告閾值: > 60秒
   - 超時時間: 120秒（前端）

**解決方案**:

- ✅ **已修復**: 添加了詳細的日誌追蹤
- ⚠️ **需要優化**: 如果 Task Analyzer 處理時間過長，可能需要優化
- ⚠️ **需要優化**: 如果 LLM 響應時間過長，可能需要調整模型或參數

---

## 📊 日誌追蹤關鍵字

### `createUserTask` API 日誌

| 日誌關鍵字 | 說明 | 檢查點 |
|-----------|------|--------|
| `create_user_task START` | 請求開始 | ✅ 確認請求到達後端 |
| `create_user_task SUCCESS` | 請求成功 | ✅ 確認請求完成時間 |
| `create_user_task ERROR` | 請求失敗 | ❌ 檢查錯誤原因 |
| `create_user_task SLOW` | 請求緩慢 | ⚠️ 檢查性能問題 |
| `workspace_creation_slow` | 工作區創建緩慢 | ⚠️ 檢查文件系統性能 |
| `create_workspace_failed` | 工作區創建失敗 | ❌ 檢查文件系統權限 |

### `chatProductStream` API 日誌

| 日誌關鍵字 | 說明 | 檢查點 |
|-----------|------|--------|
| `chat_product_stream START` | 請求開始 | ✅ 確認請求到達後端 |
| `chat_product_stream COMPLETE` | 請求完成 | ✅ 確認請求完成時間 |
| `chat_product_stream ERROR` | 請求失敗 | ❌ 檢查錯誤原因 |
| `router_llm_semantic_analysis_result` | Router LLM 分析結果 | ✅ 檢查語義分析耗時 |
| `task_analyzer_result_assigned` | Task Analyzer 結果 | ✅ 檢查 Task Analyzer 耗時 |
| `llm_completed` | LLM 生成完成 | ✅ 檢查 LLM 響應時間 |

---

## 🔧 快速診斷命令

### 檢查 `createUserTask` 超時

```bash
# 查找最近的 create_user_task 日誌
grep -E "create_user_task|workspace_creation" logs/fastapi.log | tail -50

# 查找超時的請求（耗時 > 2秒）
grep "create_user_task.*SLOW\|elapsed_time" logs/fastapi.log | tail -20

# 查找失敗的請求
grep "create_user_task.*ERROR" logs/fastapi.log | tail -20
```

### 檢查 `chatProductStream` 超時

```bash
# 查找最近的 chat_product_stream 日誌
grep -E "chat_product_stream|task_analyzer|router_llm" logs/fastapi.log | tail -50

# 查找超時的請求（耗時 > 60秒）
grep "chat_product_stream.*COMPLETE\|elapsed_time" logs/fastapi.log | tail -20

# 查找失敗的請求
grep "chat_product_stream.*ERROR" logs/fastapi.log | tail -20
```

### 檢查所有請求日誌

```bash
# 查找所有 API 請求（通過 LoggingMiddleware）
grep -E "\[.*\] Request:|\[.*\] Response:" logs/fastapi.log | tail -50

# 查找處理時間 > 5秒的請求
grep "Time: [5-9]\|Time: [0-9][0-9]" logs/fastapi.log | tail -20
```

---

## 🐛 常見問題診斷

### 問題 1: 日誌中沒有記錄

**症狀**: 執行 `grep` 命令沒有找到任何日誌

**可能原因**:

- 請求沒有到達後端（網絡問題、前端錯誤）
- 日誌級別設置過高
- 日誌文件路徑錯誤

**解決方案**:

1. 檢查網絡連接
2. 檢查前端控制台錯誤
3. 檢查日誌級別設置（`LOG_LEVEL` 環境變量）
4. 檢查日誌文件路徑（`logs/fastapi.log`）

---

### 問題 2: 請求到達但立即超時

**症狀**: 日誌顯示 `START` 但沒有 `COMPLETE` 或 `ERROR`

**可能原因**:

- 後端處理時間過長
- 數據庫查詢超時
- LLM 響應超時

**解決方案**:

1. 檢查數據庫連接狀態
2. 檢查 LLM 服務狀態
3. 檢查服務器負載
4. 優化耗時操作

---

### 問題 3: 工作區創建失敗導致超時

**症狀**: 日誌顯示 `create_workspace_failed`

**可能原因**:

- 文件系統權限問題
- 存儲路徑不存在
- 磁盤空間不足

**解決方案**:

1. 檢查文件系統權限
2. 檢查存儲路徑配置
3. 檢查磁盤空間
4. 確認工作區創建失敗不影響任務創建（已修復）

---

## 📚 相關文檔

- [文件生成日誌追蹤指南](./文件生成日誌追蹤指南.md)
- [測試Data任務文件生成問題診斷指南](./測試Data任務文件生成問題診斷指南.md)

---

**最後更新日期**: 2026-01-06
**文檔版本**: 1.0
**維護人**: Daniel Chung
