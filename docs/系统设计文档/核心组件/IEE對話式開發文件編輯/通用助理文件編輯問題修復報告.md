# é€šç”¨åŠ©ç†æ–‡ä»¶ç·¨è¼¯å•é¡Œä¿®å¾©å ±å‘Š

**ç‰ˆæœ¬**: 1.0
**å‰µå»ºæ—¥æœŸ**: 2026-01-06
**å‰µå»ºäºº**: Daniel Chung
**æœ€å¾Œä¿®æ”¹æ—¥æœŸ**: 2026-01-06

---

## ğŸ“‹ å•é¡Œæè¿°

é€šç”¨åŠ©ç† Assistant ç„¡æ³•ç”Ÿæˆæ–‡ä»¶ï¼Œå³ä½¿é…ç½®äº† `document_editing` å·¥å…·ï¼Œç³»çµ±ä»ç„¶è¿”å›ä¸€èˆ¬å°è©±å›å¾©è€Œä¸æ˜¯åŸ·è¡Œæ–‡ä»¶ç·¨è¼¯æ“ä½œã€‚

---

## ğŸ” å•é¡Œåˆ†æ

### æ ¹æœ¬åŸå› 

**å•é¡Œ 1: å‰ç«¯æœªå‚³é Assistant çš„ `allowedTools`**

åœ¨ `Home.tsx` çš„ `handleMessageSend` å‡½æ•¸ä¸­ï¼Œ`allowedTools` çš„æ§‹å»ºé‚è¼¯åªæª¢æŸ¥äº† `tools?.web_search`ï¼Œæ²’æœ‰å¾ Assistant çš„é…ç½®ä¸­ç²å– `allowedTools`ï¼š

```typescript
// âŒ éŒ¯èª¤ï¼šåªæª¢æŸ¥ web_search
const allowedTools: string[] = [];
if (tools?.web_search) {
  allowedTools.push('web_search');
}
```

**å•é¡Œ 2: ChatInput æœªå°‡ Assistant çš„ `allowedTools` åŒ…å«åœ¨æ¶ˆæ¯ä¸­**

åœ¨ `ChatInput.tsx` çš„ `handleSend` å‡½æ•¸ä¸­ï¼Œåªå‚³éäº† `assistantId`ï¼Œæ²’æœ‰å‚³é `allowedTools`ï¼š

```typescript
// âŒ éŒ¯èª¤ï¼šæ²’æœ‰å‚³é allowedTools
const messageWithFiles = {
  text: messageText,
  assistantId: selectedAssistantId,
  // ç¼ºå°‘ allowedTools
};
```

**å•é¡Œ 3: Router LLM System Prompt ç¼ºå°‘ç°¡çŸ­æŒ‡ä»¤ç¤ºä¾‹**

Router LLM çš„ System Prompt ä¸­ç¼ºå°‘ç°¡çŸ­çš„æ–‡ä»¶ç”ŸæˆæŒ‡ä»¤ç¤ºä¾‹ï¼ˆå¦‚ã€Œç”Ÿæˆæ–‡ä»¶ã€ã€ã€Œå¹«æˆ‘ç”¢ç”Ÿæ–‡ä»¶ã€ï¼‰ï¼Œå¯èƒ½å°è‡´ç„¡æ³•æ­£ç¢ºè­˜åˆ¥æ„åœ–ã€‚

---

## âœ… ä¿®å¾©æ–¹æ¡ˆ

### ä¿®å¾© 1: ChatInput å‚³é Assistant çš„ `allowedTools`

**æ–‡ä»¶**: `ai-bot/src/components/ChatInput.tsx`

**ä¿®æ”¹å…§å®¹**:

- åœ¨ `handleSend` å‡½æ•¸ä¸­ï¼Œå¾ Assistant é…ç½®ä¸­ç²å– `allowedTools`ï¼ˆåŒ…æ‹¬å¾ localStorage è®€å–ï¼‰
- å°‡ `allowedTools` æ·»åŠ åˆ° `messageWithFiles` å°è±¡ä¸­

**ä»£ç¢¼è®Šæ›´**:

```typescript
// âœ… æ­£ç¢ºï¼šç²å– Assistant çš„ allowedTools
let assistantAllowedTools: string[] = [];
if (selectedAssistantId) {
  const assistant = safeAssistants.find(a => a && a.id === selectedAssistantId);
  if (assistant) {
    const baseTools = assistant.allowedTools || [];
    // å¾ localStorage ç²å–å·¥å…·åˆ—è¡¨
    let localStorageTools: string[] = [];
    try {
      const storageKey = `assistant_${assistant.id}_allowedTools`;
      const stored = localStorage.getItem(storageKey);
      if (stored) {
        localStorageTools = JSON.parse(stored);
      }
    } catch (e) {
      // å¿½ç•¥éŒ¯èª¤
    }

    // åˆä½µæ‰€æœ‰å·¥å…·
    assistantAllowedTools = Array.from(new Set([
      ...(Array.isArray(baseTools) ? baseTools : []),
      ...(Array.isArray(localStorageTools) ? localStorageTools : []),
    ]));
  }
}

const messageWithFiles = {
  text: messageText,
  assistantId: selectedAssistantId,
  allowedTools: assistantAllowedTools.length > 0 ? assistantAllowedTools : undefined, // âœ… æ·»åŠ 
};
```

---

### ä¿®å¾© 2: Home.tsx å¾æ¶ˆæ¯ä¸­æå– `allowedTools`

**æ–‡ä»¶**: `ai-bot/src/pages/Home.tsx`

**ä¿®æ”¹å…§å®¹**:

- åœ¨ `handleMessageSend` å‡½æ•¸ä¸­ï¼Œå¾æ¶ˆæ¯ä¸­æå– `allowedTools`ï¼ˆä¾†è‡ª Assistant é…ç½®ï¼‰
- å„ªå…ˆä½¿ç”¨æ¶ˆæ¯ä¸­çš„ `allowedTools`ï¼Œè€Œä¸æ˜¯åªæª¢æŸ¥ `web_search`

**ä»£ç¢¼è®Šæ›´**:

```typescript
// âœ… æ­£ç¢ºï¼šå¾æ¶ˆæ¯ä¸­æå– allowedTools
const allowedTools: string[] = [];

// å¾æ¶ˆæ¯ä¸­æå– allowedToolsï¼ˆå¦‚æœå­˜åœ¨ï¼‰
let messageAllowedTools: string[] = [];
try {
  const parsedMessage = JSON.parse(raw);
  if (parsedMessage?.allowedTools && Array.isArray(parsedMessage.allowedTools)) {
    messageAllowedTools = parsedMessage.allowedTools;
  }
} catch (e) {
  // å¿½ç•¥è§£æéŒ¯èª¤
}

// å„ªå…ˆä½¿ç”¨æ¶ˆæ¯ä¸­çš„ allowedToolsï¼ˆä¾†è‡ª Assistant é…ç½®ï¼‰
if (messageAllowedTools.length > 0) {
  allowedTools.push(...messageAllowedTools);
}

// å¦‚æœ web_search è¢«æ¿€æ´»ï¼Œç¢ºä¿åŒ…å«åœ¨ allowedTools ä¸­
if (tools?.web_search && !allowedTools.includes('web_search')) {
  allowedTools.push('web_search');
}
```

---

### ä¿®å¾© 3: å¢å¼· Router LLM System Prompt

**æ–‡ä»¶**: `agents/task_analyzer/router_llm.py`

**ä¿®æ”¹å…§å®¹**:

- åœ¨ System Prompt ä¸­æ·»åŠ æ›´å¤šæ–‡ä»¶ç”ŸæˆæŒ‡ä»¤ç¤ºä¾‹
- æ˜ç¢ºèªªæ˜ç°¡çŸ­æŒ‡ä»¤ï¼ˆå¦‚ã€Œç”Ÿæˆæ–‡ä»¶ã€ã€ã€Œå¹«æˆ‘ç”¢ç”Ÿæ–‡ä»¶ã€ï¼‰ä¹Ÿéœ€è¦ `needs_tools=true`

**ä»£ç¢¼è®Šæ›´**:

```python
Examples that NEED tools:
- "å¹«æˆ‘ç”¢ç”ŸData Agentæ–‡ä»¶" / "generate Data Agent document" â†’ needs_tools=true (requires document editing tool)
- "å¹«æˆ‘ç”¢ç”Ÿæ–‡ä»¶" / "generate a file" â†’ needs_tools=true (requires document editing tool)
- "ç”Ÿæˆæ–‡ä»¶" / "create a file" â†’ needs_tools=true (requires document editing tool)
```

---

## ğŸ”„ å®Œæ•´æµç¨‹è¿½è¹¤

### ä¿®å¾©å¾Œçš„æµç¨‹

1. **å‰ç«¯ ChatInput** (`ChatInput.tsx:1027-1042`)
   - âœ… ç²å– Assistant çš„ `allowedTools`ï¼ˆå¾é…ç½®å’Œ localStorageï¼‰
   - âœ… å°‡ `allowedTools` æ·»åŠ åˆ°æ¶ˆæ¯ä¸­

2. **å‰ç«¯ Home** (`Home.tsx:602-612`)
   - âœ… å¾æ¶ˆæ¯ä¸­æå– `allowedTools`
   - âœ… å°‡ `allowedTools` å‚³éçµ¦å¾Œç«¯ API

3. **å¾Œç«¯ API** (`chat.py:1378-1389`)
   - âœ… æ¥æ”¶ `allowed_tools` åƒæ•¸
   - âœ… å¦‚æœåŒ…å« `document_editing`ï¼Œè‡ªå‹•æ·»åŠ  `datetime` å·¥å…·

4. **Task Analyzer** (`chat.py:980-989`)
   - âœ… å°‡ `allowed_tools` å‚³éçµ¦ Task Analyzer
   - âœ… Capability Matcher å„ªå…ˆè€ƒæ…®å•Ÿç”¨çš„å·¥å…·

5. **Router LLM** (`router_llm.py:35-44`)
   - âœ… è­˜åˆ¥æ–‡ä»¶ç”Ÿæˆæ„åœ–ï¼ˆ`needs_tools=true`, `intent_type="execution"`ï¼‰

6. **Capability Matcher** (`capability_matcher.py:338-351`)
   - âœ… åŒ¹é… `document_editing` å·¥å…·ï¼ˆå¦‚æœ `has_file_editing_enabled=True`ï¼‰

7. **Decision Engine** (`decision_engine.py:269-292`)
   - âœ… é¸æ“‡ `document_editing` å·¥å…·ï¼ˆè©•åˆ† >= 0.5ï¼‰

8. **System Prompt å¢å¼·** (`chat.py:1967-2014`)
   - âœ… å¢å¼· System Promptï¼ŒæŒ‡ç¤º AI ç”Ÿæˆæ–‡æª”å…§å®¹

9. **æ–‡ä»¶å‰µå»º** (`chat.py:2209-2286`)
   - âœ… èª¿ç”¨ `_try_create_file_from_chat_output` å‰µå»ºæ–‡ä»¶

---

## ğŸ“Š æª¢æŸ¥æ¸…å–®

ä¿®å¾©å¾Œï¼Œè«‹ç¢ºèªä»¥ä¸‹é …ç›®ï¼š

### å‰ç«¯æª¢æŸ¥

- [ ] **Assistant é…ç½®**: ç¢ºèªé€šç”¨åŠ©ç†å·²å•Ÿç”¨ã€Œæ–‡ä»¶ç·¨è¼¯ã€åŠŸèƒ½
- [ ] **allowedTools å‚³é**: ç¢ºèª `ChatInput` æ­£ç¢ºç²å–ä¸¦å‚³é `allowedTools`
- [ ] **æ¶ˆæ¯è§£æ**: ç¢ºèª `Home.tsx` æ­£ç¢ºå¾æ¶ˆæ¯ä¸­æå– `allowedTools`
- [ ] **æ§åˆ¶å°æ—¥èªŒ**: æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°ï¼Œç¢ºèª `allowedTools` åŒ…å« `document_editing`

### å¾Œç«¯æª¢æŸ¥

- [ ] **API æ¥æ”¶**: ç¢ºèªå¾Œç«¯æ¥æ”¶åˆ° `allowed_tools` åƒæ•¸
- [ ] **Router LLM åˆ¤æ–·**: æª¢æŸ¥æ—¥èªŒï¼Œç¢ºèª Router LLM åˆ¤æ–· `needs_tools=true`
- [ ] **Capability Matcher**: æª¢æŸ¥æ—¥èªŒï¼Œç¢ºèªåŒ¹é…åˆ° `document_editing` å·¥å…·
- [ ] **Decision Engine**: æª¢æŸ¥æ—¥èªŒï¼Œç¢ºèªé¸æ“‡äº† `document_editing` å·¥å…·
- [ ] **System Prompt å¢å¼·**: æª¢æŸ¥æ—¥èªŒï¼Œç¢ºèª System Prompt è¢«å¢å¼·
- [ ] **æ–‡ä»¶å‰µå»º**: æª¢æŸ¥æ—¥èªŒï¼Œç¢ºèªæ–‡ä»¶è¢«å‰µå»º

---

## ğŸ› èª¿è©¦æ­¥é©Ÿ

### Step 1: æª¢æŸ¥å‰ç«¯æ—¥èªŒ

æ‰“é–‹ç€è¦½å™¨é–‹ç™¼è€…å·¥å…·ï¼ˆF12ï¼‰ï¼ŒæŸ¥çœ‹ Console æ—¥èªŒï¼š

```javascript
// æ‡‰è©²çœ‹åˆ°ï¼š
[ChatInput] ğŸ“¤ Sending message with tools: {
  allowedTools: ["document_editing", ...],  // âœ… æ‡‰è©²åŒ…å« document_editing
  ...
}

[Home] Calling chatProductStream with tools: {
  allowedTools: ["document_editing", ...],  // âœ… æ‡‰è©²åŒ…å« document_editing
  ...
}
```

### Step 2: æª¢æŸ¥å¾Œç«¯æ—¥èªŒ

æŸ¥çœ‹å¾Œç«¯æ—¥èªŒï¼Œç¢ºèªä»¥ä¸‹é—œéµæ—¥èªŒï¼š

```bash
# 1. æ¥æ”¶ allowed_tools
grep "chat_request_tools_received" logs/app.log | tail -5

# 2. Router LLM åˆ¤æ–·
grep "Router LLM: Router decision" logs/app.log | tail -5

# 3. Capability Matcher åŒ¹é…
grep "Matched tools for router decision" logs/app.log | tail -5

# 4. Decision Engine é¸æ“‡
grep "Decision Engine: Selected tool" logs/app.log | tail -5

# 5. System Prompt å¢å¼·
grep "document_generation_intent_detected_via_task_analyzer" logs/app.log | tail -5

# 6. æ–‡ä»¶å‰µå»º
grep "file_created_from_stream\|try_create_file_start" logs/app.log | tail -5
```

---

## ğŸ“ æ¸¬è©¦ç”¨ä¾‹

### æ¸¬è©¦ç”¨ä¾‹ 1: ç°¡çŸ­æŒ‡ä»¤

**æŒ‡ä»¤**: "ç”Ÿæˆæ–‡ä»¶"

**é æœŸçµæœ**:

- Router LLM åˆ¤æ–·: `needs_tools=true`, `intent_type="execution"`
- Capability Matcher åŒ¹é…: `document_editing` å·¥å…·ï¼ˆè©•åˆ† 1.0ï¼‰
- Decision Engine é¸æ“‡: `chosen_tools=["document_editing"]`
- System Prompt å¢å¼·: åŒ…å«æ–‡æª”ç”ŸæˆæŒ‡ç¤º
- æ–‡ä»¶å‰µå»º: æˆåŠŸå‰µå»ºæ–‡ä»¶

---

### æ¸¬è©¦ç”¨ä¾‹ 2: æ˜ç¢ºä¸»é¡Œ

**æŒ‡ä»¤**: "å¹«æˆ‘ç”¢ç”ŸData Agentæ–‡ä»¶"

**é æœŸçµæœ**:

- Router LLM åˆ¤æ–·: `needs_tools=true`, `intent_type="execution"`
- Capability Matcher åŒ¹é…: `document_editing` å·¥å…·ï¼ˆè©•åˆ† 1.0ï¼‰
- Decision Engine é¸æ“‡: `chosen_tools=["document_editing"]`
- System Prompt å¢å¼·: åŒ…å«æ–‡æª”ç”ŸæˆæŒ‡ç¤ºï¼Œæ–‡ä»¶åç‚º "Data Agentæ–‡ä»¶.md"
- æ–‡ä»¶å‰µå»º: æˆåŠŸå‰µå»ºæ–‡ä»¶

---

### æ¸¬è©¦ç”¨ä¾‹ 3: æŒ‡å®šæ–‡ä»¶å

**æŒ‡ä»¤**: "ç”Ÿæˆ Data Agent.md æ–‡ä»¶"

**é æœŸçµæœ**:

- Router LLM åˆ¤æ–·: `needs_tools=true`, `intent_type="execution"`
- Capability Matcher åŒ¹é…: `document_editing` å·¥å…·ï¼ˆè©•åˆ† 1.0ï¼‰
- Decision Engine é¸æ“‡: `chosen_tools=["document_editing"]`
- System Prompt å¢å¼·: åŒ…å«æ–‡æª”ç”ŸæˆæŒ‡ç¤ºï¼Œæ–‡ä»¶åç‚º "Data Agent.md"
- æ–‡ä»¶å‰µå»º: æˆåŠŸå‰µå»ºæ–‡ä»¶

---

## ğŸ”§ å¾ŒçºŒå„ªåŒ–å»ºè­°

### 1. å¾Œç«¯æ ¹æ“š `assistant_id` æŸ¥è©¢é…ç½®

**å»ºè­°**: å¦‚æœå‰ç«¯æœªå‚³é `allowed_tools`ï¼Œå¾Œç«¯æ‡‰è©²æ ¹æ“š `assistant_id` æŸ¥è©¢ Assistant é…ç½®ï¼Œè‡ªå‹•ç²å– `allowedTools`ã€‚

**å¯¦ç¾ä½ç½®**: `api/routers/chat.py:1378`

**ä»£ç¢¼ç¤ºä¾‹**:

```python
# å¦‚æœæœªæä¾› allowed_toolsï¼Œæ ¹æ“š assistant_id æŸ¥è©¢
if not allowed_tools and request_body.assistant_id:
    assistant_service = get_assistant_service()
    assistant = assistant_service.get(request_body.assistant_id)
    if assistant and assistant.allowed_tools:
        allowed_tools = assistant.allowed_tools
```

---

### 2. å¢å¼· Router LLM çš„æ„åœ–è­˜åˆ¥

**å»ºè­°**: åœ¨ Router LLM çš„ User Prompt ä¸­æ·»åŠ æ›´å¤šä¸Šä¸‹æ–‡ï¼Œå¹«åŠ©è­˜åˆ¥æ–‡ä»¶ç”Ÿæˆæ„åœ–ã€‚

**å¯¦ç¾ä½ç½®**: `agents/task_analyzer/router_llm.py:136-214`

**ä»£ç¢¼ç¤ºä¾‹**:

```python
# åœ¨ User Prompt ä¸­æ·»åŠ  Assistant é…ç½®ä¿¡æ¯
if router_input.session_context.get("assistant_allowed_tools"):
    prompt += f"\n\nAssistant Available Tools: {router_input.session_context['assistant_allowed_tools']}"
    prompt += "\nIf the user wants to create/generate a file and document_editing is available, set needs_tools=true."
```

---

### 3. æ·»åŠ èª¿è©¦æ—¥èªŒ

**å»ºè­°**: åœ¨é—œéµç¯€é»æ·»åŠ è©³ç´°çš„èª¿è©¦æ—¥èªŒï¼Œæ–¹ä¾¿æ’æŸ¥å•é¡Œã€‚

**å¯¦ç¾ä½ç½®**:

- `ChatInput.tsx`: è¨˜éŒ„ `allowedTools` çš„ç²å–éç¨‹
- `Home.tsx`: è¨˜éŒ„ `allowedTools` çš„æå–å’Œå‚³ééç¨‹
- `chat.py`: è¨˜éŒ„ `allowed_tools` çš„æ¥æ”¶å’Œä½¿ç”¨éç¨‹

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [æ–‡ä»¶ç·¨è¼¯å•é¡Œè¨ºæ–·æŒ‡å—](./æ–‡ä»¶ç·¨è¼¯å•é¡Œè¨ºæ–·æŒ‡å—.md)
- [æ–‡ä»¶ç·¨è¼¯åŠŸèƒ½ä½¿ç”¨æŒ‡å—](./æ–‡ä»¶ç·¨è¼¯åŠŸèƒ½ä½¿ç”¨æŒ‡å—.md)
- [GenAI å·¥ä½œæµæŒ‡ä»¤-èªç¾©-å·¥å…·-æ¨¡å‹-Agent ç­‰èª¿ç”¨](../GenAI%20å·¥ä½œæµæŒ‡ä»¤-èªç¾©-å·¥å…·-æ¨¡å‹-Agent%20ç­‰èª¿ç”¨.md)

---

**æœ€å¾Œæ›´æ–°æ—¥æœŸ**: 2026-01-06
**æ–‡æª”ç‰ˆæœ¬**: 1.0
**ç¶­è­·äºº**: Daniel Chung
