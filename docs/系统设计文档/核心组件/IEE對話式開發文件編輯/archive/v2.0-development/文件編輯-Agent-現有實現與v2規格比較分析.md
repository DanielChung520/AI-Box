# 文件編輯 Agent 現有實現與 v2.0 規格比較分析

**創建日期**: 2026-01-11
**創建人**: Daniel Chung
**最後修改日期**: 2026-01-11

---

## 📋 執行摘要

本文檔對比分析現有文件編輯 Agent 實現（`agents/builtin/document_editing/agent.py`）與 v2.0 規格書（`文件編輯-Agent（Markdown）工程系統規格書-v2.md`）的差異，評估實現新規格的可行性。

**結論**：

- ✅ **架構方向一致**：現有實現與 v2.0 規格在整體架構上方向一致（都是基於 Patch 的編輯模式）
- ⚠️ **實現層級差異巨大**：現有實現為 MVP 級別，v2.0 規格為企業級完整實現
- ✅ **可實現性高**：v2.0 規格的所有要求都可以在現有基礎上逐步實現
- 📊 **差異程度**：約 **70-80%** 的功能需要新增或重構

---

## 1. 當前實現概述

### 1.1 實現位置

- **Agent 實現**: `agents/builtin/document_editing/agent.py`
- **服務實現**: `agents/core/execution/document_editing_service.py`
- **Agent ID**: `document-editing-agent`
- **版本**: v1.0（MVP 級別）

### 1.2 核心功能

現有實現提供以下功能：

1. **自然語言指令處理**
   - 接收自然語言編輯指令（`command`）
   - 通過 LLM 生成編輯 patches

2. **Search-and-Replace 協議**
   - 使用 `search_block` / `replace_block` 格式
   - 支持多個 patches 並列

3. **文件讀取**
   - 通過 `FileMetadataService` 獲取文件元數據
   - 通過 `Storage` 讀取文件內容

4. **基本錯誤處理**
   - 參數驗證（`command`、`doc_id`）
   - 文件讀取錯誤處理
   - 異常捕獲與日誌記錄

### 1.3 調用流程

根據 `Agent-Platform-v3.md`，文件編輯任務的調用流程：

```
用戶指令（自然語言）
    ↓
Task Analyzer（任務分析）
    ├── Router LLM（語義意圖分析）
    ├── 強制修正邏輯（文件編輯關鍵詞匹配）
    └── Capability Matcher（能力匹配）
        └── 優先匹配 document-editing-agent
    ↓
Agent Orchestrator（任務分發）
    ↓
DocumentEditingAgent.execute()
    ↓
DocumentEditingService.generate_editing_patches()
    ↓
返回 Search-and-Replace patches
```

---

## 2. 詳細差異分析

### 2.1 輸入接口差異

| 項目 | 現有實現 | v2.0 規格 | 差異程度 |
|------|---------|----------|---------|
| **輸入格式** | 自然語言指令（`command`） | 結構化 Intent DSL（JSON Schema） | 🔴 重大差異 |
| **Document Context** | 簡單參數（`doc_id`、`format`） | 完整 DocumentContext 對象（包含 `version_id`、`editability_state`、`permission_scope` 等） | 🔴 重大差異 |
| **Target Selector** | 無（依賴游標位置或全文搜索） | 結構化 Target Selector DSL（heading/anchor/block） | 🔴 重大差異 |
| **Constraints** | 無 | 可機器驗證的 Constraints（`max_tokens`、`style_guide`、`semantic_drift` 等） | 🔴 重大差異 |

**影響**：

- 現有實現無法支持精確的目標定位（只能依賴游標位置或全文搜索）
- 現有實現無法支持可機器驗證的約束條件
- 需要重構輸入接口以支持 Intent DSL

### 2.2 核心處理邏輯差異

| 項目 | 現有實現 | v2.0 規格 | 差異程度 |
|------|---------|----------|---------|
| **Markdown 解析** | 無（直接處理文本） | CommonMark + GFM AST 解析 | 🔴 重大差異 |
| **目標定位** | 游標位置或全文搜索 | Target Selector DSL（heading/anchor/block 唯一定位） | 🔴 重大差異 |
| **上下文策略** | 大文件時使用上下文窗口（2000 字符） | 最小上下文策略（目標 block + 祖先 heading + 相鄰 block） | 🟡 中等差異 |
| **LLM 配置** | 無固定配置 | 固定配置（temperature=0、固定模型版本、種子） | 🟡 中等差異 |
| **內容生成** | 直接調用 LLM | LLM 生成 + 輸出校驗（結構、長度、樣式、語義漂移、外部參照） | 🔴 重大差異 |

**影響**：

- 現有實現無法保證可重現性（沒有固定 LLM 配置）
- 現有實現無法進行結構化編輯（沒有 AST 解析）
- 現有實現無法進行約束驗證（沒有輸出校驗流程）

### 2.3 輸出格式差異

| 項目 | 現有實現 | v2.0 規格 | 差異程度 |
|------|---------|----------|---------|
| **Patch 格式** | Search-and-Replace（`search_block` / `replace_block`） | Block Patch（結構化）+ Text Patch（unified diff） | 🔴 重大差異 |
| **Patch 類型** | 單一格式 | 三層 Patch（Semantic Patch / Block Patch / Text Patch） | 🔴 重大差異 |
| **Operation 類型** | 僅支持 replace | 支持 insert/update/delete/move/replace | 🔴 重大差異 |
| **審計信息** | 基本日誌 | 完整的審計事件模型（9 個事件類型） | 🔴 重大差異 |

**影響**：

- 現有實現的 Patch 格式無法支持結構化編輯（如 move、insert）
- 現有實現無法提供完整的審計追蹤
- 需要重構輸出格式以支持 Block Patch

### 2.4 驗證與約束差異

| 項目 | 現有實現 | v2.0 規格 | 差異程度 |
|------|---------|----------|---------|
| **結構驗證** | 無 | Markdown 結構檢查（標題階層、禁止空標題、禁止重複 id） | 🔴 重大差異 |
| **樣式檢查** | 無 | Style Guide 規則集（語氣、術語表、格式） | 🔴 重大差異 |
| **長度檢查** | 無 | `max_tokens` / `max_chars` 量化檢查 | 🔴 重大差異 |
| **語義漂移檢查** | 無 | Semantic Drift 指標化檢查（NER 變更率、關鍵詞交集比例） | 🔴 重大差異 |
| **外部參照檢查** | 無 | `no_external_reference` 檢查（禁止外部 URL、禁止未在上下文中的事實） | 🔴 重大差異 |

**影響**：

- 現有實現無法保證生成內容的質量（沒有驗證機制）
- 現有實現無法防止語義漂移或外部參照
- 需要新增完整的驗證與 Linter 模組

### 2.5 錯誤處理差異

| 項目 | 現有實現 | v2.0 規格 | 差異程度 |
|------|---------|----------|---------|
| **錯誤碼** | 簡單字符串錯誤訊息 | 14 個結構化錯誤碼（`TARGET_NOT_FOUND`、`CONSTRAINT_VIOLATION` 等） | 🔴 重大差異 |
| **錯誤格式** | 簡單錯誤訊息 | 結構化錯誤回傳格式（`code`、`message`、`details`、`suggestions`） | 🔴 重大差異 |
| **修正建議** | 無 | 提供修正建議（`suggestions` 陣列） | 🔴 重大差異 |

**影響**：

- 現有實現的錯誤處理不夠結構化，無法提供機器可讀的錯誤碼
- 現有實現無法提供修正建議
- 需要重構錯誤處理機制

### 2.6 觀測性與審計差異

| 項目 | 現有實現 | v2.0 規格 | 差異程度 |
|------|---------|----------|---------|
| **事件追蹤** | 基本日誌 | 9 個審計事件類型（`intent_received`、`target_located`、`content_generated` 等） | 🔴 重大差異 |
| **審計存儲** | 無 | 不可變存儲（含雜湊、簽章） | 🔴 重大差異 |
| **性能指標** | 無 | SLA 指標（延遲、超時策略） | 🔴 重大差異 |
| **上下文摘要** | 無 | `context_digest`（SHA-256）用於可重現性驗證 | 🔴 重大差異 |

**影響**：

- 現有實現無法提供完整的審計追蹤
- 現有實現無法驗證可重現性（沒有 `context_digest`）
- 需要新增觀測性與審計模組

### 2.7 安全治理差異

| 項目 | 現有實現 | v2.0 規格 | 差異程度 |
|------|---------|----------|---------|
| **權限檢查** | 無 | 權限模型與檢查（`permission_scope` 驗證） | 🔴 重大差異 |
| **資料洩漏防範** | 無 | Prompt 注入防範、敏感資訊檢測（PII、保密資訊） | 🔴 重大差異 |
| **版本檢查** | 無 | 版本不匹配檢查（`VERSION_MISMATCH` 錯誤） | 🔴 重大差異 |
| **併發編輯** | 無 | 樂觀鎖策略、版本檢查 | 🔴 重大差異 |

**影響**：

- 現有實現無法進行權限檢查
- 現有實現無法防範資料洩漏
- 現有實現無法處理併發編輯衝突
- 需要新增安全治理模組

---

## 3. 功能覆蓋度分析

### 3.1 v2.0 規格功能清單

根據 v2.0 規格書，文件編輯 Agent 需要實現以下功能：

#### P0（必要功能）

1. ✅ **Markdown 標準與 AST 解析** - ❌ 未實現
2. ✅ **Target Selector 可唯一定位** - ❌ 未實現
3. ✅ **Intent DSL JSON Schema** - ❌ 未實現
4. ✅ **Block Patch schema** - ❌ 未實現
5. ✅ **LLM 可重現配置** - ❌ 未實現
6. ✅ **基本驗證規則** - ❌ 未實現

#### P1（提高品質）

1. ✅ **Semantic Drift 檢查** - ❌ 未實現
2. ✅ **Style Guide 規則集** - ❌ 未實現
3. ✅ **觀測性與審計** - ❌ 未實現
4. ✅ **併發編輯鎖** - ❌ 未實現

#### P2（進階能力）

1. ✅ **Semantic Patch** - ❌ 未實現
2. ✅ **Refactor 機器驗證** - ❌ 未實現
3. ✅ **GraphRAG 授權** - ❌ 未實現

### 3.2 現有實現功能清單

現有實現提供以下功能：

1. ✅ **自然語言指令處理** - ✅ 已實現
2. ✅ **Search-and-Replace Patch** - ✅ 已實現
3. ✅ **文件讀取** - ✅ 已實現
4. ✅ **基本錯誤處理** - ✅ 已實現
5. ✅ **大文件優化** - ✅ 已實現（上下文窗口）

### 3.3 功能覆蓋度統計

| 類別 | 總功能數 | 已實現 | 未實現 | 覆蓋度 |
|------|---------|--------|--------|--------|
| **P0（必要）** | 6 | 0 | 6 | 0% |
| **P1（品質）** | 4 | 0 | 4 | 0% |
| **P2（進階）** | 3 | 0 | 3 | 0% |
| **基礎功能** | 5 | 5 | 0 | 100% |
| **總計** | 18 | 5 | 13 | **27.8%** |

**結論**：

- 現有實現僅覆蓋了 **27.8%** 的 v2.0 規格功能
- 所有 P0 必要功能都未實現
- 需要大量開發工作才能達到 v2.0 規格要求

---

## 4. 實現可行性評估

### 4.1 技術可行性

**✅ 高度可行**：

1. **架構方向一致**
   - 現有實現已經採用 Patch 模式，與 v2.0 規格的設計理念一致
   - 現有實現已經有 Agent 框架基礎，可以在此基礎上擴展

2. **技術棧相容**
   - v2.0 規格要求的功能都可以使用現有技術棧實現
   - Markdown 解析可以使用現有庫（`markdown-it`、`remark` 等）
   - LLM 調用已經有基礎設施

3. **模組化設計**
   - v2.0 規格採用模組化設計，可以逐步實現
   - 現有實現可以作為基礎，逐步擴展

### 4.2 實現難度

**難度分級**：

| 功能模組 | 實現難度 | 預估工作量 | 依賴關係 |
|---------|---------|-----------|---------|
| **Intent DSL 解析** | 🟡 中等 | 2-3 週 | 無 |
| **Markdown AST 解析** | 🟡 中等 | 1-2 週 | 無 |
| **Target Selector** | 🔴 困難 | 2-3 週 | 依賴 AST 解析 |
| **Block Patch 生成** | 🔴 困難 | 2-3 週 | 依賴 AST 解析、Target Selector |
| **LLM 可重現配置** | 🟢 簡單 | 1 週 | 無 |
| **驗證與 Linter** | 🟡 中等 | 2-3 週 | 依賴 AST 解析 |
| **錯誤處理機制** | 🟢 簡單 | 1 週 | 無 |
| **觀測性與審計** | 🟡 中等 | 2-3 週 | 無 |
| **安全治理** | 🟡 中等 | 2-3 週 | 依賴權限系統 |

**總預估工作量**：**15-22 週**（約 4-6 個月）

### 4.3 實現策略建議

#### 階段一：基礎設施（4-6 週）

1. **Intent DSL 解析器**
   - 實現 JSON Schema 驗證
   - 實現 Intent Type 與 Action Mode 相容性檢查
   - 實現 Constraints 解析

2. **Markdown AST 解析器**
   - 集成 CommonMark + GFM 解析器
   - 實現 Block ID 生成算法
   - 實現 AST → Markdown 可逆轉換

3. **LLM 可重現配置**
   - 固定模型版本、temperature=0
   - 實現最小上下文策略
   - 實現 `context_digest` 計算

#### 階段二：核心功能（6-8 週）

1. **Target Selector**
   - 實現 heading selector（text + level + occurrence + path）
   - 實現 anchor selector（HTML id + 註解標記）
   - 實現 block selector（block_id）

2. **Block Patch 生成**
   - 實現 Block Patch operation schema
   - 實現 Block Patch → Text Patch 轉換
   - 實現 Patch 驗證機制

3. **驗證與 Linter**
   - 實現結構檢查（標題階層、禁止空標題）
   - 實現長度檢查（max_tokens / max_chars）
   - 實現外部參照檢查

#### 階段三：品質提升（4-6 週）

1. **觀測性與審計**
   - 實現 9 個審計事件類型
   - 實現審計存儲（不可變、含雜湊）
   - 實現性能指標監控

2. **錯誤處理機制**
   - 實現 14 個錯誤碼
   - 實現結構化錯誤回傳格式
   - 實現修正建議機制

3. **安全治理**
   - 實現權限檢查
   - 實現資料洩漏防範
   - 實現版本檢查

#### 階段四：進階功能（2-4 週）

1. **Semantic Patch**
   - 實現語義變更追蹤
   - 實現語義漂移檢查

2. **併發編輯支持**
   - 實現樂觀鎖策略
   - 實現版本檢查

---

## 5. 遷移路徑建議

### 5.1 向後相容策略

**建議**：保持向後相容，逐步遷移

1. **雙模式支持**
   - 保留現有的自然語言指令模式（作為 fallback）
   - 新增 Intent DSL 模式（作為主要模式）
   - 通過參數切換模式

2. **輸出格式兼容**
   - 保留 Search-and-Replace 格式輸出（作為兼容模式）
   - 新增 Block Patch 格式輸出（作為主要模式）
   - 提供格式轉換工具

### 5.2 漸進式遷移

**階段 1**：並行運行（2-3 個月）

- 新功能使用 v2.0 規格實現
- 舊功能保持現有實現
- 通過配置切換

**階段 2**：逐步遷移（2-3 個月）

- 將舊功能遷移到 v2.0 規格
- 保持 API 向後相容
- 提供遷移工具

**階段 3**：完全遷移（1 個月）

- 移除舊實現
- 統一使用 v2.0 規格
- 更新文檔

---

## 6. 風險評估

### 6.1 技術風險

| 風險 | 影響 | 可能性 | 緩解措施 |
|------|------|--------|---------|
| **Markdown 解析器兼容性** | 高 | 中 | 選擇成熟的解析器（`remark`、`markdown-it`），進行充分測試 |
| **Target Selector 唯一性** | 高 | 中 | 實現多種定位策略（heading + level + occurrence + path），提供候選列表 |
| **LLM 可重現性** | 中 | 低 | 固定所有參數（temperature=0、種子），使用固定模型版本 |
| **性能問題** | 中 | 中 | 實現最小上下文策略，優化 AST 解析性能 |

### 6.2 業務風險

| 風險 | 影響 | 可能性 | 緩解措施 |
|------|------|--------|---------|
| **遷移成本** | 高 | 高 | 採用漸進式遷移，保持向後相容 |
| **用戶適應** | 中 | 中 | 提供清晰的文檔和遷移指南 |
| **功能缺失** | 中 | 低 | 按照 MVP 路線逐步實現，優先實現 P0 功能 |

---

## 7. 結論與建議

### 7.1 結論

1. **差異程度**：現有實現與 v2.0 規格的差異約 **70-80%**，需要大量開發工作

2. **可實現性**：✅ **高度可行**
   - 架構方向一致
   - 技術棧相容
   - 可以逐步實現

3. **實現時間**：預估 **4-6 個月**（15-22 週）

4. **優先級**：建議按照 MVP 路線，優先實現 P0 功能

### 7.2 建議

1. **立即行動**：
   - 開始實現 Intent DSL 解析器
   - 開始實現 Markdown AST 解析器
   - 開始實現 LLM 可重現配置

2. **短期目標**（1-2 個月）：
   - 完成基礎設施（Intent DSL、AST 解析、可重現配置）
   - 完成核心功能（Target Selector、Block Patch）

3. **中期目標**（3-4 個月）：
   - 完成驗證與 Linter
   - 完成觀測性與審計
   - 完成錯誤處理機制

4. **長期目標**（5-6 個月）：
   - 完成安全治理
   - 完成進階功能（Semantic Patch、併發編輯）
   - 完成遷移與文檔更新

### 7.3 下一步行動

1. **技術選型**：
   - 選擇 Markdown 解析器（推薦：`remark` 或 `markdown-it`）
   - 選擇 JSON Schema 驗證庫（推薦：`jsonschema`）
   - 選擇 LLM 客戶端（已有基礎設施）

2. **架構設計**：
   - 設計模組化架構（Intent Validator、Markdown Parser、Target Locator 等）
   - 設計 API 接口（保持向後相容）
   - 設計數據模型（Intent DSL、Block Patch 等）

3. **開發計劃**：
   - 制定詳細的開發計劃（按階段劃分）
   - 分配開發資源
   - 設定里程碑與驗收標準

---

**文件版本**: v1.0
**最後更新日期**: 2026-01-11
**維護人**: Daniel Chung
