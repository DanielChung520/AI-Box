# æ–‡ä»¶ç·¨è¼¯å•é¡Œè¨ºæ–·æŒ‡å—

**ç‰ˆæœ¬**: 1.0
**å‰µå»ºæ—¥æœŸ**: 2026-01-06
**å‰µå»ºäºº**: Daniel Chung
**æœ€å¾Œä¿®æ”¹æ—¥æœŸ**: 2026-01-06

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æª”æä¾›æ–‡ä»¶ç·¨è¼¯åŠŸèƒ½æœªè§¸ç™¼æ™‚çš„è¨ºæ–·æ­¥é©Ÿå’Œè§£æ±ºæ–¹æ¡ˆã€‚

---

## ğŸ” å•é¡Œè¨ºæ–·æµç¨‹

### Step 1: æª¢æŸ¥ Assistant é…ç½®

**å•é¡Œ**: Assistant æ˜¯å¦å•Ÿç”¨äº† `document_editing` å·¥å…·ï¼Ÿ

**æª¢æŸ¥æ­¥é©Ÿ**:

1. æ‰“é–‹ Assistant ç¶­è­·ç•Œé¢
2. æª¢æŸ¥ã€Œæ–‡ä»¶ç·¨è¼¯ã€é–‹é—œæ˜¯å¦å•Ÿç”¨
3. æª¢æŸ¥ `allowedTools` æ˜¯å¦åŒ…å« `document_editing`

**å‰ç«¯æª¢æŸ¥** (`ChatInput.tsx:418-448`):

```typescript
const canEditFiles = useMemo(() => {
  // æª¢æŸ¥ Assistant çš„ allowedTools æ˜¯å¦åŒ…å« document_editing
  const toolNamesToCheck = ['document_editing', 'file_editing', 'documentEditing', 'fileEditing'];
  return allAllowedTools.some(toolName => toolNamesToCheck.includes(toolName));
}, [selectedAssistantId, safeAssistants]);
```

**å¾Œç«¯æª¢æŸ¥** (`chat.py:1378-1389`):

```python
allowed_tools = request_body.allowed_tools or []
# å¦‚æœ Assistant æ”¯æŒæ–‡ä»¶ç·¨è¼¯ï¼Œæ‡‰è©²åŒ…å« "document_editing"
if "document_editing" in allowed_tools or "file_editing" in allowed_tools:
    # è‡ªå‹•æ·»åŠ  datetime å·¥å…·
    if "datetime" not in allowed_tools:
        allowed_tools.append("datetime")
```

**è§£æ±ºæ–¹æ¡ˆ**:

- âœ… å¦‚æœæœªå•Ÿç”¨ï¼Œè«‹åœ¨ Assistant ç¶­è­·ç•Œé¢å•Ÿç”¨ã€Œæ–‡ä»¶ç·¨è¼¯ã€åŠŸèƒ½
- âœ… ç¢ºèª `allowedTools` åŒ…å« `document_editing`

---

### Step 2: æª¢æŸ¥ Router LLM åˆ¤æ–·

**å•é¡Œ**: Router LLM æ˜¯å¦æ­£ç¢ºè­˜åˆ¥æ–‡ä»¶ç”Ÿæˆæ„åœ–ï¼Ÿ

**æª¢æŸ¥æ—¥èªŒ**:
æŸ¥æ‰¾ä»¥ä¸‹æ—¥èªŒé—œéµå­—ï¼š

- `Router LLM: Router decision`
- `intent_type`
- `needs_tools`
- `confidence`

**é æœŸçµæœ**:

```python
RouterDecision(
    intent_type="execution",  # âœ… æ‡‰è©²æ˜¯ "execution"ï¼ˆåŸ·è¡Œæ“ä½œï¼‰
    complexity="mid",
    needs_agent=False,
    needs_tools=True,  # âœ… å¿…é ˆæ˜¯ True
    determinism_required=False,
    risk_level="low",
    confidence=0.85  # âœ… æ‡‰è©² >= 0.6
)
```

**Router LLM System Prompt** (`router_llm.py:35`):

```
5. Document creation or editing (creating files, generating documents, editing files)
```

**ç¤ºä¾‹æŒ‡ä»¤**:

- âœ… "å¹«æˆ‘ç”¢ç”ŸData Agentæ–‡ä»¶" â†’ `needs_tools=true`, `intent_type="execution"`
- âœ… "ç”Ÿæˆä¸€ä»½å ±å‘Š" â†’ `needs_tools=true`, `intent_type="execution"`
- âœ… "ç·¨è¼¯README.mdæ–‡ä»¶" â†’ `needs_tools=true`, `intent_type="execution"`
- âŒ "ä»€éº¼æ˜¯DevSecOps" â†’ `needs_tools=false`ï¼ˆçŸ¥è­˜å•é¡Œï¼‰

**å¦‚æœ Router LLM åˆ¤æ–·éŒ¯èª¤**:

- æª¢æŸ¥ç”¨æˆ¶æŒ‡ä»¤æ˜¯å¦æ˜ç¢ºè¡¨é”æ–‡ä»¶ç”Ÿæˆæ„åœ–
- ä½¿ç”¨æ›´æ˜ç¢ºçš„æŒ‡ä»¤ï¼Œå¦‚ã€Œå¹«æˆ‘ç”¢ç”ŸXXXæ–‡ä»¶ã€ã€ã€Œç”ŸæˆXXXæ–‡ä»¶ã€
- æª¢æŸ¥ Router LLM çš„ confidence æ˜¯å¦ >= 0.6ï¼ˆä½æ–¼æ­¤å€¼æœƒä½¿ç”¨ Safe Fallbackï¼‰

---

### Step 3: æª¢æŸ¥ Capability Matcher åŒ¹é…

**å•é¡Œ**: Capability Matcher æ˜¯å¦åŒ¹é…åˆ° `document_editing` å·¥å…·ï¼Ÿ

**æª¢æŸ¥æ—¥èªŒ**:
æŸ¥æ‰¾ä»¥ä¸‹æ—¥èªŒé—œéµå­—ï¼š

- `Matched tools for router decision`
- `document_editing_tool_selected_by_task_analyzer`
- `has_file_editing_enabled`

**åŒ¹é…é‚è¼¯** (`capability_matcher.py:338-351`):

```python
if tool_name in ["document_editing", "file_editing"] and has_file_editing_enabled:
    if router_decision.needs_tools:
        if router_decision.intent_type == "execution":
            name_category_match = 1.0  # âœ… å®Œç¾åŒ¹é…
        elif router_decision.intent_type in ["retrieval", "analysis"]:
            name_category_match = 0.95
        else:
            name_category_match = 0.9
```

**æ¢ä»¶æª¢æŸ¥**:

1. âœ… `has_file_editing_enabled=True`ï¼ˆAssistant å•Ÿç”¨äº†æ–‡ä»¶ç·¨è¼¯ï¼‰
2. âœ… `router_decision.needs_tools=True`ï¼ˆRouter LLM åˆ¤æ–·éœ€è¦å·¥å…·ï¼‰
3. âœ… `router_decision.intent_type="execution"`ï¼ˆåŸ·è¡Œæ“ä½œï¼‰

**å¦‚æœæœªåŒ¹é…**:

- æª¢æŸ¥ `allowed_tools` æ˜¯å¦æ­£ç¢ºå‚³éçµ¦ Task Analyzer (`chat.py:989`)
- æª¢æŸ¥ `has_file_editing_enabled` æ˜¯å¦ç‚º `True`
- æª¢æŸ¥ Router LLM çš„ `intent_type` æ˜¯å¦ç‚º `"execution"`

---

### Step 4: æª¢æŸ¥ Decision Engine é¸æ“‡

**å•é¡Œ**: Decision Engine æ˜¯å¦é¸æ“‡äº† `document_editing` å·¥å…·ï¼Ÿ

**æª¢æŸ¥æ—¥èªŒ**:
æŸ¥æ‰¾ä»¥ä¸‹æ—¥èªŒé—œéµå­—ï¼š

- `Decision Engine: Selected tool`
- `chosen_tools`
- `total_score`

**é¸æ“‡é‚è¼¯** (`decision_engine.py:269-292`):

```python
if tool.total_score >= 0.5:  # âœ… æœ€ä½å¯æ¥å—è©•åˆ†
    chosen_tools.append(tool.candidate_id)
```

**é æœŸçµæœ**:

```python
DecisionResult(
    chosen_tools=["document_editing"],  # âœ… æ‡‰è©²åŒ…å« document_editing
    chosen_agent=None,
    chosen_model="...",
    score=0.95,  # âœ… æ‡‰è©² >= 0.5
    reasoning="é¸æ“‡ Tool: document_editing (è©•åˆ†: 0.95)"
)
```

**å¦‚æœæœªé¸æ“‡**:

- æª¢æŸ¥å·¥å…·çš„ `total_score` æ˜¯å¦ >= 0.5
- æª¢æŸ¥æ˜¯å¦æœ‰å…¶ä»–å·¥å…·è©•åˆ†æ›´é«˜ï¼ˆæœ€å¤šé¸æ“‡ 3 å€‹å·¥å…·ï¼‰

---

### Step 5: æª¢æŸ¥ System Prompt å¢å¼·

**å•é¡Œ**: System Prompt æ˜¯å¦è¢«æ­£ç¢ºå¢å¼·ï¼Ÿ

**æª¢æŸ¥æ—¥èªŒ**:
æŸ¥æ‰¾ä»¥ä¸‹æ—¥èªŒé—œéµå­—ï¼š

- `document_generation_intent_detected_via_task_analyzer`
- `filename`
- `doc_format`

**å¢å¼·é‚è¼¯** (`chat.py:1967-2014`):

```python
if (
    decision_result
    and decision_result.chosen_tools
    and ("document_editing" in decision_result.chosen_tools)
):
    # å¢å¼· System Prompt
    document_generation_instruction = (
        f"\n\nã€é‡è¦ï¼šç”¨æˆ¶è¦æ±‚ç”Ÿæˆæ–‡æª”ã€‘\n"
        f"ç”¨æˆ¶æŒ‡ä»¤ï¼š{last_user_text}\n"
        f"ç›®æ¨™æ–‡ä»¶åï¼š{filename}\n"
        f"æ–‡æª”æ ¼å¼ï¼š{doc_format}\n\n"
        f"è«‹æ ¹æ“šç”¨æˆ¶æŒ‡ä»¤ç”Ÿæˆå®Œæ•´çš„æ–‡æª”å…§å®¹ï¼ˆMarkdown æ ¼å¼ï¼‰ã€‚\n"
        f"- ä¸è¦è¼¸å‡ºè§£é‡‹æ–‡å­—ï¼Œåªè¼¸å‡ºæ–‡æª”å…§å®¹\n"
        ...
    )
```

**å¦‚æœæœªå¢å¼·**:

- æª¢æŸ¥ `decision_result.chosen_tools` æ˜¯å¦åŒ…å« `document_editing`
- æª¢æŸ¥æ—¥èªŒä¸­æ˜¯å¦æœ‰ `document_generation_intent_detected_via_task_analyzer`

---

### Step 6: æª¢æŸ¥æ–‡ä»¶å‰µå»ºé‚è¼¯

**å•é¡Œ**: æ–‡ä»¶æ˜¯å¦è¢«æ­£ç¢ºå‰µå»ºï¼Ÿ

**æª¢æŸ¥æ—¥èªŒ**:
æŸ¥æ‰¾ä»¥ä¸‹æ—¥èªŒé—œéµå­—ï¼š

- `document_editing_tool_detected_for_file_creation`
- `file_created_from_stream`
- `try_create_file_start`

**å‰µå»ºé‚è¼¯** (`chat.py:2209-2286`):

```python
if (
    decision_result
    and decision_result.chosen_tools
    and ("document_editing" in decision_result.chosen_tools)
):
    # å˜—è©¦å‰µå»ºæ–‡ä»¶
    create_action = _try_create_file_from_chat_output(
        user_text=last_user_text,
        assistant_text=full_content,
        task_id=task_id,
        current_user=current_user,
        force_create=True,  # âœ… å¼·åˆ¶å‰µå»ºï¼Œä¸ä¾è³´é—œéµè©åŒ¹é…
    )
```

**å¦‚æœæœªå‰µå»º**:

- æª¢æŸ¥ `task_id` æ˜¯å¦ç‚º `None`ï¼ˆå¿…é ˆæœ‰ task_idï¼‰
- æª¢æŸ¥æ–‡ä»¶æ“´å±•åæ˜¯å¦ç‚º `.md`, `.txt`, `.json`
- æª¢æŸ¥æ¬Šé™æ˜¯å¦è¶³å¤ ï¼ˆéœ€è¦ `FILE_UPDATE` æ¬Šé™ï¼‰
- æª¢æŸ¥ `assistant_text`ï¼ˆAI å›å¾©ï¼‰æ˜¯å¦ç‚ºç©º

---

## ğŸ› å¸¸è¦‹å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ

### å•é¡Œ 1: Router LLM åˆ¤æ–· `needs_tools=false`

**åŸå› **:

- ç”¨æˆ¶æŒ‡ä»¤ä¸å¤ æ˜ç¢ºï¼ˆå¦‚ã€Œå¹«æˆ‘æ•´ç†ä¸€ä¸‹ã€ï¼‰
- Router LLM çš„ confidence å¤ªä½ï¼ˆ< 0.6ï¼‰

**è§£æ±ºæ–¹æ¡ˆ**:

- âœ… ä½¿ç”¨æ›´æ˜ç¢ºçš„æŒ‡ä»¤ï¼Œå¦‚ã€Œå¹«æˆ‘ç”¢ç”ŸData Agentæ–‡ä»¶ã€
- âœ… æ˜ç¢ºæŒ‡å®šæ–‡ä»¶åï¼Œå¦‚ã€Œç”Ÿæˆ Data Agent.md æ–‡ä»¶ã€
- âœ… æª¢æŸ¥ Router LLM çš„ confidence æ˜¯å¦ >= 0.6

---

### å•é¡Œ 2: Assistant æœªå•Ÿç”¨ `document_editing` å·¥å…·

**åŸå› **:

- Assistant é…ç½®ä¸­æœªå•Ÿç”¨ã€Œæ–‡ä»¶ç·¨è¼¯ã€åŠŸèƒ½
- `allowedTools` ä¸­ä¸åŒ…å« `document_editing`

**è§£æ±ºæ–¹æ¡ˆ**:

- âœ… åœ¨ Assistant ç¶­è­·ç•Œé¢å•Ÿç”¨ã€Œæ–‡ä»¶ç·¨è¼¯ã€åŠŸèƒ½
- âœ… ç¢ºèª `allowedTools` åŒ…å« `document_editing`
- âœ… æª¢æŸ¥å‰ç«¯æ˜¯å¦æ­£ç¢ºå‚³é `allowed_tools` çµ¦å¾Œç«¯

---

### å•é¡Œ 3: Capability Matcher æœªåŒ¹é…åˆ° `document_editing` å·¥å…·

**åŸå› **:

- `has_file_editing_enabled=False`ï¼ˆAssistant æœªå•Ÿç”¨æ–‡ä»¶ç·¨è¼¯ï¼‰
- `router_decision.needs_tools=False`ï¼ˆRouter LLM åˆ¤æ–·ä¸éœ€è¦å·¥å…·ï¼‰
- `router_decision.intent_type` ä¸æ˜¯ `"execution"`

**è§£æ±ºæ–¹æ¡ˆ**:

- âœ… ç¢ºèª Assistant å•Ÿç”¨äº†æ–‡ä»¶ç·¨è¼¯åŠŸèƒ½
- âœ… ç¢ºèª Router LLM åˆ¤æ–· `needs_tools=True`
- âœ… ç¢ºèª Router LLM åˆ¤æ–· `intent_type="execution"`

---

### å•é¡Œ 4: Decision Engine æœªé¸æ“‡ `document_editing` å·¥å…·

**åŸå› **:

- å·¥å…·çš„ `total_score` < 0.5ï¼ˆä½æ–¼æœ€ä½å¯æ¥å—è©•åˆ†ï¼‰
- æœ‰å…¶ä»–å·¥å…·è©•åˆ†æ›´é«˜ï¼ˆæœ€å¤šé¸æ“‡ 3 å€‹å·¥å…·ï¼‰

**è§£æ±ºæ–¹æ¡ˆ**:

- âœ… æª¢æŸ¥å·¥å…·çš„è©•åˆ†è¨ˆç®—é‚è¼¯
- âœ… ç¢ºèª `document_editing` å·¥å…·çš„è©•åˆ† >= 0.5
- âœ… æª¢æŸ¥æ˜¯å¦æœ‰å…¶ä»–å·¥å…·å„ªå…ˆç´šæ›´é«˜

---

### å•é¡Œ 5: æ–‡ä»¶å‰µå»ºå¤±æ•—

**åŸå› **:

- `task_id` ç‚º `None`ï¼ˆå¿…é ˆæœ‰ task_idï¼‰
- æ–‡ä»¶æ“´å±•åä¸æ˜¯ `.md`, `.txt`, `.json`
- æ¬Šé™ä¸è¶³ï¼ˆéœ€è¦ `FILE_UPDATE` æ¬Šé™ï¼‰
- `assistant_text`ï¼ˆAI å›å¾©ï¼‰ç‚ºç©º

**è§£æ±ºæ–¹æ¡ˆ**:

- âœ… ç¢ºèªå·²é¸æ“‡ä»»å‹™ï¼ˆtask_id ä¸ç‚º Noneï¼‰
- âœ… ç¢ºèªæ–‡ä»¶åæ“´å±•åç‚º `.md`, `.txt`, `.json`
- âœ… æª¢æŸ¥ç”¨æˆ¶æ¬Šé™æ˜¯å¦è¶³å¤ 
- âœ… ç¢ºèª AI å›å¾©ä¸ç‚ºç©º

---

## ğŸ“Š è¨ºæ–·æª¢æŸ¥æ¸…å–®

åœ¨è¨ºæ–·æ–‡ä»¶ç·¨è¼¯å•é¡Œæ™‚ï¼Œè«‹æŒ‰é †åºæª¢æŸ¥ä»¥ä¸‹é …ç›®ï¼š

- [ ] **Step 1**: Assistant æ˜¯å¦å•Ÿç”¨äº† `document_editing` å·¥å…·ï¼Ÿ
- [ ] **Step 2**: Router LLM æ˜¯å¦æ­£ç¢ºè­˜åˆ¥æ–‡ä»¶ç”Ÿæˆæ„åœ–ï¼Ÿï¼ˆ`needs_tools=true`, `intent_type="execution"`ï¼‰
- [ ] **Step 3**: Capability Matcher æ˜¯å¦åŒ¹é…åˆ° `document_editing` å·¥å…·ï¼Ÿï¼ˆ`has_file_editing_enabled=True`ï¼‰
- [ ] **Step 4**: Decision Engine æ˜¯å¦é¸æ“‡äº† `document_editing` å·¥å…·ï¼Ÿï¼ˆ`total_score >= 0.5`ï¼‰
- [ ] **Step 5**: System Prompt æ˜¯å¦è¢«æ­£ç¢ºå¢å¼·ï¼Ÿï¼ˆ`document_generation_intent_detected_via_task_analyzer`ï¼‰
- [ ] **Step 6**: æ–‡ä»¶æ˜¯å¦è¢«æ­£ç¢ºå‰µå»ºï¼Ÿï¼ˆ`file_created_from_stream`ï¼‰

---

## ğŸ”§ èª¿è©¦å‘½ä»¤

### æŸ¥çœ‹å¾Œç«¯æ—¥èªŒ

```bash
# æŸ¥çœ‹ Router LLM åˆ¤æ–·æ—¥èªŒ
grep "Router LLM: Router decision" logs/app.log

# æŸ¥çœ‹ Capability Matcher åŒ¹é…æ—¥èªŒ
grep "Matched tools for router decision" logs/app.log

# æŸ¥çœ‹ Decision Engine é¸æ“‡æ—¥èªŒ
grep "Decision Engine: Selected tool" logs/app.log

# æŸ¥çœ‹æ–‡ä»¶å‰µå»ºæ—¥èªŒ
grep "file_created_from_stream\|try_create_file_start" logs/app.log
```

### æŸ¥çœ‹å‰ç«¯æ—¥èªŒ

æ‰“é–‹ç€è¦½å™¨é–‹ç™¼è€…å·¥å…·ï¼ˆF12ï¼‰ï¼ŒæŸ¥çœ‹ Console æ—¥èªŒï¼š

- `[ChatInput]` - Assistant é…ç½®æª¢æŸ¥
- `[ChatArea]` - æ–‡ä»¶é¸æ“‡å’Œç·¨è¼¯ Session

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [æ–‡ä»¶ç·¨è¼¯åŠŸèƒ½ä½¿ç”¨æŒ‡å—](./æ–‡ä»¶ç·¨è¼¯åŠŸèƒ½ä½¿ç”¨æŒ‡å—.md)
- [æ–‡ä»¶ç·¨è¼¯ Agent é–‹ç™¼è¦åŠƒæ›¸](./æ–‡ä»¶ç·¨è¼¯Agenté–‹ç™¼è¦åŠƒæ›¸.md)
- [GenAI å·¥ä½œæµæŒ‡ä»¤-èªç¾©-å·¥å…·-æ¨¡å‹-Agent ç­‰èª¿ç”¨](../GenAI%20å·¥ä½œæµæŒ‡ä»¤-èªç¾©-å·¥å…·-æ¨¡å‹-Agent%20ç­‰èª¿ç”¨.md)

---

**æœ€å¾Œæ›´æ–°æ—¥æœŸ**: 2026-01-06
**æ–‡æª”ç‰ˆæœ¬**: 1.0
**ç¶­è­·äºº**: Daniel Chung
