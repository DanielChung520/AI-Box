# æ—¥å¿—å­˜å‚¨æ ¼å¼è¯´æ˜

**åˆ›å»ºæ—¥æœŸ**: 2025-12-29
**åˆ›å»ºäºº**: Daniel Chung
**æœ€åä¿®æ”¹æ—¥æœŸ**: 2025-12-29
**å…³è”æ–‡æ¡£**: [å­˜å‚¨æ¶æ„](./å­˜å‚¨æ¶æ„.md)ã€[SeaweedFS ä½¿ç”¨æŒ‡å—](./SeaweedFSä½¿ç”¨æŒ‡å—.md)

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜ AI-Box ç³»ç»Ÿä¸­æ—¥å¿—æ•°æ®çš„å­˜å‚¨æ ¼å¼ï¼ŒåŒ…æ‹¬ JSON Lines æ ¼å¼è§„èŒƒã€æ–‡ä»¶è·¯å¾„ç»„ç»‡æ–¹å¼å’Œå„ç±»å‹æ—¥å¿—çš„æ ¼å¼ç¤ºä¾‹ã€‚

---

## ğŸ“„ JSON Lines æ ¼å¼è¯´æ˜

### æ ¼å¼è§„èŒƒ

æ‰€æœ‰æ—¥å¿—æ•°æ®ä½¿ç”¨ **JSON Lines (JSONL)** æ ¼å¼å­˜å‚¨ï¼Œæ¯è¡Œä¸€ä¸ª JSON å¯¹è±¡ï¼Œä¾¿äºè¿½åŠ å†™å…¥å’Œæµå¼è¯»å–ã€‚

**æ ¼å¼ç‰¹ç‚¹**ï¼š

- âœ… **è¿½åŠ å†™å…¥**ï¼šé€‚åˆ Append-Only æ¨¡å¼
- âœ… **æµå¼è¯»å–**ï¼šå¯ä»¥é€è¡Œè¯»å–ï¼Œæ— éœ€åŠ è½½æ•´ä¸ªæ–‡ä»¶
- âœ… **æ˜“äºè§£æ**ï¼šæ¯è¡Œæ˜¯ç‹¬ç«‹çš„ JSON å¯¹è±¡
- âœ… **å‹ç¼©å‹å¥½**ï¼šå¯ä»¥è½»æ¾å‹ç¼©å­˜å‚¨

### æ–‡ä»¶æ‰©å±•å

- æ—¥å¿—æ–‡ä»¶ï¼š`.jsonl`
- ç‰ˆæœ¬å†å²ï¼š`.json`
- å˜æ›´ææ¡ˆï¼š`.json`

---

## ğŸ“ æ–‡ä»¶è·¯å¾„è§„èŒƒ

### æŒ‰æ—¶é—´åˆ†ç‰‡å­˜å‚¨

æ—¥å¿—æ–‡ä»¶æŒ‰æ—¶é—´åˆ†ç‰‡å­˜å‚¨ï¼Œä¾¿äºå¿«é€Ÿå®šä½å’ŒæŸ¥è¯¢ï¼š

**è·¯å¾„æ ¼å¼**ï¼š`{log_type}/{YYYY}/{MM}/{DD}.jsonl`

**ç¤ºä¾‹**ï¼š

- å®¡è®¡æ—¥å¿—ï¼š`audit/2025/12/29.jsonl`
- ç³»ç»Ÿæ—¥å¿—ï¼ˆä»»åŠ¡ç±»å‹ï¼‰ï¼š`system/task/2025/12/29.jsonl`
- ç³»ç»Ÿæ—¥å¿—ï¼ˆå®¡è®¡ç±»å‹ï¼‰ï¼š`system/audit/2025/12/29.jsonl`
- ç³»ç»Ÿæ—¥å¿—ï¼ˆå®‰å…¨ç±»å‹ï¼‰ï¼š`system/security/2025/12/29.jsonl`

### ç‰ˆæœ¬å†å²è·¯å¾„

ç‰ˆæœ¬å†å²æ–‡ä»¶æŒ‰èµ„æºç±»å‹å’Œèµ„æº ID ç»„ç»‡ï¼š

**è·¯å¾„æ ¼å¼**ï¼š`versions/{resource_type}/{resource_id}/v{version}.json`

**ç¤ºä¾‹**ï¼š

- Ontology ç‰ˆæœ¬ï¼š`versions/ontologies/ontology-123/v1.json`
- Config ç‰ˆæœ¬ï¼š`versions/configs/tenant-456/v2.json`

### å˜æ›´ææ¡ˆè·¯å¾„

å˜æ›´ææ¡ˆæ–‡ä»¶æŒ‰ææ¡ˆç±»å‹å’Œèµ„æº ID ç»„ç»‡ï¼š

**è·¯å¾„æ ¼å¼**ï¼š`proposals/{proposal_type}/{resource_id}/{proposal_id}.json`

**ç¤ºä¾‹**ï¼š

- Config å˜æ›´ææ¡ˆï¼š`proposals/config/tenant-456/proposal-789.json`
- Ontology å˜æ›´ææ¡ˆï¼š`proposals/ontology/ontology-123/proposal-101.json`

---

## ğŸ“ æ—¥å¿—æ ¼å¼ç¤ºä¾‹

### å®¡è®¡æ—¥å¿—æ ¼å¼

**æ–‡ä»¶è·¯å¾„**ï¼š`audit/{YYYY}/{MM}/{DD}.jsonl`

**JSON æ ¼å¼**ï¼š

```json
{
  "id": "audit-log-uuid",
  "user_id": "user-123",
  "action": "CREATE",
  "resource_type": "ontology",
  "resource_id": "ontology-456",
  "timestamp": "2025-12-29T10:30:00Z",
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0...",
  "details": {
    "ontology_name": "Enterprise Ontology",
    "version": "1.0.0"
  }
}
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `id` | string | æ—¥å¿—å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆUUIDï¼‰ |
| `user_id` | string | ç”¨æˆ· ID |
| `action` | string | æ“ä½œç±»å‹ï¼ˆCREATE, UPDATE, DELETE, READ ç­‰ï¼‰ |
| `resource_type` | string | èµ„æºç±»å‹ï¼ˆontology, config, file ç­‰ï¼‰ |
| `resource_id` | string | èµ„æº IDï¼ˆå¯é€‰ï¼‰ |
| `timestamp` | string | æ“ä½œæ—¶é—´ï¼ˆISO 8601 æ ¼å¼ï¼‰ |
| `ip_address` | string | IP åœ°å€ |
| `user_agent` | string | User Agent |
| `details` | object | é¢å¤–è¯¦æƒ…ï¼ˆJSON å¯¹è±¡ï¼‰ |

### ç³»ç»Ÿæ—¥å¿—æ ¼å¼

**æ–‡ä»¶è·¯å¾„**ï¼š`system/{log_type}/{YYYY}/{MM}/{DD}.jsonl`

**æ—¥å¿—ç±»å‹**ï¼š

- `task`ï¼šä»»åŠ¡æ—¥å¿—
- `audit`ï¼šå®¡è®¡æ—¥å¿—
- `security`ï¼šå®‰å…¨æ—¥å¿—

**JSON æ ¼å¼**ï¼š

```json
{
  "id": "system-log-uuid",
  "log_type": "task",
  "level": "INFO",
  "timestamp": "2025-12-29T10:30:00Z",
  "message": "Task started",
  "task_id": "task-123",
  "user_id": "user-456",
  "details": {
    "agent": "SystemConfigAgent",
    "status": "running"
  }
}
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `id` | string | æ—¥å¿—å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆUUIDï¼‰ |
| `log_type` | string | æ—¥å¿—ç±»å‹ï¼ˆtask, audit, securityï¼‰ |
| `level` | string | æ—¥å¿—çº§åˆ«ï¼ˆDEBUG, INFO, WARNING, ERROR, CRITICALï¼‰ |
| `timestamp` | string | æ—¥å¿—æ—¶é—´ï¼ˆISO 8601 æ ¼å¼ï¼‰ |
| `message` | string | æ—¥å¿—æ¶ˆæ¯ |
| `task_id` | string | ä»»åŠ¡ IDï¼ˆå¯é€‰ï¼‰ |
| `user_id` | string | ç”¨æˆ· IDï¼ˆå¯é€‰ï¼‰ |
| `details` | object | é¢å¤–è¯¦æƒ…ï¼ˆJSON å¯¹è±¡ï¼‰ |

---

## ğŸ“‹ ç‰ˆæœ¬å†å²æ ¼å¼

**æ–‡ä»¶è·¯å¾„**ï¼š`versions/{resource_type}/{resource_id}/v{version}.json`

**JSON æ ¼å¼**ï¼š

```json
{
  "resource_type": "ontology",
  "resource_id": "ontology-123",
  "version": 1,
  "change_type": "CREATE",
  "changed_by": "user-456",
  "change_summary": "Initial version of Enterprise Ontology",
  "previous_version": null,
  "current_version": {
    "name": "Enterprise Ontology",
    "version": "1.0.0",
    "entity_classes": [...],
    "object_properties": [...]
  },
  "created_at": "2025-12-29T10:30:00Z"
}
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `resource_type` | string | èµ„æºç±»å‹ï¼ˆontology, config ç­‰ï¼‰ |
| `resource_id` | string | èµ„æº ID |
| `version` | integer | ç‰ˆæœ¬å·ï¼ˆä» 1 å¼€å§‹é€’å¢ï¼‰ |
| `change_type` | string | å˜æ›´ç±»å‹ï¼ˆCREATE, UPDATE, DELETEï¼‰ |
| `changed_by` | string | å˜æ›´äººï¼ˆç”¨æˆ· IDï¼‰ |
| `change_summary` | string | å˜æ›´æ‘˜è¦ |
| `previous_version` | object | å‰ä¸€ç‰ˆæœ¬æ•°æ®ï¼ˆCREATE æ—¶ä¸º nullï¼‰ |
| `current_version` | object | å½“å‰ç‰ˆæœ¬æ•°æ® |
| `created_at` | string | åˆ›å»ºæ—¶é—´ï¼ˆISO 8601 æ ¼å¼ï¼‰ |

---

## ğŸ“ å˜æ›´ææ¡ˆæ ¼å¼

**æ–‡ä»¶è·¯å¾„**ï¼š`proposals/{proposal_type}/{resource_id}/{proposal_id}.json`

**JSON æ ¼å¼**ï¼š

```json
{
  "proposal_id": "proposal-789",
  "proposal_type": "config",
  "resource_id": "tenant-456",
  "proposed_by": "user-123",
  "status": "PENDING",
  "proposal_data": {
    "scope": "genai.policy",
    "config_data": {
      "allowed_providers": ["openai", "anthropic"],
      "allowed_models": {...}
    }
  },
  "approval_required": true,
  "created_at": "2025-12-29T10:30:00Z",
  "updated_at": "2025-12-29T10:30:00Z",
  "approved_by": null,
  "approved_at": null,
  "rejected_by": null,
  "rejected_at": null,
  "rejection_reason": null
}
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `proposal_id` | string | ææ¡ˆå”¯ä¸€æ ‡è¯†ç¬¦ |
| `proposal_type` | string | ææ¡ˆç±»å‹ï¼ˆconfig, ontology ç­‰ï¼‰ |
| `resource_id` | string | èµ„æº IDï¼ˆå¯é€‰ï¼Œå…¨å±€ææ¡ˆä¸º nullï¼‰ |
| `proposed_by` | string | ææ¡ˆäººï¼ˆç”¨æˆ· IDï¼‰ |
| `status` | string | ææ¡ˆçŠ¶æ€ï¼ˆPENDING, APPROVED, REJECTEDï¼‰ |
| `proposal_data` | object | ææ¡ˆæ•°æ®ï¼ˆJSON å¯¹è±¡ï¼‰ |
| `approval_required` | boolean | æ˜¯å¦éœ€è¦å®¡æ‰¹ |
| `created_at` | string | åˆ›å»ºæ—¶é—´ï¼ˆISO 8601 æ ¼å¼ï¼‰ |
| `updated_at` | string | æ›´æ–°æ—¶é—´ï¼ˆISO 8601 æ ¼å¼ï¼‰ |
| `approved_by` | string | å®¡æ‰¹äººï¼ˆç”¨æˆ· IDï¼Œå¯é€‰ï¼‰ |
| `approved_at` | string | å®¡æ‰¹æ—¶é—´ï¼ˆISO 8601 æ ¼å¼ï¼Œå¯é€‰ï¼‰ |
| `rejected_by` | string | æ‹’ç»äººï¼ˆç”¨æˆ· IDï¼Œå¯é€‰ï¼‰ |
| `rejected_at` | string | æ‹’ç»æ—¶é—´ï¼ˆISO 8601 æ ¼å¼ï¼Œå¯é€‰ï¼‰ |
| `rejection_reason` | string | æ‹’ç»åŸå› ï¼ˆå¯é€‰ï¼‰ |

---

## ğŸ” æŸ¥è¯¢ç¤ºä¾‹

### æŸ¥è¯¢å®¡è®¡æ—¥å¿—

```python
from services.api.services.governance.seaweedfs_log_service import SeaweedFSAuditLogService

# æŸ¥è¯¢æŒ‡å®šæ—¶é—´èŒƒå›´çš„å®¡è®¡æ—¥å¿—
logs = await audit_log_service.get_audit_logs(
    user_id="user-123",
    action="CREATE",
    start_time=datetime(2025, 12, 1),
    end_time=datetime(2025, 12, 31),
    limit=100
)
```

### æŸ¥è¯¢ç‰ˆæœ¬å†å²

```python
from services.api.services.governance.version_history_service import SeaweedFSVersionHistoryService

# æŸ¥è¯¢èµ„æºçš„ç‰ˆæœ¬å†å²
versions = await version_history_service.get_version_history(
    resource_type="ontology",
    resource_id="ontology-123",
    limit=50
)
```

### æŸ¥è¯¢å˜æ›´ææ¡ˆ

```python
from services.api.services.governance.change_proposal_service import SeaweedFSChangeProposalService

# æŸ¥è¯¢ç‰¹å®šææ¡ˆ
proposal = await proposal_service.get_proposal("proposal-789")
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å­˜å‚¨æ¶æ„](./å­˜å‚¨æ¶æ„.md) - å­˜å‚¨æ¶æ„è¯¦ç»†è¯´æ˜
- [SeaweedFS ä½¿ç”¨æŒ‡å—](./SeaweedFSä½¿ç”¨æŒ‡å—.md) - SeaweedFS ä½¿ç”¨æŒ‡å—
- [èµ„æ–™æ¶æ„å»ºè®®æŠ¥å‘Š](../è³‡æ–™æ¶æ„å»ºè®®æŠ¥å‘Š.md) - æ¶æ„æ¼”è¿›å»ºè®®

---

**æœ€åæ›´æ–°æ—¥æœŸ**: 2025-12-29
