# HybridRAG 查詢測試說明

**創建日期**: 2026-01-05
**創建人**: Daniel Chung
**最後修改日期**: 2026-01-05

---

## 📋 測試狀態

### ✅ 權重配置功能（可以測試）

**查詢**: "請說明中国预制菜产业市场规模与增长趋势"

**權重配置分析**:
- **查詢類型**: `semantic_query`（語義查詢）
- **向量權重**: 0.7 (70%)
- **圖權重**: 0.3 (30%)

**說明**:
1. 查詢中包含"說明"關鍵詞，屬於語義查詢類型
2. 系統會使用語義查詢的權重配置：向量 70%，圖 30%
3. 這意味著系統會優先使用向量檢索（語義相似性匹配）
4. 圖檢索作為補充（提供結構化關係信息）

**測試方法**:
```python
from genai.workflows.rag.hybrid_rag_config import HybridRAGConfigService

config_service = HybridRAGConfigService()
query = "請說明中国预制菜产业市场规模与增长趋势"
weights = config_service.get_weights(query=query)

print(f"查詢: {query}")
print(f"權重: 向量 {weights['vector_weight']:.1f}, 圖 {weights['graph_weight']:.1f}")
# 輸出: 權重: 向量 0.7, 圖 0.3
```

---

### ⚠️ 完整 HybridRAG 檢索（需要運行環境）

要測試完整的 HybridRAG 檢索功能，需要：

1. **ArangoDB 服務運行**
2. **ChromaDB 服務運行**
3. **已上傳文檔**（如"东方伊厨-预制菜发展策略报告20250902.pdf"）
4. **已構建向量索引**（ChromaDB）
5. **已構建知識圖譜**（ArangoDB）
6. **AAMManager 實例**（需要正確配置）

---

## 🔍 查詢分析

### 查詢文本

**原始查詢**: "請說明中国预制菜产业^场规模与增⻓趋势"

**清理後的查詢**: "請說明中国预制菜产业市场规模与增长趋势"

**關鍵詞提取**:
- "說明" → 語義查詢關鍵詞
- "中国" → 實體（國家）
- "预制菜" → 實體（產業/產品）
- "产业" → 實體（行業）
- "市场" → 實體（領域）
- "规模" → 屬性
- "增长趋势" → 屬性

### 查詢類型檢測

1. **結構化查詢檢測**: 無匹配（關鍵詞：框架、步驟、流程、階段、順序、架構、設計）
2. **實體查詢檢測**: 無匹配（關鍵詞：是什麼、關係、連接、包含、屬於）
3. **語義查詢檢測**: ✅ 匹配（關鍵詞：說明）
4. **最終類型**: `semantic_query`（語義查詢）

### 權重配置

根據查詢類型 `semantic_query`，使用權重配置：
- **向量權重**: 0.7 (70%)
- **圖權重**: 0.3 (30%)

---

## 🎯 預期檢索行為

### 1. 向量檢索（70% 權重）

**預期行為**:
- 在 ChromaDB 中搜索與"中國預製菜產業市場規模與增長趨勢"語義相似的文檔片段
- 優先返回與市場規模、增長趨勢相關的內容
- 可能找到的內容：
  - "中國預製菜產業市場規模達到 XXX 億元"
  - "預製菜產業呈現快速增長趨勢"
  - "市場規模年均增長率為 XX%"

### 2. 圖檢索（30% 權重）

**預期行為**:
- 使用 NER 提取實體：["中国", "预制菜", "产业", "市场", "规模", "增长趋势"]
- 在 ArangoDB 知識圖譜中查找相關實體和關係
- 可能找到的關係：
  - "中国 - 包含 - 预制菜产业"
  - "预制菜产业 - 具有 - 市场规模"
  - "市场规模 - 呈现 - 增长趋势"

### 3. 結果融合

**預期行為**:
- 向量結果 × 0.7（70% 權重）
- 圖結果 × 0.3（30% 權重）
- 去重並按相關度排序
- 返回最終結果（主要來自向量檢索）

---

## ⚠️ 當前限制

### 1. 導入問題

`genai/workflows/rag/__init__.py` 中導入了不存在的模組 `genai.workflows.retrieval.manager`，需要修復。

**已修復**: ✅ 已更新 `__init__.py`，改為從 `genai.workflows.rag.manager` 導入

### 2. 數據庫連接

測試配置功能需要 ArangoDB 連接，如果數據庫未運行或認證失敗，無法測試。

**解決方案**:
- 確保 ArangoDB 服務運行
- 確保環境變數配置正確（`ARANGODB_USERNAME`, `ARANGODB_PASSWORD` 等）

### 3. 完整檢索測試

完整 HybridRAG 檢索需要：
- 已上傳的文檔
- 已構建的向量索引
- 已構建的知識圖譜
- 正確配置的服務實例

---

## 💡 測試建議

### 階段 1：配置功能測試（當前可做）

1. **確保 ArangoDB 連接正常**
2. **初始化配置**（如果未初始化）:
   ```python
   from genai.workflows.rag.hybrid_rag_config import HybridRAGConfigService
   config_service = HybridRAGConfigService()
   config_service.initialize_default_config(force=False, changed_by="system")
   ```

3. **測試權重配置**:
   ```python
   query = "請說明中国预制菜产业市场规模与增长趋势"
   weights = config_service.get_weights(query=query)
   print(f"權重: {weights}")
   ```

### 階段 2：完整檢索測試（需要環境）

1. **確保所有服務運行**
2. **確保文檔已上傳並處理**
3. **使用 HybridRAGService 進行完整檢索**

---

## 📊 總結

### ✅ 可以測試

1. **權重配置邏輯**（如果 ArangoDB 連接正常）
   - 查詢類型檢測
   - 權重配置讀取
   - 權重驗證

### ⚠️ 需要環境

1. **完整 HybridRAG 檢索**
   - 需要所有服務運行
   - 需要已上傳的文檔
   - 需要已構建的索引和圖譜

### 💡 當前狀態

對於查詢"請說明中国预制菜产业市场规模与增长趋势"：

- ✅ **權重配置**: 語義查詢，向量 70%，圖 30%
- ⚠️ **完整檢索**: 需要完整的運行環境

**建議**: 先測試配置功能，確保權重配置邏輯正確；然後再測試完整的檢索功能。

---

**最後更新日期**: 2026-01-05
**維護人**: Daniel Chung

