# 文件儲存與任務關聯說明

**最後修改日期**: 2026-01-06
**維護人**: AI Assistant

---

## 1. 核心儲存邏輯

在 AI-Box 系統中，所有上傳的文檔都會與特定的任務（Task）進行實體關聯。系統採用「任務隔離」的儲存策略，確保每個任務的文件都在其獨立的路徑下管理。

**重要說明**：系統採用**單一存儲後端機制**，根據配置選擇使用**其中一個**存儲後端，**不是同時備份到兩個地方**。

### 1.1 存儲後端選擇

系統支持兩種存儲後端，根據配置自動選擇：

#### 1.1.1 本地文件系統存儲 (`LocalFileStorage`)

**使用條件**：
- `storage_backend="local"` 或未配置且 S3 不可用
- 開發和測試環境

**儲存路徑規則**：
```bash
data/tasks/{task_id}/workspace/{file_id}.{extension}
```

**storage_path 格式**：
- 存儲在 `file_metadata.storage_path` 中
- 格式：`data/tasks/{task_id}/workspace/{file_id}.{ext}`

#### 1.1.2 SeaWeedFS/S3 存儲 (`S3FileStorage`)

**使用條件**：
- `storage_backend="s3"` 或生產環境且 S3 配置可用
- 生產環境，支持 Kubernetes 無狀態擴展

**儲存位置**：
- **Bucket**: `bucket-ai-box-assets`
- **Key**: `tasks/{task_id}/workspace/{file_id}.{ext}`
- **S3 URI格式**: `s3://bucket-ai-box-assets/tasks/{task_id}/workspace/{file_id}.{ext}`

**storage_path 格式**：
- 存儲在 `file_metadata.storage_path` 中
- 格式：`s3://bucket-ai-box-assets/tasks/{task_id}/workspace/{file_id}.{ext}`

### 1.2 配置優先級

存儲後端的選擇通過配置決定，優先級如下：

1. **明確指定**：如果明確指定 `storage_backend="local"` → 使用本地文件系統
2. **明確指定**：如果明確指定 `storage_backend="s3"` → 使用 SeaweedFS/S3
3. **環境自動選擇**：如果未指定，根據環境自動選擇：
   - 生產環境 (`ENV=production`) → 優先使用 SeaweedFS
   - 開發環境 → 如果 S3 配置可用，使用 SeaweedFS；否則使用本地文件系統

**實現位置**：
- `create_storage_from_config()` - `storage/file_storage.py:560`
- `get_storage()` - `api/routers/file_upload.py:135`

### 1.3 路徑參數說明

*   **task_id**: 任務的唯一識別碼（通常為時間戳或 UUID）。
*   **workspace**: 任務的工作區目錄，存放所有與該任務直接相關的原始文件及處理結果。
*   **file_id**: 文件在系統中的 UUID，確保文件名唯一性並與 `file_metadata` 集合關聯。

---

## 2. 任務文件生命週期

### 2.1 文件上傳
當用戶在前端上傳文檔時，系統會：
1.  獲取當前活躍的 `task_id`。
2.  在 `data/tasks/{task_id}/workspace/` 下創建對應目錄。
3.  將原始文件重新命名為 `{file_id}` 並保存。
4.  在 ArangoDB 的 `file_metadata` 集合中記錄文件的元數據（包括路徑、所屬用戶、所屬任務）。

### 2.2 任務清理
根據系統維護規範：
*   **孤兒資料夾**: 若磁盤上存在 `{task_id}` 資料夾，但 ArangoDB 中無對應任務記錄，該資料夾被視為「孤兒數據」，可安全刪除。
*   **歸檔任務**: 當任務被標記為 `archive` 時，其在磁盤上的實體文件夾應被同步清理以釋放空間。

---

## 3. 實地調查結果 (2026-01-06)

經檢查，系統目前的儲存狀況如下：

### 3.1 當前存儲後端配置

*   **實際使用的存儲類型**: `S3FileStorage`（SeaWeedFS）
*   **S3 Endpoint**: `http://localhost:8333`
*   **默認 Bucket**: `bucket-ai-box-assets`

### 3.2 歷史文件存儲狀況

*   **歷史文件**: 所有現有文件的 `storage_path` 均為本地路徑格式（`data/tasks/{task_id}/workspace/{file_id}.{ext}`）
*   **磁盤文件**: 確實在 `data/tasks/` 目錄下存在實體文件（例如任務 `1767610663899` 下存放了 `.pdf` 文件）
*   **說明**: 這些文件是在系統使用本地文件系統存儲時上傳的歷史數據

### 3.3 新文件存儲行為

*   **新上傳的文件**: 將根據當前配置保存到 SeaWeedFS（`s3://bucket-ai-box-assets/tasks/{task_id}/workspace/{file_id}.{ext}`）
*   **不會同時保存**: 系統採用單一存儲後端機制，新文件**只會**保存到 SeaWeedFS，**不會**同時保存到本地 `data/tasks/` 目錄

### 3.4 清理成效

*   **清理成果**: 已執行大規模維護，清理了 476 個孤兒資料夾及 193 個歸檔任務資料夾，確保磁盤數據與數據庫狀態高度一致
*   **注意**: 清理的是本地 `data/tasks/` 目錄下的歷史文件，SeaWeedFS 中的文件需要單獨清理（如果存在）

---

## 4. 常見問題

### Q1: 文件是否同時保存在本地和 SeaWeedFS？

**答**：**不是**。系統採用**單一存儲後端機制**，根據配置選擇使用其中一個：
- 如果配置為 `storage_backend="local"` → 文件只保存在本地 `data/tasks/` 目錄
- 如果配置為 `storage_backend="s3"` → 文件只保存在 SeaWeedFS

**不會同時保存到兩個地方**。

### Q2: 為什麼磁盤上還有文件？

**答**：磁盤上的文件是**歷史數據**，是在系統使用本地文件系統存儲時上傳的。當系統切換到 SeaWeedFS 後，新上傳的文件會保存到 SeaWeedFS，不會再寫入本地目錄。

### Q3: 如何遷移歷史文件到 SeaWeedFS？

**答**：如果需要將歷史文件遷移到 SeaWeedFS，需要：
1. 讀取本地文件
2. 使用 `S3FileStorage.save_file()` 上傳到 SeaWeedFS
3. 更新 `file_metadata.storage_path` 為新的 S3 URI
4. 可選：刪除本地文件以釋放空間

