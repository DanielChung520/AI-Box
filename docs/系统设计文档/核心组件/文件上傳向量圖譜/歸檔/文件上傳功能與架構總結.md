# 文件上傳功能與架構總結

**創建日期**: 2025-12-06
**最後更新日期**: 2025-12-09 12:29 (UTC+8)
**創建人**: Daniel Chung

## 目錄

1. [系統概述](#系統概述)
2. [架構設計](#架構設計)
3. [核心模組說明](#核心模組說明)
4. [存儲層架構](#存儲層架構)
5. [任務工作區系統](#任務工作區系統)
6. [認證與安全機制](#認證與安全機制)
7. [文件處理流程](#文件處理流程)
8. [系統優勢與特性](#系統優勢與特性)

---

## 系統概述

AI-Box 文件上傳系統是一個完整的企業級文件處理平台，採用前後端分離架構，提供安全、高效、可擴展的文件處理能力。

### 核心功能

- ✅ **任務驅動的文件組織**：所有文件關聯到任務工作區
- ✅ **自動任務創建**：首次上傳或聊天時自動創建任務
- ✅ **統一認證機制**：JWT 認證，無 dev_user fallback
- ✅ **文件存儲抽象**：支持本地存儲，預留雲存儲接口
- ✅ **動態文件樹**：後端動態構建，確保數據一致性
- ✅ **多格式支持**：PDF、Word、Excel、Markdown、CSV、TXT 等
- ✅ **異步處理**：文件掃描、向量化、知識圖譜提取

---

## 架構設計

### 整體架構

系統採用分層架構設計：

1. **前端層**：React 組件，處理用戶交互和 UI 展示
2. **API 路由層**：FastAPI 路由，處理 HTTP 請求和響應
3. **服務層**：業務邏輯處理，包括任務、文件、權限管理
4. **存儲抽象層**：文件存儲接口，支持多種存儲實現
5. **認證層**：JWT 認證和權限檢查
6. **數據存儲層**：ArangoDB 和文件系統

---

## 核心模組說明

### 1. Storage 模組

**位置**：`storage/file_storage.py`

**職責**：提供文件存儲的抽象接口和實現

**核心類**：

- `FileStorage`（抽象基類）：定義文件存儲標準接口
- `LocalFileStorage`：本地文件系統存儲實現
- `S3FileStorage`、`OSSFileStorage`：雲存儲接口（預留）

**設計模式**：

- **策略模式**：FileStorage 是抽象策略，LocalFileStorage 是具體策略
- **工廠模式**：`create_storage_from_config()` 根據配置創建存儲實例

### 2. TaskWorkspaceService

**位置**：`services/api/services/task_workspace_service.py`

**職責**：管理任務工作區的創建和管理

**核心功能**：

- 創建任務工作區（文件系統 + 數據庫記錄）
- 確保工作區存在
- 獲取工作區路徑
- 刪除工作區

### 3. UserTaskService

**位置**：`services/api/services/user_task_service.py`

**職責**：管理用戶任務的 CRUD 操作

**核心功能**：

- 創建任務（自動創建工作區）
- 獲取任務（動態構建 fileTree）
- 更新/刪除/列出任務

### 4. FileMetadataService

**位置**：`services/api/services/file_metadata_service.py`

**職責**：管理文件元數據的 CRUD 操作

**核心功能**：

- 創建/獲取/更新/刪除文件元數據
- 查詢文件（按用戶、任務）

### 5. 認證模組

**位置**：`system/security/`

**職責**：處理 JWT 認證和權限檢查

**核心組件**：

- `auth.py`：認證邏輯
- `dependencies.py`：FastAPI 依賴注入
- `jwt_service.py`：JWT token 生成和驗證

**關鍵修改（2025-12-09）**：

- 移除 `dev_user` fallback 邏輯
- `should_bypass_auth` 只在 `SECURITY_ENABLED=false` 時返回 true
- 正式環境下要求真實 JWT 認證

---

## 存儲層架構

### 文件存儲抽象層

```
FileStorage (抽象基類)
    │
    ├── LocalFileStorage (本地存儲)
    │   ├── 新結構：data/tasks/{task_id}/workspace/
    │   └── 舊結構：data/datasets/files/{file_id[:2]}/
    │
    ├── S3FileStorage (AWS S3，預留)
    └── OSSFileStorage (阿里雲 OSS，預留)
```

### 路徑配置

**配置文件**：`config/config.json`

```json
{
  "file_upload": {
    "storage_backend": "local",
    "storage_root": "./data",
    "tasks_path": "./data/tasks",
    "storage_path": "./data/datasets/files"
  }
}
```

### 文件查找邏輯

文件查找順序：

1. 優先使用 metadata 中記錄的實際路徑
2. 如果有 task_id，在任務工作區中查找
3. 最後在舊結構中查找（向後兼容）

---

## 任務工作區系統

### 工作區結構

```
data/tasks/
  ├── {task_id_1}/
  │   ├── workspace/          # 任務工作區
  │   │   ├── file1.pdf
  │   │   └── file2.docx
  │   └── scheduled/          # 排程任務（預留）
  │
  ├── {task_id_2}/
  │   ├── workspace/
  │   └── scheduled/
  └── ...
```

### 工作區創建流程

```
任務創建 → UserTaskService.create()
    │
    ├── 生成 task_id
    ├── 創建任務記錄（ArangoDB）
    └── 調用 TaskWorkspaceService.create_workspace()
            │
            ├── 創建文件系統目錄
            │   └── data/tasks/{task_id}/workspace/
            │
            └── 創建數據庫記錄
                └── folder_metadata 集合
```

---

## 認證與安全機制

### JWT 認證流程

```
前端登錄
    │
    ├── 獲取 JWT token
    ├── 存儲到 localStorage
    └── 每次請求攜帶：Authorization: Bearer {token}
            │
            ▼
後端驗證
    │
    ├── dependencies.py: get_current_user()
    ├── auth.py: authenticate_request()
    ├── jwt_service.py: verify_token()
    └── 解析用戶信息 → User 對象
            │
            ├── 成功 → 繼續處理請求
            └── 失敗 → 401 錯誤（不再 fallback 到 dev_user）
```

### 安全配置

`should_bypass_auth` 屬性修改：正式測試環境下，只有在 `SECURITY_ENABLED=false` 時才繞過認證，不再因 `SECURITY_MODE=development` 而繞過。

### 文件安全措施

1. **文件名清理**：移除路徑分隔符、危險字符
2. **文件類型驗證**：MIME 類型、文件簽名驗證
3. **文件大小限制**：防止過大文件（可配置）
4. **權限檢查**：`FilePermissionService` 檢查用戶權限
5. **路徑驗證**：防止路徑遍歷攻擊

---

## 文件處理流程

### 完整流程

```
用戶上傳文件
    │
    ├── 前端：ChatInput.tsx
    │   ├── 文件選擇/拖拽
    │   ├── 獲取當前 task_id（可能為 null）
    │   └── 構建 FormData
    │
    ▼
POST /api/files/upload
    │
    ├── JWT 認證驗證
    │   └── get_current_user() → User 對象
    │
    ├── 任務處理
    │   ├── IF task_id 提供：
    │   │   └── 驗證任務存在
    │   └── ELSE：
    │       └── 創建新任務 + 工作區
    │
    ├── 文件驗證
    │   └── FileValidator.validate_upload_file()
    │
    ├── 確保工作區存在
    │   └── TaskWorkspaceService.ensure_workspace_exists()
    │
    ├── 保存文件
    │   └── LocalFileStorage.save_file()
    │       └── 保存到：data/tasks/{task_id}/workspace/{file_id}.{ext}
    │
    ├── 創建元數據
    │   └── FileMetadataService.create()
    │       └── 記錄到：file_metadata 集合
    │
    ├── 異步處理（可選）
    │   ├── 文件掃描
    │   ├── 向量化處理
    │   └── 知識圖譜提取
    │
    └── 返回響應
        └── file_id, filename, file_path, task_id
```

---

## 系統優勢與特性

### 1. 架構優勢

- ✅ **分層清晰**：前端、API、服務、存儲、數據層分離
- ✅ **抽象化**：存儲層抽象，支持多種存儲後端
- ✅ **可擴展**：預留雲存儲接口（S3、OSS）
- ✅ **解耦**：各模組職責明確，互不依賴

### 2. 功能特性

- ✅ **任務驅動**：文件按任務組織，易於管理
- ✅ **自動創建**：任務和工作區自動創建
- ✅ **動態構建**：文件樹動態構建，數據一致
- ✅ **向後兼容**：支持舊文件結構

### 3. 安全特性

- ✅ **JWT 認證**：標準的 token 認證機制
- ✅ **無 fallback**：正式環境不允許未認證訪問
- ✅ **文件驗證**：多層次文件驗證
- ✅ **權限控制**：基於用戶和任務的權限檢查

### 4. 性能特性

- ✅ **單例模式**：服務實例重用
- ✅ **異步處理**：文件處理異步執行
- ✅ **進度追蹤**：Redis 存儲上傳進度

---

## 關鍵修改記錄

### 2025-12-09 更新

1. **移除 dev_user fallback 邏輯**
   - 正式環境下要求真實 JWT 認證
   - `should_bypass_auth` 只在 `SECURITY_ENABLED=false` 時返回 true

2. **統一存儲路徑配置**
   - `TaskWorkspaceService` 從配置文件讀取路徑
   - 支持通過配置自定義存儲路徑

3. **改進文件查找邏輯**
   - 優先使用 `metadata.storage_path`
   - 支持多種路徑查找方式

4. **動態文件樹構建**
   - 後端動態從數據庫構建 `fileTree`
   - 確保前端顯示與數據庫一致

---

## 相關文檔

- [文件上傳系統功能與流程](./文件上傳系統功能與流程.md)
- [任務工作區服務](../../../../../../services/api/services/task_workspace_service.py)
- [文件存儲抽象層](../../../../../../storage/file_storage.py)

---

**最後更新**: 2025-12-09 12:29 (UTC+8)
**維護者**: Daniel Chung
