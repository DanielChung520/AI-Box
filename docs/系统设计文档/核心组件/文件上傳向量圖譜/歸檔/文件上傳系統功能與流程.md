# 文件上傳系統功能與流程

**創建日期**: 2025-12-08
**最後更新日期**: 2025-12-09 12:29 (UTC+8)
**創建人**: Daniel Chung

## 目錄

1. [系統概述](#系統概述)
2. [核心組件架構](#核心組件架構)
3. [文件上傳流程](#文件上傳流程)
4. [任務工作區機制](#任務工作區機制)
5. [文件存儲路徑規範](#文件存儲路徑規範)
6. [認證與安全](#認證與安全)
7. [數據流圖](#數據流圖)
8. [關鍵修改記錄](#關鍵修改記錄)

---

## 系統概述

文件上傳系統是 AI-Box 的核心功能之一，負責處理用戶文件的上傳、存儲、管理和組織。系統採用任務工作區（Task Workspace）的概念，每個任務擁有獨立的文件存儲空間。

### 核心特性

- ✅ **任務驅動的文件組織**：所有文件必須關聯到任務工作區
- ✅ **自動任務創建**：首次上傳文件或首次聊天時自動創建任務
- ✅ **統一認證**：正式環境下要求真實 JWT 認證，無 dev_user fallback
- ✅ **路徑抽象**：統一的文件存儲抽象層，支持多種存儲後端
- ✅ **動態文件樹**：後端動態構建 fileTree，確保數據一致性

---

## 核心組件架構

### 1. 前端組件

\`\`\`
ai-bot/src/
  ├── pages/
  │   └── Home.tsx              # 主頁，包含文件上傳 UI
  ├── components/
  │   ├── ChatInput.tsx         # 聊天輸入框，支持文件拖拽上傳
  │   ├── FileTree.tsx          # 文件樹顯示組件
  │   └── Sidebar.tsx           # 側邊欄，顯示任務列表
  └── lib/
      ├── api.ts                # API 客戶端
      ├── taskStorage.ts        # 任務存儲管理
      └── jwtUtils.ts           # JWT 工具函數
\`\`\`

### 2. 後端組件

\`\`\`
api/routers/
  └── file_upload.py            # 文件上傳路由

services/api/services/
  ├── user_task_service.py      # 用戶任務服務
  ├── task_workspace_service.py # 任務工作區服務
  ├── file_metadata_service.py  # 文件元數據服務
  └── file_permission_service.py # 文件權限服務

storage/
  └── file_storage.py           # 文件存儲抽象層

system/security/
  ├── auth.py                   # 認證邏輯
  ├── dependencies.py           # 依賴注入（get_current_user）
  └── jwt_service.py            # JWT 服務
\`\`\`

### 3. 數據存儲

\`\`\`
ArangoDB 集合:
  ├── user_tasks               # 任務信息
  ├── file_metadata            # 文件元數據
  └── folder_metadata          # 文件夾元數據

文件系統:
  ├── data/tasks/              # 任務工作區（新結構）
  │   └── {task_id}/
  │       ├── workspace/       # 任務工作區文件
  │       └── scheduled/       # 排程任務（預留）
  └── data/datasets/files/     # 舊文件存儲（向後兼容）
      └── {file_id[:2]}/
          └── {file_id}.{ext}
\`\`\`

---

## 文件上傳流程

### 完整流程步驟

1. **前端準備**：選擇/拖拽文件，獲取當前 task_id（可能為 null），構建 FormData
2. **API 請求**：POST /api/files/upload，帶 JWT token
3. **JWT 認證**：驗證 token，解析用戶信息（無 dev_user fallback）
4. **任務處理**：檢查/創建任務
5. **文件驗證**：FileValidator 驗證文件
6. **工作區準備**：確保任務工作區存在
7. **文件保存**：LocalFileStorage 保存到文件系統
8. **元數據創建**：FileMetadataService 創建元數據記錄
9. **異步處理**：文件掃描、向量化、知識圖譜提取（可選）
10. **返回響應**：返回 file_id, filename, file_path, task_id

詳細流程圖和代碼示例請參考：[文件上傳功能與架構總結.md](./文件上傳功能與架構總結.md)

---

## 任務工作區機制

### 任務工作區結構

每個任務擁有兩個標準目錄：

\`\`\`
data/tasks/{task_id}/
  ├── workspace/        # 任務工作區（文件存放處）
  └── scheduled/        # 排程任務（預留，未來功能）
\`\`\`

### 工作區創建時機

1. **任務創建時**：\`UserTaskService.create()\` 自動調用 \`TaskWorkspaceService.create_workspace()\`
2. **文件上傳時**：如果工作區不存在，\`ensure_workspace_exists()\` 會自動創建

### 文件樹動態構建

後端在獲取任務時動態從 \`file_metadata\` 和 \`folder_metadata\` 構建 \`fileTree\`，確保前端顯示與數據庫一致。

---

## 文件存儲路徑規範

### 新結構（任務工作區）

\`\`\`
data/tasks/{task_id}/workspace/{file_id}.{ext}
\`\`\`

**特點**：

- 所有新文件都使用此結構
- 文件按任務組織，易於管理和清理
- 路徑從配置文件讀取：\`config.file_upload.tasks_path\`

### 舊結構（向後兼容）

\`\`\`
data/datasets/files/{file_id[:2]}/{file_id}.{ext}
\`\`\`

**特點**：

- 用於兼容舊文件
- 按文件 ID 前兩字符分組，避免單一目錄文件過多
- 路徑從配置文件讀取：\`config.file_upload.storage_path\`

### 文件查找邏輯

文件查找順序：

1. 優先使用 metadata 中記錄的實際路徑
2. 如果有 task_id，在任務工作區中查找
3. 最後在舊結構中查找（向後兼容）

---

## 認證與安全

### JWT 認證流程

\`\`\`

1. 前端登錄 → 獲取 JWT token
2. 前端存儲 token (localStorage)
3. 每次請求攜帶: Authorization: Bearer {token}
4. 後端驗證 token → 解析用戶信息
5. 認證失敗 → 返回 401 錯誤（不再 fallback 到 dev_user）
\`\`\`

### 安全配置

\`should_bypass_auth\` 屬性修改：正式測試環境下，只有在 \`SECURITY_ENABLED=false\` 時才繞過認證，不再因 \`SECURITY_MODE=development\` 而繞過。

### 文件安全措施

1. **文件名清理**：移除路徑分隔符和危險字符
2. **文件類型驗證**：限制允許的文件類型
3. **文件大小限制**：防止過大文件
4. **權限檢查**：\`FilePermissionService\` 檢查用戶權限

---

## 數據流圖

### 完整的數據流

\`\`\`
前端層 → API 路由層 → 服務層/存儲層/認證層 → 數據存儲層
\`\`\`

詳細架構圖請參考：[文件上傳功能與架構總結.md](./文件上傳功能與架構總結.md)

---

## 關鍵修改記錄

### 2025-12-09 更新

1. **移除 dev_user fallback 邏輯**
   - 正式環境下要求真實 JWT 認證
   - 認證失敗返回 401 錯誤，不再 fallback

2. **統一存儲路徑配置**
   - \`TaskWorkspaceService\` 從配置文件讀取路徑
   - 支持通過配置自定義存儲路徑

3. **改進文件查找邏輯**
   - 優先使用 \`metadata.storage_path\`
   - 支持多種路徑查找方式（新結構、舊結構）

4. **動態文件樹構建**
   - 後端動態從 \`file_metadata\` 和 \`folder_metadata\` 構建 \`fileTree\`
   - 確保前端顯示的文件樹與數據庫一致

---

## 相關文檔

- [文件上傳功能與架構總結](./文件上傳功能與架構總結.md)
- [任務工作區服務](../../../../../../services/api/services/task_workspace_service.py)
- [文件存儲抽象層](../../../../../../storage/file_storage.py)

---

**最後更新**: 2025-12-09 12:29 (UTC+8)
**維護者**: Daniel Chung
