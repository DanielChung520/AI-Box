# çŸ¥è­˜åº«æª¢ç´¢å•é¡Œè¨ºæ–·èˆ‡ä¿®å¾©æŒ‡å—

**å‰µå»ºæ—¥æœŸ**: 2026-01-28
**å‰µå»ºäºº**: Daniel Chung
**æœ€å¾Œä¿®æ”¹æ—¥æœŸ**: 2026-01-28

---

## ğŸ“‹ å•é¡Œæè¿°

ç”¨æˆ¶åæ˜ ï¼šå·²ç¶“å®Œæˆäº†æ–‡ä»¶å‘é‡åŒ–å’Œåœ–è­œæ§‹å»ºï¼Œä¹Ÿå¯¦ç¾äº†æ··åˆæŸ¥è©¢é‚è¼¯ï¼Œä½†åœ¨ AI å°è©±ä¸­è©¢å•æ˜¯å¦èƒ½æŸ¥åˆ°çŸ¥è­˜åº«æˆ–è‡ªå·±çš„æ–‡ä»¶æ™‚ï¼ŒAI å»å›ç­”çœ‹ä¸åˆ°ã€‚

---

## ğŸ” å•é¡Œè¨ºæ–·æµç¨‹

### æ­¥é©Ÿ 1: æª¢æŸ¥ HybridRAG æ˜¯å¦å•Ÿç”¨

**æª¢æŸ¥ä½ç½®**: `services/api/services/chat_memory_service.py`

**æª¢æŸ¥æ–¹æ³•**:

1. ç¢ºèª `ChatMemoryService` åˆå§‹åŒ–æ™‚ `use_hybrid_rag` åƒæ•¸ç‚º `True`ï¼ˆé»˜èªå€¼ï¼‰

```python
# æª¢æŸ¥ get_chat_memory_service() å‡½æ•¸
# ä½ç½®: services/api/services/chat_memory_service.py:541-545
def get_chat_memory_service() -> ChatMemoryService:
    global _chat_memory_service
    if _chat_memory_service is None:
        _chat_memory_service = ChatMemoryService()  # é»˜èª use_hybrid_rag=True
    return _chat_memory_service
```

**å¦‚æœç™¼ç¾å•é¡Œ**:
- ç¢ºèª `ChatMemoryService()` åˆå§‹åŒ–æ™‚æ²’æœ‰å‚³å…¥ `use_hybrid_rag=False`

---

### æ­¥é©Ÿ 2: æª¢æŸ¥ AAMManager æ˜¯å¦å¯ç”¨

**å•é¡ŒåŸå› **: `HybridRAGService` ä¾è³´æ–¼ `AAMManager`ï¼Œå¦‚æœ `AAMManager` åˆå§‹åŒ–å¤±æ•—ï¼Œ`HybridRAGService` å°±ä¸æœƒè¢«ä½¿ç”¨ã€‚

**æª¢æŸ¥ä½ç½®**: `services/api/services/chat_memory_service.py:62-105`

**æª¢æŸ¥æ–¹æ³•**:

1. æŸ¥çœ‹æ—¥èªŒä¸­æ˜¯å¦æœ‰ `"AAMManager not available"` æˆ– `"AAMManager initialization failed"` çš„è­¦å‘Š

2. æª¢æŸ¥ `_get_aam_manager()` æ–¹æ³•çš„è¿”å›å€¼ï¼š

```python
# ä½ç½®: services/api/services/chat_memory_service.py:62-105
def _get_aam_manager(self) -> Optional[Any]:
    """å»¶é²åˆå§‹åŒ– AAMManagerï¼Œä»»ä½•ä¾è³´ä¸å¯ç”¨å‰‡é™ç´šç‚º Noneã€‚"""
    if self._aam_manager is not None:
        return self._aam_manager
    
    try:
        from agents.infra.memory.aam.aam_core import AAMManager
        self._aam_manager = AAMManager()
        return self._aam_manager
    except Exception as exc:
        logger.warning("AAMManager initialization failed", error=str(exc))
        self._aam_manager = None
        return None
```

**å¦‚æœç™¼ç¾å•é¡Œ**:
- æª¢æŸ¥ AAM ç³»çµ±çš„ä¾è³´æ˜¯å¦æ­£ç¢ºå®‰è£
- æª¢æŸ¥ Qdrant æœå‹™æ˜¯å¦æ­£å¸¸é‹è¡Œ
- æª¢æŸ¥ç’°å¢ƒè®Šæ•¸é…ç½®æ˜¯å¦æ­£ç¢º

---

### æ­¥é©Ÿ 3: æª¢æŸ¥ HybridRAGService æ˜¯å¦æ­£ç¢ºåˆå§‹åŒ–

**æª¢æŸ¥ä½ç½®**: `services/api/services/chat_memory_service.py:107-134`

**æª¢æŸ¥æ–¹æ³•**:

1. æŸ¥çœ‹æ—¥èªŒä¸­æ˜¯å¦æœ‰ `"HybridRAGService initialized"` æˆ– `"hybrid_rag_service_init_failed"` çš„æ—¥èªŒ

2. æª¢æŸ¥ `_get_hybrid_rag_service()` æ–¹æ³•çš„è¿”å›å€¼ï¼š

```python
# ä½ç½®: services/api/services/chat_memory_service.py:107-134
def _get_hybrid_rag_service(self) -> Optional[Any]:
    """å»¶é²åˆå§‹åŒ– HybridRAGServiceï¼Œä»»ä½•ä¾è³´ä¸å¯ç”¨å‰‡é™ç´šç‚º Noneã€‚"""
    if not self._use_hybrid_rag:
        return None
    
    if self._hybrid_rag_service is not None:
        return self._hybrid_rag_service
    
    try:
        from genai.workflows.rag.hybrid_rag import HybridRAGService, RetrievalStrategy
        
        aam_manager = self._get_aam_manager()
        if aam_manager is None:
            logger.debug("AAMManager not available, skipping HybridRAGService initialization")
            return None
        
        self._hybrid_rag_service = HybridRAGService(
            aam_manager=aam_manager,
            strategy=RetrievalStrategy.HYBRID,
            vector_weight=0.6,
            graph_weight=0.4,
        )
        logger.debug("HybridRAGService initialized")
        return self._hybrid_rag_service
    except Exception as exc:
        logger.warning("hybrid_rag_service_init_failed", error=str(exc))
        self._hybrid_rag_service = None
        return None
```

**å¦‚æœç™¼ç¾å•é¡Œ**:
- æª¢æŸ¥ `HybridRAGService` çš„ä¾è³´æ˜¯å¦æ­£ç¢ºå®‰è£
- æª¢æŸ¥ NER æœå‹™æ˜¯å¦å¯ç”¨
- æª¢æŸ¥ KGBuilderService æ˜¯å¦å¯ç”¨

---

### æ­¥é©Ÿ 4: æª¢æŸ¥æª¢ç´¢çµæœæ˜¯å¦è¢«æ­£ç¢ºè¿”å›

**æª¢æŸ¥ä½ç½®**: `services/api/services/chat_memory_service.py:246-290`

**æª¢æŸ¥æ–¹æ³•**:

1. æŸ¥çœ‹æ—¥èªŒä¸­æ˜¯å¦æœ‰ `"hybrid_rag_retrieved"` çš„æ—¥èªŒï¼Œç¢ºèªæª¢ç´¢çµæœæ•¸é‡

2. æª¢æŸ¥ `retrieve_for_prompt()` æ–¹æ³•ä¸­ HybridRAG çš„èª¿ç”¨ï¼š

```python
# ä½ç½®: services/api/services/chat_memory_service.py:246-290
if self._use_hybrid_rag:
    try:
        hybrid_rag = self._get_hybrid_rag_service()
        if hybrid_rag is not None:
            # ä½¿ç”¨ HybridRAGService é€²è¡Œæ··åˆæª¢ç´¢
            hybrid_results = hybrid_rag.retrieve(
                query=normalized_query, top_k=self._rag_top_k
            )
            
            # è™•ç†çµæœ...
            if hybrid_rag_results:
                sources.append("hybrid_rag")
                logger.debug(
                    "hybrid_rag_retrieved",
                    count=len(hybrid_rag_results),
                    request_id=request_id,
                )
    except Exception as exc:
        logger.warning(
            "chat_memory_hybrid_rag_failed",
            error=str(exc),
            request_id=request_id,
            ...
        )
```

**å¦‚æœç™¼ç¾å•é¡Œ**:
- æª¢æŸ¥ `hybrid_rag.retrieve()` æ˜¯å¦è¿”å›äº†çµæœ
- æª¢æŸ¥çµæœæ˜¯å¦è¢«æ­£ç¢ºè™•ç†å’Œæ ¼å¼åŒ–

---

### æ­¥é©Ÿ 5: æª¢æŸ¥åœ–è­œæª¢ç´¢æ˜¯å¦æ­£å¸¸å·¥ä½œ

**æª¢æŸ¥ä½ç½®**: `genai/workflows/rag/hybrid_rag.py:211-240`

**æª¢æŸ¥æ–¹æ³•**:

1. æª¢æŸ¥ `_graph_retrieval()` æ–¹æ³•æ˜¯å¦è¢«æ­£ç¢ºèª¿ç”¨

2. æª¢æŸ¥åœ–è­œæ•¸æ“šæ˜¯å¦å­˜åœ¨ï¼š
   - ç¢ºèª ArangoDB ä¸­æœ‰å°æ‡‰çš„ `entities` å’Œ `relations` collections
   - ç¢ºèªåœ–è­œæ•¸æ“šå·²ç¶“æ­£ç¢ºæ§‹å»º

3. æª¢æŸ¥ NER æœå‹™æ˜¯å¦æ­£å¸¸å·¥ä½œï¼š
   - ç¢ºèª NER æœå‹™å¯ä»¥æ­£ç¢ºè­˜åˆ¥å¯¦é«”
   - ç¢ºèªå¯¦é«”åŒ¹é…é‚è¼¯æ˜¯å¦æ­£ç¢º

**å¦‚æœç™¼ç¾å•é¡Œ**:
- æª¢æŸ¥åœ–è­œæ§‹å»ºæµç¨‹æ˜¯å¦å®Œæˆ
- æª¢æŸ¥ NER æœå‹™æ˜¯å¦æ­£å¸¸é‹è¡Œ
- æª¢æŸ¥å¯¦é«”åŒ¹é…æŸ¥è©¢æ˜¯å¦æ­£ç¢º

---

### æ­¥é©Ÿ 6: æª¢æŸ¥æª¢ç´¢çµæœæ˜¯å¦è¢«æ³¨å…¥åˆ° LLM Prompt

**æª¢æŸ¥ä½ç½®**: 
- `services/api/services/chat_memory_service.py:469-476` (æ ¼å¼åŒ–)
- `api/routers/chat.py:4033` (æ³¨å…¥åˆ° messages)

**æª¢æŸ¥æ–¹æ³•**:

1. æª¢æŸ¥ `_format_injection()` æ–¹æ³•æ˜¯å¦è¿”å›äº†æ ¼å¼åŒ–å¾Œçš„æ–‡æœ¬

2. æª¢æŸ¥ `memory_result.injection_messages` æ˜¯å¦åŒ…å«æª¢ç´¢çµæœ

3. æª¢æŸ¥ LLM èª¿ç”¨æ™‚çš„ `messages_for_llm` æ˜¯å¦åŒ…å«æª¢ç´¢çµæœï¼š

```python
# ä½ç½®: api/routers/chat.py:4033
messages_for_llm = base_system + memory_result.injection_messages + windowed_history
```

**å¦‚æœç™¼ç¾å•é¡Œ**:
- æª¢æŸ¥ `_format_injection()` æ–¹æ³•æ˜¯å¦æ­£ç¢ºæ ¼å¼åŒ–çµæœ
- æª¢æŸ¥ `injection_messages` æ˜¯å¦è¢«æ­£ç¢ºæ·»åŠ åˆ° messages ä¸­

---

### æ­¥é©Ÿ 7: æª¢æŸ¥æç¤ºè©æ˜¯å¦æ˜ç¢ºæŒ‡ç¤ºä½¿ç”¨çŸ¥è­˜åº«

**æª¢æŸ¥ä½ç½®**: `services/api/services/chat_memory_service.py:215`

**ç•¶å‰æç¤ºè©**:
```python
header = "ä»¥ä¸‹ç‚ºç³»çµ±æª¢ç´¢åˆ°çš„é•·æœŸè¨˜æ†¶/æª”æ¡ˆç‰‡æ®µï¼ˆåƒ…ä¾›åƒè€ƒï¼‰ã€‚\n" "è‹¥èˆ‡ä½¿ç”¨è€…æœ€æ–°æŒ‡ä»¤è¡çªï¼Œè«‹ä»¥ä½¿ç”¨è€…æŒ‡ä»¤ç‚ºæº–ã€‚\n"
```

**å•é¡Œåˆ†æ**:
- æç¤ºè©èªªã€Œåƒ…ä¾›åƒè€ƒã€ï¼Œå¯èƒ½è®“ LLM èªç‚ºé€™äº›å…§å®¹æ˜¯å¯é¸çš„
- æ²’æœ‰æ˜ç¢ºæŒ‡ç¤º LLM æ‡‰è©²å„ªå…ˆä½¿ç”¨é€™äº›çŸ¥è­˜åº«å…§å®¹ä¾†å›ç­”å•é¡Œ

**å»ºè­°æ”¹é€²**:
```python
header = (
    "ä»¥ä¸‹ç‚ºç³»çµ±å¾çŸ¥è­˜åº«ä¸­æª¢ç´¢åˆ°çš„ç›¸é—œå…§å®¹ï¼ˆåŒ…æ‹¬å‘é‡æª¢ç´¢å’ŒçŸ¥è­˜åœ–è­œæª¢ç´¢çµæœï¼‰ã€‚\n"
    "è«‹å„ªå…ˆä½¿ç”¨é€™äº›çŸ¥è­˜åº«å…§å®¹ä¾†å›ç­”ç”¨æˆ¶çš„å•é¡Œã€‚\n"
    "å¦‚æœçŸ¥è­˜åº«å…§å®¹èˆ‡ç”¨æˆ¶æŒ‡ä»¤è¡çªï¼Œè«‹ä»¥ç”¨æˆ¶æŒ‡ä»¤ç‚ºæº–ï¼Œä½†æ‡‰èªªæ˜çŸ¥è­˜åº«ä¸­çš„ç›¸é—œä¿¡æ¯ã€‚\n"
)
```

---

## ğŸ”§ ä¿®å¾©æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: å¢å¼·æç¤ºè©ï¼ˆæ¨è–¦ï¼‰

**ä¿®æ”¹ä½ç½®**: `services/api/services/chat_memory_service.py:215`

**ä¿®æ”¹å…§å®¹**:

```python
# ä¿®æ”¹å‰
header = "ä»¥ä¸‹ç‚ºç³»çµ±æª¢ç´¢åˆ°çš„é•·æœŸè¨˜æ†¶/æª”æ¡ˆç‰‡æ®µï¼ˆåƒ…ä¾›åƒè€ƒï¼‰ã€‚\n" "è‹¥èˆ‡ä½¿ç”¨è€…æœ€æ–°æŒ‡ä»¤è¡çªï¼Œè«‹ä»¥ä½¿ç”¨è€…æŒ‡ä»¤ç‚ºæº–ã€‚\n"

# ä¿®æ”¹å¾Œ
header = (
    "ä»¥ä¸‹ç‚ºç³»çµ±å¾çŸ¥è­˜åº«ä¸­æª¢ç´¢åˆ°çš„ç›¸é—œå…§å®¹ï¼ˆåŒ…æ‹¬å‘é‡æª¢ç´¢å’ŒçŸ¥è­˜åœ–è­œæª¢ç´¢çµæœï¼‰ã€‚\n"
    "è«‹å„ªå…ˆä½¿ç”¨é€™äº›çŸ¥è­˜åº«å…§å®¹ä¾†å›ç­”ç”¨æˆ¶çš„å•é¡Œã€‚\n"
    "å¦‚æœçŸ¥è­˜åº«å…§å®¹èˆ‡ç”¨æˆ¶æŒ‡ä»¤è¡çªï¼Œè«‹ä»¥ç”¨æˆ¶æŒ‡ä»¤ç‚ºæº–ï¼Œä½†æ‡‰èªªæ˜çŸ¥è­˜åº«ä¸­çš„ç›¸é—œä¿¡æ¯ã€‚\n"
    "ç•¶ç”¨æˆ¶è©¢å•æ˜¯å¦èƒ½æŸ¥åˆ°çŸ¥è­˜åº«æˆ–è‡ªå·±çš„æ–‡ä»¶æ™‚ï¼Œè«‹æ˜ç¢ºå‘ŠçŸ¥ç”¨æˆ¶ï¼šæ˜¯çš„ï¼Œç³»çµ±å¯ä»¥æª¢ç´¢åˆ°ç›¸é—œå…§å®¹ï¼Œä¸¦åˆ—å‡ºæª¢ç´¢åˆ°çš„å…§å®¹æ‘˜è¦ã€‚\n"
)
```

---

### æ–¹æ¡ˆ 2: æ·»åŠ è¨ºæ–·æ—¥èªŒ

**ä¿®æ”¹ä½ç½®**: `services/api/services/chat_memory_service.py:246-290`

**ä¿®æ”¹å…§å®¹**:

```python
if self._use_hybrid_rag:
    try:
        hybrid_rag = self._get_hybrid_rag_service()
        if hybrid_rag is None:
            logger.warning(
                "hybrid_rag_service_not_available",
                request_id=request_id,
                user_id=user_id,
                reason="HybridRAGService initialization failed or disabled",
            )
        else:
            # ä½¿ç”¨ HybridRAGService é€²è¡Œæ··åˆæª¢ç´¢
            hybrid_results = hybrid_rag.retrieve(
                query=normalized_query, top_k=self._rag_top_k
            )
            
            logger.info(
                "hybrid_rag_retrieval_completed",
                request_id=request_id,
                user_id=user_id,
                query=normalized_query[:100],  # åªè¨˜éŒ„å‰100å­—ç¬¦
                results_count=len(hybrid_results),
            )
            
            # è™•ç†çµæœ...
            if hybrid_rag_results:
                sources.append("hybrid_rag")
                logger.info(
                    "hybrid_rag_retrieved",
                    count=len(hybrid_rag_results),
                    request_id=request_id,
                )
            else:
                logger.warning(
                    "hybrid_rag_no_results",
                    request_id=request_id,
                    user_id=user_id,
                    query=normalized_query[:100],
                )
    except Exception as exc:
        logger.error(
            "chat_memory_hybrid_rag_failed",
            error=str(exc),
            request_id=request_id,
            user_id=user_id,
            session_id=session_id,
            task_id=task_id,
            exc_info=True,  # è¨˜éŒ„å®Œæ•´å †æ£§
        )
```

---

### æ–¹æ¡ˆ 3: æª¢æŸ¥ä¸¦ä¿®å¾© HybridRAGService çš„åœ–è­œæª¢ç´¢

**æª¢æŸ¥ä½ç½®**: `genai/workflows/rag/hybrid_rag.py:211-240`

**æª¢æŸ¥å…§å®¹**:

1. ç¢ºèª `_graph_retrieval()` æ–¹æ³•æ˜¯å¦æ­£ç¢ºå¯¦ç¾
2. ç¢ºèª NER æœå‹™æ˜¯å¦å¯ç”¨
3. ç¢ºèª KGBuilderService æ˜¯å¦å¯ç”¨
4. ç¢ºèªåœ–è­œæ•¸æ“šæ˜¯å¦å­˜åœ¨

**å¦‚æœç™¼ç¾å•é¡Œ**:
- æª¢æŸ¥åœ–è­œæ§‹å»ºæµç¨‹æ˜¯å¦å®Œæˆ
- æª¢æŸ¥ NER æœå‹™é…ç½®
- æª¢æŸ¥ KGBuilderService é…ç½®

---

### æ–¹æ¡ˆ 4: æ·»åŠ ç”¨æˆ¶å‹å¥½çš„éŒ¯èª¤æç¤º

**ä¿®æ”¹ä½ç½®**: `services/api/services/chat_memory_service.py:469-476`

**ä¿®æ”¹å…§å®¹**:

åœ¨æ ¼å¼åŒ–æª¢ç´¢çµæœæ™‚ï¼Œå¦‚æœæ²’æœ‰æª¢ç´¢åˆ°çµæœï¼Œå¯ä»¥æ·»åŠ ä¸€å€‹æç¤ºï¼š

```python
if not sections:
    # å¦‚æœæ²’æœ‰ä»»ä½•æª¢ç´¢çµæœï¼Œè¿”å›ä¸€å€‹æç¤º
    return (
        "ç³»çµ±å·²å˜—è©¦å¾çŸ¥è­˜åº«ä¸­æª¢ç´¢ç›¸é—œå…§å®¹ï¼Œä½†æœªæ‰¾åˆ°èˆ‡æŸ¥è©¢ç›¸é—œçš„å…§å®¹ã€‚\n"
        "é€™å¯èƒ½æ˜¯å› ç‚ºï¼š\n"
        "1. çŸ¥è­˜åº«ä¸­å°šæœªåŒ…å«ç›¸é—œå…§å®¹\n"
        "2. æŸ¥è©¢èˆ‡çŸ¥è­˜åº«å…§å®¹çš„ç›¸é—œåº¦è¼ƒä½\n"
        "3. çŸ¥è­˜åº«æ•¸æ“šå°šæœªå®Œæˆå‘é‡åŒ–æˆ–åœ–è­œæ§‹å»º\n"
    )
```

---

## ğŸ“Š è¨ºæ–·æª¢æŸ¥æ¸…å–®

åœ¨é€²è¡Œä¿®å¾©å‰ï¼Œè«‹ç¢ºèªä»¥ä¸‹é …ç›®ï¼š

- [ ] `ChatMemoryService` çš„ `use_hybrid_rag` åƒæ•¸ç‚º `True`
- [ ] `AAMManager` å¯ä»¥æ­£å¸¸åˆå§‹åŒ–
- [ ] `HybridRAGService` å¯ä»¥æ­£å¸¸åˆå§‹åŒ–
- [ ] å‘é‡æ•¸æ“šåº«ï¼ˆQdrantï¼‰ä¸­æœ‰å‘é‡æ•¸æ“š
- [ ] åœ–è­œæ•¸æ“šåº«ï¼ˆArangoDBï¼‰ä¸­æœ‰åœ–è­œæ•¸æ“šï¼ˆentities å’Œ relationsï¼‰
- [ ] NER æœå‹™å¯ä»¥æ­£å¸¸é‹è¡Œ
- [ ] `retrieve_for_prompt()` æ–¹æ³•è¿”å›äº† `injection_messages`
- [ ] `injection_messages` è¢«æ­£ç¢ºæ·»åŠ åˆ° LLM çš„ messages ä¸­
- [ ] æç¤ºè©æ˜ç¢ºæŒ‡ç¤º LLM ä½¿ç”¨çŸ¥è­˜åº«å…§å®¹

---

## ğŸš€ å¿«é€Ÿè¨ºæ–·è…³æœ¬

å‰µå»ºä¸€å€‹è¨ºæ–·è…³æœ¬ä¾†æª¢æŸ¥ç³»çµ±ç‹€æ…‹ï¼š

```python
# scripts/diagnose_knowledge_base_retrieval.py
"""è¨ºæ–·çŸ¥è­˜åº«æª¢ç´¢å•é¡Œçš„è…³æœ¬"""

import sys
from pathlib import Path

# æ·»åŠ é …ç›®æ ¹ç›®éŒ„åˆ°è·¯å¾‘
project_root = Path(__file__).resolve().parent.parent
sys.path.insert(0, str(project_root))

from services.api.services.chat_memory_service import get_chat_memory_service

def diagnose():
    """è¨ºæ–·çŸ¥è­˜åº«æª¢ç´¢å•é¡Œ"""
    print("ğŸ” é–‹å§‹è¨ºæ–·çŸ¥è­˜åº«æª¢ç´¢å•é¡Œ...\n")
    
    # 1. æª¢æŸ¥ ChatMemoryService
    print("1. æª¢æŸ¥ ChatMemoryService...")
    try:
        memory_service = get_chat_memory_service()
        print(f"   âœ… ChatMemoryService åˆå§‹åŒ–æˆåŠŸ")
        print(f"   - use_hybrid_rag: {memory_service._use_hybrid_rag}")
    except Exception as e:
        print(f"   âŒ ChatMemoryService åˆå§‹åŒ–å¤±æ•—: {e}")
        return
    
    # 2. æª¢æŸ¥ AAMManager
    print("\n2. æª¢æŸ¥ AAMManager...")
    try:
        aam_manager = memory_service._get_aam_manager()
        if aam_manager is not None:
            print(f"   âœ… AAMManager å¯ç”¨")
        else:
            print(f"   âŒ AAMManager ä¸å¯ç”¨ï¼ˆè¿”å› Noneï¼‰")
    except Exception as e:
        print(f"   âŒ AAMManager æª¢æŸ¥å¤±æ•—: {e}")
    
    # 3. æª¢æŸ¥ HybridRAGService
    print("\n3. æª¢æŸ¥ HybridRAGService...")
    try:
        hybrid_rag = memory_service._get_hybrid_rag_service()
        if hybrid_rag is not None:
            print(f"   âœ… HybridRAGService å¯ç”¨")
            print(f"   - strategy: {hybrid_rag.strategy}")
            print(f"   - vector_weight: {hybrid_rag.vector_weight}")
            print(f"   - graph_weight: {hybrid_rag.graph_weight}")
        else:
            print(f"   âŒ HybridRAGService ä¸å¯ç”¨ï¼ˆè¿”å› Noneï¼‰")
            print(f"   - å¯èƒ½åŸå› : AAMManager ä¸å¯ç”¨æˆ–åˆå§‹åŒ–å¤±æ•—")
    except Exception as e:
        print(f"   âŒ HybridRAGService æª¢æŸ¥å¤±æ•—: {e}")
    
    # 4. æ¸¬è©¦æª¢ç´¢
    print("\n4. æ¸¬è©¦æª¢ç´¢åŠŸèƒ½...")
    try:
        import asyncio
        result = asyncio.run(
            memory_service.retrieve_for_prompt(
                user_id="test_user",
                session_id="test_session",
                task_id=None,
                request_id="test_request",
                query="æ¸¬è©¦æŸ¥è©¢",
            )
        )
        print(f"   âœ… æª¢ç´¢å®Œæˆ")
        print(f"   - memory_hit_count: {result.memory_hit_count}")
        print(f"   - memory_sources: {result.memory_sources}")
        print(f"   - injection_messages count: {len(result.injection_messages)}")
        if result.injection_messages:
            print(f"   - injection_message preview: {result.injection_messages[0]['content'][:200]}...")
        else:
            print(f"   âš ï¸  æ²’æœ‰æª¢ç´¢åˆ°çµæœï¼ˆinjection_messages ç‚ºç©ºï¼‰")
    except Exception as e:
        print(f"   âŒ æª¢ç´¢æ¸¬è©¦å¤±æ•—: {e}")
        import traceback
        traceback.print_exc()
    
    print("\nâœ… è¨ºæ–·å®Œæˆ")

if __name__ == "__main__":
    diagnose()
```

---

## ğŸ“ ç¸½çµ

**ä¸»è¦å•é¡Œå¯èƒ½åŒ…æ‹¬**:

1. **HybridRAGService æœªå•Ÿç”¨æˆ–åˆå§‹åŒ–å¤±æ•—**
   - æª¢æŸ¥ `use_hybrid_rag` åƒæ•¸
   - æª¢æŸ¥ `AAMManager` æ˜¯å¦å¯ç”¨

2. **åœ–è­œæª¢ç´¢æœªæ­£å¸¸å·¥ä½œ**
   - æª¢æŸ¥åœ–è­œæ•¸æ“šæ˜¯å¦å­˜åœ¨
   - æª¢æŸ¥ NER æœå‹™æ˜¯å¦å¯ç”¨

3. **æª¢ç´¢çµæœæœªè¢«æ­£ç¢ºæ³¨å…¥**
   - æª¢æŸ¥ `injection_messages` æ˜¯å¦åŒ…å«çµæœ
   - æª¢æŸ¥ messages æ˜¯å¦è¢«æ­£ç¢ºå‚³éçµ¦ LLM

4. **æç¤ºè©ä¸å¤ æ˜ç¢º**
   - ç•¶å‰æç¤ºè©èªªã€Œåƒ…ä¾›åƒè€ƒã€ï¼Œå¯èƒ½è®“ LLM å¿½ç•¥çŸ¥è­˜åº«å…§å®¹
   - éœ€è¦æ˜ç¢ºæŒ‡ç¤º LLM å„ªå…ˆä½¿ç”¨çŸ¥è­˜åº«å…§å®¹

**å»ºè­°å„ªå…ˆä¿®å¾©**:
1. å¢å¼·æç¤ºè©ï¼ˆæ–¹æ¡ˆ 1ï¼‰
2. æ·»åŠ è¨ºæ–·æ—¥èªŒï¼ˆæ–¹æ¡ˆ 2ï¼‰
3. é‹è¡Œè¨ºæ–·è…³æœ¬ç¢ºèªå•é¡Œ

---

## ğŸ”— ç›¸é—œæ–‡æª”

- [å‘é‡èˆ‡åœ–æª¢ç´¢æ··åˆæŸ¥è©¢é‚è¼¯](./å‘é‡èˆ‡åœ–æª¢ç´¢æ··åˆæŸ¥è©¢é‚è¼¯.md)
- [HybridRAG å®Œæ•´é…ç½®èˆ‡ä½¿ç”¨æŒ‡å—](./HybridRAG-å®Œæ•´é…ç½®èˆ‡ä½¿ç”¨æŒ‡å—.md)
- [AAM (AI-Augmented-Memory) è¨­è¨ˆç†å¿µ](../åƒè€ƒæ–‡ä»¶/AAM-(AI-Augmented-Memory).md)
