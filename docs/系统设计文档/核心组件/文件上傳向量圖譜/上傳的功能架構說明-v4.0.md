# 文件上傳功能架構說明 v4.1

## 文檔信息

- **版本**: 4.3
- **創建日期**: 2025-01-27
- **創建人**: Daniel Chung
- **最後修改日期**: 2026-01-23

**更新記錄**：

- 2026-01-23：v4.3 版本，添加文件存放位置說明（FileTree 架構整合）
- 2026-01-21：v4.2 版本，添加雙軌 RAG 解析架構說明（Stage 2 已實現）
- 2026-01-21：v4.1 版本，添加雙軌 RAG 解析架構說明
- 2026-01-20：v4.1 版本，添加嵌入模型推薦配置（qwen3-embedding）
- 2026-01-20：v4.0 版本，從 ChromaDB 遷移到 Qdrant 向量數據庫
- 2026-01-20：v3.1 版本，更新 ChromaDB 配置說明
- 2026-01-05：添加文件摘要生成功能說明（階段 1.5）
- 2026-01-05：添加狀態恢復機制說明
- 2026-01-03：添加 GraphRAG 裁決層說明
- 2026-01-02：v3.0 版本，整合文件管理、狀態管理內容

---

## 目錄

1. [概述](#概述)
2. [文件存放位置與文件樹架構](#文件存放位置與文件樹架構)
3. [系統功能現況盤點](#系統功能現況盤點)
4. [完整流程追蹤](#完整流程追蹤)
5. [文件管理系統](#文件管理系統)
6. [狀態管理系統](#狀態管理系統)
7. [文件存儲系統](#文件存儲系統)
8. [文件授權管理系統](#文件授權管理系統)
9. [Ontology 系統詳解](#ontology-系統詳解)
10. [向量化系統](#向量化系統)
    - [雙軌 RAG 解析架構](#v41-雙軌-rag-解析架構2026-01-21)
    - [2.1 嵌入模型推薦配置](#21-嵌入模型推薦配置)
11. [知識圖譜系統](#知識圖譜系統)
12. [VectorDB 向量數據庫](#vectordb-向量數據庫)
13. [相關服務和依賴](#相關服務和依賴)
14. [API 端點總結](#api-端點總結)
15. [數據流](#數據流)
16. [已知問題與改進計劃](#已知問題與改進計劃)

---

## ⚠️ 重要：VectorDB 遷移說明

### 2026-01-20 重大變更

**向量數據庫從 ChromaDB 遷移到 Qdrant**

| 項目 | 之前 | 之後 |
|------|------|------|
| 向量數據庫 | ChromaDB | ✅ Qdrant |
| REST API 端口 | 8001 | 6333 |
| gRPC API 端口 | - | 6334 |
| Dashboard | 無 | <http://localhost:6333/dashboard> |
| 配置來源 | `datastores.chromadb` | `datastores.qdrant` |

### 遷移優勢

1. **更好的性能**：Qdrant 性能優於 ChromaDB
2. **內建 Dashboard**：提供 Web 管理界面
3. **更好的可擴展性**：支持 Kubernetes 部署
4. **清晰的 Collection 管理**：每個文件一個 Collection

### 遷移文檔

詳細的遷移說明請參閱：

- [VectorDB.md](./VectorDB.md) - 向量數據庫完整架構文檔
- [CHROMADB_TO_QDRANT_MIGRATION.md](./CHROMADB_TO_QDRANT_MIGRATION.md)
- [ROLLBACK_PLAN.md](./ROLLBACK_PLAN.md)

---

## 概述

本文檔詳細說明 AI-Box 系統中文件上傳功能的完整架構，包括前端觸發、API 調用、後端處理、異步任務執行，以及 Ontology 在知識圖譜提取中的應用。

### 主要功能

- 多文件上傳（支持拖拽和點擊選擇）
- 文件類型驗證（PDF, Word, Excel, Markdown, CSV, TXT, 圖片等）
- 自動任務創建（首次上傳時）
- 異步處理流程（分塊、向量化、知識圖譜提取）
- Ontology 自動選擇和應用
- 實時進度追蹤

---

## 文件存放位置與文件樹架構

### 2.1 概述

文件上傳後，會存放在任務的「任務工作區」（Workspace）。文件樹採用 **工作區 + 自訂資料夾** 的層級結構，由 `file_metadata` 和 `folder_metadata` 兩張表動態生成。

### 2.2 系統資料夾

每個任務自動創建以下系統資料夾：

| 資料夾 ID | 名稱 | 類型 | 說明 |
|-----------|------|------|------|
| `temp-workspace` | 任務工作區 | workspace | **前端預設 ID**，顯示為「任務工作區」 |
| `{task_id}_workspace` | 任務工作區 | workspace | **後端預設存放位置** |
| `{task_id}_scheduled` | 排程任務 | scheduled | 系統預留 |

**規則**：

- 系統資料夾不可刪除
- 系統資料夾不可移動
- 系統資料夾的 `folder_type` 不可更改

### 2.3 文件存放邏輯

```
文件上傳
    │
    ▼
┌─────────────────────────────────────────────────────┐
│ 1. 檢查是否指定 target_folder_id                     │
└─────────────────────────────────────────────────────┘
                        │
        ┌───────────────┴───────────────┐
        ▼                               ▼
┌─────────────────────┐     ┌─────────────────────────────┐
│ 有指定 folder_id     │     │ 未指定 folder_id（預設）    │
│                     │     │                             │
│ 存放到指定資料夾     │     │ 存放到 temp-workspace       │
│ folder_id = 設置值   │     │ folder_id = null            │
└─────────────────────┘     └─────────────────────────────┘
```

### 2.4 file_metadata 與 fileTree 的關聯

**file_metadata 關鍵欄位**：

| 欄位 | 類型 | 說明 |
|------|------|------|
| `folder_id` | string (可選) | 所屬資料夾 ID，若為 `null` 表示在任務工作區 |
| `task_id` | string | 所屬任務 ID |

**API 回應格式** (`GET /api/v1/files/tree`)：

```json
{
  "success": true,
  "data": {
    "tree": {
      "temp-workspace": [ /* 默認工作區檔案 */ ],
      "{folder_id}": [
        {
          "file_id": "uuid",
          "filename": "檔案名稱.md",
          "file_type": "text/markdown",
          "file_size": 12345,
          "upload_time": "2026-01-21T12:00:00Z"
        }
      ]
    },
    "folders": {
      "{folder_id}": {
        "folder_name": "目錄名稱",
        "parent_task_id": null,
        "task_id": "task_id",
        "folder_type": "custom"
      }
    },
    "total_files": 5
  }
}
```

### 2.5 文件樹結構示意圖

```
任務文件區
└── 任務工作區 (workspace) ← 預設存放位置
    ├── 子目錄 A
    │   ├── 子目錄 A1
    │   │   └── 檔案 1.md
    │   └── 檔案 2.md
    ├── 子目錄 B
    │   └── 檔案 3.md
    └── 檔案 4.md  ← 上傳時未指定 folder_id，預設放在這裡
```

### 2.6 與文件樹維護規格的關聯

本節說明文件上傳後的存放位置，詳細的文件樹操作（如創建/刪除資料夾、移動檔案等）請參閱：

**[AI-Box文件樹維護需求規格.md](./AI-Box文件樹維護需求規格.md)**

該文檔定義了：

- 資料夾的增刪改操作
- 檔案移動與重命名
- 文件樹的 API 端點
- 前端顯示邏輯

---

## 向量化系統

### v4.0 更新說明

**2026-01-20**：向量存儲系統從 ChromaDB 遷移到 Qdrant

| 功能 | v3.x (ChromaDB) | v4.0 (Qdrant) |
|------|-----------------|---------------|
| 向量存儲 | ChromaDB | ✅ Qdrant |
| API 端口 | 8001 | 6333 |
| Dashboard | 無 | ✅ 有 |
| Collection 命名 | `file_{file_id}` | `file_{file_id}` |
| 權限過濾 | ✅ 支持 | ✅ 支持 |

### v4.1 雙軌 RAG 解析架構（2026-01-21）

**新增功能**：實現雙軌並行解析架構，提升檢索精度

| 階段 | 目標 | 時間 | 狀態 |
|------|------|------|------|
| **Stage 1: 快速軌** | 快速完成基礎向量索引，立即提供檢索能力 | 30-60秒 | ✅ 已實現 |
| **Stage 2: 深度軌** | 使用 LLM + VLM 進行深度理解，生成摘要和 Contextual Header | 30-60秒（背景任務） | ✅ 已實現 |

**詳細說明**: 請參閱 [AI-Box 雙軌 RAG 解析規格書](./AI-Box雙軌RAG解析規格書.md)

### 向量化流程（雙軌架構）

```
文件上傳
  ↓
存儲到 SeaweedFS S3
  ↓
創建 file_metadata 記錄
  ↓
提交 RQ 任務
  ↓
┌──────────────────────────────────────────────────────┐
│ Stage 1: 快速軌（基礎索引）                          │
│                                                      │
│  1. 分塊 (ChunkProcessor)          0-50%           │
│     ↓                                                     │
│  2. 快速向量化 (EmbeddingService) 50-90%           │
│     ↓                                                     │
│  3. 存儲到 Qdrant（基礎 Payload）  90-100%          │
│     └─ ✅ 立即提供檢索能力                              │
│                                                      │
│ Stage 2: 深度軌（背景任務）                          │
│                                                      │
│  4. Prompt A: 語意摘要員（生成全局摘要）            │
│  5. Prompt B: 視覺解析員（圖片/表格轉文字）         │
│  6. Prompt C: 整合封裝員（生成 Contextual Header）  │
│  7. 更新 Qdrant Payload（upsert）                   │
│     └─ ✅ 提升檢索精度                                  │
│                                                      │
│ 知識圖譜提取 (KGExtraction)    90-100%              │
└──────────────────────────────────────────────────────┘
```

### 1. 分塊處理

**實現位置**: `services/api/processors/chunk_processor.py`

**分塊策略**:

- **策略**: `SEMANTIC`（語義分塊）
- **默認 chunk_size**: 768 字符
- **特殊內容保護**:
  - 代碼塊：單獨成塊
  - 表格：包含上下文
- **質量評估**：每個 chunk 進行質量評估

### 2. 向量化

**實現位置**: `services/api/services/embedding_service.py`

**方法**: `generate_embeddings_batch(chunk_texts, progress_callback)`

**特點**:

- 批量向量生成
- 並發控制（信號量機制）
- Ollama 本地模型支持

### 2.1 嵌入模型推薦配置

**v4.1 更新說明（2026-01-20）**

AI-Box 支援語言感知的嵌入模型自動選擇，根據文件語言自動選擇最適合的模型。

#### 推薦嵌入模型

| 語言 | 模型 | 維度 | 說明 | 測試結果 |
|------|------|------|------|----------|
| **多語言/中文** | `qwen3-embedding:latest` | 1024 | Alibaba 最新多語言模型，MTEB 排名第 1 | 47 entities, 52 relations |
| **中文專用** | `bge-large-zh-v1.5:latest` | 1024 | 北京智源中文優化 | 45 entities, 55 relations |
| **英文** | `nomic-embed-text:latest` | 768 | 通用英文模型 | 40 entities, 39 relations |

#### 模型選擇策略

```python
# 語言檢測邏輯
def detect_language(text: str) -> str:
    if re.search(r'[\u4e00-\u9fff]', text):  # 包含中文字符
        return "zh"
    return "default"  # 英文或其他

# 模型映射
LANGUAGE_MODEL_MAP = {
    "zh": "qwen3-embedding:latest",       # 中文 → qwen3
    "en": "nomic-embed-text:latest",      # 英文 → nomic
    "default": "nomic-embed-text:latest"  # 預設 → nomic
}
```

#### MoE 場景配置

嵌入模型通過 MoE 系統管理，場景名稱為 `embedding`：

```json
// config/config.json
{
  "services": {
    "moe": {
      "model_priority": {
        "embedding": [
          {
            "model": "qwen3-embedding:latest",
            "context_size": 32768,
            "timeout": 120,
            "dimension": 1024
          },
          {
            "model": "quentinz/bge-large-zh-v1.5:latest",
            "context_size": 8192,
            "timeout": 120,
            "dimension": 1024
          },
          {
            "model": "nomic-embed-text:latest",
            "context_size": 8192,
            "timeout": 120,
            "dimension": 768
          }
        ]
      }
    }
  }
}
```

#### 環境變數覆蓋

```bash
# 使用特定模型
export MOE_EMBEDDING_MODEL="qwen3-embedding:latest"

# 或使用 bge-large-zh（中文專用）
export MOE_EMBEDDING_MODEL="quentinz/bge-large-zh-v1.5:latest"
```

#### Ollama 模型下載

```bash
# 推薦的多語言模型
ollama pull qwen3-embedding:latest

# 中文專用模型
ollama pull quentinz/bge-large-zh-v1.5:latest

# 通用英文模型
ollama pull nomic-embed-text:latest
```

### 3. 向量存儲（Qdrant）

**實現位置**: `services/api/services/qdrant_vector_store_service.py`

#### 存儲向量

```python
def store_vectors(
    self,
    file_id: str,
    chunks: List[Chunk],
    embeddings: List[List[float]],
    user_id: Optional[str] = None,
) -> bool:
```

**實現邏輯**:

1. 創建 Collection（如不存在）
2. 生成 PointStruct 列表
3. 批量 upsert 到 Qdrant
4. 記錄 metadata

#### 查詢向量

```python
def query_vectors(
    self,
    query_embedding: List[float],
    file_id: Optional[str] = None,
    user_id: Optional[str] = None,
    limit: int = 5,
    score_threshold: float = 0.7,
) -> List[Dict[str, Any]]:
```

**實現邏輯**:

1. 構建查詢 filter（如指定 file_id）
2. 調用 `query_points()`
3. 轉換結果格式
4. 返回相似向量

### 4. Qdrant 配置

#### Docker 啟動

```bash
docker run -d \
  --name qdrant \
  -p 6333:6333 \
  -p 6334:6334 \
  -v /Users/daniel/GitHub/AI-Box/data/qdrant:/qdrant/storage \
  qdrant/qdrant:latest
```

#### 配置文件

```json
{
  "datastores": {
    "qdrant": {
      "host": "127.0.0.1",
      "port": 6333,
      "grpc_port": 6334,
      "protocol": "http",
      "mode": "local",
      "data_path": "./data/qdrant",
      "api_key": null,
      "timeout": 30,
      "hnsw": {
        "m": 16,
        "ef_construct": 100,
        "full_scan_threshold": 10000
      }
    }
  }
}
```

### 5. 權限過濾（ACL）

**實現位置**: `qdrant_vector_store_service.py` - `query_vectors_with_acl()`

**功能**:

- 基於用戶角色過濾向量
- 確保 RAG 檢索結果符合訪問控制

### 6. 代碼調用關係

```
QdrantVectorStoreService 被以下模組調用：

api/routers/file_upload.py
    ├── store_vectors()       ← 存儲文件向量
    ├── query_vectors()       ← 查詢相似向量
    └── get_collection_stats() ← 獲取統計信息

api/routers/file_management.py
    ├── delete_vectors_by_file_id() ← 刪除文件向量
    └── get_vectors_by_file_id()   ← 獲取文件向量

api/routers/user_tasks.py
    └── delete_vectors_by_file_id() ← 刪除任務相關向量

agents/task_analyzer/rag_service.py
    ├── store_capability()    ← 存儲 Capability 向量
    ├── retrieve_capabilities() ← 檢索 Capability
    ├── store_policy_chunk()  ← 存儲 Policy 向量
    └── retrieve_policies()   ← 檢索 Policy
```

### 7. 向量元數據

存儲在 Qdrant payload 中的元數據：

```json
{
  "file_id": "cc3d7aee-b5b3-4e11-9458-784575c1dba6",
  "chunk_index": 0,
  "chunk_text": "文檔內容...",
  "start_position": 0,
  "end_position": 500,
  "chunk_size": 500,
  "strategy": "semantic",
  "encoding": "utf-8",
  "line_count": 10,
  "char_count": 10415,
  "sections": [...],
  "headers": [...],
  "has_code_blocks": true,
  "quality": "{\"size\": 500, ...}",
  "task_id": "systemAdmin_SystemDocs",
  "user_id": "unauthenticated"
}
```

---

## VectorDB 向量數據庫

### 概述

AI-Box 系統使用 **Qdrant** 作為向量數據庫，用於存儲和檢索文檔的向量化表示。

### 與其他 VectorDB 的比較

| 特性 | Qdrant | ChromaDB |
|------|--------|----------|
| 性能 | ✅ 更高 | 較低 |
| Dashboard | ✅ 內建 | ❌ 無 |
| Kubernetes 支持 | ✅ 原生 | 有限 |
| Collection 管理 | ✅ 清晰 | 混亂 |
| 向後兼容 | ✅ 可回滾 | - |

### 配置說明

#### 環境變數

| 環境變數 | 說明 | 默認值 |
|----------|------|--------|
| `QDRANT_HOST` | Qdrant 主機地址 | localhost |
| `QDRANT_PORT` | REST API 端口 | 6333 |
| `QDRANT_GRPC_PORT` | gRPC 端口 | 6334 |

#### Docker Compose

參見 `docker-compose.qdrant.yml`

### Dashboard 訪問

URL: `http://localhost:6333/dashboard`

功能：

- 查看所有 Collections
- 搜索向量
- 監控系統狀態
- 管理數據

### API 接口

| 端點 | 方法 | 功能 |
|------|------|------|
| `/collections` | GET | 列出所有 Collections |
| `/health` | GET | 健康檢查 |
| `/collections/{name}/points/search` | POST | 搜索向量 |

---

## 知識圖譜系統

### 概述

知識圖譜系統負責從文件中提取實體、關係和三元組，並存儲到 ArangoDB 中。

### 處理流程

```
知識圖譜提取流程

文件分塊完成
    ↓
Ontology 選擇（自動匹配）
    ↓
合併 Base + Domain + Major Ontology
    ↓
生成 Prompt 模板
    ↓
LLM 三元組提取
    ↓
GraphRAG 裁決層（置信度過濾）
    ↓
存儲到 ArangoDB
    ↓
返回結果
```

### Ontology 選擇策略

**優先級降級機制**:

1. **Tier 1**: Major Ontology（專業層）
2. **Tier 2**: Domain Ontology（領域層）
3. **Tier 3**: Base 5W1H Ontology（基礎層）
4. **Tier 4**: LLM 自由發揮

### GraphRAG 裁決層

**功能**:

- 置信度過濾
- 核心節點識別
- 統計信息生成

---

## 完整流程追蹤

### 1. 前端觸發

**組件**: `ChatInput.tsx` → `FileUploadModal`

**功能**:

- 文件選擇和驗證
- 拖拽上傳支持
- 進度更新

### 2. API 調用

**端點**: `POST /api/v1/files/v2/upload`

**請求格式**:

```typescript
interface FileUploadRequest {
  files: File[];
  task_id?: string;        // 任務 ID（可選，首次上傳時自動創建）
  target_folder_id?: string; // 目標資料夾 ID（可選，預設存放到任務工作區）
}
```

**請求參數說明**：

| 參數 | 類型 | 必填 | 說明 |
|------|------|------|------|
| `files` | File[] | ✅ | 檔案列表（支持多文件） |
| `task_id` | string | ❌ | 任務 ID，未指定則自動創建新任務 |
| `target_folder_id` | string | ❌ | 目標資料夾 ID，未指定則存放到任務工作區 (`temp-workspace`) |

**響應格式**:

```json
{
  "success": true,
  "data": {
    "uploaded": [
      {
        "file_id": "uuid",
        "filename": "檔案名稱.md",
        "file_type": "text/markdown",
        "file_size": 12345,
        "folder_id": null,  // null 表示在任務工作區
        "upload_time": "2026-01-21T12:00:00Z"
      }
    ],
    "failed": [],
    "task_id": "task_123"
  }
}
```

### 3. 後端處理

**路由**: `api/routers/file_upload.py`

**處理步驟**:

1. 權限檢查
2. 任務處理邏輯
3. 文件驗證
4. 文件存儲（SeaweedFS S3）
5. 元數據創建（ArangoDB）
6. 提交 RQ 任務

### 4. 異步處理

**隊列**: `FILE_PROCESSING_QUEUE`

**任務**: `process_file_chunking_and_vectorization_task`

**處理階段**:

1. 文件解析和分塊（ChunkProcessor）
2. 文件摘要生成（LLM）
3. 向量化（EmbeddingService）
4. 向量存儲（Qdrant）
5. 知識圖譜提取（KGExtractionService）

---

## 狀態管理

### 存儲位置

| 狀態類型 | Redis | ArangoDB |
|----------|-------|-----------|
| 上傳進度 | ✅ | `upload_progress` collection |
| 處理狀態 | ✅ | `processing_status` collection |
| 文件元數據 | ❌ | `file_metadata` collection |

### 狀態恢復機制

**問題**: Redis 狀態過期後無法查詢正確狀態

**解決方案**:

1. 優先從 Redis 讀取
2. 從 ArangoDB 恢復
3. 同步回 Redis

---

## 文件存儲系統

### 概述

文件上傳後會根據 `folder_id` 存放在不同的位置。文件樹採用 **工作區 + 自訂資料夾** 的層級結構。

### 存放位置邏輯

| 場景 | folder_id | 存放位置 | 顯示名稱 |
|------|-----------|----------|----------|
| 未指定目標資料夾 | `null` | 任務工作區 (`temp-workspace`) | 任務工作區 |
| 指定目標資料夾 | `{folder_id}` | 自訂資料夾 | 資料夾名稱 |

### S3 存儲路徑

```
s3://bucket-ai-box-assets/tasks/{task_id}/workspace/{file_id}.{ext}
```

### file_metadata 記錄

文件元數據記錄在 `file_metadata` collection：

```json
{
  "_key": "file_id",
  "file_id": "uuid",
  "filename": "檔案名稱.md",
  "file_type": "text/markdown",
  "file_size": 12345,
  "user_id": "user@example.com",
  "task_id": "task_123",
  "folder_id": null,  // null 表示在任務工作區
  "storage_path": "s3://bucket-ai-box-assets/tasks/task_123/workspace/uuid.md",
  "status": "uploaded",
  "access_control": {...},
  "upload_time": "2026-01-21T12:00:00Z",
  "created_at": "2026-01-21T12:00:00Z",
  "updated_at": "2026-01-21T12:00:00Z"
}
```

### 與文件樹的關聯

1. **前端顯示**：`GET /api/v1/files/tree` 返回 `tree` 和 `folders` 結構
2. **工作區 ID**：
   - 前端：`temp-workspace`（固定 ID）
   - 後端：`{task_id}_workspace`
3. **查詢邏輯**：`folder_id = null` 的檔案會歸類到任務工作區

詳細的文件樹結構說明，請參閱 [AI-Box文件樹維護需求規格.md](./AI-Box文件樹維護需求規格.md)

---

## API 端點總結

### 文件上傳

| 端點 | 方法 | 功能 |
|------|------|------|
| `/api/v1/files/v2/upload` | POST | 多文件上傳（預設存放到任務工作區） |
| `/api/v1/files/{file_id}/processing-status` | GET | 查詢處理狀態 |
| `/api/v1/files/{file_id}/regenerate` | POST | 重新生成 |

### 文件管理

| 端點 | 方法 | 功能 |
|------|------|------|
| `/api/v1/files` | GET | 列出文件 |
| `/api/v1/files/{file_id}` | GET | 獲取文件信息 |
| `/api/v1/files/{file_id}` | DELETE | 刪除文件 |

### 文件樹

| 端點 | 方法 | 功能 |
|------|------|------|
| `/api/v1/files/tree` | GET | 查詢任務文件樹（包含任務工作區） |

### 向量查詢

| 端點 | 方法 | 功能 |
|------|------|------|
| `/api/v1/files/{file_id}/vectors` | GET | 獲取文件向量 |
| `/api/v1/files/{file_id}/vectors/search` | POST | 搜索向量 |

### 資料夾管理

| 端點 | 方法 | 功能 |
|------|------|------|
| `/api/v1/files/folders` | POST | 創建資料夾 |
| `/api/v1/files/folders/{folder_id}` | PUT | 重命名資料夾 |
| `/api/v1/files/folders/{folder_id}` | DELETE | 刪除資料夾 |

---

## 數據流

### 文件上傳數據流

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   前端      │────▶│  FastAPI   │────▶│ SeaweedFS  │
│ FileUpload  │     │  /v2/upload│     │    S3      │
└─────────────┘     └──────┬──────┘     └─────────────┘
                            │
                            ▼
                     ┌─────────────┐
                     │ ArangoDB   │
                     │ file_meta  │ ◄── folder_id 記錄存放位置
                     └─────────────┘
                            │
                            ▼
                     ┌─────────────┐
                     │   RQ Queue │
                     └─────────────┘
                            │
          ┌─────────────────┼─────────────────┐
          ▼                 ▼                 ▼
   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
   │  Chunking   │   │ Embedding  │   │  KG Extract│
   └─────────────┘   └─────────────┘   └─────────────┘
                            │
                            ▼
                     ┌─────────────┐
                     │   Qdrant   │
                     │  Vectors   │
                     └─────────────┘
```

### 文件存放位置數據流

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   上傳檔案   │────▶│  解析參數   │────▶│  存儲位置   │
│             │     │             │     │             │
│ - files     │     │ target_     │     │ folder_id   │
│ - task_id   │     │ folder_id?  │     │ = null →    │
│ - target_   │     │             │     │ temp-       │
│   folder_id │     │             │     │ workspace   │
└─────────────┘     └─────────────┘     └─────────────┘
                                              │
                                              ▼
                                       ┌─────────────┐
                                       │  文件樹查詢  │
                                       │ /files/tree │
                                       └─────────────┘
```

---

## 相關文檔

### 核心文檔

- [VectorDB.md](./VectorDB.md) - 向量數據庫完整架構
- [CHROMADB_TO_QDRANT_MIGRATION.md](./CHROMADB_TO_QDRANT_MIGRATION.md)
- [ROLLBACK_PLAN.md](./ROLLBACK_PLAN.md)

### 文件樹相關文檔

- **[AI-Box文件樹維護需求規格.md](./AI-Box文件樹維護需求規格.md)** - 文件樹顯示邏輯與資料夾操作
- [AI-Box檔案任務管理需求規格書.md](./AI-Box檔案任務管理需求規格書.md) - 檔案任務管理架構

### 系統文檔

- [Ontology系统.md](./Ontology系统.md)
- [强化RAG系统.md](./强化RAG系统.md)
- [知识图谱系统.md](./知识图谱系统.md)

---

## 已知問題與改進計劃

### 高優先級

1. **文件上傳後顯示問題**
   - 移除跳過事件監聽的邏輯
   - 改進 prop 更新機制

2. **Gemini 模型版本**
   - `gemini-pro` 已棄用
   - 優先使用本地 Ollama 模型

### 中優先級

1. **Ontology 合併模式改進**
   - 添加 Fallback 模式支持
   - OWL 約束改為替換

2. **統一任務ID類型**
   - TypeScript 類型統一

### 低優先級

1. **文件授權管理系統實施**
   - 按計劃逐步實現
