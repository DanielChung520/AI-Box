# AI-Box é›™è»Œ RAG è§£æå¯¦æ–½è¨ˆåŠƒæ›¸

**ä»£ç¢¼åŠŸèƒ½èªªæ˜**: AI-Box é›™è»Œ RAG è§£æå¯¦æ–½è¨ˆåŠƒæ›¸ - åŒ…å«è©³ç´°å¯¦æ–½æ­¥é©Ÿã€é€²åº¦ç®¡æ§è¡¨å’Œç‹€æ…‹èªªæ˜
**å‰µå»ºæ—¥æœŸ**: 2026-01-21 15:00 UTC+8
**å‰µå»ºäºº**: Daniel Chung
**æœ€å¾Œä¿®æ”¹æ—¥æœŸ**: 2026-01-21 16:10 UTC+8

---

## ğŸ“‹ æ–‡æª”ä¿¡æ¯

- **ç‰ˆæœ¬**: v1.5
- **ç‹€æ…‹**: é–‹ç™¼ä¸­ï¼ˆIn Progressï¼‰
- **é©ç”¨ç¯„åœ**: AI-Box æ–‡ä»¶ä¸Šå‚³èˆ‡å‘é‡åŒ–ç³»çµ±
- **ç›¸é—œæ–‡æª”**:
  - [AI-Boxé›™è»ŒRAGè§£æè¦æ ¼æ›¸](./AI-Boxé›™è»ŒRAGè§£æè¦æ ¼æ›¸.md) - è¦æ ¼èªªæ˜
  - [ä¸Šå‚³çš„åŠŸèƒ½æ¶æ§‹èªªæ˜-v4.0.md](./ä¸Šå‚³çš„åŠŸèƒ½æ¶æ§‹èªªæ˜-v4.0.md) - æ¶æ§‹èªªæ˜

---

## 1. å¯¦æ–½æ¦‚è¿°

### 1.1 ç›®æ¨™

å¯¦ç¾é›™è»Œ RAG è§£ææ¶æ§‹ï¼Œæå‡æª¢ç´¢ç²¾åº¦å’Œæ–‡æª”ç†è§£èƒ½åŠ›ï¼š

- **Stage 1ï¼ˆå¿«é€Ÿè»Œï¼‰**: å¿«é€Ÿå®ŒæˆåŸºç¤å‘é‡ç´¢å¼•ï¼Œæä¾›å³æ™‚æª¢ç´¢èƒ½åŠ›
- **Stage 2ï¼ˆæ·±åº¦è»Œï¼‰**: ä½¿ç”¨ LLM + VLM é€²è¡Œæ·±åº¦ç†è§£ï¼Œç”Ÿæˆæ‘˜è¦å’Œ Contextual Header

### 1.2 æ ¸å¿ƒåŠŸèƒ½

1. **Prompt Aï¼ˆèªæ„æ‘˜è¦å“¡ï¼‰**: ç”Ÿæˆå…¨å±€èƒŒæ™¯æ‘˜è¦
2. **Prompt Bï¼ˆè¦–è¦ºè§£æå“¡ï¼‰**: åœ–ç‰‡å’Œè¡¨æ ¼è½‰æ–‡å­—
3. **Prompt Cï¼ˆæ•´åˆå°è£å“¡ï¼‰**: ç”Ÿæˆ Contextual Header

---

## 2. å·¥ä½œåˆ†è§£çµæ§‹ (WBS)

### 2.1 éšæ®µä¸€ï¼šå¢å¼·ç¾æœ‰æ‘˜è¦åŠŸèƒ½ï¼ˆPrompt Aï¼‰

**ç›®æ¨™**: å¯¦ç¾èªæ„æ‘˜è¦å“¡ï¼Œç”Ÿæˆçµæ§‹åŒ–æ–‡æª”æ‘˜è¦

**é ä¼°æ™‚é–“**: 1 é€±ï¼ˆ5 å€‹å·¥ä½œå¤©ï¼‰

| å·¥ä½œé … ID                        | å·¥ä½œé …åç¨±                                     | é ä¼°æ™‚é–“ | ç‹€æ…‹ | å®Œæˆåº¦ | é–‹å§‹æ—¥æœŸ | å®Œæˆæ—¥æœŸ | è² è²¬äºº    | èªªæ˜                                                     |
| -------------------------------- | ---------------------------------------------- | -------- | ---- | ------ | -------- | -------- | --------- | -------------------------------------------------------- |
| **WBS 1.1: Prompt A å¯¦ç¾** |                                                |          |      |        |          |          |           |                                                          |
| 1.1.1                            | å¢å¼· `_generate_file_summary_for_metadata()` | 1 å¤©     | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | ä¿®æ”¹ç¾æœ‰å‡½æ•¸ï¼Œä½¿ç”¨ Prompt A è¦æ ¼                         |
| 1.1.2                            | æ•´åˆ MoE `semantic_understanding` å ´æ™¯       | 0.5 å¤©   | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | ä½¿ç”¨ MoE ç³»çµ±é¸æ“‡æ¨¡å‹                                    |
| 1.1.3                            | å¯¦ç¾çµæ§‹åŒ–æ‘˜è¦è§£æ                             | 1 å¤©     | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | è§£æ JSON æ ¼å¼æ‘˜è¦ï¼ˆä¸»é¡Œã€çµæ§‹å¤§ç¶±ã€é—œéµè¡“èªã€ç›®æ¨™å—çœ¾ï¼‰ |
| 1.1.4                            | å–®å…ƒæ¸¬è©¦å’Œé›†æˆæ¸¬è©¦                             | 1 å¤©     | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | æ¸¬è©¦æ‘˜è¦ç”ŸæˆåŠŸèƒ½ï¼ˆ7é …æ¸¬è©¦å…¨éƒ¨é€šéï¼‰                 |
| 1.1.5                            | æ–‡æª”æ›´æ–°                                       | 0.5 å¤©   | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | æ›´æ–° API æ–‡æª”å’Œä»£ç¢¼è¨»é‡‹                                  |

**éšæ®µç‹€æ…‹**: âœ… å·²å®Œæˆ
**éšæ®µé€²åº¦**: 100% (5/5)
**éšæ®µé ä¼°æ™‚é–“**: 5 å¤©

---

### 2.2 éšæ®µäºŒï¼šå¯¦ç¾è¦–è¦ºè§£æå“¡ï¼ˆPrompt Bï¼‰

**ç›®æ¨™**: å¯¦ç¾è¦–è¦ºè§£æå“¡ï¼Œå°‡åœ–ç‰‡å’Œè¡¨æ ¼è½‰ç‚ºæ–‡å­—

**é ä¼°æ™‚é–“**: 1-2 é€±ï¼ˆ5-10 å€‹å·¥ä½œå¤©ï¼‰

| å·¥ä½œé … ID                        | å·¥ä½œé …åç¨±                                   | é ä¼°æ™‚é–“ | ç‹€æ…‹ | å®Œæˆåº¦ | é–‹å§‹æ—¥æœŸ | å®Œæˆæ—¥æœŸ | è² è²¬äºº    | èªªæ˜                              |
| -------------------------------- | -------------------------------------------- | -------- | ---- | ------ | -------- | -------- | --------- | --------------------------------- |
| **WBS 2.1: Prompt B å¯¦ç¾** |                                              |          |      |        |          |          |           |                                   |
| 2.1.1                            | å‰µå»º `VisualParser` è¦–è¦ºè§£æå“¡           | 2 å¤©     | âœ… | 100%   | 2026-01-21 | 2026-01-21 | AI-1      | å¯¦ç¾è¦–è¦ºå…ƒç´ è§£æé‚è¼¯              |
| 2.1.2                            | å¯¦ç¾è¡¨æ ¼è­˜åˆ¥å’Œ Markdown è½‰æ›                 | 2 å¤©     | âœ… | 100%   | 2026-01-21 | 2026-01-21 | AI-1      | ä½¿ç”¨ VLM è­˜åˆ¥è¡¨æ ¼ä¸¦è½‰ç‚º Markdown  |
| 2.1.3                            | å¯¦ç¾åœ–è¡¨è­˜åˆ¥å’Œæè¿°ç”Ÿæˆ                       | 2 å¤©     | âœ… | 100%   | 2026-01-21 | 2026-01-21 | AI-1      | è­˜åˆ¥æŠ€è¡“åœ–è¡¨ï¼Œæè¿° X/Y è»¸ã€è¶¨å‹¢ç­‰ |
| 2.1.4                            | å¯¦ç¾ç”¢å“åœ–ç‰‡æè¿°ç”Ÿæˆ                         | 1 å¤©     | âœ… | 100%   | 2026-01-21 | 2026-01-21 | AI-1      | æè¿°ä¸»é«”ç‰¹å¾µã€çµ„æˆé›¶ä»¶ç­‰          |
| 2.1.5                            | æ•´åˆåˆ°æ–‡ä»¶è™•ç†æµç¨‹                           | 1 å¤©     | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | åœ¨ PDF/Word è§£æä¸­èª¿ç”¨è¦–è¦ºè§£æ    |
| 2.1.6                            | éŒ¯èª¤è™•ç†å’Œ Fallback æ©Ÿåˆ¶                     | 1 å¤©     | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | å¯¦ç¾ VLM å¤±æ•—æ™‚çš„é™ç´šè™•ç†         |
| 2.1.7                            | å–®å…ƒæ¸¬è©¦å’Œé›†æˆæ¸¬è©¦                           | 1 å¤©     | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | æ¸¬è©¦è¦–è¦ºè§£æåŠŸèƒ½ï¼ˆ13é …æ¸¬è©¦å…¨éƒ¨é€šéï¼‰ |

**éšæ®µç‹€æ…‹**: âœ… å·²å®Œæˆ
**éšæ®µé€²åº¦**: 100% (7/7)
**éšæ®µé ä¼°æ™‚é–“**: 10 å¤©

---

### 2.3 éšæ®µä¸‰ï¼šå¯¦ç¾ Contextual Header æ•´åˆå“¡ï¼ˆPrompt Cï¼‰

**ç›®æ¨™**: å¯¦ç¾æ•´åˆå°è£å“¡ï¼Œç‚ºæ¯å€‹ chunk ç”Ÿæˆ Contextual Header

**é ä¼°æ™‚é–“**: 1 é€±ï¼ˆ5 å€‹å·¥ä½œå¤©ï¼‰

| å·¥ä½œé … ID                        | å·¥ä½œé …åç¨±                            | é ä¼°æ™‚é–“ | ç‹€æ…‹ | å®Œæˆåº¦ | é–‹å§‹æ—¥æœŸ | å®Œæˆæ—¥æœŸ | è² è²¬äºº    | èªªæ˜                                         |
| -------------------------------- | ------------------------------------- | -------- | ---- | ------ | -------- | -------- | --------- | -------------------------------------------- |
| **WBS 3.1: Prompt C å¯¦ç¾** |                                       |          |      |        |          |          |           |                                              |
| 3.1.1                            | å‰µå»º `ContextualHeaderGenerator` é¡ | 1 å¤©     | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | å¯¦ç¾ Prompt C é‚è¼¯                           |
| 3.1.2                            | æ•´åˆå…¨å±€æ‘˜è¦å’Œ TOC è·¯å¾‘               | 1 å¤©     | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | å¾ Prompt A çµæœå’Œ chunk metadata ç²å–ä¸Šä¸‹æ–‡ |
| 3.1.3                            | æ•´åˆåˆ°åˆ†å¡Šè™•ç†æµç¨‹                    | 1 å¤©     | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | åœ¨ `ChunkProcessor` ä¸­èª¿ç”¨ Header ç”Ÿæˆ     |
| 3.1.4                            | æ‰¹é‡è™•ç†å„ªåŒ–                          | 1 å¤©     | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | å„ªåŒ–å¤šå€‹ chunk çš„ Header ç”Ÿæˆæ€§èƒ½            |
| 3.1.5                            | å–®å…ƒæ¸¬è©¦å’Œé›†æˆæ¸¬è©¦                    | 1 å¤©     | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | æ¸¬è©¦ Contextual Header ç”ŸæˆåŠŸèƒ½ï¼ˆ16é …æ¸¬è©¦å…¨éƒ¨é€šéï¼‰ |

**éšæ®µç‹€æ…‹**: âœ… å·²å®Œæˆ
**éšæ®µé€²åº¦**: 100% (5/5)
**éšæ®µé ä¼°æ™‚é–“**: 5 å¤©

---

### 2.4 éšæ®µå››ï¼šå¯¦ç¾é›™è»Œè™•ç†æµç¨‹

**ç›®æ¨™**: æ•´åˆ Stage 1 å’Œ Stage 2ï¼Œå¯¦ç¾å®Œæ•´çš„é›™è»Œè™•ç†æµç¨‹

**é ä¼°æ™‚é–“**: 2-3 é€±ï¼ˆ10-15 å€‹å·¥ä½œå¤©ï¼‰

| å·¥ä½œé … ID                             | å·¥ä½œé …åç¨±                                         | é ä¼°æ™‚é–“ | ç‹€æ…‹ | å®Œæˆåº¦ | é–‹å§‹æ—¥æœŸ | å®Œæˆæ—¥æœŸ | è² è²¬äºº    | èªªæ˜                                                 |
| ------------------------------------- | -------------------------------------------------- | -------- | ---- | ------ | -------- | -------- | --------- | ---------------------------------------------------- |
| **WBS 4.1: Stage 1 å¿«é€Ÿè»Œå¯¦ç¾** |                                                    |          |      |        |          |          |           |                                                      |
| 4.1.1                                 | ä¿®æ”¹ `process_file_chunking_and_vectorization()` | 1 å¤©     | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | ç¾æœ‰æµç¨‹å„ªåŒ–ç‚ºé›™è»Œæ¶æ§‹                          |
| 4.1.2                                 | å¯¦ç¾åŸºç¤å‘é‡åŒ–æµç¨‹                                 | 1 å¤©     | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | å¿«é€Ÿç”ŸæˆåŸºç¤å‘é‡ä¸¦å­˜å„²                           |
| 4.1.3                                 | å¯¦ç¾åŸºç¤ Payload å­˜å„²                              | 0.5 å¤©   | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | å­˜å„²åŸºç¤ Payloadï¼ˆfile_id, chunk_index, chunk_textï¼‰ |
| **WBS 4.2: Stage 2 æ·±åº¦è»Œå¯¦ç¾** |                                                    |          |      |        |          |          |           |                                                      |
| 4.2.1                                 | å‰µå»º `process_dual_track_stage2_task` èƒŒæ™¯ä»»å‹™   | 2 å¤©     | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | å¯¦ç¾ Stage 2 èƒŒæ™¯ä»»å‹™ï¼ˆDualTrackProcessorï¼‰    |
| 4.2.2                                 | æ•´åˆ Prompt Aã€Bã€C                                | 2 å¤©     | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | åœ¨ Stage 2 ä¸­èª¿ç”¨ä¸‰å€‹ Prompt                     |
| 4.2.3                                 | å¯¦ç¾ Payload æ›´æ–°æ©Ÿåˆ¶                              | 2 å¤©     | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | ä½¿ç”¨ Qdrant `upsert` æ›´æ–° Payload              |
| 4.2.4                                 | å¯¦ç¾éŒ¯èª¤è™•ç†å’Œé‡è©¦æ©Ÿåˆ¶                             | 1 å¤©     | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | è™•ç† Stage 2 å¤±æ•—æƒ…æ³                           |
| 4.2.5                                 | å¯¦ç¾é€²åº¦è¿½è¹¤                                       | 1 å¤©     | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | æ›´æ–° `stage2` è¿½è¹¤ Stage 2 é€²åº¦              |
| **WBS 4.3: æ•´åˆèˆ‡æ¸¬è©¦**         |                                                    |          |      |        |          |          |           |                                                      |
| 4.3.1                                 | ç«¯åˆ°ç«¯æ¸¬è©¦                                         | 2 å¤©     | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | æ¸¬è©¦å®Œæ•´é›™è»Œæµç¨‹ï¼ˆ7é …é›†æˆæ¸¬è©¦å…¨éƒ¨é€šéï¼‰             |
| 4.3.2                                 | æ€§èƒ½æ¸¬è©¦                                           | 1 å¤©     | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | æ¸¬è©¦ Stage 1 å’Œ Stage 2 æ€§èƒ½ï¼ˆ12é …æ€§èƒ½æ¸¬è©¦å…¨éƒ¨é€šéï¼‰ |
| 4.3.3                                 | æ–‡æª”æ›´æ–°                                           | 0.5 å¤©   | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | æ›´æ–° API æ–‡æª”å’Œæ¶æ§‹æ–‡æª”                              |

**éšæ®µç‹€æ…‹**: âœ… å·²å®Œæˆ
**éšæ®µé€²åº¦**: 100% (11/11)
**éšæ®µé ä¼°æ™‚é–“**: 13.5 å¤©

---

### 2.5 éšæ®µäº”ï¼šMoE Vision å ´æ™¯é…ç½®

**ç›®æ¨™**: åœ¨ MoE ç³»çµ±ä¸­æ·»åŠ  `vision` å ´æ™¯é…ç½®ï¼Œä½¿ç”¨ qwen3-vl:latest ä½œç‚ºè¦–è¦ºç†è§£æ¨¡å‹

**é ä¼°æ™‚é–“**: 0.5 é€±ï¼ˆ2-3 å€‹å·¥ä½œå¤©ï¼‰

| å·¥ä½œé … ID                          | å·¥ä½œé …åç¨±                        | é ä¼°æ™‚é–“ | ç‹€æ…‹ | å®Œæˆåº¦ | é–‹å§‹æ—¥æœŸ | å®Œæˆæ—¥æœŸ | è² è²¬äºº    | èªªæ˜                        |
| ---------------------------------- | --------------------------------- | -------- | ---- | ------ | -------- | -------- | --------- | --------------------------- |
| **WBS 5.1: MoE Vision å ´æ™¯** |                                   |          |      |        |          |          |           |                             |
| 5.1.1                              | åœ¨ MoE é…ç½®ä¸­æ·»åŠ  `vision` å ´æ™¯ | 0.5 å¤©   | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | æ›´æ–° `config/config.json`ï¼Œä½¿ç”¨ qwen3-vl:latest |
| 5.1.2                              | æ›´æ–° `scene_routing.py`         | 0.5 å¤©   | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | æ·»åŠ  vision å ´æ™¯è·¯ç”±é‚è¼¯å’Œç’°å¢ƒè®Šæ•¸æ˜ å°„ |
| 5.1.3                              | æ›´æ–°æ–‡æª”                          | 0.5 å¤©   | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | æ›´æ–° MoE é…ç½®æ–‡æª”å’Œå–®å…ƒæ¸¬è©¦ |
| 5.1.4                              | å–®å…ƒæ¸¬è©¦                          | 0.5 å¤©   | âœ… | 100%   | 2026-01-21 | 2026-01-21 | Backend-1 | å‰µå»º vision å ´æ™¯æ¸¬è©¦ï¼ˆ10é …æ¸¬è©¦å…¨éƒ¨é€šéï¼‰ |

**éšæ®µç‹€æ…‹**: âœ… å·²å®Œæˆ
**éšæ®µé€²åº¦**: 100% (4/4)
**éšæ®µé ä¼°æ™‚é–“**: 2 å¤©

---

## 3. é€²åº¦ç®¡æ§è¡¨

### 3.1 æ•´é«”é€²åº¦çµ±è¨ˆ

| éšæ®µ                                 | å·¥ä½œé …æ•¸ | å·²å®Œæˆ | é€²è¡Œä¸­ | æœªé–‹å§‹ | å®Œæˆåº¦ | é ä¼°æ™‚é–“ |
| ------------------------------------ | -------- | ------ | ------ | ------ | ------ | -------- |
| **éšæ®µä¸€ï¼šPrompt A**           | 5        | 5      | 0      | 0      | 100%   | 5 å¤©     |
| **éšæ®µäºŒï¼šPrompt B**           | 7        | 7      | 0      | 0      | 100%   | 10 å¤©    |
| **éšæ®µä¸‰ï¼šPrompt C**           | 5        | 5      | 0      | 0      | 100%   | 5 å¤©     |
| **éšæ®µå››ï¼šé›™è»Œæµç¨‹**           | 11       | 11     | 0      | 0      | 100%   | 13.5 å¤©  |
| **éšæ®µäº”ï¼šMoE Vision**         | 4        | 4      | 0      | 0      | 100%   | 2 å¤©     |
| **ç¸½è¨ˆ**                       | 32       | 32     | 0      | 0      | 100%   | 35.5 å¤©  |

### 3.2 é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ ID    | é‡Œç¨‹ç¢‘åç¨±    | ç›®æ¨™æ—¥æœŸ | ç‹€æ…‹ | å¯¦éš›å®Œæˆæ—¥æœŸ | èªªæ˜                             |
| ------------ | ------------- | -------- | ---- | ------------ | -------------------------------- |
| **M1** | Prompt A å®Œæˆ | -        | âœ… | 2026-01-21 | èªæ„æ‘˜è¦å“¡åŠŸèƒ½å®Œæˆï¼ˆ5/5 å·¥ä½œé …ï¼‰ |
| **M2** | Prompt B å®Œæˆ | -        | âœ… | 2026-01-21 | è¦–è¦ºè§£æå“¡åŠŸèƒ½å®Œæˆï¼ˆ7/7 å·¥ä½œé …ï¼‰ |
| **M3** | Prompt C å®Œæˆ | -        | âœ… | 2026-01-21 | Contextual Header æ•´åˆå“¡åŠŸèƒ½å®Œæˆï¼ˆ5/5 å·¥ä½œé …ï¼‰ |
| **M4** | é›™è»Œæµç¨‹å®Œæˆ  | -        | âœ… | 2026-01-21 | Stage 1 + Stage 2 å®Œæ•´å¯¦ç¾ï¼ˆ11/11 å·¥ä½œé …ï¼‰ |
| **M5** | ç³»çµ±æ¸¬è©¦å®Œæˆ  | -        | âœ… | 2026-01-21 | ç«¯åˆ°ç«¯æ¸¬è©¦ï¼ˆ7é …ï¼‰å’Œæ€§èƒ½æ¸¬è©¦ï¼ˆ12é …ï¼‰å…¨éƒ¨é€šé |
| **M6** | MoE Vision å®Œæˆ | -        | âœ… | 2026-01-21 | Vision å ´æ™¯é…ç½®å®Œæˆï¼ˆ4/4 å·¥ä½œé …ï¼Œ10é …æ¸¬è©¦é€šéï¼‰ |

---

## 4. ç‹€æ…‹èªªæ˜

### 4.1 å·¥ä½œé …ç‹€æ…‹

| ç‹€æ…‹æ¨™è¨˜ | ç‹€æ…‹åç¨±              | èªªæ˜                         |
| -------- | --------------------- | ---------------------------- |
| âœ…       | **completed**   | å·²å®Œæˆï¼Œå·²é€šéæ¸¬è©¦å’Œä»£ç¢¼å¯©æŸ¥ |
| ğŸ”„       | **in_progress** | é€²è¡Œä¸­ï¼Œæ­£åœ¨é–‹ç™¼æˆ–æ¸¬è©¦       |
| â¸ï¸     | **pending**     | æœªé–‹å§‹ï¼Œç­‰å¾…å‰ç½®ä»»å‹™å®Œæˆ     |
| âš ï¸     | **delayed**     | å»¶é²ï¼ŒæœªæŒ‰è¨ˆåŠƒå®Œæˆ           |
| âŒ       | **blocked**     | é˜»å¡ï¼Œå› ä¾è³´æˆ–å•é¡Œç„¡æ³•ç¹¼çºŒ   |

### 4.2 éšæ®µç‹€æ…‹

| ç‹€æ…‹æ¨™è¨˜ | ç‹€æ…‹åç¨±         | èªªæ˜                         |
| -------- | ---------------- | ---------------------------- |
| âœ…       | **å·²å®Œæˆ** | éšæ®µå…§æ‰€æœ‰å·¥ä½œé …å·²å®Œæˆ       |
| ğŸ”„       | **é€²è¡Œä¸­** | éšæ®µå…§è‡³å°‘æœ‰ä¸€å€‹å·¥ä½œé …é€²è¡Œä¸­ |
| â¸ï¸     | **æœªé–‹å§‹** | éšæ®µå…§æ‰€æœ‰å·¥ä½œé …æœªé–‹å§‹       |
| âš ï¸     | **å»¶é²**   | éšæ®µé€²åº¦è½å¾Œæ–¼è¨ˆåŠƒ           |
| âŒ       | **é˜»å¡**   | éšæ®µå› å•é¡Œç„¡æ³•ç¹¼çºŒ           |

### 4.3 é‡Œç¨‹ç¢‘ç‹€æ…‹

| ç‹€æ…‹æ¨™è¨˜ | ç‹€æ…‹åç¨±              | èªªæ˜                 |
| -------- | --------------------- | -------------------- |
| âœ…       | **completed**   | é‡Œç¨‹ç¢‘å·²é”æˆ         |
| ğŸ”„       | **in_progress** | é‡Œç¨‹ç¢‘ç›¸é—œå·¥ä½œé€²è¡Œä¸­ |
| â¸ï¸     | **pending**     | é‡Œç¨‹ç¢‘å°šæœªé–‹å§‹       |

---

## 5. è©³ç´°å¯¦æ–½æ–¹æ¡ˆ

### 5.1 éšæ®µä¸€ï¼šå¢å¼·ç¾æœ‰æ‘˜è¦åŠŸèƒ½ï¼ˆPrompt Aï¼‰

**ç›®æ¨™**: å¯¦ç¾èªæ„æ‘˜è¦å“¡ï¼Œç”Ÿæˆçµæ§‹åŒ–æ–‡æª”æ‘˜è¦

**å¯¦æ–½æ­¥é©Ÿ**:

#### 5.1.1 å¢å¼· `_generate_file_summary_for_metadata()` å‡½æ•¸

**æ–‡ä»¶ä½ç½®**: `api/routers/file_upload.py` - è¡Œ 484

**ä¿®æ”¹å…§å®¹**:

```python
async def _generate_file_summary_for_metadata(
    file_id: str,
    file_name: str,
    full_text: str,
    user_id: str,
) -> Optional[Dict[str, Any]]:
    """
    ç”Ÿæˆæ–‡ä»¶æ‘˜è¦ï¼ˆå¢å¼·ç‰ˆï¼šç¬¦åˆ Prompt A è¦æ ¼ï¼‰

    è¿”å›æ ¼å¼ï¼š
    {
        "theme": "æ ¸å¿ƒä¸»é¡Œ",
        "structure_outline": [
            {"chapter": "ç« ç¯€åç¨±", "core_logic": "æ ¸å¿ƒé‚è¼¯"}
        ],
        "key_terms": ["è¡“èª1", "è¡“èª2", ...],
        "target_audience": "æŠ€è¡“å“¡/æŠ•è³‡äºº/ä¸€èˆ¬ç”¨æˆ¶"
    }
    """
    from llm.moe.moe_manager import LLMMoEManager

    moe = LLMMoEManager()

    # ä½¿ç”¨ semantic_understanding å ´æ™¯
    prompt = """ä½ ç¾åœ¨æ˜¯ä¸€åå°ˆæ¥­çš„æ–‡ä»¶æ¶æ§‹åˆ†æå¸«ã€‚è«‹é–±è®€é€™ä»½æ–‡ä»¶ï¼Œä¸¦å®Œæˆä»¥ä¸‹ä»»å‹™ï¼š

1. **ä¸»é¡Œå®šç¾©**ï¼šç”¨ä¸€å¥è©±æ¦‚æ‹¬é€™ä»½æ–‡ä»¶çš„æ ¸å¿ƒä¸»é¡Œï¼ˆä¾‹å¦‚ï¼šåœ‹ç¿æ©Ÿæ¢°ç†±è§£çˆæ“ä½œæ‰‹å†Šï¼‰
2. **çµæ§‹å¤§ç¶±**ï¼šåˆ—å‡ºæ–‡ä»¶ä¸»è¦ç« ç¯€èˆ‡å°æ‡‰çš„æ ¸å¿ƒé‚è¼¯
3. **é—œéµè¡“èª**ï¼šæå– 5-10 å€‹è²«ç©¿å…¨æ–‡çš„æ ¸å¿ƒæŠ€è¡“è¡“èª
4. **ç›®æ¨™å—çœ¾**ï¼šåˆ¤æ–·æ­¤æ–‡ä»¶æ˜¯çµ¦æŠ€è¡“å“¡ã€æŠ•è³‡äººé‚„æ˜¯ä¸€èˆ¬ç”¨æˆ¶çœ‹çš„

è«‹ä»¥ JSON æ ¼å¼è¿”å›ï¼š
{
    "theme": "æ ¸å¿ƒä¸»é¡Œ",
    "structure_outline": [
        {"chapter": "ç« ç¯€åç¨±", "core_logic": "æ ¸å¿ƒé‚è¼¯"}
    ],
    "key_terms": ["è¡“èª1", "è¡“èª2", ...],
    "target_audience": "æŠ€è¡“å“¡/æŠ•è³‡äºº/ä¸€èˆ¬ç”¨æˆ¶"
}"""

    result = await moe.generate(
        prompt,
        scene="semantic_understanding",
        temperature=0.3,
        max_tokens=1000,
        user_id=user_id,
        file_id=file_id,
    )

    # è§£æ JSON éŸ¿æ‡‰
    summary_text = result.get("text") or result.get("content", "")
    json_match = re.search(r"\{[\s\S]*\}", summary_text)
    if json_match:
        summary_json = json.loads(json_match.group(0))
        return summary_json

    return None
```

**é©—æ”¶æ¨™æº–**:

- [ ] å‡½æ•¸è¿”å›çµæ§‹åŒ– JSON æ‘˜è¦
- [ ] åŒ…å«ä¸»é¡Œã€çµæ§‹å¤§ç¶±ã€é—œéµè¡“èªã€ç›®æ¨™å—çœ¾
- [ ] å–®å…ƒæ¸¬è©¦é€šé
- [ ] é›†æˆæ¸¬è©¦é€šé

---

#### 5.1.2 æ•´åˆ MoE `semantic_understanding` å ´æ™¯

**æ–‡ä»¶ä½ç½®**: `llm/moe/scene_routing.py`

**ä¿®æ”¹å…§å®¹**:

- ç¢ºèª `semantic_understanding` å ´æ™¯å·²é…ç½®
- ç¢ºèªæ¨¡å‹é¸æ“‡é‚è¼¯æ­£ç¢º

**é©—æ”¶æ¨™æº–**:

- [ ] MoE æ­£ç¢ºé¸æ“‡æ¨¡å‹
- [ ] å ´æ™¯é…ç½®æ­£ç¢º

---

#### 5.1.3 å¯¦ç¾çµæ§‹åŒ–æ‘˜è¦è§£æ

**å¯¦æ–½å…§å®¹**:

- è§£æ LLM è¿”å›çš„ JSON æ ¼å¼æ‘˜è¦
- é©—è­‰å¿…è¦å­—æ®µå­˜åœ¨
- è™•ç†è§£æéŒ¯èª¤

**é©—æ”¶æ¨™æº–**:

- [ ] æ­£ç¢ºè§£æ JSON æ ¼å¼
- [ ] è™•ç†æ ¼å¼éŒ¯èª¤æƒ…æ³
- [ ] è¿”å›çµæ§‹åŒ–å­—å…¸

---

### 5.2 éšæ®µäºŒï¼šå¯¦ç¾è¦–è¦ºè§£æå“¡ï¼ˆPrompt Bï¼‰

**ç›®æ¨™**: å¯¦ç¾è¦–è¦ºè§£æå“¡ï¼Œå°‡åœ–ç‰‡å’Œè¡¨æ ¼è½‰ç‚ºæ–‡å­—

**å¯¦æ–½æ­¥é©Ÿ**:

#### 5.2.1 å¢å¼· `ImageParser` æˆ–å‰µå»º `VisualParser`

**æ–‡ä»¶ä½ç½®**: `services/api/processors/parsers/image_parser.py` æˆ–æ–°å»º `visual_parser.py`

**å¯¦æ–½å…§å®¹**:

```python
class VisualParser(BaseParser):
    """è¦–è¦ºè§£æå“¡ï¼ˆå¯¦ç¾ Prompt Bï¼‰"""

    async def parse_visual_element(
        self,
        image_content: bytes,
        element_type: Optional[str] = None,
        file_id: str,
        user_id: str,
    ) -> Dict[str, Any]:
        """è§£æè¦–è¦ºå…ƒç´ """
        from llm.clients.ollama_vision import get_ollama_vision_client

        vision_client = get_ollama_vision_client()

        prompt = """ä½ ç¾åœ¨æ˜¯ä¸€åè¦–è¦ºæ•¸æ“šè§£æå°ˆå®¶ã€‚è«‹åˆ†æé€™å¼µåœ–ç‰‡ä¸¦åˆ¤æ–·å…¶é¡å‹ï¼š

* **è‹¥ç‚ºè¡¨æ ¼**ï¼šè«‹ç²¾ç¢ºé‚„åŸç‚º Markdown æ ¼å¼ï¼Œç¢ºä¿è¡Œåˆ—å°é½Šï¼Œä¸è¦éºæ¼ä»»ä½•æ•¸æ“šã€‚
* **è‹¥ç‚ºæŠ€è¡“åœ–è¡¨ (å¦‚æ›²ç·šã€æµç¨‹åœ–)**ï¼šè«‹æè¿° X/Y è»¸å«ç¾©ã€è¶¨å‹¢è®ŠåŒ–ï¼ˆä¸Šå‡/ä¸‹é™/å¹³ç©©ï¼‰ä»¥åŠé—œéµæ•¸æ“šé»ã€‚
* **è‹¥ç‚ºç”¢å“åœ–ç‰‡**ï¼šè«‹æè¿°ä¸»é«”ç‰¹å¾µã€çµ„æˆé›¶ä»¶ä»¥åŠå…¶åœ¨æ–‡ä»¶ä¸­çš„æ½›åœ¨åŠŸèƒ½ã€‚

**æ³¨æ„**ï¼šè¼¸å‡ºå¿…é ˆåŒ…å«è©²åœ–ç‰‡åœ¨æ–‡ä»¶ä¸­å¯èƒ½é—œè¯çš„æŠ€è¡“è¡“èªã€‚"""

        result = await vision_client.describe_image(
            image_content=image_content,
            prompt=prompt,
            model="qwen3-vl",
            user_id=user_id,
            file_id=file_id,
        )

        return {
            "description": result.get("description", ""),
            "element_type": element_type or "image",
            "metadata": result.get("metadata", {}),
        }
```

**é©—æ”¶æ¨™æº–**:

- [ ] æ­£ç¢ºè­˜åˆ¥è¡¨æ ¼ã€åœ–è¡¨ã€ç”¢å“åœ–ç‰‡
- [ ] è¡¨æ ¼è½‰ç‚º Markdown æ ¼å¼
- [ ] åœ–è¡¨æè¿°åŒ…å« X/Y è»¸å’Œè¶¨å‹¢
- [ ] ç”¢å“åœ–ç‰‡æè¿°åŒ…å«ç‰¹å¾µå’Œé›¶ä»¶

---

#### 5.2.2 å¯¦ç¾è¡¨æ ¼è­˜åˆ¥å’Œ Markdown è½‰æ›

**å¯¦æ–½å…§å®¹**:

- ä½¿ç”¨ VLM è­˜åˆ¥è¡¨æ ¼çµæ§‹
- è½‰æ›ç‚º Markdown è¡¨æ ¼æ ¼å¼
- ä¿ç•™è¡Œåˆ—å°é½Š

**é©—æ”¶æ¨™æº–**:

- [ ] è¡¨æ ¼çµæ§‹æ­£ç¢ºè­˜åˆ¥
- [ ] Markdown æ ¼å¼æ­£ç¢º
- [ ] æ•¸æ“šå®Œæ•´ç„¡éºæ¼

---

#### 5.2.3 æ•´åˆåˆ°æ–‡ä»¶è™•ç†æµç¨‹

**æ–‡ä»¶ä½ç½®**: `api/routers/file_upload.py` - `process_file_chunking_and_vectorization()`

**å¯¦æ–½å…§å®¹**:

- åœ¨ PDF/Word è§£æä¸­æå–åœ–ç‰‡
- èª¿ç”¨ `VisualParser` è§£æåœ–ç‰‡
- å°‡åœ–ç‰‡æè¿°æ·»åŠ åˆ° chunk metadata

**é©—æ”¶æ¨™æº–**:

- [ ] åœ–ç‰‡è‡ªå‹•æå–å’Œè§£æ
- [ ] åœ–ç‰‡æè¿°å­˜å„²åœ¨ chunk metadata
- [ ] èˆ‡æ–‡å­—å…§å®¹æ­£ç¢ºé—œè¯

---

### 5.3 éšæ®µä¸‰ï¼šå¯¦ç¾ Contextual Header æ•´åˆå“¡ï¼ˆPrompt Cï¼‰

**ç›®æ¨™**: å¯¦ç¾æ•´åˆå°è£å“¡ï¼Œç‚ºæ¯å€‹ chunk ç”Ÿæˆ Contextual Header

**å¯¦æ–½æ­¥é©Ÿ**:

#### 5.3.1 å‰µå»º `ContextualHeaderGenerator` é¡

**æ–‡ä»¶ä½ç½®**: `services/api/processors/contextual_header_generator.py`ï¼ˆæ–°å»ºï¼‰

**å¯¦æ–½å…§å®¹**:

```python
class ContextualHeaderGenerator:
    """Contextual Header æ•´åˆå“¡ï¼ˆå¯¦ç¾ Prompt Cï¼‰"""

    def __init__(self, moe_manager: LLMMoEManager):
        self.moe = moe_manager

    async def generate_contextual_header(
        self,
        global_context: Dict[str, Any],
        toc_path: Optional[str],
        raw_chunk_content: str,
        file_id: str,
        user_id: str,
    ) -> str:
        """ç”Ÿæˆ Contextual Header"""
        prompt = f"""ä½ ç¾åœ¨è² è²¬ç”Ÿæˆ RAG æª¢ç´¢å‰ç¶´ã€‚

è¼¸å…¥æ•¸æ“šï¼š
* å…¨å±€èƒŒæ™¯ï¼š{json.dumps(global_context, ensure_ascii=False)}
* ç•¶å‰ç›®éŒ„è·¯å¾‘ï¼š{toc_path or "æœªæŒ‡å®š"}
* åŸå§‹æ®µè½å…§å®¹ï¼š{raw_chunk_content[:500]}...

**ä»»å‹™**ï¼šè«‹ç‚ºåŸå§‹æ®µè½å¯«ä¸€æ®µ 50 å­—ä»¥å…§çš„ã€è„ˆçµ¡æ¨™é ­ (Contextual Header)ã€ï¼Œç¢ºä¿è©²æ®µè½å³ä½¿å–®ç¨è¢«æª¢ç´¢ï¼Œä¹Ÿèƒ½è®“ AI çŸ¥é“å®ƒæ˜¯é—œæ–¼ä»€éº¼ã€åœ¨å“ªå€‹ç« ç¯€ã€‚

è¼¸å‡ºç¯„ä¾‹ï¼š
ã€[èƒŒæ™¯ï¼šåœ‹ç¿æ©Ÿæ¢°ç†±è§£çˆèªªæ˜æ›¸ > ç¶­è­·æ‰‹å†Š > é›†å¡µå™¨æ¸…ç†] æœ¬æ®µè½èªªæ˜é›†å¡µå™¨çš„æ¸…ç†é »ç‡èˆ‡æ³¨æ„äº‹é …ï¼š...ã€"""

        result = await self.moe.generate(
            prompt,
            scene="semantic_understanding",
            temperature=0.3,
            max_tokens=200,
            user_id=user_id,
            file_id=file_id,
        )

        return result.get("text", "").strip()
```

**é©—æ”¶æ¨™æº–**:

- [ ] æ­£ç¢ºç”Ÿæˆ Contextual Header
- [ ] Header é•·åº¦æ§åˆ¶åœ¨ 50 å­—ä»¥å…§
- [ ] åŒ…å«å…¨å±€èƒŒæ™¯å’Œ TOC è·¯å¾‘ä¿¡æ¯

---

#### 5.3.2 æ•´åˆåˆ°åˆ†å¡Šè™•ç†æµç¨‹

**æ–‡ä»¶ä½ç½®**: `services/api/processors/chunk_processor.py`

**å¯¦æ–½å…§å®¹**:

- åœ¨ `ChunkProcessor.process()` ä¸­èª¿ç”¨ `ContextualHeaderGenerator`
- ç‚ºæ¯å€‹ chunk ç”Ÿæˆ Header
- å°‡ Header æ·»åŠ åˆ° chunk metadata

**é©—æ”¶æ¨™æº–**:

- [ ] æ¯å€‹ chunk éƒ½æœ‰ Contextual Header
- [ ] Header å­˜å„²åœ¨ chunk metadata
- [ ] ä¸å½±éŸ¿ç¾æœ‰åˆ†å¡Šé‚è¼¯

---

### 5.4 éšæ®µå››ï¼šå¯¦ç¾é›™è»Œè™•ç†æµç¨‹

**ç›®æ¨™**: æ•´åˆ Stage 1 å’Œ Stage 2

**å¯¦æ–½æ­¥é©Ÿ**:

#### 5.4.1 ä¿®æ”¹ `process_file_chunking_and_vectorization()` å‡½æ•¸

**æ–‡ä»¶ä½ç½®**: `api/routers/file_upload.py`

**å¯¦æ–½å…§å®¹**:

```python
async def process_file_chunking_and_vectorization(
    file_id: str,
    file_path: str,
    file_type: Optional[str],
    user_id: str,
) -> None:
    """é›™è»Œ RAG è™•ç†æµç¨‹"""

    # ========== Stage 1: å¿«é€Ÿè»Œï¼ˆåŸºç¤ç´¢å¼•ï¼‰==========
    # 1. æ–‡ä»¶è§£æ
    parser = get_parser(file_type)
    parse_result = parser.parse(file_path)

    # 2. åŸºç¤åˆ†å¡Š
    chunk_processor = get_chunk_processor()
    chunks = chunk_processor.process(
        text=parse_result["text"],
        file_id=file_id,
        metadata=parse_result.get("metadata", {}),
    )

    # 3. å¿«é€Ÿå‘é‡åŒ–
    embedding_service = get_embedding_service()
    embeddings = await embedding_service.generate_embeddings_batch(
        [chunk.get("text", "") for chunk in chunks]
    )

    # 4. ç«‹å³å­˜å„²åˆ° Qdrantï¼ˆåŸºç¤ Payloadï¼‰
    vector_store_service = get_qdrant_vector_store_service()
    vector_store_service.store_vectors(
        file_id=file_id,
        chunks=chunks,
        embeddings=embeddings,
        user_id=user_id,
    )

    # ========== Stage 2: æ·±åº¦è»Œï¼ˆèƒŒæ™¯ä»»å‹™ï¼‰==========
    # æäº¤èƒŒæ™¯ä»»å‹™é€²è¡Œæ·±åº¦è™•ç†
    queue = get_task_queue(FILE_PROCESSING_QUEUE)
    job = queue.enqueue(
        process_dual_track_stage2_task,
        file_id=file_id,
        file_path=file_path,
        file_type=file_type,
        user_id=user_id,
        job_timeout=1800,  # 30åˆ†é˜
    )
```

**é©—æ”¶æ¨™æº–**:

- [ ] Stage 1 å¿«é€Ÿå®Œæˆï¼ˆ30-60ç§’ï¼‰
- [ ] Stage 2 æäº¤åˆ°èƒŒæ™¯ä»»å‹™éšŠåˆ—
- [ ] ä¸å½±éŸ¿ Stage 1 çš„æª¢ç´¢åŠŸèƒ½

---

#### 5.4.2 å‰µå»º `process_dual_track_stage2_task` èƒŒæ™¯ä»»å‹™

**æ–‡ä»¶ä½ç½®**: `workers/tasks.py`ï¼ˆæ–°å»ºæˆ–æ“´å±•ï¼‰

**å¯¦æ–½å…§å®¹**:

```python
@rq.job('file_processing', timeout=1800)
def process_dual_track_stage2_task(
    file_id: str,
    file_path: str,
    file_type: Optional[str],
    user_id: str,
) -> None:
    """Stage 2: æ·±åº¦è»Œè™•ç†ï¼ˆèƒŒæ™¯ä»»å‹™ï¼‰"""

    # 1. Prompt A: èªæ„æ‘˜è¦å“¡
    summary = await _generate_file_summary_for_metadata(
        file_id, file_name, full_text, user_id
    )

    # 2. Prompt B: è¦–è¦ºè§£æå“¡ï¼ˆå¦‚æœæœ‰åœ–ç‰‡ï¼‰
    visual_descriptions = await process_visual_elements(
        file_path, file_id, user_id
    )

    # 3. Prompt C: Contextual Header æ•´åˆå“¡
    header_generator = ContextualHeaderGenerator(LLMMoEManager())
    for chunk in chunks:
        contextual_header = await header_generator.generate_contextual_header(
            global_context=summary,
            toc_path=chunk.get("metadata", {}).get("header_path"),
            raw_chunk_content=chunk["text"],
            file_id=file_id,
            user_id=user_id,
        )
        chunk["metadata"]["contextual_header"] = contextual_header

    # 4. æ›´æ–° Qdrant Payloadï¼ˆä½¿ç”¨ upsertï¼‰
    vector_store_service = get_qdrant_vector_store_service()
    vector_store_service.update_vectors_payload(
        file_id=file_id,
        chunks=chunks,
        user_id=user_id,
    )
```

**é©—æ”¶æ¨™æº–**:

- [ ] èƒŒæ™¯ä»»å‹™æ­£ç¢ºåŸ·è¡Œ
- [ ] ä¸‰å€‹ Prompt æ­£ç¢ºèª¿ç”¨
- [ ] Payload æ­£ç¢ºæ›´æ–°

---

#### 5.4.3 å¯¦ç¾ Payload æ›´æ–°æ©Ÿåˆ¶

**æ–‡ä»¶ä½ç½®**: `services/api/services/qdrant_vector_store_service.py`

**å¯¦æ–½å…§å®¹**:

```python
def update_vectors_payload(
    self,
    file_id: str,
    chunks: List[Dict[str, Any]],
    user_id: Optional[str] = None,
) -> bool:
    """æ›´æ–° Qdrant Payloadï¼ˆä¿ç•™åŸæœ‰å‘é‡ IDï¼‰"""
    collection_name = self._get_collection_name(file_id, user_id)

    # ç²å–ç¾æœ‰ points
    existing_points = self.get_vectors_by_file_id(
        file_id=file_id,
        user_id=user_id,
        limit=10000,
        with_vector=False,
    )

    # æ§‹å»ºæ›´æ–°å¾Œçš„ points
    updated_points = []
    for i, chunk in enumerate(chunks):
        existing_point = next(
            (p for p in existing_points if p["payload"].get("chunk_index") == i),
            None
        )

        if existing_point:
            # æ›´æ–° Payloadï¼Œä¿ç•™åŸæœ‰ ID
            updated_payload = {
                **existing_point["payload"],
                "global_summary": chunk.get("metadata", {}).get("global_summary"),
                "contextual_header": chunk.get("metadata", {}).get("contextual_header"),
                "image_description": chunk.get("metadata", {}).get("image_description"),
            }

            updated_points.append(
                PointStruct(
                    id=existing_point["id"],
                    vector=None,  # ä¸æ›´æ–°å‘é‡
                    payload=updated_payload,
                )
            )

    # ä½¿ç”¨ upsert æ›´æ–°
    if updated_points:
        self.client.upsert(
            collection_name=collection_name,
            points=updated_points,
        )
        return True

    return False
```

**é©—æ”¶æ¨™æº–**:

- [ ] Payload æ­£ç¢ºæ›´æ–°
- [ ] ä¿ç•™åŸæœ‰å‘é‡ ID
- [ ] ä¸å½±éŸ¿å‘é‡æ•¸æ“š

---

## 6. é¢¨éšªç®¡ç†

### 6.1 é¢¨éšªè­˜åˆ¥èˆ‡ç·©è§£

| é¢¨éšª ID      | é¢¨éšªæè¿°         | å½±éŸ¿  | å¯èƒ½æ€§ | ç‹€æ…‹ | ç·©è§£æªæ–½                            |
| ------------ | ---------------- | ----- | ------ | ---- | ----------------------------------- |
| **R1** | LLM èª¿ç”¨å¤±æ•—     | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­  | â¸ï¸ | Fallback æ©Ÿåˆ¶ï¼Œæ¨™è¨»éŒ¯èª¤ä½†ä¸å½±éŸ¿æª¢ç´¢ |
| **R2** | VLM èª¿ç”¨å¤±æ•—     | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­  | â¸ï¸ | æ¨™è¨» `vlm_error`ï¼Œä¿ç•™æ–‡å­— OCR    |
| **R3** | Payload æ›´æ–°å¤±æ•— | ğŸŸ¢ ä½ | ğŸŸ¢ ä½  | â¸ï¸ | é‡è©¦æ©Ÿåˆ¶ï¼Œä¸å½±éŸ¿ Stage 1 åŠŸèƒ½       |
| **R4** | æ€§èƒ½ä¸‹é™         | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­  | â¸ï¸ | å¯é…ç½®é–‹é—œï¼Œç”Ÿç”¢ç’°å¢ƒå¯é¸æ“‡æ€§å•Ÿç”¨    |
| **R5** | æˆæœ¬å¢åŠ          | ğŸŸ¡ ä¸­ | ğŸŸ¡ é«˜  | â¸ï¸ | å¯é…ç½®é–‹é—œï¼ŒæŒ‰éœ€å•Ÿç”¨ Stage 2        |

### 6.2 ä¾è³´é—œä¿‚

| å·¥ä½œé …           | ä¾è³´é …                   | èªªæ˜                              |
| ---------------- | ------------------------ | --------------------------------- |
| **éšæ®µäºŒ** | **éšæ®µä¸€**         | Prompt B éœ€è¦ Prompt A çš„æ‘˜è¦çµæœ |
| **éšæ®µä¸‰** | **éšæ®µä¸€**         | Prompt C éœ€è¦ Prompt A çš„å…¨å±€æ‘˜è¦ |
| **éšæ®µå››** | **éšæ®µä¸€ã€äºŒã€ä¸‰** | é›™è»Œæµç¨‹éœ€è¦æ‰€æœ‰ Prompt å¯¦ç¾      |

---

## 7. é…ç½®è¦æ±‚

### 7.1 MoE å ´æ™¯é…ç½®

**æ–‡ä»¶ä½ç½®**: `config/config.json`

```json
{
  "services": {
    "moe": {
      "model_priority": {
        "semantic_understanding": [
          {
            "model": "qwen3-vl",
            "context_size": 32768,
            "temperature": 0.3,
            "timeout": 60
          }
        ],
        "vision": [
          {
            "model": "qwen3-vl",
            "context_size": 32768,
            "temperature": 0.2,
            "timeout": 120
          }
        ]
      }
    }
  }
}
```

### 7.2 é›™è»Œè™•ç†é…ç½®

**æ–‡ä»¶ä½ç½®**: `config/config.json`

```json
{
  "chunk_processing": {
    "dual_track": {
      "enabled": true,
      "stage1_strategy": "semantic",
      "stage2_enabled": true,
      "stage2_delay_seconds": 0,
      "update_payload_on_complete": true,
      "fallback_on_error": true
    }
  }
}
```

---

## 8. æ¸¬è©¦è¨ˆåŠƒ

### 8.1 å–®å…ƒæ¸¬è©¦

| æ¸¬è©¦é …               | æ¸¬è©¦æ–‡ä»¶                                         | ç‹€æ…‹ |
| -------------------- | ------------------------------------------------ | ---- |
| Prompt A æ‘˜è¦ç”Ÿæˆ    | `tests/api/routers/test_file_summary_prompt_a.py` | âœ… |
| Prompt B è¦–è¦ºè§£æ    | `tests/api/routers/test_visual_parser_prompt_b.py` | âœ… |
| Prompt C Header ç”Ÿæˆ | `tests/api/routers/test_contextual_header_prompt_c.py` | âœ… |
| Payload æ›´æ–°         | `tests/services/test_qdrant_payload_update.py` | â¸ï¸ |

### 8.2 é›†æˆæ¸¬è©¦

| æ¸¬è©¦é …         | æ¸¬è©¦æ–‡ä»¶                                        | ç‹€æ…‹ |
| -------------- | ----------------------------------------------- | ---- |
| é›™è»Œæµç¨‹ç«¯åˆ°ç«¯ | `tests/integration/test_dual_track_rag.py`    | â¸ï¸ |
| Stage 1 å¿«é€Ÿè»Œ | `tests/integration/test_stage1_fast_track.py` | â¸ï¸ |
| Stage 2 æ·±åº¦è»Œ | `tests/integration/test_stage2_deep_track.py` | â¸ï¸ |

### 8.3 æ€§èƒ½æ¸¬è©¦

| æ¸¬è©¦é …           | ç›®æ¨™    | ç‹€æ…‹ |
| ---------------- | ------- | ---- |
| Stage 1 è™•ç†æ™‚é–“ | < 60ç§’  | â¸ï¸ |
| Stage 2 è™•ç†æ™‚é–“ | < 120ç§’ | â¸ï¸ |
| Payload æ›´æ–°æ™‚é–“ | < 10ç§’  | â¸ï¸ |

---

## 9. æ›´æ–°è¨˜éŒ„

| æ›´æ–°æ—¥æœŸ   | ç‰ˆæœ¬ | æ›´æ–°å…§å®¹                             | æ›´æ–°äºº       |
| ---------- | ---- | ------------------------------------ | ------------ |
| 2026-01-21 | v1.1 | æ›´æ–° MoE é…ç½®ï¼šæ¨¡å‹æ”¹ç‚º `qwen3-vl`ï¼Œä¸Šä¸‹æ–‡çª—å£æ”¹ç‚º 32K | Daniel Chung |
| 2026-01-21 | v1.0 | åˆå§‹ç‰ˆæœ¬ï¼Œå‰µå»ºå¯¦æ–½è¨ˆåŠƒæ›¸å’Œé€²åº¦ç®¡æ§è¡¨ | Daniel Chung |
| 2026-01-21 | v1.1 | éšæ®µä¸€ï¼ˆPrompt Aï¼‰é‡æ§‹å®Œæˆï¼š5/5 å·¥ä½œé …å·²å®Œæˆ | Daniel Chung |
| 2026-01-21 | v1.2 | å–®å…ƒæ¸¬è©¦å‰µå»ºå®Œæˆï¼ˆ7é …æ¸¬è©¦å…¨éƒ¨é€šéï¼‰  | Daniel Chung |
| 2026-01-21 | v1.3 | éšæ®µäºŒï¼ˆPrompt Bï¼‰å®Œæˆï¼š7/7 å·¥ä½œé …å·²å®Œæˆï¼Œå‰µå»º VisualParser å’Œ VisualElementProcessor | Daniel Chung |
| 2026-01-21 | v1.4 | éšæ®µä¸‰ï¼ˆPrompt Cï¼‰å®Œæˆï¼š5/5 å·¥ä½œé …å·²å®Œæˆï¼Œå‰µå»º ContextualHeaderGenerator | Daniel Chung |
| 2026-01-21 | v1.5 | éšæ®µå››ï¼ˆé›™è»Œæµç¨‹ï¼‰å®Œæˆï¼š11/11 å·¥ä½œé …å·²å®Œæˆï¼Œå‰µå»º DualTrackProcessorï¼Œ7é …é›†æˆæ¸¬è©¦å…¨éƒ¨é€šé | Daniel Chung |
| 2026-01-21 | v1.6 | éšæ®µäº”ï¼ˆMoE Visionï¼‰å®Œæˆï¼š4/4 å·¥ä½œé …å·²å®Œæˆï¼Œä½¿ç”¨ qwen3-vl:latestï¼Œ10é …æ¸¬è©¦å…¨éƒ¨é€šé | Daniel Chung |

---

**æ–‡ä»¶ç‰ˆæœ¬**: v1.6
**æœ€å¾Œæ›´æ–°æ—¥æœŸ**: 2026-01-21 16:30 UTC+8
**ç¶­è­·äºº**: Daniel Chung
