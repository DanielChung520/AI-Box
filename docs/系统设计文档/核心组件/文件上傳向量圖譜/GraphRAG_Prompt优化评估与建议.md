# GraphRAG Prompt 优化评估与建议

**创建日期**: 2026-01-03
**创建人**: Daniel Chung
**最后修改日期**: 2026-01-03

---

## 📋 ChatGPT 建议评估

### ✅ 建议 1: 明确裁决层（GraphRAG Judgment）

**评估**: ⭐⭐⭐⭐⭐ **强烈推荐**

**理由**:
- 当前系统已有 `confidence` 字段，但缺少明确的裁决机制
- `include_in_graph` 和 `core_node` 字段可以显著提升图谱质量
- 避免模型过度创造和推测，提高可控性

**实现建议**:
- ✅ 在 Prompt 模板中添加裁决规则段落
- ⚠️ 需要扩展 `Triple` 模型添加 `include_in_graph` 和 `core_node` 字段（可选，也可以在后处理层实现）

**权衡**:
- **方案 A（推荐）**: 在 Prompt 中要求模型输出裁决信息，但不在数据模型中强制要求（向后兼容）
- **方案 B**: 扩展数据模型，完全集成裁决层（需要数据迁移）

---

### ✅ 建议 2: JSON Schema 强制性

**评估**: ⭐⭐⭐⭐⭐ **强烈推荐**

**理由**:
- 当前模板已有相关说明，但可以更明确
- 对 Ollama 本地模型尤其重要，可以减少解析错误
- 提高系统稳定性

**实现建议**:
- ✅ 在模板中强化 JSON 输出要求
- ✅ 添加错误处理提示

---

### ⚠️ 建议 3: 模型参数建议

**评估**: ⭐⭐⭐⭐ **推荐，但需可配置**

**理由**:
- 参数建议合理，但应该作为**配置项**而非硬编码
- 不同模型可能需要不同参数
- 不同场景（提取 vs 生成）可能需要不同参数

**实现建议**:
- ✅ 创建模型参数配置文档
- ✅ 在服务层支持参数配置
- ⚠️ 不建议直接硬编码到 Prompt 模板中

**建议参数**:
```python
{
    "temperature": 0.0,  # 保守，确保稳定性
    "top_p": 0.9,
    "top_k": 40,
    "max_tokens": 512,  # 每个 chunk
    "chunk_size": 200-500  # tokens
}
```

---

### ✅ 建议 4: 明确分层说明

**评估**: ⭐⭐⭐⭐⭐ **强烈推荐**

**理由**:
- 提高 Prompt 的可维护性
- 便于后续扩展和优化
- 符合软件工程最佳实践

**实现建议**:
- ✅ 在 Prompt 模板中明确标注三层功能
- ✅ 添加注释说明每层的职责

---

### ✅ 建议 5: 多义词/上下文一致性提示

**评估**: ⭐⭐⭐⭐ **推荐**

**理由**:
- 对 Graph 一致性非常重要
- 避免创建重复节点
- 提高图谱质量

**实现建议**:
- ✅ 在 Prompt 中添加一致性提示
- ⚠️ 注意：这主要依赖后处理层的实体去重，Prompt 只是辅助

---

## 🎯 我的专业建议

### 1. 优先级排序

1. **高优先级**（立即实现）:
   - ✅ JSON Schema 强制性强化
   - ✅ 明确分层说明
   - ✅ 多义词/上下文一致性提示

2. **中优先级**（建议实现）:
   - ✅ 裁决层（GraphRAG Judgment）- 可以在 Prompt 中添加，但不强制修改数据模型
   - ✅ 模型参数配置文档

3. **低优先级**（可选）:
   - ⚠️ 扩展数据模型添加 `include_in_graph` 和 `core_node`（需要数据迁移）

### 2. 实现策略

**推荐方案**: **渐进式优化**

1. **第一阶段**（当前）:
   - 优化 Prompt 模板，添加裁决层说明
   - 强化 JSON Schema 要求
   - 添加分层说明和一致性提示
   - **不修改数据模型**（保持向后兼容）

2. **第二阶段**（可选）:
   - 如果裁决层效果良好，再考虑扩展数据模型
   - 添加后处理层的裁决逻辑（基于 confidence 阈值）

3. **第三阶段**（未来）:
   - 实现完整的裁决层服务
   - 支持可配置的裁决规则

### 3. 关键设计决策

**裁决层的实现位置**:

- **方案 A（推荐）**: Prompt 层 + 后处理层
  - Prompt 要求模型输出裁决信息（但不强制）
  - 后处理层基于 confidence 和规则进行过滤
  - 优点：灵活、向后兼容

- **方案 B**: 完全在数据模型中实现
  - 扩展 Triple 模型添加裁决字段
  - 优点：结构化、可查询
  - 缺点：需要数据迁移

**我的建议**: 采用**方案 A**，在 Prompt 中添加裁决说明，但在后处理层实现实际的裁决逻辑。

---

## 📝 优化后的 Prompt 模板

基于 ChatGPT 的建议和我的评估，以下是优化后的模板：

```json
{
    "template_name": "Knowledge_Graph_Extraction_Multi_Layer",
    "model_target": "Mistral-NeMo:12B (Local)",
    "language": "zh-TW",
    "instruction_template": [
        "你是一位專業的知識圖譜工程師，請仔細閱讀以下 [TEXT_CHUNK]。",
        "任務：抽取符合內部 Ontology 規範的三元組結構化知識，並對每個三元組進行質量評估。",
        "你必須嚴格遵守以下由我們動態載入的規則，否則你的輸出將被系統拒絕。",

        "## 功能分層說明",
        "本任務分為三個層次：",
        "1. **Extraction Layer (抽取層)**: 負責從文本中識別實體和關係，生成候選三元組",
        "2. **Judgment Layer (裁決層)**: 負責評估三元組質量，判斷是否適合入圖",
        "3. **Schema Layer (格式層)**: 強制 JSON Schema 規範，確保系統可直接解析",

        "### 1. 核心實體類型 (Entity Classes):",
        "[INJECT_ENTITY_LIST]",

        "### 2. 關係類型約束 (Relationship Types):",
        "[INJECT_RELATIONSHIP_LIST]",

        "### 3. OWL Domain/Range 規則 (嚴格約束):",
        "提取的三元組必須滿足 Domain-Range 約束。例如，如果關係是 'produces'，則主體必須是 'Machine_Asset'，客體必須是 'Material'。",

        "### 4. GraphRAG 裁決規則 (Judgment Layer):",
        "對每個候選三元組，請進行以下評估：",
        "1. **證據充分性**: 三元組必須在文本中有明確的證據支持，禁止推測或創造",
        "2. **置信度評估**: 請給出 0~1 的置信度數值，表示你對該三元組的信心",
        "   - 0.9-1.0: 文本中明確提及，證據充分",
        "   - 0.7-0.9: 文本中提及，但需要一定推斷",
        "   - 0.5-0.7: 文本中隱含，需要較多推斷",
        "   - <0.5: 證據不足，不建議入圖",
        "3. **核心節點識別**: 如果實體是文檔的核心概念（如主要人物、關鍵設備、重要流程），請標記為核心節點",
        "4. **保守原則**: 當證據不足或存在歧義時，請保守處理，寧可遺漏也不要錯誤入圖",
        "5. **禁止創造**: 絕對禁止模型自行新增文本中未明確出現的實體或關係",

        "### 5. 上下文一致性要求:",
        "1. **實體名稱一致性**: 如果同一實體在不同片段出現，請保持名稱完全一致，避免創建重複節點",
        "2. **類型一致性**: 同一實體在不同三元組中應保持相同的實體類型",
        "3. **關係一致性**: 相同實體對之間的關係應保持一致",

        "### 6. 輸出格式 (JSON Schema):",
        "[INJECT_JSON_SCHEMA]",
        "",
        "**重要**: 你的輸出必須完全符合上述 JSON Schema，不得包含任何 Markdown、註解、額外文字或說明。",
        "如果無法生成符合規範的三元組，請輸出空列表 `{\"extracted_triples\": []}`。",
        "系統會自動驗證 JSON 格式，任何格式錯誤都會導致提取失敗。",

        "### 7. 待分析文本片段 (Text Chunk):",
        "[TEXT_CHUNK]",

        "### 8. 輸出 (JSON):"
    ],
    "injection_placeholders": {
        "INJECT_ENTITY_LIST": "用於插入所有合併後的實體類別名稱列表。",
        "INJECT_RELATIONSHIP_LIST": "用於插入所有合併後的關係名稱列表。",
        "INJECT_JSON_SCHEMA": "用於插入由 Pydantic 模型動態生成的 JSON Schema。",
        "TEXT_CHUNK": "待分析的文檔內容片段。"
    },
    "extraction_example_slot": {
        "enabled": false,
        "description": "可選地，在這裡插入 Few-Shot 範例來提高特定任務的準確性。啟用時，LangChain Agent 應將範例插入到 '### 7. 待分析文本片段' 之前。"
    },
    "model_parameters": {
        "recommended": {
            "temperature": 0.0,
            "top_p": 0.9,
            "top_k": 40,
            "max_tokens": 512
        },
        "description": "建議的模型參數（可在服務層配置，不強制）"
    }
}
```

---

## 🔧 实现建议

### 1. 立即实现（高优先级）

- ✅ 更新 `kag/ontology/Prompt-Template.json`
- ✅ 添加裁决层说明
- ✅ 强化 JSON Schema 要求
- ✅ 添加分层说明和一致性提示

### 2. 后续优化（中优先级）

- ⚠️ 在后处理层实现基于 confidence 的过滤逻辑
- ⚠️ 创建模型参数配置文档
- ⚠️ 添加实体去重和一致性检查

### 3. 可选增强（低优先级）

- ⚠️ 扩展数据模型添加裁决字段（需要数据迁移）
- ⚠️ 实现完整的裁决层服务

---

## 📊 预期效果

### 改进点

1. **稳定性提升**: JSON Schema 强制性 → 减少解析错误
2. **质量提升**: 裁决层 → 减少错误三元组
3. **一致性提升**: 上下文一致性提示 → 减少重复节点
4. **可维护性提升**: 分层说明 → 便于后续扩展

### 风险控制

- ✅ 保持向后兼容（不强制修改数据模型）
- ✅ 渐进式实现（先 Prompt，后数据模型）
- ✅ 可配置参数（不硬编码）

---

## 🎯 总结

ChatGPT 的建议**整体非常优秀**，特别是：
- ✅ 裁决层设计（提高可控性）
- ✅ JSON Schema 强制性（提高稳定性）
- ✅ 分层说明（提高可维护性）

**我的建议**:
1. **立即实现** Prompt 模板优化（高优先级建议）
2. **渐进式实现**裁决层（先 Prompt，后数据模型）
3. **可配置化**模型参数（不硬编码）

这样可以在**保持向后兼容**的前提下，**显著提升 GraphRAG 的质量和稳定性**。

