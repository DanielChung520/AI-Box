# å­˜å‚¨æ¶æ„æ–‡æ¡£

**åˆ›å»ºæ—¥æœŸ**: 2025-12-29
**åˆ›å»ºäºº**: Daniel Chung
**æœ€åä¿®æ”¹æ—¥æœŸ**: 2025-12-29

**æ›´æ–°è®°å½•**ï¼š

- 2025-12-29ï¼šæ–‡æ¡£å·²åˆ›å»ºï¼ŒåŒ…å«å®Œæ•´çš„ SeaweedFS åŒæœåŠ¡éƒ¨ç½²æ¶æ„è¯´æ˜

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿° AI-Box ç³»ç»Ÿçš„å­˜å‚¨æ¶æ„ï¼ŒåŒ…æ‹¬ SeaweedFS åŒæœåŠ¡éƒ¨ç½²æ¶æ„ã€S3 å­˜å‚¨å®ç°å’Œé…ç½®è¯´æ˜ã€‚

---

## ğŸ—ï¸ å­˜å‚¨æ¶æ„è®¾è®¡

### åŒæœåŠ¡æ¶æ„

AI-Box ç³»ç»Ÿä½¿ç”¨ **SeaweedFS åŒæœåŠ¡éƒ¨ç½²æ¶æ„**ï¼Œåˆ†åˆ«ä¸º AI-Box å’Œ DataLake é¡¹ç›®æä¾›ç‹¬ç«‹çš„å­˜å‚¨æœåŠ¡ï¼š

1. **AI-Box SeaweedFS æœåŠ¡**ï¼šå­˜æ”¾ AI-Box é¡¹ç›®å†…çš„éç»“æ„åŒ–æ•°æ®
2. **DataLake SeaweedFS æœåŠ¡**ï¼šå­˜æ”¾ DataLake é¡¹ç›®çš„æ–‡ä»¶å¤‡ä»½æ•°æ®

**æ¶æ„ä¼˜åŠ¿**ï¼š

- âœ… **èŒè´£åˆ†ç¦»**ï¼šAI-Box å’Œ DataLake å„è‡ªç®¡ç†è‡ªå·±çš„å­˜å‚¨
- âœ… **ç‹¬ç«‹æ‰©å±•**ï¼šä¸¤ä¸ªæœåŠ¡å¯ä»¥æ ¹æ®å„è‡ªéœ€æ±‚ç‹¬ç«‹æ‰©å±•
- âœ… **æ•°æ®éš”ç¦»**ï¼šé¿å…ä¸¤ä¸ªé¡¹ç›®ä¹‹é—´çš„æ•°æ®æ··æ‚
- âœ… **çµæ´»éƒ¨ç½²**ï¼šå¯ä»¥æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©ä¸åŒçš„éƒ¨ç½²ç­–ç•¥

### å­˜å‚¨åç«¯æ”¯æŒ

ç³»ç»Ÿæ”¯æŒä¸¤ç§å­˜å‚¨åç«¯ï¼š

1. **æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ** (`LocalFileStorage`)ï¼šç”¨äºå¼€å‘å’Œæµ‹è¯•ç¯å¢ƒ
2. **S3/SeaweedFS** (`S3FileStorage`)ï¼šç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œæ”¯æŒ Kubernetes æ— çŠ¶æ€æ‰©å±•

---

## ğŸ”§ SeaweedFS æœåŠ¡é…ç½®

### AI-Box SeaweedFS æœåŠ¡

**æœåŠ¡åç§°**ï¼š`seaweedfs-ai-box`

**ä¸»è¦å­˜å‚¨å†…å®¹**ï¼š

- **æ²»ç†ç›¸å…³æ—¥å¿—**ï¼š
  - å®¡è®¡æ—¥å¿—ï¼ˆAppend-Onlyï¼‰
  - ç³»ç»Ÿæ—¥å¿—ï¼ˆAppend-Onlyï¼‰
- **ç‰ˆæœ¬å†å²è®°å½•**ï¼šé…ç½®å’Œ Ontology çš„å†å²ç‰ˆæœ¬ï¼ˆAppend-Onlyï¼‰
- **å˜æ›´ææ¡ˆ**ï¼šå˜æ›´ææ¡ˆè®°å½•ï¼ˆAppend-Onlyï¼‰
- **DataLake å…ƒæ•°æ®**ï¼š
  - Data Agent ä¿å­˜çš„ DataLake dictionary å®šä¹‰
  - Data Agent ä¿å­˜çš„ DataLake schema å®šä¹‰
- **AI-Box é¡¹ç›®å…¶ä»–éç»“æ„åŒ–æ•°æ®**

**Buckets**ï¼š

- `bucket-governance-logs`ï¼šæ²»ç†ç›¸å…³æ—¥å¿—
- `bucket-version-history`ï¼šç‰ˆæœ¬å†å²è®°å½•
- `bucket-change-proposals`ï¼šå˜æ›´ææ¡ˆè®°å½•
- `bucket-datalake-dictionary`ï¼šDataLake dictionary å®šä¹‰
- `bucket-datalake-schema`ï¼šDataLake schema å®šä¹‰
- `bucket-ai-box-assets`ï¼šAI-Box é¡¹ç›®å…¶ä»–éç»“æ„åŒ–æ•°æ®

**ç¯å¢ƒå˜é‡é…ç½®**ï¼š

```bash
AI_BOX_SEAWEEDFS_S3_ENDPOINT=http://seaweedfs-ai-box-filer:8333
AI_BOX_SEAWEEDFS_S3_ACCESS_KEY=...
AI_BOX_SEAWEEDFS_S3_SECRET_KEY=...
AI_BOX_SEAWEEDFS_USE_SSL=false
AI_BOX_SEAWEEDFS_FILER_ENDPOINT=http://seaweedfs-ai-box-filer:8888
```

### DataLake SeaweedFS æœåŠ¡

**æœåŠ¡åç§°**ï¼š`seaweedfs-datalake`

**ä¸»è¦å­˜å‚¨å†…å®¹**ï¼š

- æ–‡ä»¶å¤‡ä»½æ•°æ®
- DataLake é¡¹ç›®ç›¸å…³çš„å­˜å‚¨éœ€æ±‚

**Buckets**ï¼š

- `bucket-file-backups`ï¼šæ–‡ä»¶å¤‡ä»½æ•°æ®
- `bucket-datalake-assets`ï¼šDataLake é¡¹ç›®ç›¸å…³å­˜å‚¨éœ€æ±‚

**ç¯å¢ƒå˜é‡é…ç½®**ï¼š

```bash
DATALAKE_SEAWEEDFS_S3_ENDPOINT=http://seaweedfs-datalake-filer:8333
DATALAKE_SEAWEEDFS_S3_ACCESS_KEY=...
DATALAKE_SEAWEEDFS_S3_SECRET_KEY=...
DATALAKE_SEAWEEDFS_USE_SSL=false
DATALAKE_SEAWEEDFS_FILER_ENDPOINT=http://seaweedfs-datalake-filer:8888
```

---

## ğŸ’» ä»£ç å®ç°

### S3FileStorage ç±»

`S3FileStorage` ç±»å®ç°äº† `FileStorage` æŠ½è±¡æ¥å£ï¼Œä½¿ç”¨ `boto3` è¿æ¥ SeaweedFS S3 APIã€‚

**ä¸»è¦åŠŸèƒ½**ï¼š

- æ–‡ä»¶ä¸Šä¼ ã€ä¸‹è½½ã€åˆ é™¤
- Bucket è‡ªåŠ¨åˆ›å»º
- æ”¯æŒ task_id ç»„ç»‡æ–‡ä»¶è·¯å¾„
- æ”¯æŒåŒæœåŠ¡é€‰æ‹©ï¼ˆAI-Box vs DataLakeï¼‰
- é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```python
from storage.s3_storage import S3FileStorage, SeaweedFSService

# åˆ›å»º AI-Box æœåŠ¡çš„å­˜å‚¨å®ä¾‹
storage = S3FileStorage(
    endpoint="http://seaweedfs-ai-box-filer:8333",
    access_key="your-access-key",
    secret_key="your-secret-key",
    service_type=SeaweedFSService.AI_BOX,
)

# ä¿å­˜æ–‡ä»¶
file_id, s3_uri = storage.save_file(
    file_content=b"file content",
    filename="test.txt",
)

# è¯»å–æ–‡ä»¶
content = storage.read_file(file_id=file_id)
```

### é…ç½®åˆ›å»ºå­˜å‚¨å®ä¾‹

ä½¿ç”¨ `create_storage_from_config` å‡½æ•°ä»é…ç½®åˆ›å»ºå­˜å‚¨å®ä¾‹ï¼š

```python
from storage.file_storage import create_storage_from_config

# ä»é…ç½®åˆ›å»ºï¼ˆæ”¯æŒç¯å¢ƒå˜é‡å’Œé…ç½®æ–‡ä»¶ï¼‰
config = {
    "storage_backend": "s3",
    "service_type": "ai_box",  # æˆ– "datalake"
}

storage = create_storage_from_config(config, service_type="ai_box")
```

**é…ç½®ä¼˜å…ˆçº§**ï¼š

1. å‡½æ•°å‚æ•°ï¼ˆ`service_type`ï¼‰
2. é…ç½®æ–‡ä»¶ï¼ˆ`config["service_type"]`ï¼‰
3. ç¯å¢ƒå˜é‡ï¼ˆæ ¹æ®æœåŠ¡ç±»å‹é€‰æ‹©å¯¹åº”çš„ç¯å¢ƒå˜é‡ï¼‰
4. é»˜è®¤å€¼ï¼ˆAI-Box æœåŠ¡ï¼‰

---

## ğŸš€ éƒ¨ç½²æŒ‡å—

### Kubernetes éƒ¨ç½²

SeaweedFS æœåŠ¡é€šè¿‡ Kubernetes éƒ¨ç½²ï¼ŒåŒ…æ‹¬ä»¥ä¸‹ç»„ä»¶ï¼š

1. **Master èŠ‚ç‚¹**ï¼šç®¡ç†å…ƒæ•°æ®å’Œ Volume èŠ‚ç‚¹
2. **Volume èŠ‚ç‚¹**ï¼šå­˜å‚¨å®é™…æ•°æ®
3. **Filer èŠ‚ç‚¹**ï¼šæä¾›æ–‡ä»¶ç³»ç»Ÿæ¥å£å’Œ S3 API

**éƒ¨ç½²æ–‡ä»¶ä½ç½®**ï¼š

- `k8s/seaweedfs-ai-box/`ï¼šAI-Box æœåŠ¡éƒ¨ç½²é…ç½®
- `k8s/seaweedfs-datalake/`ï¼šDataLake æœåŠ¡éƒ¨ç½²é…ç½®

### Buckets åˆ›å»º

ä½¿ç”¨ `scripts/migration/create_seaweedfs_buckets.py` è„šæœ¬åˆ›å»ºæ‰€æœ‰å¿…è¦çš„ Bucketsï¼š

```bash
# åˆ›å»ºæ‰€æœ‰ Bucketsï¼ˆAI-Box å’Œ DataLakeï¼‰
python scripts/migration/create_seaweedfs_buckets.py --service all

# åªåˆ›å»º AI-Box æœåŠ¡çš„ Buckets
python scripts/migration/create_seaweedfs_buckets.py --service ai_box

# åªåˆ›å»º DataLake æœåŠ¡çš„ Buckets
python scripts/migration/create_seaweedfs_buckets.py --service datalake

# ä¹¾é‹è¡Œæ¨¡å¼ï¼ˆä¸å¯¦éš›å‰µå»ºï¼‰
python scripts/migration/create_seaweedfs_buckets.py --service all --dry-run
```

---

## ğŸ“ å¼€å‘æŒ‡å—

### ç¯å¢ƒé…ç½®

1. **å¤åˆ¶ç¯å¢ƒå˜é‡ç¤ºä¾‹æ–‡ä»¶**ï¼š

   ```bash
   cp env.example .env
   ```

2. **é…ç½® SeaweedFS è¿æ¥ä¿¡æ¯**ï¼š
   ç¼–è¾‘ `.env` æ–‡ä»¶ï¼Œè®¾ç½® AI-Box å’Œ DataLake æœåŠ¡çš„ SeaweedFS é…ç½®ã€‚

3. **éªŒè¯é…ç½®**ï¼š
   ç¡®ä¿æ‰€æœ‰å¿…è¦çš„ç¯å¢ƒå˜é‡éƒ½å·²è®¾ç½®ã€‚

### ä»£ç ä½¿ç”¨

1. **å¯¼å…¥å­˜å‚¨æ¨¡å—**ï¼š

   ```python
   from storage import S3FileStorage, SeaweedFSService
   from storage.file_storage import create_storage_from_config
   ```

2. **åˆ›å»ºå­˜å‚¨å®ä¾‹**ï¼š

   ```python
   # æ–¹å¼ä¸€ï¼šç›´æ¥åˆ›å»º
   storage = S3FileStorage(
       endpoint=os.getenv("AI_BOX_SEAWEEDFS_S3_ENDPOINT"),
       access_key=os.getenv("AI_BOX_SEAWEEDFS_S3_ACCESS_KEY"),
       secret_key=os.getenv("AI_BOX_SEAWEEDFS_S3_SECRET_KEY"),
       service_type=SeaweedFSService.AI_BOX,
   )

   # æ–¹å¼äºŒï¼šä»é…ç½®åˆ›å»º
   config = get_config_section("file_upload", default={}) or {}
   storage = create_storage_from_config(config, service_type="ai_box")
   ```

3. **ä½¿ç”¨å­˜å‚¨æ¥å£**ï¼š

   ```python
   # ä¿å­˜æ–‡ä»¶
   file_id, s3_uri = storage.save_file(
       file_content=content,
       filename="example.txt",
       task_id="task-123",  # å¯é€‰
   )

   # è¯»å–æ–‡ä»¶
   content = storage.read_file(file_id=file_id)

   # åˆ é™¤æ–‡ä»¶
   success = storage.delete_file(file_id=file_id)

   # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
   exists = storage.file_exists(file_id=file_id)
   ```

---

## ğŸ” æµ‹è¯•

### å•å…ƒæµ‹è¯•

è¿è¡Œå­˜å‚¨æ¨¡å—çš„å•å…ƒæµ‹è¯•ï¼š

```bash
# è¿è¡Œæ‰€æœ‰å­˜å‚¨æµ‹è¯•
pytest tests/storage/

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
pytest tests/storage/test_s3_storage.py

# è¿è¡Œç‰¹å®šæµ‹è¯•ç”¨ä¾‹
pytest tests/storage/test_s3_storage.py::TestS3FileStorage::test_save_file
```

### é›†æˆæµ‹è¯•

åœ¨é›†æˆæµ‹è¯•ä¸­ï¼Œç¡®ä¿ SeaweedFS æœåŠ¡å¯ç”¨ï¼Œå¹¶é…ç½®æ­£ç¡®çš„ç¯å¢ƒå˜é‡ã€‚

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [èµ„æ–™å­˜å‚¨æ¶æ„é‡æ„åˆ†æä¸è®¡åˆ’](../è³‡æ–™å­˜å„²æ¶æ§‹é‡æ§‹åˆ†æèˆ‡è¨ˆåŠƒ.md)
- [èµ„æ–™æ¶æ„å»ºè®®æŠ¥å‘Š](../è³‡æ–™æ¶æ„å»ºè®®æŠ¥å‘Š.md)
- [ç³»ç»Ÿè®¾è®¡æ–‡æ¡£ä¸»README](../README.md)

---

**æœ€åæ›´æ–°æ—¥æœŸ**: 2025-12-29
