# Cloudflare MCP Gateway é–‹ç™¼ç’°å¢ƒéƒ¨ç½²ç‹€æ…‹å ±å‘Š

**åˆ›å»ºæ—¥æœŸ**: 2025-12-31
**åˆ›å»ºäºº**: Daniel Chung
**æœ€åä¿®æ”¹æ—¥æœŸ**: 2025-12-31

---

## âœ… å·²å®Œæˆçš„æ“ä½œ

### 1. åŸºç¡€è®¾ç½®

- âœ… Cloudflare è´¦æˆ·å·²ç™»å½• (Daniels89)
- âœ… Wrangler CLI å·²å®‰è£…å¹¶ç™»å½• (v4.54.0)
- âœ… Worker é¡¹ç›®å·²åˆ›å»º

### 2. KV å‘½åç©ºé—´

æ‰€æœ‰ KV å‘½åç©ºé—´å·²åˆ›å»ºï¼š

| å‘½åç©ºé—´ | ç”Ÿäº§ç¯å¢ƒ ID | é¢„è§ˆç¯å¢ƒ ID |
|---------|------------|------------|
| AUTH_STORE | `5b6e229c21f649269e93db9dcb8a7e16` | `b1295b79c8f64b879d5d7a3fd8c65400` |
| PERMISSIONS_STORE | `75e2e224e5844e1ea7639094b87d1001` | `89d30fa67fc944e0a5bce820c2b6b4b3` |
| RATE_LIMIT_STORE | `e5b99f78db7c452aa70a080b662e0530` | `437f52b27010407ab1730f85d89d835a` |

### 3. Gateway Secret

- âœ… å·²ç”Ÿæˆ: `0d28bdb881c5aeea501bf535b45c153ea78bf6f28b4856a41e36068dfbf7410e`
- âœ… å·²è®¾ç½®åˆ° Cloudflare Worker Secrets

### 4. Worker éƒ¨ç½²

- âœ… Worker åç§°: `mcp-gateway`
- âœ… Workers.dev URL: `https://mcp-gateway.896445070.workers.dev`
- âœ… ç‰ˆæœ¬ ID: `cc1088a1-2f2c-4530-bc25-cdddb66a9b9f`
- âœ… éƒ¨ç½²çŠ¶æ€: å·²æˆåŠŸéƒ¨ç½²

### 5. é…ç½®æ–‡ä»¶

- âœ… `wrangler.toml` å·²æ›´æ–°æ‰€æœ‰ KV å‘½åç©ºé—´ ID
- âœ… åŸŸåè·¯ç”±å·²é…ç½®: `mcp.k84.org`

---

## â¸ï¸ å¾…å®Œæˆçš„æ“ä½œ

### 1. DNS é…ç½®ï¼ˆå¿…é¡»æ‰‹åŠ¨ï¼‰

**æ“ä½œä½ç½®**: Cloudflare Dashboard â†’ k84.org â†’ DNS â†’ Records

**æ“ä½œæ­¥éª¤**:

1. ç™»å½• Cloudflare Dashboard
2. é€‰æ‹©åŸŸå `k84.org`
3. è¿›å…¥ "DNS" â†’ "Records"
4. æ·»åŠ  CNAME è®°å½•ï¼š
   - **Type**: CNAME
   - **Name**: `mcp`
   - **Target**: `mcp-gateway.896445070.workers.dev`
   - **Proxy status**: Proxiedï¼ˆæ©™è‰²äº‘æœµå›¾æ ‡ï¼‰
5. ç‚¹å‡» "Save"

**å®Œæˆå**: å¯ä»¥é€šè¿‡ `https://mcp.k84.org` è®¿é—® Gateway

---

### 2. AI-Box ç¯å¢ƒå˜é‡é…ç½®ï¼ˆå¿…é¡»æ‰‹åŠ¨ï¼‰

**æ“ä½œä½ç½®**: AI-Box é¡¹ç›®æ ¹ç›®å½•çš„ `.env` æ–‡ä»¶

**æ“ä½œæ­¥éª¤**:

```bash
# åœ¨ AI-Box é¡¹ç›®æ ¹ç›®å½•
echo "MCP_GATEWAY_SECRET=0d28bdb881c5aeea501bf535b45c153ea78bf6f28b4856a41e36068dfbf7410e" >> .env
echo "MCP_GATEWAY_ENDPOINT=https://mcp.k84.org" >> .env
# æˆ–å¦‚æœ DNS è¿˜æœªé…ç½®ï¼Œå…ˆä½¿ç”¨ workers.dev URL:
# echo "MCP_GATEWAY_ENDPOINT=https://mcp-gateway.896445070.workers.dev" >> .env
```

---

### 3. R2 å­˜å‚¨æ¡¶ï¼ˆå¯é€‰ï¼Œç”¨äºå®¡è®¡æ—¥å¿—ï¼‰

**æ“ä½œä½ç½®**: Cloudflare Dashboard â†’ R2

**æ“ä½œæ­¥éª¤**:

1. ç™»å½• Cloudflare Dashboard
2. è¿›å…¥ "R2"
3. å¦‚æœæç¤ºå¯ç”¨ R2ï¼Œç‚¹å‡» "Enable R2"
4. ç‚¹å‡» "Create bucket"
5. è¾“å…¥å­˜å‚¨æ¡¶åç§°: `mcp-gateway-audit-logs`
6. é€‰æ‹©ä½ç½®ï¼ˆæ¨èé€‰æ‹©ç¦»ä½ æœ€è¿‘çš„åŒºåŸŸï¼‰
7. ç‚¹å‡» "Create bucket"
8. åˆ›å»ºé¢„è§ˆå­˜å‚¨æ¡¶: `mcp-gateway-audit-logs-preview`

**å®Œæˆå**: æ›´æ–° `wrangler.toml`ï¼Œå–æ¶ˆæ³¨é‡Š R2 é…ç½®éƒ¨åˆ†

---

### 4. é…ç½®å¤–éƒ¨ MCP è®¤è¯ï¼ˆæŒ‰éœ€ï¼‰

**æ“ä½œä½ç½®**: æœ¬åœ°ç»ˆç«¯ï¼ˆåœ¨ Gateway é¡¹ç›®ç›®å½•ï¼‰

**æ“ä½œæ­¥éª¤**:

```bash
cd /Users/daniel/GitHub/AI-Box/mcp/gateway

# ç¤ºä¾‹ï¼šé…ç½® Yahoo Finance MCPï¼ˆæ— è®¤è¯ï¼‰
wrangler kv key put "auth:yahoo_finance_quote" \
  '{"type":"none"}' \
  --namespace-id=5b6e229c21f649269e93db9dcb8a7e16

# ç¤ºä¾‹ï¼šé…ç½® Office MCPï¼ˆAPI Key è®¤è¯ï¼‰
# é¦–å…ˆè®¾ç½® API Key Secret:
wrangler secret put OFFICE_API_KEY
# ç„¶åé…ç½®è®¤è¯:
wrangler kv key put "auth:office_word" \
  '{"type":"api_key","api_key":"${OFFICE_API_KEY}","header_name":"X-API-Key"}' \
  --namespace-id=5b6e229c21f649269e93db9dcb8a7e16
```

---

### 5. é…ç½®ç”¨æˆ·æƒé™ï¼ˆæŒ‰éœ€ï¼‰

**æ“ä½œä½ç½®**: æœ¬åœ°ç»ˆç«¯ï¼ˆåœ¨ Gateway é¡¹ç›®ç›®å½•ï¼‰

**æ“ä½œæ­¥éª¤**:

```bash
cd /Users/daniel/GitHub/AI-Box/mcp/gateway

# ç¤ºä¾‹ï¼šé…ç½®ç”¨æˆ·æƒé™
wrangler kv key put "permissions:tenant-456:user-123" \
  '{"tools":["finance_*","office_readonly_*"],"rate_limits":{"default":100}}' \
  --namespace-id=75e2e224e5844e1ea7639094b87d1001
```

---

## ğŸ§ª æµ‹è¯• Gateway

### æµ‹è¯• Workers.dev URL

```bash
curl -X POST https://mcp-gateway.896445070.workers.dev \
  -H "Content-Type: application/json" \
  -H "X-Gateway-Secret: 0d28bdb881c5aeea501bf535b45c153ea78bf6f28b4856a41e36068dfbf7410e" \
  -H "X-User-ID: test-user" \
  -H "X-Tenant-ID: test-tenant" \
  -H "X-Tool-Name: test_tool" \
  -d '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "tools/list"
  }'
```

### æµ‹è¯•è‡ªå®šä¹‰åŸŸåï¼ˆDNS é…ç½®åï¼‰

```bash
curl -X POST https://mcp.k84.org \
  -H "Content-Type: application/json" \
  -H "X-Gateway-Secret: 0d28bdb881c5aeea501bf535b45c153ea78bf6f28b4856a41e36068dfbf7410e" \
  -H "X-User-ID: test-user" \
  -H "X-Tenant-ID: test-tenant" \
  -H "X-Tool-Name: test_tool" \
  -d '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "tools/list"
  }'
```

---

## ğŸ“ é‡è¦ä¿¡æ¯

### Gateway Secret

- **å€¼**: `0d28bdb881c5aeea501bf535b45c153ea78bf6f28b4856a41e36068dfbf7410e`
- **ç”¨é€”**: AI-Box å’Œ Gateway ä¹‹é—´çš„è®¤è¯
- **å¿…é¡»**: åœ¨ AI-Box çš„ `.env` æ–‡ä»¶ä¸­é…ç½®

### Worker URLs

- **Workers.dev**: `https://mcp-gateway.896445070.workers.dev`
- **è‡ªå®šä¹‰åŸŸå**: `https://mcp.k84.org` (å¾… DNS é…ç½®)

### KV å‘½åç©ºé—´ ID

- æ‰€æœ‰ ID å·²é…ç½®åœ¨ `wrangler.toml` ä¸­
- ç”¨äºå­˜å‚¨è®¤è¯é…ç½®ã€æƒé™é…ç½®å’Œé€Ÿç‡é™åˆ¶æ•°æ®

---

## ğŸ”„ åç»­ç»´æŠ¤

### æ›´æ–° Worker

```bash
cd /Users/daniel/GitHub/AI-Box/mcp/gateway
wrangler deploy
```

### æŸ¥çœ‹æ—¥å¿—

```bash
wrangler tail mcp-gateway
```

### æ›´æ–° Gateway Secret

```bash
# ç”Ÿæˆæ–°å¯†é’¥
openssl rand -hex 32

# è®¾ç½®åˆ° Worker
echo "æ–°å¯†é’¥" | wrangler secret put GATEWAY_SECRET

# åŒæ—¶æ›´æ–° AI-Box çš„ .env æ–‡ä»¶
```

---

**æœ€åæ›´æ–°æ—¥æœŸ**: 2025-12-31
**ç»´æŠ¤äºº**: Daniel Chung
