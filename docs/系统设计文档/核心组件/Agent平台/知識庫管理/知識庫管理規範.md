# 知識庫管理規範

> **文件狀態**: 工程開發規範  
> **文檔版本**: v1.0.0  
> **最後更新**: 2026-02-16  
> **維護人**: Daniel Chung  
> **對齊系統**: AI-Box Knowledge Base Management v2.0

---

## 1. 概述

本文檔定義 AI-Box 知識庫管理的核心規範，確保知識調用的安全性與一致性。

### 1.1 設計原則

根據 [KA-Agent 規格書](./KA-Agent/KA-Agent-規格書.md) 的設計原則：

1. **Knowledge is not memory**：知識是平台級資產，不屬於任何單一 Agent
2. **Assets over documents**：以 Knowledge Base 為治理單位，而非原始文件
3. **Governance before retrieval**：所有檢索操作必須先通過安全審計
4. **Unified Retrieval**：所有 Agent（Chat、MM-Agent 等）統一通過 KA-Agent 進行知識檢索

---

## 2. 知識調用優先級

AI-Box 知識調用必須遵循以下優先級順序：

| 優先級 | 來源 | 說明 | 實現狀態 |
|--------|------|------|----------|
| **1** | KA-Agent | 統一知識檢索入口，進行安全審計與權限控制 | ✅ 已實現 |
| **2** | LLM 內部知識 | 模型本身的知識庫（如 GPT 的訓練知識） | ✅ 原生支持 |
| **3** | 網絡搜索 | 當 KA-Agent 和 LLM 都無法找到答案時的 fallback | ⚠️ 待實現 |

### 2.1 優先級說明

1. **KA-Agent 優先**：所有知識檢索請求必須先通過 KA-Agent，確保：
   - 知識庫存取權限控制
   - 審計日誌記錄
   - 來源追溯（Provenance）

2. **LLM 知識次之**：當 KA-Agent 無法提供答案時，使用 LLM 本身的訓練知識

3. **網絡搜索最後**：僅當前兩者都無法回答時，才進行網絡搜索

---

## 3. 架構設計

### 3.1 統一檢索流程

```
用戶查詢
    │
    ▼
┌─────────────────────────────────────────┐
│           Chat API (chat.py)            │
│  - 意圖分類                             │
│  - Agent 選擇                           │
└─────────────────────────────────────────┘
    │
    ├── [選擇特定 Agent 時]
    │       │
    │       ▼
    │   ┌─────────────────────┐
    │   │  Agent 處理流程    │
    │   │  (如 MM-Agent)     │
    │   └─────────────────────┘
    │           │
    │           ▼ [需要知識時]
    │   ┌─────────────────────┐
    │   │  knowledge_service │ → KA-Agent
    │   │  (統一知識服務)     │   (安全審計)
    │   └─────────────────────┘           │
    │           │                         ▼
    │           ▼               ┌─────────────────────┐
    │   ┌─────────────────┐     │  知識庫檢索        │
    │   │  返回結果並組裝  │     │  (Qdrant + ArangoDB)│
    │   └─────────────────┘     └─────────────────────┘
    │           │                         │
    │           ◄─────────────────────────┘
    ▼
LLM 生成回覆
```

### 3.2 組件職責

| 組件 | 職責 | 位置 |
|------|------|------|
| **Chat API** | 接收用戶請求，進行意圖分類與 Agent 路由 | `api/routers/chat.py` |
| **MM-Agent** | 處理特定領域的業務邏輯 | `agents/builtin/` |
| **knowledge_service** | 統一知識服務接口，包裝 KA-Agent 調用 | Agent 內部實現 |
| **KA-Agent** | 統一知識檢索入口，安全審計，權限控制 | `agents/builtin/ka_agent/` |
| **知識庫存儲** | Qdrant（向量）+ ArangoDB（图） | `database/` |

---

## 4. 實現規範

### 4.1 Agent 實現要求

所有需要進行知識檢索的 Agent 必須：

1. **不得直接調用知識庫 API**：禁止直接調用 `knowledge-bases/*` API
2. **必須通過 knowledge_service**：調用統一的知識服務接口
3. **必須攜帶上下文信息**：傳遞 user_id、session_id 用於權限審計

### 4.2 MM-Agent 實現示例

```python
# ✅ 正確：通過 knowledge_service 調用 KA-Agent
from agents.builtin.ka_agent.agent import KnowledgeArchitectAgent

class MaterialManagementAgent:
    async def process(self, instruction: str, context: Dict):
        # 知識檢索必須通過 KA-Agent
        ka_agent = KnowledgeArchitectAgent()
        kb_results = await ka_agent.retrieve(
            query=instruction,
            user_id=context["user_id"],
            knowledge_bases=context.get("knowledge_bases", []),
        )
        
        # 使用檢索結果組裝 prompt
        prompt = self._build_prompt(instruction, kb_results)
        
        # 調用 LLM 生成回覆
        llm_response = await self.llm.chat(prompt)
        
        return llm_response


# ❌ 錯誤：直接調用知識庫 API
async def retrieve_knowledge(query: str, kb_ids: List[str]):
    # 禁止直接調用 API
    response = await httpx.get(
        f"http://localhost:8000/api/v1/knowledge-bases/{kb_id}/query"
    )
```

### 4.3 Chat API 實現要求

```python
# ✅ 正確：MM-Agent 統一通過 KA-Agent 調用知識庫
# chat.py 中的實現

# 1. 檢測是否需要轉發給 MM-Agent
if user_selected_agent_id == "mm-agent":
    # 2. 轉發給 MM-Agent（由 MM-Agent 內部通過 KA-Agent 處理知識）
    mm_response = await forward_to_mm_agent(request)
    return mm_response

# 3. 知識庫統計查詢（特例：僅返回元數據）
if _is_knowledge_base_stats_query(query):
    kb_stats = await _handle_knowledge_base_query(...)
    return kb_stats


# ❌ 錯誤：chat.py 直接處理知識庫檢索
if user_selected_agent_id == "mm-agent":
    # 禁止在此處直接調用知識庫
    kb_response = await _handle_knowledge_base_query(...)
```

---

## 5. 安全與審計

### 5.1 權限控制

- **用戶級權限**：知識庫按照用戶/租戶隔離
- **Agent 級權限**：Agent 配置的 `knowledge_bases` 列表限定檢索範圍
- **KA-Agent 特殊權限**：KA-Agent 為知識管理員，對所有已上架知識有權限

### 5.2 審計日誌

所有知識檢索操作必須記錄：

| 欄位 | 說明 |
|------|------|
| timestamp | 檢索時間 |
| user_id | 用戶 ID |
| agent_id | 調用 Agent ID |
| query | 檢索內容 |
| knowledge_bases | 使用的知識庫列表 |
| result_count | 返回結果數量 |
| latency_ms | 檢索耗時 |

---

## 5. MM-Agent 調用 KA-Agent 流程

### 5.1 核心概念

- **業務代理（MM-Agent）**：處理特定領域業務邏輯的代理（如經寶物料管理代理）
- **知識服務代理（KA-Agent）**：統一提供知識檢索服務
- **調用模式**：業務代理主動提需求 → KA-Agent 根據 caller_agent_key 授權檢索

### 5.2 完整流程

```
用戶在 AI-Box 輸入查詢
    │
    ▼
AI-Box 進行意圖分類
    │
    ├── [選擇業務代理：如 MM-Agent]
    │       │
    │       ▼
    │   查詢 agent_display_configs._key (如 "-h0tjyh")
    │       │
    │       ▼
    │   取得 endpoint_url (如 http://localhost:8003/api/v1/chat/auto-execute)
    │       │
    │       ▼
    │   轉發任務給 MM-Agent
    │       │
    │       ▼
    │   MM-Agent 處理業務邏輯
    │       │
    │       ├── [需要知識庫時]
    │       │       │
    │       │       ▼
    │       │   MM-Agent 調用 KA-Agent
    │       │       │
    │       │       ├── 傳遞 caller_agent_key = "-h0tjyh"
    │       │       │         (MM-Agent 的 arangodb_key)
    │       │       │
    │       │       ▼
    │       │   KA-Agent 授權檢索
    │       │       │
    │       │       ├── 根據 agent_key 查詢 knowledge_bases
    │       │       │
    │       │       ├── 比對 file_metadata.knowledge_base_id
    │       │       │
    │       │       ▼
    │       │   HybridRAG 檢索與組織
    │       │       │
    │       │       ├── 向量檢索 (Qdrant)
    │       │       │
    │       │       ├── 圖譜檢索 (ArangoDB)
    │       │       │
    │       │       ├── 重排序與組裝
    │       │       │
    │       │       ▼
    │       │   返回組織好的知識回覆
    │       │
    │       ▼
    │   MM-Agent 使用知識組裝回覆
    │
    ▼
AI-Box 返回最終回覆
```

### 5.3 API 調用示例

**Step 1: AI-Box 轉發給 MM-Agent**

```python
# chat.py
agent_config = store.get_agent_config(agent_key="-h0tjyh")
mm_endpoint = agent_config.endpoint_url  # http://localhost:8003/api/v1/chat/auto-execute

# 轉發任務
response = httpx.post(mm_endpoint, json={
    "instruction": "查詢料號庫存",
    "session_id": "..."
})
```

**Step 2: MM-Agent 調用 KA-Agent**

```python
# MM-Agent 內部
# 當需要知識庫時，調用 KA-Agent

ka_request = {
    "query": "料號庫存查詢方式",
    "agent_id": "ka-agent",
    "user_id": "user_123",
    "metadata": {
        "caller_agent_key": "-h0tjyh",  # MM-Agent 的 arangodb_key
        "caller_agent_id": "mm-agent"
    },
    "options": {
        "top_k": 5,
        "include_graph": True
    }
}

# KA-Agent 處理
# 1. 從 metadata 獲取 caller_agent_key = "-h0tjyh"
# 2. 調用 kb_auth_service.get_authorized_files(agent_key="-h0tjyh")
# 3. 只檢索授權的 5 份文件

# 4. HybridRAG 檢索與組織
#    - 向量檢索 (Qdrant)
#    - 圖譜檢索 (ArangoDB)  
#    - 重排序與組裝

# 5. 返回組織好的知識回覆
ka_response = {
    "success": True,
    "results": [
        {
            "content": "料號庫存查詢方式如下：\n1. 登入 TIPTOP ERP 系統\n2. 進入庫存管理模組\n3. 使用庫存查詢功能...",
            "source": "物料管理員專業知識.md",
            "score": 0.95
        },
        {
            "content": "TIPTOP ERP 庫存模組操作手冊第 3 章...",
            "source": "鼎捷TIPTOP ERP全套操作参考手册.pdf",
            "score": 0.88
        }
    ],
    "total": 2,
    "query_time_ms": 45
}

# MM-Agent 使用組織好的知識組裝回覆
```

### 5.4 權限檢查點

| 檢查點 | 位置 | 說明 |
|--------|------|------|
| 1 | AI-Box Chat API | 驗證 user 權限，選擇合適的代理 |
| 2 | MM-Agent | 處理業務邏輯，判斷是否需要知識 |
| 3 | KA-Agent | 根據 caller_agent_key 驗證知識庫權限 |
| 4 | 向量檢索 | 只檢索授權的檔案 |

### 5.5 授權查詢與 HybridRAG

```python
# KA-Agent 內部使用 kb_auth_service + HybridRAG
from services.api.services.kb_auth_service import get_kb_auth_service

svc = get_kb_auth_service()

# 根據 caller_agent_key 獲取授權的 KB
kb_ids = get_agent_knowledge_bases(agent_key="-h0tjyh")
# 返回: ["root_Material_Management_1770989092"]

# 根據 caller_agent_key 獲取授權的檔案
file_ids = get_authorized_file_ids(agent_key="-h0tjyh")
# 返回: 5 個授權的 file_id

# HybridRAG 檢索結果格式
hybrid_rag_result = {
    "results": [
        {
            "content": "組織好的知識內容...",
            "source": "文件名稱.md",
            "score": 0.95,
            "metadata": {"file_id": "...", "chunk_id": "..."}
        }
    ],
    "graph_results": [...],  # 圖譜檢索結果
    "total": 5,
    "query_time_ms": 120
}
```

---

## 6. 異常處理

### 6.1 知識庫不可用

當知識庫服務不可用時：

1. **記錄錯誤日誌**
2. **返回友好提示**：“目前無法訪問知識庫，請稍後再試”
3. **不 fallback 到網絡搜索**（除非明確需要）

### 6.2 知識庫為空

當用戶詢問知識庫內容但知識庫為空時：

1. **返回引導提示**：如 “知識庫中尚未有任何文件，請先上傳文件”
2. **不返回錯誤**：這是正常狀態，不是異常

---

## 7. 知識庫統計查詢（特例）

### 7.1 什麼是統計查詢

統計查詢是用戶明確詢問知識庫元數據的請求，例如：
- “知識庫有多少文件？”
- “文件列表是什麼？”
- “知識庫狀態如何？”

這些查詢**不涉及知識內容檢索**，因此：
- 可以直接調用 API 獲取統計數據
- 不需要通過 KA-Agent（因為不涉及檢索）
- 不消耗 LLM tokens

### 7.2 實現方式

```python
def _is_knowledge_base_stats_query(query: str) -> bool:
    """檢測是否為知識庫統計查詢"""
    stats_patterns = [
        r".*?(?:有多少|有幾個|幾個).*?(?:文件|檔案)",
        r"文件列表",
        r"文件統計",
        r".*?(?:上傳|向量化).*?(?:哪些|多少)",
        r"知識庫狀態",
    ]
    
    for pattern in stats_patterns:
        if re.match(pattern, query.lower()):
            return True
    return False


async def _handle_knowledge_base_query(...):
    """處理知識庫統計查詢（不通過 KA-Agent）"""
    # 直接調用 API 獲取文件數量、狀態等
    # 返回格式化的統計信息
```

---

## 8. 當前實現狀態

### 8.1 已實現

| 功能 | 說明 | 位置 |
|------|------|------|
| ✅ KA-Agent 統一入口 | 所有知識檢索通過 KA-Agent | `agents/builtin/ka_agent/` |
| ✅ MM-Agent 路由 | chat.py 轉發給 MM-Agent | `api/routers/chat.py` |
| ✅ 知識庫統計 | 直接 API 獲取統計數據 | `api/routers/chat.py` |
| ✅ 權限控制 | 基於 user_id 的知識庫隔離 | KA-Agent 內部實現 |
| ✅ 審計日誌 | 知識檢索審計軌跡 | KA-Agent 內部實現 |

### 8.2 待實現

| 功能 | 說明 | 優先級 |
|------|------|--------|
| ⚠️ 網絡搜索 fallback | 當 KA-Agent 和 LLM 都無法回答時的 fallback | 中 |
| ⚠️ 知識來源提示 | 在回覆中標註知識來源（KB/LLM/Web） | 低 |

---

## 9. 參考文檔

- [KA-Agent 規格書](./KA-Agent/KA-Agent-規格書.md)
- [KA-Agent 作業規範](./KA-Agent/知識庫/KA-Agent作業規範.md)
- [知識庫數據模型](./KA-Agent/KA-Agent-規格書.md#3-知識庫數據模型v20)
- [AI-Box 上下文管理架構說明](../AI-Box上下文管理架構說明.md)

---

## 10. 更新記錄

| 日期 | 版本 | 變更說明 |
|------|------|----------|
| 2026-02-16 | v1.0.0 | 初始版本 |
