# åº«ç®¡å“¡ Agent - Cloudflare Gateway è¨»å†Šé…ç½®æŒ‡å—

**å‰µå»ºæ—¥æœŸ**: 2026-01-14
**å‰µå»ºäºº**: Daniel Chung
**æœ€å¾Œä¿®æ”¹æ—¥æœŸ**: 2026-01-14 13:54 UTC+8

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æª”å®Œæ•´èªªæ˜å¦‚ä½•å°‡**åº«ç®¡å“¡ Agent** é€šé **Cloudflare MCP Gateway** èˆ‡ AI-Box ç³»çµ±é€šä¿¡ï¼ŒåŒ…å«å…©å€‹ä¸»è¦æ­¥é©Ÿï¼š

1. **ç¬¬ä¸€éƒ¨åˆ†ï¼šåœ¨ Cloudflare Gateway ä¸­è¨»å†Š** - é…ç½®è·¯ç”±ã€èªè­‰å’Œæ¬Šé™
2. **ç¬¬äºŒéƒ¨åˆ†ï¼šåœ¨ AI-Box ä¸­è¨»å†Š** - å°‡ Cloudflare Gateway ç«¯é»è¨»å†Šåˆ° AI-Box

### æ¶æ§‹èªªæ˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI-Boxï¼ˆAI æ“ä½œç³»çµ±ï¼‰                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Agent Orchestrator                               â”‚   â”‚
â”‚  â”‚  - è¨»å†Š Agentï¼ˆç«¯é»æŒ‡å‘ Cloudflare Gatewayï¼‰      â”‚   â”‚
â”‚  â”‚  - é€šé MCP Client èª¿ç”¨ Agent                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ MCP Protocol
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cloudflare MCP Gateway                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  - è·¯ç”±è¦å‰‡ï¼šwarehouse_* â†’ åº«ç®¡å“¡ Agent ç«¯é»      â”‚   â”‚
â”‚  â”‚  - èªè­‰ç®¡ç†ï¼ˆå¦‚éœ€è¦ï¼‰                             â”‚   â”‚
â”‚  â”‚  - è«‹æ±‚è½‰ç™¼                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ HTTP/HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº«ç®¡å“¡ Agentï¼ˆå¤–éƒ¨æœå‹™ï¼Œç«¯å£ 8003ï¼‰                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  MCP Server                                       â”‚   â”‚
â”‚  â”‚  - æ¥æ”¶ä¾†è‡ª Cloudflare Gateway çš„è«‹æ±‚            â”‚   â”‚
â”‚  â”‚  - è™•ç†åº«å­˜ç®¡ç†æ¥­å‹™é‚è¼¯                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é…ç½®æµç¨‹æ¦‚è¦½

**ç¬¬ä¸€éƒ¨åˆ†ï¼šåœ¨ Cloudflare Gateway ä¸­è¨»å†Š**

1. é…ç½® Cloudflare Gateway è·¯ç”± - æ·»åŠ åº«ç®¡å“¡ Agent è·¯ç”±è¦å‰‡
2. é…ç½® Cloudflare Gateway èªè­‰ï¼ˆå¦‚éœ€è¦ï¼‰- è¨­ç½® Agent èªè­‰ä¿¡æ¯
3. é…ç½® Cloudflare Gateway æ¬Šé™ï¼ˆå¦‚éœ€è¦ï¼‰- è¨­ç½®ç”¨æˆ¶/ç§Ÿæˆ¶æ¬Šé™
4. éƒ¨ç½²å’Œé©—è­‰ Gateway é…ç½®

**ç¬¬äºŒéƒ¨åˆ†ï¼šåœ¨ AI-Box ä¸­è¨»å†Š**

1. æäº¤ Agent è¨»å†Šç”³è«‹ï¼ˆé€šéå‰ç«¯æˆ– APIï¼‰
2. AI-Box å¯©æŸ¥ï¼ˆè‡ªå‹•å¯©æ ¸æˆ–äººå·¥å¯©æ ¸ï¼‰
3. ç³»çµ±ç™¼æ”¾ Secret ID/Key å°ï¼ˆå¯©æ ¸é€šéå¾Œï¼‰
4. ä½¿ç”¨ Secret è¨»å†Š Agentï¼ˆç«¯é»æŒ‡å‘ Cloudflare Gatewayï¼‰
5. ç®¡ç†å“¡æ ¸å‡† Agentï¼ˆç‹€æ…‹å¾ REGISTERING è½‰ç‚º ONLINEï¼‰
6. Runtime æˆæ¬Šæª¢æŸ¥èˆ‡å¯©è¨ˆæ—¥èªŒï¼ˆé‹è¡Œæ™‚ï¼‰

### å®Œæ•´è¨»å†Šèˆ‡æˆæ¬Šæµç¨‹åœ–

æ ¹æ“š ChatGPT å»ºè­°çš„æµç¨‹ï¼Œå®Œæ•´çš„è¨»å†Šèˆ‡æˆæ¬Šæµç¨‹å¦‚ä¸‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cloudflare MCP Gateway (ä¿¡ä»»é‚Šç•Œ)                      â”‚
â”‚  Agent é€šé Cloudflare Gateway æäº¤è¨»å†Šç”³è«‹              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI-Boxï¼ˆäº‹å‰è¨»å†Šèˆ‡æˆæ¬Šä¸­å¿ƒï¼‰                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. æ¥æ”¶ç”³è«‹                                       â”‚   â”‚
â”‚  â”‚ 2. å„²å­˜ç”³è«‹ Metadata                              â”‚   â”‚
â”‚  â”‚ 3. è‡ªå‹•å¯©æ ¸ï¼ˆä½é¢¨éšªï¼‰æˆ–äººå·¥å¯©æ ¸ï¼ˆé«˜é¢¨éšªï¼‰         â”‚   â”‚
â”‚  â”‚ 4. ç™¼æ”¾ API key / OAuth token / client cert       â”‚   â”‚
â”‚  â”‚ 5. æ›´æ–° Permission Store                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent è¨»å†Šéšæ®µ                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 6. ä½¿ç”¨ Secret è¨»å†Š Agent                         â”‚   â”‚
â”‚  â”‚ 7. ç‹€æ…‹ï¼šREGISTERINGï¼ˆç­‰å¾…ç®¡ç†å“¡æ ¸å‡†ï¼‰            â”‚   â”‚
â”‚  â”‚ 8. ç®¡ç†å“¡æ ¸å‡† â†’ ç‹€æ…‹ï¼šONLINE                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Runtime é‹è¡Œéšæ®µ                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 9. Agent ä½¿ç”¨ tool å‘¼å« AI-Box                    â”‚   â”‚
â”‚  â”‚ 10. Runtime æª¢æŸ¥æˆæ¬Š & é€Ÿç‡é™åˆ¶                   â”‚   â”‚
â”‚  â”‚ 11. è¨˜éŒ„å¯©è¨ˆæ—¥èªŒ                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æµç¨‹èªªæ˜**ï¼š

1. **ç”³è«‹éšæ®µ**ï¼šAgent é€šé Cloudflare Gateway æäº¤è¨»å†Šç”³è«‹
2. **å¯©æŸ¥éšæ®µ**ï¼šAI-Box æ¥æ”¶ç”³è«‹ã€å„²å­˜ Metadataã€é€²è¡Œè‡ªå‹•æˆ–äººå·¥å¯©æ ¸
3. **æ†‘è­‰ç™¼æ”¾**ï¼šå¯©æ ¸é€šéå¾Œï¼Œç³»çµ±ç™¼æ”¾ Secret ID/Key å°
4. **æ¬Šé™é…ç½®**ï¼šæ›´æ–° Permission Storeï¼Œé…ç½®ç”¨æˆ¶/ç§Ÿæˆ¶æ¬Šé™
5. **è¨»å†Šéšæ®µ**ï¼šAgent ä½¿ç”¨ Secret é€²è¡Œè¨»å†Šï¼Œç‹€æ…‹ç‚º `REGISTERING`
6. **æ ¸å‡†éšæ®µ**ï¼šç®¡ç†å“¡æ ¸å‡† Agentï¼Œç‹€æ…‹è½‰ç‚º `ONLINE`
7. **é‹è¡Œéšæ®µ**ï¼šRuntime æª¢æŸ¥æˆæ¬Šå’Œé€Ÿç‡é™åˆ¶ï¼Œè¨˜éŒ„å¯©è¨ˆæ—¥èªŒ

---

## ğŸ“Œ ç¬¬ä¸€éƒ¨åˆ†ï¼šåœ¨ Cloudflare Gateway ä¸­è¨»å†Š

æœ¬éƒ¨åˆ†èªªæ˜å¦‚ä½•åœ¨ Cloudflare Gateway ä¸­é…ç½®åº«ç®¡å“¡ Agent çš„è·¯ç”±ã€èªè­‰å’Œæ¬Šé™ï¼Œä½¿ Gateway èƒ½å¤ æ­£ç¢ºè·¯ç”±å’Œè™•ç†ä¾†è‡ª AI-Box çš„è«‹æ±‚ã€‚

---

## ğŸ”§ æ­¥é©Ÿ 1: é…ç½® Cloudflare Gateway è·¯ç”±

### 1.1 æ›´æ–° wrangler.toml

**æ–‡ä»¶ä½ç½®**: `mcp/gateway/wrangler.toml`

**æ“ä½œæ­¥é©Ÿ**:

1. ç·¨è¼¯ `wrangler.toml` æ–‡ä»¶
2. åœ¨ `MCP_ROUTES` ä¸­æ·»åŠ åº«ç®¡å“¡ Agent è·¯ç”±è¦å‰‡

**é…ç½®ç¤ºä¾‹**:

```toml
MCP_ROUTES = '''
[
  {
    "pattern": "yahoo_finance_*",
    "target": "https://smithery.ai/server/@tsmdev-ux/yahoo-finance-mcp"
  },
  {
    "pattern": "warehouse_*",
    "target": "http://your-warehouse-agent-host:8003/mcp"
  }
]
'''
```

**é…ç½®èªªæ˜**:

- **Pattern**: `warehouse_*` - åŒ¹é…æ‰€æœ‰ä»¥ `warehouse_` é–‹é ­çš„å·¥å…·åç¨±
- **Target**: åº«ç®¡å“¡ Agent çš„å¯¦éš› MCP ç«¯é» URL
  - æœ¬åœ°é–‹ç™¼: `http://localhost:8003/mcp`
  - å…§ç¶²éƒ¨ç½²: `http://192.168.1.100:8003/mcp`
  - å…¬ç¶²éƒ¨ç½²: `https://warehouse-agent.example.com/mcp`

**æ³¨æ„**:

- å¦‚æœåº«ç®¡å“¡ Agent éƒ¨ç½²åœ¨å…¬ç¶²ï¼Œå»ºè­°ä½¿ç”¨ HTTPS
- å¦‚æœéƒ¨ç½²åœ¨å…§ç¶²ï¼Œéœ€è¦ç¢ºä¿ Cloudflare Gateway èƒ½å¤ è¨ªå•ï¼ˆå¯èƒ½éœ€è¦ VPN æˆ–å…§ç¶²ç©¿é€ï¼‰

### 1.2 éƒ¨ç½²æ›´æ–°

```bash
cd /Users/daniel/GitHub/AI-Box/mcp/gateway
wrangler deploy
```

**é©—è­‰éƒ¨ç½²**:

```bash
# æª¢æŸ¥éƒ¨ç½²ç‹€æ…‹
wrangler deployments list

# æŸ¥çœ‹æ—¥èªŒ
wrangler tail mcp-gateway
```

---

## ğŸ” æ­¥é©Ÿ 2: é…ç½® Cloudflare Gateway èªè­‰ï¼ˆå¯é¸ï¼‰

### 2.1 ç„¡èªè­‰é…ç½®ï¼ˆå…¬é–‹æœå‹™ï¼‰

å¦‚æœåº«ç®¡å“¡ Agent ä¸éœ€è¦èªè­‰ï¼ˆé–‹ç™¼/æ¸¬è©¦ç’°å¢ƒï¼‰ï¼Œé…ç½®ç‚ºç„¡èªè­‰ï¼š

```bash
cd /Users/daniel/GitHub/AI-Box/mcp/gateway

# é…ç½®ç„¡èªè­‰ï¼ˆä½¿ç”¨é€šé…ç¬¦åŒ¹é…æ‰€æœ‰ warehouse_* å·¥å…·ï¼‰
wrangler kv key put "auth:warehouse_query_part" \
  '{"type":"none"}' \
  --namespace-id=5b6e229c21f649269e93db9dcb8a7e16 \
  --remote

wrangler kv key put "auth:warehouse_query_stock" \
  '{"type":"none"}' \
  --namespace-id=5b6e229c21f649269e93db9dcb8a7e16 \
  --remote
```

### 2.2 API Key èªè­‰é…ç½®ï¼ˆç”Ÿç”¢ç’°å¢ƒï¼‰

å¦‚æœåº«ç®¡å“¡ Agent éœ€è¦ API Key èªè­‰ï¼š

```bash
# 1. è¨­ç½® API Key Secret
wrangler secret put WAREHOUSE_AGENT_API_KEY
# è¼¸å…¥ API Key å€¼

# 2. é…ç½®èªè­‰
wrangler kv key put "auth:warehouse_query_part" \
  '{"type":"api_key","api_key":"${WAREHOUSE_AGENT_API_KEY}","header_name":"X-API-Key"}' \
  --namespace-id=5b6e229c21f649269e93db9dcb8a7e16 \
  --remote
```

### 2.3 Bearer Token èªè­‰é…ç½®

å¦‚æœåº«ç®¡å“¡ Agent ä½¿ç”¨ Bearer Tokenï¼š

```bash
# 1. è¨­ç½® Token Secret
wrangler secret put WAREHOUSE_AGENT_TOKEN
# è¼¸å…¥ Token å€¼

# 2. é…ç½®èªè­‰
wrangler kv key put "auth:warehouse_query_part" \
  '{"type":"bearer","token":"${WAREHOUSE_AGENT_TOKEN}"}' \
  --namespace-id=5b6e229c21f649269e93db9dcb8a7e16 \
  --remote
```

### 2.4 é©—è­‰èªè­‰é…ç½®

```bash
# æª¢æŸ¥èªè­‰é…ç½®
wrangler kv key get "auth:warehouse_query_part" \
  --namespace-id=5b6e229c21f649269e93db9dcb8a7e16 \
  --remote
```

---

## ğŸ“Œ ç¬¬äºŒéƒ¨åˆ†ï¼šåœ¨ AI-Box ä¸­è¨»å†Š Cloudflare Gateway ç«¯é»

æœ¬éƒ¨åˆ†èªªæ˜å¦‚ä½•åœ¨ AI-Box ä¸­è¨»å†Š Agentï¼Œç«¯é»æŒ‡å‘ Cloudflare Gatewayï¼Œä½¿ AI-Box èƒ½å¤ é€šé Gateway èª¿ç”¨åº«ç®¡å“¡ Agentã€‚

**âš ï¸ é‡è¦æç¤º**ï¼š

- åœ¨é–‹å§‹ç¬¬äºŒéƒ¨åˆ†ä¹‹å‰ï¼Œè«‹ç¢ºä¿ç¬¬ä¸€éƒ¨åˆ†ï¼ˆCloudflare Gateway é…ç½®ï¼‰å·²ç¶“å®Œæˆ
- MCP ç«¯é» URL å¿…é ˆæŒ‡å‘ Cloudflare Gatewayï¼ˆ`https://mcp.k84.org`ï¼‰ï¼Œè€Œä¸æ˜¯ç›´æ¥æŒ‡å‘åº«ç®¡å“¡ Agent

---

## ğŸ“ æ­¥é©Ÿ 3: åœ¨ AI-Box ä¸­è¨»å†Š Agentï¼ˆç«¯é»æŒ‡å‘ Cloudflare Gatewayï¼‰

### 3.1 AI-Box è¨»å†Šèˆ‡å¯©æŸ¥æµç¨‹æ¦‚è¿°

**å®Œæ•´è¨»å†Šæµç¨‹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent ç”³è«‹éšæ®µ                                          â”‚
â”‚  1. Agent é€šé Cloudflare Gateway æäº¤è¨»å†Šç”³è«‹          â”‚
â”‚  2. AI-Box æ¥æ”¶ç”³è«‹ä¸¦å„²å­˜ Metadata                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI-Box å¯©æŸ¥éšæ®µ                                         â”‚
â”‚  3. è‡ªå‹•å¯©æ ¸ï¼ˆä½é¢¨éšª Agentï¼‰æˆ–äººå·¥å¯©æ ¸ï¼ˆé«˜é¢¨éšª Agentï¼‰   â”‚
â”‚  4. å¯©æ ¸é€šéå¾Œï¼Œç³»çµ±ç™¼æ”¾ Secret ID/Key å°               â”‚
â”‚  5. æ›´æ–° Permission Storeï¼ˆæ¬Šé™é…ç½®ï¼‰                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent è¨»å†Šéšæ®µ                                          â”‚
â”‚  6. Agent ä½¿ç”¨ Secret ID/Key é€²è¡Œè¨»å†Š                    â”‚
â”‚  7. è¨»å†Šå¾Œç‹€æ…‹ç‚º REGISTERINGï¼ˆç­‰å¾…ç®¡ç†å“¡æ ¸å‡†ï¼‰           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç®¡ç†å“¡æ ¸å‡†éšæ®µ                                          â”‚
â”‚  8. ç®¡ç†å“¡æ ¸å‡† Agent â†’ ç‹€æ…‹è½‰ç‚º ONLINE                  â”‚
â”‚  9. Agent å¯ä»¥é–‹å§‹ä½¿ç”¨                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Runtime é‹è¡Œéšæ®µ                                        â”‚
â”‚  10. Runtime æª¢æŸ¥æˆæ¬Š & é€Ÿç‡é™åˆ¶                         â”‚
â”‚  11. è¨˜éŒ„å¯©è¨ˆæ—¥èªŒ                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âš ï¸ é‡è¦èªªæ˜**ï¼š

- **ç›®å‰å¯¦ç¾**ï¼ˆæ¸¬è©¦/é–‹ç™¼ç’°å¢ƒï¼‰ï¼šç”¨æˆ¶å¯ä»¥ç›´æ¥é€šé API ç”Ÿæˆ Secret
- **ç†æƒ³æµç¨‹**ï¼ˆç”Ÿç”¢ç’°å¢ƒï¼‰ï¼šæ‡‰è©²é€šéå¯©æ‰¹æµç¨‹ï¼Œç³»çµ±åœ¨å¯©æ ¸é€šéå¾Œç™¼æ”¾ Secret
- **å¯©æŸ¥æ©Ÿåˆ¶**ï¼šæ”¯æŒè‡ªå‹•å¯©æ ¸ï¼ˆä½é¢¨éšªï¼‰å’Œäººå·¥å¯©æ ¸ï¼ˆé«˜é¢¨éšªï¼‰

### 3.2 ç²å– Secret ID å’Œ Secret Key

**æ–¹å¼ä¸€ï¼šé€šé API ç”Ÿæˆï¼ˆç›®å‰å¯¦ç¾ï¼Œæ¸¬è©¦/é–‹ç™¼ç’°å¢ƒï¼‰**

**æ“ä½œæ­¥é©Ÿ**:

```bash
# ç”Ÿæˆæ–°çš„ Secret ID/Key å°
curl -X POST http://localhost:8000/api/v1/agents/secrets/generate \
  -H "Content-Type: application/json"
```

**éŸ¿æ‡‰ç¤ºä¾‹**:

```json
{
  "success": true,
  "data": {
    "secret_id": "aibox-warehouse-agent-1234567890-abc123",
    "secret_key": "sk_live_<YOUR_SECRET_KEY_HERE>",
    "expires_at": null
  },
  "message": "Secret generated successfully"
}
```

**âš ï¸ é‡è¦**:

- ä¿å­˜ `secret_id` å’Œ `secret_key`ï¼Œå¾ŒçºŒè¨»å†Šéœ€è¦ä½¿ç”¨
- **æ³¨æ„**ï¼šSecret Key åªåœ¨ç”Ÿæˆæ™‚è¿”å›ä¸€æ¬¡ï¼Œè«‹å¦¥å–„ä¿ç®¡
- **ç”Ÿç”¢ç’°å¢ƒ**ï¼šæ­¤æ­¥é©Ÿæ‡‰è©²é€šéå¯©æ‰¹æµç¨‹ï¼Œç”±ç³»çµ±åœ¨å¯©æ ¸é€šéå¾Œç™¼æ”¾

**æ–¹å¼äºŒï¼šé€šéå¯©æ‰¹æµç¨‹ç²å–ï¼ˆç†æƒ³æµç¨‹ï¼Œç”Ÿç”¢ç’°å¢ƒï¼‰**

**æµç¨‹èªªæ˜**ï¼š

1. **æäº¤ç”³è«‹**
   - åœ¨ AI-Box å‰ç«¯ç•Œé¢æäº¤ Agent è¨»å†Šç”³è«‹
   - ç³»çµ±å„²å­˜ç”³è«‹ Metadataï¼ˆAgent è³‡è¨Šã€ç«¯é»é…ç½®ç­‰ï¼‰

2. **è‡ªå‹•å¯©æ ¸æˆ–äººå·¥å¯©æ ¸**
   - **è‡ªå‹•å¯©æ ¸**ï¼ˆä½é¢¨éšª Agentï¼‰ï¼š
     - ç¬¦åˆé è¨­è¦å‰‡çš„ Agent è‡ªå‹•é€šéå¯©æ ¸
     - ä¾‹å¦‚ï¼šå…§éƒ¨ Agentã€å·²çŸ¥å¯ä¿¡ä¾†æºçš„ Agent
   - **äººå·¥å¯©æ ¸**ï¼ˆé«˜é¢¨éšª Agentï¼‰ï¼š
     - éœ€è¦ç®¡ç†å“¡æ‰‹å‹•å¯©æ ¸
     - ä¾‹å¦‚ï¼šå¤–éƒ¨ Agentã€æ–°ä¾†æºçš„ Agentã€é«˜æ¬Šé™ Agent

3. **ç³»çµ±ç™¼æ”¾ Secret**
   - å¯©æ ¸é€šéå¾Œï¼Œç³»çµ±è‡ªå‹•ç”Ÿæˆä¸¦ç™¼æ”¾ Secret ID/Key å°
   - é€šééƒµä»¶æˆ–ç³»çµ±é€šçŸ¥ç™¼é€çµ¦ç”³è«‹äºº

**âš ï¸ æ³¨æ„**ï¼šç›®å‰ç³»çµ±å¯¦ç¾ä¸­ï¼ŒSecret ç”Ÿæˆä¸éœ€è¦å¯©æ‰¹ï¼ˆæ¸¬è©¦/é–‹ç™¼ç’°å¢ƒï¼‰ã€‚ç”Ÿç”¢ç’°å¢ƒæ‡‰è©²æ”¹ç‚ºå¯©æ‰¹æµç¨‹ã€‚

### 3.2 AI-Box å¯©æŸ¥èˆ‡é©—è­‰æ©Ÿåˆ¶

**å¯©æŸ¥æµç¨‹èªªæ˜**ï¼š

æ ¹æ“š ChatGPT å»ºè­°çš„æµç¨‹ï¼ŒAI-Box ä½œç‚º**äº‹å‰è¨»å†Šèˆ‡æˆæ¬Šä¸­å¿ƒ**ï¼Œæä¾›å®Œæ•´çš„å¯©æŸ¥æ©Ÿåˆ¶ï¼š

#### 3.2.1 ç”³è«‹æ¥æ”¶èˆ‡å„²å­˜

1. **Agent æäº¤ç”³è«‹**
   - Agent é€šé Cloudflare Gateway æäº¤è¨»å†Šç”³è«‹
   - æˆ–ç›´æ¥åœ¨ AI-Box å‰ç«¯ç•Œé¢æäº¤ç”³è«‹

2. **ç³»çµ±å„²å­˜ Metadata**
   - AI-Box æ¥æ”¶ç”³è«‹ä¸¦å„²å­˜æ‰€æœ‰ Metadata
   - åŒ…æ‹¬ï¼šAgent è³‡è¨Šã€ç«¯é»é…ç½®ã€èƒ½åŠ›åˆ—è¡¨ã€æ¬Šé™éœ€æ±‚ç­‰

#### 3.2.2 è‡ªå‹•å¯©æ ¸ vs äººå·¥å¯©æ ¸

**è‡ªå‹•å¯©æ ¸ï¼ˆä½é¢¨éšª Agentï¼‰**ï¼š

é©ç”¨æ–¼ä»¥ä¸‹æƒ…æ³ï¼š

- âœ… å…§éƒ¨ Agentï¼ˆ`is_internal: true`ï¼‰
- âœ… å·²çŸ¥å¯ä¿¡ä¾†æºçš„ Agent
- âœ… ç¬¦åˆé è¨­å®‰å…¨è¦å‰‡çš„ Agent
- âœ… ä½æ¬Šé™éœ€æ±‚çš„ Agent

**è‡ªå‹•å¯©æ ¸è¦å‰‡**ï¼ˆç¤ºä¾‹ï¼‰ï¼š

- ç«¯é»ä½¿ç”¨ HTTPS
- å·¥å…·åç¨±ç¬¦åˆå‘½åè¦ç¯„
- æ¬Šé™é…ç½®åœ¨å…è¨±ç¯„åœå…§
- ç„¡é«˜é¢¨éšªæ“ä½œ

**äººå·¥å¯©æ ¸ï¼ˆé«˜é¢¨éšª Agentï¼‰**ï¼š

éœ€è¦ç®¡ç†å“¡æ‰‹å‹•å¯©æ ¸çš„æƒ…æ³ï¼š

- âš ï¸ å¤–éƒ¨ Agentï¼ˆ`is_internal: false`ï¼‰
- âš ï¸ æ–°ä¾†æºæˆ–æœªçŸ¥ä¾†æºçš„ Agent
- âš ï¸ é«˜æ¬Šé™éœ€æ±‚çš„ Agentï¼ˆå¦‚ `admin: true`ï¼‰
- âš ï¸ æ¶‰åŠæ•æ„Ÿæ“ä½œçš„ Agent
- âš ï¸ ä¸ç¬¦åˆè‡ªå‹•å¯©æ ¸è¦å‰‡çš„ Agent

**äººå·¥å¯©æ ¸æª¢æŸ¥é …**ï¼š

- Agent ä¾†æºå¯ä¿¡åº¦
- ç«¯é»å®‰å…¨æ€§ï¼ˆHTTPSã€è­‰æ›¸ç­‰ï¼‰
- æ¬Šé™é…ç½®åˆç†æ€§
- å·¥å…·åŠŸèƒ½å®‰å…¨æ€§
- åˆè¦æ€§æª¢æŸ¥

#### 3.2.3 ç³»çµ±ç™¼æ”¾æ†‘è­‰

å¯©æ ¸é€šéå¾Œï¼Œç³»çµ±æœƒç™¼æ”¾ä»¥ä¸‹æ†‘è­‰ä¹‹ä¸€ï¼š

1. **Secret ID/Key å°**ï¼ˆç•¶å‰å¯¦ç¾ï¼‰
   - ç”¨æ–¼ Agent èº«ä»½é©—è­‰
   - é€šé `/api/v1/agents/secrets/generate` ç”Ÿæˆ

2. **OAuth Token**ï¼ˆæœªä¾†æ”¯æŒï¼‰
   - ç”¨æ–¼ OAuth 2.0 èªè­‰
   - æ”¯æŒå‹•æ…‹ Token åˆ·æ–°

3. **Client Certificate**ï¼ˆæœªä¾†æ”¯æŒï¼‰
   - ç”¨æ–¼ mTLS èªè­‰
   - æä¾›æ›´å¼·çš„å®‰å…¨æ€§

#### 3.2.4 æ›´æ–° Permission Store

å¯©æ ¸é€šéä¸¦ç™¼æ”¾æ†‘è­‰å¾Œï¼Œç³»çµ±æœƒï¼š

1. **æ›´æ–° Permission Store**
   - åœ¨ Cloudflare Gateway çš„ KV Store ä¸­é…ç½®æ¬Šé™
   - è¨­ç½®ç”¨æˆ¶/ç§Ÿæˆ¶å°æ‡‰çš„å·¥å…·è¨ªå•æ¬Šé™
   - é…ç½®é€Ÿç‡é™åˆ¶è¦å‰‡

2. **é…ç½®ç¤ºä¾‹**ï¼š

   ```bash
   # é…ç½®ç§Ÿæˆ¶é»˜èªæ¬Šé™
   wrangler kv key put "permissions:test-tenant:default" \
     '{"tools":["warehouse_*"],"rate_limits":{"default":100}}' \
     --binding=PERMISSIONS_STORE --preview=false --remote
   ```

### 3.3 é©—è­‰ Secret

```bash
curl -X POST http://localhost:8000/api/v1/agents/secrets/verify \
  -H "Content-Type: application/json" \
  -d '{
    "secret_id": "aibox-warehouse-agent-1234567890-abc123",
    "secret_key": "sk_live_<YOUR_SECRET_KEY_HERE>"
  }'
```

**é æœŸéŸ¿æ‡‰**:

```json
{
  "success": true,
  "data": {
    "valid": true,
    "is_bound": false,
    "status": "active"
  },
  "message": "Secret verified successfully"
}
```

### 3.4 è¨»å†Š Agentï¼ˆç«¯é»æŒ‡å‘ Cloudflare Gatewayï¼‰

**é—œéµé…ç½®**: MCP ç«¯é»æŒ‡å‘ Cloudflare Gatewayï¼Œè€Œä¸æ˜¯ç›´æ¥æŒ‡å‘åº«ç®¡å“¡ Agentã€‚

**æ–¹å¼ä¸€ï¼šé€šéå‰ç«¯ç•Œé¢è¨»å†Šï¼ˆæ¨è–¦ï¼‰**

1. **æ‰“é–‹ Agent è¨»å†Šç•Œé¢**
   - åœ¨ AI-Box å‰ç«¯ç•Œé¢é»æ“Šã€Œè¨»å†Šæ–° Agentã€æŒ‰éˆ•

2. **å¡«å¯«åŸºæœ¬è³‡è¨Š**
   - **Agent åç¨±**: `åº«ç®¡å“¡ Agent` æˆ– `Warehouse Manager Agent`
   - **Agent é¡å‹**: é¸æ“‡ `Execution (åŸ·è¡Œ)`
   - **æè¿°**: `åº«å­˜ç®¡ç†æ¥­å‹™ Agentï¼Œè² è²¬æ–™è™ŸæŸ¥è©¢ã€åº«å­˜æŸ¥è©¢ã€ç¼ºæ–™åˆ†æå’Œæ¡è³¼å–®ç”Ÿæˆ`
   - **èƒ½åŠ›åˆ—è¡¨**: â­ **é‡è¦** - å¿…é ˆä»¥ `warehouse_` é–‹é ­
     - `warehouse_execute_task` - åŸ·è¡Œåº«å­˜ç®¡ç†ä»»å‹™ï¼ˆç•¶å‰å¯¦ç¾ï¼‰
     - `warehouse_query_part` - æŸ¥è©¢æ–™è™Ÿ
     - `warehouse_query_stock` - æŸ¥è©¢åº«å­˜
     - `warehouse_analyze_shortage` - ç¼ºæ–™åˆ†æ
     - `warehouse_generate_purchase_order` - ç”Ÿæˆæ¡è³¼å–®
   - **åœ–æ¨™**: é¸æ“‡åˆé©çš„åœ–æ¨™ï¼ˆä¾‹å¦‚ï¼š`FaWarehouse`ï¼‰

   **âš ï¸ é—œéµæç¤º**ï¼š
   - æ‰€æœ‰å·¥å…·åç¨±**å¿…é ˆ**ä»¥ `warehouse_` é–‹é ­
   - é€™æ˜¯ Gateway è­˜åˆ¥ä¸¦è·¯ç”±åˆ°åº«ç®¡å“¡ Agent çš„é—œéµ
   - å¦‚æœå·¥å…·åç¨±ä¸ç¬¦åˆå‰ç¶´è¦ç¯„ï¼ŒGateway ç„¡æ³•æ­£ç¢ºè·¯ç”±

3. **é…ç½®ç«¯é»ï¼ˆé—œéµæ­¥é©Ÿï¼‰**
   - **å–æ¶ˆå‹¾é¸**ã€Œå…§éƒ¨ Agentã€
   - **å”è­°é¡å‹**: é¸æ“‡ `MCP (Model Context Protocol)`
   - **MCP ç«¯é» URL**: `https://mcp.k84.org` â­ **æŒ‡å‘ Cloudflare Gateway**
     - æˆ–ä½¿ç”¨ Workers.dev URL: `https://mcp-gateway.896445070.workers.dev`
   - **âš ï¸ é‡è¦èªªæ˜**ï¼š
     - âœ… **æ­£ç¢º**ï¼šç«¯é»æŒ‡å‘ Cloudflare Gatewayï¼ˆ`https://mcp.k84.org`ï¼‰
     - âŒ **éŒ¯èª¤**ï¼šä¸è¦ç›´æ¥æŒ‡å‘åº«ç®¡å“¡ Agent çš„ç«¯é»ï¼ˆå¦‚ `http://localhost:8003` æˆ– ngrok URLï¼‰
     - **ç‚ºä»€éº¼**ï¼šGateway æœƒæ ¹æ“šå·¥å…·åç¨±ï¼ˆ`warehouse_*`ï¼‰è‡ªå‹•è·¯ç”±åˆ°åº«ç®¡å“¡ Agent
     - **å¤š Agent æ”¯æŒ**ï¼šå³ä½¿ Gateway ä¸Šè¨»å†Šäº†å¤šå€‹ Agentï¼Œæ‰€æœ‰ Agent éƒ½ä½¿ç”¨åŒä¸€å€‹ Gateway ç«¯é»

4. **Secret èº«ä»½é©—è­‰**
   - è¼¸å…¥å¾ AI-Box ç²å–çš„ `Secret ID`
   - è¼¸å…¥å°æ‡‰çš„ `Secret Key`
   - é»æ“Šã€Œé©—è­‰ Secretã€æŒ‰éˆ•

5. **æäº¤è¨»å†Š**
   - æª¢æŸ¥æ‰€æœ‰å¿…å¡«é …æ˜¯å¦å·²å¡«å¯«
   - é»æ“Šã€Œè¨»å†Š Agentã€æŒ‰éˆ•

**æ–¹å¼äºŒï¼šé€šé API è¨»å†Š**

```bash
curl -X POST http://localhost:8000/api/v1/agents/register \
  -H "Content-Type: application/json" \
  -d '{
    "agent_id": "warehouse-manager-agent",
    "agent_type": "execution",
    "name": "åº«ç®¡å“¡ Agent",
    "endpoints": {
      "http": null,
      "mcp": "https://mcp.k84.org",
      "protocol": "mcp",
      "is_internal": false
    },
    "capabilities": [
      "query_part",
      "query_stock",
      "analyze_shortage",
      "generate_purchase_order"
    ],
    "metadata": {
      "version": "2.2",
      "description": "åº«å­˜ç®¡ç†æ¥­å‹™ Agentï¼Œè² è²¬æ–™è™ŸæŸ¥è©¢ã€åº«å­˜æŸ¥è©¢ã€ç¼ºæ–™åˆ†æå’Œæ¡è³¼å–®ç”Ÿæˆ",
      "tags": ["warehouse", "inventory", "purchase"],
      "icon": "FaWarehouse"
    },
    "permissions": {
      "read": true,
      "write": false,
      "execute": true,
      "admin": false,
      "secret_id": "aibox-warehouse-agent-1234567890-abc123",
      "allowed_memory_namespaces": [],
      "allowed_tools": [],
      "allowed_llm_providers": []
    }
  }'
```

**é—œéµé…ç½®èªªæ˜**:

- **`mcp`**: `https://mcp.k84.org` - æŒ‡å‘ Cloudflare Gatewayï¼Œä¸æ˜¯åº«ç®¡å“¡ Agent çš„ç›´æ¥ç«¯é»
- **`protocol`**: `mcp` - ä½¿ç”¨ MCP å”è­°
- **`is_internal`**: `false` - æ¨™è¨˜ç‚ºå¤–éƒ¨ Agent

---

## âœ… æ­¥é©Ÿ 4: Runtime æˆæ¬Šæª¢æŸ¥èˆ‡å¯©è¨ˆæ—¥èªŒ

### 4.1 Runtime æˆæ¬Šæª¢æŸ¥

Agent æ ¸å‡†ä¸¦ä¸Šç·šå¾Œï¼Œåœ¨æ¯æ¬¡èª¿ç”¨æ™‚ï¼Œç³»çµ±æœƒé€²è¡Œä»¥ä¸‹æª¢æŸ¥ï¼š

1. **æˆæ¬Šæª¢æŸ¥**
   - æª¢æŸ¥ç”¨æˆ¶/ç§Ÿæˆ¶æ˜¯å¦æœ‰æ¬Šé™èª¿ç”¨è©² Agent
   - æª¢æŸ¥ Agent ç‹€æ…‹æ˜¯å¦ç‚º `ONLINE`
   - æª¢æŸ¥ Secret æ˜¯å¦æœ‰æ•ˆä¸”æœªéæœŸ
   - æª¢æŸ¥å·¥å…·åç¨±æ˜¯å¦åœ¨å…è¨±åˆ—è¡¨ä¸­

2. **é€Ÿç‡é™åˆ¶**
   - æ ¹æ“š Permission Store ä¸­çš„é…ç½®é€²è¡Œé€Ÿç‡é™åˆ¶
   - é˜²æ­¢ Agent è¢«æ¿«ç”¨
   - è¶…éé™åˆ¶çš„è«‹æ±‚æœƒè¢«æ‹’çµ•ï¼ˆè¿”å› 429 Too Many Requestsï¼‰

3. **è«‹æ±‚é©—è­‰**
   - é©—è­‰è«‹æ±‚æ ¼å¼æ˜¯å¦æ­£ç¢º
   - é©—è­‰åƒæ•¸æ˜¯å¦ç¬¦åˆå·¥å…·è¦ç¯„
   - é©—è­‰ç”¨æˆ¶èº«ä»½å’Œæ¬Šé™

### 4.2 å¯©è¨ˆæ—¥èªŒè¨˜éŒ„

**è¨˜éŒ„å…§å®¹**ï¼š

ç³»çµ±æœƒè¨˜éŒ„ä»¥ä¸‹å¯©è¨ˆä¿¡æ¯ï¼š

1. **è«‹æ±‚æ—¥èªŒ**
   - è«‹æ±‚æ™‚é–“æˆ³
   - ç”¨æˆ¶ ID å’Œç§Ÿæˆ¶ ID
   - Agent ID å’Œå·¥å…·åç¨±
   - è«‹æ±‚åƒæ•¸ï¼ˆæ•æ„Ÿä¿¡æ¯æœƒè„«æ•ï¼‰

2. **æˆæ¬Šæª¢æŸ¥çµæœ**
   - æˆæ¬Šæ˜¯å¦é€šé
   - é€Ÿç‡é™åˆ¶æª¢æŸ¥çµæœ
   - æ‹’çµ•åŸå› ï¼ˆå¦‚é©ç”¨ï¼‰

3. **éŸ¿æ‡‰æ—¥èªŒ**
   - éŸ¿æ‡‰ç‹€æ…‹ç¢¼
   - éŸ¿æ‡‰æ™‚é–“
   - éŒ¯èª¤ä¿¡æ¯ï¼ˆå¦‚é©ç”¨ï¼‰

**æ—¥èªŒç”¨é€”**ï¼š

- å®‰å…¨å¯©è¨ˆ
- å•é¡Œæ’æŸ¥
- ä½¿ç”¨çµ±è¨ˆ
- åˆè¦æ€§æª¢æŸ¥

---

## âœ… æ­¥é©Ÿ 5: ç†è§£ Gateway è·¯ç”±è­˜åˆ¥æ©Ÿåˆ¶

### 5.1 é—œéµå•é¡Œï¼šå¦‚ä½•è­˜åˆ¥ä¸åŒçš„ Agentï¼Ÿ

**å•é¡Œ**ï¼šå¦‚æœ Cloudflare Gateway ä¸Šè¨»å†Šäº†å¾ˆå¤š Agentï¼Œç³»çµ±å¦‚ä½•è­˜åˆ¥è¦èª¿ç”¨å“ªå€‹ Agentï¼Ÿ

**ç­”æ¡ˆ**ï¼š**é€šéå·¥å…·åç¨±ï¼ˆTool Nameï¼‰çš„å‰ç¶´é€²è¡Œè·¯ç”±åŒ¹é…**

### 5.2 è·¯ç”±è­˜åˆ¥æ©Ÿåˆ¶è©³è§£

**å·¥ä½œåŸç†**ï¼š

1. **å·¥å…·åç¨±æ˜¯è·¯ç”±çš„é—œéµ**
   - æ¯å€‹ Agent çš„å·¥å…·åç¨±å¿…é ˆæœ‰**å”¯ä¸€çš„å‰ç¶´**
   - ä¾‹å¦‚ï¼šåº«ç®¡å“¡ Agent ä½¿ç”¨ `warehouse_*`ï¼Œè²¡å‹™ Agent ä½¿ç”¨ `finance_*`

2. **Gateway è·¯ç”±åŒ¹é…æµç¨‹**ï¼š

   ```
   AI-Box èª¿ç”¨å·¥å…·
       â†“
   ç™¼é€è«‹æ±‚åˆ° https://mcp.k84.org
   è«‹æ±‚é ­åŒ…å«ï¼šX-Tool-Name: warehouse_execute_task
       â†“
   Gateway æå–å·¥å…·åç¨±ï¼šwarehouse_execute_task
       â†“
   Gateway åŒ¹é…è·¯ç”±è¦å‰‡ï¼š
   - warehouse_* â†’ https://ngrok-url-for-warehouse-agent
   - finance_* â†’ https://ngrok-url-for-finance-agent
   - office_* â†’ https://ngrok-url-for-office-agent
       â†“
   åŒ¹é…æˆåŠŸï¼šwarehouse_execute_task åŒ¹é… warehouse_*
       â†“
   Gateway è½‰ç™¼è«‹æ±‚åˆ°åº«ç®¡å“¡ Agent ç«¯é»
   ```

3. **å¯¦éš›ç¤ºä¾‹**ï¼š

   **å ´æ™¯ 1ï¼šèª¿ç”¨åº«ç®¡å“¡ Agent**

   ```bash
   # AI-Box ç™¼é€è«‹æ±‚
   POST https://mcp.k84.org
   Headers:
     X-Tool-Name: warehouse_execute_task

   # Gateway åŒ¹é…ï¼š
   # warehouse_execute_task åŒ¹é… pattern: warehouse_*
   # â†’ è·¯ç”±åˆ°åº«ç®¡å“¡ Agent (https://182740a0a99a.ngrok-free.app)
   ```

   **å ´æ™¯ 2ï¼šèª¿ç”¨è²¡å‹™ Agent**

   ```bash
   # AI-Box ç™¼é€è«‹æ±‚
   POST https://mcp.k84.org
   Headers:
     X-Tool-Name: finance_get_quote

   # Gateway åŒ¹é…ï¼š
   # finance_get_quote åŒ¹é… pattern: finance_*
   # â†’ è·¯ç”±åˆ°è²¡å‹™ Agent (https://finance-agent.example.com)
   ```

### 5.3 å·¥å…·åç¨±è¦ç¯„ï¼ˆé‡è¦ï¼‰

**å¿…é ˆéµå¾ªçš„è¦ç¯„**ï¼š

æ ¹æ“š [åº«ç®¡å“¡-Agent-è¦æ ¼æ›¸](./åº«ç®¡å“¡-Agent-è¦æ ¼æ›¸.md)ï¼Œåº«ç®¡å“¡ Agent æä¾›çš„å·¥å…·æ‡‰è©²ä»¥ `warehouse_` å‰ç¶´å‘½åï¼Œä¾‹å¦‚ï¼š

- `warehouse_execute_task` - åŸ·è¡Œåº«å­˜ç®¡ç†ä»»å‹™ï¼ˆç•¶å‰å¯¦ç¾ï¼‰
- `warehouse_query_part` - æŸ¥è©¢æ–™è™Ÿ
- `warehouse_query_stock` - æŸ¥è©¢åº«å­˜
- `warehouse_analyze_shortage` - ç¼ºæ–™åˆ†æ
- `warehouse_generate_purchase_order` - ç”Ÿæˆæ¡è³¼å–®

**å…¶ä»– Agent çš„å‘½åç¯„ä¾‹**ï¼š

| Agent | å·¥å…·åç¨±å‰ç¶´ | ç¯„ä¾‹å·¥å…·åç¨± |
|-------|------------|------------|
| åº«ç®¡å“¡ Agent | `warehouse_*` | `warehouse_execute_task` |
| è²¡å‹™ Agent | `finance_*` | `finance_get_quote`, `finance_get_balance` |
| Office 365 | `office_*` | `office_create_document`, `office_send_email` |
| Slack | `slack_*` | `slack_send_message`, `slack_list_channels` |

### 5.4 Gateway è·¯ç”±é…ç½®

**wrangler.toml é…ç½®ç¤ºä¾‹**ï¼š

```toml
MCP_ROUTES = '''
[
  {
    "pattern": "yahoo_finance_*",
    "target": "https://smithery.ai/server/@tsmdev-ux/yahoo-finance-mcp"
  },
  {
    "pattern": "warehouse_*",
    "target": "https://182740a0a99a.ngrok-free.app"
  },
  {
    "pattern": "finance_*",
    "target": "https://finance-agent.example.com/mcp"
  },
  {
    "pattern": "office_*",
    "target": "https://office-mcp.example.com/mcp"
  }
]
'''
```

**è·¯ç”±åŒ¹é…è¦å‰‡**ï¼š

- `warehouse_*` åŒ¹é…æ‰€æœ‰ä»¥ `warehouse_` é–‹é ­çš„å·¥å…·åç¨±
- `finance_*` åŒ¹é…æ‰€æœ‰ä»¥ `finance_` é–‹é ­çš„å·¥å…·åç¨±
- é€šé…ç¬¦ `*` å¯ä»¥åŒ¹é…ä»»æ„å­—ç¬¦

**âš ï¸ é‡è¦æ³¨æ„äº‹é …**ï¼š

1. **å‰ç¶´å¿…é ˆå”¯ä¸€**ï¼šä¸åŒ Agent çš„å·¥å…·å‰ç¶´ä¸èƒ½é‡ç–Š
   - âœ… æ­£ç¢ºï¼š`warehouse_*` å’Œ `finance_*`ï¼ˆä¸é‡ç–Šï¼‰
   - âŒ éŒ¯èª¤ï¼š`warehouse_*` å’Œ `warehouse_manager_*`ï¼ˆæœƒè¡çªï¼‰

2. **å·¥å…·åç¨±å¿…é ˆç¬¦åˆå‰ç¶´**ï¼š
   - åº«ç®¡å“¡ Agent çš„æ‰€æœ‰å·¥å…·åç¨±å¿…é ˆä»¥ `warehouse_` é–‹é ­
   - å¦å‰‡ Gateway ç„¡æ³•æ­£ç¢ºè·¯ç”±

3. **åœ¨ AI-Box è¨»å†Šæ™‚**ï¼š
   - è¨»å†Š Agent æ™‚ï¼Œ**ç«¯é»çµ±ä¸€æŒ‡å‘** `https://mcp.k84.org`
   - **ä¸éœ€è¦**ç‚ºæ¯å€‹ Agent é…ç½®ä¸åŒçš„ç«¯é»
   - Gateway æœƒæ ¹æ“šå·¥å…·åç¨±è‡ªå‹•è·¯ç”±åˆ°æ­£ç¢ºçš„ Agent

### 5.5 å®Œæ•´èª¿ç”¨æµç¨‹ç¤ºä¾‹

**å ´æ™¯ï¼šAI-Box èª¿ç”¨åº«ç®¡å“¡ Agent çš„å·¥å…·**

```
æ­¥é©Ÿ 1: AI-Box æ±ºå®šèª¿ç”¨ warehouse_execute_task
    â†“
æ­¥é©Ÿ 2: AI-Box æŸ¥æ‰¾ Agent è¨»å†Šä¿¡æ¯
    - Agent ID: warehouse-manager-agent
    - MCP ç«¯é»: https://mcp.k84.org
    - å·¥å…·åç¨±: warehouse_execute_task
    â†“
æ­¥é©Ÿ 3: AI-Box ç™¼é€è«‹æ±‚åˆ° Gateway
    POST https://mcp.k84.org
    Headers:
      X-Gateway-Secret: [Gateway Secret]
      X-User-ID: user-123
      X-Tenant-ID: tenant-456
      X-Tool-Name: warehouse_execute_task  â­ é—œéµï¼
    Body:
      {
        "jsonrpc": "2.0",
        "id": 1,
        "method": "tools/call",
        "params": {
          "name": "warehouse_execute_task",
          "arguments": {...}
        }
      }
    â†“
æ­¥é©Ÿ 4: Gateway æå–å·¥å…·åç¨±
    toolName = "warehouse_execute_task"
    â†“
æ­¥é©Ÿ 5: Gateway åŒ¹é…è·¯ç”±è¦å‰‡
    éæ­·è·¯ç”±è¦å‰‡ï¼š
    - yahoo_finance_* â†’ ä¸åŒ¹é…
    - warehouse_* â†’ âœ… åŒ¹é…ï¼
    - finance_* â†’ ä¸åŒ¹é…
    â†“
æ­¥é©Ÿ 6: Gateway ç²å–ç›®æ¨™ç«¯é»
    targetEndpoint = "https://182740a0a99a.ngrok-free.app"
    â†“
æ­¥é©Ÿ 7: Gateway è½‰ç™¼è«‹æ±‚åˆ°åº«ç®¡å“¡ Agent
    POST https://182740a0a99a.ngrok-free.app
    [è½‰ç™¼åŸå§‹è«‹æ±‚]
    â†“
æ­¥é©Ÿ 8: åº«ç®¡å“¡ Agent è™•ç†è«‹æ±‚ä¸¦è¿”å›çµæœ
    â†“
æ­¥é©Ÿ 9: Gateway è½‰ç™¼éŸ¿æ‡‰å› AI-Box
```

### 5.6 å¤š Agent å…±å­˜ç¤ºä¾‹

**å‡è¨­ Gateway ä¸Šè¨»å†Šäº†å¤šå€‹ Agent**ï¼š

```toml
MCP_ROUTES = '''
[
  {
    "pattern": "warehouse_*",
    "target": "https://warehouse-agent.ngrok.app"
  },
  {
    "pattern": "finance_*",
    "target": "https://finance-agent.ngrok.app"
  },
  {
    "pattern": "office_*",
    "target": "https://office-agent.ngrok.app"
  }
]
'''
```

**èª¿ç”¨ç¤ºä¾‹**ï¼š

| å·¥å…·åç¨± | Gateway åŒ¹é… | è·¯ç”±ç›®æ¨™ | å°æ‡‰ Agent |
|---------|------------|---------|-----------|
| `warehouse_execute_task` | `warehouse_*` | `https://warehouse-agent.ngrok.app` | åº«ç®¡å“¡ Agent |
| `finance_get_quote` | `finance_*` | `https://finance-agent.ngrok.app` | è²¡å‹™ Agent |
| `office_create_document` | `office_*` | `https://office-agent.ngrok.app` | Office Agent |

**é—œéµé»**ï¼š

- âœ… æ‰€æœ‰ Agent éƒ½ä½¿ç”¨**åŒä¸€å€‹ Gateway ç«¯é»**ï¼š`https://mcp.k84.org`
- âœ… Gateway æ ¹æ“š**å·¥å…·åç¨±çš„å‰ç¶´**è‡ªå‹•è·¯ç”±åˆ°æ­£ç¢ºçš„ Agent
- âœ… ä¸éœ€è¦ç‚ºæ¯å€‹ Agent é…ç½®ä¸åŒçš„ç«¯é» URL

---

## ğŸ§ª æ­¥é©Ÿ 6: é©—è­‰é…ç½®

### 6.1 æ¸¬è©¦ Cloudflare Gateway è·¯ç”±

```bash
curl -X POST https://mcp.k84.org \
  -H "Content-Type: application/json" \
  -H "X-Gateway-Secret: 0d28bdb881c5aeea501bf535b45c153ea78bf6f28b4856a41e36068dfbf7410e" \
  -H "X-User-ID: test-user" \
  -H "X-Tenant-ID: test-tenant" \
  -H "X-Tool-Name: warehouse_query_part" \
  -d '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "tools/list"
  }'
```

**é æœŸçµæœ**:

- âœ… å¦‚æœè·¯ç”±é…ç½®æ­£ç¢ºï¼ŒGateway æœƒè½‰ç™¼è«‹æ±‚åˆ°åº«ç®¡å“¡ Agent
- âœ… å¦‚æœåº«ç®¡å“¡ Agent æ­£å¸¸é‹è¡Œï¼Œæœƒè¿”å›å·¥å…·åˆ—è¡¨

### 6.2 æª¢æŸ¥ Agent è¨»å†Šç‹€æ…‹

```bash
curl http://localhost:8000/api/v1/agents/warehouse-manager-agent
```

**é æœŸéŸ¿æ‡‰**:

```json
{
  "success": true,
  "data": {
    "agent_id": "warehouse-manager-agent",
    "name": "åº«ç®¡å“¡ Agent",
    "status": "registering",
    "is_internal": false,
    "protocol": "mcp",
    "endpoints": {
      "mcp": "https://mcp.k84.org",
      "protocol": "mcp",
      "is_internal": false
    }
  }
}
```

### 6.3 ç®¡ç†å“¡æ ¸å‡†

**æ ¸å‡†æµç¨‹èªªæ˜**ï¼š

Agent è¨»å†Šå¾Œï¼Œç‹€æ…‹ç‚º `REGISTERING`ï¼ˆè¨»å†Šä¸­ï¼‰ï¼Œéœ€è¦ç®¡ç†å“¡æ ¸å‡†æ‰èƒ½è½‰ç‚º `ONLINE`ï¼ˆåœ¨ç·šï¼‰ç‹€æ…‹ã€‚

**æ ¸å‡†æ“ä½œ**ï¼š

```bash
curl -X POST "http://localhost:8000/api/v1/agents/warehouse-manager-agent/approve?approved=true" \
  -H "Content-Type: application/json"
```

**æ ¸å‡†çµæœ**ï¼š

- **æ ¸å‡†**ï¼ˆ`approved=true`ï¼‰ï¼šç‹€æ…‹è½‰ç‚º `ONLINE`ï¼ˆåœ¨ç·šï¼‰ï¼ŒAgent å¯ä»¥æ­£å¸¸ä½¿ç”¨
- **æ‹’çµ•**ï¼ˆ`approved=false`ï¼‰ï¼šç‹€æ…‹è½‰ç‚º `DEPRECATED`ï¼ˆå·²ä½œå»¢ï¼‰ï¼ŒAgent ç„¡æ³•ä½¿ç”¨

**ç‹€æ…‹èªªæ˜**ï¼š

| ç‹€æ…‹ | èªªæ˜ | æ˜¯å¦å¯ä»¥èª¿ç”¨ |
|------|------|------------|
| `REGISTERING` | è¨»å†Šä¸­ï¼Œç­‰å¾…ç®¡ç†å–®ä½æ ¸å‡† | âŒ å¦ |
| `ONLINE` | åœ¨ç·šï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨ | âœ… æ˜¯ |
| `MAINTENANCE` | ç¶­ä¿®ä¸­ï¼Œæš«æ™‚ç„¡æ³•æ¥å—æ–°ä»»å‹™ | âŒ å¦ |
| `DEPRECATED` | å·²ä½œå»¢ï¼Œä¸å†ä½¿ç”¨ | âŒ å¦ |
| `OFFLINE` | é›¢ç·šï¼ˆå¥åº·æª¢æŸ¥/å¿ƒè·³è¶…æ™‚æ¨™è¨˜ï¼‰ | âŒ å¦ |

### 6.4 é©—è­‰ Agent å¯ç”¨æ€§

æ ¸å‡†å¾Œï¼ŒAgent ç‹€æ…‹æ‡‰ç‚º `ONLINE`ï¼š

```bash
curl http://localhost:8000/api/v1/agents/warehouse-manager-agent
```

**æœŸæœ›éŸ¿æ‡‰**:

```json
{
  "success": true,
  "data": {
    "agent_id": "warehouse-manager-agent",
    "status": "online",
    ...
  }
}
```

---

## ğŸ“Š é…ç½®æª¢æŸ¥æ¸…å–®

### Cloudflare Gateway é…ç½®

- [ ] `wrangler.toml` ä¸­å·²æ·»åŠ  `warehouse_*` è·¯ç”±è¦å‰‡
- [ ] Gateway å·²éƒ¨ç½²æ›´æ–°
- [ ] èªè­‰é…ç½®å·²è¨­ç½®ï¼ˆå¦‚éœ€è¦ï¼‰
- [ ] è·¯ç”±æ¸¬è©¦é€šé

### AI-Box Agent è¨»å†Š

- [ ] Secret ID/Key å·²ç”Ÿæˆä¸¦é©—è­‰
- [ ] Agent å·²è¨»å†Šï¼ˆç«¯é»æŒ‡å‘ Cloudflare Gatewayï¼‰
- [ ] Agent ç‹€æ…‹ç‚º `online`
- [ ] å·¥å…·èª¿ç”¨æ¸¬è©¦é€šé

---

## ğŸ” å¸¸è¦‹å•é¡Œ

### Q1: ç‚ºä»€éº¼è¦é€šé Cloudflare Gatewayï¼Ÿ

**A**: Cloudflare Gateway æä¾›ä»¥ä¸‹å„ªå‹¢ï¼š

1. **çµ±ä¸€ç®¡ç†**: æ‰€æœ‰å¤–éƒ¨ MCP æœå‹™é€šéåŒä¸€å€‹ Gateway ç®¡ç†
2. **å®‰å…¨éš”é›¢**: Gateway ä½œç‚ºå®‰å…¨å±¤ï¼Œä¿è­·å…§éƒ¨æœå‹™
3. **èªè­‰ç®¡ç†**: é›†ä¸­ç®¡ç†å¤–éƒ¨æœå‹™çš„èªè­‰ä¿¡æ¯
4. **å¯©è¨ˆæ—¥èªŒ**: çµ±ä¸€è¨˜éŒ„æ‰€æœ‰å¤–éƒ¨æœå‹™çš„è¨ªå•æ—¥èªŒ
5. **é€Ÿç‡é™åˆ¶**: é˜²æ­¢å¤–éƒ¨æœå‹™è¢«æ¿«ç”¨

### Q2: åº«ç®¡å“¡ Agent ç«¯é»æ‡‰è©²é…ç½®ä»€éº¼ï¼Ÿ

**A**:

- **åœ¨ AI-Box ä¸­è¨»å†Šæ™‚**: ç«¯é»æ‡‰è©²æŒ‡å‘ Cloudflare Gatewayï¼ˆ`https://mcp.k84.org`ï¼‰
- **åœ¨ Cloudflare Gateway è·¯ç”±ä¸­**: ç«¯é»æ‡‰è©²æŒ‡å‘åº«ç®¡å“¡ Agent çš„å¯¦éš›ç«¯é»ï¼ˆ`http://your-warehouse-agent-host:8003/mcp`ï¼‰

### Q3: å¦‚æœåº«ç®¡å“¡ Agent éƒ¨ç½²åœ¨å…§ç¶²æ€éº¼è¾¦ï¼Ÿ

**A**: æœ‰å¹¾ç¨®è§£æ±ºæ–¹æ¡ˆï¼š

1. **ä½¿ç”¨å…§ç¶²ç©¿é€**: ä½¿ç”¨ ngrokã€Cloudflare Tunnel ç­‰å·¥å…·å°‡å…§ç¶²æœå‹™æš´éœ²åˆ°å…¬ç¶²
2. **VPN é€£æ¥**: ç¢ºä¿ Cloudflare Gateway èƒ½å¤ é€šé VPN è¨ªå•å…§ç¶²æœå‹™
3. **ç›´æ¥é€£æ¥**: å¦‚æœ AI-Box å’Œåº«ç®¡å“¡ Agent åœ¨åŒä¸€å…§ç¶²ï¼Œå¯ä»¥ä¸ä½¿ç”¨ Gatewayï¼Œç›´æ¥è¨»å†Š Agent ç«¯é»

### Q4: å·¥å…·åç¨±å¿…é ˆä»¥ `warehouse_` é–‹é ­å—ï¼Ÿ

**A**: æ˜¯çš„ï¼Œç‚ºäº†åŒ¹é… Cloudflare Gateway çš„è·¯ç”±è¦å‰‡ `warehouse_*`ï¼Œå·¥å…·åç¨±å¿…é ˆä»¥ `warehouse_` é–‹é ­ã€‚å¦‚æœä½¿ç”¨å…¶ä»–å‰ç¶´ï¼Œéœ€è¦ç›¸æ‡‰æ›´æ–° Gateway è·¯ç”±è¦å‰‡ã€‚

### Q5: å¦‚ä½•æ›´æ–°è·¯ç”±é…ç½®ï¼Ÿ

**A**:

1. ç·¨è¼¯ `mcp/gateway/wrangler.toml`
2. æ›´æ–° `MCP_ROUTES` é…ç½®
3. åŸ·è¡Œ `wrangler deploy` éƒ¨ç½²æ›´æ–°

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [åº«ç®¡å“¡-Agent-è¦æ ¼æ›¸](./åº«ç®¡å“¡-Agent-è¦æ ¼æ›¸.md) - å®Œæ•´çš„ Agent è¦æ ¼èªªæ˜
- [åº«ç®¡å“¡-Agent-è¨»å†Šé…ç½®æŒ‡å—](./åº«ç®¡å“¡-Agent-è¨»å†Šé…ç½®æŒ‡å—.md) - ç›´æ¥è¨»å†ŠæŒ‡å—ï¼ˆä¸ä½¿ç”¨ Gatewayï¼‰
- [Cloudflare MCP Gateway è®¾ç½®æŒ‡å—](../MCPå·¥å…·/Cloudflare-MCP-Gateway-è®¾ç½®æŒ‡å—.md) - Gateway è©³ç´°è¨­ç½®
- [ç¬¬ä¸‰æ–¹ MCP æœåŠ¡é…ç½®æŒ‡å—](../MCPå·¥å…·/ç¬¬ä¸‰æ–¹MCPæœåŠ¡é…ç½®æŒ‡å—.md) - ç¬¬ä¸‰æ–¹æœå‹™é…ç½®ä¸»æŒ‡å—
- [Cloudflareç¬¬ä¸‰æ–¹MCPæœå‹™æœ€çµ‚éƒ¨ç½²ç‹€æ…‹](../MCPå·¥å…·/Cloudflareç¬¬ä¸‰æ–¹MCPæœå‹™æœ€çµ‚éƒ¨ç½²ç‹€æ…‹.md) - Gateway ç•¶å‰éƒ¨ç½²ç‹€æ…‹

---

## ğŸ¯ æœ€çµ‚é…ç½®ç‹€æ…‹ï¼ˆ2026-01-14ï¼‰

### âœ… é…ç½®æˆåŠŸç¸½çµ

**æ ¸å¿ƒåŠŸèƒ½**: âœ… **å…¨éƒ¨æ­£å¸¸å·¥ä½œ**

#### 1. æœ¬åœ°æœå‹™é…ç½® âœ…

- **æœå‹™é‹è¡Œ**: `localhost:8003` âœ…
- **å¥åº·æª¢æŸ¥**: `http://localhost:8003/health` âœ…
- **MCP ç«¯é»**:
  - `http://localhost:8003/mcp` âœ…
  - `http://localhost:8003/` âœ…ï¼ˆæ ¹è·¯å¾‘ï¼Œç”¨æ–¼ Tunnel/ngrokï¼‰
- **å·¥å…·è¨»å†Š**: `warehouse_execute_task` âœ…

#### 2. ngrok é…ç½® âœ…

- **ngrok URL**: `https://182740a0a99a.ngrok-free.app` âœ…
- **ngrok Authtoken**: å·²é…ç½® âœ…
- **ç›´æ¥è¨ªå•**: âœ… æˆåŠŸï¼ˆHTTP 200ï¼Œè¿”å›å·¥å…·åˆ—è¡¨ï¼‰

#### 3. Cloudflare Gateway é…ç½® âœ…

**è·¯ç”±é…ç½®**:

- **è·¯ç”±è¦å‰‡**: `warehouse_*` â†’ `https://182740a0a99a.ngrok-free.app` âœ…
- **èªè­‰é…ç½®**: `auth:warehouse_execute_task` = `{"type":"none"}` âœ…
- **æ¬Šé™é…ç½®**: `permissions:test-tenant:default` = `{"tools":["warehouse_*"]}` âœ…

**ç«¯é»ç‹€æ…‹**:

- **Workers.dev URL**: `https://mcp-gateway.896445070.workers.dev` âœ… æ­£å¸¸å·¥ä½œ
- **è‡ªå®šç¾©åŸŸå**: `https://mcp.k84.org` âœ… å·²é…ç½®ä¸¦æ­£å¸¸å·¥ä½œï¼ˆåœ¨ Dashboard ä¸­è¨­ç½®è·¯ç”±ï¼‰

**éƒ¨ç½²ä¿¡æ¯**:

- **Worker åç¨±**: `mcp-gateway`
- **ç•¶å‰ç‰ˆæœ¬ ID**: `ff825e48-8a80-477d-b6d4-61acd3e79304` (2026-01-14)
- **éƒ¨ç½²ç‹€æ…‹**: âœ… å·²éƒ¨ç½²

#### 4. æ¸¬è©¦é©—è­‰çµæœ âœ…

**Gateway (workers.dev) æ¸¬è©¦**: âœ… **æˆåŠŸï¼**

```bash
$ curl -X POST https://mcp-gateway.896445070.workers.dev \
  -H "Content-Type: application/json" \
  -H "X-Gateway-Secret: 0d28bdb881c5aeea501bf535b45c153ea78bf6f28b4856a41e36068dfbf7410e" \
  -H "X-User-ID: test-user" \
  -H "X-Tenant-ID: test-tenant" \
  -H "X-Tool-Name: warehouse_execute_task" \
  -d '{"jsonrpc":"2.0","id":1,"method":"tools/list"}'

âœ… æˆåŠŸè¿”å›å·¥å…·åˆ—è¡¨
å·¥å…·æ•¸é‡: 1
å·¥å…·åç¨±: warehouse_execute_task
```

**Gateway (è‡ªå®šç¾©åŸŸå) æ¸¬è©¦**: âœ… **æˆåŠŸï¼**

```bash
$ curl -X POST https://mcp.k84.org \
  -H "Content-Type: application/json" \
  -H "X-Gateway-Secret: 0d28bdb881c5aeea501bf535b45c153ea78bf6f28b4856a41e36068dfbf7410e" \
  -H "X-User-ID: test-user" \
  -H "X-Tenant-ID: test-tenant" \
  -H "X-Tool-Name: warehouse_execute_task" \
  -d '{"jsonrpc":"2.0","id":1,"method":"tools/list"}'

âœ… æˆåŠŸè¿”å›å·¥å…·åˆ—è¡¨
```

### ğŸ“Š å®Œæ•´é…ç½®æ‘˜è¦

#### ç•¶å‰å¯ç”¨ç«¯é»

| ç«¯é» | URL | ç‹€æ…‹ | èªªæ˜ |
|------|-----|------|------|
| **æœ¬åœ°æœå‹™** | `http://localhost:8003` | âœ… | æœ¬åœ°é–‹ç™¼ |
| **ngrok** | `https://182740a0a99a.ngrok-free.app` | âœ… | å…§ç¶²ç©¿é€ |
| **Gateway (workers.dev)** | `https://mcp-gateway.896445070.workers.dev` | âœ… | ç”Ÿç”¢ç’°å¢ƒ |
| **Gateway (è‡ªå®šç¾©åŸŸå)** | `https://mcp.k84.org` | âœ… | ç”Ÿç”¢ç’°å¢ƒï¼ˆæ¨è–¦ï¼‰ |

#### Gateway é…ç½®è©³æƒ…

**wrangler.toml è·¯ç”±é…ç½®**:

```toml
MCP_ROUTES = '''
[
  {
    "pattern": "yahoo_finance_*",
    "target": "https://smithery.ai/server/@tsmdev-ux/yahoo-finance-mcp"
  },
  {
    "pattern": "warehouse_*",
    "target": "https://182740a0a99a.ngrok-free.app"
  }
]
'''
```

**KV èªè­‰é…ç½®**:

```bash
# å·¥å…·èªè­‰ï¼ˆç„¡èªè­‰ï¼‰
auth:warehouse_execute_task = {"type":"none"}
```

**KV æ¬Šé™é…ç½®**:

```bash
# ç§Ÿæˆ¶é»˜èªæ¬Šé™
permissions:test-tenant:default = {"tools":["warehouse_*"]}
```

#### DNS å’Œè·¯ç”±é…ç½®

**DNS è¨˜éŒ„** (Cloudflare Dashboard):

- **é¡å‹**: CNAME
- **åç¨±**: `mcp`
- **ç›®æ¨™**: `mcp-gateway.896445070.workers.dev`
- **ä»£ç†ç‹€æ…‹**: âœ… å·²å•Ÿç”¨ï¼ˆæ©™è‰²é›²æœµï¼‰

**Worker è·¯ç”±** (Cloudflare Dashboard):

- **è·¯ç”±**: `mcp.k84.org/*`
- **Zone**: `k84.org`
- **ç‹€æ…‹**: âœ… å·²ç¶å®šåˆ° `mcp-gateway` Worker

### ğŸ‰ é…ç½®å®Œæˆæ¸…å–®

#### Cloudflare Gateway é…ç½®

- [x] `wrangler.toml` ä¸­å·²æ·»åŠ  `warehouse_*` è·¯ç”±è¦å‰‡
- [x] Gateway å·²éƒ¨ç½²æ›´æ–°
- [x] èªè­‰é…ç½®å·²è¨­ç½®ï¼ˆç„¡èªè­‰ï¼‰
- [x] æ¬Šé™é…ç½®å·²è¨­ç½®ï¼ˆå…è¨± `warehouse_*`ï¼‰
- [x] DNS è¨˜éŒ„å·²é…ç½® (mcp.k84.org)
- [x] Worker è·¯ç”±å·²åœ¨ Dashboard ä¸­ç¶å®š
- [x] è·¯ç”±æ¸¬è©¦é€šéï¼ˆworkers.dev å’Œè‡ªå®šç¾©åŸŸåï¼‰

#### ngrok é…ç½®

- [x] ngrok å¸³è™Ÿå·²è¨»å†Š
- [x] Authtoken å·²é…ç½®
- [x] ngrok å·²å•Ÿå‹•ä¸¦é‹è¡Œ
- [x] Gateway è·¯ç”±å·²æ›´æ–°ç‚º ngrok URL
- [x] ngrok ç›´æ¥è¨ªå•æ¸¬è©¦é€šé

#### åº«ç®¡å“¡ Agent é…ç½®

- [x] Agent æœå‹™å·²å•Ÿå‹• (localhost:8003)
- [x] MCP ç«¯é»å·²é…ç½® (`/mcp` å’Œ `/`)
- [x] å·¥å…·å·²è¨»å†Š (`warehouse_execute_task`)
- [x] Gateway è·¯ç”±å·²é…ç½® (`warehouse_*`)
- [x] Gateway èªè­‰å·²é…ç½®ï¼ˆç„¡èªè­‰ï¼‰
- [x] Gateway æ¬Šé™å·²é…ç½®ï¼ˆå…è¨± `warehouse_*`ï¼‰

#### æ¸¬è©¦é©—è­‰

- [x] æœ¬åœ°æœå‹™æ¸¬è©¦é€šé
- [x] ngrok ç›´æ¥è¨ªå•æ¸¬è©¦é€šé
- [x] Gateway (workers.dev) æ¸¬è©¦é€šé
- [x] Gateway (è‡ªå®šç¾©åŸŸå) æ¸¬è©¦é€šé

---

## ğŸ¯ ç¸½çµ

### é…ç½®æµç¨‹

1. âœ… **é…ç½® Cloudflare Gateway è·¯ç”±** - æ·»åŠ  `warehouse_*` è·¯ç”±è¦å‰‡
2. âœ… **é…ç½® Cloudflare Gateway èªè­‰** - è¨­ç½® Agent èªè­‰ä¿¡æ¯ï¼ˆç„¡èªè­‰ï¼‰
3. âœ… **é…ç½® Cloudflare Gateway æ¬Šé™** - è¨­ç½®ç”¨æˆ¶æ¬Šé™ï¼ˆå…è¨± `warehouse_*`ï¼‰
4. âœ… **é…ç½® ngrok** - æš´éœ²æœ¬åœ°æœå‹™åˆ°å…¬ç¶²
5. âœ… **é…ç½® DNS å’Œè·¯ç”±** - è¨­ç½®è‡ªå®šç¾©åŸŸå `mcp.k84.org`
6. âœ… **åœ¨ AI-Box ä¸­è¨»å†Š Agent** - ç«¯é»æŒ‡å‘ Cloudflare Gatewayï¼ˆ`https://mcp.k84.org`ï¼‰
7. âœ… **ç®¡ç†å“¡æ ¸å‡†** - å°‡ Agent ç‹€æ…‹å¾ `registering` è½‰ç‚º `online`
8. âœ… **é©—è­‰é…ç½®** - æ¸¬è©¦ Agent èª¿ç”¨ï¼ˆå…¨éƒ¨é€šéï¼‰

### é—œéµé…ç½®é»

- **AI-Box è¨»å†Šç«¯é»**: `https://mcp.k84.org`ï¼ˆCloudflare Gateway è‡ªå®šç¾©åŸŸåï¼‰âœ…
- **Gateway è·¯ç”±ç›®æ¨™**: `https://182740a0a99a.ngrok-free.app`ï¼ˆngrok æš´éœ²çš„æœ¬åœ°æœå‹™ï¼‰âœ…
- **å·¥å…·åç¨±å‰ç¶´**: `warehouse_*`ï¼ˆå¿…é ˆåŒ¹é…è·¯ç”±è¦å‰‡ï¼‰âœ…
- **Gateway Secret**: `0d28bdb881c5aeea501bf535b45c153ea78bf6f28b4856a41e36068dfbf7410e` âœ…

### ç•¶å‰ç‹€æ…‹

**æ‰€æœ‰é…ç½®å·²å®Œæˆä¸¦æ­£å¸¸å·¥ä½œ** âœ…

- âœ… æœ¬åœ°æœå‹™é‹è¡Œæ­£å¸¸
- âœ… ngrok é…ç½®æˆåŠŸä¸¦é‹è¡Œ
- âœ… Cloudflare Gateway é…ç½®å®Œæˆä¸¦éƒ¨ç½²
- âœ… DNS å’Œè·¯ç”±é…ç½®å®Œæˆ
- âœ… æ‰€æœ‰ç«¯é»æ¸¬è©¦é€šé
- âœ… å·¥å…·åˆ—è¡¨æŸ¥è©¢æˆåŠŸ

---

## ğŸ“š ç›¸é—œæ–‡æª”

### ä¸»è¦æ–‡æª”

- [åº«ç®¡å“¡-Agent-è¦æ ¼æ›¸](./åº«ç®¡å“¡-Agent-è¦æ ¼æ›¸.md) - å®Œæ•´çš„ Agent è¦æ ¼èªªæ˜
- [åº«ç®¡å“¡-Agent-è¨»å†Šé…ç½®æŒ‡å—](./åº«ç®¡å“¡-Agent-è¨»å†Šé…ç½®æŒ‡å—.md) - ç›´æ¥è¨»å†ŠæŒ‡å—ï¼ˆä¸ä½¿ç”¨ Gatewayï¼‰
- [Cloudflare MCP Gateway è®¾ç½®æŒ‡å—](../MCPå·¥å…·/Cloudflare-MCP-Gateway-è®¾ç½®æŒ‡å—.md) - Gateway è©³ç´°è¨­ç½®å’Œå®Œæ•´é…ç½®

### æ­¸æª”æ–‡æª”

æ‰€æœ‰å•é¡Œè§£æ±ºå’Œé…ç½®éç¨‹å ±å‘Šå·²æ­¸æª”åˆ° `archive/åº«ç®¡å“¡-Agent-é…ç½®éç¨‹/` ç›®éŒ„ï¼ŒåŒ…æ‹¬ï¼š

- æœå‹™å•Ÿå‹•è¨ºæ–·å ±å‘Š
- Tunnel é…ç½®å•é¡Œæ’æŸ¥
- ngrok é…ç½®æŒ‡å—å’Œå ±å‘Š
- å…§ç¶²ç©¿é€è¨­ç½®æŒ‡å—
- 522 éŒ¯èª¤æ’æŸ¥å ±å‘Š
- é…ç½®å®Œæˆå ±å‘Š
- æœ€çµ‚ç‹€æ…‹å ±å‘Š

---

**ç‰ˆæœ¬**: 2.0
**æœ€å¾Œæ›´æ–°æ—¥æœŸ**: 2026-01-14
**ç¶­è­·äºº**: Daniel Chung
