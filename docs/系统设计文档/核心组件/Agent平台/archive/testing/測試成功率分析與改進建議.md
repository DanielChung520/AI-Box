# æ¸¬è©¦æˆåŠŸç‡åˆ†æèˆ‡æ”¹é€²å»ºè­°

## ğŸ“Š æ¸¬è©¦çµæœæ‘˜è¦

**æ¸¬è©¦æ—¥æœŸ**: 2026-01-11
**ç¸½å ´æ™¯æ•¸**: 100
**åŸ·è¡Œçµæœ**:

- âœ… ä»»å‹™é¡å‹è­˜åˆ¥æˆåŠŸç‡: **66/100 (66%)**
- âŒ Agent èª¿ç”¨æˆåŠŸç‡: **0/100 (0%)**
- âŒ æ•´é«”é€šéç‡: **0/100 (0%)**

## ğŸ” å•é¡Œå®šä½

### ä¸»è¦å•é¡Œï¼šAgent èª¿ç”¨å¤±æ•—ç‡ 100%

å¾æ¸¬è©¦çµæœåˆ†æï¼Œæ‰€æœ‰ 100 å€‹æ¸¬è©¦å ´æ™¯éƒ½å­˜åœ¨ä»¥ä¸‹å•é¡Œï¼š

1. **96/100 å ´æ™¯è¿”å›ç©º Agent åˆ—è¡¨** (`actual_agents: []`)
2. **ä»»å‹™é¡å‹è­˜åˆ¥ç›¸å°è¼ƒå¥½** (66% æ­£ç¢ºç‡)
3. **ç³»çµ±èƒ½å¤ è­˜åˆ¥ä»»å‹™é¡å‹ï¼Œä½†ç„¡æ³•æ­£ç¢ºé¸æ“‡å°æ‡‰çš„ Agent**

### å…·é«”å•é¡Œåˆ†æ

**ç¤ºä¾‹å ´æ™¯**:

- MD-001: `ç·¨è¼¯æ–‡ä»¶ README.md` â†’ é æœŸ: `md-editor`, å¯¦éš›: `[]`
- XLS-001: `ç·¨è¼¯æ–‡ä»¶ data.xlsx` â†’ é æœŸ: `xls-editor`, å¯¦éš›: `[]`
- MD2PDF-001: `å°‡ README.md è½‰æ›ç‚º PDF` â†’ é æœŸ: `md-to-pdf`, å¯¦éš›: `[]`

**å•é¡Œæ ¹æº**:

1. `TaskAnalyzer` èƒ½å¤ æ­£ç¢ºè­˜åˆ¥ä»»å‹™é¡å‹ (`execution`)
2. ä½† `DecisionEngine` ç„¡æ³•åŒ¹é…åˆ°å°æ‡‰çš„ Agent (`chosen_agent` ç‚ºç©º)
3. å°è‡´ `suggested_agents` ç‚ºç©ºæ•¸çµ„

## ğŸ’¡ æ”¹é€²å»ºè­°

### æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ RAG å¢å¼· Agent é¸æ“‡ï¼ˆæ¨è–¦ï¼‰

#### 1.1 åœ¨ TaskAnalyzer ä¸­é›†æˆ RAG æª¢ç´¢

**ç›®æ¨™**: é€šéèªç¾©æª¢ç´¢åŒ¹é…ç”¨æˆ¶æ„åœ–èˆ‡ Agent èƒ½åŠ›æè¿°

**å¯¦ç¾æ–¹å¼**:

```python
# åœ¨ analyzer.py ä¸­ï¼Œåœ¨èª¿ç”¨ DecisionEngine ä¹‹å‰æ·»åŠ  RAG æª¢ç´¢
from services.api.services.hybrid_rag_service import HybridRAGService

class TaskAnalyzer:
    def __init__(self):
        self._hybrid_rag_service = HybridRAGService()
        self._decision_engine = DecisionEngine()

    async def analyze(self, request: TaskAnalysisRequest) -> TaskAnalysisResult:
        # 1. ä½¿ç”¨ RouterLLM é€²è¡Œåˆæ­¥æ„åœ–åˆ†æ
        router_decision = await self._router_llm.route(router_input)

        # 2. ä½¿ç”¨ RAG æª¢ç´¢ç›¸é—œçš„ Agent èƒ½åŠ›æè¿°
        if router_decision.needs_agent:
            # æª¢ç´¢ç›¸é—œçš„ Agent èƒ½åŠ›
            agent_capabilities = await self._retrieve_agent_capabilities(
                user_input=request.task,
                intent_type=router_decision.intent_type,
            )

            # 3. å°‡æª¢ç´¢çµæœä½œç‚ºä¸Šä¸‹æ–‡å‚³éçµ¦ DecisionEngine
            decision_result = await self._decision_engine.decide(
                router_decision=router_decision,
                agent_capabilities=agent_capabilities,  # æ–°å¢åƒæ•¸
            )
        else:
            decision_result = await self._decision_engine.decide(router_decision)

        # ...
```

#### 1.2 å‰µå»º Agent èƒ½åŠ›å‘é‡åº«

**æ­¥é©Ÿ**:

1. ç‚ºæ¯å€‹ Agent å‰µå»ºèƒ½åŠ›æè¿°æ–‡æª”ï¼š

   ```markdown
   Agent ID: md-editor
   èƒ½åŠ›æè¿°:
   - ç·¨è¼¯ Markdown æ–‡ä»¶
   - ä¿®æ”¹ã€æ·»åŠ ã€åˆªé™¤ Markdown å…§å®¹
   - æ ¼å¼åŒ– Markdown æ–‡æª”
   - å‰µå»ºæ–°çš„ Markdown æ–‡ä»¶

   é©ç”¨å ´æ™¯:
   - "ç·¨è¼¯æ–‡ä»¶ README.md"
   - "ä¿®æ”¹ docs/guide.md"
   - "åœ¨ README.md ä¸­æ·»åŠ å®‰è£èªªæ˜"
   - "å‰µå»ºä¸€å€‹æ–°çš„ Markdown æ–‡ä»¶ CONTRIBUTING.md"
   ```

2. å°‡ Agent èƒ½åŠ›æè¿°å­˜å…¥å‘é‡æ•¸æ“šåº«
3. ä½¿ç”¨èªç¾©æª¢ç´¢åŒ¹é…ç”¨æˆ¶è¼¸å…¥èˆ‡ Agent èƒ½åŠ›

#### 1.3 å¯¦ç¾ Agent èƒ½åŠ›æª¢ç´¢æœå‹™

```python
# agents/task_analyzer/agent_capability_retriever.py
from typing import List, Dict
from services.api.services.hybrid_rag_service import HybridRAGService

class AgentCapabilityRetriever:
    """Agent èƒ½åŠ›æª¢ç´¢æœå‹™"""

    def __init__(self):
        self._rag_service = HybridRAGService()
        self._agent_capabilities_collection = "agent_capabilities"

    async def retrieve_matching_agents(
        self,
        user_input: str,
        intent_type: str,
        top_k: int = 5,
    ) -> List[Dict[str, Any]]:
        """
        æª¢ç´¢åŒ¹é…çš„ Agent

        Args:
            user_input: ç”¨æˆ¶è¼¸å…¥
            intent_type: æ„åœ–é¡å‹
            top_k: è¿”å›å‰ K å€‹åŒ¹é…çµæœ

        Returns:
            åŒ¹é…çš„ Agent åˆ—è¡¨ï¼Œæ¯å€‹åŒ…å« agent_id å’Œç›¸ä¼¼åº¦åˆ†æ•¸
        """
        # æ§‹å»ºæª¢ç´¢æŸ¥è©¢
        query = f"{user_input} {intent_type}"

        # ä½¿ç”¨ HybridRAG æª¢ç´¢
        results = await self._rag_service.retrieve(
            query=query,
            collection_name=self._agent_capabilities_collection,
            top_k=top_k,
        )

        # æå– Agent ID å’Œç›¸ä¼¼åº¦
        matching_agents = []
        for result in results:
            agent_id = result.get("metadata", {}).get("agent_id")
            score = result.get("score", 0.0)
            if agent_id:
                matching_agents.append({
                    "agent_id": agent_id,
                    "score": score,
                    "metadata": result.get("metadata", {}),
                })

        return matching_agents
```

### æ–¹æ¡ˆ 2ï¼šæ”¹é€² DecisionEngine çš„ Agent åŒ¹é…é‚è¼¯

#### 2.1 å¢å¼· CapabilityMatcher

**ç•¶å‰å•é¡Œ**: `CapabilityMatcher` å¯èƒ½ä¾è³´é—œéµè©åŒ¹é…ï¼Œç„¡æ³•è™•ç†èªç¾©ç›¸ä¼¼æ€§

**æ”¹é€²æ–¹å¼**:

1. ä½¿ç”¨èªç¾©åµŒå…¥è¨ˆç®—ç”¨æˆ¶è¼¸å…¥èˆ‡ Agent èƒ½åŠ›çš„ç›¸ä¼¼åº¦
2. è¨­ç½®ç›¸ä¼¼åº¦é–¾å€¼ï¼ˆå¦‚ 0.7ï¼‰
3. è¿”å›æœ€åŒ¹é…çš„ Agent

#### 2.2 æ·»åŠ  Agent è¨»å†Šè¡¨æŸ¥è©¢

**å¯¦ç¾æ–¹å¼**:

```python
# åœ¨ DecisionEngine ä¸­
from agents.services.registry.registry import AgentRegistry

class DecisionEngine:
    async def decide(self, router_decision: RouterDecision) -> DecisionResult:
        # å¦‚æœ needs_agent=Trueï¼ŒæŸ¥è©¢ Agent Registry
        if router_decision.needs_agent:
            # ç²å–æ‰€æœ‰è¨»å†Šçš„ Agent
            registry = AgentRegistry()
            available_agents = await registry.list_agents()

            # ä½¿ç”¨ CapabilityMatcher åŒ¹é…
            matched_agent = await self._capability_matcher.match(
                user_input=router_decision.user_query,
                intent_type=router_decision.intent_type,
                available_agents=available_agents,
            )

            return DecisionResult(
                chosen_agent=matched_agent,
                # ...
            )
```

### æ–¹æ¡ˆ 3ï¼šæ”¹é€² RouterLLM çš„ Prompt

#### 3.1 åœ¨ Prompt ä¸­æ·»åŠ  Agent åˆ—è¡¨

**ç•¶å‰å•é¡Œ**: RouterLLM çš„ System Prompt æ²’æœ‰æä¾›å¯ç”¨çš„ Agent åˆ—è¡¨

**æ”¹é€²æ–¹å¼**:

```python
# åœ¨ router_llm.py ä¸­ï¼Œå‹•æ…‹æ§‹å»º Prompt
async def route(self, router_input: RouterInput) -> RouterDecision:
    # ç²å–å¯ç”¨ Agent åˆ—è¡¨
    from agents.services.registry.registry import AgentRegistry
    registry = AgentRegistry()
    available_agents = await registry.list_agents()

    # æ§‹å»ºåŒ…å« Agent åˆ—è¡¨çš„ Prompt
    agent_list = "\n".join([
        f"- {agent.id}: {agent.description}"
        for agent in available_agents
    ])

    enhanced_prompt = f"""{ROUTER_SYSTEM_PROMPT}

Available Agents:
{agent_list}

When needs_agent=true, you should specify which agent should be used in the response.
"""
    # ...
```

#### 3.2 æ·»åŠ  Agent é¸æ“‡ç¤ºä¾‹

åœ¨ System Prompt ä¸­æ·»åŠ æ˜ç¢ºçš„ Agent é¸æ“‡ç¤ºä¾‹ï¼š

```python
AGENT_SELECTION_EXAMPLES = """
Agent Selection Examples:
- "ç·¨è¼¯æ–‡ä»¶ README.md" â†’ md-editor
- "ç·¨è¼¯æ–‡ä»¶ data.xlsx" â†’ xls-editor
- "å°‡ README.md è½‰æ›ç‚º PDF" â†’ md-to-pdf
- "å°‡ data.xlsx è½‰æ›ç‚º PDF" â†’ xls-to-pdf
- "å°‡ document.pdf è½‰æ›ç‚º Markdown" â†’ pdf-to-md
"""
```

### æ–¹æ¡ˆ 4ï¼šæ··åˆæ–¹æ¡ˆï¼ˆæœ€ä½³å¯¦è¸ï¼‰

**å»ºè­°æ¡ç”¨ä»¥ä¸‹çµ„åˆ**:

1. **çŸ­æœŸæ”¹é€²**ï¼ˆå¿«é€Ÿè¦‹æ•ˆï¼‰:
   - æ”¹é€² RouterLLM Promptï¼Œæ·»åŠ  Agent åˆ—è¡¨å’Œç¤ºä¾‹
   - æ”¹é€² DecisionEngineï¼Œæ·»åŠ  Agent Registry æŸ¥è©¢
   - ä½¿ç”¨é—œéµè©åŒ¹é…ä½œç‚ºå¾Œå‚™æ–¹æ¡ˆ

2. **ä¸­æœŸæ”¹é€²**ï¼ˆæå‡æº–ç¢ºç‡ï¼‰:
   - å¯¦ç¾ Agent èƒ½åŠ›æª¢ç´¢æœå‹™
   - ä½¿ç”¨ RAG é€²è¡Œèªç¾©åŒ¹é…
   - å»ºç«‹ Agent èƒ½åŠ›å‘é‡åº«

3. **é•·æœŸå„ªåŒ–**ï¼ˆæŒçºŒæ”¹é€²ï¼‰:
   - æ”¶é›†å¤±æ•—æ¡ˆä¾‹ï¼Œå„ªåŒ– Prompt
   - ä½¿ç”¨æ¸¬è©¦çµæœè¨“ç·´æ›´å¥½çš„åŒ¹é…æ¨¡å‹
   - å¯¦ç¾ Agent é¸æ“‡çš„ç½®ä¿¡åº¦è©•ä¼°

## ğŸ“ˆ é æœŸæ•ˆæœ

æ¡ç”¨ä¸Šè¿°æ”¹é€²æ–¹æ¡ˆå¾Œï¼Œé æœŸå¯ä»¥é”åˆ°ï¼š

- **ä»»å‹™é¡å‹è­˜åˆ¥æˆåŠŸç‡**: 66% â†’ **85-90%**
- **Agent èª¿ç”¨æˆåŠŸç‡**: 0% â†’ **70-85%**
- **æ•´é«”é€šéç‡**: 0% â†’ **60-75%**

## ğŸ”§ å¯¦æ–½å„ªå…ˆç´š

1. **P0ï¼ˆç«‹å³å¯¦æ–½ï¼‰**: æ”¹é€² RouterLLM Promptï¼Œæ·»åŠ  Agent åˆ—è¡¨
2. **P1ï¼ˆæœ¬é€±å¯¦æ–½ï¼‰**: æ”¹é€² DecisionEngineï¼Œæ·»åŠ  Agent Registry æŸ¥è©¢
3. **P2ï¼ˆä¸‹é€±å¯¦æ–½ï¼‰**: å¯¦ç¾ Agent èƒ½åŠ›æª¢ç´¢æœå‹™ï¼ˆRAGï¼‰
4. **P3ï¼ˆæŒçºŒå„ªåŒ–ï¼‰**: æ ¹æ“šæ¸¬è©¦çµæœæŒçºŒæ”¹é€²

## ğŸ“ åƒè€ƒè³‡æ–™

- æ¸¬è©¦çµæœæ–‡ä»¶: `tests/agents/test_reports/test_results_20260111_173921.json`
- RouterLLM å¯¦ç¾: `agents/task_analyzer/router_llm.py`
- DecisionEngine å¯¦ç¾: `agents/task_analyzer/decision_engine.py`
- CapabilityMatcher å¯¦ç¾: `agents/task_analyzer/capability_matcher.py`
