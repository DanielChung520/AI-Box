# 階段2 GRO架構轉型使用指南

**版本**：1.0
**創建日期**：2026-01-08
**創建人**：Daniel Chung
**最後修改日期**：2026-01-08

## 概述

本指南說明如何使用階段2實現的GRO架構組件，包括ReAct FSM、Policy Engine、State Store、Observation Collector和Capability Adapter。

## 快速開始

### 1. 使用 ReAct FSM 處理請求

```python
from agents.services.orchestrator.orchestrator import AgentOrchestrator

orchestrator = AgentOrchestrator()

# 使用 ReAct FSM 模式處理請求
result = await orchestrator.process_with_react(
    instruction="查詢系統配置",
    user_id="user-123",
)

print(f"狀態: {result['status']}")
print(f"ReAct ID: {result['react_id']}")
print(f"結果: {result['result']}")
```

### 2. 查看狀態歷史

```python
from agents.services.state_store import StateStore

state_store = StateStore()

# 獲取完整的狀態歷史
history = state_store.get_state_history("react-id-here")

print(f"總迭代次數: {history['total_iterations']}")
print(f"狀態數量: {len(history['states'])}")
print(f"決策日誌數量: {len(history['decision_logs'])}")
```

### 3. 回放 ReAct 循環

```python
from agents.services.react_fsm import ReactStateMachine

fsm = ReactStateMachine()

# 回放指定的 ReAct session
replayed_result = await fsm.replay("react-id-here")

print(f"成功: {replayed_result.success}")
print(f"總迭代次數: {replayed_result.total_iterations}")
```

### 4. 使用 Policy Engine

```python
from agents.services.policy_engine import PolicyEngine
from agents.services.policy_engine.models import PolicyContext
from pathlib import Path

# 加載政策文件
policy_path = Path("config/policies/default_policy.yaml")
engine = PolicyEngine(default_policy_path=policy_path)

# 評估政策
context = PolicyContext(
    command={"risk_level": "critical"},
    constraints={"local_only": True},
    retry_count=0,
)

effective_policy = engine.evaluate(context)

print(f"決策: {effective_policy.decision}")
print(f"命中的規則: {effective_policy.rule_hits}")
```

### 5. 使用 Capability Adapter

```python
from agents.services.capability_adapter import FileAdapter

# 創建文件適配器（會自動從配置文件加載白名單）
adapter = FileAdapter()

# 執行文件操作
result = await adapter.execute(
    "read_file",
    {"file_path": "/tmp/test.txt"}
)

if result.success:
    print(f"文件內容: {result.result['content']}")
else:
    print(f"錯誤: {result.error}")
```

## 配置文件

### 政策文件配置

政策文件位置：`config/policies/default_policy.yaml`

**示例規則**：

```yaml
rules:
  - name: "local_only_guard"
    priority: 200
    when:
      constraints.local_only: true
    then:
      forbid:
        capabilities:
          - "capability.cloud_call"
```

### Capability Adapter 配置

配置文件位置：`config/capability_adapter_config.yaml`

**示例配置**：

```yaml
file_adapter:
  allowed_paths:
    - "/tmp"
    - "/var/log"
    - "/opt/ai-box/data"

database_adapter:
  allowed_tables:
    - "task_records"
    - "react_states"
    - "decision_logs"
```

## 運行測試

### 運行所有階段2測試

```bash
# 運行單元測試
pytest tests/agents/services/ -v

# 運行集成測試
pytest tests/integration/phase2/ -v

# 運行所有測試並生成覆蓋率報告
pytest tests/agents/services/ --cov=agents/services/state_store --cov=agents/services/policy_engine --cov-report=html
```

### 使用測試腳本

```bash
# 運行階段2測試腳本
./tests/agents/services/run_phase2_tests.sh
```

## API 參考

### ReAct FSM

**ReactStateMachine**

- `execute(command, context, react_id)` - 執行ReAct循環
- `replay(react_id)` - 回放ReAct循環

### Policy Engine

**PolicyEngine**

- `load_policy(policy_path)` - 加載政策文件
- `reload_policy(policy_path)` - 重新加載政策文件（熱加載）
- `evaluate(context)` - 評估政策規則

### State Store

**StateStore**

- `save_state(state)` - 保存ReAct狀態
- `get_state(react_id, iteration)` - 獲取ReAct狀態
- `save_decision_log(log)` - 保存Decision Log
- `replay_states(react_id)` - 回放狀態
- `get_state_history(react_id)` - 獲取完整狀態歷史

### Observation Collector

**ObservationCollector**

- `collect(react_id, task_ids, timeout, mode, threshold, message_bus)` - 收集觀察結果
- `fan_in(observations, mode, threshold)` - 執行fan-in匯整
- `generate_summary(observations, mode, threshold)` - 生成Observation Summary

### Capability Adapter

**FileAdapter**

- `execute(capability, params)` - 執行文件操作（read_file、write_file、delete_file、list_files）
- `validate(params)` - 驗證參數

**DatabaseAdapter**

- `execute(capability, params)` - 執行數據庫操作（query、update、insert、delete）
- `validate(params)` - 驗證參數

**APIAdapter**

- `execute(capability, params)` - 執行API調用（get、post、put、delete）
- `validate(params)` - 驗證參數

### Message Bus

**MessageBus**

- `subscribe(message_type, callback)` - 訂閱消息類型
- `publish(message)` - 發布消息
- `publish_task_dispatch(dispatch)` - 發布任務派發消息
- `publish_task_result(result)` - 發布任務結果消息
- `wait_for_results(react_id, task_ids, timeout)` - 等待任務結果（fan-in）

## 向後兼容性

階段2實現完全向後兼容：

- ✅ `process_natural_language_request()` 方法繼續可用
- ✅ 現有API端點不受影響
- ✅ 現有Agent繼續正常工作
- ✅ 可以通過配置選擇使用ReAct FSM模式或傳統模式

## 故障排除

### 問題1：Policy Engine無法加載政策文件

**解決方案**：

- 檢查政策文件路徑是否正確
- 檢查YAML文件格式是否正確
- 查看日誌獲取詳細錯誤信息

### 問題2：State Store無法連接ArangoDB

**解決方案**：

- 檢查ArangoDB連接配置
- 確認Collections已創建（運行Schema腳本）
- 檢查網絡連接

### 問題3：Capability Adapter拒絕操作

**解決方案**：

- 檢查操作是否在白名單中
- 更新配置文件添加允許的路徑/表/端點
- 檢查參數驗證是否通過

## 參考文檔

- [AI-Box-Agent-架構規格書.md](../AI-Box-Agent-架構規格書.md)（內部版本 v4.0）
- [AI-Box-Agent-架構升級計劃-v3.md](./AI-Box-Agent-架構升級計劃-v3.md)（已歸檔，v3 架構升級計劃）
- [階段2實施完成報告.md](./階段2實施完成報告.md)

---

**文檔版本**：1.0
**最後更新**：2026-01-08
**維護者**：Daniel Chung
