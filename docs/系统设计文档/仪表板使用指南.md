# RQ Dashboard 使用說明

**創建日期**: 2025-12-12
**創建人**: Daniel Chung
**最後修改日期**: 2025-12-12

## 📋 概述

RQ Dashboard 是一個 Web 界面，用於監控 RQ 任務隊列的狀態。它**不是 Worker 的一部分**，需要**單獨啟動**。

## 🚀 啟動 Dashboard

### 方式一：使用統一腳本（推薦）⭐

```bash
# 啟動 Dashboard（默認端口 9181）
./scripts/start_services.sh dashboard

# 使用環境變數設置端口為 9182
export RQ_DASHBOARD_PORT=9182
./scripts/start_services.sh dashboard
```

### 方式二：使用獨立腳本

```bash
# 使用默認端口 9181
./scripts/rq_dashboard.sh

# 指定端口 9182
./scripts/rq_dashboard.sh --port 9182
```

## 🌐 訪問 Dashboard

啟動後，訪問：

- **默認端口**: <http://localhost:9181>
- **自定義端口**: <http://localhost:9182（如果設置了> `RQ_DASHBOARD_PORT=9182`）

## ⚙️ 端口配置

### 環境變數配置

在 `.env` 文件中設置：

```bash
RQ_DASHBOARD_PORT=9182
```

或在命令行中設置：

```bash
export RQ_DASHBOARD_PORT=9182
./scripts/start_services.sh dashboard
```

### 默認端口

如果不設置 `RQ_DASHBOARD_PORT`，默認使用端口 **9181**。

## 📊 Dashboard 功能

Dashboard 提供以下功能：

- ✅ 查看所有隊列和任務
- ✅ 查看 Worker 狀態
- ✅ 查看任務詳情（包括參數、錯誤信息）
- ✅ 重試失敗的任務
- ✅ 刪除任務
- ✅ 實時更新

## 🔍 驗證 Dashboard 運行

```bash
# 方法一：使用 status 命令
./scripts/start_services.sh status

# 方法二：檢查端口
lsof -i :9181
# 或
lsof -i :9182

# 方法三：訪問 Web 界面
curl http://localhost:9181
```

## ⚠️ 重要說明

1. **Dashboard 是獨立服務**：啟動 Worker **不會自動啟動 Dashboard**
2. **需要單獨啟動**：使用 `./scripts/start_services.sh dashboard` 啟動
3. **端口配置**：可以通過環境變數 `RQ_DASHBOARD_PORT` 設置端口
4. **依賴 Redis**：Dashboard 需要 Redis 運行才能正常工作

## 🎯 推薦使用方式

### 開發環境

```bash
# 啟動 Worker 和 Dashboard
./scripts/start_services.sh worker
./scripts/start_services.sh dashboard
```

### 生產環境

```bash
# 後台啟動 Dashboard
nohup ./scripts/start_services.sh dashboard > logs/dashboard.log 2>&1 &
```

## 📝 日誌位置

Dashboard 日誌保存在：`logs/rq_dashboard.log`

查看日誌：

```bash
tail -f logs/rq_dashboard.log
```

## 🛑 停止 Dashboard

```bash
# 使用 stop 命令（停止所有服務，包括 Dashboard）
./scripts/start_services.sh stop

# 或手動停止
lsof -ti :9181 | xargs kill -TERM
# 或
lsof -ti :9182 | xargs kill -TERM
```

## 🌐 如何用「前端 Modal」開 RQ Dashboard（推薦，可避免 404）

**「改用前端 Modal 開 RQ」** 指：不直接打 `http://localhost:9181`，改從 **AI-Box 前端** 開啟 RQ Dashboard。

1. 登入 AI-Box 前端（**systemAdmin** 帳號）。
2. 進入 **系統管理** → **服務狀態**（或對應的監控頁）。
3. 找到 **RQ** 服務卡片，點 **「開啟 Dashboard」**（或類似按鈕）。
4. 會彈出一個視窗（Modal），裡面嵌入的就是 RQ Dashboard。  
   - 該視窗實際載入的是 **API 代理** `{API}/api/v1/admin/services/dashboards/rq`，而非直連 9181。  
   - 靜態檔（CSS/JS）由 **API 自行提供**（來自 rq-dashboard 套件），不再向 9181 要，故不會 404。

這樣即可在測試時用系統監控查看 RQ 隊列，且不會遇到靜態資源 404。

---

## ⚠️ 故障排除：靜態資源 404（bootstrap.min.css、main.css、jquery 等）

**現象**：訪問 RQ Dashboard 時，Console 報 `bootstrap.min.css`、`main.css`、`jquery-3.4.1.min.js` 等 404，頁面空白或樣式錯亂。

**原因**：  
- **直連 9181**：rq-dashboard 在部分環境下對 `/static/...` 回 404。  
- **經 API 代理**：若以前直連 9181 取得 HTML、靜態又打 9181，一樣會 404。

**處理**（已修復）：

1. **改經 API 代理 + 前端 Modal**（推薦）：  
   - 使用 **「前端 Modal 開 RQ」**（見上方說明）。  
   - 或直接開啟 `{API 基底}/api/v1/admin/services/dashboards/rq`（需 systemAdmin 登入，若有 token 可加 `?token=...`）。  
   - 代理會重寫 HTML 內靜態路徑；**靜態檔改由 API 自行提供**（不轉 9181），故可避免 404。

2. **直連 9181**：若仍直連 `http://localhost:9181` 且出現 404，請改用上述 **API 代理 / Modal** 方式。  
   - 啟動 Dashboard 建議用 `./scripts/rq_dashboard.sh`（專案腳本），並確保已 `pip install rq-dashboard`。

## 📚 相關文檔

- `./任务队列系统指南.md` - 完整的任務隊列系統指南
- `./统一服务指南.md` - 統一服務管理指南
