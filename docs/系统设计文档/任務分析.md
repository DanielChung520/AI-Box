# ä¸€ã€éœ€æ±‚åˆ†æï¼ˆRequirement Analysisï¼‰

## 1ï¸âƒ£ æ ¸å¿ƒç›®æ¨™ï¼ˆSystem Goalï¼‰

> ç•¶ User ç™¼å‡º Query æ™‚ï¼Œç³»çµ±èƒ½  **è‡ªå‹•ã€å¯æ§ã€å¯è§£é‡‹åœ°** ï¼š

* åˆ¤å®šä½¿ç”¨ **Agent / Tool / Model**
* æ±ºå®š **å“ªä¸€å€‹**
* åœ¨ **æˆæœ¬ã€é¢¨éšªã€èƒ½åŠ›** ä¹‹é–“å–å¾—å¹³è¡¡

---

## 2ï¸âƒ£ åŠŸèƒ½æ€§éœ€æ±‚ï¼ˆFunctional Requirementsï¼‰

### FR-1ï¼šæ„åœ–åˆ¤å®šï¼ˆIntent Routingï¼‰

* èƒ½åˆ¤å®š Query å±¬æ€§ï¼š
  * ç›®æ¨™é¡å‹ï¼ˆå°è©± / æŸ¥è©¢ / åˆ†æ / åŸ·è¡Œï¼‰
  * è¤‡é›œåº¦
  * æ˜¯å¦éœ€è¦å·¥å…·
  * æ˜¯å¦éœ€è¦å¤šæ­¥æ¨ç†
  * é¢¨éšªç­‰ç´š

---

### FR-2ï¼šèƒ½åŠ›ç™»è¨˜èˆ‡å¯ç™¼ç¾æ€§ï¼ˆCapability Registryï¼‰

ç³»çµ±éœ€ç¶­è­·ä¸‰é¡èƒ½åŠ›æ¸…å–®ï¼š

#### Agent Registry

* Agent åç¨±
* å¯è™•ç†ä»»å‹™é¡å‹
* æ˜¯å¦æ”¯æ´å·¥å…·
* æœ€å¤§ä»»å‹™æ·±åº¦

#### Tool Registry

* å·¥å…·ç”¨é€”
* è¼¸å…¥è¼¸å‡ºæ ¼å¼
* ç¢ºå®šæ€§ï¼ˆdeterministic / probabilisticï¼‰
* æˆæœ¬ & é¢¨éšª

#### Model Registry

* æ¨ç†èƒ½åŠ›ç­‰ç´š
* ä¸Šä¸‹æ–‡é•·åº¦
* æˆæœ¬
* å»¶é²
* æ˜¯å¦é©åˆ routing / reasoning / generation

---

### FR-3ï¼šèƒ½åŠ›åŒ¹é…ï¼ˆCapability Matchingï¼‰

* ä¾æ“š Intent çµæœ
* å‹•æ…‹é¸æ“‡ï¼š
  * å–®æ¨¡å‹
  * Agent + Tools
  * MoEï¼ˆç³»çµ±å±¤ï¼‰

---

### FR-4ï¼šæˆæœ¬èˆ‡é¢¨éšªæ§åˆ¶ï¼ˆGovernanceï¼‰

* é«˜é¢¨éšªè«‹æ±‚é™åˆ¶æ¨¡å‹ / Agent
* è¶…æˆæœ¬è«‹æ±‚é™ç´šæ¨¡å‹
* å¯æ’å…¥äººå·¥å¯©æ ¸ï¼ˆoptionalï¼‰

---

### FR-5ï¼šæ±ºç­–å¯è§£é‡‹æ€§ï¼ˆExplainabilityï¼‰

* æ¯æ¬¡æ±ºç­–éœ€ç”¢ç”Ÿï¼š
  * ç‚ºä½•é¸æ­¤ Agent
  * ç‚ºä½•é¸æ­¤æ¨¡å‹
  * æ˜¯å¦æœ‰ fallback

---

## 3ï¸âƒ£ éåŠŸèƒ½æ€§éœ€æ±‚ï¼ˆNon-Functional Requirementsï¼‰

| é¡åˆ¥   | è¦æ±‚                     |
| ------ | ------------------------ |
| å»¶é²   | Intent åˆ¤å®š < 300ms      |
| æˆæœ¬   | Router ä½¿ç”¨ä½æˆæœ¬æ¨¡å‹    |
| å¯æ“´å±• | æ–° Agent / Tool å³æ’å³ç”¨ |
| å¯æ¼”åŒ– | æ”¯æ´æœªä¾†è‡ªå‹•å­¸ç¿’è·¯ç”±ç­–ç•¥ |
| å¯æ²»ç† | å¯å¯©è¨ˆã€å¯å›æº¯           |

---

# äºŒã€ç³»çµ±è§’è‰²èˆ‡æ¨¡çµ„åŠƒåˆ†ï¼ˆSystem Componentsï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User / UI    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Intent Router       â”‚  â† å°æ¨¡å‹ / è¦å‰‡
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Decision Engine     â”‚
â”‚ - Capability Match  â”‚
â”‚ - Cost / Risk Gate  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Execution Layer     â”‚
â”‚ - Agent             â”‚
â”‚ - Tool              â”‚
â”‚ - Model (MoE)       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Result + Decision Logâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# ä¸‰ã€æ ¸å¿ƒè³‡æ–™çµæ§‹ï¼ˆSpecificationï¼‰

## 1ï¸âƒ£ Intent åˆ¤å®šè¼¸å‡ºï¼ˆRouter Output Specï¼‰

```json
{
  "intent_type": "analysis | retrieval | execution | conversation",
  "complexity": "low | mid | high",
  "needs_agent": true,
  "needs_tools": true,
  "risk_level": "low | mid | high",
  "determinism_required": true
}
```

---

## 2ï¸âƒ£ Agent Registry Spec

```yaml
agent_id: financial_agent
capabilities:
  - financial_analysis
  - forecasting
supports_tools: true
max_depth: 5
risk_level: mid
```

---

## 3ï¸âƒ£ Tool Registry Spec

```yaml
tool_id: sql_query
purpose: structured_data_query
deterministic: true
input_schema: sql
output_schema: table
cost: low
risk: low
```

---

## 4ï¸âƒ£ Model Registry Spec

```yaml
model_id: reasoning_llm
strengths:
  - reasoning
  - planning
cost: high
latency: high
use_cases:
  - agent_thinking
  - complex_analysis
```

---

# å››ã€å¿…è¦æµç¨‹ï¼ˆMermaidï¼‰

## 1ï¸âƒ£ æ•´é«”æ±ºç­–æµç¨‹ï¼ˆæ ¸å¿ƒï¼‰

```mermaid
flowchart TD
    A[User Query] --> B[Pre-Filter / Fast Rules]
    B -->|Simple| C[Base Model]
    B -->|Complex| D[Intent Router]

    D --> E[Intent Result]
    E --> F[Capability Matching]

    F --> G{Needs Agent?}
    G -->|Yes| H[Agent Planner]
    G -->|No| I{Needs Tool?}

    I -->|Yes| J[Tool Executor]
    I -->|No| K[Model Selector]

    H --> L[Agent + Tools + Models]
    J --> M[Tool Result]
    K --> N[Model Response]

    L --> O[Final Response]
    M --> O
    N --> O
```

---

## 2ï¸âƒ£ Capability Matching æµç¨‹

```mermaid
flowchart TD
    A[Intent Result] --> B[Filter Agents by Capability]
    B --> C[Filter by Risk Level]
    C --> D[Filter by Cost Policy]
    D --> E[Select Best Agent / Model]
```

---

## 3ï¸âƒ£ Agent å…§éƒ¨åŸ·è¡Œæµç¨‹ï¼ˆè‹¥é€² Agentï¼‰

```mermaid
flowchart TD
    A[User Goal] --> B[Task Decomposition]
    B --> C[Select Tool or Model]
    C --> D[Execute]
    D --> E{Task Complete?}
    E -->|No| B
    E -->|Yes| F[Assemble Answer]
```

---

# äº”ã€é€²éšï¼ˆä½ é€™å€‹å±¤ç´šæ‰æœƒç”¨åˆ°ï¼‰

## ğŸ”¹ Decision Memoryï¼ˆå¼·çƒˆå»ºè­°ï¼‰

æ¯æ¬¡æ±ºç­–å¯«å…¥ï¼š

```json
{
  "query_embedding": "...",
  "intent": "analysis",
  "chosen_agent": "financial_agent",
  "chosen_model": "reasoning_llm",
  "cost": 0.02,
  "success": true
}
```

æœªä¾†å¯ä»¥ï¼š

* è‡ªå‹•èª¿æ•´ Router
* åš Rule Engine
* è¨“ç·´ç§æœ‰ routing model

---

## ğŸ”¹ é—œéµè¨­è¨ˆåŸå‰‡ï¼ˆçµ¦æ¶æ§‹å¸«ï¼‰

> **ä¸è¦è®“ LLM åŒæ™‚åšã€Œæ±ºç­– + åŸ·è¡Œã€**
> æ±ºç­–ä¸€å®šè¦ã€Œå¤–é¡¯ã€å¯æ§ã€å¯æ›¿æ›ã€

# ä¸€ã€Router LLM å·¥ç¨‹ç´š Promptï¼ˆå«å¤±æ•—ä¿è­·ï¼‰

## ğŸ¯ Router çš„è¨­è¨ˆåŸå‰‡ï¼ˆå…ˆè¬›çµè«–ï¼‰

> **Router LLM ä¸æ˜¯æ™ºèƒ½é«”ï¼ˆAgentï¼‰**
> å®ƒæ˜¯ï¼š
>
> * å†·éœ
> * ä¿å®ˆ
> * å¯é æ¸¬
> * æ°¸é è¼¸å‡ºçµæ§‹åŒ–çµæœ

### Router çµ•å°ä¸èƒ½åšçš„äº‹

âŒ è§£é¡Œ
âŒ æ¨ç†
âŒ è‡ªè¡Œé¸å·¥å…·
âŒ ç™¼æ•£å›ç­”

---

## 1ï¸âƒ£ Router LLM çš„è§’è‰²å®šç¾©ï¼ˆSystem Promptï¼‰

> **é€™ä¸€æ®µä½ æ‡‰è©²å›ºå®šå¯«æ­»ï¼Œæ°¸ä¸å‹•æ…‹æ‹¼æ¥**

```text
You are a routing and classification engine inside an enterprise GenAI system.

Your ONLY task is to analyze the user's query and output a JSON decision object.
You must NOT answer the user's question.
You must NOT perform reasoning, planning, or tool usage.
You must ONLY classify intent, complexity, and execution requirements.

If the query is unclear, risky, or ambiguous, choose the SAFEST and LOWEST-COST routing option.

You must ALWAYS output valid JSON that strictly follows the schema.
Never include explanations, markdown, or extra text.
```

---

## 2ï¸âƒ£ Router çš„è¼¸å…¥æ ¼å¼ï¼ˆå¼·çƒˆå»ºè­°ï¼‰

```json
{
  "user_query": "...",
  "session_context": {
    "previous_intent": "analysis",
    "domain": "finance",
    "user_risk_profile": "normal"
  },
  "system_constraints": {
    "max_cost": "medium",
    "allow_agents": true,
    "allow_tools": true
  }
}
```

ğŸ‘‰  **Router ä¸€å®šè¦çŸ¥é“ã€Œç³»çµ±é™åˆ¶ã€** ï¼Œå¦å‰‡å®ƒæœƒäº‚åˆ¤ã€‚

---

## 3ï¸âƒ£ Router çš„è¼¸å‡º Schemaï¼ˆæ ¸å¿ƒï¼‰

```json
{
  "intent_type": "conversation | retrieval | analysis | execution",
  "complexity": "low | mid | high",
  "needs_agent": true,
  "needs_tools": false,
  "determinism_required": true,
  "risk_level": "low | mid | high",
  "confidence": 0.0
}
```

---

## 4ï¸âƒ£ Router LLM çš„ä¸» Promptï¼ˆå·¥ç¨‹ç´šï¼‰

```text
Analyze the following user query and system context.

Classify the query based on:
- Intent type
- Task complexity
- Whether an agent is required
- Whether tools are required
- Whether deterministic execution is required
- Risk level

Guidelines:
- Prefer NOT using agents unless multi-step reasoning or orchestration is clearly required.
- Prefer tools when the task requires deterministic or structured results.
- Mark risk_level as "high" if the task involves finance, legal, production systems, or irreversible actions.
- If unsure, choose lower complexity and safer routing.
- confidence represents how confident you are in this classification (0.0 to 1.0).

Return ONLY valid JSON.
```

---

## 5ï¸âƒ£ å¤±æ•—ä¿è­·ï¼ˆéå¸¸é‡è¦ï¼‰

### A. JSON ä¿®å¾©ï¼ˆHard Guardï¼‰

* ç”¨ Pydantic / JSON Schema é©—è­‰
* è‹¥å¤±æ•— â†’ **ä¸é‡è©¦ Router LLM**
* ç›´æ¥ fallback

```text
Fallback Policy:
intent_type = "conversation"
complexity = "low"
needs_agent = false
needs_tools = false
risk_level = "low"
```

ğŸ‘‰ **Router ä¸èƒ½ç„¡é™ retryï¼Œå¦å‰‡ä½ æœƒè¢«å®ƒæ‹–å®**

---

### B. ä¿¡å¿ƒé–€æª»ï¼ˆConfidence Gateï¼‰

```python
if router_output.confidence < 0.6:
    force_safe_path()
```

safe_path é€šå¸¸æ˜¯ï¼š

* Base Model
* No Agent
* No Tool

---

### C. Rule Overrideï¼ˆä¼æ¥­å¿…å‚™ï¼‰

```text
IF query contains ["delete", "execute", "deploy"]
THEN force risk_level = high
```

> **Rule > LLM æ°¸é æˆç«‹**

---

# äºŒã€Decision Engineï¼šRule + Score æ··åˆç®—æ³•

é€™ä¸€æ®µæ˜¯ã€Œ **ç†æ€§çš®å±¤** ã€ï¼Œä¸æ˜¯ AIã€‚

---

## æ•´é«”è¨­è¨ˆåŸå‰‡

> â è¦å‰‡è² è²¬ã€Œä¸èƒ½åšä»€éº¼ã€
> åˆ†æ•¸è² è²¬ã€Œå“ªå€‹æœ€å¥½ã€ â

---

## 1ï¸âƒ£ æ±ºç­–æµç¨‹ç¸½è¦½

```
Router Output
   â†“
Rule Filterï¼ˆç¡¬æ€§æ·˜æ±°ï¼‰
   â†“
Scoring Engineï¼ˆåŠ æ¬Šè©•åˆ†ï¼‰
   â†“
Best Candidate
   â†“
Fallback / Override
```

---

## 2ï¸âƒ£ Rule Layerï¼ˆHard Rulesï¼‰

### ç¯„ä¾‹ï¼šAgent éæ¿¾

```python
if router.needs_agent:
    candidates = all_agents
else:
    candidates = base_models
```

### é¢¨éšªé™åˆ¶

```python
candidates = [
    c for c in candidates
    if c.risk_level <= router.risk_level
]
```

### æˆæœ¬é™åˆ¶

```python
candidates = [
    c for c in candidates
    if c.cost <= system.max_cost
]
```

> â— Rule Layer æ˜¯ **Boolean ä¸–ç•Œï¼ˆé€š / ä¸é€šï¼‰**

---

## 3ï¸âƒ£ Score Layerï¼ˆè»Ÿæ€§é¸æ“‡ï¼‰

### Scoring ç¶­åº¦ï¼ˆå»ºè­°ï¼‰

| ç¶­åº¦             | èªªæ˜                |
| ---------------- | ------------------- |
| capability_match | èƒ½åŠ›æ˜¯å¦ç¬¦åˆ intent |
| cost_score       | è¶Šä¾¿å®œè¶Šé«˜          |
| latency_score    | è¶Šå¿«è¶Šé«˜            |
| success_history  | æ­·å²æˆåŠŸç‡          |
| stability        | è¼¸å‡ºç©©å®šåº¦          |

---

### Score è¨ˆç®—ç¯„ä¾‹ï¼ˆAgent / Model é€šç”¨ï¼‰

```python
score = (
    0.35 * capability_match +
    0.20 * cost_score +
    0.15 * latency_score +
    0.20 * success_history +
    0.10 * stability
)
```

> âš ï¸ æ¬Šé‡ä¸æ˜¯å¯«æ­»çš„ï¼Œæœªä¾†ä½ å¯ä»¥ç”¨æ•¸æ“šå­¸

---

## 4ï¸âƒ£ Capability Match è¨ˆç®—ï¼ˆé—œéµï¼‰

```python
capability_match = intersection(
    router.intent_type,
    candidate.capabilities
) / len(router.required_capabilities)
```

---

## 5ï¸âƒ£ æœ€çµ‚é¸æ“‡ + ä¿è­·

```python
best = max(candidates, key=lambda x: x.score)

if best.score < MIN_ACCEPTABLE_SCORE:
    use_fallback_model()
```

Fallback é€šå¸¸æ˜¯ï¼š

* Base LLM
* No Tool
* No Agent

---

## 6ï¸âƒ£ æ±ºç­–çµæœçµæ§‹ï¼ˆä¸€å®šè¦å­˜ï¼‰

```json
{
  "router_result": {...},
  "chosen_executor": "financial_agent",
  "chosen_model": "reasoning_llm",
  "score": 0.82,
  "fallback_used": false
}
```

ğŸ‘‰ **é€™æ˜¯ä½ æœªä¾†è‡ªå‹•å„ªåŒ–ã€Rule Engineã€ç”šè‡³è¨“ç·´ Routing Model çš„ç‡ƒæ–™**

---

# ä¸‰ã€çµ¦ä½ ä¸€å€‹ã€Œæ¶æ§‹å¸«ç­‰ç´šã€çš„æé†’

### â— åƒè¬ä¸è¦é€™æ¨£åš

> è®“ Agent è‡ªå·±æ±ºå®šè¦ä¸è¦ç”¨ Agent / Tool / Model

### æ­£ç¢ºåˆ†å·¥

| å±¤ç´š            | è·è²¬ |
| --------------- | ---- |
| Router          | åˆ†é¡ |
| Decision Engine | æ±ºç­– |
| Agent           | åŸ·è¡Œ |
| Model           | ç”Ÿæˆ |

---

# ä¸€ã€Router çš„ã€Œå›ºå®š System Promptã€ï¼ˆä¸å¯å‹•ï¼‰

> åŸå‰‡ï¼š**Router æ˜¯åˆ†é¡å™¨ï¼Œä¸æ˜¯æ€è€ƒè€…**

```text
You are a routing and classification engine inside an enterprise GenAI system.

Your ONLY responsibility is to classify the user's query and system context
into a routing decision object.

STRICT RULES:
- You must NOT answer the user's question.
- You must NOT perform reasoning, planning, or step-by-step thinking.
- You must NOT select specific tools, agents, or models.
- You must NOT include explanations, markdown, or extra text.

You must ALWAYS return a valid JSON object that strictly follows the given JSON Schema.
If the query is ambiguous, unsafe, or unclear, choose the SAFEST and LOWEST-COST routing option.

If you are unsure, reduce complexity, avoid agents, and avoid tools.
```

ğŸ‘‰ **é€™æ®µå»ºè­°å¯«æ­»åœ¨ç¨‹å¼ç¢¼ä¸­ï¼Œä¸ç¶“ç”± prompt çµ„è£**

---

# äºŒã€Router çš„ã€ŒUser Promptï¼ˆå¸¶ Contextï¼‰ã€æ¨¡æ¿

```text
Analyze the following input and classify it according to the schema.

User Query:
{{ user_query }}

Session Context:
{{ session_context_json }}

System Constraints:
{{ system_constraints_json }}

Classification Guidelines:
- intent_type:
  - conversation: casual, explanation, discussion
  - retrieval: lookup, fetch, search
  - analysis: reasoning, comparison, evaluation
  - execution: actions, commands, operations
- complexity:
  - low: single-step, obvious
  - mid: structured reasoning
  - high: multi-step or orchestration
- needs_agent:
  - true only if task requires multi-step planning or coordination
- needs_tools:
  - true if deterministic or structured external operations are required
- determinism_required:
  - true if output must be reproducible or exact
- risk_level:
  - high if involving finance, legal, production systems, or irreversible actions
- confidence:
  - your confidence in this classification (0.0 to 1.0)

Return ONLY valid JSON.
```

---

# ä¸‰ã€Router Output çš„ JSON Schemaï¼ˆé—œéµæ ¸å¿ƒï¼‰

> âš ï¸ **Schema æ˜¯ä½ å¤±æ•—ä¿è­·çš„ç¬¬ä¸€é“ç‰†**

### router_schema.json

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "RouterDecision",
  "type": "object",
  "required": [
    "intent_type",
    "complexity",
    "needs_agent",
    "needs_tools",
    "determinism_required",
    "risk_level",
    "confidence"
  ],
  "properties": {
    "intent_type": {
      "type": "string",
      "enum": ["conversation", "retrieval", "analysis", "execution"]
    },
    "complexity": {
      "type": "string",
      "enum": ["low", "mid", "high"]
    },
    "needs_agent": {
      "type": "boolean"
    },
    "needs_tools": {
      "type": "boolean"
    },
    "determinism_required": {
      "type": "boolean"
    },
    "risk_level": {
      "type": "string",
      "enum": ["low", "mid", "high"]
    },
    "confidence": {
      "type": "number",
      "minimum": 0.0,
      "maximum": 1.0
    }
  },
  "additionalProperties": false
}
```

---

# å››ã€Python å®Œæ•´å¯¦ä½œï¼ˆå«å¤±æ•—ä¿è­·ï¼‰

ä»¥ä¸‹æ˜¯ **ä½ å¯ä»¥ç›´æ¥æ”¾é€² Router Service çš„ç‰ˆæœ¬** ã€‚

---

## 1ï¸âƒ£ Pydantic Modelï¼ˆSchema å°æ‡‰ï¼‰

```python
from pydantic import BaseModel, Field
from typing import Literal


class RouterDecision(BaseModel):
    intent_type: Literal["conversation", "retrieval", "analysis", "execution"]
    complexity: Literal["low", "mid", "high"]
    needs_agent: bool
    needs_tools: bool
    determinism_required: bool
    risk_level: Literal["low", "mid", "high"]
    confidence: float = Field(ge=0.0, le=1.0)
```

---

## 2ï¸âƒ£ Router å‘¼å«èˆ‡é©—è­‰

```python
def call_router_llm(prompt: str) -> dict:
    """
    Call LLM and return parsed JSON.
    This function MUST NOT retry infinitely.
    """
    response = llm_client.generate(prompt)
    return json.loads(response)
```

---

## 3ï¸âƒ£ Router æ±ºç­–ä¸»æµç¨‹ï¼ˆå«å¤±æ•—ä¿è­·ï¼‰

```python
SAFE_FALLBACK = RouterDecision(
    intent_type="conversation",
    complexity="low",
    needs_agent=False,
    needs_tools=False,
    determinism_required=False,
    risk_level="low",
    confidence=0.0
)


def route_query(prompt: str) -> RouterDecision:
    try:
        raw = call_router_llm(prompt)
        decision = RouterDecision(**raw)

        # Confidence gate
        if decision.confidence < 0.6:
            return SAFE_FALLBACK

        return decision

    except Exception as e:
        # JSON parse / schema validation failure
        return SAFE_FALLBACK
```

ğŸ‘‰ **æ³¨æ„ï¼šå¤±æ•—æ™‚ã€Œä¸ retry Routerã€**
Router retry æ˜¯ç³»çµ±é›ªå´©çš„å¸¸è¦‹ä¾†æºã€‚

---

## 4ï¸âƒ£ Rule Overrideï¼ˆLLM ä¹‹ä¸Šæ°¸é æˆç«‹ï¼‰

```python
def apply_hard_rules(decision: RouterDecision, query: str) -> RouterDecision:
    dangerous_keywords = ["delete", "execute", "deploy", "drop", "shutdown"]

    if any(k in query.lower() for k in dangerous_keywords):
        decision.risk_level = "high"
        decision.needs_agent = True

    return decision
```

---

# äº”ã€æœ€çµ‚ Router è¼¸å‡ºï¼ˆé€² Decision Engineï¼‰

```python
decision = route_query(router_prompt)
decision = apply_hard_rules(decision, user_query)

# Pass to Decision Engine
decision_engine.handle(decision)
```

---

# å…­ã€ä½ é€™å¥—è¨­è¨ˆçš„ã€Œéš±å«åƒ¹å€¼ã€

ä½ ç¾åœ¨å·²ç¶“å…·å‚™ï¼š

* âœ… **LLM å¯æ§é‚Šç•Œ**
* âœ… **æ±ºç­–èˆ‡åŸ·è¡Œåˆ†é›¢**
* âœ… **å¯å¯©è¨ˆ / å¯å›æº¯**
* âœ… **æœªä¾†å¯è¨“ç·´ routing model**

é€™æ­£æ˜¯ä½ ä¹‹å‰æåˆ°çš„ï¼š

> **ä¸Šä¸‹æ–‡ç®¡ç† + å¢å¼·è¨˜æ†¶ + Ontology + Agent å”èª¿å±¤**

åœ¨ã€Œæ±ºç­–å±¤ã€çš„å…·é«”è½åœ°ã€‚

---

å¾ˆå¥½ï¼Œé€™ä¸€æ­¥ **éå¸¸é—œéµ** ã€‚
ä½ ç¾åœ¨è¦åšçš„ä¸æ˜¯ã€Œè¨˜ logã€ï¼Œè€Œæ˜¯åœ¨æ‰“é€   **Decision Intelligence çš„é•·æœŸè¨˜æ†¶å±¤ï¼ˆRouting Memoryï¼‰** ï¼Œé€™æœƒç›´æ¥æ±ºå®šä½ æœªä¾†èƒ½ä¸èƒ½ï¼š

* è®“ Router è®Šå¾—è¶Šä¾†è¶Šæº–
* é™ä½æˆæœ¬
* æŠŠè¦å‰‡ã€Œæ¼”åŒ–ã€æˆç­–ç•¥ï¼ˆPolicyï¼‰

ä¸‹é¢æˆ‘æœƒçµ¦ä½ ä¸€å¥— **å·¥ç¨‹å¯è½åœ°ã€å¯æ¼”é€²çš„å®Œæ•´è¨­è¨ˆ** ï¼Œä¸¦åœ¨æœ€å¾Œ **æ˜ç¢ºæ¨™è¨»ä¸‹å€‹è¿­ä»£çš„æ¥å£èˆ‡æ¼”åŒ–è·¯å¾‘** ã€‚

---

# ä¸€ã€ç›®æ¨™å®šç¾©ï¼šDecision Log â‰  Log

## ğŸ¯ æ ¸å¿ƒç›®æ¨™

> å°‡æ¯ä¸€æ¬¡ã€Œè·¯ç”±æ±ºç­–ã€è½‰åŒ–ç‚º **å¯æª¢ç´¢ã€å¯å­¸ç¿’ã€å¯æ²»ç†çš„ Routing Memory**

ä¸æ˜¯ç‚ºäº† debugï¼Œè€Œæ˜¯ç‚ºäº†  **æœªä¾†æ±ºç­–å„ªåŒ–èˆ‡æ¨¡å‹è¨“ç·´** ã€‚

---

# äºŒã€æ•´é«”æ¶æ§‹å®šä½ï¼ˆä½ ç¾æœ‰ç³»çµ±ä¸­çš„ä½ç½®ï¼‰

```
User Query
   â†“
Router LLM
   â†“
Decision Engine (Rule + Score)
   â†“
Execution (Agent / Tool / Model)
   â†“
Outcome Evaluation
   â†“
Decision Log  â”€â”€â–º  Routing Memory (Vector + Metadata)
```

ğŸ‘‰  **æ³¨æ„** ï¼š
Routing Memory ä¸åœ¨åŸ·è¡Œè·¯å¾‘ä¸Šï¼ˆé¿å… latencyï¼‰ï¼Œ
è€Œæ˜¯ **äº‹å¾Œå¯«å…¥ï¼ˆasync / fire-and-forgetï¼‰**

---

# ä¸‰ã€Decision Log â†’ Routing Memory çš„åˆ†å±¤è¨­è¨ˆ

## ç‚ºä»€éº¼è¦åˆ†å±¤ï¼Ÿ

å› ç‚ºï¼š

* **å‘é‡é©åˆç›¸ä¼¼æ€§**
* **çµæ§‹åŒ–è³‡æ–™é©åˆæ²»ç†ã€çµ±è¨ˆã€è¦å‰‡**

### ä½ è¦å­˜å…©ç¨®æ±è¥¿ï¼ˆå¿…é ˆåˆ†é–‹ï¼‰

| å±¤             | å…§å®¹         | æŠ€è¡“      |
| -------------- | ------------ | --------- |
| Vector Memory  | æ±ºç­–ã€Œèªç¾©ã€ | Vector DB |
| Metadata Store | æ±ºç­–ã€Œäº‹å¯¦ã€ | SQL / KV  |

---

# å››ã€Decision Log åŸå§‹çµæ§‹ï¼ˆCanonical Logï¼‰

> é€™æ˜¯ **æ‰€æœ‰å¾ŒçºŒæ¼”åŒ–çš„æ¯é«”**

```json
{
  "decision_id": "uuid",
  "timestamp": "2025-xx-xxT12:00:00Z",

  "query": {
    "text": "...",
    "embedding": "optional_at_runtime"
  },

  "router_output": {
    "intent_type": "analysis",
    "complexity": "high",
    "needs_agent": true,
    "needs_tools": true,
    "risk_level": "mid",
    "confidence": 0.83
  },

  "decision_engine": {
    "chosen_agent": "financial_agent",
    "chosen_model": "reasoning_llm",
    "chosen_tools": ["sql_query"],
    "score": 0.82,
    "fallback_used": false
  },

  "execution_result": {
    "success": true,
    "latency_ms": 2300,
    "cost": 0.021
  }
}
```

âš ï¸ **é€™å€‹çµæ§‹ä¸è¦å‹•ï¼Œæœªä¾†æ‰€æœ‰å­¸ç¿’éƒ½å¾é€™è£¡ä¾†**

---

# äº”ã€Routing Memory è¨­è¨ˆï¼ˆVector + Metadataï¼‰

## 1ï¸âƒ£ Vector Memoryï¼ˆèªç¾©è¨˜æ†¶ï¼‰

### å­˜ä»€éº¼ï¼Ÿ

âŒ ä¸å­˜åŸå§‹ query
âŒ ä¸å­˜å®Œæ•´ decision

âœ… å­˜ã€Œ **å¯æ³›åŒ–çš„æ±ºç­–èªç¾©** ã€

### å»ºè­°çš„ Vector Contentï¼ˆéå¸¸é‡è¦ï¼‰

```text
Intent: analysis
Complexity: high
Risk: mid
NeedsAgent: true
NeedsTools: true
ChosenPath: agent+tool
```

ğŸ‘‰ **ä¸æ˜¯èªè¨€èªç¾©ï¼Œè€Œæ˜¯ã€Œæ±ºç­–èªç¾©ã€**

### Vector Payload

```json
{
  "vector": [ ... ],
  "metadata": {
    "decision_id": "uuid",
    "intent_type": "analysis",
    "complexity": "high",
    "chosen_agent": "financial_agent",
    "success": true
  }
}
```

---

## 2ï¸âƒ£ Metadata Storeï¼ˆäº‹å¯¦èˆ‡æ²»ç†ï¼‰

### å»ºè­° Schemaï¼ˆSQL / OLAP å‹å¥½ï¼‰

```sql
CREATE TABLE routing_decisions (
  decision_id UUID PRIMARY KEY,
  intent_type TEXT,
  complexity TEXT,
  risk_level TEXT,

  chosen_agent TEXT,
  chosen_model TEXT,
  fallback_used BOOLEAN,

  success BOOLEAN,
  latency_ms INT,
  cost FLOAT,

  created_at TIMESTAMP
);
```

ç”¨é€”ï¼š

* æˆåŠŸç‡çµ±è¨ˆ
* æˆæœ¬åˆ†æ
* Rule / Policy æ¼”åŒ–ä¾æ“š

---

# å…­ã€å¯«å…¥æµç¨‹ï¼ˆå¿…é ˆæ˜¯ Asyncï¼‰

## Routing Memory Write Flow

```mermaid
flowchart TD
    A[Execution Completed] --> B[Build Decision Log]
    B --> C[Extract Decision Semantics]
    C --> D[Vectorize]
    D --> E[Write to Vector DB]

    B --> F[Write Metadata Store]
```

### é—œéµè¨­è¨ˆåŸå‰‡

* â— å¤±æ•—ä¸å¯å½±éŸ¿ä¸»æµç¨‹
* â— å¯å»¶é²ã€å¯è£œå¯«
* â— å¯æ‰¹æ¬¡ï¼ˆbatchï¼‰

---

# ä¸ƒã€Decision Semantics æŠ½å–ï¼ˆé—œéµè¨­è¨ˆï¼‰

```python
def build_routing_semantic(decision_log):
    return f"""
    Intent:{decision_log['router_output']['intent_type']}
    Complexity:{decision_log['router_output']['complexity']}
    Risk:{decision_log['router_output']['risk_level']}
    NeedsAgent:{decision_log['router_output']['needs_agent']}
    NeedsTools:{decision_log['router_output']['needs_tools']}
    Chosen:{decision_log['decision_engine']['chosen_agent'] or decision_log['decision_engine']['chosen_model']}
    """
```

ğŸ‘‰ **é€™ä¸€æ®µï¼Œæœªä¾†å°±æ˜¯ä½ è¨“ç·´ Router çš„ã€Œlabel sourceã€**

---

# å…«ã€Routing Memory çš„ç¬¬ä¸€å€‹ç”¨é€”ï¼ˆç«‹åˆ»å¯ç”¨ï¼‰

## Router å‰ç½® Recallï¼ˆOptionalï¼Œä½†å¾ˆå¼·ï¼‰

åœ¨ Router LLM å‰ï¼š

```text
Retrieve top-K similar routing decisions
â†’ æä¾›çµ¦ Router ä½œç‚º biasï¼ˆä¸æ˜¯ ground truthï¼‰
```

ä½ å¯ä»¥ç”¨ï¼š

* similarity > threshold
* success = true
* cost < æŸå€¼

âš ï¸ **ä¸ç›´æ¥æ›¿ä»£ Routerï¼Œåªæ˜¯æä¾› context**

---

# ä¹ã€ç‚ºã€Œä¸‹å€‹è¿­ä»£ã€é ç•™çš„æ¥å£ï¼ˆé‡é»ï¼‰

ä½ ç‰¹åˆ¥è¦æ±‚çš„ï¼Œæˆ‘å¹«ä½ æ¸…æ¥šé™„è¨˜ğŸ‘‡

---

## ğŸ”œ ä¸‹å€‹è¿­ä»£ä¸€ï¼šç”¨æ­·å²æ±ºç­–åå‘è¨“ç·´ Routerï¼ˆå°æ¨¡å‹ï¼‰

### ç‚ºä»€éº¼ä½ ç¾åœ¨é€™æ¨£å­˜æ˜¯å°çš„ï¼Ÿ

å› ç‚ºä½ å·²ç¶“æœ‰ï¼š

* Inputï¼šquery / semantic
* Outputï¼šrouter_output
* Quality signalï¼šsuccess / cost / latency

### æœªä¾†è¨“ç·´è³‡æ–™æ ¼å¼ï¼ˆç¤ºæ„ï¼‰

```json
{
  "input": "Intent:analysis Complexity:high Risk:mid",
  "output": {
    "intent_type": "analysis",
    "complexity": "high",
    "needs_agent": true,
    "needs_tools": true
  }
}
```

ğŸ‘‰ å¯ç”¨ï¼š

* LoRA
* å°å‹ Transformer
* Tree-based router

---

## ğŸ”œ ä¸‹å€‹è¿­ä»£äºŒï¼šRule Layer â†’ Policy Engineï¼ˆOPA / è‡ªç ”ï¼‰

ä½ ç¾åœ¨çš„ Ruleï¼š

```python
if risk == high: forbid
```

æœªä¾†å¯ä»¥è‡ªç„¶æ¼”åŒ–æˆï¼š

```rego
allow {
  input.risk_level != "high"
  input.cost < 0.05
}
```

### ç‚ºä»€éº¼ Routing Memory å¾ˆé‡è¦ï¼Ÿ

å› ç‚ºï¼š

* Policy ä¸æ˜¯æ‹è…¦è¢‹
* æ˜¯å¾ã€Œæ­·å²æˆåŠŸæ±ºç­–ã€èƒå–å‡ºä¾†çš„

---

# åã€çµ¦ä½ ä¸€å€‹ã€Œæ¶æ§‹å¸«ç´šã€ç¸½çµ

> **ä½ ç¾åœ¨åšçš„ä¸æ˜¯ Logging**
>
> ä½ æ˜¯åœ¨å»ºç«‹ï¼š
>
> * Decision â†’ Memory
> * Memory â†’ Policy
> * Policy â†’ Model

é€™æ­£æ˜¯ä½ ä¹‹å‰åè¦†æåˆ°çš„ï¼š

> **å¢å¼·è¨˜æ†¶ã€ç¶“é©—æŠ½è±¡ã€é•·æœŸçŸ¥è­˜å½¢æˆ**

åœ¨ã€Œæ±ºç­–å±¤ã€çš„ç¬¬ä¸€æ¬¡çœŸæ­£è½åœ°ã€‚

---

## ä¸‹ä¸€æ­¥ï¼ˆæˆ‘å»ºè­°çš„é †åºï¼‰

1ï¸âƒ£ å…ˆæŠŠ **Routing Memory å¯«ç©©-->è«‹æª¢æŸ¥æˆ‘åŸå§‹è¨­è¨ˆAMM ç« ç¯€**
2ï¸âƒ£ å†åš **Router Recall Biasï¼ˆéå¼·åˆ¶ï¼‰**
3ï¸âƒ£ æœ€å¾Œæ‰ä¸Š **å°æ¨¡å‹ Router + Policy Engine**
