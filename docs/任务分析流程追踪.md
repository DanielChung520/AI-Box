# ä»»åŠ¡åˆ†ææµç¨‹è¿½è¸ªæ–‡æ¡£

**åˆ›å»ºæ—¥æœŸ**: 2025-12-30
**åˆ›å»ºäºº**: Daniel Chung
**æœ€åä¿®æ”¹æ—¥æœŸ**: 2025-12-30

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å½“ç”¨æˆ·è¯¢é—®AIåï¼Œåå°å¦‚ä½•è¿›è¡Œä»»åŠ¡åˆ†æçš„å®Œæ•´æµç¨‹ã€‚

---

## ğŸ”„ ä»»åŠ¡åˆ†ææµç¨‹

### 1. è§¦å‘æ¡ä»¶

ä»»åŠ¡åˆ†æåœ¨ä»¥ä¸‹æƒ…å†µä¸‹è§¦å‘ï¼š

- **æ¨¡å¼**: `model_selector.mode == "auto"`ï¼ˆè‡ªåŠ¨æ¨¡å¼ï¼‰
- **ä½ç½®**: `api/routers/chat.py` çš„ `chat_product_stream` å‡½æ•°

### 2. ä»»åŠ¡åˆ†ææ­¥éª¤

#### æ­¥éª¤ 1: å‡†å¤‡åˆ†æè¾“å…¥

```python
# ä½ç½®: api/routers/chat.py:1349-1356
task_classification = classifier.classify(
    last_user_text,  # ç”¨æˆ·è¾“å…¥çš„æœ€åä¸€åˆ™æ¶ˆæ¯
    context={
        "user_id": current_user.user_id,
        "session_id": session_id,
        "task_id": task_id,
    },
)
```

**è¾“å…¥æ•°æ®**:

- `last_user_text`: ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬ï¼ˆæœ€åä¸€åˆ™ç”¨æˆ·æ¶ˆæ¯ï¼‰
- `context`: ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆç”¨æˆ·IDã€ä¼šè¯IDã€ä»»åŠ¡IDï¼‰

#### æ­¥éª¤ 2: TaskClassifier åˆ†ç±»

**ä½ç½®**: `agents/task_analyzer/classifier.py`

**åˆ†ç±»é€»è¾‘**:

1. **å…³é”®è¯åŒ¹é…**:
   - å¯¹æ¯ä¸ªä»»åŠ¡ç±»å‹ï¼ˆQUERYã€EXECUTIONã€REVIEWã€PLANNINGã€COMPLEXã€LOG_QUERYï¼‰è¿›è¡Œå…³é”®è¯åŒ¹é…
   - ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å…³é”®è¯
   - è®¡ç®—åŒ¹é…åˆ†æ•°ï¼ˆæ¯ä¸ªåŒ¹é… +0.3ï¼Œæœ€é«˜ 1.0ï¼‰

2. **ä»»åŠ¡ç±»å‹å®šä¹‰**:

   ```python
   TaskType.QUERY: ["æŸ¥è©¢", "æœç´¢", "æŸ¥æ‰¾", "å‘Šè¨´æˆ‘", "ä»€éº¼æ˜¯", "å¦‚ä½•", "ç‚ºä»€éº¼", ...]
   TaskType.EXECUTION: ["åŸ·è¡Œ", "é‹è¡Œ", "æ“ä½œ", "å‰µå»º", "åˆªé™¤", "æ›´æ–°", ...]
   TaskType.REVIEW: ["å¯©æŸ¥", "æª¢æŸ¥", "é©—è­‰", "è©•ä¼°", "å¯©æ ¸", ...]
   TaskType.PLANNING: ["è¨ˆåŠƒ", "è¦åŠƒ", "è¨­è¨ˆ", "å®‰æ’", "åˆ¶å®š", ...]
   TaskType.COMPLEX: ["è¤‡é›œ", "å¤šæ­¥é©Ÿ", "ç¶œåˆ", "æ•´åˆ", "å”ä½œ", ...]
   TaskType.LOG_QUERY: ["æ—¥èªŒ", "å¯©è¨ˆ", "å®‰å…¨æ—¥èªŒ", "ä»»å‹™æ—¥èªŒ", ...]
   ```

3. **å¤æ‚ä»»åŠ¡æ£€æµ‹**:
   - å¦‚æœåŒ…å«"å¤šå€‹"ã€"å¤šæ­¥é©Ÿ"ã€"ç¶œåˆ"ç­‰å…³é”®è¯
   - å°† COMPLEX ç±»å‹çš„åˆ†æ•°æå‡åˆ°è‡³å°‘ 0.8

4. **é€‰æ‹©æœ€ä½³ç±»å‹**:
   - é€‰æ‹©å¾—åˆ†æœ€é«˜çš„ä»»åŠ¡ç±»å‹
   - å¦‚æœæ‰€æœ‰åˆ†æ•°ä¸º 0ï¼Œé»˜è®¤åˆ†ç±»ä¸º QUERYï¼ˆç½®ä¿¡åº¦ 0.5ï¼‰

5. **ä¸Šä¸‹æ–‡è€ƒè™‘**:
   - å¦‚æœ context ä¸­æœ‰ `previous_task_type`
   - ä¼šè°ƒæ•´åˆ†æ•°ï¼ˆ+0.2ï¼‰ï¼Œå¯èƒ½æ”¹å˜æœ€ç»ˆåˆ†ç±»

#### æ­¥éª¤ 3: è¿”å›åˆ†ç±»ç»“æœ

**è¿”å›ç±»å‹**: `TaskClassificationResult`

```python
class TaskClassificationResult(BaseModel):
    task_type: TaskType  # ä»»åŠ¡ç±»å‹
    confidence: float     # ç½®ä¿¡åº¦ (0.0-1.0)
    reasoning: str        # åˆ†ç±»ç†ç”±
```

**ç¤ºä¾‹ç»“æœ**:

```python
TaskClassificationResult(
    task_type=TaskType.QUERY,
    confidence=0.9,
    reasoning="æ ¹æ“šé—œéµè©åŒ¹é…ï¼Œåˆ†é¡ç‚º query é¡å‹ï¼ŒåŒ¹é…åº¦ 0.90"
)
```

### 3. ä»»åŠ¡ç±»å‹è¯´æ˜

| ä»»åŠ¡ç±»å‹ | è¯´æ˜ | å…¸å‹å…³é”®è¯ |
|---------|------|-----------|
| **QUERY** | æŸ¥è¯¢ç±»ä»»åŠ¡ | æŸ¥è©¢ã€æœç´¢ã€æŸ¥æ‰¾ã€å‘Šè¨´æˆ‘ã€ä»€éº¼æ˜¯ã€å¦‚ä½•ã€ç‚ºä»€éº¼ |
| **EXECUTION** | æ‰§è¡Œç±»ä»»åŠ¡ | åŸ·è¡Œã€é‹è¡Œã€æ“ä½œã€å‰µå»ºã€åˆªé™¤ã€æ›´æ–°ã€ä¿®æ”¹ |
| **REVIEW** | å®¡æŸ¥ç±»ä»»åŠ¡ | å¯©æŸ¥ã€æª¢æŸ¥ã€é©—è­‰ã€è©•ä¼°ã€å¯©æ ¸ã€æ ¡å° |
| **PLANNING** | è§„åˆ’ç±»ä»»åŠ¡ | è¨ˆåŠƒã€è¦åŠƒã€è¨­è¨ˆã€å®‰æ’ã€åˆ¶å®šã€æº–å‚™ |
| **COMPLEX** | å¤æ‚ä»»åŠ¡ | è¤‡é›œã€å¤šæ­¥é©Ÿã€ç¶œåˆã€æ•´åˆã€å”ä½œã€å¤šä»»å‹™ |
| **LOG_QUERY** | æ—¥å¿—æŸ¥è¯¢ | æ—¥èªŒã€å¯©è¨ˆã€å®‰å…¨æ—¥èªŒã€ä»»å‹™æ—¥èªŒã€æŸ¥çœ‹æ—¥èªŒ |

---

## ğŸ“Š æ—¥å¿—è®°å½•

### ä»»åŠ¡åˆ†æå¼€å§‹æ—¥å¿—

**ä½ç½®**: `api/routers/chat.py:1349`

```python
logger.info(
    "task_analysis_start",
    request_id=request_id,
    user_text=last_user_text[:200],
    user_id=current_user.user_id,
    session_id=session_id,
    task_id=task_id,
)
```

**æ—¥å¿—æ ¼å¼**:

```
task_analysis_start request_id=xxx user_text="..." user_id=xxx session_id=xxx task_id=xxx
```

### ä»»åŠ¡åˆ†æå®Œæˆæ—¥å¿—

**ä½ç½®**: `api/routers/chat.py:1356`

```python
logger.info(
    "task_analysis_completed",
    request_id=request_id,
    task_type=task_classification.type.value,
    confidence=task_classification.confidence,
    reasoning=task_classification.reasoning[:200],
)
```

**æ—¥å¿—æ ¼å¼**:

```
task_analysis_completed request_id=xxx task_type=query confidence=0.9 reasoning="..."
```

### TaskClassifier å†…éƒ¨æ—¥å¿—

**ä½ç½®**: `agents/task_analyzer/classifier.py:63, 123`

```python
logger.info(f"Classifying task: {task[:100]}...")
logger.info(f"Task classified as {best_type.value} with confidence {confidence:.2f}")
```

### è°ƒè¯•è¾“å‡º

**ä½ç½®**: `api/routers/chat.py:1365`

```python
print(f"\n[DEBUG] Task Analysis Result:")
print(f"  Type: {task_classification.type.value}")
print(f"  Confidence: {task_classification.confidence}")
print(f"  Reasoning: {task_classification.reasoning[:200]}")
```

---

## ğŸ” å¦‚ä½•è¿½è¸ªä»»åŠ¡åˆ†æ

### 1. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶

```bash
# æŸ¥çœ‹ä»»åŠ¡åˆ†æç›¸å…³æ—¥å¿—
tail -f logs/fastapi.log | grep -E "task_analysis|Classifying task|Task classified"

# æŸ¥çœ‹ç‰¹å®šè¯·æ±‚çš„ä»»åŠ¡åˆ†æ
tail -f logs/fastapi.log | grep -E "task_analysis_start|task_analysis_completed"
```

### 2. æŸ¥çœ‹è°ƒè¯•è¾“å‡º

å¦‚æœ uvicorn åœ¨å‰å°è¿è¡Œï¼Œä¼šçœ‹åˆ°ï¼š

```
[DEBUG] Task Analysis Result:
  Type: query
  Confidence: 0.9
  Reasoning: æ ¹æ“šé—œéµè©åŒ¹é…ï¼Œåˆ†é¡ç‚º query é¡å‹ï¼ŒåŒ¹é…åº¦ 0.90
```

### 3. æ£€æŸ¥åˆ†ç±»ç»“æœçš„ä½¿ç”¨

ä»»åŠ¡åˆ†ç±»ç»“æœä¼šç”¨äºï¼š

- **MoE è·¯ç”±**: æ ¹æ®ä»»åŠ¡ç±»å‹é€‰æ‹©æœ€åˆé€‚çš„ LLM æä¾›å•†å’Œæ¨¡å‹
- **å·¥ä½œæµé€‰æ‹©**: å†³å®šä½¿ç”¨å“ªç§å·¥ä½œæµï¼ˆLangChainã€CrewAIã€AutoGenç­‰ï¼‰
- **Agent é€‰æ‹©**: å†³å®šæ˜¯å¦éœ€è¦å¯åŠ¨ç‰¹å®šçš„ Agent

---

## ğŸ“ ç¤ºä¾‹æµç¨‹

### ç¤ºä¾‹ 1: æŸ¥è¯¢ä»»åŠ¡

**ç”¨æˆ·è¾“å…¥**: "è«‹ä¸Šç¶²<https://hci-marketingchain.net/> ä¸¦å‘Šè¨´æˆ‘å…§å®¹"

**ä»»åŠ¡åˆ†æè¿‡ç¨‹**:

1. æå–å…³é”®è¯: "ä¸Šç¶²"ã€"å‘Šè¨´æˆ‘"
2. åŒ¹é…ä»»åŠ¡ç±»å‹:
   - QUERY: åŒ¹é… "å‘Šè¨´æˆ‘" â†’ åˆ†æ•° 0.3
   - å…¶ä»–ç±»å‹: æ— åŒ¹é… â†’ åˆ†æ•° 0.1
3. é€‰æ‹©æœ€ä½³ç±»å‹: QUERYï¼ˆåˆ†æ•°æœ€é«˜ï¼‰
4. è¿”å›ç»“æœ:

   ```python
   TaskClassificationResult(
       task_type=TaskType.QUERY,
       confidence=0.3,
       reasoning="æ ¹æ“šé—œéµè©åŒ¹é…ï¼Œåˆ†é¡ç‚º query é¡å‹ï¼ŒåŒ¹é…åº¦ 0.30"
   )
   ```

### ç¤ºä¾‹ 2: æ‰§è¡Œä»»åŠ¡

**ç”¨æˆ·è¾“å…¥**: "è«‹å¹«æˆ‘å‰µå»ºä¸€å€‹æ–°çš„é…ç½®æ–‡ä»¶"

**ä»»åŠ¡åˆ†æè¿‡ç¨‹**:

1. æå–å…³é”®è¯: "å‰µå»º"
2. åŒ¹é…ä»»åŠ¡ç±»å‹:
   - EXECUTION: åŒ¹é… "å‰µå»º" â†’ åˆ†æ•° 0.3
   - QUERY: æ— åŒ¹é… â†’ åˆ†æ•° 0.1
3. é€‰æ‹©æœ€ä½³ç±»å‹: EXECUTION
4. è¿”å›ç»“æœ:

   ```python
   TaskClassificationResult(
       task_type=TaskType.EXECUTION,
       confidence=0.3,
       reasoning="æ ¹æ“šé—œéµè©åŒ¹é…ï¼Œåˆ†é¡ç‚º execution é¡å‹ï¼ŒåŒ¹é…åº¦ 0.30"
   )
   ```

---

## ğŸ”§ ç›¸å…³ä»£ç ä½ç½®

- **ä»»åŠ¡åˆ†æå…¥å£**: `api/routers/chat.py:1349`
- **TaskClassifier å®ç°**: `agents/task_analyzer/classifier.py`
- **ä»»åŠ¡ç±»å‹å®šä¹‰**: `agents/task_analyzer/models.py:TaskType`
- **åˆ†ç±»ç»“æœæ¨¡å‹**: `agents/task_analyzer/models.py:TaskClassificationResult`

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Task Analyzer è®¾è®¡æ–‡æ¡£](../ç³»ç»Ÿè®¾è®¡æ–‡æ¡£/agents/TaskAnalyzerè®¾è®¡è¯´æ˜.md)
- [LLM Router è®¾è®¡æ–‡æ¡£](../ç³»ç»Ÿè®¾è®¡æ–‡æ¡£/llm/LLMRouterè®¾è®¡è¯´æ˜.md)

---

**æœ€åæ›´æ–°æ—¥æœŸ**: 2025-12-30
**ç»´æŠ¤äºº**: Daniel Chung
