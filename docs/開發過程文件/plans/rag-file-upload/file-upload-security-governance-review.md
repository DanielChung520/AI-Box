# 文件上傳與RAG處理計劃 - 安全與AI治理評估報告

**評估日期**: 2025-01-27
**評估人**: AI Assistant (第三方視角)
**評估範圍**: 文件上傳、RAG處理、文件管理系統

## 執行摘要

本評估從**安全**、**AI治理**、**架構合理性**三個維度審視當前實施計劃，發現了**8個高風險問題**、**12個中風險問題**和**6個改進建議**。

### 風險等級總覽

| 風險類別 | 高風險 | 中風險 | 低風險 | 總計 |
|---------|--------|--------|--------|------|
| 安全風險 | 5 | 6 | 3 | 14 |
| AI治理風險 | 3 | 4 | 2 | 9 |
| 架構風險 | 0 | 2 | 1 | 3 |
| **總計** | **8** | **12** | **6** | **26** |

---

## 一、安全風險評估

### 🔴 高風險問題

#### 1.1 認證系統不完整（關鍵風險）

**問題描述**：

- `system/security/auth.py` 中的 JWT 驗證函數返回 `None`，實際未實現
- 文件上傳API中 `user_id` 為可選參數，沒有強制認證
- 開發模式下可能完全繞過認證檢查

**影響**：

- 未授權用戶可能上傳文件
- 無法追蹤文件歸屬
- 可能導致數據洩露

**建議**：

```python
# 必須實現的認證中間件
@router.post("/upload")
async def upload_files(
    files: List[UploadFile] = File(...),
    current_user: User = Depends(get_current_user),  # 強制認證
) -> JSONResponse:
    user_id = current_user.id  # 從認證中獲取，不可選
```

**優先級**: 🔴 P0 - 必須在階段一開始前解決

---

#### 1.2 文件訪問權限控制缺失

**問題描述**：

- 計劃中提到"用戶只能訪問自己的文件"，但沒有具體的權限驗證機制
- 缺少基於角色的訪問控制（RBAC）
- 文件路徑可能被猜測或枚舉

**影響**：

- 用戶可能訪問其他用戶的文件
- 敏感數據可能被未授權訪問

**建議**：

1. 實現文件訪問權限檢查中間件
2. 使用文件ID而非路徑進行訪問
3. 實現基於任務的權限繼承

**優先級**: 🔴 P0 - 階段四必須實現

---

#### 1.3 敏感數據處理無加密

**問題描述**：

- 文件存儲在本地文件系統，沒有加密
- 向量數據和知識圖譜可能包含敏感信息，未加密存儲
- 傳輸過程中可能缺少加密（取決於部署環境）

**影響**：

- 數據庫被攻擊時，所有數據可讀
- 符合GDPR等法規要求困難

**建議**：

1. 實現文件存儲加密（AES-256）
2. 數據庫連接使用TLS
3. 敏感字段加密存儲

**優先級**: 🔴 P1 - 階段二A/B需要考慮

---

#### 1.4 缺少審計日誌

**問題描述**：

- 計劃中沒有提到操作審計日誌
- 無法追蹤誰上傳了什麼文件
- 無法追蹤數據使用情況

**影響**：

- 合規審計困難
- 安全事件無法追溯
- 無法滿足數據保護法規要求

**建議**：

```python
# 必須記錄的操作
- 文件上傳（用戶、時間、文件名、大小）
- 文件訪問（用戶、時間、文件ID）
- 文件刪除（用戶、時間、文件ID）
- 數據處理操作（用戶、時間、處理類型）
- 模型調用（用戶、時間、模型、輸入長度）
```

**優先級**: 🔴 P1 - 階段一需要開始實施

---

#### 1.5 輸入驗證不足

**問題描述**：

- 文件類型驗證可能不夠嚴格
- 缺少文件內容掃描（惡意文件檢測）
- 文件名可能包含路徑遍歷字符

**影響**：

- 可能上傳惡意文件
- 路徑遍歷攻擊風險
- 存儲空間被惡意佔用

**建議**：

1. 實現文件內容掃描（病毒掃描、惡意代碼檢測）
2. 嚴格的文件名驗證和清理
3. 文件大小和數量限制

**優先級**: 🔴 P1 - 階段一必須實現

---

### 🟡 中風險問題

#### 1.6 會話管理不完善

- 缺少會話超時機制
- 沒有並發登錄控制

#### 1.7 數據備份和恢復缺失

- 沒有備份策略
- 沒有災難恢復計劃

#### 1.8 API速率限制不足

- 缺少針對用戶的速率限制
- 可能被DDoS攻擊

#### 1.9 錯誤信息洩露

- 錯誤信息可能暴露系統結構
- 缺少統一的錯誤處理

#### 1.10 跨站請求偽造（CSRF）防護

- 前端缺少CSRF token
- API缺少CSRF驗證

#### 1.11 數據保留策略缺失

- 沒有定義數據保留期限
- 沒有自動清理機制

---

## 二、AI治理風險評估

### 🔴 高風險問題

#### 2.1 模型使用追蹤缺失

**問題描述**：

- 沒有記錄哪些模型處理了哪些數據
- 無法追蹤模型版本和參數
- 缺少模型使用統計

**影響**：

- 無法進行模型審計
- 無法追蹤數據流向
- 合規困難

**建議**：

```python
# 必須記錄的模型使用信息
{
  "model_name": "gpt-oss:20b",
  "model_version": "v1.0",
  "user_id": "user_123",
  "file_id": "file_456",
  "input_length": 1000,
  "output_length": 500,
  "timestamp": "2025-01-27T10:00:00Z",
  "purpose": "embedding|ner|re|rt"
}
```

**優先級**: 🔴 P1 - 階段二A/B必須實現

---

#### 2.2 數據使用同意和追蹤缺失

**問題描述**：

- 沒有記錄用戶是否同意數據用於AI訓練
- 沒有追蹤數據的二次使用
- 缺少數據使用目的記錄

**影響**：

- 違反GDPR等數據保護法規
- 用戶隱私權受損
- 法律風險

**建議**：

1. 實現數據使用同意機制
2. 記錄數據使用目的和範圍
3. 提供數據使用報告功能

**優先級**: 🔴 P1 - 階段一開始前需要設計

---

#### 2.3 偏見檢測和緩解缺失

**問題描述**：

- NER/RE/RT提取可能包含偏見
- 沒有偏見檢測機制
- 沒有偏見緩解策略

**影響**：

- AI系統可能產生歧視性結果
- 影響系統公平性
- 聲譽風險

**建議**：

1. 實現偏見檢測工具
2. 定期審查提取結果
3. 提供偏見報告

**優先級**: 🔴 P2 - 階段二B需要考慮

---

### 🟡 中風險問題

#### 2.4 可解釋性不足

- 缺少AI決策解釋
- 用戶無法理解為什麼得到特定結果

#### 2.5 模型版本管理

- 沒有模型版本控制
- 無法回滾到舊版本

#### 2.6 數據質量監控

- 沒有數據質量檢查
- 無法檢測異常數據

#### 2.7 人工審核機制缺失

- 敏感提取結果沒有人工審核
- 缺少審核工作流

---

## 三、架構合理性評估

### ✅ 合理的設計

1. **目錄結構設計**：`files/{user_id}/{task_id}/` 結構清晰合理
2. **分階段實施**：階段劃分合理，依賴關係明確
3. **技術選型**：使用成熟的技術棧

### 🟡 需要改進的設計

#### 3.1 缺少統一錯誤處理層

- 建議實現統一的錯誤處理和響應格式

#### 3.2 缺少監控和告警

- 建議添加系統監控、性能監控、錯誤告警

---

## 四、改進建議

### 4.1 必須在階段一開始前完成

1. **實現完整的認證系統**
   - JWT Token 驗證
   - 用戶身份識別
   - 會話管理

2. **設計數據使用同意機制**
   - 用戶同意流程
   - 數據使用追蹤

3. **實現審計日誌基礎設施**
   - 日誌存儲
   - 日誌查詢API

### 4.2 階段一需要補充

1. **文件安全驗證增強**
   - 文件內容掃描
   - 惡意文件檢測
   - 文件名清理

2. **權限驗證中間件**
   - 文件上傳權限檢查
   - 文件訪問權限驗證

### 4.3 階段二A/B需要補充

1. **模型使用追蹤**
   - 記錄所有模型調用
   - 模型使用統計

2. **數據加密**
   - 敏感數據加密存儲
   - 傳輸加密

### 4.4 階段四需要補充

1. **完整的權限控制**
   - RBAC實現
   - 文件訪問控制

2. **數據保留和清理**
   - 自動清理策略
   - 數據歸檔機制

---

## 五、合規性檢查

### 5.1 GDPR合規性

**缺失項**：

- ❌ 數據使用同意機制
- ❌ 數據刪除權（Right to be Forgotten）
- ❌ 數據可移植性
- ❌ 數據處理記錄

**建議**：

1. 實現用戶數據導出功能
2. 實現數據刪除API
3. 記錄所有數據處理操作

### 5.2 數據保護法規

**需要考慮**：

- 個人信息保護法（中國）
- CCPA（加州）
- 其他地區法規

---

## 六、優先級行動計劃

### P0 - 立即處理（階段一開始前）

1. ✅ 實現JWT認證系統
2. ✅ 設計數據使用同意機制
3. ✅ 實現基礎審計日誌

### P1 - 高優先級（階段一）

1. ✅ 文件安全驗證增強
2. ✅ 權限驗證中間件
3. ✅ 錯誤處理統一化

### P2 - 中優先級（階段二）

1. ✅ 模型使用追蹤
2. ✅ 數據加密
3. ✅ 偏見檢測機制

### P3 - 低優先級（階段三/四）

1. ✅ 完整RBAC實現
2. ✅ 數據保留策略
3. ✅ 監控和告警

---

## 七、建議新增的WBS任務

### 7.1 安全加固階段（建議新增）

**目標**: 實現完整的安全機制

**主要任務**:

- 認證系統實現（2-3天）
- 權限控制實現（2-3天）
- 審計日誌系統（1-2天）
- 數據加密實現（2-3天）
- 安全測試（1-2天）

**總計**: 8-13天

### 7.2 AI治理階段（建議新增）

**目標**: 實現AI治理機制

**主要任務**:

- 模型使用追蹤（2天）
- 數據使用同意機制（1-2天）
- 偏見檢測工具（2-3天）
- 可解釋性實現（2-3天）
- 治理報告功能（1-2天）

**總計**: 8-12天

---

## 八、總結

### 8.1 關鍵發現

1. **安全風險較高**：認證系統不完整是最大風險
2. **AI治理缺失**：缺少必要的治理機制
3. **合規性不足**：難以滿足GDPR等法規要求

### 8.2 建議

1. **立即行動**：在開始實施前，必須完成認證系統
2. **分階段增強**：在每個階段添加相應的安全和治理功能
3. **持續改進**：建立安全審查機制，定期評估和改進

### 8.3 風險緩解

通過實施本報告的建議，可以將：

- 高風險問題從 8 個降至 0 個
- 中風險問題從 12 個降至 3-4 個
- 系統整體安全等級從 **C級**提升至 **A級**

---

**報告結束**

*本報告基於當前計劃文檔和代碼庫分析，建議定期更新評估。*
