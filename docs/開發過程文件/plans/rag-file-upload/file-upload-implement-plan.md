# 文件上傳與RAG處理實施計劃

**文檔功能說明**: AI-Box 文件上傳與RAG處理功能實施主計劃
**創建日期**: 2025-12-06
**創建人**: Daniel Chung
**最後修改日期**: 2025-12-06

## 📊 實施進度管制表

| 階段           | 階段名稱     | 預計時間           | 開始日期   | 完成日期   | 狀態        | 進度         | 負責人 | 備註                    |
| -------------- | ------------ | ------------------ | ---------- | ---------- | ----------- | ------------ | ------ | ----------------------- |
| 0              | 安全準備     | 3-5 天             | 2025-12-06 | 2025-12-06 | 🔄 進行中   | 95%          | -      | 🔴 關鍵路徑，必須先完成 |
| 1              | 文件上傳     | 4.5-5.5 天         | 2025-12-06 | 2025-12-06 | ✅ 已完成 | 90%           | -      | 1.2.4安全验证增强未完成：1.2.4.1文件扫描服务未实现；1.2.4.2文件名清理已实现基本防护；1.2.4.3缺少用户级别限制；1.2.4.4权限验证中间件已实现但未集成到文件上传。交付物：代码实现已完成，测试和文档未完成。 |
| 2A            | 分塊與向量化 | 9-13 天            | 2025-12-06 | 2025-12-06 | ✅ 已完成 | 90%           | -      | 核心功能已完成（文件分块、向量化、ChromaDB存储）。未完成：1.1.1-1.1.2文件解析增强和智能分块；1.2.1-1.2.2文意分析集成；1.4.1-1.4.2 LangChain/LangGraph集成；1.5.1-1.5.2模型使用追踪。交付物：核心服务已完成，测试和文档未完成。 |
| 2B            | 知識圖譜提取 | 12-18 天           | 2025-12-06 | 2025-12-06 | ✅ 已完成 | 90%           | -      | 核心功能已完成（KG提取服务、三元组提取、图谱构建、ArangoDB存储）。未完成：1.1.1-1.1.2 NER服务增强（批量提取、实体标准化）；1.2.1-1.2.2 RE服务增强（关系抽取、验证过滤）；1.3.1-1.3.2 RT服务增强（三元组标准化、质量评分）；1.4.3标签化处理；1.5.2索引优化；1.6.1-1.6.2偏见检测。交付物：核心服务已完成，测试和文档未完成。 |
| 3              | 整合測試     | 10-14 天           | 2025-12-06 | -        | 🔄 進行中 | 95%          | -      | 測試框架和代碼已完成（16個測試文件），測試執行遇到依賴問題需修復（缺失模組、循環導入）         |
| 4              | 文件管理系統 | 4-6 天             | 2025-12-06 | 2025-12-06 | ✅ 已完成 | 100%         | -      | 依賴階段1，與階段3並行執行，已完成               |
| 5 | 安全加固 | 8-13 天 | 2025-12-06 | - | 🔄 進行中 | 60% | - | 已完成（60%）：RBAC数据模型和角色管理API、权限检查中间件、文件访问权限控制、文件加密服务、文件存储加密集成、文件扫描服务、文件名清理和路径验证。未完成（40%）：基于任务的权限继承（1.1.2）、密钥管理完善（1.2.1.3）、数据库加密和传输加密（1.2.2）、专业扫描库集成（1.3.1.1）、用户级别限制（1.3.3）、安全监控告警（1.4）、安全测试（1.5） |

- ✅ 1.1.1.1 RBAC数据模型（services/api/models/rbac.py）
- ✅ 1.1.1.2 角色管理API（api/routers/rbac.py）
- ✅ 1.1.1.3 权限检查中间件（system/security/dependencies.py）
- ✅ 1.1.1.4 文件访问权限控制（services/api/services/file_permission_service.py）
- ✅ 1.2.1.1 文件加密服务（services/api/services/encryption_service.py）
- ✅ 1.2.1.2 修改文件存储逻辑（storage/file_storage.py）
- ✅ 1.3.1.2 扫描服务（services/api/services/file_scanner.py）
- ✅ 1.3.2.1 文件名清理（services/api/utils/file_validator.py）
- ✅ 1.3.2.2 路径验证（services/api/utils/file_validator.py）

未完成任务（40%）：

- ⏸️ 1.1.2.1 任务权限模型（任务所有者、协作者、查看者权限）
- ⏸️ 1.1.2.2 文件权限继承（文件继承任务的权限设置）
- ⏸️ 1.1.2.3 权限查询API（查询用户对资源的权限）
- ⏸️ 1.2.1.3 密钥管理完善（密钥轮换、安全存储）
- ⏸️ 1.2.2.1 敏感字段加密（文件元数据中的敏感字段加密）
- ⏸️ 1.2.2.2 数据库TLS连接（ChromaDB和ArangoDB使用TLS）
- ⏸️ 1.2.2.3 传输加密（API使用HTTPS）
- ⏸️ 1.3.1.1 集成文件扫描库（病毒扫描、恶意代码检测，当前为基础实现）
- ⏸️ 1.3.3.1 用户级别限制（每个用户的文件大小和数量限制）
- ⏸️ 1.3.3.2 全局限制（系统级别的限制）
- ⏸️ 1.4.1.1 异常行为检测（检测异常上传、异常访问模式）
- ⏸️ 1.4.1.2 安全告警系统（异常行为触发告警）
- ⏸️ 1.4.2.1 日志聚合（聚合审计日志）
- ⏸️ 1.4.2.2 安全报告（生成安全事件报告）
- ⏸️ 1.5.1.1 安全扫描（OWASP ZAP, Burp Suite）
- ⏸️ 1.5.1.2 修复发现的漏洞
- ⏸️ 1.5.2.1 代码安全审查
- ⏸️ 1.5.2.2 安全文档更新 -      | 依賴階段4               |
| 6 | AI治理 | 8-12 天 | 2025-12-06 | - | 🔄 進行中 | 85% | - | 已完成：模型使用追踪系统（数据模型、服务、Ollama客户端集成、NER/RE/RT服务集成、统计API）、数据质量监控（检查服务、API）、可解释性服务、偏见检测服务、治理报告服务。未完成：前端解释显示组件、前端治理仪表板 |
| **總計** | -            | **59-86 天** | -          | -          | -           | **54%** | -      | -                       |

### 進度說明

- **⏸️ 待開始**: 尚未開始
- **🔄 進行中**: 正在實施
- **✅ 已完成**: 已完成
- **⏹️ 已暫停**: 已暫停
- **❌ 已取消**: 已取消

### 關鍵里程碑

- **M0**: 階段0完成 - 安全準備就緒（阻塞階段1）
- **M1**: 階段1完成 - 文件上傳功能可用
- **M2**: 階段2A+2B完成 - RAG處理完整流程
- **M3**: 階段3完成 - 整合測試通過
- **M4**: 階段4完成 - 文件管理系統上線
- **M5**: 階段5完成 - 安全加固完成
- **M6**: 階段6完成 - AI治理機制就緒

### 風險狀態

- 🔴 **高風險**: 階段0未完成將阻塞整個項目
- 🟡 **中風險**: 階段2A和2B的並行執行需要資源協調
- 🟢 **低風險**: 其他階段按計劃進行

---

## 1. 項目概述

### 1.1 項目目標

實現從 AI-Bot 聊天輸入框回紋針按鈕觸發的文件上傳功能，並進行完整的 RAG（Retrieval-Augmented Generation）處理流程，包括文件分塊、向量化存儲和知識圖譜提取。

### 1.2 功能範圍

- **前端功能**: 在 ChatInput 組件中實現文件選擇和上傳UI
- **文件處理**: 支持多種文件格式的上傳、驗證和存儲
- **文件管理**: 統一的文件檔案管理區，按賬號和任務ID分目錄儲存，前端文件列表顯示
- **RAG處理**:
  - 文件分塊（Chunking）
  - 文意分析和向量化（使用 本地 Ollama 服務 (localhost:11434) 模型）
  - 向量存儲到 ChromaDB
  - 知識圖譜提取（NER/RE/RT 三元組）
  - 標簽化處理

### 1.3 技術架構

- **前端**: React + TypeScript (ai-bot)
- **後端**: FastAPI (api/)
- **向量數據庫**: ChromaDB
- **圖譜數據庫**: ArangoDB
- **LLM服務**: Ollama (本地 Ollama 服務 (localhost:11434))
- **處理服務**: LangChain / LangGraph

## 2. 實施階段

本項目分為三個主要階段：

### 階段零：安全準備（必須在階段一開始前完成）

**目標**: 實現基礎安全機制，確保系統安全運行

**主要任務**:

- 實現完整的JWT認證系統
- 設計並實現數據使用同意機制
- 實現基礎審計日誌系統
- 安全配置和測試

**詳細計劃**: 參見 [WBS-階段零](./wbs-phase0-security-prep.md)

**⚠️ 重要**: 此階段必須在階段一開始前完成，否則系統存在嚴重安全風險

### 階段一：文件選擇與上傳功能

**目標**: 實現從 ChatInput 回紋針按鈕觸發的文件選擇和上傳功能

**主要任務**:

- 前端：實現文件選擇UI和上傳組件
- 後端：整合現有文件上傳API
- 文件驗證和存儲

**詳細計劃**: 參見 [WBS-階段一](./wbs-phase1-file-upload.md)

### 階段二A：文件分塊與向量化

**目標**: 實現文件智能分塊，使用 本地 Ollama 服務 (localhost:11434) 模型進行文意分析和向量化，存儲到 ChromaDB

**主要任務**:

- 文件解析和分塊處理
- 使用 Ollama 模型進行文意分析
- 向量化處理（Embedding）
- 存儲到 ChromaDB
- 整合 LangChain/LangGraph 服務

**詳細計劃**: 參見 [WBS-階段二A](./wbs-phase2a-chunk-vectorization.md)

### 階段二B：知識圖譜提取與標簽化

**目標**: 對文件進行 NER/RE/RT 三元圖譜數據分析並進行標簽化

**主要任務**:

- 調用 NER 服務進行命名實體識別
- 調用 RE 服務進行關係抽取
- 調用 RT 服務進行三元組提取
- 構建知識圖譜並標簽化
- 存儲到 ArangoDB

**詳細計劃**: 參見 [WBS-階段二B](./wbs-phase2b-kg-extraction.md)

### 階段三：整合測試

### 階段四：文件管理系統

**目標**: 建立統一的文件檔案管理區，實現按賬號和任務ID分目錄儲存，並在前端顯示文件列表

**主要任務**:

- 後端：實現文件目錄結構管理（按賬號/任務ID組織）
- 後端：實現文件元數據管理API
- 前端：實現文件管理組件和文件列表顯示
- 前端：實現文件上傳後自動掛載到文件區
- 前端：實現文件瀏覽、搜索、下載功能

**詳細計劃**: 參見 [WBS-階段四](./wbs-phase4-file-management.md)

### 階段五：安全加固

**目標**: 實現完整的安全機制，提升系統安全等級

**主要任務**:

- 完整的權限控制實現（RBAC）
- 數據加密實現
- 安全測試和滲透測試
- 安全監控和告警

**詳細計劃**: 參見 [WBS-階段五](./wbs-phase5-security-hardening.md)

### 階段六：AI治理

**目標**: 實現AI治理機制，確保AI系統負責任使用

**主要任務**:

- 模型使用追蹤系統
- 偏見檢測和緩解機制
- 可解釋性實現
- AI治理報告功能

**詳細計劃**: 參見 [WBS-階段六](./wbs-phase6-ai-governance.md)

**目標**: 完成端到端測試，確保所有功能正常運作

**主要任務**:

- 單元測試
- 集成測試
- 端到端測試
- 性能測試
- 文檔更新

**詳細計劃**: 參見 [WBS-階段三](./wbs-phase3-integration-test.md)

## 3. 技術依賴

### 3.1 現有服務

- ✅ 文件上傳API (`api/routers/file_upload.py`)
- ✅ 文件分塊處理 (`api/routers/chunk_processing.py`)
- ✅ ChromaDB API (`api/routers/chromadb.py`)
- ✅ NER服務 (`genai/api/services/ner_service.py`)
- ✅ RE服務 (`genai/api/services/re_service.py`)
- ✅ RT服務 (`genai/api/services/rt_service.py`)
- ✅ 知識圖譜構建服務 (`genai/api/services/kg_builder_service.py`)

### 3.2 需要開發

- 🔨 前端文件上傳組件
- 🔨 文件上傳進度顯示
- 🔨 RAG處理流程編排
- 🔨 向量化處理集成
- 🔨 知識圖譜提取流程

### 3.3 外部依賴

### 3.4 Ollama 服務配置

#### 3.4.1 本機服務配置（推薦）

為了確保數據安全和性能，**強烈建議使用本機 Ollama 服務**：

**環境變數配置**（`.env` 文件）：

```bash
# Ollama 本機服務配置
OLLAMA_REMOTE_HOST=localhost
OLLAMA_REMOTE_PORT=11434
OLLAMA_SCHEME=http
OLLAMA_DEFAULT_MODEL=gpt-oss:20b
OLLAMA_EMBEDDING_MODEL=nomic-embed-text
```

**配置文件方式**（`config/config.json`）：

```json
{
  "services": {
    "ollama": {
      "scheme": "http",
      "host": "localhost",
      "port": 11434,
      "default_model": "gpt-oss:20b",
      "embedding_model": "nomic-embed-text",
      "request_timeout": 60
    }
  }
}
```

#### 3.4.2 安全優勢

使用本機服務的優勢：

- ✅ **數據安全**: 敏感文件內容不經過外部網路
- ✅ **性能優異**: 無網路延遲，響應更快
- ✅ **配置簡單**: 無需 SSL 證書和複雜網路配置
- ✅ **可靠性高**: 不受外部網路波動影響

#### 3.4.3 外部服務配置（不推薦）

如果必須使用外部服務，請確保：

- 使用 HTTPS 協議
- 配置 SSL 證書驗證
- 實施 API Token 認證
- 使用 VPN 或私有網路
- Ollama 服務 (本地 Ollama 服務 (localhost:11434))
- ChromaDB 數據庫
- ArangoDB 數據庫
- LangChain / LangGraph 服務

## 4. 技術架構

### 4.1 前端架構

```
ChatInput 組件
  └── 回紋針按鈕
      └── FileUploadModal 組件
          ├── 文件選擇
          ├── 上傳進度
          └── 處理狀態顯示
```

### 4.2 後端處理流程

```
文件上傳 API
  ├── 文件驗證與存儲
  └── 觸發異步處理
      ├── 文件分塊處理
      ├── 文意分析 (Ollama)
      ├── 向量化 (Embedding)
      ├── 存儲到 ChromaDB
      ├── NER/RE/RT 提取
      └── 知識圖譜構建與標簽化
```

### 4.3 數據流

### 4.4 文件管理架構

```
文件上傳
  ├── 文件存儲 (按 user_id/task_id 組織)
  │   └── storage/files/{user_id}/{task_id}/{file_id}.{ext}
  ├── 元數據管理
  │   └── 文件信息、狀態、關聯關係
  └── 前端顯示
      ├── FileManager 組件 (統一文件管理區)
      ├── ResultPanel 集成 (任務文件列表)
      └── 文件上傳後自動掛載
```

```
用戶選擇文件
  → 前端上傳
  → 後端存儲
  → 異步處理觸發
  → 文件分塊
  → 並行處理:
      ├── 向量化 → ChromaDB
      └── 圖譜提取 → ArangoDB
```

## 5. 實施時間表

| 階段                 | 預計時間           | 開始日期 | 完成日期 | 狀態        |
| -------------------- | ------------------ | -------- | -------- | ----------- |
| 階段零：安全準備     | 3-5 天             | TBD      | TBD      | ⏸️ 待開始 |
| 階段一：文件上傳     | 4.5-5.5 天         | TBD      | TBD      | ⏸️ 待開始 |
| 階段二A：向量化      | 9-13 天            | TBD      | TBD      | ⏸️ 待開始 |
| 階段二B：圖譜提取    | 12-18 天           | TBD      | TBD      | ⏸️ 待開始 |
| 階段三：整合測試     | 10-14 天           | TBD      | TBD      | ⏸️ 待開始 |
| 階段四：文件管理系統 | 4-6 天             | TBD      | TBD      | ⏸️ 待開始 |
| 階段五：安全加固     | 8-13 天            | TBD      | TBD      | ⏸️ 待開始 |
| 階段六：AI治理       | 8-12 天            | TBD      | TBD      | ⏸️ 待開始 |
| **總計**       | **59-86 天** | -        | -        | -           |

## 6. 風險與挑戰

### 6.1 技術風險

- **大文件處理**: 需要實現流式處理和進度追蹤
- **模型可用性: 本地 Ollama 服務的穩定性和響應時間
- **並發處理**: 多文件同時上傳的資源管理
- **向量化性能**: 大量文本的向量化處理時間

### 6.2 解決方案

### 6.3 安全風險

- **認證系統缺失**: 必須在階段零完成認證系統，否則系統存在嚴重安全漏洞
- **數據隱私**: 需要實現數據加密和訪問控制
- **合規性**: 需要實現數據使用同意和審計日誌

### 6.4 AI治理風險

- **模型追蹤缺失**: 無法追蹤模型使用情況，影響審計和合規
- **偏見問題**: AI提取結果可能包含偏見，需要檢測和緩解機制
- **可解釋性**: 用戶無法理解AI決策過程
- 實現文件大小限制和分片上傳
- 實現重試機制和錯誤處理
- 使用任務隊列管理並發處理
- 優化批處理和異步處理流程

## 7. 成功標準

### 7.1 功能標準

- ✅ 用戶可以通過回紋針按鈕選擇和上傳文件
- ✅ 文件成功上傳並存儲
- ✅ 文件自動進行分塊處理
- ✅ 向量成功存儲到 ChromaDB
- ✅ 知識圖譜成功提取並存儲到 ArangoDB
- ✅ 處理進度可視化顯示

### 7.2 性能標準

- 文件上傳響應時間 < 2秒（小文件）
- 分塊處理時間 < 文件大小 × 0.1秒/MB
- 向量化處理時間 < 文本長度 × 0.05秒/1000字符
- 圖譜提取時間 < 文本長度 × 0.1秒/1000字符

### 7.3 質量標準

- 代碼覆蓋率 > 80%
- API 響應時間 P95 < 3秒
- 錯誤率 < 1%

## 8. 相關文檔

- [WBS-階段一：文件上傳](./wbs-phase1-file-upload.md)
- [WBS-階段二A：分塊與向量化](./wbs-phase2a-chunk-vectorization.md)
- [WBS-階段二B：知識圖譜提取](./wbs-phase2b-kg-extraction.md)
- [WBS-階段三：整合測試](./wbs-phase3-integration-test.md)

## 9. 更新日誌

| 日期       | 版本 | 更新內容     | 更新人       |
| ---------- | ---- | ------------ | ------------ |
| 2025-01-27 | 1.0  | 初始版本創建 | Daniel Chung |
