# 文件存儲配置檢查報告

**創建日期**: 2026-01-02
**創建人**: Daniel Chung
**最後修改日期**: 2026-01-02

---

## 📋 檢查概述

本報告檢查 AI-Box 系統的文件存儲配置，確認當前使用的存儲後端，並提供統一到 SeaweedFS 的建議。

---

## 🔍 當前配置狀態

### 存儲後端配置

**當前配置**：
- `config.json` → `file_upload.storage_backend`: `local`
- 環境變數 `ENV`: `development`
- **實際使用的存儲後端**: **本地文件系統** (`LocalFileStorage`)

**存儲位置**：
- 任務工作區模式：`data/tasks/{task_id}/workspace/{file_id}.{ext}`
- 傳統模式：`./data/datasets/files/{file_id[:2]}/{file_id}.{ext}`

### 配置優先級

根據 `storage/file_storage.py` 的實現，存儲後端選擇優先級如下：

1. **明確指定**：如果 `config.json` 中 `storage_backend="local"` → 使用本地文件系統
2. **明確指定**：如果 `config.json` 中 `storage_backend="s3"` → 使用 SeaweedFS/S3
3. **環境自動選擇**：
   - 生產環境 (`ENV=production`) → 優先使用 SeaweedFS（如果 S3 配置可用）
   - 開發環境 → 優先使用本地文件系統（如果 S3 配置不可用）

---

## ✅ 統一到 SeaweedFS 的建議

### 方案 1：修改配置文件（推薦）

**適用場景**：開發環境測試 SeaweedFS

**步驟**：

1. **修改 `config.json`**：
   ```json
   {
     "file_upload": {
       "storage_backend": "s3",
       "ai_box_seaweedfs_s3_endpoint": "http://seaweedfs-ai-box-filer:8333",
       "ai_box_seaweedfs_s3_access_key": "<your-access-key>",
       "ai_box_seaweedfs_s3_secret_key": "<your-secret-key>",
       "ai_box_seaweedfs_use_ssl": false
     }
   }
   ```

2. **或使用環境變數**：
   ```bash
   export AI_BOX_SEAWEEDFS_S3_ENDPOINT="http://seaweedfs-ai-box-filer:8333"
   export AI_BOX_SEAWEEDFS_S3_ACCESS_KEY="<your-access-key>"
   export AI_BOX_SEAWEEDFS_S3_SECRET_KEY="<your-secret-key>"
   export AI_BOX_SEAWEEDFS_USE_SSL="false"
   ```

3. **重啟 API 服務**：
   ```bash
   # 重啟 API 服務以應用新配置
   ./scripts/start_services.sh restart api
   ```

### 方案 2：設置生產環境（推薦）

**適用場景**：生產環境部署

**步驟**：

1. **設置環境變數**：
   ```bash
   export ENV=production
   export AI_BOX_SEAWEEDFS_S3_ENDPOINT="http://seaweedfs-ai-box-filer:8333"
   export AI_BOX_SEAWEEDFS_S3_ACCESS_KEY="<your-access-key>"
   export AI_BOX_SEAWEEDFS_S3_SECRET_KEY="<your-secret-key>"
   export AI_BOX_SEAWEEDFS_USE_SSL="false"
   ```

2. **系統會自動選擇 SeaweedFS**（如果 S3 配置可用）

---

## 📊 存儲後端對比

| 特性 | 本地文件系統 | SeaweedFS/S3 |
|------|------------|-------------|
| **適用環境** | 開發/測試 | 生產環境 |
| **擴展性** | 單機限制 | 分布式，可擴展 |
| **Kubernetes 支持** | ❌ 不適合 | ✅ 適合無狀態擴展 |
| **文件路徑格式** | 本地路徑 | S3 URI (`s3://bucket/key`) |
| **配置複雜度** | 簡單 | 中等（需要 SeaweedFS 服務） |
| **性能** | 本地 I/O | 網絡 I/O（可能稍慢） |

---

## 🔧 檢查清單

### 當前狀態檢查

- [x] **存儲後端配置**：`local`（本地文件系統）
- [x] **環境變數**：`ENV=development`
- [x] **實際使用的存儲**：本地文件系統
- [ ] **SeaweedFS 服務狀態**：需要檢查（如果計劃使用）

### 統一到 SeaweedFS 的準備

- [ ] **SeaweedFS 服務運行**：確認 SeaweedFS 服務正常運行
- [ ] **S3 配置完整**：確認 endpoint、access_key、secret_key 配置正確
- [ ] **測試連接**：測試 S3 連接是否正常
- [ ] **文件遷移計劃**：如果已有文件在本地，需要遷移計劃
- [ ] **備份策略**：確認 SeaweedFS 的備份和恢復策略

---

## 📝 建議

### 短期（第三階段測試）

**建議**：繼續使用本地文件系統

**理由**：
- 當前配置為 `local`，測試環境穩定
- 避免測試期間的配置變更影響測試結果
- 本地文件系統更適合開發和測試環境

### 中期（生產環境部署）

**建議**：統一使用 SeaweedFS

**理由**：
- 支持 Kubernetes 無狀態擴展
- 分布式存儲，更適合生產環境
- 與 IEE（Intelligent Editor Environment）兼容

**實施步驟**：
1. 設置 `ENV=production`
2. 配置 SeaweedFS S3 環境變數
3. 系統會自動選擇 SeaweedFS
4. 使用遷移腳本將現有文件遷移到 SeaweedFS（如果需要）

---

## 🔄 文件遷移

如果已有文件在本地文件系統，需要遷移到 SeaweedFS：

**遷移腳本**：`scripts/migration/migrate_files_to_seaweedfs.py`

**遷移步驟**：
1. 確認 SeaweedFS 服務正常運行
2. 配置 S3 環境變數
3. 運行遷移腳本
4. 驗證遷移結果

**注意事項**：
- 遷移是一次性操作，不是持續的雙重備份
- 遷移後，`file_metadata.storage_path` 會更新為 S3 URI
- 建議在遷移前備份數據

---

## 📚 相關文檔

- [文件上傳架構說明](./上傳的功能架構說明-v3.0.md) - 文件存儲系統詳解
- [文件上傳狀態管理檢查報告](../備份與歸檔/文件管理歸檔/文件上傳狀態管理檢查報告.md) - 存儲位置記錄

---

## ✅ 結論

### 當前狀態

- ✅ **存儲後端**：本地文件系統（`local`）
- ✅ **配置位置**：`config.json` → `file_upload.storage_backend = "local"`
- ✅ **環境**：開發環境（`ENV=development`）

### 統一到 SeaweedFS 的建議

**第三階段測試**：
- 建議繼續使用本地文件系統，避免配置變更影響測試

**生產環境部署**：
- 建議統一使用 SeaweedFS
- 設置 `ENV=production` 並配置 S3 環境變數
- 系統會自動選擇 SeaweedFS

---

**最後更新日期**: 2026-01-02

