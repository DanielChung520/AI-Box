# 文件操作功能目錄規劃

**創建日期**: 2025-01-27
**創建人**: Daniel Chung
**最後修改日期**: 2025-01-27

## 概述

本文檔根據 `文件操作功能實現計劃.md` 的8個實現階段，規劃了前後端的檔案目錄結構。目錄規劃遵循模塊化、可維護性和可擴展性的原則。

## 規劃原則

1. **模塊化**: 按功能模塊組織代碼，每個模塊職責單一
2. **分層架構**: 明確區分路由層、服務層、數據層
3. **前後端分離**: 前端和後端目錄結構清晰分離
4. **階段對應**: 目錄結構對應實現階段，便於開發和維護
5. **可擴展性**: 預留擴展空間，方便後續功能添加

---

## 後端目錄結構

### 當前結構（基礎）

```
AI-Box/
├── api/
│   ├── routers/
│   │   ├── file_upload.py          # 文件上傳路由（S1）
│   │   ├── file_management.py      # 文件管理路由（S2, S3）
│   │   └── file_metadata.py        # 文件元數據路由
│   └── core/
│       └── response.py             # API響應格式
│
├── services/
│   └── api/
│       ├── services/
│       │   ├── file_metadata_service.py      # 文件元數據服務（S1）
│       │   ├── file_permission_service.py    # 權限檢查服務（S1）
│       │   ├── vector_store_service.py       # 向量數據服務（S1）
│       │   └── kg_extraction_service.py      # 圖譜數據服務（S1）
│       ├── models/
│       │   └── file_metadata.py              # 文件元數據模型
│       └── utils/
│           └── file_validator.py            # 文件驗證工具（S1）
│
└── storage/
    └── file_storage.py                       # 文件存儲抽象（S1）
```

### 建議的新增/重構結構

```
AI-Box/
├── api/
│   ├── routers/
│   │   ├── file_operations/                   # 文件操作路由模塊（新增）
│   │   │   ├── __init__.py
│   │   │   ├── file_upload.py                # S1: 文件上傳
│   │   │   ├── file_management.py            # S2, S3: 文件管理（列表、搜尋）
│   │   │   ├── file_crud.py                  # S3: 文件CRUD操作（重命名、複製、移動、刪除）
│   │   │   ├── folder_operations.py          # S4: 資料夾操作
│   │   │   ├── clipboard.py                  # S5: 剪貼板操作
│   │   │   ├── batch_operations.py           # S6: 批量操作
│   │   │   └── file_search.py                # S2: 文件搜尋
│   │   │
│   │   └── ai_features/                      # AI相關功能路由（新增）
│   │       ├── __init__.py
│   │       ├── file_attach.py                 # S7: 文件附加到聊天
│   │       ├── vector_view.py                 # S7: 向量資料查看
│   │       └── graph_view.py                  # S7: 圖譜資料查看
│   │
│   └── core/
│       ├── response.py                        # API響應格式
│       ├── error_handler.py                  # S1: 錯誤處理框架
│       └── permissions.py                     # S1: 權限檢查中間件
│
├── services/
│   └── api/
│       ├── services/
│       │   ├── file_operations/               # 文件操作服務模塊（新增）
│       │   │   ├── __init__.py
│       │   │   ├── file_metadata_service.py   # S1: 文件元數據服務
│       │   │   ├── file_storage_service.py    # S1: 文件存儲服務
│       │   │   ├── file_crud_service.py       # S3: 文件CRUD服務
│       │   │   ├── folder_service.py          # S4: 資料夾服務
│       │   │   ├── clipboard_service.py       # S5: 剪貼板服務
│       │   │   ├── batch_service.py           # S6: 批量操作服務
│       │   │   └── file_search_service.py     # S2: 文件搜尋服務
│       │   │
│       │   ├── data_processing/               # 數據處理服務模塊（新增）
│       │   │   ├── __init__.py
│       │   │   ├── vector_store_service.py    # S1: 向量數據服務
│       │   │   ├── kg_extraction_service.py   # S1: 圖譜數據服務
│       │   │   ├── vector_view_service.py     # S7: 向量查看服務
│       │   │   └── graph_view_service.py     # S7: 圖譜查看服務
│       │   │
│       │   ├── security/                      # 安全服務模塊（新增）
│       │   │   ├── __init__.py
│       │   │   ├── file_permission_service.py # S1: 文件權限服務
│       │   │   └── permission_checker.py      # S1: 權限檢查器
│       │   │
│       │   └── infrastructure/                # 基礎設施服務（新增）
│       │       ├── __init__.py
│       │       ├── transaction_manager.py     # S1: 事務管理器
│       │       ├── error_handler.py            # S1: 錯誤處理服務
│       │       └── cache_service.py            # 緩存服務（可選）
│       │
│       ├── models/
│       │   ├── file_operations/               # 文件操作模型（新增）
│       │   │   ├── __init__.py
│       │   │   ├── file_metadata.py           # 文件元數據模型
│       │   │   ├── file_operation.py          # 文件操作請求/響應模型
│       │   │   ├── folder_operation.py         # 資料夾操作模型
│       │   │   └── clipboard.py               # 剪貼板模型
│       │   │
│       │   └── ai_features/                   # AI功能模型（新增）
│       │       ├── __init__.py
│       │       ├── file_attach.py             # 文件附加模型
│       │       ├── vector_data.py             # 向量數據模型
│       │       └── graph_data.py              # 圖譜數據模型
│       │
│       └── utils/
│           ├── file_validator.py              # S1: 文件驗證工具
│           ├── file_utils.py                  # 文件工具函數
│           └── path_utils.py                  # 路徑工具函數
│
└── storage/
    ├── __init__.py
    ├── file_storage.py                        # S1: 文件存儲抽象
    ├── local_file_storage.py                  # S1: 本地文件存儲實現
    └── storage_factory.py                    # S1: 存儲工廠（可選）
```

---

## 前端目錄結構

### 當前結構（基礎）

```
ai-bot/src/
├── components/
│   ├── FileTree.tsx                          # 文件樹組件（S1）
│   ├── FileViewer.tsx                         # 文件查看器
│   ├── FileUploadModal.tsx                    # 文件上傳對話框
│   ├── FileSearchModal.tsx                    # 文件搜尋對話框（S2）
│   └── ResultPanel.tsx                        # 結果面板
│
├── lib/
│   ├── api.ts                                 # API客戶端
│   ├── mockFileStorage.ts                     # 模擬文件存儲
│   └── taskStorage.ts                         # 任務存儲
│
└── pages/
    └── Home.tsx                               # 主頁面
```

### 建議的新增/重構結構

```
ai-bot/src/
├── components/
│   ├── file-operations/                       # 文件操作組件模塊（新增）
│   │   ├── FileTree/
│   │   │   ├── index.tsx                      # S1: 文件樹主組件
│   │   │   ├── FileTreeNode.tsx               # 文件樹節點
│   │   │   ├── FolderNode.tsx                 # 資料夾節點
│   │   │   └── FileNode.tsx                  # 文件節點
│   │   │
│   │   ├── FileInfo/
│   │   │   ├── FileInfoModal.tsx              # S2: 文件信息對話框（已實現）
│   │   │   └── FolderInfoModal.tsx            # S4: 資料夾信息對話框
│   │   │
│   │   ├── FileOperations/
│   │   │   ├── RenameDialog.tsx               # S3: 重命名對話框
│   │   │   ├── MoveDialog.tsx                 # S3: 移動對話框
│   │   │   ├── DeleteConfirmDialog.tsx        # S3: 刪除確認對話框
│   │   │   ├── CopyProgress.tsx               # S3: 複製進度
│   │   │   └── OperationProgress.tsx         # 操作進度通用組件
│   │   │
│   │   ├── FolderOperations/
│   │   │   ├── CreateFolderDialog.tsx         # S4: 創建資料夾對話框
│   │   │   ├── RenameFolderDialog.tsx         # S4: 重命名資料夾對話框
│   │   │   └── DeleteFolderConfirmDialog.tsx  # S4: 刪除資料夾確認對話框
│   │   │
│   │   ├── Clipboard/
│   │   │   ├── ClipboardManager.tsx           # S5: 剪貼板管理器
│   │   │   └── ClipboardIndicator.tsx         # S5: 剪貼板狀態指示器
│   │   │
│   │   ├── BatchOperations/
│   │   │   ├── BatchSelector.tsx              # S6: 批量選擇器
│   │   │   ├── BatchOperationBar.tsx          # S6: 批量操作工具欄
│   │   │   └── BatchProgress.tsx              # S6: 批量操作進度
│   │   │
│   │   ├── ContextMenus/
│   │   │   ├── FileContextMenu.tsx            # S1: 文件右鍵選單
│   │   │   ├── FolderContextMenu.tsx          # S1: 資料夾右鍵選單
│   │   │   └── ContextMenu.tsx                # 右鍵選單基礎組件
│   │   │
│   │   └── HeaderToolbar/
│   │       ├── FileOperationToolbar.tsx       # S8: Header工具欄
│   │       ├── NewFolderButton.tsx            # S8: 新增資料夾按鈕
│   │       ├── NewFileButton.tsx              # S8: 新增檔案按鈕
│   │       ├── SearchButton.tsx               # S2: 搜尋按鈕
│   │       └── MoreOptionsMenu.tsx            # S8: 更多選項選單
│   │
│   ├── file-viewer/                           # 文件查看器模塊（現有，可優化）
│   │   ├── FileViewer.tsx                     # 文件查看器主組件
│   │   ├── MarkdownViewer.tsx                 # Markdown查看器
│   │   ├── PDFViewer.tsx                      # PDF查看器
│   │   ├── DOCXViewer.tsx                     # DOCX查看器
│   │   └── ImageViewer.tsx                    # 圖片查看器（可新增）
│   │
│   ├── file-search/                           # 文件搜尋模塊（新增）
│   │   ├── FileSearchModal.tsx                # S2: 文件搜尋對話框（已實現）
│   │   ├── SearchResults.tsx                  # 搜尋結果列表
│   │   └── SearchFilters.tsx                  # 搜尋過濾器
│   │
│   └── ai-features/                           # AI功能組件模塊（新增）
│       ├── FileAttach/
│       │   ├── FileAttachButton.tsx           # S7: 文件附加按鈕
│       │   ├── AttachedFileList.tsx           # S7: 附加文件列表
│       │   └── FileAttachManager.tsx          # S7: 文件附加管理器
│       │
│       ├── VectorView/
│       │   ├── VectorViewModal.tsx            # S7: 向量資料查看對話框
│       │   ├── VectorList.tsx                 # 向量列表
│       │   └── VectorVisualization.tsx        # 向量可視化（可選）
│       │
│       └── GraphView/
│           ├── GraphViewModal.tsx             # S7: 圖譜資料查看對話框
│           ├── GraphVisualization.tsx         # 圖譜可視化
│           └── GraphNodeDetails.tsx           # 圖譜節點詳情
│
├── lib/
│   ├── api/
│   │   ├── index.ts                           # API客戶端主入口
│   │   ├── file-operations/                   # 文件操作API（新增）
│   │   │   ├── fileUpload.ts                  # S1: 文件上傳API
│   │   │   ├── fileCRUD.ts                    # S3: 文件CRUD API
│   │   │   ├── folderOperations.ts            # S4: 資料夾操作API
│   │   │   ├── clipboard.ts                   # S5: 剪貼板API
│   │   │   ├── batchOperations.ts             # S6: 批量操作API
│   │   │   └── fileSearch.ts                  # S2: 文件搜尋API
│   │   │
│   │   └── ai-features/                       # AI功能API（新增）
│   │       ├── fileAttach.ts                  # S7: 文件附加API
│   │       ├── vectorView.ts                  # S7: 向量查看API
│   │       └── graphView.ts                   # S7: 圖譜查看API
│   │
│   ├── services/                              # 前端服務層（新增）
│   │   ├── fileOperationService.ts            # 文件操作服務
│   │   ├── clipboardService.ts                # S5: 剪貼板服務
│   │   ├── batchOperationService.ts           # S6: 批量操作服務
│   │   └── focusStateService.ts               # S8: 聚焦狀態服務
│   │
│   ├── stores/                                # 狀態管理（新增）
│   │   ├── fileTreeStore.ts                   # S1: 文件樹狀態
│   │   ├── clipboardStore.ts                  # S5: 剪貼板狀態
│   │   ├── selectionStore.ts                  # S6: 選擇狀態
│   │   └── focusStore.ts                      # S8: 聚焦狀態
│   │
│   ├── hooks/                                 # 自定義Hooks（新增）
│   │   ├── useFileOperations.ts               # 文件操作Hook
│   │   ├── useClipboard.ts                    # S5: 剪貼板Hook
│   │   ├── useBatchSelection.ts               # S6: 批量選擇Hook
│   │   ├── useFileSearch.ts                   # S2: 文件搜尋Hook
│   │   └── useFocusState.ts                   # S8: 聚焦狀態Hook
│   │
│   ├── utils/
│   │   ├── fileUtils.ts                       # 文件工具函數
│   │   ├── pathUtils.ts                       # 路徑工具函數
│   │   ├── validation.ts                      # 驗證工具函數
│   │   └── errorHandler.ts                    # 錯誤處理工具
│   │
│   └── mock/                                  # 模擬數據（開發用）
│       ├── mockFileStorage.ts                 # 模擬文件存儲（現有）
│       └── mockTaskStorage.ts                 # 模擬任務存儲（現有）
│
├── types/                                     # TypeScript類型定義（新增）
│   ├── file-operations/
│   │   ├── file.ts                            # 文件類型定義
│   │   ├── folder.ts                          # 資料夾類型定義
│   │   ├── clipboard.ts                       # S5: 剪貼板類型定義
│   │   └── operations.ts                      # 操作類型定義
│   │
│   └── api/
│       ├── file-operations.ts                 # 文件操作API類型
│       └── ai-features.ts                     # AI功能API類型
│
└── pages/
    └── Home.tsx                               # 主頁面（整合所有功能）
```

---

## 階段對應目錄映射

### 階段一：基礎設施建設（S1）

**後端**:
- `api/routers/file_operations/file_upload.py`
- `services/api/services/file_operations/file_metadata_service.py`
- `services/api/services/file_operations/file_storage_service.py`
- `services/api/services/security/file_permission_service.py`
- `services/api/services/infrastructure/transaction_manager.py`
- `services/api/services/infrastructure/error_handler.py`
- `storage/file_storage.py`

**前端**:
- `components/file-operations/FileTree/`
- `components/file-operations/ContextMenus/`
- `lib/api/file-operations/fileUpload.ts`
- `lib/stores/fileTreeStore.ts`

### 階段二：基礎操作實現（S2）

**後端**:
- `api/routers/file_operations/file_search.py`
- `services/api/services/file_operations/file_search_service.py`

**前端**:
- `components/file-operations/FileInfo/FileInfoModal.tsx`
- `components/file-search/FileSearchModal.tsx`
- `lib/api/file-operations/fileSearch.ts`
- `lib/hooks/useFileSearch.ts`

### 階段三：文件操作核心（S3）

**後端**:
- `api/routers/file_operations/file_crud.py`
- `services/api/services/file_operations/file_crud_service.py`

**前端**:
- `components/file-operations/FileOperations/`
- `lib/api/file-operations/fileCRUD.ts`
- `lib/hooks/useFileOperations.ts`

### 階段四：資料夾操作（S4）

**後端**:
- `api/routers/file_operations/folder_operations.py`
- `services/api/services/file_operations/folder_service.py`

**前端**:
- `components/file-operations/FolderOperations/`
- `lib/api/file-operations/folderOperations.ts`

### 階段五：剪貼板操作（S5）

**後端**:
- `api/routers/file_operations/clipboard.py`
- `services/api/services/file_operations/clipboard_service.py`

**前端**:
- `components/file-operations/Clipboard/`
- `lib/api/file-operations/clipboard.ts`
- `lib/services/clipboardService.ts`
- `lib/stores/clipboardStore.ts`
- `lib/hooks/useClipboard.ts`

### 階段六：批量操作（S6）

**後端**:
- `api/routers/file_operations/batch_operations.py`
- `services/api/services/file_operations/batch_service.py`

**前端**:
- `components/file-operations/BatchOperations/`
- `lib/api/file-operations/batchOperations.ts`
- `lib/services/batchOperationService.ts`
- `lib/stores/selectionStore.ts`
- `lib/hooks/useBatchSelection.ts`

### 階段七：AI相關功能（S7）

**後端**:
- `api/routers/ai_features/`
- `services/api/services/data_processing/vector_view_service.py`
- `services/api/services/data_processing/graph_view_service.py`

**前端**:
- `components/ai-features/`
- `lib/api/ai-features/`

### 階段八：高級功能整合（S8）

**後端**:
- 整合現有路由，無新增目錄

**前端**:
- `components/file-operations/HeaderToolbar/`
- `lib/services/focusStateService.ts`
- `lib/stores/focusStore.ts`
- `lib/hooks/useFocusState.ts`

---

## 目錄創建計劃

### 第一階段：基礎目錄結構（S1開始前）

```bash
# 後端目錄
mkdir -p api/routers/file_operations
mkdir -p api/routers/ai_features
mkdir -p services/api/services/file_operations
mkdir -p services/api/services/data_processing
mkdir -p services/api/services/security
mkdir -p services/api/services/infrastructure
mkdir -p services/api/models/file_operations
mkdir -p services/api/models/ai_features

# 前端目錄
mkdir -p src/components/file-operations/{FileTree,FileInfo,FileOperations,FolderOperations,Clipboard,BatchOperations,ContextMenus,HeaderToolbar}
mkdir -p src/components/file-search
mkdir -p src/components/ai-features/{FileAttach,VectorView,GraphView}
mkdir -p src/lib/api/file-operations
mkdir -p src/lib/api/ai-features
mkdir -p src/lib/services
mkdir -p src/lib/stores
mkdir -p src/lib/hooks
mkdir -p src/types/file-operations
mkdir -p src/types/api
```

### 第二階段：按實現階段逐步填充

每個階段實現時，在對應目錄中創建文件，遵循以下原則：
1. 先創建目錄結構
2. 再實現基礎功能
3. 最後進行功能整合

---

## 文件命名規範

### 後端文件命名
- **路由文件**: `{功能}_operations.py` 或 `{功能}.py`
- **服務文件**: `{功能}_service.py`
- **模型文件**: `{功能}.py` 或 `{功能}_model.py`
- **工具文件**: `{功能}_utils.py` 或 `{功能}_helper.py`

### 前端文件命名
- **組件文件**: `{ComponentName}.tsx`（PascalCase）
- **Hook文件**: `use{HookName}.ts`（camelCase，use前綴）
- **服務文件**: `{serviceName}Service.ts`（camelCase）
- **API文件**: `{apiName}.ts`（camelCase）
- **類型文件**: `{typeName}.ts`（camelCase）

---

## 模塊導入規範

### 後端導入示例

```python
# 從服務層導入
from services.api.services.file_operations.file_metadata_service import FileMetadataService
from services.api.services.file_operations.file_crud_service import FileCRUDService

# 從模型層導入
from services.api.models.file_operations.file_metadata import FileMetadata
from services.api.models.file_operations.file_operation import FileRenameRequest

# 從工具層導入
from services.api.utils.file_validator import FileValidator
```

### 前端導入示例

```typescript
// 從組件導入
import FileTree from '@/components/file-operations/FileTree';
import FileInfoModal from '@/components/file-operations/FileInfo/FileInfoModal';

// 從API導入
import { uploadFile, deleteFile } from '@/lib/api/file-operations/fileCRUD';

// 從服務導入
import { useClipboard } from '@/lib/hooks/useClipboard';
import { clipboardStore } from '@/lib/stores/clipboardStore';

// 從類型導入
import type { FileMetadata, FolderMetadata } from '@/types/file-operations/file';
```

---

## 測試目錄結構

### 後端測試

```
tests/
├── api/
│   └── routers/
│       └── file_operations/
│           ├── test_file_upload.py
│           ├── test_file_crud.py
│           └── test_folder_operations.py
│
└── services/
    └── api/
        └── services/
            └── file_operations/
                ├── test_file_metadata_service.py
                └── test_file_crud_service.py
```

### 前端測試

```
ai-bot/src/
└── __tests__/
    ├── components/
    │   └── file-operations/
    │       ├── FileTree.test.tsx
    │       └── FileInfoModal.test.tsx
    │
    └── lib/
        └── api/
            └── file-operations/
                └── fileCRUD.test.ts
```

---

## 文檔目錄結構

```
docs/
├── file-operations/                           # 文件操作相關文檔（新增）
│   ├── api/                                   # API文檔
│   │   ├── file-operations-api.md
│   │   └── ai-features-api.md
│   │
│   ├── architecture/                          # 架構文檔
│   │   ├── backend-architecture.md
│   │   └── frontend-architecture.md
│   │
│   └── guides/                                # 開發指南
│       ├── backend-development-guide.md
│       └── frontend-development-guide.md
│
├── 文件操作.md                                # 功能需求文檔（現有）
├── 文件操作功能實現計劃.md                    # 實現計劃（現有）
└── 文件操作功能WBS計劃.md                    # WBS計劃（現有）
```

---

## 遷移計劃

### 階段一：重構現有代碼（S1開始前）

1. **後端重構**:
   - 將 `api/routers/file_upload.py` 移動到 `api/routers/file_operations/file_upload.py`
   - 將 `api/routers/file_management.py` 拆分為多個文件
   - 重構服務層，按模塊組織

2. **前端重構**:
   - 將 `components/FileTree.tsx` 移動到 `components/file-operations/FileTree/`
   - 將 `components/FileSearchModal.tsx` 移動到 `components/file-search/`
   - 重構 `lib/api.ts`，按功能模塊拆分

### 階段二：逐步實現新功能（S1-S8）

按照實現計劃，在對應目錄中創建新文件，實現新功能。

---

## 注意事項

1. **向後兼容**: 重構時保持API向後兼容，使用別名導入舊路徑
2. **漸進式遷移**: 不要一次性重構所有代碼，按階段逐步遷移
3. **文檔同步**: 每次目錄變更都要更新文檔
4. **代碼審查**: 目錄結構變更需要經過代碼審查
5. **測試覆蓋**: 重構後確保測試覆蓋率不降低

---

## 更新日誌

### 2025-01-27
- ✅ 創建文件操作功能目錄規劃文檔
- ✅ 規劃後端目錄結構（按8個階段組織）
- ✅ 規劃前端目錄結構（按8個階段組織）
- ✅ 定義階段對應目錄映射
- ✅ 制定目錄創建和遷移計劃
- ✅ 定義文件命名和導入規範

---
