# 圖譜重新生成功能測試報告

**測試日期**: 2025-12-10  
**測試人**: Daniel Chung  
**測試範圍**: 文件預覽圖譜模式的重新生成功能

---

## 測試總結

### ✅ 測試通過的項目

1. **API 端點**
   - ✅ `POST /api/v1/files/{file_id}/regenerate` 端點存在
   - ✅ 支持 `type: "graph"` 參數
   - ✅ 返回 200 狀態碼
   - ✅ 後台任務已添加到隊列

2. **後台任務函數**
   - ✅ `process_kg_extraction_only()` 函數存在
   - ✅ 文件讀取邏輯正常（支持從文件系統直接讀取）
   - ✅ 文件解析成功
   - ✅ 文本分塊成功（測試文件生成了5個chunks）

3. **代碼修復**
   - ✅ 已修復文件讀取邏輯，支持在元數據不存在時從文件系統直接讀取
   - ✅ 已更新 `.env` 中的 `ARANGODB_PASSWORD` 為 `ai_box_arangodb_password`

### ⚠️ 發現的問題

1. **ArangoDB 認證問題**
   - **問題**: `[HTTP 401][ERR 11] not authorized to execute this request`
   - **原因**: `.env` 中的 `ARANGODB_PASSWORD` 與 `docker-compose.yml` 中的 `ARANGO_ROOT_PASSWORD` 不匹配
   - **狀態**: ✅ 已修復（更新了 `.env` 文件）
   - **影響**: 需要重啟 API 服務才能生效

2. **Redis 連接失敗**
   - **問題**: `Connection refused`
   - **原因**: Redis 服務未運行
   - **影響**: 無法更新處理狀態到 Redis，但不影響後台任務執行

---

## 測試流程

### 1. API 端點測試

```bash
POST /api/v1/files/{file_id}/regenerate
Headers: Authorization: Bearer {token}
Body: {"type": "graph"}
```

**結果**: ✅ 成功
- 返回 200 狀態碼
- 返回消息: "圖譜重新生成已啟動，處理將在後台進行"
- 後台任務已添加到 FastAPI BackgroundTasks

### 2. 後台任務執行測試

**測試文件**: `32fe6db5-c89c-4885-b962-0d63a17070a1.md`

**執行步驟**:
1. ✅ 檢查文件是否存在
2. ✅ 嘗試從向量重構 chunks（失敗，因為沒有向量數據）
3. ✅ 從文件系統直接讀取文件
4. ✅ 解析文件（Markdown）
5. ✅ 文本分塊（生成5個chunks）
6. ⚠️ 執行圖譜提取（ArangoDB 認證失敗）

**執行結果**:
- ✅ 文件讀取: 成功（2195字符）
- ✅ 文件解析: 成功
- ✅ 文本分塊: 成功（5個chunks）
- ⚠️ 圖譜提取: ArangoDB 認證失敗（已修復配置，需重啟服務）

---

## 代碼修改記錄

### 1. 文件讀取邏輯增強

**文件**: `api/routers/file_upload.py`

**修改內容**:
- 在 `process_kg_extraction_only()` 中，當無法從存儲讀取文件時，嘗試直接從文件系統讀取
- 支持在文件元數據不存在時仍能執行圖譜提取

**修改代碼**:
```python
# 如果無法從存儲讀取，嘗試直接從文件系統讀取
if file_content is None and file_path and os.path.exists(file_path):
    logger.info(
        "直接從文件系統讀取文件",
        file_id=file_id,
        file_path=file_path,
    )
    with open(file_path, "rb") as f:
        file_content = f.read()
```

### 2. 環境變量修復

**文件**: `.env`

**修改內容**:
- 將 `ARANGODB_PASSWORD` 從 `changeme` 更新為 `ai_box_arangodb_password`
- 與 `docker-compose.yml` 中的 `ARANGO_ROOT_PASSWORD` 保持一致

---

## 測試結論

### ✅ 功能可以執行

1. **API 端點**: ✅ 正常工作
2. **後台任務**: ✅ 可以啟動
3. **文件處理**: ✅ 讀取、解析、分塊都成功
4. **圖譜提取**: ⚠️ 需要重啟 API 服務後測試（ArangoDB 認證已修復）

### 📋 後續步驟

1. **重啟 API 服務**
   ```bash
   # 停止現有服務
   pkill -f "uvicorn api.main"
   
   # 啟動服務（會自動加載新的.env配置）
   source venv/bin/activate
   uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload
   ```

2. **啟動 Redis 服務**（可選，用於狀態更新）
   ```bash
   docker-compose up -d redis
   ```

3. **重新測試**
   - 通過前端觸發圖譜重新生成
   - 或通過 API 直接調用
   - 檢查後台日誌確認執行情況

---

## 測試日誌示例

### 成功的執行日誌

```
2025-12-10 09:30:54 [info] 重新解析和分塊以進行圖譜提取
2025-12-10 09:30:54 [warning] 無法獲取文件元數據，將嘗試直接讀取文件
2025-12-10 09:30:54 [info] 直接從文件系統讀取文件
2025-12-10 09:30:59 [info] 文件重新分塊完成 chunk_count=5
```

### 需要修復的問題

```
2025-12-10 09:31:03 [error] 知識圖譜提取失敗
  error='[HTTP 401][ERR 11] not authorized to execute this request'
```

**狀態**: ✅ 已修復（更新了 `.env` 配置）

---

## 功能驗證清單

- [x] API 端點存在且可訪問
- [x] 後台任務函數存在
- [x] 文件讀取邏輯正常
- [x] 文件解析成功
- [x] 文本分塊成功
- [ ] 圖譜提取成功（需重啟服務後測試）
- [ ] 圖譜數據存儲成功（需重啟服務後測試）
- [ ] 前端可以查詢圖譜數據（需重啟服務後測試）

---

**報告結束**
