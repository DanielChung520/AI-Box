# 文檔顯示功能規格與技術架構

**代碼功能說明**: 文檔顯示功能（Markdown、DOCX、XLSX、PDF）的功能規格與技術架構文檔
**創建日期**: 2025-12-17
**創建人**: Daniel Chung
**最後修改日期**: 2025-12-17

---

## 目錄

1. [功能概述](#功能概述)
2. [功能規格](#功能規格)
3. [技術架構](#技術架構)
4. [各文件類型實現詳情](#各文件類型實現詳情)
5. [API 接口說明](#api-接口說明)
6. [技術棧與依賴](#技術棧與依賴)
7. [錯誤處理機制](#錯誤處理機制)
8. [性能優化](#性能優化)

---

## 功能概述

文檔顯示功能是 AI-Box 平台的核心功能之一，支持在瀏覽器中直接預覽多種文件格式，包括：

- **Markdown (.md)**: 支持 Markdown 語法渲染、Mermaid 圖表、代碼高亮
- **DOCX (.docx, .doc)**: Microsoft Word 文檔預覽
- **XLSX (.xlsx, .xls)**: Microsoft Excel 表格預覽
- **PDF (.pdf)**: PDF 文檔預覽，支持頁面導航、縮放、旋轉

所有文件類型均支持：

- 文件內容預覽
- 向量數據查看（如果已生成）
- 知識圖譜查看（如果已生成）
- 文件下載功能

---

## 功能規格

### 1. Markdown 文件顯示

#### 1.1 核心功能

- ✅ Markdown 語法完整支持（標題、列表、表格、代碼塊、鏈接等）
- ✅ Mermaid 圖表渲染（流程圖、序列圖、甘特圖等）
- ✅ 代碼高亮顯示
- ✅ 響應式布局，適配不同屏幕尺寸
- ✅ 深色/淺色主題支持

#### 1.2 擴展功能

- **三種預覽模式**：
  - **文件模式**: 顯示 Markdown 渲染後的內容
  - **向量模式**: 顯示文件的向量化數據（向量數量、維度、集合名稱等）
  - **圖譜模式**: 顯示知識圖譜（實體、關係、三元組）

- **數據生成狀態監控**：
  - 實時顯示向量/圖譜生成進度
  - 支持手動觸發重新生成
  - 自動輪詢檢查生成狀態（每 3 秒）

#### 1.3 特殊處理

- 草稿文件（`draft-*` ID）不支持向量和圖譜功能
- 自動識別並渲染 Mermaid 代碼塊
- 保留原始格式（換行、縮進）

### 2. DOCX 文件顯示

#### 2.1 核心功能

- ✅ DOCX/DOC 格式文件解析
- ✅ 將 Word 文檔轉換為 HTML 顯示
- ✅ 保留文檔格式（字體、顏色、段落等）
- ✅ 支持大文件加載（通過 Blob 流式處理）

#### 2.2 技術實現

- 使用 `mammoth` 庫將 DOCX 轉換為 HTML
- 通過 `downloadFile` API 下載文件（自動處理認證）
- 錯誤處理：認證失敗、文件不存在、權限不足等

### 3. XLSX 文件顯示

#### 3.1 核心功能

- ✅ Excel 文件解析（.xlsx, .xls）
- ✅ 多工作表支持
- ✅ 工作表切換功能
- ✅ 表格數據完整顯示
- ✅ 表頭自動識別（第一行作為表頭）

#### 3.2 技術實現

- 使用 `xlsx` 庫解析 Excel 文件
- 支持多工作表，可通過下拉選單切換
- 表格樣式：邊框、表頭高亮、響應式布局

### 4. PDF 文件顯示

#### 4.1 核心功能

- ✅ PDF 文檔完整渲染
- ✅ 頁面導航（上一頁/下一頁）
- ✅ 縮放控制（50% - 300%）
- ✅ 旋轉功能（90° 倍數）
- ✅ 下載功能
- ✅ 頁碼顯示（當前頁/總頁數）

#### 4.2 技術實現

- 使用 `react-pdf` 庫（基於 PDF.js）
- PDF.js Worker 通過 CDN 加載（unpkg）
- 使用 ArrayBuffer 傳遞 PDF 數據（更穩定）
- 自動處理認證（通過 `downloadFile` API）

#### 4.3 布局優化

- 確保不覆蓋文件/向量/圖譜按鈕組
- 使用 Flexbox 布局，正確處理滾動
- 響應式設計，適配不同屏幕

---

## 技術架構

### 架構圖

```
┌─────────────────────────────────────────────────────────┐
│                    FilePreview 組件                      │
│  (統一入口，處理文件類型判斷和模式切換)                    │
└──────────────────┬──────────────────────────────────────┘
                   │
        ┌──────────┼──────────┐
        │          │          │
        ▼          ▼          ▼
┌──────────┐ ┌──────────┐ ┌──────────┐
│ Markdown │ │  DOCX    │ │  XLSX    │
│ Viewer   │ │  Viewer  │ │  Viewer  │
└──────────┘ └──────────┘ └──────────┘
        │
        ▼
┌──────────┐
│   PDF    │
│  Viewer  │
└──────────┘
```

### 組件層次結構

1. **FilePreview** (頂層組件)
   - 文件類型判斷
   - 模式切換（文件/向量/圖譜）
   - 統一錯誤處理
   - 數據可用性檢查

2. **專用 Viewer 組件**
   - `MarkdownViewer`: Markdown 渲染
   - `DOCXViewer`: DOCX 文件顯示
   - `ExcelViewer`: Excel 文件顯示
   - `PDFViewer`: PDF 文件顯示

3. **輔助組件**
   - `MermaidRenderer`: Mermaid 圖表渲染
   - `KnowledgeGraphViewer`: 知識圖譜可視化

### 數據流

```
用戶操作
   │
   ▼
FilePreview 組件
   │
   ├─→ 檢查文件類型
   │
   ├─→ 調用對應 Viewer 組件
   │
   ├─→ downloadFile API (需要認證的文件)
   │
   ├─→ 文件解析/轉換
   │
   └─→ 渲染顯示
```

---

## 各文件類型實現詳情

### 1. MarkdownViewer

**文件路徑**: `ai-bot/src/components/MarkdownViewer.tsx`

**核心依賴**:

- `markdown-to-jsx`: Markdown 轉 JSX
- `mermaid`: Mermaid 圖表渲染
- `prism-react-renderer`: 代碼高亮

**主要功能**:

1. **Markdown 解析**:
   - 使用 `markdown-to-jsx` 將 Markdown 轉換為 React 組件
   - 自定義組件樣式（標題、列表、表格、代碼塊等）
   - 保留原始格式（`whiteSpace: 'pre-wrap'`）

2. **Mermaid 圖表**:
   - 自動識別 ````mermaid` 代碼塊
   - 使用 `MermaidRenderer` 組件渲染
   - 支持所有 Mermaid 圖表類型

3. **向量/圖譜模式**:
   - 通過 `getFileVectors` API 獲取向量數據
   - 通過 `getFileGraph` API 獲取圖譜數據
   - 實時監控生成狀態

**狀態管理**:

```typescript
- mode: 'text' | 'vector' | 'graph'
- markdownParts: Array<{type: 'text' | 'mermaid', content: string}>
- vectorData: 向量數據
- graphData: 圖譜數據
- loading: 加載狀態
- error: 錯誤信息
```

### 2. DOCXViewer

**文件路徑**: `ai-bot/src/components/DOCXViewer.tsx`

**核心依賴**:

- `mammoth`: DOCX 轉 HTML

**實現流程**:

1. 通過 `downloadFile` API 下載 DOCX 文件（Blob）
2. 將 Blob 轉換為 ArrayBuffer
3. 使用 `mammoth.convertToHtml()` 轉換為 HTML
4. 使用 `dangerouslySetInnerHTML` 渲染 HTML

**錯誤處理**:

- 文件為空
- 認證失敗 (401)
- 文件不存在 (404)
- 權限不足 (403)
- 服務器錯誤 (5xx)

### 3. ExcelViewer

**文件路徑**: `ai-bot/src/components/ExcelViewer.tsx`

**核心依賴**:

- `xlsx`: Excel 文件解析

**實現流程**:

1. 通過 `downloadFile` API 下載 Excel 文件（Blob）
2. 將 Blob 轉換為 ArrayBuffer
3. 使用 `XLSX.read()` 解析工作簿
4. 提取所有工作表數據
5. 渲染為 HTML 表格

**特殊功能**:

- 多工作表支持（下拉選單切換）
- 第一行自動識別為表頭
- 空單元格處理（使用空字符串）

### 4. PDFViewer

**文件路徑**: `ai-bot/src/components/PDFViewer.tsx`

**核心依賴**:

- `react-pdf`: PDF 渲染（基於 PDF.js）
- `pdfjs-dist`: PDF.js 核心庫

**實現流程**:

1. 配置 PDF.js Worker（通過 unpkg CDN）
2. 通過 `downloadFile` API 下載 PDF 文件（Blob）
3. 將 Blob 轉換為 ArrayBuffer
4. 使用 `react-pdf` 的 `Document` 組件渲染
5. 使用 `Page` 組件顯示單頁

**PDF.js Worker 配置**:

```javascript
pdfjs.GlobalWorkerOptions.workerSrc =
  `https://unpkg.com/pdfjs-dist@${pdfjs.version}/build/pdf.worker.min.mjs`;
```

**功能控制**:

- 頁面導航：`pageNumber` 狀態
- 縮放：`scale` 狀態（0.5 - 3.0）
- 旋轉：`rotation` 狀態（0, 90, 180, 270）

**布局優化**:

- 使用 Flexbox 布局
- `flex-shrink-0` 確保工具欄不被壓縮
- `minHeight: 0` 確保內容區域正確滾動

---

## API 接口說明

### 1. downloadFile

**接口**: `GET /api/v1/files/{file_id}/download`

**功能**: 下載文件（自動處理認證）

**參數**:

- `file_id` (path): 文件 ID

**響應**:

- `Content-Type`: 根據文件類型（`application/pdf`, `application/octet-stream` 等）
- `Content-Length`: 文件大小
- `Body`: 文件二進制數據（Blob）

**認證**: 需要 Bearer Token（自動從 localStorage 獲取）

**使用示例**:

```typescript
const blob = await downloadFile(fileId);
const arrayBuffer = await blob.arrayBuffer();
```

### 2. getFileVectors

**接口**: `GET /api/v1/files/{file_id}/vectors`

**功能**: 獲取文件的向量數據

**參數**:

- `file_id` (path): 文件 ID
- `limit` (query): 返回數量限制
- `offset` (query): 偏移量

**響應**:

```json
{
  "success": true,
  "data": {
    "vectors": [...],
    "total": 100,
    "stats": {
      "vector_count": 100,
      "dimension": 1536,
      "collection_name": "file_vectors"
    }
  }
}
```

### 3. getFileGraph

**接口**: `GET /api/v1/files/{file_id}/graph`

**功能**: 獲取文件的知識圖譜數據

**參數**:

- `file_id` (path): 文件 ID
- `limit` (query): 返回數量限制
- `offset` (query): 偏移量

**響應**:

```json
{
  "success": true,
  "data": {
    "nodes": [...],
    "edges": [...],
    "triples": [...],
    "stats": {
      "entities_count": 50,
      "relations_count": 30,
      "triples_count": 80
    }
  }
}
```

### 4. getProcessingStatus

**接口**: `GET /api/v1/files/{file_id}/processing-status`

**功能**: 獲取文件處理狀態（向量化/圖譜化進度）

**響應**:

```json
{
  "success": true,
  "data": {
    "vectorization": {
      "status": "processing",
      "progress": 75,
      "message": "向量處理中..."
    },
    "kg_extraction": {
      "status": "processing",
      "progress": 50,
      "total_chunks": 10,
      "completed_chunks": [1, 2, 3, 4, 5],
      "failed_chunks": [],
      "failed_permanent_chunks": []
    }
  }
}
```

### 5. regenerateFileData

**接口**: `POST /api/v1/files/{file_id}/regenerate`

**功能**: 重新生成文件的向量或圖譜數據

**參數**:

- `file_id` (path): 文件 ID
- `data_type` (body): `'vector'` 或 `'graph'`

**響應**:

```json
{
  "success": true,
  "message": "任務已提交",
  "data": {
    "job_id": "job_123456"
  }
}
```

---

## 技術棧與依賴

### 前端框架

- **React**: 18.3.1
- **TypeScript**: 5.7.2
- **Vite**: 6.2.0 (構建工具)

### 核心依賴

#### Markdown 相關

- `markdown-to-jsx`: ^9.3.5 - Markdown 轉 JSX
- `mermaid`: ^10.9.0 - Mermaid 圖表渲染
- `prism-react-renderer`: ^2.3.1 - 代碼高亮

#### 文檔處理

- `mammoth`: ^1.11.0 - DOCX 轉 HTML
- `xlsx`: ^0.18.5 - Excel 文件解析
- `react-pdf`: ^10.2.0 - PDF 渲染（基於 PDF.js 5.4.296）

#### UI 組件

- `lucide-react`: ^0.555.0 - 圖標庫
- `sonner`: ^2.0.2 - Toast 通知
- `tailwindcss`: ^3.4.17 - CSS 框架

#### 圖表可視化

- `@antv/g6`: ^5.0.50 - 知識圖譜可視化

### CDN 資源

#### PDF.js Worker

- **URL**: `https://unpkg.com/pdfjs-dist@5.4.296/build/pdf.worker.min.mjs`
- **用途**: PDF.js Worker 線程（用於 PDF 解析）
- **備選**: 如果 CDN 不可用，可考慮本地部署

#### PDF.js 資源

- **CMap URL**: `https://unpkg.com/pdfjs-dist@5.4.296/cmaps/`
- **標準字體**: `https://unpkg.com/pdfjs-dist@5.4.296/standard_fonts/`

---

## 錯誤處理機制

### 1. 文件下載錯誤

**錯誤類型**:

- 401: 認證失敗 → 提示重新登錄
- 403: 權限不足 → 提示無權限訪問
- 404: 文件不存在 → 提示文件不存在
- 5xx: 服務器錯誤 → 顯示錯誤信息

**處理方式**:

```typescript
try {
  const blob = await downloadFile(fileId);
  // 處理文件
} catch (err: any) {
  if (err.status === 401) {
    errorMessage = '認證失敗，請重新登錄';
  } else if (err.status === 404) {
    errorMessage = '文件不存在';
  } else {
    errorMessage = err.message || '無法加載文件';
  }
  setError(errorMessage);
}
```

### 2. 文件解析錯誤

**DOCX**:

- 空文件檢查
- mammoth 轉換警告（記錄但不阻止渲染）

**Excel**:

- 空工作表檢查
- 文件格式驗證

**PDF**:

- PDF.js Worker 加載失敗
- PDF 文件損壞
- 頁面渲染錯誤

### 3. 數據可用性檢查

**靜默處理**:

- 404 錯誤（文件可能沒有向量/圖譜數據是正常情況）
- 只記錄非 404 錯誤

**用戶提示**:

- 數據未生成：顯示"未成功生成"和重新生成按鈕
- 數據生成中：顯示進度條和狀態信息
- 數據生成失敗：顯示錯誤信息和重試按鈕

---

## 性能優化

### 1. 文件加載優化

- **流式處理**: 使用 Blob 和 ArrayBuffer，避免內存溢出
- **按需加載**: 只在需要時下載文件
- **緩存策略**: PDF.js Worker 通過 CDN 緩存

### 2. 渲染優化

- **虛擬滾動**: Markdown 長文檔使用虛擬滾動（未來優化）
- **代碼分割**: 各 Viewer 組件獨立加載
- **Memo 優化**: 使用 `useMemo` 緩存計算結果

### 3. 狀態管理優化

- **條件渲染**: 只在需要時加載向量/圖譜數據
- **輪詢控制**: 自動停止不必要的輪詢
- **清理資源**: 組件卸載時釋放 Blob URL

### 4. 網絡優化

- **並行請求**: 向量和圖譜數據可並行請求（如果支持）
- **請求去重**: 避免重複請求相同數據
- **錯誤重試**: 網絡錯誤自動重試機制（未來優化）

---

## 未來改進方向

### 1. 功能增強

- [ ] 支持更多文件格式（PPTX、TXT、CSV 等）
- [ ] PDF 文本選擇和複製
- [ ] Excel 表格編輯（只讀模式）
- [ ] Markdown 實時編輯預覽

### 2. 性能優化

- [ ] 大文件分頁加載
- [ ] 圖片懶加載
- [ ] 虛擬滾動優化
- [ ] Service Worker 緩存

### 3. 用戶體驗

- [ ] 文件預覽縮略圖
- [ ] 全屏預覽模式
- [ ] 鍵盤快捷鍵支持
- [ ] 打印功能

### 4. 錯誤處理

- [ ] 更詳細的錯誤信息
- [ ] 自動錯誤重試
- [ ] 錯誤報告機制

---

## 附錄

### A. 文件類型判斷邏輯

```typescript
// FilePreview.tsx
const isFileTypeWithCustomViewer = (fileType: string, filename: string): boolean => {
  const lowerFilename = filename.toLowerCase();
  return (
    // PDF
    fileType === 'application/pdf' || lowerFilename.endsWith('.pdf') ||
    // DOCX/DOC
    fileType === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' ||
    fileType === 'application/msword' ||
    lowerFilename.endsWith('.docx') || lowerFilename.endsWith('.doc') ||
    // XLSX/XLS
    fileType === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
    fileType === 'application/vnd.ms-excel' ||
    lowerFilename.endsWith('.xlsx') || lowerFilename.endsWith('.xls')
  );
};
```

### B. 組件文件結構

```
ai-bot/src/components/
├── FilePreview.tsx          # 統一入口組件
├── MarkdownViewer.tsx       # Markdown 預覽
├── DOCXViewer.tsx           # DOCX 預覽
├── ExcelViewer.tsx          # Excel 預覽
├── PDFViewer.tsx            # PDF 預覽
├── MermaidRenderer.tsx      # Mermaid 圖表渲染
└── KnowledgeGraphViewer.tsx # 知識圖譜可視化
```

### C. 相關 API 文件

```
ai-bot/src/lib/
└── api.ts                    # API 客戶端（包含 downloadFile 等函數）
```

---

**文檔版本**: 1.0
**最後更新**: 2025-12-17
**維護者**: Daniel Chung
