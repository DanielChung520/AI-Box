# 檔案系統轉結構遷移 - 需求規格說明書

## 文檔資訊

- **創建日期**: 2025-12-18
- **創建人**: Daniel Chung
- **最後修改日期**: 2025-12-18
- **版本**: 1.0

## 一、功能需求

### 1.1 Ontology 管理需求

#### 1.1.1 CRUD 操作需求

**創建（Create）**

- 支援創建新的 Ontology（base/domain/major 三種類型）
- 支援創建 Ontology 時指定 tenant_id（租戶專屬）或使用 null（全局共享）
- 支援創建時指定版本號
- 支援創建時指定 metadata（名稱、描述、作者、標籤等）
- 支援創建時指定繼承關係（inherits_from）
- 支援創建時指定兼容性（compatible_domains）

**讀取（Read）**

- 支援根據 ID 查詢單個 Ontology
- 支援根據 tenant_id 查詢租戶專屬 Ontology
- 支援查詢全局共享 Ontology（tenant_id 為 null）
- 支援根據類型（type）查詢（base/domain/major）
- 支援根據名稱（name）查詢
- 支援列表查詢（支援分頁、排序、過濾）
- 支援多租戶優先級查詢邏輯（租戶專屬 > 全局共享）
- 支援合併查詢（根據選擇的 domain 和 major，合併為完整的 Ontology 規則）

**更新（Update）**

- 支援更新 Ontology 內容
- 支援更新 metadata
- 支援版本更新（創建新版本，保留舊版本）
- 支援更新繼承關係和兼容性
- 支援更新時記錄變更日誌

**刪除（Delete）**

- 支援刪除 Ontology（軟刪除或硬刪除）
- 支援刪除前檢查依賴關係
- 支援批量刪除

#### 1.1.2 版本控制需求

**版本管理**

- 每個 Ontology 支援多個版本
- 版本號格式：語義化版本（semantic versioning，如 1.0.0）
- 支援標記默認版本（default_version）
- 支援版本比較和差異分析
- 支援版本回滾功能

**版本查詢**

- 支援查詢所有版本列表
- 支援查詢特定版本
- 支援查詢最新版本
- 支援查詢默認版本

#### 1.1.3 查詢需求

**基本查詢**

- 支援根據 ID、名稱、類型、tenant_id 查詢
- 支援模糊搜索（名稱、描述、標籤）
- 支援組合查詢（多條件組合）

**高級查詢**

- 支援根據關鍵字查詢（用於 OntologySelector）
- 支援根據文檔類型查詢（用於 OntologySelector）
- 支援自動選擇查詢（綜合多種方法）
- 支援兼容性查詢（查詢與指定 domain 兼容的 major）

**性能需求**

- 單個 Ontology 查詢回應時間 < 50ms（P95）
- 列表查詢（100 條）回應時間 < 200ms（P95）
- 合併查詢（base + domain + major）回應時間 < 300ms（P95）

### 1.2 Config 管理需求

#### 1.2.1 多層級配置需求

**System 層配置**

- 支援系統級全局配置（tenant_id 為 null）
- 配置範圍包括：
  - GenAI Policy（allowed_providers, allowed_models, default_fallback）
  - GenAI Model Registry（可用模型列表）
  - 其他系統配置
- 支援配置的啟用/禁用（is_active）
- 支援配置的 scope 分類（genai.policy, genai.model_registry 等）

**Tenant 層配置**

- 支援租戶專屬配置（tenant_id 指定）
- 配置類型與 System 層相同
- 支援配置繼承（繼承 System 層配置）
- 支援配置收斂（只能縮小權限，不能擴權）

**User 層配置**

- 支援用戶專屬配置（tenant_id + user_id 組合）
- 主要用於 API Keys 管理（已實現）
- 未來可擴展到其他用戶級配置

#### 1.2.2 配置合併邏輯需求

**合併優先級**

- 優先級順序：User > Tenant > System
- User 層配置優先級最高
- Tenant 層配置只能收斂（不擴權）
- System 層配置為基礎

**合併規則**

- **allowed_providers**: 交集運算（Tenant 只能是 System 的子集）
- **allowed_models**: 每個 provider 的模式列表交集（Tenant 只能是 System 的子集）
- **default_fallback**: Tenant/User 可以覆蓋 System 的默認值
- **model_registry_models**: Tenant 可以添加額外的模型（需符合 provider allowlist）

**配置收斂檢查**

- Tenant 配置必須是 System 配置的子集（不能擴權）
- 自動過濾不符合收斂規則的配置項
- 記錄配置合併日誌

**有效配置（Effective Config）**

- 提供 `get_effective_config()` 方法
- 自動合併三層配置
- 返回最終有效配置

### 1.3 多租戶隔離需求

#### 1.3.1 數據隔離需求

**租戶數據隔離**

- 每個租戶只能訪問自己的數據
- 使用 `tenant_id` 作為隔離鍵
- 查詢時自動過濾 `tenant_id`
- 禁止跨租戶數據訪問

**全局共享數據**

- 支援全局共享 Ontology（tenant_id 為 null）
- 所有租戶可以訪問全局共享數據
- 租戶專屬數據優先於全局共享數據

**用戶數據隔離**

- 用戶級配置使用 `tenant_id + user_id` 組合作為隔離鍵
- 用戶只能訪問自己租戶內的數據
- 禁止跨用戶數據訪問

#### 1.3.2 權限控制需求

**存取控制**

- 支援基於角色的存取控制（RBAC）
- 支援基於租戶的存取控制
- 支援配置級別的權限控制

**操作權限**

- 讀取權限：所有租戶用戶可以讀取自己的數據和全局共享數據
- 創建權限：租戶管理員可以創建租戶專屬 Ontology/Config
- 更新權限：租戶管理員可以更新自己的租戶數據
- 刪除權限：租戶管理員可以刪除自己的租戶數據（需檢查依賴）

**權限驗證**

- 所有操作前進行權限驗證
- 記錄權限驗證日誌
- 拒絕未授權訪問並返回錯誤

## 二、非功能需求

### 2.1 性能需求

**API 回應時間**

- Ontology CRUD API: < 200ms（P95）
- Config CRUD API: < 200ms（P95）
- 配置合併查詢: < 300ms（P95）
- 列表查詢（100 條）: < 500ms（P95）

**查詢效率**

- 支援索引優化（tenant_id, type, name, version）
- 支援查詢結果快取（可選）
- 支援批量查詢優化

**數據庫性能**

- ArangoDB 查詢優化
- 索引策略優化
- 連接池管理

### 2.2 安全需求

**數據加密**

- 敏感配置數據加密存儲（如 API Keys）
- 使用現有的 `GenAISecretEncryptionService`
- 加密密鑰管理（環境變數）

**存取控制**

- 所有 API 端點需要認證
- 支援 JWT Token 認證
- 支援 API Key 認證
- 支援基於角色的權限控制

**數據驗證**

- 輸入數據驗證（Pydantic models）
- JSON Schema 驗證
- 防止 SQL 注入（AQL 參數化查詢）
- 防止路徑遍歷攻擊

**審計日誌**

- 記錄所有 CRUD 操作
- 記錄權限驗證結果
- 記錄配置合併過程
- 支援審計日誌查詢和導出

### 2.3 合規需求

**審計追蹤**

- 所有操作記錄審計日誌
- 審計日誌包含：操作類型、操作者、操作時間、操作內容、操作結果
- 審計日誌不可篡改
- 支援審計日誌查詢和報告生成

**數據保留**

- 定義數據保留政策
- 支援數據保留檢查
- 支援數據自動清理（可選）
- 支援數據備份和恢復

**合規標準**

- 符合 ISO/IEC 42001 要求
- 符合 AIGP 最佳實踐
- 符合 AAIA 稽核框架
- 符合 AAISM 安全管理

## 三、技術需求

### 3.1 數據存儲需求

**ArangoDB Schema**

- Collections: `ontologies`, `system_configs`, `tenant_configs`, `user_configs`
- 索引策略：tenant_id, type, name, version, is_active, scope
- 數據驗證規則：必填欄位、數據類型、格式驗證

**數據遷移**

- 支援從文件系統遷移到 ArangoDB
- 支援數據驗證和完整性檢查
- 支援遷移回滾機制
- 支援遷移進度追蹤

### 3.2 API 需求

**RESTful API**

- 遵循 REST 規範
- 使用 FastAPI 框架
- API 版本控制（/api/v1/...）
- OpenAPI 文檔生成

**API 端點**

- Ontology CRUD API
- Config CRUD API
- 配置合併查詢 API
- 審計日誌查詢 API

### 3.3 服務架構需求

**服務層級**

- Store Service 層（數據訪問層）
- Business Service 層（業務邏輯層）
- API Router 層（API 端點層）

**依賴關係**

- OntologyStoreService → ArangoDB
- ConfigStoreService → ArangoDB
- 現有服務使用 Store Services（不再直接讀取文件）

## 四、遷移需求

### 4.1 數據遷移需求

**Ontology 遷移**

- 遷移 7 個 JSON 文件到 ArangoDB
- 保持數據結構和依賴關係
- 設置 tenant_id 為 null（全局共享）
- 遷移 metadata（名稱、版本、描述等）

**Config 遷移**

- 遷移 System 層配置到 ArangoDB
- 遷移 genai.policy 配置
- 遷移 genai.model_registry 配置
- 保持配置結構和合併邏輯

### 4.2 服務遷移需求

**服務更新**

- 更新 OntologyManager 使用 OntologyStoreService
- 更新 OntologySelector 使用 OntologyStoreService
- 更新 GenAIConfigResolverService 使用 ConfigStoreService
- 更新 GenAIModelRegistryService 使用 ConfigStoreService

**向後兼容**

- 保留文件系統作為備份
- 支援雙寫機制（可選）
- 提供回滾機制

### 4.3 測試需求

**功能測試**

- 單元測試（覆蓋率 ≥ 80%）
- 整合測試
- E2E 測試

**性能測試**

- API 性能測試
- 數據庫性能測試
- 負載測試

**安全測試**

- 租戶隔離測試
- 存取控制測試
- 安全漏洞測試

## 五、驗收標準

### 5.1 功能驗收標準

- ✅ 所有 Ontology CRUD 操作正常
- ✅ 所有 Config CRUD 操作正常
- ✅ 配置合併邏輯正確
- ✅ 多租戶隔離功能正常
- ✅ 版本控制功能正常

### 5.2 性能驗收標準

- ✅ API 回應時間符合要求
- ✅ 數據庫查詢性能達標
- ✅ 系統資源使用正常

### 5.3 安全驗收標準

- ✅ 通過安全測試
- ✅ 通過合規審查
- ✅ 審計日誌完整

---

**文檔完成日期**: 2025-12-18
