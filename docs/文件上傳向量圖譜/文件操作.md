# 文件操作功能說明

**創建日期**: 2025-01-27
**創建人**: Daniel Chung
**最後修改日期**: 2025-01-27

## 目錄

1. [概述](#概述)
2. [文件右鍵選單](#文件右鍵選單)
3. [資料夾右鍵選單](#資料夾右鍵選單)
4. [Header 工具欄操作](#header-工具欄操作)
5. [關鍵技術說明](#關鍵技術說明)
6. [快捷鍵列表](#快捷鍵列表)
7. [批量操作](#批量操作)
8. [數據驗證規則](#數據驗證規則)
9. [注意事項](#注意事項)
10. [更新日誌](#更新日誌)

## 概述

文件樹組件提供了完整的文件管理功能，支持通過右鍵選單對文件和資料夾進行各種操作。所有操作都遵循一般檔案管理系統的使用習慣，提供直觀的用戶體驗。

### 主要特性

- ✅ **右鍵選單操作**: 文件和資料夾都支持右鍵選單
- ✅ **視覺反饋**: 文件項目和選單項都有 hover 效果
- ✅ **Focus 狀態**: 點擊文件後會顯示 focus 狀態
- ✅ **主題適配**: 支持深色/淺色模式
- ✅ **流暢動畫**: 所有交互都有平滑的過渡效果

---

## 文件右鍵選單

在文件項目上點擊右鍵，會顯示以下選單項：

### 基本操作

#### 1. 重新命名

- **圖標**: `fa-pen`
- **功能**: 重新命名文件
- **實現狀態**: ⏸️ 待實現
- **描述**: 允許用戶修改文件名，支持文件名驗證（避免特殊字符、路徑分隔符等）

#### 2. 移動目錄

- **圖標**: `fa-folder-open`
- **功能**: 將文件移動到其他資料夾
- **實現狀態**: ⏸️ 待實現
- **描述**: 打開資料夾選擇對話框，允許用戶選擇目標資料夾，移動文件並更新相關的任務關聯

#### 3. 刪除文件

- **圖標**: `fa-trash`
- **功能**: 刪除文件
- **實現狀態**: ⏸️ 待實現
- **描述**: 刪除文件前顯示確認對話框，刪除後同時清理：
  - 文件實體（從文件系統）
  - 文件元數據（從 ArangoDB）
  - 向量數據（從 ChromaDB）
  - 知識圖譜關聯（從 ArangoDB）

#### 4. 複製

- **圖標**: `fa-copy`
- **功能**: 複製文件
- **實現狀態**: ⏸️ 待實現
- **描述**: 複製文件到剪貼板，支持在資料夾中貼上。複製操作會創建文件的副本，包括文件內容和元數據

#### 5. 複製路徑

- **圖標**: `fa-link`
- **功能**: 複製文件路徑到剪貼板
- **實現狀態**: ⏸️ 待實現
- **描述**: 複製文件的完整路徑（包括任務ID和文件ID），方便在其他地方引用

#### 6. 剪下

- **圖標**: `fa-cut`
- **功能**: 剪下文件（準備移動）
- **實現狀態**: ⏸️ 待實現
- **描述**: 將文件標記為「剪下」狀態，在目標資料夾使用「貼上」時會移動文件而不是複製

#### 7. 貼上

- **圖標**: `fa-paste`
- **功能**: 貼上已剪下或複製的文件
- **實現狀態**: ⏸️ 待實現
- **描述**: 在當前資料夾中貼上已剪下或複製的文件。如果是剪下操作，會移動文件；如果是複製操作，會創建副本

---

### AI 相關操作

#### 8. 標註到AI任務指令區

- **圖標**: `fa-paperclip`
- **功能**: 將文件附加到AI聊天輸入框
- **實現狀態**: ⏸️ 待實現
- **描述**: 類似 Cursor 的 "Attach to Chat" 功能，將文件引用添加到AI任務指令區，讓AI能夠訪問文件內容進行分析和回答

#### 9. 查看向量資料

- **圖標**: `fa-database`
- **功能**: 查看文件的向量化數據
- **實現狀態**: ⏸️ 待實現
- **描述**: 顯示文件在 ChromaDB 中的向量數據，包括：
  - 文本塊（chunks）
  - 嵌入向量（embeddings）
  - 元數據（metadata）
  - 相似度搜索結果

#### 10. 查看圖譜資料

- **圖標**: `fa-project-diagram`
- **功能**: 查看文件的知識圖譜數據
- **實現狀態**: ⏸️ 待實現
- **描述**: 顯示文件在 ArangoDB 中的知識圖譜數據，包括：
  - 實體（Entities）
  - 關係（Relations）
  - 三元組（Triples）
  - 圖譜可視化

#### 11. 查看文件信息

- **圖標**: `fa-info-circle`
- **功能**: 查看文件的詳細信息
- **實現狀態**: ✅ 已實現
- **描述**: 顯示文件的詳細信息對話框，包括：

---

## 資料夾右鍵選單

在資料夾（任務節點）上點擊右鍵，會顯示以下選單項：

### 新建操作

#### 1. 新增資料夾

- **圖標**: `fa-folder-plus`
- **功能**: 創建新的資料夾
- **實現狀態**: ⏸️ 待實現
- **描述**: 在當前資料夾下創建新的子資料夾（任務），允許用戶輸入資料夾名稱，創建後會生成新的任務ID。此操作與 Header 工具欄的「新增資料夾」功能不同：Header 工具欄的新增資料夾會根據當前聚焦狀態決定位置，而右鍵選單的新增資料夾則明確在當前資料夾下創建。

#### 2. 新增檔案

- **圖標**: `fa-file-plus`
- **功能**: 上傳新文件到當前資料夾
- **實現狀態**: ⏸️ 待實現
- **描述**: 打開文件上傳對話框，允許用戶選擇文件上傳到當前資料夾（任務），上傳後會自動進行處理（分塊、向量化、KG提取）。此操作與 Header 工具欄的「新增檔案」功能不同：Header 工具欄的新增檔案會根據當前聚焦狀態決定上傳位置，而右鍵選單的新增檔案則明確上傳到當前資料夾。

---

## Header 工具欄操作

在右側文件瀏覽區域的 header 工具欄中，提供了以下快捷操作按鈕：

### 1. 新增資料夾

- **圖標**: `fa-folder-plus`
- **位置**: Header 工具欄最左側
- **功能**: 創建新的資料夾（任務）
- **實現狀態**: ✅ 已實現（UI），⏸️ 待實現（功能邏輯）
- **行為邏輯**:
  - 若鼠標 focus 在資料夾上，點擊新增資料夾則在該資料夾下新增資料夾
  - 若沒有任何 focus，則在與「暫存工作區」同級目錄新增
- **描述**:
  - 根據當前聚焦狀態決定新增位置
  - 如果用戶點擊了某個資料夾，該資料夾會被標記為「聚焦」狀態
  - 新增的資料夾會作為任務創建，並生成新的任務ID
  - 創建後會自動更新文件樹顯示

### 2. 新增檔案

- **圖標**: `fa-file-plus`（文件圖標 + 加號）
- **位置**: Header 工具欄，新增資料夾按鈕右側
- **功能**: 上傳新文件
- **實現狀態**: ✅ 已實現（UI），⏸️ 待實現（功能邏輯）
- **行為邏輯**:
  - 若鼠標 focus 在資料夾上，點擊新增檔案則在該資料夾下新增檔案
  - 若沒有任何 focus，則在「暫存工作區」新增檔案
- **描述**:
  - 根據當前聚焦狀態決定上傳位置
  - 打開文件上傳對話框，允許用戶選擇文件
  - 上傳後會自動進行處理（分塊、向量化、KG提取）
  - 上傳成功後會更新文件樹顯示

### 3. 搜尋檔案

- **圖標**: `fa-magnifying-glass`
- **位置**: Header 工具欄，新增檔案按鈕右側（中間位置）
- **功能**: 搜尋檔案和文件內容
- **實現狀態**: ✅ 已實現
- **描述**:
  - 仿照 Cursor 的文件搜尋功能
  - 點擊後打開搜尋對話框
  - 支持搜尋檔名和文件內容
  - 顯示搜尋結果列表，支持鍵盤導航（↑↓ 選擇，Enter 打開，Esc 關閉）
  - 支持快捷鍵：`Cmd/Ctrl + P`（待實現）
  - 搜尋結果會標記匹配類型（檔名/內容）
  - 點擊搜尋結果會打開對應文件

### 4. 其他選項

- **圖標**: `fa-ellipsis`（三點圖標）
- **位置**: Header 工具欄最右側
- **功能**: 顯示更多操作選單
- **實現狀態**: ✅ 已實現（UI），⏸️ 待實現（功能邏輯）
- **下拉選單項**:
  - **從文件庫上傳**: 從文件庫選擇文件上傳到當前任務
  - **傳回文件庫**: 將當前任務的文件傳回文件庫
  - **同步文件**: 同步文件狀態和元數據
  - **搜尋文件庫**: 在文件庫中搜尋文件
- **描述**:
  - 點擊後顯示下拉選單
  - 目前所有選單項都為空動作（待實現）
  - 點擊外部區域或再次點擊按鈕可關閉選單

### 聚焦狀態管理

- **資料夾聚焦**: 當用戶點擊資料夾時，該資料夾會被標記為「聚焦」狀態
- **聚焦清除**: 當用戶點擊其他區域或文件時，聚焦狀態會被清除
- **默認聚焦**: 如果沒有明確的聚焦狀態，操作會默認在「暫存工作區」執行

---

## 關鍵技術說明

### 錯誤處理

所有文件操作都應該包含完善的錯誤處理機制：

#### 網絡錯誤處理

- **網絡連接失敗**: 顯示友好的錯誤提示，建議用戶檢查網絡連接
- **請求超時**: 顯示超時提示，提供重試選項
- **服務器錯誤**: 顯示服務器錯誤信息，記錄錯誤日誌

#### 文件操作錯誤處理

- **文件上傳失敗**:
  - 顯示具體的失敗原因（文件過大、格式不支持等）
  - 提供重試選項
  - 記錄失敗的文件信息
- **文件刪除失敗**:
  - 顯示失敗原因（文件被鎖定、權限不足等）
  - 提供解決建議
- **文件移動失敗**:
  - 顯示失敗原因（目標位置不存在、權限不足等）
  - 回滾操作，恢復原位置

#### 用戶提示

- **成功操作**: 顯示成功提示（Toast 通知），持續時間 3 秒
- **失敗操作**: 顯示錯誤提示，包含錯誤原因和解決建議
- **進行中操作**: 顯示進度條或載入動畫

### 權限檢查

所有文件操作都需要進行權限檢查：

#### 權限類型

- **文件讀取權限**: 查看文件、預覽文件、下載文件
- **文件寫入權限**: 上傳文件、修改文件、重新命名文件
- **文件刪除權限**: 刪除文件
- **資料夾創建權限**: 創建新資料夾（任務）
- **資料夾管理權限**: 刪除資料夾、移動資料夾

#### 權限檢查時機

- **操作前檢查**: 在執行操作前檢查用戶權限
- **實時驗證**: 對於長時間操作，定期驗證權限
- **服務器端驗證**: 前端檢查僅用於 UI 顯示，實際權限驗證在服務器端進行

#### 權限不足處理

- **隱藏操作**: 如果用戶沒有權限，隱藏對應的操作按鈕或選單項
- **禁用操作**: 如果操作按鈕可見但無權限，禁用按鈕並顯示提示
- **錯誤提示**: 如果用戶嘗試執行無權限的操作，顯示友好的錯誤提示

### 事務處理

對於涉及多個數據源的操作，需要保證事務一致性：

#### 多數據源操作

以下操作涉及多個數據源，需要事務處理：

- **文件刪除**: 文件系統 + ArangoDB（元數據）+ ChromaDB（向量數據）+ ArangoDB（知識圖譜）
- **資料夾刪除**: 文件系統 + ArangoDB（元數據）+ ChromaDB（向量數據）+ ArangoDB（知識圖譜）+ 任務記錄
- **文件移動**: ArangoDB（更新元數據中的 task_id）

#### 事務處理策略

- **原子性**: 所有數據源的操作要麼全部成功，要麼全部失敗
- **回滾機制**: 如果任何一個數據源操作失敗，回滾所有已執行的操作
- **補償操作**: 對於無法回滾的操作，執行補償操作恢復狀態

#### 數據一致性保證

- **最終一致性**: 對於異步操作，保證最終數據一致性
- **狀態同步**: 定期同步各數據源的狀態
- **衝突解決**: 當數據衝突時，優先使用最新的數據

### 操作反饋

所有操作都應該提供明確的用戶反饋：

#### 載入狀態

- **文件上傳**: 顯示上傳進度條，包含文件大小和上傳速度
- **文件處理**: 顯示處理進度（分塊、向量化、KG提取），包含當前階段和預計剩餘時間
- **文件列表載入**: 顯示載入動畫和「載入中...」提示

#### 成功反饋

- **Toast 通知**: 操作成功後顯示 Toast 通知，包含操作類型和成功信息
- **視覺更新**: 立即更新 UI，反映操作結果
- **音效提示**: （可選）播放成功音效

#### 失敗反饋

- **錯誤對話框**: 顯示錯誤對話框，包含錯誤原因和解決建議
- **錯誤日誌**: 記錄詳細的錯誤日誌，便於排查問題
- **重試選項**: 提供重試按鈕，允許用戶重新嘗試操作

---

## 快捷鍵列表

### 全局快捷鍵

- `Cmd/Ctrl + P`: 打開搜尋檔案對話框
- `Esc`: 關閉當前對話框或取消操作

### 文件操作快捷鍵

- `F2`: 重新命名選中的文件或資料夾
- `Delete`: 刪除選中的文件或資料夾（需要確認）
- `Cmd/Ctrl + C`: 複製選中的文件或資料夾
- `Cmd/Ctrl + X`: 剪下選中的文件或資料夾
- `Cmd/Ctrl + V`: 貼上已複製或剪下的文件或資料夾
- `Cmd/Ctrl + A`: 全選當前資料夾中的所有文件（待實現）

### 文件瀏覽快捷鍵

- `↑/↓`: 在文件列表中上下移動選擇
- `Enter`: 打開選中的文件或展開/折疊資料夾
- `←`: 折疊當前資料夾
- `→`: 展開當前資料夾

### 搜尋快捷鍵

- `Cmd/Ctrl + F`: 在當前視圖中搜尋（待實現）
- `Cmd/Ctrl + P`: 打開全局文件搜尋

---

## 批量操作

### 批量選擇

- **單個選擇**: 點擊文件或資料夾進行選擇
- **多個選擇**: `Ctrl/Cmd + 點擊` 選擇多個項目
- **範圍選擇**: `Shift + 點擊` 選擇範圍內的所有項目
- **全選**: `Cmd/Ctrl + A` 選擇當前資料夾中的所有文件（待實現）

### 批量操作功能

- **批量刪除**: 選擇多個文件或資料夾後，點擊刪除按鈕或按 `Delete` 鍵
- **批量移動**: 選擇多個文件或資料夾後，使用「移動目錄」功能
- **批量複製**: 選擇多個文件或資料夾後，使用「複製」功能
- **批量下載**: 選擇多個文件後，使用下載功能（待實現）

### 批量操作限制

- **最大選擇數量**: 單次最多選擇 100 個項目
- **操作確認**: 批量操作前需要確認對話框
- **進度顯示**: 批量操作時顯示進度條和當前處理的項目

---

## 數據驗證規則

### 文件名規則

- **長度限制**: 文件名長度不超過 255 個字符
- **字符限制**: 不能包含以下字符：`/ \ : * ? " < > |`
- **保留名稱**: 不能使用系統保留名稱（如 `CON`, `PRN`, `AUX` 等）
- **擴展名**: 必須包含有效的文件擴展名

### 資料夾名稱規則

- **長度限制**: 資料夾名稱長度不超過 255 個字符
- **字符限制**: 不能包含以下字符：`/ \ : * ? " < > |`
- **唯一性**: 同一父資料夾下不能有重名的資料夾

### 文件大小限制

- **單個文件**: 最大 100MB
- **批量上傳**: 單次上傳總大小不超過 500MB
- **文件數量**: 單次上傳最多 50 個文件

### 文件類型限制

- **支持的文件類型**:
  - 文檔: `.md`, `.txt`, `.doc`, `.docx`, `.pdf`, `.rtf`
  - 表格: `.xls`, `.xlsx`, `.csv`
  - 圖片: `.jpg`, `.jpeg`, `.png`, `.gif`, `.bmp`, `.svg`
  - 代碼: `.py`, `.js`, `.ts`, `.java`, `.cpp`, `.c`, `.h`, `.html`, `.css`, `.json`, `.xml`
- **不支持的文件類型**: 可執行文件（`.exe`, `.bat`, `.sh` 等）

---

## 注意事項

1. **數據一致性**: 所有刪除操作都需要確保清理所有相關數據（文件系統、數據庫、向量庫、圖譜庫）
2. **權限檢查**: 實現功能時需要檢查用戶權限
3. **錯誤處理**: 所有操作都需要適當的錯誤處理和用戶提示
4. **確認對話框**: 危險操作（刪除）必須顯示確認對話框
5. **事務處理**: 涉及多個數據源的操作需要使用事務確保一致性
6. **用戶體驗**: 所有操作都應該提供明確的反饋和載入狀態
7. **性能優化**: 對於大量文件的操作，需要考慮性能優化（分批處理、異步操作）

---

## 更新日誌

### 2025-12-07

- ✅ 創建文件操作功能說明文檔
- ✅ 總結所有文件夾和文件選單操作
- ✅ 添加功能描述和實現狀態
- ✅ 添加交互效果說明
- ✅ 添加技術實現細節
- ✅ 添加 Header 工具欄操作說明
- ✅ 修復文檔結構問題
- ✅ 統一邏輯描述
- ✅ 添加關鍵技術說明（錯誤處理、權限檢查、事務處理）
- ✅ 添加快捷鍵完整列表
- ✅ 添加批量操作說明
- ✅ 添加數據驗證規則說明

---
