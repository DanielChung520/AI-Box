# 圖譜標簽化測試最終報告

**創建日期**: 2025-12-10  
**創建人**: Daniel Chung  
**最後修改日期**: 2025-12-10

## 執行摘要

本報告總結了圖譜標簽化功能的配置修改、測試結果和問題分析。

---

## 一、配置修改總結

### 1.1 .env文件修改

**修改內容**:
- `OLLAMA_REMOTE_HOST=localhost`（從 `olm.k84.org` 修改）
- `OLLAMA_REMOTE_PORT=11434`
- `OLLAMA_DEFAULT_MODEL=llama3.1:8b`
- `OLLAMA_NER_MODEL=llama3.1:8b`
- `OLLAMA_TIMEOUT_SECONDS=300`

**原因**: 
- `olm.k84.org` 可能指向11434端口，導致連接超時
- 使用localhost可以確保連接到本地Ollama服務

### 1.2 config.json修改

**修改內容**:
- `text_analysis.ner.model_name=llama3.1:8b`
- `services.ollama.host=localhost`
- `services.ollama.port=11434`
- `services.ollama.request_timeout=300`
- `services.ollama.default_model=llama3.1:8b`

### 1.3 代碼修改

**修改文件**:
1. `genai/api/services/ner_service.py`
   - 支持從環境變量 `OLLAMA_NER_MODEL` 讀取模型
   - 改進prompt，要求嚴格的JSON格式
   - 改進JSON解析邏輯，支持 `{"entities": [...]}` 格式

2. `genai/api/services/re_service.py`
   - 支持從環境變量讀取模型（使用 `OLLAMA_NER_MODEL` 或 `OLLAMA_RE_MODEL`）
   - 默認值改為 `llama3.1:8b`

3. `genai/api/services/rt_service.py`
   - 支持從環境變量讀取模型（使用 `OLLAMA_NER_MODEL` 或 `OLLAMA_RT_MODEL`）
   - 默認值改為 `llama3.1:8b`

---

## 二、測試結果

### 2.1 Ollama連接測試

**結果**: ✅ **成功**

- Ollama服務在 `localhost:11434` 可訪問
- 可以獲取模型列表
- 模型生成請求不再超時

### 2.2 模型JSON格式測試

**gpt-oss:20b**:
- ❌ 即使使用 `format=json`，仍返回自然語言描述
- ❌ JSON解析失敗

**llama3.1:8b**:
- ✅ 可以返回有效的JSON格式
- ✅ 支持 `{"entities": [...]}` 格式
- ✅ JSON解析成功

### 2.3 圖譜提取測試

**測試文件**: `877c57a1-8ea0-47be-8616-3482fbc499f5.md` (Notion CLI使用指南)

**結果**: ⚠️ **部分成功**

- ✅ NER服務：使用llama3.1:8b，可以提取實體
- ⚠️ RE服務：之前使用qwen3-coder:30b，已修復為llama3.1:8b
- ⚠️ RT服務：之前使用qwen3-coder:30b，已修復為llama3.1:8b
- ⚠️ 圖譜數據：尚未生成（可能因為實體數量不足或RE/RT提取失敗）

---

## 三、問題分析

### 3.1 已解決的問題

1. ✅ **Ollama連接超時**
   - 原因：使用 `olm.k84.org` 導致連接問題
   - 解決：改為 `localhost`

2. ✅ **模型配置不一致**
   - 原因：代碼中硬編碼默認值 `qwen3-coder:30b`
   - 解決：支持從環境變量讀取，默認值改為 `llama3.1:8b`

3. ✅ **JSON格式問題**
   - 原因：gpt-oss:20b不支持format=json
   - 解決：改用llama3.1:8b，並改進JSON解析邏輯

### 3.2 當前問題

1. ⚠️ **圖譜數據尚未生成**
   - 可能原因：
     - 文件內容主要是CLI命令，不適合提取傳統實體關係
     - RE/RT服務可能仍有問題
     - 實體數量不足，無法構建關係

2. ⚠️ **Redis服務未啟動**
   - 影響：無法更新處理狀態
   - 解決方案：啟動Redis容器

---

## 四、配置總結

### 4.1 當前配置

**Ollama服務**:
- Host: `localhost`
- Port: `11434`
- 超時: `300秒`

**模型配置**:
- NER模型: `llama3.1:8b`
- RE模型: `llama3.1:8b`（從環境變量讀取）
- RT模型: `llama3.1:8b`（從環境變量讀取）
- 默認模型: `llama3.1:8b`

### 4.2 環境變量優先級

1. `OLLAMA_NER_MODEL` - NER模型（RE/RT也會使用）
2. `OLLAMA_RE_MODEL` - RE模型（如果設置）
3. `OLLAMA_RT_MODEL` - RT模型（如果設置）
4. `config.json` 中的配置
5. 代碼默認值（`llama3.1:8b`）

---

## 五、建議

### 5.1 立即行動

1. **啟動Redis服務**:
   ```bash
   docker-compose up -d redis
   ```

2. **重新測試圖譜提取**:
   - 使用修復後的RE/RT服務
   - 確保所有服務都使用llama3.1:8b

3. **測試其他文件**:
   - 使用包含更多實體關係的文件（如技術文檔、新聞文章等）
   - CLI使用指南可能不適合提取傳統實體關係

### 5.2 長期優化

1. **模型選擇**:
   - 考慮為不同類型的文件使用不同的模型
   - 技術文檔：可能需要專門的模型

2. **Prompt優化**:
   - 針對不同文件類型優化prompt
   - 技術文檔：提取工具、命令、功能等實體

3. **錯誤處理**:
   - 改進JSON解析錯誤處理
   - 提供更詳細的錯誤信息

---

## 六、測試命令

```bash
# 1. 啟動Redis
docker-compose up -d redis

# 2. 重啟API服務
pkill -f "uvicorn api.main"
# 然後重新啟動

# 3. 測試圖譜提取
curl -X POST http://localhost:8000/api/v1/files/{file_id}/regenerate \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{"type": "graph"}'

# 4. 查詢圖譜數據
curl http://localhost:8000/api/v1/files/{file_id}/graph \
  -H "Authorization: Bearer {token}"
```

---

**報告結束**
