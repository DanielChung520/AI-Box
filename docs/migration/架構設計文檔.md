# 檔案系統轉結構遷移 - 架構設計文檔

## 文檔資訊

- **創建日期**: 2025-12-18
- **創建人**: Daniel Chung
- **最後修改日期**: 2025-12-18
- **版本**: 1.0

## 一、數據模型設計

### 1.1 Ontology 數據模型

#### 1.1.1 Collection: `ontologies`

**Document 結構**:
```json
{
  "_key": "ontology_id",              // 主鍵，格式：{type}-{name}-{version} 或 UUID
  "_id": "ontologies/ontology_id",
  "tenant_id": "tenant_123" | null,   // null 表示全局共享
  "type": "base" | "domain" | "major", // Ontology 類型
  "name": "5W1H_Base_Ontology_OWL",   // Ontology 名稱
  "version": "3.0",                    // 版本號（語義化版本）
  "default_version": true,             // 是否為默認版本
  "ontology_name": "5W1H_Base_Ontology_OWL", // 完整名稱
  "description": "...",                // 描述
  "author": "Daniel Chung",            // 作者
  "last_modified": "2025-12-10",       // 最後修改日期
  "inherits_from": ["5W1H_Base_Ontology_OWL"], // 繼承的 Ontology 名稱列表
  "compatible_domains": ["domain-enterprise.json"], // 兼容的 domain（僅 major 類型）
  "tags": ["基礎", "5W1H", "通用"],    // 標籤列表
  "use_cases": [...],                  // 使用場景列表
  "entity_classes": [...],             // 實體類別列表
  "object_properties": [...],          // 物件屬性列表
  "metadata": {...},                   // 其他元數據
  "is_active": true,                   // 是否啟用
  "created_at": "2025-12-18T10:00:00Z",
  "updated_at": "2025-12-18T10:00:00Z",
  "created_by": "user_id",
  "updated_by": "user_id"
}
```

**索引策略**:
- **主鍵索引**: `_key`（自動）
- **複合索引 1**: `["tenant_id", "type", "name"]` - 用於租戶查詢和類型過濾
- **複合索引 2**: `["tenant_id", "type", "name", "version"]` - 用於版本查詢
- **複合索引 3**: `["type", "name", "default_version"]` - 用於全局共享查詢
- **單列索引**: `["is_active"]` - 用於過濾啟用狀態

**查詢模式**:
1. 根據 tenant_id + type + name 查詢（租戶專屬或全局共享）
2. 根據 tenant_id + type 列表查詢
3. 根據 name 模糊搜索
4. 根據 tags 查詢

#### 1.1.2 版本控制設計

**版本存儲策略**:
- 每個版本作為獨立的 document
- `_key` 格式：`{type}-{name}-{version}` 或 `{type}-{name}-{version}-{tenant_id}`
- `default_version` 標記默認版本
- 查詢時優先返回默認版本

**版本查詢邏輯**:
```python
# 查詢邏輯：
# 1. 查詢租戶專屬的指定版本
# 2. 如果不存在，查詢全局共享的指定版本
# 3. 如果未指定版本，查詢默認版本（優先租戶專屬）
```

### 1.2 Config 數據模型

#### 1.2.1 Collection: `system_configs`

**Document 結構**:
```json
{
  "_key": "scope_key",                 // 主鍵，格式：{scope} 或 {scope}_{sub_scope}
  "_id": "system_configs/scope_key",
  "tenant_id": null,                   // 始終為 null（系統層）
  "scope": "genai.policy",             // 配置範圍（如 genai.policy, genai.model_registry）
  "sub_scope": "model_registry",       // 子範圍（可選）
  "is_active": true,                   // 是否啟用
  "config_data": {                     // 配置數據（JSON 對象）
    "allowed_providers": [...],
    "allowed_models": {...},
    "default_fallback": {...},
    "models": [...]                    // model_registry 使用
  },
  "metadata": {
    "description": "...",
    "version": "1.0"
  },
  "created_at": "2025-12-18T10:00:00Z",
  "updated_at": "2025-12-18T10:00:00Z",
  "created_by": "system",
  "updated_by": "user_id"
}
```

**索引策略**:
- **主鍵索引**: `_key`（自動）
- **複合索引**: `["scope", "is_active"]` - 用於查詢啟用的系統配置

#### 1.2.2 Collection: `tenant_configs`

**Document 結構**:
```json
{
  "_key": "tenant_id_scope_key",       // 主鍵，格式：{tenant_id}_{scope}
  "_id": "tenant_configs/tenant_id_scope_key",
  "tenant_id": "tenant_123",           // 租戶 ID
  "scope": "genai.policy",             // 配置範圍（與 system_configs 對應）
  "sub_scope": "model_registry",       // 子範圍（可選）
  "is_active": true,                   // 是否啟用
  "config_data": {                     // 配置數據（JSON 對象）
    "allowed_providers": [...],        // 只能是 system 的子集
    "allowed_models": {...},           // 只能是 system 的子集
    "default_fallback": {...},         // 可以覆蓋 system
    "model_registry_models": [...]     // 可以添加額外的模型
  },
  "metadata": {
    "description": "...",
    "version": "1.0"
  },
  "created_at": "2025-12-18T10:00:00Z",
  "updated_at": "2025-12-18T10:00:00Z",
  "created_by": "user_id",
  "updated_by": "user_id"
}
```

**索引策略**:
- **主鍵索引**: `_key`（自動）
- **複合索引**: `["tenant_id", "scope", "is_active"]` - 用於查詢租戶配置

#### 1.2.3 Collection: `user_configs`（可選，未來擴展）

**Document 結構**:
```json
{
  "_key": "tenant_id_user_id_scope_key", // 主鍵
  "_id": "user_configs/tenant_id_user_id_scope_key",
  "tenant_id": "tenant_123",
  "user_id": "user_456",
  "scope": "genai.policy",
  "is_active": true,
  "config_data": {...},
  "created_at": "2025-12-18T10:00:00Z",
  "updated_at": "2025-12-18T10:00:00Z"
}
```

**索引策略**:
- **複合索引**: `["tenant_id", "user_id", "scope", "is_active"]`

### 1.3 數據驗證規則

#### 1.3.1 Ontology 驗證規則

**必填欄位**:
- `type`, `name`, `version`, `entity_classes`, `object_properties`

**數據類型驗證**:
- `type`: 必須是 "base" | "domain" | "major"
- `version`: 必須符合語義化版本格式
- `entity_classes`: 必須是數組，每個元素包含 `name` 和 `description`
- `object_properties`: 必須是數組，每個元素包含 `name`, `domain`, `range`

**業務規則驗證**:
- `inherits_from`: 必須引用已存在的 Ontology
- `compatible_domains`: 僅 major 類型可以使用
- `tenant_id`: 如果為 null，必須是全局共享的（type 為 base 或 domain）

#### 1.3.2 Config 驗證規則

**必填欄位**:
- `scope`, `config_data`, `is_active`

**數據類型驗證**:
- `scope`: 必須是預定義的範圍（genai.policy, genai.model_registry 等）
- `config_data`: 必須是 JSON 對象
- `tenant_id`: 對於 tenant_configs，不能為 null

**業務規則驗證**:
- `tenant_configs.config_data`: 必須符合配置收斂規則（不能擴權）
- `is_active`: 只能有一個啟用的配置（per tenant_id + scope）

## 二、服務架構設計

### 2.1 OntologyStoreService 架構

**類結構**:
```python
class OntologyStoreService:
    """Ontology 存儲服務"""

    def __init__(self, client: ArangoDBClient):
        self._client = client
        self._collection = ArangoCollection(...)

    # CRUD 操作
    def save_ontology(self, ontology: OntologyModel, tenant_id: Optional[str] = None) -> str:
        """保存 Ontology（創建或更新）"""

    def get_ontology(self, ontology_id: str, tenant_id: Optional[str] = None) -> Optional[OntologyModel]:
        """獲取 Ontology（支援多租戶優先級）"""

    def list_ontologies(self, tenant_id: Optional[str] = None, filters: Dict = None) -> List[OntologyModel]:
        """列表查詢 Ontology"""

    def update_ontology(self, ontology_id: str, updates: Dict, tenant_id: Optional[str] = None) -> OntologyModel:
        """更新 Ontology"""

    def delete_ontology(self, ontology_id: str, tenant_id: Optional[str] = None, soft_delete: bool = True) -> bool:
        """刪除 Ontology"""

    # 多租戶支援
    def get_ontology_with_priority(self, name: str, type: str, tenant_id: Optional[str] = None) -> Optional[OntologyModel]:
        """根據優先級查詢（租戶專屬 > 全局共享）"""

    # 版本控制
    def get_ontology_version(self, name: str, version: str, tenant_id: Optional[str] = None) -> Optional[OntologyModel]:
        """獲取指定版本"""

    def list_ontology_versions(self, name: str, tenant_id: Optional[str] = None) -> List[OntologyModel]:
        """列表查詢所有版本"""

    def set_default_version(self, name: str, version: str, tenant_id: Optional[str] = None) -> bool:
        """設置默認版本"""

    # 合併查詢
    def merge_ontologies(self, domain_files: List[str], major_file: Optional[str] = None, tenant_id: Optional[str] = None) -> Dict[str, Any]:
        """合併多個 Ontology（模擬現有的 merge_ontologies 邏輯）"""
```

### 2.2 ConfigStoreService 架構

**類結構**:
```python
class ConfigStoreService:
    """Config 存儲服務"""

    def __init__(self, client: ArangoDBClient):
        self._client = client
        self._system_collection = ArangoCollection(...)
        self._tenant_collection = ArangoCollection(...)
        self._user_collection = ArangoCollection(...)  # 可選

    # CRUD 操作
    def save_config(self, scope: str, config_data: Dict, tenant_id: Optional[str] = None, user_id: Optional[str] = None) -> str:
        """保存配置（system/tenant/user）"""

    def get_config(self, scope: str, tenant_id: Optional[str] = None, user_id: Optional[str] = None) -> Optional[Dict]:
        """獲取單層配置"""

    def get_effective_config(self, scope: str, tenant_id: str, user_id: Optional[str] = None) -> Dict:
        """獲取有效配置（合併 system → tenant → user）"""

    def update_config(self, scope: str, updates: Dict, tenant_id: Optional[str] = None) -> Dict:
        """更新配置"""

    def delete_config(self, scope: str, tenant_id: Optional[str] = None, soft_delete: bool = True) -> bool:
        """刪除配置"""

    # 配置合併
    def _merge_configs(self, system_config: Dict, tenant_config: Optional[Dict], user_config: Optional[Dict] = None) -> Dict:
        """合併配置邏輯（實現收斂規則）"""

    def _validate_config_convergence(self, system_config: Dict, tenant_config: Dict) -> bool:
        """驗證配置收斂（tenant 不能擴權）"""
```

### 2.3 服務層級和依賴關係

```
API Router 層
    ├── /api/v1/ontologies/* (OntologyRouter)
    └── /api/v1/configs/* (ConfigRouter)
         │
         ↓
Business Service 層
    ├── OntologyService (業務邏輯)
    └── ConfigService (業務邏輯)
         │
         ↓
Store Service 層
    ├── OntologyStoreService → ArangoDB (ontologies)
    └── ConfigStoreService → ArangoDB (system_configs, tenant_configs, user_configs)
         │
         ↓
現有服務更新
    ├── OntologyManager → OntologyStoreService
    ├── OntologySelector → OntologyStoreService
    ├── GenAIConfigResolverService → ConfigStoreService
    └── GenAIModelRegistryService → ConfigStoreService
```

### 2.4 API 端點結構

**Ontology API**:
- `GET /api/v1/ontologies` - 列表查詢
- `GET /api/v1/ontologies/{id}` - 獲取單個
- `POST /api/v1/ontologies` - 創建
- `PUT /api/v1/ontologies/{id}` - 更新
- `DELETE /api/v1/ontologies/{id}` - 刪除
- `GET /api/v1/ontologies/merge` - 合併查詢

**Config API**:
- `GET /api/v1/configs/effective?scope=genai.policy&tenant_id=xxx` - 獲取有效配置
- `GET /api/v1/configs/system?scope=genai.policy` - 獲取系統配置
- `GET /api/v1/configs/tenant/{tenant_id}?scope=genai.policy` - 獲取租戶配置
- `POST /api/v1/configs` - 創建配置
- `PUT /api/v1/configs/{id}` - 更新配置

## 三、多租戶隔離設計

### 3.1 租戶隔離策略

**應用層隔離**:
- 所有查詢自動過濾 `tenant_id`
- 使用 AQL 查詢過濾條件：`FILTER doc.tenant_id == @tenant_id OR doc.tenant_id == null`
- 在服務層實現隔離邏輯，不依賴數據庫層級隔離

**隔離實現**:
```python
def _build_tenant_filter(tenant_id: Optional[str]) -> str:
    """構建租戶過濾條件"""
    if tenant_id:
        return "FILTER doc.tenant_id == @tenant_id OR doc.tenant_id == null"
    else:
        return "FILTER doc.tenant_id == null"  # 只查詢全局共享
```

### 3.2 租戶優先級邏輯

**優先級規則**:
1. **租戶專屬數據** (`tenant_id` 匹配) - 優先級最高
2. **全局共享數據** (`tenant_id == null`) - 優先級次之

**查詢邏輯**:
```python
def get_ontology_with_priority(self, name: str, type: str, tenant_id: Optional[str] = None) -> Optional[OntologyModel]:
    # 1. 先查詢租戶專屬
    if tenant_id:
        tenant_ontology = self._query_tenant_ontology(name, type, tenant_id)
        if tenant_ontology:
            return tenant_ontology

    # 2. 再查詢全局共享
    global_ontology = self._query_global_ontology(name, type)
    return global_ontology
```

### 3.3 租戶配置繼承機制

**繼承邏輯**:
- System 層配置為基礎
- Tenant 層配置繼承 System 層，但只能收斂（不能擴權）
- User 層配置繼承 Tenant 層，優先級最高

**合併順序**:
```
Effective Config = Merge(
    System Config (base),
    Tenant Config (convergence only),
    User Config (highest priority)
)
```

### 3.4 租戶數據查詢過濾機制

**查詢過濾**:
- 所有查詢自動添加 `tenant_id` 過濾條件
- 使用 AQL 參數化查詢防止注入
- 查詢結果自動過濾跨租戶數據

**實現示例**:
```python
def list_ontologies(self, tenant_id: Optional[str] = None, filters: Dict = None) -> List[OntologyModel]:
    aql = """
    FOR doc IN ontologies
        FILTER doc.tenant_id == @tenant_id OR doc.tenant_id == null
        FILTER doc.is_active == true
        // ... 其他過濾條件
        RETURN doc
    """
    bind_vars = {"tenant_id": tenant_id, **filters}
    # ...
```

## 四、安全架構設計

### 4.1 存取控制機制

**認證層**:
- JWT Token 認證
- API Key 認證
- 開發模式繞過（可配置）

**授權層**:
- 基於角色的存取控制（RBAC）
- 基於租戶的存取控制
- 操作級別權限控制

**實現方式**:
```python
@router.get("/api/v1/ontologies")
async def list_ontologies(
    current_user: User = Depends(get_current_user),
    tenant_id: str = Depends(get_tenant_id)
):
    # 自動注入 tenant_id，確保隔離
    # 權限驗證
    if not current_user.has_permission("ontology:read"):
        raise HTTPException(403, "Permission denied")
    # ...
```

### 4.2 數據加密策略

**加密範圍**:
- 敏感配置數據（API Keys）已實現加密（GenAISecretEncryptionService）
- Ontology 數據不需要加密（非敏感）
- Config 中的敏感字段需要加密

**加密實現**:
- 使用現有的 `GenAISecretEncryptionService`
- 加密密鑰存儲在環境變數中
- 數據庫存儲加密後的數據

### 4.3 審計日誌機制

**審計範圍**:
- 所有 CRUD 操作
- 權限驗證結果
- 配置合併過程
- 數據訪問記錄

**審計日誌結構**:
```json
{
  "event_type": "ontology.create" | "config.update" | "access.denied",
  "resource_type": "ontology" | "config",
  "resource_id": "...",
  "tenant_id": "...",
  "user_id": "...",
  "action": "create" | "read" | "update" | "delete",
  "timestamp": "2025-12-18T10:00:00Z",
  "details": {...},
  "result": "success" | "failed",
  "error_message": "..." // 如果失敗
}
```

**審計日誌存儲**:
- 使用現有的 `audit_log_service`
- 存儲到 ArangoDB `audit_logs` collection
- 支援查詢和導出

### 4.4 安全掃描整合點

**代碼安全掃描**:
- Bandit（Python 安全掃描）
- Safety（依賴項漏洞掃描）
- Snyk（綜合安全掃描）

**容器安全掃描**:
- Trivy（容器漏洞掃描）
- Docker Bench（容器配置檢查）

**整合點**:
- CI/CD 流程中自動執行
- 提交前檢查（pre-commit hooks）
- 定期掃描（scheduled jobs）

---

**文檔完成日期**: 2025-12-18
