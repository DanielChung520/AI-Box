# âš ï¸ AI é–‹ç™¼è¦ç¯„ - å¼·åˆ¶åŸ·è¡Œè¦å‰‡

**æœ€å¾Œæ›´æ–°æ—¥æœŸ**: 2025-12-30

---

## ğŸ”´ æœ€é«˜å„ªå…ˆç´šè¦å‰‡

### å ±å‘Šç”Ÿæˆè¦ç¯„ï¼ˆ2026-01-28 æ–°å¢ï¼‰

**é‡è¦**ï¼šé™¤éç”¨æˆ¶æ˜ç¢ºè¦æ±‚ç”Ÿæˆå ±å‘Šï¼Œå¦å‰‡**ç¦æ­¢**å‰µå»ºå ±å‘Šæ–‡ä»¶ã€‚

**è¦å‰‡**ï¼š
- âŒ **ç¦æ­¢**ä¸»å‹•å‰µå»º `.md` å ±å‘Šæ–‡ä»¶ï¼ˆé™¤éç”¨æˆ¶æ˜ç¢ºè¦æ±‚ï¼‰
- âœ… **å…è¨±**ç°¡æ½”çš„æ–‡å­—å›è¦†èªªæ˜å•é¡Œå’Œä¿®å¾©
- âœ… **å…è¨±**åœ¨ä»£ç¢¼ä¸­æ·»åŠ è¨»é‡‹èªªæ˜
- âœ… **å…è¨±**å‰µå»ºå¿…è¦çš„æ¸¬è©¦è…³æœ¬ï¼ˆç”¨æ–¼é©—è­‰ä¿®å¾©ï¼‰

**ä¾‹å¤–æƒ…æ³**ï¼ˆç”¨æˆ¶æ˜ç¢ºè¦æ±‚æ™‚ï¼‰ï¼š
- ç”¨æˆ¶æ˜ç¢ºèªªã€Œå¯«å ±å‘Šã€ã€ã€Œç”Ÿæˆå ±å‘Šã€ã€ã€Œå‰µå»ºå ±å‘Šæ–‡æª”ã€ç­‰
- ç”¨æˆ¶è¦æ±‚ã€Œè¨˜éŒ„åˆ°æ–‡æª”ã€ã€ã€Œä¿å­˜åˆ†æçµæœã€ç­‰

**é•è¦å¾Œæœ**ï¼š
- å¦‚æœé•åæ­¤è¦ç¯„å‰µå»ºäº†ä¸å¿…è¦çš„å ±å‘Šï¼Œå¿…é ˆç«‹å³åˆªé™¤

### æ¯æ¬¡ä»£ç¢¼ä¿®æ”¹å¾Œå¿…é ˆåŸ·è¡Œçš„æª¢æŸ¥æµç¨‹

1. **æ›´æ–°æ–‡ä»¶é ­è¨»é‡‹**ï¼ˆå„ªå…ˆç´šæœ€é«˜ï¼‰
   - âš ï¸ **å¿…é ˆ**ä½¿ç”¨ç€è¦½å™¨å·¥å…·è¨ªå• `https://tw.piliapp.com/time/` ç¢ºèªç•¶å‰æ—¥æœŸæ™‚é–“ï¼ˆUTC+8ï¼‰
   - âŒ **ç¦æ­¢**ä½¿ç”¨ `web_search` æˆ–å…¶ä»–æ–¹å¼ç²å–æ—¥æœŸæ™‚é–“
   - âœ… **å¿…é ˆ**ä½¿ç”¨ `mcp_cursor-browser-extension_browser_navigate` è¨ªå•æŒ‡å®šç¶²ç«™
   - âœ… **å¿…é ˆ**ä½¿ç”¨ `browser_evaluate` ç²å–é é¢ä¸Šçš„å¯¦éš›æ—¥æœŸæ™‚é–“
   - æ›´æ–°ã€Œæœ€å¾Œä¿®æ”¹æ—¥æœŸã€ç‚ºç¢ºèªçš„æ—¥æœŸæ™‚é–“
   - æ ¼å¼ï¼š`# æœ€å¾Œä¿®æ”¹æ—¥æœŸ: YYYY-MM-DD HH:MM UTC+8`

2. **ä»£ç¢¼æ ¼å¼æª¢æŸ¥**ï¼ˆå¿…é ˆå…¨éƒ¨é€šéï¼‰
   - é‹è¡Œ `black <æ–‡ä»¶>` æ ¼å¼åŒ–ä»£ç¢¼
   - é‹è¡Œ `ruff check --fix <æ–‡ä»¶>` æª¢æŸ¥ä»£ç¢¼é¢¨æ ¼
   - é‹è¡Œ `mypy <æ–‡ä»¶>` é€²è¡Œé¡å‹æª¢æŸ¥

3. **æª¢æŸ¥çµæœè™•ç†**
   - å¦‚æœä»»ä½•æª¢æŸ¥å¤±æ•—ï¼Œå¿…é ˆä¿®å¾©éŒ¯èª¤
   - ä¿®å¾©å¾Œé‡æ–°é‹è¡Œå¤±æ•—çš„æª¢æŸ¥
   - åªæœ‰æ‰€æœ‰æª¢æŸ¥é€šéå¾Œæ‰èƒ½æ¨™è¨˜ä»»å‹™å®Œæˆ

### ç¦æ­¢è¡Œç‚º

- âŒ è·³éæ–‡ä»¶é ­æ—¥æœŸæ›´æ–°
- âŒ **ç¦æ­¢**ä½¿ç”¨ `web_search` ç²å–æ—¥æœŸï¼ˆå¿…é ˆä½¿ç”¨ç€è¦½å™¨å·¥å…·è¨ªå•æŒ‡å®šç¶²ç«™ï¼‰
- âŒ **ç¦æ­¢**çŒœæ¸¬æˆ–ä½¿ç”¨è¨˜æ†¶ä¸­çš„æ—¥æœŸï¼ˆå¿…é ˆå¾ç¶²ç«™ç²å–ï¼‰
- âŒ è·³éä»£ç¢¼æ ¼å¼æª¢æŸ¥
- âŒ è·³éé¡å‹æª¢æŸ¥
- âŒ åœ¨æª¢æŸ¥å¤±æ•—æ™‚æ¨™è¨˜ä»»å‹™ç‚ºå®Œæˆ

### ğŸš¨ Docker å®¹å™¨æ“ä½œç¦æ­¢è¦ç¯„ï¼ˆ2026-01-28 æ–°å¢ï¼‰

**åš´ç¦ AI åŸ·è¡Œä»¥ä¸‹æ“ä½œï¼ˆé™¤éç”¨æˆ¶æ˜ç¢ºè¦æ±‚ä¸”å·²ç¢ºèªå‚™ä»½ï¼‰**ï¼š

1. âŒ **ç¦æ­¢åˆªé™¤ Docker å®¹å™¨**
   - `docker rm <container_name>`
   - `docker stop <container_name> && docker rm <container_name>`
   - `docker-compose down`ï¼ˆæœƒåˆªé™¤å®¹å™¨ï¼‰
   - **ä¾‹å¤–**ï¼šåƒ…åœ¨ç”¨æˆ¶æ˜ç¢ºè¦æ±‚ä¸”å·²ç¢ºèªæ•¸æ“šå·²å‚™ä»½æ™‚æ‰å¯åŸ·è¡Œ

2. âŒ **ç¦æ­¢åˆªé™¤ Docker Volumes**
   - `docker volume rm <volume_name>`
   - **ä¾‹å¤–**ï¼šåƒ…åœ¨ç”¨æˆ¶æ˜ç¢ºè¦æ±‚ä¸”å·²ç¢ºèªæ•¸æ“šå·²å‚™ä»½æ™‚æ‰å¯åŸ·è¡Œ

3. âŒ **ç¦æ­¢é‡å»ºå®¹å™¨ï¼ˆæœƒå°è‡´æ•¸æ“šä¸Ÿå¤±ï¼‰**
   - åˆªé™¤å¾Œé‡æ–°å‰µå»ºå®¹å™¨ï¼ˆé™¤éæ•¸æ“šå·²æŒä¹…åŒ–åˆ° volumeï¼‰
   - **å¿…é ˆ**ï¼šå…ˆç¢ºèªæ•¸æ“šæ˜¯å¦å·²æŒä¹…åŒ–åˆ° volume

4. âŒ **ç¦æ­¢åœæ­¢é—œéµæœå‹™å®¹å™¨ï¼ˆé™¤éç”¨æˆ¶æ˜ç¢ºè¦æ±‚ï¼‰**
   - `docker stop arangodb`
   - `docker stop seaweedfs-ai-box-filer`
   - `docker stop qdrant`
   - ç­‰é—œéµæ•¸æ“šæœå‹™å®¹å™¨

**å…è¨±çš„æ“ä½œ**ï¼š

- âœ… `docker ps` - æŸ¥çœ‹å®¹å™¨ç‹€æ…‹
- âœ… `docker logs <container>` - æŸ¥çœ‹æ—¥èªŒ
- âœ… `docker exec <container> <command>` - åŸ·è¡Œåªè®€å‘½ä»¤
- âœ… `docker restart <container>` - é‡å•Ÿå®¹å™¨ï¼ˆä¸åˆªé™¤ï¼‰
- âœ… `docker-compose restart <service>` - é‡å•Ÿæœå‹™ï¼ˆä¸åˆªé™¤ï¼‰

**å¿…é ˆåŸ·è¡Œçš„ç¢ºèªæµç¨‹**ï¼š

åœ¨åŸ·è¡Œä»»ä½•å¯èƒ½å°è‡´æ•¸æ“šä¸Ÿå¤±çš„æ“ä½œå‰ï¼Œ**å¿…é ˆ**ï¼š

1. **æª¢æŸ¥æ•¸æ“šæŒä¹…åŒ–ç‹€æ…‹**ï¼š
   ```bash
   docker inspect <container> --format '{{json .Mounts}}'
   # ç¢ºèªæ˜¯å¦æœ‰ volume æ›è¼‰
   ```

2. **æª¢æŸ¥å‚™ä»½ç‹€æ…‹**ï¼š
   - ç¢ºèªæ˜¯å¦æœ‰æœ€è¿‘çš„å‚™ä»½
   - æª¢æŸ¥å‚™ä»½æ˜¯å¦å®Œæ•´

3. **å‘ç”¨æˆ¶æ˜ç¢ºèªªæ˜é¢¨éšª**ï¼š
   ```
   âš ï¸ è­¦å‘Šï¼šåŸ·è¡Œæ­¤æ“ä½œå°‡ï¼š
   - åˆªé™¤å®¹å™¨ï¼š<container_name>
   - å½±éŸ¿ï¼š<èªªæ˜å½±éŸ¿ç¯„åœ>
   - æ•¸æ“šé¢¨éšªï¼š<èªªæ˜æ•¸æ“šæ˜¯å¦æœƒä¸Ÿå¤±>
   - å‚™ä»½ç‹€æ…‹ï¼š<æ˜¯å¦æœ‰å‚™ä»½>
   
   è«‹ç¢ºèªæ˜¯å¦ç¹¼çºŒï¼Ÿ
   - æ˜¯ï¼ˆæˆ‘ç¢ºèªå·²å‚™ä»½ï¼Œç¹¼çºŒåŸ·è¡Œï¼‰
   - å¦ï¼ˆå–æ¶ˆæ“ä½œï¼‰
   ```

4. **ç²å¾—ç”¨æˆ¶æ˜ç¢ºç¢ºèª**ï¼š
   - å¿…é ˆæ”¶åˆ°ç”¨æˆ¶æ˜ç¢ºçš„ã€Œæ˜¯ã€ã€ã€Œç¹¼çºŒã€ã€ã€ŒåŸ·è¡Œã€ç­‰ç¢ºèª
   - ç¦æ­¢åœ¨æœªç²å¾—ç¢ºèªçš„æƒ…æ³ä¸‹åŸ·è¡Œ

**é•è¦å¾Œæœ**ï¼š

- å¦‚æœé•åæ­¤è¦ç¯„å°è‡´æ•¸æ“šä¸Ÿå¤±ï¼Œå¿…é ˆï¼š
  1. ç«‹å³åœæ­¢æ‰€æœ‰æ“ä½œ
  2. æª¢æŸ¥æ˜¯å¦æœ‰å‚™ä»½å¯æ¢å¾©
  3. å‘ç”¨æˆ¶å ±å‘Šå•é¡Œå’Œæ¢å¾©æ–¹æ¡ˆ
  4. è¨˜éŒ„åˆ°æ–‡æª”ä¸­ï¼Œé˜²æ­¢å†æ¬¡ç™¼ç”Ÿ

---

## ğŸ“ æ–‡ä»¶é ­è¨»é‡‹è¦ç¯„

### åŸºæœ¬è¦æ±‚

å‡¡æ˜¯å‰µå»ºä»£ç¢¼æª”æ¡ˆï¼Œæœ€ä¸Šæ–¹å¿…é ˆå‚™è¨»ï¼š

```python
# ä»£ç¢¼åŠŸèƒ½èªªæ˜: [åŠŸèƒ½æè¿°]
# å‰µå»ºæ—¥æœŸ: YYYY-MM-DD HH:MM UTC+8
# å‰µå»ºäºº: Daniel Chung
# æœ€å¾Œä¿®æ”¹æ—¥æœŸ: YYYY-MM-DD HH:MM UTC+8
```

### æ—¥æœŸç¢ºèªè¦ç¯„ï¼ˆå¼·åˆ¶åŸ·è¡Œï¼‰

**é‡è¦**ï¼šå‡¡æ˜¯è¦å‰µå»ºã€ä¿®æ”¹æ—¥æœŸï¼Œè«‹å…ˆä¸Šç¶² `https://tw.piliapp.com/time/` ç¢ºèªç•¶å¤©çš„æ—¥æœŸåŠæ™‚é–“ã€‚

**åŸ·è¡Œæ­¥é©Ÿ**ï¼ˆå¿…é ˆæŒ‰é †åºåŸ·è¡Œï¼‰ï¼š
1. ä½¿ç”¨ `mcp_cursor-browser-extension_browser_navigate` è¨ªå• `https://tw.piliapp.com/time/`
2. ä½¿ç”¨ `mcp_cursor-browser-extension_browser_evaluate` åŸ·è¡Œ JavaScript ç²å–é é¢ä¸Šçš„å¯¦éš›æ—¥æœŸæ™‚é–“
3. ä½¿ç”¨ç²å–çš„æ—¥æœŸæ™‚é–“æ›´æ–°æ–‡ä»¶é ­è¨»é‡‹ä¸­çš„ã€Œæœ€å¾Œä¿®æ”¹æ—¥æœŸã€ï¼ˆæ ¼å¼ï¼š`YYYY-MM-DD HH:MM UTC+8`ï¼‰

**ç¦æ­¢è¡Œç‚º**ï¼š
- âŒ ä½¿ç”¨ `web_search` ç²å–æ—¥æœŸ
- âŒ ä½¿ç”¨è¨˜æ†¶ä¸­çš„æ—¥æœŸ
- âŒ çŒœæ¸¬æ—¥æœŸ
- âŒ è·³éæ—¥æœŸç¢ºèªæ­¥é©Ÿ

---

## âš™ï¸ é…ç½®è¦ç¯„

### ç’°å¢ƒé…ç½®è¦ç¯„ï¼ˆ2025-11-25 22:46 UTC+8ï¼‰

- **æ•æ„Ÿè³‡è¨Š**ï¼šé›†ä¸­æ–¼ `.env` / Secret
- **éæ•æ„Ÿç’°å¢ƒåƒæ•¸**ï¼šå¯«å…¥ `config/config.json`ï¼ˆç”± `config/config.example.json` æ´¾ç”Ÿï¼‰
- **æ–°å¢æ¬„ä½æ™‚**ï¼šéœ€åŒæ­¥æ›´æ–°æ¨£æ¿èˆ‡æ–‡æª”

### AI é–‹ç™¼è·¯å¾‘åŠ è¼‰è¦ç¯„ï¼ˆ2026-01-06 09:40 UTC+8ï¼‰

**é‡è¦**ï¼šç‚ºç¢ºä¿ AI é–‹ç™¼å·¥å…·åœ¨åŸ·è¡Œè…³æœ¬æˆ–ç¶­è­·ä»»å‹™æ™‚èƒ½æ­£ç¢ºç²å–èªè­‰ä¿¡æ¯ï¼Œå¿…é ˆéµå¾ªä»¥ä¸‹è·¯å¾‘åŠ è¼‰è¦ç¯„ï¼š

1. **é¡¯å¼åŠ è¼‰ `.env`**ï¼š
   - âŒ **ç¦æ­¢**ä¾è³´è‡ªå‹•è·¯å¾‘æŸ¥æ‰¾ï¼ˆå¦‚ `load_dotenv()`ï¼‰ã€‚
   - âœ… **å¿…é ˆ**ä½¿ç”¨çµ•å°è·¯å¾‘é¡¯å¼åŠ è¼‰æ ¹ç›®éŒ„ä¸‹çš„ `.env` æ–‡ä»¶ã€‚
   - ç†ç”±ï¼šç¹é Cursor æˆ–å…¶ä»–ç’°å¢ƒçš„å®‰å…¨éæ¿¾é™åˆ¶ï¼Œç¢ºä¿èªè­‰æœ‰æ•ˆã€‚

2. **Python ä»£ç¢¼ç¯„ä¾‹**ï¼š
   ```python
   import os
   from pathlib import Path
   from dotenv import load_dotenv

   # è¦ç¯„æ–¹å¼ï¼šç²å–é …ç›®æ ¹ç›®éŒ„ä¸¦å®šä½ .env
   base_dir = Path(__file__).resolve().parent.parent  # æ ¹æ“šè…³æœ¬æ·±åº¦èª¿æ•´
   env_path = base_dir / ".env"
   load_dotenv(dotenv_path=env_path)
   ```

3. **å„ªå…ˆèª¿ç”¨ Store Service**ï¼š
   - âœ… èªè­‰åŠ è¼‰å¾Œï¼Œæ‡‰å„ªå…ˆä½¿ç”¨ç³»çµ±å°è£çš„ `ArangoDBClient` æˆ– `StoreService` é€²è¡Œæ•¸æ“šæ“ä½œï¼Œç¦æ­¢ç¹éæ¥­å‹™é‚è¼¯ç›´æ¥æ“ä½œæ•¸æ“šåº«åº•å±¤ã€‚

---

## ğŸ“‹ pyproject.toml é…ç½®è¦ç¯„ï¼ˆ2025-01-27 UTC+8ï¼‰

**é‡è¦**ï¼šç”Ÿæˆæˆ–ä¿®æ”¹ Python ä»£ç¢¼æ™‚ï¼Œå¿…é ˆåš´æ ¼éµå¾ª `pyproject.toml` ä¸­çš„é…ç½®ã€‚

### Ruff é…ç½®è¦æ±‚

1. **è¡Œé•·åº¦**: æœ€å¤§ 100 å­—ç¬¦ï¼ˆèˆ‡ black ä¿æŒä¸€è‡´ï¼‰
2. **Python ç‰ˆæœ¬**: ç›®æ¨™ Python 3.11
3. **å•Ÿç”¨çš„è¦å‰‡é¡åˆ¥**:
   - E: pycodestyle errorsï¼ˆåŸºæœ¬éŒ¯èª¤ï¼‰
   - F: pyflakesï¼ˆæœªå®šç¾©è®Šé‡ã€æœªä½¿ç”¨å°å…¥ç­‰ï¼‰
   - W: pycodestyle warningsï¼ˆåŸºæœ¬è­¦å‘Šï¼‰
   - I: isortï¼ˆå°å…¥æ’åºï¼‰
   - UP: pyupgradeï¼ˆPython ç‰ˆæœ¬å‡ç´šå»ºè­°ï¼‰
   - B: flake8-bugbearï¼ˆå¸¸è¦‹ bug æ¨¡å¼ï¼‰
   - SIM: flake8-simplifyï¼ˆç°¡åŒ–å»ºè­°ï¼‰
   - RET: flake8-returnï¼ˆè¿”å›å€¼æª¢æŸ¥ï¼‰
   - RUF: ruff-specific rulesï¼ˆruff ç‰¹å®šè¦å‰‡ï¼‰

4. **å¿…é ˆé¿å…çš„éŒ¯èª¤**ï¼ˆé«˜å„ªå…ˆç´šï¼‰:
   - âŒ **F821**: æœªå®šç¾©çš„åç¨±ï¼ˆæœƒå°è‡´é‹è¡Œæ™‚éŒ¯èª¤ï¼‰- **å¿…é ˆä¿®å¾©**
   - âŒ **E722**: è£¸ exceptï¼ˆå¿…é ˆä½¿ç”¨ `except Exception` æˆ–æ›´å…·é«”çš„ç•°å¸¸é¡å‹ï¼‰- **å¿…é ˆä¿®å¾©**
   - âŒ **F841**: æœªä½¿ç”¨çš„è®Šé‡ï¼ˆé™¤éåœ¨ scripts ç›®éŒ„ä¸­ï¼‰
   - âŒ **E402**: å°å…¥ä¸åœ¨æ–‡ä»¶é ‚éƒ¨ï¼ˆé™¤éåœ¨ scripts/mcp ç›®éŒ„ä¸­ï¼‰

5. **å°å…¥æ’åºè¦å‰‡**:
   - æ¨™æº–åº« â†’ ç¬¬ä¸‰æ–¹åº« â†’ ç¬¬ä¸€æ–¹åŒ…
   - ç¬¬ä¸€æ–¹åŒ…åˆ—è¡¨ï¼š`api`, `agents`, `database`, `genai`, `llm`, `mcp`, `services`, `storage`, `system`, `workers`, `kag`

### Mypy é…ç½®è¦æ±‚

1. **é¡å‹æ³¨è§£è¦æ±‚**:
- âœ… æ‰€æœ‰å‡½æ•¸åƒæ•¸å¿…é ˆæœ‰é¡å‹æ³¨è§£
- âœ… æ‰€æœ‰è¿”å›å€¼å¿…é ˆæœ‰é¡å‹æ³¨è§£
   - âœ… å¯èƒ½ç‚º None çš„è®Šé‡ä½¿ç”¨ `Optional[T]` è€Œä¸æ˜¯ `T = None`
   - âœ… ä¸å…è¨±éš±å¼çš„ Optionalï¼ˆå¿…é ˆæ˜ç¢ºä½¿ç”¨ `Optional[T]`ï¼‰

2. **é¡å‹æª¢æŸ¥è¦æ±‚**:
   - âœ… ä½¿ç”¨ `strict_optional = true`ï¼ˆåš´æ ¼æª¢æŸ¥ Optional é¡å‹ï¼‰
   - âœ… ä½¿ç”¨ `no_implicit_optional = true`ï¼ˆä¸å…è¨±éš±å¼ Optionalï¼‰

3. **å¿…é ˆé¿å…çš„é¡å‹éŒ¯èª¤**:
   - âŒ æœªå®šç¾©çš„è®Šé‡æˆ–å‡½æ•¸
   - âŒ é¡å‹ä¸åŒ¹é…
   - âŒ éš±å¼çš„ Optionalï¼ˆå¦‚ `def func(param: str = None)` æ‡‰ç‚º `def func(param: Optional[str] = None)`ï¼‰

### ç”Ÿæˆä»£ç¢¼å¾Œçš„æª¢æŸ¥æµç¨‹

**é‡è¦**ï¼šAI ç”Ÿæˆæˆ–ä¿®æ”¹ä»£ç¢¼å¾Œï¼Œå¿…é ˆåŸ·è¡Œä»¥ä¸‹æª¢æŸ¥ï¼š

1. **ç«‹å³é‹è¡Œ Ruff æª¢æŸ¥**:
   ```bash
   ruff check --fix <æ–‡ä»¶è·¯å¾‘>
   ```

2. **ç«‹å³é‹è¡Œ Mypy æª¢æŸ¥**:
   ```bash
   mypy <æ–‡ä»¶è·¯å¾‘>
   ```

3. **å¦‚æœæª¢æŸ¥å¤±æ•—ï¼Œä¿®å¾©éŒ¯èª¤å¾Œé‡æ–°æª¢æŸ¥**ï¼Œç›´åˆ°é€šéç‚ºæ­¢ã€‚

4. **é«˜å„ªå…ˆç´šéŒ¯èª¤ï¼ˆF821, E722ï¼‰å¿…é ˆç«‹å³ä¿®å¾©**ï¼Œä¸èƒ½å¿½ç•¥ã€‚

### ä»£ç¢¼ç”Ÿæˆç¯„ä¾‹

**âœ… æ­£ç¢ºçš„ä»£ç¢¼ç”Ÿæˆ**ï¼š
```python
from typing import Optional, Dict, Any
from fastapi import UploadFile

async def process_file(
    file: UploadFile,
    user_id: Optional[str] = None,
    metadata: Optional[Dict[str, Any]] = None,
) -> Dict[str, Any]:
    """
    è™•ç†æ–‡ä»¶

    Args:
        file: æ–‡ä»¶å°è±¡
        user_id: ç”¨æˆ¶ IDï¼ˆå¯é¸ï¼‰
        metadata: å…ƒæ•¸æ“šï¼ˆå¯é¸ï¼‰

    Returns:
        è™•ç†çµæœ
    """
    try:
        # è™•ç†é‚è¼¯
        result = {"status": "ok"}
        return result
    except Exception as e:
        logger.error(f"è™•ç†å¤±æ•—: {e}")
        raise
```

**âŒ éŒ¯èª¤çš„ä»£ç¢¼ç”Ÿæˆ**ï¼š
```python
# âŒ ç¼ºå°‘é¡å‹æ³¨è§£
async def process_file(file, user_id=None, metadata=None):
    # âŒ ä½¿ç”¨éš±å¼ Optional
    if user_id is None:
        user_id = "default"
    # âŒ è£¸ except
    try:
        result = process(file)
    except:  # éŒ¯èª¤ï¼šæ‡‰è©²ä½¿ç”¨ except Exception
        return None
    return result
```

---

## ğŸ”· é¡å‹æ³¨è§£è¦ç¯„ï¼ˆ2025-11-27 13:00 UTC+8ï¼‰

### å¿…é ˆä½¿ç”¨é¡å‹æ³¨è§£çš„æƒ…æ³

1. **å…¨å±€è®Šé‡**ï¼šå¦‚æœå¯èƒ½ç‚º Noneï¼Œå¿…é ˆä½¿ç”¨ `Optional[T]`
   ```python
   # âŒ éŒ¯èª¤
   _service: KGBuilderService = None

   # âœ… æ­£ç¢º
   _service: Optional[KGBuilderService] = None
   ```

2. **å‡½æ•¸åƒæ•¸**ï¼šå¦‚æœé»˜èªå€¼ç‚º Noneï¼Œå¿…é ˆä½¿ç”¨ `Optional[T]`
   ```python
   # âŒ éŒ¯èª¤
   def func(model_type: str = None):

   # âœ… æ­£ç¢º
   def func(model_type: Optional[str] = None):
   ```

3. **å±€éƒ¨è®Šé‡**ï¼šè¤‡é›œé¡å‹æˆ–å¯èƒ½ç‚º None çš„è®Šé‡éœ€è¦é¡å‹æ³¨è§£
   ```python
   # âœ… æ­£ç¢º
   temp_queue: PriorityQueue = PriorityQueue()
   model: Optional[BaseRTModel] = None
   bind_vars: dict = {}
   ```

4. **é¡å±¬æ€§**ï¼šæ‰€æœ‰é¡å±¬æ€§éƒ½æ‡‰è©²æœ‰é¡å‹æ³¨è§£
   ```python
   class Service:
       _primary_model: Optional[BaseModel] = None
       _fallback_model: Optional[BaseModel] = None
   ```

### é¡å‹åŒ¹é…è¦æ±‚

- ä½¿ç”¨æ­£ç¢ºçš„é¡å‹ï¼Œä¸è¦æ··ç”¨ï¼ˆå¦‚ `List[Dict]` vs `List[WorkflowTelemetryEvent]`ï¼‰
- å°è±¡é¡å‹è¦åŒ¹é…ï¼ˆå¦‚ `CrewResourceQuota` å°è±¡è€Œé `int`ï¼‰
- é¿å…éš±å¼ Optionalï¼Œæ˜ç¢ºä½¿ç”¨ `Optional[T]` æˆ– `T | None`

---

## ğŸ›¡ï¸ é˜²å¾¡æ€§ç·¨ç¨‹è¦ç¯„ï¼ˆ2025-11-27 13:00 UTC+8ï¼‰

### None æª¢æŸ¥è¦æ±‚

1. **æ•¸æ“šåº«é€£æ¥**ï¼šä½¿ç”¨å‰å¿…é ˆæª¢æŸ¥æ˜¯å¦ç‚º None
   ```python
   # âŒ éŒ¯èª¤
   collection = self.client.db.collection(COLLECTION_NAME)

   # âœ… æ­£ç¢º
   if self.client.db is None:
       raise RuntimeError("ArangoDB client is not connected")
   collection = self.client.db.collection(COLLECTION_NAME)
   ```

2. **å¯é¸åƒæ•¸**ï¼šè™•ç†å¯èƒ½ç‚º None çš„åƒæ•¸
   ```python
   # âŒ éŒ¯èª¤
   parser = get_parser(file_type)  # file_type å¯èƒ½æ˜¯ None

   # âœ… æ­£ç¢º
   if file_type is None:
       file_type = "text/plain"  # æä¾›é»˜èªå€¼
   parser = get_parser(file_type)
   ```

3. **æ¨¡å‹å°è±¡**ï¼šä½¿ç”¨å‰æª¢æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–
   ```python
   # âŒ éŒ¯èª¤
   doc = self._model(text)  # _model å¯èƒ½æ˜¯ None

   # âœ… æ­£ç¢º
   if self._model is None:
       raise RuntimeError(f"Model {self.model_name} is not available")
   doc = self._model(text)
   ```

4. **AQL æŸ¥è©¢**ï¼šæª¢æŸ¥ aql å±¬æ€§æ˜¯å¦å¯ç”¨
   ```python
   # âœ… æ­£ç¢º
   if self.client.db is None or self.client.db.aql is None:
       raise RuntimeError("AQL is not available")
   cursor = self.client.db.aql.execute(aql, bind_vars=bind_vars)
   ```

### API èª¿ç”¨æª¢æŸ¥

- èª¿ç”¨å¤–éƒ¨ API å‰ï¼Œç¢ºèªåƒæ•¸åç¨±å’Œé¡å‹æ­£ç¢º
- æª¢æŸ¥å‡½æ•¸ç°½åï¼Œä¸è¦å‚³å…¥ä¸å­˜åœ¨çš„åƒæ•¸
- ä½¿ç”¨ IDE çš„é¡å‹æç¤ºåŠŸèƒ½é©—è­‰åƒæ•¸

---

## ğŸ“ ä»£ç¢¼çµæ§‹è¦ç¯„ï¼ˆ2025-11-27 13:00 UTC+8ï¼‰

### Import èªå¥è¦ç¯„

1. **ä½ç½®**ï¼šæ‰€æœ‰ import å¿…é ˆåœ¨æ–‡ä»¶é ‚éƒ¨ï¼Œåœ¨æ¨¡å¡Šæ–‡æª”å­—ç¬¦ä¸²ä¹‹å¾Œ
   ```python
   """æ¨¡å¡Šèªªæ˜"""

   from typing import Optional, List
   from fastapi import APIRouter
   # âŒ éŒ¯èª¤ï¼šä¸è¦åœ¨ä»£ç¢¼ä¸­é–“æ·»åŠ  import
   ```

2. **é †åº**ï¼š
   - æ¨™æº–åº« import
   - ç¬¬ä¸‰æ–¹åº« import
   - æœ¬åœ°æ¨¡å¡Š import
   - é¡å‹ç›¸é—œ importï¼ˆå¦‚ `from typing import ...`ï¼‰

### è®Šé‡ä½¿ç”¨è¦ç¯„

1. **æœªä½¿ç”¨çš„è®Šé‡**ï¼šå¿…é ˆåˆªé™¤æˆ–ä½¿ç”¨
   ```python
   # âŒ éŒ¯èª¤ï¼šå®šç¾©ä½†æœªä½¿ç”¨
   type_names = [rt.type for rt in filtered]
   pass

   # âœ… æ­£ç¢ºï¼šåˆªé™¤æœªä½¿ç”¨çš„è®Šé‡ï¼Œæˆ–æ·»åŠ è¨»é‡‹èªªæ˜ç‚ºä»€éº¼éœ€è¦
   ```

2. **å…¨å±€è®Šé‡**ï¼šä½¿ç”¨å–®ä¾‹æ¨¡å¼æ™‚ï¼Œé¡å‹å¿…é ˆæ­£ç¢º
   ```python
   # âœ… æ­£ç¢º
   _service: Optional[KGBuilderService] = None

   def get_service() -> KGBuilderService:
       global _service
       if _service is None:
           _service = KGBuilderService()
       return _service
   ```

### æ–‡ä»¶æ ¼å¼è¦ç¯„

1. **æ–‡ä»¶æœ«å°¾**ï¼šå¿…é ˆæœ‰æ›è¡Œç¬¦ï¼ˆç”± pre-commit hook è‡ªå‹•ä¿®å¾©ï¼‰
2. **è¡Œå°¾ç©ºæ ¼**ï¼šä¸å…è¨±æœ‰ trailing whitespaceï¼ˆç”± pre-commit hook è‡ªå‹•æª¢æŸ¥å’Œä¿®å¾©ï¼‰
3. **ä»£ç¢¼æ ¼å¼åŒ–**ï¼šä½¿ç”¨ black è‡ªå‹•æ ¼å¼åŒ–
4. **é¡å‹æª¢æŸ¥**ï¼šæäº¤å‰å¿…é ˆé€šé mypy æª¢æŸ¥

**Pre-commit Hooks è‡ªå‹•æª¢æŸ¥é …ç›®**ï¼š
- âœ… **trailing-whitespace**ï¼šè‡ªå‹•ç§»é™¤è¡Œå°¾ç©ºæ ¼
- âœ… **end-of-file-fixer**ï¼šè‡ªå‹•ä¿®å¾©æ–‡ä»¶æœ«å°¾æ ¼å¼ï¼ˆç¢ºä¿æ–‡ä»¶æœ«å°¾æœ‰æ›è¡Œç¬¦ï¼‰
- âœ… **black**ï¼šè‡ªå‹•æ ¼å¼åŒ– Python ä»£ç¢¼
- âœ… **ruff**ï¼šè‡ªå‹•æª¢æŸ¥å’Œä¿®å¾©ä»£ç¢¼é¢¨æ ¼å•é¡Œ
- âœ… **mypy**ï¼šé¡å‹æª¢æŸ¥ï¼ˆå¿…é ˆé€šéï¼‰
- âœ… **check-yaml/json/toml**ï¼šé…ç½®æ–‡ä»¶èªæ³•æª¢æŸ¥
- âœ… **check-added-large-files**ï¼šæª¢æŸ¥å¤§æ–‡ä»¶ï¼ˆ>1MBï¼‰
- âœ… **check-merge-conflict**ï¼šæª¢æŸ¥åˆä½µè¡çªæ¨™è¨˜
- âœ… **check-case-conflict**ï¼šæª¢æŸ¥æ–‡ä»¶åå¤§å°å¯«è¡çª

**æäº¤å‰å¿…é ˆç¢ºä¿**ï¼š
- æ‰€æœ‰ pre-commit hooks æª¢æŸ¥é€šé
- å¦‚æœæª¢æŸ¥å¤±æ•—ï¼Œæœƒè‡ªå‹•ä¿®å¾©éƒ¨åˆ†å•é¡Œï¼Œè«‹é‡æ–°æäº¤ä¿®å¾©å¾Œçš„ä»£ç¢¼

### æ—¥èªŒä½¿ç”¨è¦ç¯„ï¼ˆ2026-01-14 23:35 UTC+8ï¼‰

**é‡è¦**ï¼šæœ¬é …ç›®ä½¿ç”¨æ¨™æº– Python loggingï¼Œ**ç¦æ­¢**ä½¿ç”¨ structlog æ ¼å¼çš„æ—¥èªŒèª¿ç”¨ã€‚

#### 1. **Logger åˆå§‹åŒ–**

```python
import logging

logger = logging.getLogger(__name__)
```

#### 2. **æ­£ç¢ºçš„æ—¥èªŒæ ¼å¼**

**âœ… æ­£ç¢ºï¼šä½¿ç”¨ f-string æ ¼å¼åŒ–æ—¥èªŒæ¶ˆæ¯**
```python
# å–®è¡Œæ—¥èªŒ
logger.info(f"User logged in: user_id={user_id}")

# å¤šè¡Œæ—¥èªŒï¼ˆä¿æŒå¯è®€æ€§ï¼‰
logger.info(
    f"Task analysis completed: task_id={task_id}, "
    f"chosen_agent={chosen_agent}, confidence={confidence}"
)

# å¸¶ç•°å¸¸ä¿¡æ¯çš„æ—¥èªŒ
logger.error(
    f"Failed to process request: request_id={request_id}, error={str(e)}",
    exc_info=True,  # è¨˜éŒ„å®Œæ•´çš„å †æ£§è·Ÿè¹¤
)
```

**âŒ éŒ¯èª¤ï¼šstructlog æ ¼å¼ï¼ˆæœƒå°è‡´é‹è¡Œæ™‚éŒ¯èª¤ï¼‰**
```python
# âŒ ç¦æ­¢ï¼šä½¿ç”¨é—œéµå­—åƒæ•¸ï¼ˆstructlog æ ¼å¼ï¼‰
logger.info(
    "user_logged_in",
    user_id=user_id,
    timestamp=timestamp,
)
# éŒ¯èª¤ï¼šTypeError: Logger._log() got an unexpected keyword argument 'user_id'

# âŒ ç¦æ­¢ï¼šäº‹ä»¶åç¨± + é—œéµå­—åƒæ•¸
logger.info(
    "task_analysis_completed",
    task_id=task_id,
    chosen_agent=chosen_agent,
    confidence=confidence,
)
```

#### 3. **æ—¥èªŒç´šåˆ¥ä½¿ç”¨æŒ‡å—**

```python
# DEBUGï¼šè©³ç´°çš„èª¿è©¦ä¿¡æ¯ï¼ˆé–‹ç™¼æ™‚ä½¿ç”¨ï¼‰
logger.debug(f"Processing item {i}/{total}")

# INFOï¼šä¸€èˆ¬ä¿¡æ¯æ€§æ¶ˆæ¯
logger.info(f"Service started on port {port}")

# WARNINGï¼šè­¦å‘Šä¿¡æ¯ï¼ˆå¯æ¢å¾©çš„å•é¡Œï¼‰
logger.warning(f"Rate limit approaching: {current}/{limit}")

# ERRORï¼šéŒ¯èª¤ä¿¡æ¯ï¼ˆéœ€è¦é—œæ³¨çš„å•é¡Œï¼‰
logger.error(f"Failed to connect to database: {error}", exc_info=True)

# CRITICALï¼šåš´é‡éŒ¯èª¤ï¼ˆç³»çµ±ç„¡æ³•ç¹¼çºŒé‹è¡Œï¼‰
logger.critical(f"Configuration file not found: {config_path}")
```

#### 4. **ç•°å¸¸è™•ç†ä¸­çš„æ—¥èªŒ**

```python
try:
    result = process_data(data)
except ValueError as e:
    logger.error(
        f"Invalid data format: data_id={data.id}, error={str(e)}",
        exc_info=True,  # è‡ªå‹•åŒ…å«å †æ£§è·Ÿè¹¤
    )
    raise
except Exception as e:
    logger.critical(
        f"Unexpected error in process_data: {str(e)}",
        exc_info=True,
    )
    raise
```

#### 5. **æ•æ„Ÿä¿¡æ¯è™•ç†**

```python
# âœ… æ­£ç¢ºï¼šéš±è—æ•æ„Ÿä¿¡æ¯
logger.info(f"User login: user_id={user_id}, ip={ip_address}")

# âŒ éŒ¯èª¤ï¼šè¨˜éŒ„æ•æ„Ÿä¿¡æ¯
logger.info(f"User login: password={password}")  # ç¦æ­¢è¨˜éŒ„å¯†ç¢¼
logger.info(f"API call: api_key={api_key}")      # ç¦æ­¢è¨˜éŒ„ API Key

# âœ… æ­£ç¢ºï¼šéƒ¨åˆ†éš±è—æ•æ„Ÿä¿¡æ¯
masked_key = f"{api_key[:8]}..." if api_key else None
logger.info(f"API call: api_key={masked_key}")
```

#### 6. **æ€§èƒ½è€ƒæ…®**

```python
# âœ… æ­£ç¢ºï¼šé¿å…ä¸å¿…è¦çš„å­—ç¬¦ä¸²æ ¼å¼åŒ–
if logger.isEnabledFor(logging.DEBUG):
    expensive_debug_info = generate_debug_info()
    logger.debug(f"Debug info: {expensive_debug_info}")

# âœ… æ­£ç¢ºï¼šä½¿ç”¨æƒ°æ€§æ±‚å€¼ï¼ˆå°æ–¼è¤‡é›œè¨ˆç®—ï¼‰
logger.debug("Complex data: %s", lambda: json.dumps(complex_data))
```

#### 7. **å¸¸è¦‹éŒ¯èª¤æ¨¡å¼èˆ‡ä¿®å¾©**

| éŒ¯èª¤æ¨¡å¼ | ä¿®å¾©æ–¹æ³• |
|---------|---------|
| `logger.info("event", key=value)` | `logger.info(f"event: key={value}")` |
| `logger.error("failed", error=str(e))` | `logger.error(f"failed: {str(e)}", exc_info=True)` |
| `logger.warning("warning", note="message")` | `logger.warning(f"warning: message")` |

#### 8. **æª¢æŸ¥æ¸…å–®**

åœ¨æäº¤ä»£ç¢¼å‰ï¼Œç¢ºä¿ï¼š
- [ ] æ‰€æœ‰ logger èª¿ç”¨ä½¿ç”¨ f-string æ ¼å¼
- [ ] æ²’æœ‰ä½¿ç”¨ structlog æ ¼å¼çš„é—œéµå­—åƒæ•¸
- [ ] ç•°å¸¸æ—¥èªŒåŒ…å« `exc_info=True`
- [ ] æ²’æœ‰è¨˜éŒ„æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç¢¼ã€API Key ç­‰ï¼‰
- [ ] æ—¥èªŒæ¶ˆæ¯æ¸…æ™°ã€æœ‰æ„ç¾©
- [ ] æ—¥èªŒç´šåˆ¥ä½¿ç”¨æ­£ç¢º

#### 9. **å¦‚ä½•æª¢æŸ¥**

```bash
# æœç´¢å¯èƒ½çš„ structlog æ ¼å¼æ—¥èªŒ
grep -rn "logger\.(info|error|warning|debug)(" . | grep -E "=[^=]" | grep -v "exc_info="

# æˆ–ä½¿ç”¨ ruff æª¢æŸ¥
ruff check --select G <file>
```

---

## âœ… ä»£ç¢¼å¯©æŸ¥æª¢æŸ¥æ¸…å–®ï¼ˆ2025-11-27 13:00 UTC+8ï¼‰

### æäº¤å‰å¿…é ˆæª¢æŸ¥

- [ ] æ‰€æœ‰é¡å‹æ³¨è§£å®Œæ•´ä¸”æ­£ç¢º
- [ ] æ‰€æœ‰å¯èƒ½ç‚º None çš„å€¼éƒ½æœ‰æª¢æŸ¥
- [ ] Import èªå¥åœ¨æ–‡ä»¶é ‚éƒ¨
- [ ] æ²’æœ‰æœªä½¿ç”¨çš„è®Šé‡
- [ ] é€šé pre-commit hooksï¼ˆblack, ruff, mypyï¼‰
- [ ] API èª¿ç”¨åƒæ•¸æ­£ç¢º
- [ ] æ•¸æ“šåº«é€£æ¥ä½¿ç”¨å‰æœ‰ None æª¢æŸ¥
- [ ] æ¨¡å‹å°è±¡ä½¿ç”¨å‰æœ‰å¯ç”¨æ€§æª¢æŸ¥

### å¸¸è¦‹éŒ¯èª¤æ¨¡å¼

1. **é¡å‹ä¸åŒ¹é…**ï¼š`List[Dict]` vs `List[WorkflowTelemetryEvent]`
2. **ç¼ºå°‘ Optional**ï¼š`T = None` æ‡‰ç‚º `Optional[T] = None`
3. **ç¼ºå°‘ None æª¢æŸ¥**ï¼šç›´æ¥ä½¿ç”¨å¯èƒ½ç‚º None çš„å°è±¡
4. **Import ä½ç½®éŒ¯èª¤**ï¼šåœ¨ä»£ç¢¼ä¸­é–“æ·»åŠ  import
5. **API åƒæ•¸éŒ¯èª¤**ï¼šå‚³å…¥ä¸å­˜åœ¨çš„åƒæ•¸å

---

## ğŸ”§ å·¥å…·ä½¿ç”¨è¦ç¯„ï¼ˆ2025-11-27 13:00 UTC+8ï¼‰

### é–‹ç™¼æ™‚ä½¿ç”¨

- å•Ÿç”¨ IDE çš„é¡å‹æª¢æŸ¥åŠŸèƒ½
- ä½¿ç”¨ mypy é€²è¡Œé¡å‹æª¢æŸ¥ï¼š`mypy .`
- ä½¿ç”¨ ruff é€²è¡Œä»£ç¢¼æª¢æŸ¥ï¼š`ruff check .`
- ä½¿ç”¨ black é€²è¡Œæ ¼å¼åŒ–ï¼š`black .`

### CI/CD æª¢æŸ¥

- pre-commit hooks å¿…é ˆå…¨éƒ¨é€šé
- mypy é¡å‹æª¢æŸ¥å¿…é ˆé€šé
- ruff ä»£ç¢¼æª¢æŸ¥å¿…é ˆé€šé
- black æ ¼å¼åŒ–æª¢æŸ¥å¿…é ˆé€šé

---

## ğŸ“¤ Git æäº¤å‰æª¢æŸ¥è¦ç¯„ï¼ˆ2025-01-27 14:00 UTC+8ï¼‰

### æäº¤å‰å¿…é ˆåŸ·è¡Œçš„æ­¥é©Ÿ

**é‡è¦**ï¼šæ¯æ¬¡æäº¤ä»£ç¢¼å‰ï¼Œå¿…é ˆç¢ºä¿æ‰€æœ‰ pre-commit hooks æª¢æŸ¥é€šéã€‚å¦‚æœæª¢æŸ¥å¤±æ•—ï¼Œæäº¤æœƒè¢«é˜»æ­¢ã€‚

#### 1. è‡ªå‹•ä¿®å¾©æ­¥é©Ÿï¼ˆæ¨è–¦ï¼‰

```bash
# æ–¹æ³•ä¸€ï¼šä½¿ç”¨ pre-commit è‡ªå‹•ä¿®å¾©ï¼ˆæ¨è–¦ï¼‰
pre-commit run --all-files

# æ–¹æ³•äºŒï¼šæ‰‹å‹•é‹è¡Œå„å€‹å·¥å…·
# æ ¼å¼åŒ–ä»£ç¢¼
black .

# æª¢æŸ¥å’Œä¿®å¾©ä»£ç¢¼é¢¨æ ¼
ruff check --fix .

# é¡å‹æª¢æŸ¥ï¼ˆåªæª¢æŸ¥ï¼Œä¸è‡ªå‹•ä¿®å¾©ï¼‰
mypy .
```

#### 2. æäº¤æµç¨‹

```bash
# 1. æ·»åŠ æ–‡ä»¶åˆ°æš«å­˜å€
git add .

# 2. æäº¤ï¼ˆpre-commit hooks æœƒè‡ªå‹•é‹è¡Œï¼‰
git commit -m "your commit message"

# å¦‚æœ hooks å¤±æ•—ï¼Œæœƒè‡ªå‹•ä¿®å¾©éƒ¨åˆ†å•é¡Œï¼Œç„¶å¾Œéœ€è¦ï¼š
# - é‡æ–°æ·»åŠ ä¿®å¾©å¾Œçš„æ–‡ä»¶ï¼šgit add .
# - é‡æ–°æäº¤ï¼šgit commit -m "your commit message"
```

### Pre-commit Hooks æª¢æŸ¥é …ç›®è©³è§£

#### Black ä»£ç¢¼æ ¼å¼åŒ–æª¢æŸ¥

**æª¢æŸ¥å…§å®¹**ï¼š
- ä»£ç¢¼æ ¼å¼æ˜¯å¦ç¬¦åˆ Black è¦ç¯„
- è¡Œé•·åº¦ã€ç¸®é€²ã€å¼•è™Ÿä½¿ç”¨ç­‰

**å¸¸è¦‹éŒ¯èª¤**ï¼š
- ä»£ç¢¼æ ¼å¼ä¸ç¬¦åˆ Black è¦ç¯„
- è¡Œå°¾æœ‰å¤šé¤˜ç©ºæ ¼
- æ–‡ä»¶æœ«å°¾ç¼ºå°‘æ›è¡Œç¬¦

**ä¿®å¾©æ–¹æ³•**ï¼š
```bash
# è‡ªå‹•æ ¼å¼åŒ–æ‰€æœ‰æ–‡ä»¶
black .

# æ ¼å¼åŒ–ç‰¹å®šæ–‡ä»¶
black path/to/file.py

# æª¢æŸ¥ä½†ä¸ä¿®æ”¹ï¼ˆdry-runï¼‰
black --check .
```

**æ³¨æ„äº‹é …**ï¼š
- Black æœƒè‡ªå‹•ä¿®æ”¹æ–‡ä»¶æ ¼å¼ï¼Œä¿®æ”¹å¾Œéœ€è¦é‡æ–° `git add`
- å¦‚æœ Black ä¿®æ”¹äº†æ–‡ä»¶ï¼Œæäº¤æœƒå¤±æ•—ï¼Œéœ€è¦é‡æ–°æäº¤

#### Ruff ä»£ç¢¼é¢¨æ ¼æª¢æŸ¥

**æª¢æŸ¥å…§å®¹**ï¼š
- æœªä½¿ç”¨çš„è®Šé‡ï¼ˆF841ï¼‰
- æœªä½¿ç”¨çš„å°å…¥
- ä»£ç¢¼é¢¨æ ¼å•é¡Œ
- æ½›åœ¨çš„ bug

**å¸¸è¦‹éŒ¯èª¤**ï¼š
- `F841: Local variable 'xxx' is assigned to but never used`
- æœªä½¿ç”¨çš„å°å…¥
- ä»£ç¢¼é¢¨æ ¼ä¸ç¬¦åˆè¦ç¯„

**ä¿®å¾©æ–¹æ³•**ï¼š
```bash
# è‡ªå‹•ä¿®å¾©å¯ä¿®å¾©çš„å•é¡Œ
ruff check --fix .

# åªæª¢æŸ¥ä¸ä¿®å¾©
ruff check .

# æª¢æŸ¥ç‰¹å®šæ–‡ä»¶
ruff check path/to/file.py
```

**æ³¨æ„äº‹é …**ï¼š
- Ruff æœƒè‡ªå‹•ä¿®å¾©éƒ¨åˆ†å•é¡Œï¼Œä½†æœ‰äº›å•é¡Œéœ€è¦æ‰‹å‹•ä¿®å¾©
- æœªä½¿ç”¨çš„è®Šé‡å¿…é ˆåˆªé™¤æˆ–ä½¿ç”¨
- ä¿®å¾©å¾Œéœ€è¦é‡æ–° `git add`

#### Mypy é¡å‹æª¢æŸ¥

**æª¢æŸ¥å…§å®¹**ï¼š
- é¡å‹æ³¨è§£æ˜¯å¦æ­£ç¢º
- é¡å‹æ˜¯å¦åŒ¹é…
- æ˜¯å¦æœ‰é¡å‹éŒ¯èª¤

**å¸¸è¦‹éŒ¯èª¤**ï¼š
- `error: "Redis" expects no type arguments, but 1 given`
- `error: Argument 1 has incompatible type`
- `error: Item "X" has no attribute "__iter__"`
- `error: Unsupported right operand type for in`

**ä¿®å¾©æ–¹æ³•**ï¼š
```bash
# æª¢æŸ¥æ‰€æœ‰æ–‡ä»¶
mypy .

# æª¢æŸ¥ç‰¹å®šæ–‡ä»¶
mypy path/to/file.py

# å¿½ç•¥ç¼ºå¤±çš„å°å…¥ï¼ˆç”¨æ–¼ç¬¬ä¸‰æ–¹åº«ï¼‰
mypy --ignore-missing-imports .
```

**å¸¸è¦‹é¡å‹éŒ¯èª¤ä¿®å¾©**ï¼š

1. **Redis é¡å‹æ³¨è§£éŒ¯èª¤**ï¼š
   ```python
   # âŒ éŒ¯èª¤
   self._redis: Optional[redis.Redis[str]] = None

   # âœ… æ­£ç¢ºï¼ˆredis-py ä¸æ”¯æŒé¡å‹åƒæ•¸ï¼‰
   self._redis: Optional[redis.Redis] = None
   ```

2. **ç•°æ­¥æ“ä½œé¡å‹éŒ¯èª¤**ï¼š
   ```python
   # âŒ éŒ¯èª¤ï¼ˆå¿˜è¨˜ awaitï¼‰
   result = self._redis.get(key)

   # âœ… æ­£ç¢ºï¼ˆåŒæ­¥ Redisï¼‰
   result = self._redis.get(key)
   # æˆ–ä½¿ç”¨é¡å‹å¿½ç•¥ï¼ˆå¦‚æœç¢ºå®šæ˜¯åŒæ­¥çš„ï¼‰
   result = self._redis.get(key)  # type: ignore[union-attr]
   ```

3. **ArangoDB æŸ¥è©¢çµæœé¡å‹**ï¼š
   ```python
   # âŒ éŒ¯èª¤
   document = collection.get(session_id)
   if "messages" in document:  # é¡å‹éŒ¯èª¤

   # âœ… æ­£ç¢º
   document = collection.get(session_id)
   if document is not None and isinstance(document, dict):
       if "messages" in document:
   ```

### æäº¤å¤±æ•—è™•ç†æµç¨‹

#### æƒ…æ³ 1ï¼šBlack æ ¼å¼åŒ–å¤±æ•—

**éŒ¯èª¤ä¿¡æ¯**ï¼š
```
black....................................................................Failed
- hook id: black
- files were modified by this hook
```

**è™•ç†æ­¥é©Ÿ**ï¼š
1. Black å·²ç¶“è‡ªå‹•ä¿®å¾©äº†æ–‡ä»¶
2. é‡æ–°æ·»åŠ ä¿®å¾©å¾Œçš„æ–‡ä»¶ï¼š`git add .`
3. é‡æ–°æäº¤ï¼š`git commit -m "your message"`

#### æƒ…æ³ 2ï¼šRuff æª¢æŸ¥å¤±æ•—

**éŒ¯èª¤ä¿¡æ¯**ï¼š
```
ruff.....................................................................Failed
- hook id: ruff
- exit code: 1
- files were modified by this hook
```

**è™•ç†æ­¥é©Ÿ**ï¼š
1. æª¢æŸ¥ Ruff çš„éŒ¯èª¤ä¿¡æ¯
2. å¦‚æœ Ruff è‡ªå‹•ä¿®å¾©äº†ï¼Œé‡æ–°æ·»åŠ ï¼š`git add .`
3. å¦‚æœæœ‰éœ€è¦æ‰‹å‹•ä¿®å¾©çš„å•é¡Œï¼ˆå¦‚æœªä½¿ç”¨çš„è®Šé‡ï¼‰ï¼Œæ‰‹å‹•ä¿®å¾©å¾Œé‡æ–°æ·»åŠ 
4. é‡æ–°æäº¤

#### æƒ…æ³ 3ï¼šMypy é¡å‹æª¢æŸ¥å¤±æ•—

**éŒ¯èª¤ä¿¡æ¯**ï¼š
```
mypy.....................................................................Failed
- hook id: mypy
- exit code: 1
```

**è™•ç†æ­¥é©Ÿ**ï¼š
1. æŸ¥çœ‹ mypy çš„è©³ç´°éŒ¯èª¤ä¿¡æ¯
2. æ ¹æ“šéŒ¯èª¤ä¿¡æ¯ä¿®å¾©é¡å‹å•é¡Œ
3. å¦‚æœç„¡æ³•ä¿®å¾©ï¼ˆå¦‚ç¬¬ä¸‰æ–¹åº«é¡å‹å•é¡Œï¼‰ï¼Œä½¿ç”¨ `# type: ignore[error-code]` è¨»é‡‹
4. é‡æ–°æ·»åŠ å’Œæäº¤

### æäº¤å‰æª¢æŸ¥æ¸…å–®

åœ¨åŸ·è¡Œ `git commit` å‰ï¼Œè«‹ç¢ºä¿ï¼š

- [ ] å·²é‹è¡Œ `black .` æ ¼å¼åŒ–ä»£ç¢¼
- [ ] å·²é‹è¡Œ `ruff check --fix .` ä¿®å¾©ä»£ç¢¼é¢¨æ ¼å•é¡Œ
- [ ] å·²é‹è¡Œ `mypy .` æª¢æŸ¥é¡å‹ï¼ˆæˆ–è‡³å°‘æª¢æŸ¥ä¿®æ”¹çš„æ–‡ä»¶ï¼‰
- [ ] æ‰€æœ‰æ¸¬è©¦é€šéï¼ˆå¦‚æœæœ‰ï¼‰
- [ ] ä»£ç¢¼ç¬¦åˆé …ç›®è¦ç¯„
- [ ] æ²’æœ‰æœªä½¿ç”¨çš„è®Šé‡æˆ–å°å…¥
- [ ] æ‰€æœ‰é¡å‹æ³¨è§£æ­£ç¢º

### å¿«é€Ÿä¿®å¾©å‘½ä»¤

```bash
# ä¸€éµä¿®å¾©æ‰€æœ‰å¯è‡ªå‹•ä¿®å¾©çš„å•é¡Œ
black . && ruff check --fix . && git add .

# ç„¶å¾Œæª¢æŸ¥é¡å‹ï¼ˆä¸æœƒè‡ªå‹•ä¿®å¾©ï¼‰
mypy . || echo "æœ‰é¡å‹éŒ¯èª¤ï¼Œéœ€è¦æ‰‹å‹•ä¿®å¾©"

# æœ€å¾Œæäº¤
git commit -m "your message"
```

### å¸¸è¦‹å•é¡Œè§£æ±ºæ–¹æ¡ˆ

#### Q1: pre-commit hooks ä¸€ç›´å¤±æ•—ï¼Œå¦‚ä½•è·³éï¼Ÿ

**ä¸æ¨è–¦è·³é**ï¼Œä½†å¦‚æœæœ‰ç·Šæ€¥æƒ…æ³ï¼š
```bash
# è·³é pre-commit hooksï¼ˆä¸æ¨è–¦ï¼‰
git commit --no-verify -m "your message"
```

**æ³¨æ„**ï¼šè·³é hooks æœƒå°è‡´ä»£ç¢¼è³ªé‡å•é¡Œï¼Œæ‡‰è©²ç›¡é‡é¿å…ã€‚

#### Q2: å¦‚ä½•åªæª¢æŸ¥ç‰¹å®šæ–‡ä»¶ï¼Ÿ

```bash
# åªæª¢æŸ¥ç‰¹å®šæ–‡ä»¶
black path/to/file.py
ruff check path/to/file.py
mypy path/to/file.py
```

#### Q3: å¦‚ä½•æ›´æ–° pre-commit hooksï¼Ÿ

```bash
# æ›´æ–° pre-commit hooks
pre-commit autoupdate

# é‡æ–°å®‰è£ hooks
pre-commit install
```

#### Q4: å¦‚ä½•æŸ¥çœ‹è©³ç´°çš„éŒ¯èª¤ä¿¡æ¯ï¼Ÿ

```bash
# æŸ¥çœ‹è©³ç´°çš„ mypy éŒ¯èª¤
mypy . --show-error-codes

# æŸ¥çœ‹è©³ç´°çš„ ruff éŒ¯èª¤
ruff check . --verbose

# æŸ¥çœ‹è©³ç´°çš„ black éŒ¯èª¤
black . --diff
```

### é–‹ç™¼ç’°å¢ƒè¨­ç½®

ç¢ºä¿é–‹ç™¼ç’°å¢ƒå·²æ­£ç¢ºè¨­ç½®ï¼š

```bash
# 1. æ¿€æ´»è™›æ“¬ç’°å¢ƒ
source venv/bin/activate  # Linux/Mac
# æˆ–
venv\Scripts\activate  # Windows

# 2. å®‰è£ pre-commit
pip install pre-commit

# 3. å®‰è£ pre-commit hooks
pre-commit install

# 4. å®‰è£é–‹ç™¼ä¾è³´
pip install black ruff mypy
```

### æŒçºŒé›†æˆï¼ˆCIï¼‰æª¢æŸ¥

åœ¨ CI/CD æµç¨‹ä¸­ï¼Œé€™äº›æª¢æŸ¥ä¹Ÿæœƒè‡ªå‹•é‹è¡Œï¼š
- æ‰€æœ‰ pre-commit hooks å¿…é ˆé€šé
- é¡å‹æª¢æŸ¥å¿…é ˆé€šé
- ä»£ç¢¼æ ¼å¼åŒ–æª¢æŸ¥å¿…é ˆé€šé

å¦‚æœ CI æª¢æŸ¥å¤±æ•—ï¼Œè«‹åœ¨æœ¬åœ°ä¿®å¾©å¾Œé‡æ–°æäº¤ã€‚

---

## ğŸ“Š é …ç›®æ§åˆ¶è¡¨æ›´æ–°è¦ç¯„ï¼ˆ2025-01-27 14:00 UTC+8ï¼‰

### æ›´æ–° PROJECT_CONTROL_TABLE.md çš„å¼·åˆ¶è¦æ±‚

**é‡è¦**ï¼šæ›´æ–° `docs/PROJECT_CONTROL_TABLE.md` æ™‚ï¼Œ**å¿…é ˆåœ¨åŸæœ‰æ–‡ä»¶åŸºç¤ä¸Šé€²è¡Œæ›´æ–°**ï¼Œ**åš´ç¦ç›´æ¥å‰µå»ºæ–°æ–‡ä»¶æˆ–è¦†è“‹æ•´å€‹æ–‡ä»¶**ã€‚

#### æ›´æ–°åŸå‰‡

1. **å¿…é ˆè®€å–ç¾æœ‰æ–‡ä»¶**ï¼šæ›´æ–°å‰å¿…é ˆå…ˆè®€å–ç¾æœ‰çš„ `PROJECT_CONTROL_TABLE.md` æ–‡ä»¶å…§å®¹
2. **å±€éƒ¨æ›´æ–°**ï¼šåªæ›´æ–°éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†ï¼ˆå¦‚ä»»å‹™ç‹€æ…‹ã€å®Œæˆæ—¥æœŸã€é€²åº¦ç™¾åˆ†æ¯”ç­‰ï¼‰
3. **ä¿ç•™åŸæœ‰çµæ§‹**ï¼šä¿æŒæ–‡ä»¶çš„æ•´é«”çµæ§‹ã€æ ¼å¼å’Œæœªä¿®æ”¹çš„å…§å®¹ä¸è®Š
4. **ç¦æ­¢è¦†è“‹**ï¼šä¸å¾—ä½¿ç”¨ `write` å·¥å…·ç›´æ¥è¦†è“‹æ•´å€‹æ–‡ä»¶

#### æ­£ç¢ºçš„æ›´æ–°æ–¹å¼

**âœ… æ¨è–¦æ–¹å¼ 1ï¼šä½¿ç”¨ Python è…³æœ¬è®€å–-ä¿®æ”¹-å¯«å›**

```python
# è®€å–ç¾æœ‰æ–‡ä»¶
with open("docs/PROJECT_CONTROL_TABLE.md", 'r', encoding='utf-8') as f:
    content = f.read()

# åªä¿®æ”¹éœ€è¦æ›´æ–°çš„éƒ¨åˆ†
content = content.replace("èˆŠç‹€æ…‹", "æ–°ç‹€æ…‹")
# æˆ–ä½¿ç”¨æ­£å‰‡è¡¨é”å¼ç²¾ç¢ºåŒ¹é…éœ€è¦æ›´æ–°çš„è¡Œ

# å¯«å›æ–‡ä»¶
with open("docs/PROJECT_CONTROL_TABLE.md", 'w', encoding='utf-8') as f:
    f.write(content)
```

**âœ… æ¨è–¦æ–¹å¼ 2ï¼šä½¿ç”¨ sed æˆ– grep é€²è¡Œå±€éƒ¨æ›¿æ›**

```bash
# ä½¿ç”¨ sed æ›¿æ›ç‰¹å®šè¡Œ
sed -i 's/èˆŠå…§å®¹/æ–°å…§å®¹/g' docs/PROJECT_CONTROL_TABLE.md
```

**âœ… æ¨è–¦æ–¹å¼ 3ï¼šä½¿ç”¨ search_replace å·¥å…·é€²è¡Œç²¾ç¢ºæ›¿æ›**

```python
# ä½¿ç”¨ search_replace å·¥å…·ï¼Œæä¾›è¶³å¤ çš„ä¸Šä¸‹æ–‡ç¢ºä¿å”¯ä¸€åŒ¹é…
search_replace(
    file_path="docs/PROJECT_CONTROL_TABLE.md",
    old_string="| 5.1.1 | LLM Router æ ¸å¿ƒ | 2 å¤© | â¸ï¸ | 0% | - | - | AI-1 |",
    new_string="| 5.1.1 | LLM Router æ ¸å¿ƒ | 2 å¤© | âœ… | 100% | 2025-01-27 | 2025-01-27 | AI-1 |"
)
```

#### éŒ¯èª¤çš„æ›´æ–°æ–¹å¼ï¼ˆç¦æ­¢ï¼‰

**âŒ éŒ¯èª¤æ–¹å¼ 1ï¼šç›´æ¥å‰µå»ºæ–°æ–‡ä»¶**

```python
# âŒ ç¦æ­¢ï¼šç›´æ¥å‰µå»ºæ–°æ–‡ä»¶
write("docs/PROJECT_CONTROL_TABLE.md", "æ–°å…§å®¹...")
```

**âŒ éŒ¯èª¤æ–¹å¼ 2ï¼šè¦†è“‹æ•´å€‹æ–‡ä»¶**

```python
# âŒ ç¦æ­¢ï¼šè®€å–å‚™ä»½æ–‡ä»¶ç„¶å¾Œè¦†è“‹åŸæ–‡ä»¶
with open("backup.md", 'r') as f:
    content = f.read()
with open("docs/PROJECT_CONTROL_TABLE.md", 'w') as f:
    f.write(content)  # é€™æœƒä¸Ÿå¤±åŸæ–‡ä»¶ä¸­çš„å…¶ä»–æ›´æ–°
```

**âŒ éŒ¯èª¤æ–¹å¼ 3ï¼šä¸è®€å–åŸæ–‡ä»¶å°±æ›´æ–°**

```python
# âŒ ç¦æ­¢ï¼šä¸è®€å–åŸæ–‡ä»¶ï¼Œç›´æ¥å¯«å…¥
content = "æ–°å…§å®¹..."
with open("docs/PROJECT_CONTROL_TABLE.md", 'w') as f:
    f.write(content)
```

#### æ›´æ–°å‰æª¢æŸ¥æ¸…å–®

åœ¨æ›´æ–° `PROJECT_CONTROL_TABLE.md` å‰ï¼Œå¿…é ˆï¼š

- [ ] ç¢ºèªå·²è®€å–ç¾æœ‰æ–‡ä»¶å…§å®¹
- [ ] ç¢ºèªåªæ›´æ–°éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†
- [ ] ç¢ºèªä¿ç•™æ–‡ä»¶çš„æ•´é«”çµæ§‹
- [ ] ç¢ºèªæœªä¿®æ”¹çš„å…§å®¹ä¿æŒä¸è®Š
- [ ] ç¢ºèªæ›´æ–°å¾Œçš„æ ¼å¼æ­£ç¢ºï¼ˆMarkdown è¡¨æ ¼æ ¼å¼ï¼‰

#### æ›´æ–°å¾Œé©—è­‰

æ›´æ–°å®Œæˆå¾Œï¼Œæ‡‰è©²é©—è­‰ï¼š

- [ ] æ–‡ä»¶æ ¼å¼æ­£ç¢ºï¼ˆMarkdown è¡¨æ ¼å¯ä»¥æ­£å¸¸æ¸²æŸ“ï¼‰
- [ ] æœªä¿®æ”¹çš„å…§å®¹ä»ç„¶å­˜åœ¨
- [ ] æ›´æ–°çš„å…§å®¹æ­£ç¢ºåæ˜ å¯¦éš›é€²åº¦
- [ ] æ–‡ä»¶çµæ§‹å®Œæ•´ï¼ˆæ‰€æœ‰ç« ç¯€éƒ½å­˜åœ¨ï¼‰

#### å¸¸è¦‹æ›´æ–°å ´æ™¯ç¤ºä¾‹

**å ´æ™¯ 1ï¼šæ›´æ–°å–®å€‹ä»»å‹™ç‹€æ…‹**

```python
# è®€å–æ–‡ä»¶
with open("docs/PROJECT_CONTROL_TABLE.md", 'r', encoding='utf-8') as f:
    content = f.read()

# æ›´æ–°ç‰¹å®šä»»å‹™
content = content.replace(
    "| 5.1.1 | LLM Router æ ¸å¿ƒ | 2 å¤© | â¸ï¸ | 0% | - | - | AI-1 |",
    "| 5.1.1 | LLM Router æ ¸å¿ƒ | 2 å¤© | âœ… | 100% | 2025-01-27 | 2025-01-27 | AI-1 |"
)

# å¯«å›æ–‡ä»¶
with open("docs/PROJECT_CONTROL_TABLE.md", 'w', encoding='utf-8') as f:
    f.write(content)
```

**å ´æ™¯ 2ï¼šæ›´æ–°éšæ®µé€²åº¦**

```python
# è®€å–æ–‡ä»¶
with open("docs/PROJECT_CONTROL_TABLE.md", 'r', encoding='utf-8') as f:
    content = f.read()

# æ›´æ–°é€²åº¦
content = content.replace(
    "| **éšæ®µäº”** | LLM MoE éšæ®µ | ... | ğŸ”„ é€²è¡Œä¸­ | 25% |",
    "| **éšæ®µäº”** | LLM MoE éšæ®µ | ... | ğŸ”„ é€²è¡Œä¸­ | 78.6% (11/14) |"
)

# å¯«å›æ–‡ä»¶
with open("docs/PROJECT_CONTROL_TABLE.md", 'w', encoding='utf-8') as f:
    f.write(content)
```

**å ´æ™¯ 3ï¼šæ‰¹é‡æ›´æ–°å¤šå€‹ä»»å‹™**

```python
# è®€å–æ–‡ä»¶
with open("docs/PROJECT_CONTROL_TABLE.md", 'r', encoding='utf-8') as f:
    content = f.read()

# å®šç¾©æ›´æ–°æ˜ å°„
updates = {
    "| 5.1.1 | ... | â¸ï¸ | 0% |": "| 5.1.1 | ... | âœ… | 100% | 2025-01-27 | 2025-01-27 |",
    "| 5.1.2 | ... | â¸ï¸ | 0% |": "| 5.1.2 | ... | âœ… | 100% | 2025-01-27 | 2025-01-27 |",
}

# æ‰¹é‡æ›´æ–°
for old, new in updates.items():
    content = content.replace(old, new)

# å¯«å›æ–‡ä»¶
with open("docs/PROJECT_CONTROL_TABLE.md", 'w', encoding='utf-8') as f:
    f.write(content)
```

#### ç·Šæ€¥æƒ…æ³è™•ç†

å¦‚æœèª¤æ“ä½œå°è‡´æ–‡ä»¶æå£ï¼š

1. **ç«‹å³åœæ­¢**ï¼šä¸è¦ç¹¼çºŒä¿®æ”¹
2. **æª¢æŸ¥ Git æ­·å²**ï¼šä½¿ç”¨ `git log docs/PROJECT_CONTROL_TABLE.md` æŸ¥çœ‹æ­·å²ç‰ˆæœ¬
3. **æ¢å¾©å‚™ä»½**ï¼šå¦‚æœæœ‰å‚™ä»½æ–‡ä»¶ï¼ˆå¦‚ `.backup`ï¼‰ï¼Œå¾å‚™ä»½æ¢å¾©
4. **å¾ Git æ¢å¾©**ï¼šä½¿ç”¨ `git checkout HEAD -- docs/PROJECT_CONTROL_TABLE.md` æ¢å¾©åˆ°æœ€å¾Œä¸€æ¬¡æäº¤çš„ç‰ˆæœ¬
5. **æ‰‹å‹•ä¿®å¾©**ï¼šå¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½ä¸å¯ç”¨ï¼Œæ‰‹å‹•å°æ¯”ä¸¦ä¿®å¾©æ–‡ä»¶

#### ç¸½çµ

**æ ¸å¿ƒåŸå‰‡**ï¼š
- âœ… **å¿…é ˆ**åœ¨åŸæœ‰æ–‡ä»¶åŸºç¤ä¸Šæ›´æ–°
- âœ… **å¿…é ˆ**å…ˆè®€å–ç¾æœ‰æ–‡ä»¶å…§å®¹
- âœ… **å¿…é ˆ**åªæ›´æ–°éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†
- âŒ **ç¦æ­¢**ç›´æ¥å‰µå»ºæ–°æ–‡ä»¶
- âŒ **ç¦æ­¢**è¦†è“‹æ•´å€‹æ–‡ä»¶
- âŒ **ç¦æ­¢**ä¸è®€å–åŸæ–‡ä»¶å°±æ›´æ–°

éµå¾ªé€™äº›è¦ç¯„å¯ä»¥ç¢ºä¿é …ç›®æ§åˆ¶è¡¨çš„æ›´æ–°ä¸æœƒä¸Ÿå¤±å·²æœ‰çš„é€²åº¦è¨˜éŒ„ï¼Œé¿å…å› èª¤æ“ä½œå°è‡´çš„æ•¸æ“šä¸Ÿå¤±ã€‚

---

## ğŸ—„ï¸ ArangoDB æ•¸æ“šå­˜å„²è¦ç¯„ï¼ˆ2025-12-18 20:49:06 UTC+8ï¼‰

### æ¦‚è¿°

AI-Box é …ç›®ä½¿ç”¨ ArangoDB ä½œç‚ºçµ±ä¸€çš„æ•¸æ“šå­˜å„²ç³»çµ±ï¼Œæ›¿ä»£æ–‡ä»¶ç³»çµ±å’Œ Redisï¼ˆéƒ¨åˆ†å ´æ™¯ï¼‰ã€‚æœ¬è¦ç¯„å®šç¾©äº† ArangoDB ä¸­æ‰€æœ‰ Collections çš„æ•¸æ“šçµæ§‹ã€å­˜å„²è¦å‰‡å’Œä½¿ç”¨è¦ç¯„ã€‚

### ArangoDB Collections å®Œæ•´åˆ—è¡¨

#### Document Collectionsï¼ˆæ–‡æª”é›†åˆï¼‰

| Collection åç¨± | ç”¨é€” | æœå‹™ | å¤šç§Ÿæˆ¶ | TTL |
|----------------|------|------|--------|-----|
| `ontologies` | Ontology å®šç¾©å­˜å„² | `OntologyStoreService` | âœ… | - |
| `system_configs` | ç³»çµ±ç´šé…ç½® | `ConfigStoreService` | âŒ | - |
| `tenant_configs` | ç§Ÿæˆ¶ç´šé…ç½® | `ConfigStoreService` | âœ… | - |
| `user_configs` | ç”¨æˆ¶ç´šé…ç½® | `ConfigStoreService` | âœ… | - |
| `audit_logs` | å¯©è¨ˆæ—¥èªŒ | `AuditLogService` | âœ… | - |
| `upload_progress` | æ–‡ä»¶ä¸Šå‚³é€²åº¦ | `UploadStatusService` | âœ… | 1å°æ™‚ |
| `processing_status` | æ–‡ä»¶è™•ç†ç‹€æ…‹ | `UploadStatusService` | âœ… | 24å°æ™‚ |
| `file_metadata` | æ–‡ä»¶å…ƒæ•¸æ“š | `FileMetadataService` | âœ… | - |
| `folder_metadata` | æ–‡ä»¶å¤¾å…ƒæ•¸æ“š | `TaskWorkspaceService` | âœ… | - |
| `genai_tenant_policies` | GenAI ç§Ÿæˆ¶ç­–ç•¥ | `GenAITenantPolicyService` | âœ… | - |
| `genai_tenant_secrets` | GenAI ç§Ÿæˆ¶å¯†é‘°ï¼ˆåŠ å¯†ï¼‰ | `GenAITenantPolicyService` | âœ… | - |
| `genai_user_llm_secrets` | GenAI ç”¨æˆ¶ LLM å¯†é‘°ï¼ˆåŠ å¯†ï¼‰ | `GenAIUserLLMSecretService` | âœ… | - |
| `model_usage` | æ¨¡å‹ä½¿ç”¨è¨˜éŒ„ | `ModelUsageService` | âœ… | - |
| `operation_logs` | æ“ä½œæ—¥èªŒ | `OperationLogService` | âœ… | - |
| `user_tasks` | ç”¨æˆ¶ä»»å‹™ | `UserTaskService` | âœ… | - |
| `tools_registry` | å·¥å…·è¨»å†Šæ¸…å–® | `ToolRegistryStoreService` | âŒ | - |

#### Graph Collectionsï¼ˆåœ–é›†åˆ - çŸ¥è­˜åœ–è­œï¼‰

| Collection åç¨± | ç”¨é€” | é¡å‹ | èªªæ˜ |
|----------------|------|------|------|
| `entities` | çŸ¥è­˜åœ–è­œå¯¦é«” | Edge/Vertex | å‹•æ…‹å‰µå»ºï¼ŒæŒ‰æ–‡ä»¶IDçµ„ç¹” |
| `relations` | çŸ¥è­˜åœ–è­œé—œä¿‚ | Edge | å‹•æ…‹å‰µå»ºï¼ŒæŒ‰æ–‡ä»¶IDçµ„ç¹” |

### æ•¸æ“šå­˜å„²è¦ç¯„

#### 1. Collection å‘½åè¦ç¯„

**å¿…é ˆéµå¾ª**ï¼š
- âœ… ä½¿ç”¨å°å¯«å­—æ¯å’Œä¸‹åŠƒç·šï¼ˆsnake_caseï¼‰
- âœ… åç¨±å¿…é ˆæ¸…æ™°è¡¨é”ç”¨é€”
- âœ… Document Collections ä½¿ç”¨è¤‡æ•¸å½¢å¼ï¼ˆå¦‚ `ontologies`, `configs`ï¼‰
- âœ… åœ–é›†åˆä½¿ç”¨å–®æ•¸å½¢å¼ï¼ˆå¦‚ `entities`, `relations`ï¼‰

**ç¦æ­¢**ï¼š
- âŒ ä½¿ç”¨å¤§å¯«å­—æ¯
- âŒ ä½¿ç”¨é€£å­—ç¬¦ï¼ˆhyphenï¼‰
- âŒ ä½¿ç”¨ä¸­æ–‡æˆ–ç‰¹æ®Šå­—ç¬¦
- âŒ å‹•æ…‹ Collection åç¨±å¿…é ˆåŒ…å«å¯è¿½æº¯çš„æ¨™è­˜ï¼ˆå¦‚ `entities_{file_id}`ï¼‰

#### 2. æ–‡æª”çµæ§‹è¦ç¯„

**å¿…éœ€å­—æ®µ**ï¼š
- `_key`: æ–‡æª”å”¯ä¸€æ¨™è­˜ï¼ˆå¿…é ˆï¼‰
- `created_at`: å‰µå»ºæ™‚é–“ï¼ˆISO 8601 æ ¼å¼å­—ç¬¦ä¸²ï¼‰
- `updated_at`: æ›´æ–°æ™‚é–“ï¼ˆISO 8601 æ ¼å¼å­—ç¬¦ä¸²ï¼‰

**å¤šç§Ÿæˆ¶å­—æ®µ**ï¼ˆå¦‚é©ç”¨ï¼‰ï¼š
- `tenant_id`: ç§Ÿæˆ¶ IDï¼ˆå­—ç¬¦ä¸²ï¼Œnull è¡¨ç¤ºç³»çµ±ç´šï¼‰
- `user_id`: ç”¨æˆ¶ IDï¼ˆå­—ç¬¦ä¸²ï¼Œåƒ…ç”¨æˆ¶ç´šæ•¸æ“šéœ€è¦ï¼‰

**è»Ÿåˆªé™¤å­—æ®µ**ï¼ˆå¦‚é©ç”¨ï¼‰ï¼š
- `is_active`: æ˜¯å¦å•Ÿç”¨ï¼ˆå¸ƒçˆ¾å€¼ï¼Œé»˜èª trueï¼‰

**æ•¸æ“šåˆ†é¡å­—æ®µ**ï¼ˆWBS-4.2.1ï¼Œå¦‚é©ç”¨ï¼‰ï¼š
- `data_classification`: æ•¸æ“šåˆ†é¡ç´šåˆ¥ï¼ˆ`PUBLIC` / `INTERNAL` / `CONFIDENTIAL` / `RESTRICTED`ï¼‰
- `sensitivity_labels`: æ•æ„Ÿæ€§æ¨™ç±¤åˆ—è¡¨ï¼ˆå¦‚ `["PII", "PHI", "FINANCIAL"]`ï¼‰

#### 3. ç´¢å¼•è¦ç¯„

**å¿…é ˆå‰µå»ºç´¢å¼•**ï¼š
- æ‰€æœ‰æŸ¥è©¢å­—æ®µå¿…é ˆæœ‰ç´¢å¼•
- å¤šç§Ÿæˆ¶æŸ¥è©¢å¿…é ˆåœ¨ `tenant_id` å­—æ®µä¸Šå‰µå»ºç´¢å¼•
- æ™‚é–“ç¯„åœæŸ¥è©¢å¿…é ˆåœ¨æ™‚é–“å­—æ®µä¸Šå‰µå»ºç´¢å¼•
- è¤‡åˆæŸ¥è©¢å¿…é ˆå‰µå»ºè¤‡åˆç´¢å¼•

**ç´¢å¼•é¡å‹**ï¼š
- `persistent`: æŒä¹…ç´¢å¼•ï¼ˆç”¨æ–¼æŸ¥è©¢å’Œæ’åºï¼‰
- `ttl`: ç”Ÿå­˜æ™‚é–“ç´¢å¼•ï¼ˆç”¨æ–¼è‡ªå‹•æ¸…ç†ï¼‰

**ç¤ºä¾‹**ï¼š
```python
# æ­£ç¢ºï¼šå‰µå»ºè¤‡åˆç´¢å¼•
collection.add_index({
    "type": "persistent",
    "fields": ["tenant_id", "scope", "is_active"]
})

# æ­£ç¢ºï¼šå‰µå»º TTL ç´¢å¼•
collection.add_index({
    "type": "ttl",
    "fields": ["updated_at"],
    "expireAfter": 3600  # 1å°æ™‚
})
```

#### 4. å¤šç§Ÿæˆ¶éš”é›¢è¦ç¯„

**æ‡‰ç”¨å±¤éš”é›¢**ï¼š
- æ‰€æœ‰æŸ¥è©¢å¿…é ˆåŒ…å« `tenant_id` éæ¿¾æ¢ä»¶
- ç³»çµ±ç´šæ•¸æ“šä½¿ç”¨ `tenant_id: null`
- ç§Ÿæˆ¶ç´šæ•¸æ“šå¿…é ˆåŒ…å«æœ‰æ•ˆçš„ `tenant_id`

**å¿…é ˆæª¢æŸ¥**ï¼š
```python
# âœ… æ­£ç¢ºï¼šæŸ¥è©¢æ™‚å¿…é ˆéæ¿¾ tenant_id
def get_config(self, scope: str, tenant_id: Optional[str]) -> ConfigModel:
    filters = {"scope": scope, "is_active": True}
    if tenant_id:
        filters["tenant_id"] = tenant_id
    else:
        filters["tenant_id"] = None  # ç³»çµ±ç´šé…ç½®
    # ...
```

#### 5. æ•¸æ“šé¡å‹è¦ç¯„

**å­—ç¬¦ä¸²**ï¼š
- æ‰€æœ‰ ID å­—æ®µä½¿ç”¨å­—ç¬¦ä¸²é¡å‹
- æ™‚é–“å­—æ®µä½¿ç”¨ ISO 8601 æ ¼å¼å­—ç¬¦ä¸²ï¼ˆ`datetime.utcnow().isoformat()`ï¼‰

**æ•¸å€¼**ï¼š
- è¨ˆæ•¸å­—æ®µä½¿ç”¨æ•´æ•¸ï¼ˆ`int`ï¼‰
- ç™¾åˆ†æ¯”å’Œæ¯”ä¾‹ä½¿ç”¨æµ®é»æ•¸ï¼ˆ`float`ï¼‰

**å¸ƒçˆ¾å€¼**ï¼š
- ç‹€æ…‹å­—æ®µä½¿ç”¨å¸ƒçˆ¾å€¼ï¼ˆ`bool`ï¼‰ï¼Œä¸å…è¨±ä½¿ç”¨å­—ç¬¦ä¸²ï¼ˆå¦‚ `"true"`ï¼‰

**JSON å°è±¡**ï¼š
- è¤‡é›œçµæ§‹ä½¿ç”¨å­—å…¸ï¼ˆ`Dict[str, Any]`ï¼‰
- å¿…é ˆä½¿ç”¨ Pydantic æ¨¡å‹é€²è¡Œé©—è­‰

#### 6. è»Ÿåˆªé™¤è¦ç¯„

**ä½¿ç”¨è»Ÿåˆªé™¤**ï¼š
- ä¸è¦ç‰©ç†åˆªé™¤é‡è¦æ•¸æ“šï¼ˆå¯©è¨ˆã€é…ç½®ç­‰ï¼‰
- ä½¿ç”¨ `is_active: false` æ¨™è¨˜ç‚ºå·²åˆªé™¤
- æŸ¥è©¢æ™‚å¿…é ˆéæ¿¾ `is_active: true`

**å¯ä»¥ç‰©ç†åˆªé™¤**ï¼š
- è‡¨æ™‚æ•¸æ“šï¼ˆå¦‚ `upload_progress`ã€`processing_status`ï¼‰
- TTL éæœŸçš„æ•¸æ“š
- æ˜ç¢ºæ¨™è¨˜ç‚ºå¯åˆªé™¤çš„æ•¸æ“š

#### 7. åŠ å¯†å­˜å„²è¦ç¯„

**æ•æ„Ÿæ•¸æ“šå¿…é ˆåŠ å¯†**ï¼š
- GenAI API Keysï¼ˆ`genai_tenant_secrets`, `genai_user_llm_secrets`ï¼‰
- å…¶ä»–æ•æ„Ÿé…ç½®æ•¸æ“š

**åŠ å¯†è¦æ±‚**ï¼š
- ä½¿ç”¨ `GenAISecretEncryptionService` é€²è¡ŒåŠ å¯†
- ç”Ÿç”¢ç’°å¢ƒå¿…é ˆè¨­ç½® `GENAI_SECRET_ENCRYPTION_KEY` ç’°å¢ƒè®Šæ•¸
- åŠ å¯†å¾Œçš„æ•¸æ“šå­˜å„²åœ¨ ArangoDB ä¸­

#### 8. TTLï¼ˆç”Ÿå­˜æ™‚é–“ï¼‰è¦ç¯„

**ä½¿ç”¨ TTL ç´¢å¼•**ï¼š
- è‡¨æ™‚ç‹€æ…‹æ•¸æ“šï¼ˆ`upload_progress`: 1å°æ™‚ï¼‰
- è™•ç†ç‹€æ…‹æ•¸æ“šï¼ˆ`processing_status`: 24å°æ™‚ï¼‰

**TTL ç´¢å¼•å‰µå»º**ï¼š
```python
collection.add_index({
    "type": "ttl",
    "fields": ["updated_at"],
    "expireAfter": 3600  # ç§’æ•¸
})
```

### Collection è©³ç´°è¦ç¯„

#### ontologies

**ç”¨é€”**: å­˜å„² Ontology å®šç¾©ï¼ˆbase/domain/major ä¸‰ç¨®é¡å‹ï¼‰

**å¿…éœ€å­—æ®µ**:
- `_key`: `{type}-{name}-{version}` æˆ– `{type}-{name}-{version}-{tenant_id}`
- `tenant_id`: ç§Ÿæˆ¶ IDï¼ˆå¯é¸ï¼Œnull è¡¨ç¤ºå…¨å±€å…±äº«ï¼‰
- `type`: Ontology é¡å‹ï¼ˆ`base` / `domain` / `major`ï¼‰
- `name`: Ontology åç¨±
- `version`: ç‰ˆæœ¬è™Ÿï¼ˆèªç¾©åŒ–ç‰ˆæœ¬ï¼Œå¦‚ `"1.0.0"`ï¼‰
- `default_version`: æ˜¯å¦ç‚ºé»˜èªç‰ˆæœ¬ï¼ˆå¸ƒçˆ¾å€¼ï¼‰
- `ontology_name`: å®Œæ•´ Ontology åç¨±
- `entity_classes`: å¯¦é«”é¡åˆ¥åˆ—è¡¨
- `object_properties`: ç‰©ä»¶å±¬æ€§åˆ—è¡¨
- `is_active`: æ˜¯å¦å•Ÿç”¨

**ç´¢å¼•**:
- `idx_ontologies_tenant_type_name`: `["tenant_id", "type", "name"]`
- `idx_ontologies_tenant_type_name_version`: `["tenant_id", "type", "name", "version"]`
- `idx_ontologies_type_name_default`: `["type", "name", "default_version"]`
- `idx_ontologies_is_active`: `["is_active"]`

**æœå‹™**: `OntologyStoreService`

#### system_configs / tenant_configs / user_configs

**ç”¨é€”**: å­˜å„²ç³»çµ±/ç§Ÿæˆ¶/ç”¨æˆ¶ç´šé…ç½®

**å¿…éœ€å­—æ®µ**:
- `_key`: `{scope}` / `{tenant_id}_{scope}` / `{tenant_id}_{user_id}_{scope}`
- `tenant_id`: ç§Ÿæˆ¶ IDï¼ˆsystem_configs ç‚º nullï¼‰
- `user_id`: ç”¨æˆ¶ IDï¼ˆåƒ… user_configs éœ€è¦ï¼‰
- `scope`: é…ç½®ç¯„åœï¼ˆå¦‚ `"genai.policy"`, `"genai.model_registry"`ï¼‰
- `sub_scope`: å­ç¯„åœï¼ˆå¯é¸ï¼‰
- `config_data`: é…ç½®æ•¸æ“šï¼ˆJSON å°è±¡ï¼‰
- `is_active`: æ˜¯å¦å•Ÿç”¨

**ç´¢å¼•**:
- `system_configs`: `idx_system_configs_scope_active` â†’ `["scope", "is_active"]`
- `tenant_configs`: `idx_tenant_configs_tenant_scope_active` â†’ `["tenant_id", "scope", "is_active"]`
- `user_configs`: `idx_user_configs_tenant_user_scope_active` â†’ `["tenant_id", "user_id", "scope", "is_active"]`

**æœå‹™**: `ConfigStoreService`

**é…ç½®åˆä½µé †åº**: System â†’ Tenant â†’ Userï¼ˆå„ªå…ˆç´šç”±ä½åˆ°é«˜ï¼‰

#### audit_logs

**ç”¨é€”**: å¯©è¨ˆæ—¥èªŒè¿½è¹¤ï¼ˆWBS-4.1ï¼‰

**å¿…éœ€å­—æ®µ**:
- `_key`: è‡ªå‹•ç”Ÿæˆ UUID
- `user_id`: ç”¨æˆ¶ ID
- `action`: æ“ä½œé¡å‹ï¼ˆ`AuditAction` æšèˆ‰å€¼ï¼‰
- `resource_type`: è³‡æºé¡å‹ï¼ˆå­—ç¬¦ä¸²ï¼‰
- `resource_id`: è³‡æº IDï¼ˆå¯é¸ï¼‰
- `timestamp`: æ“ä½œæ™‚é–“ï¼ˆdatetimeï¼‰
- `ip_address`: IP åœ°å€
- `user_agent`: User Agent
- `details`: é¡å¤–è©³æƒ…ï¼ˆJSON å°è±¡ï¼‰

**ç´¢å¼•**:
- `["user_id"]`
- `["action"]`
- `["timestamp"]`
- `["resource_type", "resource_id"]`

**æœå‹™**: `AuditLogService`

#### upload_progress / processing_status

**ç”¨é€”**: æ–‡ä»¶ä¸Šå‚³å’Œè™•ç†ç‹€æ…‹è¿½è¹¤ï¼ˆWBS-3.7ï¼‰

**upload_progress å­—æ®µ**:
- `_key`: `{file_id}`
- `file_id`: æ–‡ä»¶ ID
- `status`: ä¸Šå‚³ç‹€æ…‹
- `progress`: é€²åº¦ç™¾åˆ†æ¯”ï¼ˆ0-100ï¼‰
- `file_size`: æ–‡ä»¶å¤§å°ï¼ˆå­—ç¯€ï¼‰
- `uploaded_bytes`: å·²ä¸Šå‚³å­—ç¯€æ•¸
- `updated_at`: æ›´æ–°æ™‚é–“ï¼ˆTTL ç´¢å¼•ï¼Œ1å°æ™‚ï¼‰

**processing_status å­—æ®µ**:
- `_key`: `{file_id}`
- `file_id`: æ–‡ä»¶ ID
- `overall_status`: ç¸½é«”ç‹€æ…‹
- `overall_progress`: ç¸½é«”é€²åº¦ï¼ˆ0-100ï¼‰
- `chunking`: åˆ†å¡Šéšæ®µç‹€æ…‹
- `vectorization`: å‘é‡åŒ–éšæ®µç‹€æ…‹
- `storage`: å­˜å„²éšæ®µç‹€æ…‹
- `kg_extraction`: çŸ¥è­˜åœ–è­œæå–éšæ®µç‹€æ…‹
- `updated_at`: æ›´æ–°æ™‚é–“ï¼ˆTTL ç´¢å¼•ï¼Œ24å°æ™‚ï¼‰

**æœå‹™**: `UploadStatusService`

#### file_metadata

**ç”¨é€”**: æ–‡ä»¶å…ƒæ•¸æ“šå­˜å„²

**å¿…éœ€å­—æ®µ**:
- `_key`: `{file_id}`
- `file_id`: æ–‡ä»¶ ID
- `filename`: æ–‡ä»¶å
- `file_type`: æ–‡ä»¶é¡å‹
- `file_size`: æ–‡ä»¶å¤§å°
- `user_id`: ç”¨æˆ¶ ID
- `task_id`: ä»»å‹™ IDï¼ˆå¯é¸ï¼‰
- `folder_id`: æ–‡ä»¶å¤¾ IDï¼ˆå¯é¸ï¼‰
- `storage_path`: å­˜å„²è·¯å¾‘
- `status`: ç‹€æ…‹
- `created_at`: å‰µå»ºæ™‚é–“
- `updated_at`: æ›´æ–°æ™‚é–“

**ç´¢å¼•**:
- `["file_id"]`
- `["filename"]`
- `["file_type"]`
- `["user_id"]`
- `["task_id"]`
- `["folder_id"]`
- `["status"]`
- `["upload_time"]`

**æœå‹™**: `FileMetadataService`

#### folder_metadata

**ç”¨é€”**: æ–‡ä»¶å¤¾å…ƒæ•¸æ“šå­˜å„²

**å¿…éœ€å­—æ®µ**:
- `_key`: `{folder_id}`
- `folder_id`: æ–‡ä»¶å¤¾ ID
- `folder_name`: æ–‡ä»¶å¤¾åç¨±
- `parent_folder_id`: çˆ¶æ–‡ä»¶å¤¾ IDï¼ˆå¯é¸ï¼‰
- `user_id`: ç”¨æˆ¶ ID
- `task_id`: ä»»å‹™ IDï¼ˆå¯é¸ï¼‰
- `created_at`: å‰µå»ºæ™‚é–“
- `updated_at`: æ›´æ–°æ™‚é–“

**æœå‹™**: `TaskWorkspaceService`

#### genai_tenant_policies / genai_tenant_secrets

**ç”¨é€”**: GenAI ç§Ÿæˆ¶ç­–ç•¥å’Œå¯†é‘°ç®¡ç†

**genai_tenant_policies å­—æ®µ**:
- `_key`: `{tenant_id}`
- `tenant_id`: ç§Ÿæˆ¶ ID
- `allowed_providers`: å…è¨±çš„æä¾›å•†åˆ—è¡¨
- `allowed_models`: å…è¨±çš„æ¨¡å‹æ˜ å°„ï¼ˆæŒ‰æä¾›å•†ï¼‰
- `created_at`: å‰µå»ºæ™‚é–“
- `updated_at`: æ›´æ–°æ™‚é–“

**genai_tenant_secrets å­—æ®µ**:
- `_key`: `{tenant_id}_{provider}`
- `tenant_id`: ç§Ÿæˆ¶ ID
- `provider`: æä¾›å•†åç¨±
- `encrypted_api_key`: åŠ å¯†å¾Œçš„ API Key
- `created_at`: å‰µå»ºæ™‚é–“
- `updated_at`: æ›´æ–°æ™‚é–“

**æœå‹™**: `GenAITenantPolicyService`

**æ³¨æ„**: Secrets å¿…é ˆä½¿ç”¨ `GenAISecretEncryptionService` åŠ å¯†

#### genai_user_llm_secrets

**ç”¨é€”**: GenAI ç”¨æˆ¶ LLM API Key ç®¡ç†

**å¿…éœ€å­—æ®µ**:
- `_key`: `{tenant_id}_{user_id}_{provider}`
- `tenant_id`: ç§Ÿæˆ¶ ID
- `user_id`: ç”¨æˆ¶ ID
- `provider`: æä¾›å•†åç¨±
- `encrypted_api_key`: åŠ å¯†å¾Œçš„ API Key
- `created_at`: å‰µå»ºæ™‚é–“
- `updated_at`: æ›´æ–°æ™‚é–“

**æœå‹™**: `GenAIUserLLMSecretService`

**æ³¨æ„**: å¿…é ˆä½¿ç”¨ `GenAISecretEncryptionService` åŠ å¯†

#### model_usage

**ç”¨é€”**: æ¨¡å‹ä½¿ç”¨è¨˜éŒ„å’Œçµ±è¨ˆ

**å¿…éœ€å­—æ®µ**:
- `_key`: è‡ªå‹•ç”Ÿæˆ UUID
- `model_name`: æ¨¡å‹åç¨±
- `provider`: æä¾›å•†åç¨±
- `user_id`: ç”¨æˆ¶ ID
- `file_id`: æ–‡ä»¶ IDï¼ˆå¯é¸ï¼‰
- `request_tokens`: è«‹æ±‚ Token æ•¸
- `response_tokens`: éŸ¿æ‡‰ Token æ•¸
- `total_tokens`: ç¸½ Token æ•¸
- `timestamp`: ä½¿ç”¨æ™‚é–“
- `metadata`: é¡å¤–å…ƒæ•¸æ“šï¼ˆJSON å°è±¡ï¼‰

**ç´¢å¼•**:
- `["model_name"]`
- `["user_id"]`
- `["file_id"]`
- `["timestamp"]`

**æœå‹™**: `ModelUsageService`

#### operation_logs

**ç”¨é€”**: æ“ä½œæ—¥èªŒè¨˜éŒ„

**å¿…éœ€å­—æ®µ**:
- `_key`: è‡ªå‹•ç”Ÿæˆ UUID
- `user_id`: ç”¨æˆ¶ ID
- `resource_id`: è³‡æº ID
- `resource_type`: è³‡æºé¡å‹ï¼ˆ`"task"` æˆ– `"document"`ï¼‰
- `resource_name`: è³‡æºåç¨±
- `operation_type`: æ“ä½œé¡å‹ï¼ˆ`"create"` / `"update"` / `"archive"` / `"delete"`ï¼‰
- `created_at`: å‰µå»ºæ™‚é–“
- `updated_at`: æ›´æ–°æ™‚é–“
- `archived_at`: æ­¸æª”æ™‚é–“ï¼ˆå¯é¸ï¼‰
- `deleted_at`: åˆªé™¤æ™‚é–“ï¼ˆå¯é¸ï¼‰

**æœå‹™**: `OperationLogService`

#### user_tasks

**ç”¨é€”**: ç”¨æˆ¶ä»»å‹™ç®¡ç†

**å¿…éœ€å­—æ®µ**:
- `_key`: `{task_id}`
- `task_id`: ä»»å‹™ ID
- `user_id`: ç”¨æˆ¶ ID
- `task_name`: ä»»å‹™åç¨±
- `status`: ä»»å‹™ç‹€æ…‹
- `created_at`: å‰µå»ºæ™‚é–“
- `updated_at`: æ›´æ–°æ™‚é–“
- `metadata`: ä»»å‹™å…ƒæ•¸æ“šï¼ˆJSON å°è±¡ï¼‰

**ç´¢å¼•**:
- `["task_id"]`
- `["user_id"]`
- `["status"]`
- `["created_at"]`

**æœå‹™**: `UserTaskService`

### çŸ¥è­˜åœ–è­œ Collectionsï¼ˆGraphï¼‰

#### entities / relations

**ç”¨é€”**: çŸ¥è­˜åœ–è­œå¯¦é«”å’Œé—œä¿‚å­˜å„²

**å‘½åè¦ç¯„**:
- å¯é¸ï¼šä½¿ç”¨ `entities_{file_id}` å’Œ `relations_{file_id}` æŒ‰æ–‡ä»¶çµ„ç¹”
- æˆ–ä½¿ç”¨çµ±ä¸€çš„ `entities` å’Œ `relations` collectionï¼Œé€šé `file_id` å­—æ®µå€åˆ†

**entities å­—æ®µ**:
- `_key`: å¯¦é«” ID
- `name`: å¯¦é«”åç¨±
- `type`: å¯¦é«”é¡å‹
- `file_id`: æ‰€å±¬æ–‡ä»¶ IDï¼ˆå¦‚ä½¿ç”¨çµ±ä¸€ collectionï¼‰
- `metadata`: å¯¦é«”å…ƒæ•¸æ“šï¼ˆJSON å°è±¡ï¼‰

**relations å­—æ®µ**:
- `_key`: é—œä¿‚ ID
- `_from`: èµ·å§‹å¯¦é«” IDï¼ˆ`entities/{entity_id}`ï¼‰
- `_to`: ç›®æ¨™å¯¦é«” IDï¼ˆ`entities/{entity_id}`ï¼‰
- `type`: é—œä¿‚é¡å‹
- `file_id`: æ‰€å±¬æ–‡ä»¶ IDï¼ˆå¦‚ä½¿ç”¨çµ±ä¸€ collectionï¼‰
- `metadata`: é—œä¿‚å…ƒæ•¸æ“šï¼ˆJSON å°è±¡ï¼‰

**æ³¨æ„**: é€™äº› Collections åœ¨çŸ¥è­˜åœ–è­œæ§‹å»ºæ™‚å‹•æ…‹å‰µå»ºï¼Œä¸é€šé Schema è…³æœ¬å‰µå»º

### æœå‹™å±¤è¦ç¯„

#### Store Services

**å¿…é ˆå¯¦ç¾**:
- âœ… æ‰€æœ‰æ•¸æ“šæ“ä½œå¿…é ˆé€šé Store Service é€²è¡Œ
- âœ… Store Service å¿…é ˆå°è£ ArangoDB æ“ä½œ
- âœ… å¿…é ˆé€²è¡Œæ•¸æ“šé©—è­‰ï¼ˆä½¿ç”¨ Pydantic æ¨¡å‹ï¼‰
- âœ… å¿…é ˆè™•ç†å¤šç§Ÿæˆ¶éš”é›¢
- âœ… å¿…é ˆé€²è¡ŒéŒ¯èª¤è™•ç†å’Œæ—¥èªŒè¨˜éŒ„

**Store Service å‘½åè¦ç¯„**:
- æœå‹™é¡åç¨±ï¼š`{Entity}StoreService`ï¼ˆå¦‚ `OntologyStoreService`ï¼‰
- ç²å–æœå‹™å‡½æ•¸ï¼š`get_{entity}_store_service()`ï¼ˆå¦‚ `get_ontology_store_service()`ï¼‰
- æœå‹™æ–‡ä»¶ï¼š`{entity}_store_service.py`ï¼ˆå¦‚ `ontology_store_service.py`ï¼‰

#### ç›´æ¥è¨ªå• ArangoDB

**ç¦æ­¢**:
- âŒ ä¸è¦åœ¨è·¯ç”±å±¤ç›´æ¥è¨ªå• ArangoDB
- âŒ ä¸è¦åœ¨æ¥­å‹™é‚è¼¯ä¸­ç›´æ¥ä½¿ç”¨ `ArangoDBClient`
- âŒ ä¸è¦ç¹é Store Service é€²è¡Œæ•¸æ“šæ“ä½œ

**å…è¨±**:
- âœ… åœ¨ Store Service å…§éƒ¨ä½¿ç”¨ `ArangoDBClient`
- âœ… åœ¨æ•¸æ“šé·ç§»è…³æœ¬ä¸­ç›´æ¥ä½¿ç”¨ `ArangoDBClient`

### Schema ç®¡ç†è¦ç¯„

#### Schema å‰µå»º

**å¿…é ˆä½¿ç”¨ Schema è…³æœ¬**:
- æ‰€æœ‰ Collections å’Œç´¢å¼•å¿…é ˆé€šé `scripts/migration/create_schema.py` å‰µå»º
- ä¸è¦æ‰‹å‹•åœ¨ ArangoDB Web UI ä¸­å‰µå»º Collections

**Schema æ›´æ–°**:
- æ–°å¢ Collection æ™‚ï¼Œæ›´æ–° `create_schema.py`
- æ–°å¢ç´¢å¼•æ™‚ï¼Œæ›´æ–° `create_schema.py` ä¸­çš„ç´¢å¼•å®šç¾©
- é‹è¡Œ Schema è…³æœ¬ï¼š`python scripts/migration/create_schema.py`

#### æ•¸æ“šé·ç§»

**é·ç§»è…³æœ¬ä½ç½®**: `scripts/migration/`

**é·ç§»è…³æœ¬å‘½å**: `migrate_{entity}.py`ï¼ˆå¦‚ `migrate_ontologies.py`ï¼‰

**é·ç§»å‰å¿…é ˆ**:
- âœ… å‚™ä»½ç¾æœ‰æ•¸æ“š
- âœ… æª¢æŸ¥ç›®æ¨™ Schema æ˜¯å¦å·²å‰µå»º
- âœ… é©—è­‰æºæ•¸æ“šå®Œæ•´æ€§

### æ•¸æ“šæŸ¥è©¢è¦ç¯„

#### AQL æŸ¥è©¢

**å¿…é ˆéµå¾ª**:
- âœ… æ‰€æœ‰ AQL æŸ¥è©¢å¿…é ˆä½¿ç”¨ç¶å®šè®Šæ•¸ï¼ˆbind varsï¼‰
- âœ… å¿…é ˆé€²è¡Œåƒæ•¸é©—è­‰
- âœ… å¿…é ˆè™•ç†æŸ¥è©¢çµæœç‚ºç©ºçš„æƒ…æ³

**ç¤ºä¾‹**:
```python
# âœ… æ­£ç¢ºï¼šä½¿ç”¨ç¶å®šè®Šæ•¸
aql = """
    FOR doc IN ontologies
        FILTER doc.tenant_id == @tenant_id
        AND doc.type == @type
        AND doc.is_active == true
        RETURN doc
"""
cursor = self.client.db.aql.execute(
    aql,
    bind_vars={"tenant_id": tenant_id, "type": ontology_type}
)

# âŒ éŒ¯èª¤ï¼šå­—ç¬¦ä¸²æ‹¼æ¥ï¼ˆSQL æ³¨å…¥é¢¨éšªï¼‰
aql = f"FOR doc IN ontologies FILTER doc.tenant_id == '{tenant_id}' RETURN doc"
```

#### Collection æŸ¥è©¢

**ä½¿ç”¨ Collection API**:
```python
# âœ… æ­£ç¢ºï¼šä½¿ç”¨ Collection API é€²è¡Œç°¡å–®æŸ¥è©¢
filters = {"tenant_id": tenant_id, "is_active": True}
docs = collection.find(filters, limit=100)

# âœ… æ­£ç¢ºï¼šä½¿ç”¨ AQL é€²è¡Œè¤‡é›œæŸ¥è©¢
aql = """
    FOR doc IN ontologies
        FILTER doc.tenant_id == @tenant_id
        SORT doc.created_at DESC
        LIMIT @limit
        RETURN doc
"""
```

### éŒ¯èª¤è™•ç†è¦ç¯„

#### æ•¸æ“šåº«é€£æ¥æª¢æŸ¥

**å¿…é ˆæª¢æŸ¥**:
```python
# âœ… æ­£ç¢ºï¼šä½¿ç”¨å‰æª¢æŸ¥æ•¸æ“šåº«é€£æ¥
if self.client.db is None:
    raise RuntimeError("ArangoDB client is not connected")

# âœ… æ­£ç¢ºï¼šæª¢æŸ¥ AQL æ˜¯å¦å¯ç”¨
if self.client.db.aql is None:
    raise RuntimeError("AQL is not available")
```

#### ç•°å¸¸è™•ç†

**å¿…é ˆè™•ç†**:
- âœ… Collection ä¸å­˜åœ¨
- âœ… æ–‡æª”ä¸å­˜åœ¨ï¼ˆ`get()` è¿”å› `None`ï¼‰
- âœ… ç´¢å¼•å‰µå»ºå¤±æ•—
- âœ… AQL æŸ¥è©¢éŒ¯èª¤

**ç¤ºä¾‹**:
```python
# âœ… æ­£ç¢ºï¼šè™•ç†æ–‡æª”ä¸å­˜åœ¨
doc = collection.get(doc_id)
if doc is None:
    raise HTTPException(status_code=404, detail="Document not found")

# âœ… æ­£ç¢ºï¼šè™•ç†ç•°å¸¸
try:
    collection.insert(doc)
except Exception as exc:
    logger.error("insert_failed", error=str(exc))
    raise RuntimeError(f"Failed to insert document: {exc}") from exc
```

### æ€§èƒ½å„ªåŒ–è¦ç¯„

#### ç´¢å¼•ä½¿ç”¨

**å¿…é ˆå‰µå»ºç´¢å¼•**:
- æ‰€æœ‰æŸ¥è©¢å­—æ®µéƒ½å¿…é ˆæœ‰ç´¢å¼•
- è¤‡åˆæŸ¥è©¢å¿…é ˆå‰µå»ºè¤‡åˆç´¢å¼•
- æ’åºå­—æ®µå¿…é ˆæœ‰ç´¢å¼•

#### æŸ¥è©¢å„ªåŒ–

**æœ€ä½³å¯¦è¸**:
- âœ… ä½¿ç”¨ `LIMIT` é™åˆ¶æŸ¥è©¢çµæœæ•¸é‡
- âœ… ä½¿ç”¨ `SORT` æ™‚ç¢ºä¿æ’åºå­—æ®µæœ‰ç´¢å¼•
- âœ… é¿å…å…¨è¡¨æƒæ
- âœ… ä½¿ç”¨ `EXPLAIN` åˆ†ææŸ¥è©¢è¨ˆåŠƒï¼ˆé–‹ç™¼éšæ®µï¼‰

### æ•¸æ“šå‚™ä»½èˆ‡æ¢å¾©

#### å‚™ä»½ç­–ç•¥

**å¿…é ˆåŸ·è¡Œ**:
- âœ… å®šæœŸå‚™ä»½ ArangoDB æ•¸æ“š
- âœ… é·ç§»å‰å¿…é ˆå‚™ä»½
- âœ… é‡è¦æ“ä½œå‰å¿…é ˆå‚™ä»½

#### æ¢å¾©æµç¨‹

**æ¢å¾©æ­¥é©Ÿ**:
1. åœæ­¢æ‡‰ç”¨æœå‹™
2. æ¢å¾© ArangoDB æ•¸æ“š
3. é‹è¡Œ Schema è…³æœ¬ç¢ºä¿çµæ§‹æ­£ç¢º
4. é©—è­‰æ•¸æ“šå®Œæ•´æ€§
5. é‡å•Ÿæ‡‰ç”¨æœå‹™

### é–‹ç™¼æª¢æŸ¥æ¸…å–®

åœ¨é–‹ç™¼ ArangoDB ç›¸é—œåŠŸèƒ½æ™‚ï¼Œå¿…é ˆæª¢æŸ¥ï¼š

- [ ] Collection åç¨±ç¬¦åˆå‘½åè¦ç¯„
- [ ] æ–‡æª”çµæ§‹åŒ…å«å¿…éœ€å­—æ®µï¼ˆ`_key`, `created_at`, `updated_at`ï¼‰
- [ ] å¤šç§Ÿæˆ¶æ•¸æ“šåŒ…å« `tenant_id` å­—æ®µ
- [ ] æŸ¥è©¢æ™‚æ­£ç¢ºéæ¿¾ `tenant_id`
- [ ] å·²å‰µå»ºå¿…è¦çš„ç´¢å¼•
- [ ] ä½¿ç”¨ Store Service é€²è¡Œæ•¸æ“šæ“ä½œ
- [ ] é€²è¡Œæ•¸æ“šé©—è­‰ï¼ˆPydantic æ¨¡å‹ï¼‰
- [ ] è™•ç†éŒ¯èª¤å’Œç•°å¸¸æƒ…æ³
- [ ] è¨˜éŒ„æ—¥èªŒ
- [ ] æ•æ„Ÿæ•¸æ“šå·²åŠ å¯†ï¼ˆå¦‚é©ç”¨ï¼‰
- [ ] TTL ç´¢å¼•å·²æ­£ç¢ºé…ç½®ï¼ˆå¦‚é©ç”¨ï¼‰

### åƒè€ƒæ–‡æª”

- ArangoDB å®˜æ–¹æ–‡æª”: https://www.arangodb.com/docs/
- é …ç›® Schema è…³æœ¬: `scripts/migration/create_schema.py`
- Store Services: `services/api/services/*_store_service.py`
- æ•¸æ“šæ¨¡å‹: `services/api/models/`

---

## âš¡ å¿«é€Ÿæª¢æŸ¥è…³æœ¬

ä½¿ç”¨é …ç›®æ ¹ç›®éŒ„çš„ `check_code_quality.py` è…³æœ¬ï¼š

```bash
python check_code_quality.py <æ–‡ä»¶è·¯å¾‘>
```

è©²è…³æœ¬æœƒè‡ªå‹•åŸ·è¡Œæ‰€æœ‰æª¢æŸ¥æ­¥é©Ÿã€‚

---

## ğŸ“š è©³ç´°è¦ç¯„æ–‡æª”åƒè€ƒ

è«‹åƒé–±ï¼š
- `AI_é–‹ç™¼è¦ç¯„æª¢æŸ¥æ¸…å–®.md` - å®Œæ•´çš„æª¢æŸ¥æ¸…å–®å’Œæµç¨‹
- `docs/ç¬¬ä¸‰æ¬¡æ•´æ”¹/ç³»çµ±æ•´æ”¹è¨ˆåŠƒ.md` - é–‹ç™¼è¦ç¯„è©³ç´°èªªæ˜
- `services/api/pyproject.toml` - é …ç›®é…ç½®èˆ‡å·¥å…·è¨­ç½®

---

**æœ€å¾Œæ›´æ–°æ—¥æœŸ**: 2025-12-30
**ç¶­è­·äºº**: Daniel Chung
